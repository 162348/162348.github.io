<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Hirofumi Shiba</title>
<link>https://162348.github.io/blog.html</link>
<atom:link href="https://162348.github.io/blog.xml" rel="self" type="application/rss+xml"/>
<description>A Blog by a Bayesian Computation Researcher</description>
<image>
<url>https://162348.github.io/assets/categories.png</url>
<title>Hirofumi Shiba</title>
<link>https://162348.github.io/blog.html</link>
</image>
<generator>quarto-1.7.32</generator>
<lastBuildDate>Wed, 25 Jun 2025 00:00:00 GMT</lastBuildDate>
<item>
  <title>シンガポール研究滞在記</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2025/Blog/NUS.html</link>
  <description><![CDATA[ 





<section id="シンガポール生活のはじまり" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="シンガポール生活のはじまり"><span class="header-section-number">1</span> シンガポール生活のはじまり</h2>
<p>６月の１日から 30 日までの１ヶ月間，総研大の<a href="https://www.soken.ac.jp/education/dispatch/sokendai_studentdispatchprogram/">研究派遣プログラム</a>の援助を受けて，シンガポール国立大学の Alexandre Thiéry 准教授を訪問した．</p>
<p><a href="../../../posts/2024/Life/UCL.html">昨年度のロンドン UCL の訪問</a> に続き，人生２度目の研究滞在である．その際は Alexandros Beskos 教授を訪問し，２度目の Alex 訪問でもある．</p>
<p>いずれの Alex も逐次モンテカルロ法 (SMC)，マルコフ連鎖モンテカルロ法 (MCMC) 双方で顕著な業績をあげている，代表的なベイズ計算の研究者である．２人の間には共著も多く，いずれもすでに大変な大物であるが，年齢的にはまだまだ中堅というべきである．</p>
<p>シンガポールの気候はロンドンの対極にある．まず熱くて日差しが強い．緯度１度であることを思えば不思議ではない．</p>
<p>さらに蒸し暑さで悪名高い東京の夏よりも湿度が高い．だが不思議と不快感は少ない．駅に着くまでに汗ダラダラになった，という経験は１度もしていない．おそらく，町中に日陰が多いことと，アスファルトが少なく，代わりに土と街路樹（日本のような人工的な街路樹ではなくて本当に生えている）が多いからだろう．</p>
<p>天気予報を見ると１週間まるまる 100% 雨の予報である週もあったが，かといってほとんど雨は降らない．どういうことかというと，当日中に雨が <strong>１度でも</strong> 降る確率は 100% であるが，それはバケツをひっくり返したような雨で 10 分も続かないのが常である．シンガポールは屋根が多いから，近場で雨宿りしてやり過ごせば，傘を持たずとも１週間過ごせる．</p>
<!-- そして人々の気質も違う．困っている人が居たら率先して助けてくれるのはどちらも同じであるが， -->
<p>しかしロンドンと共通するのは，人々の多様性である．ロンドンとは違いアジア人が多数を占めるとはいえ，マレー系，インド系，中華系に３分され，言語もこの３つを結構似た頻度で聞く．</p>
<p>この多様性が，僕がシンガポールを，そしてロンドンを好きな理由である．</p>
</section>
<section id="共同研究" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="共同研究"><span class="header-section-number">2</span> 共同研究</h2>
<p>シンガポールでは週１で滞在先の Thiéry とのミーティングを行った．初回から PDMP の離散化と既存の MCMC との比較という PDMP 研究の一大課題が共有されたため，その後のミーティングも活発にディスカッションが進んだ．</p>
<p>だかそれだけということもなく，多様体上の MCMC 手法 <span class="citation" data-cites="Au+2023">(Au et al., 2023)</span> や，高次元における粒子フィルター <span class="citation" data-cites="Finke-Thiery2023">(Finke and Thiery, 2023)</span> にも詳しいため，多くのことを学ぶことができた．</p>
<p>自分が追っている研究の最新論文 <span class="citation" data-cites="Crucinio-Pathiraja2025">(Crucinio and Pathiraja, 2025)</span> がたまたま出たので，これについて Slack 上で紹介したところ，Thiéry も読んでくれてディスカッションまでしてくれた．</p>
<p>最終日には Hamiltonian Monte Carlo の高次元漸近解析の方向性をまとめ，ドラフトにまとめることまで出来た．帰国後に継続的に取り組む予定をしている．</p>
<p>さらに高次元における PDMP とそのベイズ逆問題への応用についても，その研究の後にやる見通しがついている．</p>
</section>
<section id="研究環境" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="研究環境"><span class="header-section-number">3</span> 研究環境</h2>
<p>シンガポールでは初日から Thiéry 氏がポスドクの林氏と，David Nott のポスドクである Lucas を紹介してくれた．</p>
<p>私には机も用意されており，同室にはイタリアから滞在中の Piergiacomo がいた．</p>
<p>出張前には想像もしなかったことだが，私は彼らと，Linda Tan のポスドクである Abhinek も入れて，その後は毎日お昼と４時のティータイムを共にすることになる．</p>
<p>大学に行く機会はあまりないかもしれないと思い，東部のエリアにホテルをとってしまったのだが，彼らとの時間が好きすぎて平日は結局毎日片道１時間かけて通ってしまった．</p>
<p>こんなことならば大学の近くにホテルを借りればよかったと後悔したものであった．</p>
<p>林は訪問時時系列の予測を研究しており，これに SSM-GP と呼ばれる状態空間モデルと Gauss 過程の考え方を両方取り入れた手法を用いていた．</p>
<p>その新規性としては，さらに拡散モデルによる非線型な遷移を可能にしていることにある．</p>
<p>月末にあった BayesComp2025 というベイズ計算最大の国際学会でポスター発表をすることに向けて，最後のシミュレーション欄を詰めていたのだがなぜかうまくいかない点があった．</p>
<p>その点について Thiéry とミーティングをしていたところに，私も同居させてもらい，その日のうちに解決した．</p>
<p>特に粒子フィルターのシミュレーションにおいては，これまた隣に世界的な粒子フィルターの研究者である Hai-Dang も居たにも拘らず，自分が観測ノイズが小さすぎることに問題があることを見抜けた．</p>
<p>結局 <span class="citation" data-cites="DelMoral-Murray">(Del Moral and Murray, 2015)</span> に関連する現象であったが，自分の友人を助けたいという気持ちが実ったようで嬉しかった．</p>
</section>
<section id="bayescomp2025" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="bayescomp2025"><span class="header-section-number">4</span> <a href="https://bayescomp2025.sg/">BayesComp2025</a></h2>
<p>BayesComp は２年に１度開催される，計算に特化した BayesComp-ISBA 主催のベイズ特化の国際学会である．</p>
<p>この分野では最大規模であり，今回もサテライト２日と本会議３日を併せて５日間開催された．</p>
<p>この会議に出席する前に，自分は出席予定のセッションで触れられる論文のほとんど全てに目を通してから出席した．</p>
<p>お陰で聞きたいことをはっきり質問できた機会も多い．さらに何より，インターバル時間に研究者の本音が聞くことによって，自分の知識が有機的に繋がり，２倍にも３倍にもなるのを感じた．</p>
<p>この会議では，自分は残念ながら研究の進捗が間に合わず，ポスター発表はできなかったが，多くの友人に「見たかった」と言ってもらった．次こそはポスターでも口頭でもぜひ発表したいものである．</p>
<p>最も印象に残ったのは Emti による Bayesian Learning Rule に関する講演であった．ベイズ推論の情報理論的な特徴付け <span class="citation" data-cites="Zellner1988">(Zellner, 1988)</span> は自分にとって大変興味深いものであり，“Bring the science back to ML” の標語は discussion section に参加したみんなの脳裏に残ったであろう．</p>
</section>



<div id="quarto-appendix" class="default"><section id="俺の見てきたシンガポール" class="level2 appendix" data-number="5"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">5</span> 俺の見てきたシンガポール</h2><div class="quarto-appendix-contents">

<p>さらに個人的な経験を書いてしまおうと思う．</p>
<p>基本的に東アジア人の顔をして中華系の料理店に入ると，最初から中国語（標準語）で接客される．コスト的には納得である．牛肉麺とかを beef noodle とか言って注文する気も起きないから，まあ理にかなっているかと思っていた．</p>
<p>しかしある日タクシーに乗って中国語を話したところ，「君ら中国人はマナーが悪い」と説教を受けた．シンガポールは配車アプリが発達しており，運転手と全く会話せずに目的地に到着することも可能であるが，本人確認の都合もあり，確認したいことも多い．それにも拘らず何をいっても一言も喋ろうとしないおそろしい乗客はたいてい中華系なのだという．</p>
<p>あまりにお門違いだと思ったので事情を説明したところ，すぐに通じた．あろうことか，運転手さんは東京に 30 年以上も住んでいたことがあり，自分が日本語を喋ったらすぐにわかってくれた．<sup>1</sup> なお，この運転手さんは，マレー系のシンガポール人で，生粋のシンガポール生まれシンガポール育ちであると言っていた．</p>
<p>シンガポールは極めて犯罪率が低く，麻薬使用率も極めて低い．日本で生きていると正直それがデフォルトだと感じてしまうところがあるが，ここまで多様な社会で軋轢がないはずがない．</p>
<p>私は，これは資本主義のマジックだと見る．少なくとも今のシンガポールは，近隣国に比べて圧倒的な富がある．その大きな要因として，英語を公用語に残してあることがある．</p>



</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Au+2023" class="csl-entry">
Au, K. X., Graham, M. M., and Thiery, A. H. (2023). <a href="https://doi.org/10.1093/jrsssb/qkad023">Manifold lifting: Scaling markov chain monte carlo to the vanishing noise regime</a>. <em>Journal of the Royal Statistical Society Series B: Statistical Methodology</em>, <em>85</em>(3), 757–782.
</div>
<div id="ref-Crucinio-Pathiraja2025" class="csl-entry">
Crucinio, F. R., and Pathiraja, S. (2025). <a href="https://arxiv.org/abs/2506.05905">Sequential monte carlo approximations of wasserstein–fisher–rao gradient flows</a>.
</div>
<div id="ref-DelMoral-Murray" class="csl-entry">
Del Moral, P., and Murray, L. M. (2015). <a href="https://doi.org/10.1137/15M1011214">Sequential monte carlo with highly informative observations</a>. <em>SIAM/ASA Journal on Uncertainty Quantification</em>, <em>3</em>(1), 969–997.
</div>
<div id="ref-Finke-Thiery2023" class="csl-entry">
Finke, A., and Thiery, A. H. (2023). <a href="https://doi.org/10.1214/22-AOS2252"><span class="nocase">Conditional sequential Monte Carlo in high dimensions</span></a>. <em>The Annals of Statistics</em>, <em>51</em>(2), 437–463.
</div>
<div id="ref-Zellner1988" class="csl-entry">
Zellner, A. (1988). <a href="https://doi.org/10.1080/00031305.1988.10475585">Optimal information processing and bayes’s theorem</a>. <em>The American Statistician</em>, <em>42</em>(4), 278–280.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>ここで気づくだろうが，僕の中国語は，聞き手がネイティブじゃない限り，僕がネイティブじゃないことは見抜けない完成度がある．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Life</category>
  <guid>https://162348.github.io/posts/2025/Blog/NUS.html</guid>
  <pubDate>Wed, 25 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>A Function that is Continuous on a Closed Subset</title>
  <dc:creator>Hirofumi Shiba</dc:creator>
  <link>https://162348.github.io/posts/2025/Topology/ContiunitySet.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<p>For the sake of simplicity, we focus on the case of <img src="https://latex.codecogs.com/png.latex?f:%5Cmathbb%7BR%7D%5Cto%5Cmathbb%7BR%7D">.</p>
<p>This article is concerned with the <em>continuity set</em> of <img src="https://latex.codecogs.com/png.latex?f">, defined as <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7BCont%7D(f):=%5Cleft%5C%7Bx%5Cin%5Cmathbb%7BR%7D%5Cmid%20f%5Ctext%7B%20is%20continuous%20at%20%7Dx%5Cright%5C%7D.%0A"></p>
<p>Most continuous functions are treated on open sets. We might be easily tricked to think that <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BCont%7D(f)"> should be open.</p>
<p>Is this conjecture true?<sup>1</sup> As a starting point, proving that <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BCont%7D(f)"> is a countable intersection of open sets is not difficult.</p>
<section id="mathrmcontf-is-g_delta" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="mathrmcontf-is-g_delta"><span class="header-section-number">1</span> <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BCont%7D(f)"> is <img src="https://latex.codecogs.com/png.latex?G_%5Cdelta"></h2>
<p>We denote an open ball of radius <img src="https://latex.codecogs.com/png.latex?%5Cdelta"> centered at <img src="https://latex.codecogs.com/png.latex?x"> by <img src="https://latex.codecogs.com/png.latex?U_%5Cdelta(x)">.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="Proposition">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Proposition
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BCont%7D(f)"> is a <img src="https://latex.codecogs.com/png.latex?G_%5Cdelta"> set, meaning that it is a countable intersection of open sets. Specifically, <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7BCont%7D(f)=%5Cbigcap_%7Bn=1%7D%5E%5Cinfty%5Cleft%5C%7Bx%5Cin%5Cmathbb%7BR%7D%5C,%5Cmiddle%7C%5C,%5Cexists_%7B%5Cdelta%3E0%7D%5C;%5Cforall_%7By,z%5Cin%20U_%5Cdelta(x)%7D%5C;%5Clvert%20f(y)-f(z)%5Crvert%3C%5Cfrac%7B1%7D%7Bn%7D%5Cright%5C%7D.%0A"></p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Proof">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Proof
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>It is straightforward to check that each <img src="https://latex.codecogs.com/png.latex?%5Cleft%5C%7Bx%5Cin%5Cmathbb%7BR%7D%5C,%5Cmiddle%7C%5C,%5Cexists_%7B%5Cdelta%3E0%7D%5C;%5Cforall_%7By,z%5Cin%20U_%5Cdelta(x)%7D%5C;%5Clvert%20f(y)-f(z)%5Crvert%3C%5Cfrac%7B1%7D%7Bn%7D%5Cright%5C%7D"> is open.</p>
<p>The easy part is the <img src="https://latex.codecogs.com/png.latex?%5Csupset"> direction, since for every <img src="https://latex.codecogs.com/png.latex?%5Cepsilon%3E0">, there exists a <img src="https://latex.codecogs.com/png.latex?N%3E0"> satisfying <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7BN%7D%3C%5Cepsilon">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Csubset"> direction is also straightforward, following from the definition of continuity and triangle inequality.</p>
</div>
</div>
</div>
</section>
<section id="g_delta-sets-are-continuity-sets" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="g_delta-sets-are-continuity-sets"><span class="header-section-number">2</span> <img src="https://latex.codecogs.com/png.latex?G_%5Cdelta"> sets are continuity sets</h2>
<p>A fun fact is that every <img src="https://latex.codecogs.com/png.latex?G_%5Cdelta"> set is the continuity set <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BCont%7D(f)"> of some function <img src="https://latex.codecogs.com/png.latex?f">, proved in, for example, a almost one-page article <span class="citation" data-cites="Kim1999">(Kim, 1999)</span>.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="[Theorem p.258 @Kim1999]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="citation" data-cites="Kim1999">(Theorem p.258 Kim, 1999)</span>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let <img src="https://latex.codecogs.com/png.latex?X"> be a nonempty metric space without isolated points. Then every <img src="https://latex.codecogs.com/png.latex?G_%5Cdelta"> subset <img src="https://latex.codecogs.com/png.latex?G%5Csubset%20X"> is the continuity set of some function <img src="https://latex.codecogs.com/png.latex?f:X%5Cto%5Cmathbb%7BR%7D">.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Proof">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Proof
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This construction can be understood as a generalization of the example given later in Section&nbsp;3.</p>
<p>Given that <img src="https://latex.codecogs.com/png.latex?G"> is a <img src="https://latex.codecogs.com/png.latex?G_%5Cdelta"> set, the complement <img src="https://latex.codecogs.com/png.latex?G%5E%5Ccomplement"> is a countable union of closed sets: <img src="https://latex.codecogs.com/png.latex?%0AG%5E%5Ccomplement=%5Cbigcup_%7Bn=1%7D%5E%5Cinfty%20F_n,%5Cqquad%20F_n%5Coverset%7B%5Ctextrm%7Bclosed%7D%7D%7B%5Csubset%7DX.%0A"></p>
<p>Using <img src="https://latex.codecogs.com/png.latex?%5C%7BF_n%5C%7D">, we construct a function <img src="https://latex.codecogs.com/png.latex?g:X%5Cto%5Cmathbb%7BR%7D"> as follows: <img src="https://latex.codecogs.com/png.latex?%0Ag(x):=%5Csum_%7Bn=1%7D%5E%5Cinfty%5Cfrac%7B1%7D%7B2%5En%7D1_%7BF_n%7D(x).%0A"> Observe that <img src="https://latex.codecogs.com/png.latex?g=0%5C;%5Cmathrm%7Bon%7D%5C;G">. Building upon this, we define <img src="https://latex.codecogs.com/png.latex?f:X%5Cto%5Cmathbb%7BR%7D"> by <img src="https://latex.codecogs.com/png.latex?%0Af(x):=g(x)%5Cleft(1_A(x)-%5Cfrac%7B1%7D%7B2%7D%5Cright)%0A"> where <img src="https://latex.codecogs.com/png.latex?A%5Csubset%20X"> be a set that both <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?A%5E%5Ccomplement"> are dense in <img src="https://latex.codecogs.com/png.latex?X">.</p>
<p>This set <img src="https://latex.codecogs.com/png.latex?A"> corresponds <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BQ%7D"> in the example given later in Section&nbsp;3.</p>
</div>
</div>
</div>
</section>
<section id="sec-example" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-example"><span class="header-section-number">3</span> Example of <img src="https://latex.codecogs.com/png.latex?f:%5Cmathbb%7BR%7D%5Cto%5Cmathbb%7BR%7D"> with closed <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BCont%7D(f)"></h2>
<p>In perfectly regular spaces, every closed set is a <img src="https://latex.codecogs.com/png.latex?G_%5Cdelta"> set <span class="citation" data-cites="Tong1952">(Tong, 1952)</span>.</p>
<p>So there should be an example on <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D"> that <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BCont%7D(f)"> is closed.</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="Example^[My colleague Nakajima-san taught me this example.]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example<sup>2</sup>
</div>
</div>
<div class="callout-body-container callout-body">
<p>The function <img src="https://latex.codecogs.com/png.latex?f"> defined as follows has <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BCont%7D(f)=(-%5Cinfty,0%5D">: <img src="https://latex.codecogs.com/png.latex?%0Af(x):=%5Cbegin%7Bcases%7D%0A0,&amp;x%5Cle0,%5C%5C%0A%5Cfrac%7B1%7D%7Bn%7D,&amp;x%5Cin(0,%5Cinfty)%5Ccap%5Cmathbb%7BQ%7D,%5C%5C%0A-%5Cfrac%7B1%7D%7Bn%7D,&amp;x%5Cin(0,%5Cinfty)%5Csetminus%5Cmathbb%7BQ%7D.%0A%5Cend%7Bcases%7D%0A"></p>
</div>
</div>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Kim1999" class="csl-entry">
Kim, S. S. (1999). <a href="https://doi.org/10.1080/00029890.1999.12005038">A characterization of the set of points of continuity of a real function</a>. <em>The American Mathematical Monthly</em>, <em>106</em>(3), 258–259.
</div>
<div id="ref-Tong1952" class="csl-entry">
Tong, H. (1952). <a href="https://doi.org/10.1215/S0012-7094-52-01928-5"><span class="nocase">Some characterizations of normal and perfectly normal spaces</span></a>. <em>Duke Mathematical Journal</em>, <em>19</em>(2), 289–292.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>It is not true.↩︎</p></li>
<li id="fn2"><p>My colleague Nakajima-san taught me this example.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Topology</category>
  <guid>https://162348.github.io/posts/2025/Topology/ContiunitySet.html</guid>
  <pubDate>Thu, 17 Apr 2025 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2025/Topology/Files/NakajimaExp.png" medium="image" type="image/png" height="58" width="144"/>
</item>
<item>
  <title>PDMP によりスパイク付きの非絶対連続分布からもサンプリングが可能になる</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2025/Posters/第19回日本統計学会春季集会.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="導入新たなモンテカルロ法の出現" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="導入新たなモンテカルロ法の出現"><span class="header-section-number">1</span> 導入：新たなモンテカルロ法の出現</h2>
<p>マルコフ連鎖モンテカルロ法 (MCMC: Markov Chain Monte Carlo) や逐次モンテカルロ法 (SMC: Sequential Monte Carlo) などのモンテカルロ法は， 21世紀に入って計算機が普及してのち，ベイズ統計の応用範囲を爆発的に拡大する立役者となった <span class="citation" data-cites="InPractice1996">(Gilks et al., 1996)</span>, <span class="citation" data-cites="Doucet+2001">(Doucet et al., 2001)</span>, <span class="citation" data-cites="Martin+2024">(Martin et al., 2024)</span>． 近年提案された<strong>区分確定的マルコフ過程</strong> (PDMP: Piecewise Deterministic Markov Process) を利用した新たなモンテカルロ法も，この系列に続くものと理解できる．</p>
<p>MCMC と SMC はいずれも離散時間のマルコフ過程 <img src="https://latex.codecogs.com/png.latex?(X_n)_%7Bn=1%7D%5E%5Cinfty"> のシミュレーションに基づく． ここでは特にMCMCに焦点を当てる． ベイズ統計では事後分布 <img src="https://latex.codecogs.com/png.latex?%5Cpi"> を導くことで推論を実行するが，事前分布や尤度の選択範囲を大きく制限しない限り，<img src="https://latex.codecogs.com/png.latex?%5Cpi"> は既知の分布とはならない． たとえ <img src="https://latex.codecogs.com/png.latex?%5Cpi"> の関数形がわかっていても，事後分布 <img src="https://latex.codecogs.com/png.latex?%5Cpi"> の平均を求めるなど，これを後続の統計解析に供することは必ずしも簡単ではない． そんな中でも，事後分布 <img src="https://latex.codecogs.com/png.latex?%5Cpi"> を平衡分布にもつエルゴード的なマルコフ連鎖 <img src="https://latex.codecogs.com/png.latex?(X_n)"> を設計することができれば，大数の強法則 <span id="eq-LLN"><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B1%7D%7BN%7D%5Csum_%7Bn=1%7D%5ENf(X_n)%5Cxrightarrow%7BN%5Cto%5Cinfty%7D%5Cint%20f(x)%5Cpi(dx)%5C;%5C;%5Ctext%7Ba.s.%7D%5Cqquad%20f%5Cin%5Cmathcal%7BL%7D%5E1(%5Cpi)%0A%5Ctag%7B1%7D"></span> が成り立つ <span class="citation" data-cites="Kulik2018">(Kulik, 2018, pp. 175–176)</span>．この事実を用いて事後分布 <img src="https://latex.codecogs.com/png.latex?%5Cpi"> を近似する枠組みが MCMC であり， 条件を満たす <img src="https://latex.codecogs.com/png.latex?(X_n)"> の構成法に Gibbs サンプラー <span class="citation" data-cites="Geman-Geman1984">(Geman and Geman, 1984)</span> やランダムウォーク Metropolis-Hastings法 <span class="citation" data-cites="Hastings1970">(Hastings, 1970)</span> などがある．</p>
<p>多くの MCMC 法は物理学に由来する．例えば Gibbs サンプラーは Ising モデル <span class="citation" data-cites="Glauber1963">(Glauber, 1963)</span>，Metropolis-Hastings 法は状態方程式 <span class="citation" data-cites="Metropolis+1953">(Metropolis et al., 1953)</span> のシミュレーションにおいて最初に提案された． MCMC という名前は <span class="citation" data-cites="Geman-Geman1984">(Geman and Geman, 1984)</span> や <span class="citation" data-cites="Hastings1970">(Hastings, 1970)</span> などで統計学における確率分布からのサンプリングの問題に応用されて初めて付いたものである．</p>
<p>連続時間のマルコフ過程である PDMP を用いた新しいモンテカルロ法も，やはり物理学における研究 <span class="citation" data-cites="Bernard+2009">(Bernard et al., 2009)</span>, <span class="citation" data-cites="Peters-deWith2012">(Peters and de&nbsp;With, 2012)</span> で最初に使われ始め，初の氷の液相転移の全原子シミュレーションも成功させている <span class="citation" data-cites="Faulkner+2018">(Faulkner et al., 2018)</span>． これに倣い統計でもBouncy Particle Sampler (BPS) <span class="citation" data-cites="Bouchard-Cote+2018-BPS">(Bouchard-Côté et al., 2018)</span> や Zig-Zag Sampler <span class="citation" data-cites="Bierkens+2019">(Bierkens et al., 2019)</span>，Forward PDMC <span class="citation" data-cites="Michel+2020">(Michel et al., 2020)</span> などの汎用アルゴリズムが提案され， この手法群に PDMP に由来する<strong>区分確定的モンテカルロ法</strong> (PDMC: Piecewise Deterministic Monte Carlo) の名前がついた．</p>
<section id="ポスターと本稿の構成" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="ポスターと本稿の構成"><span class="header-section-number">1.1</span> ポスターと本稿の構成</h3>
<p>本ポスターでは紙面を３つにわける． 本稿もこれに対応する３つの節を用意し，それぞれを詳説する． 初めに PDMC と MCMC（従来法）の違いを，シミュレートされるマルコフ過程の違いとアルゴリズムの違いの両面からみる（第 2 節）． 続いて Poisson 剪定をはじめとする PDMP のシミュレーションの自動化法を解説し， 筆者が開発したパッケージ <code>PDMPFlux.jl</code> <span class="citation" data-cites="PDMPFlux2025">(Shiba, 2025)</span> ではどのようなアプローチを取っているかを解説する（第 3 節）． 最後に MCMC では不可能であったが PDMC で可能になることとして，デルタ部分を持つ非絶対連続分布 <span id="eq-spike-and-slab"><img src="https://latex.codecogs.com/png.latex?%0Ap(dx)=%5Cprod_%7Bi=1%7D%5Ed%5Cbiggr(%5Comega_ip_i(x_i)%5C,dx_i+(1-%5Comega_i)%5Cdelta_0(dx_i)%5Cbiggl)%0A%5Ctag%7B2%7D"></span> からのサンプリング法を紹介し，ベイズ変数選択への応用に触れる（第 4 節）．</p>
</section>
</section>
<section id="sec-1" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="sec-1"><span class="header-section-number">2</span> PDMCとMCMCの違い</h2>
<p>既存の PDMC 法はいずれも， <span id="eq-pi"><img src="https://latex.codecogs.com/png.latex?%0A%5Cpi(x)%5C,%5Cpropto%5C,e%5E%7B-U(x)%7D,%5Cqquad%20U%5Cin%20C%5E1(%5Cmathbb%7BR%7D%5Ed),%0A%5Ctag%7B3%7D"></span> という表示を持つ確率分布を対象に扱う．定数の差を除いて負の対数密度 <img src="https://latex.codecogs.com/png.latex?-%5Clog%5Cpi"> にあたる <img src="https://latex.codecogs.com/png.latex?U"> をポテンシャルとも呼び，PDMC アルゴリズムはその勾配 <img src="https://latex.codecogs.com/png.latex?%5Cnabla%20U"> のみを入力に取る．さらに <img src="https://latex.codecogs.com/png.latex?%5Cnabla%20U(x)"> の計算コストが高い場合は，<img src="https://latex.codecogs.com/png.latex?%5Cnabla%20U(x)"> の不偏推定量を代わりに使うだけでも，Poisson 剪定（命題 <img src="https://latex.codecogs.com/png.latex?%5Cref%7Bprop-thinning%7D">）を通じて正確に <img src="https://latex.codecogs.com/png.latex?%5Cpi"> に収束する PDMP のシミュレーションが可能である <span class="citation" data-cites="Bierkens+2019">(Bierkens et al., 2019)</span>．MCMC では各イテレーションでデータの一部のみを用いたバッチ実行を，収束先 <img src="https://latex.codecogs.com/png.latex?%5Cpi"> を変えずに行うことが難しかったために，PDMC は特に大規模データを用いたベイズ推論への応用が期待されている．</p>
<p>PDMC と MCMC の最大の違いはアルゴリズムであるが，これはシミュレートしようとしているマルコフ過程の性質の違いに起因する． 例えば最も広く使われている MCMC 法の１つである Metropolis-adjusted Langevin 法 <span class="citation" data-cites="Besag1994">(MALA, Besag, 1994)</span> は， ポテンシャル <img src="https://latex.codecogs.com/png.latex?U"> が定める Langevin 拡散過程 <span id="eq-Langevin"><img src="https://latex.codecogs.com/png.latex?%0AdL_t=-%5Cnabla%20U(L_t)%5C,dt+%5Csqrt%7B2%7D%5C,dB_t,%0A%5Ctag%7B4%7D"></span> に基づくが，<img src="https://latex.codecogs.com/png.latex?(L_t)"> は正確なシミュレーションが困難であり，Euler-Maruyama 法などの離散化が必要になる． この段階で数値誤差が入り，このままでは大数の法則 (1) が成り立たなくなる． これを防ぐためには Metropolis-Hastings 様の棄却法を用いる必要がある． こうして，最終的にシミュレートされるマルコフ過程は離散時間過程になり，さらに人工的な対称性が導入され，収束が遅くなる．</p>
<p>PDMP とは式 (4) のような拡散過程から，拡散項 <img src="https://latex.codecogs.com/png.latex?dB_t"> を除いた代わりに，ランダムなジャンプ項を加えたものを言う． このクラスのマルコフ過程は，ジャンプの時刻を棄却法によりシミュレートすることで，離散化誤差を伴わない正確なシミュレーションが可能である． その結果人工的な対称性が少なく，一般にその分収束を速くすることができる <span class="citation" data-cites="Andrieu-Livingstone2021">(Andrieu and Livingstone, 2021)</span>．</p>
<p>式 (3) で与えられる確率分布 <img src="https://latex.codecogs.com/png.latex?%5Cpi"> を平衡分布にもつ PDMP <img src="https://latex.codecogs.com/png.latex?(X_t,V_t)"> は，次の２ステップの繰り返しでシミュレートできる． まず， <span id="eq-intensity"><img src="https://latex.codecogs.com/png.latex?%0Am(t)=%5Cbiggr(v%5Ccdot%5Cnabla%20U(x_0+tv_0)%5Cbiggl),%5Cqquad%20i=1,2,%5Ccdots%0A%5Ctag%7B5%7D"></span> を強度関数に持つ非一様 Poisson 点過程の最初の到着時刻 <img src="https://latex.codecogs.com/png.latex?T_1"> をシミュレートし，時刻 <img src="https://latex.codecogs.com/png.latex?T_1"> まで初期速度 <img src="https://latex.codecogs.com/png.latex?v_0"> で決定論的に運動する． このイベント発生地点を新しい <img src="https://latex.codecogs.com/png.latex?x_1:=x_0+T_1v_0"> とし，新たな速度 <img src="https://latex.codecogs.com/png.latex?v_1"> をサンプリングして同じことを繰り返す． 前述の BPS，Zig-Zag Sampler，Forward PDMC などの既存手法はいずれもこの枠組みの下で設計されており，新たな速度 <img src="https://latex.codecogs.com/png.latex?v_1"> の決め方のみが違う．</p>
<p>式 (5) の強度を持つ非一様 Poisson 点過程のシミュレーションでは，<strong>Poisson 剪定</strong> <span class="citation" data-cites="Lewis-Shedler1979">(thinning, Lewis and Shedler, 1979)</span> と呼ばれる棄却法が主流であるが，その実行には <img src="https://latex.codecogs.com/png.latex?m"> の上界 <img src="https://latex.codecogs.com/png.latex?M"> を構成する必要がある（次の命題参照）．ポテンシャル <img src="https://latex.codecogs.com/png.latex?U"> はモデルの尤度を含み，大変複雑である．従って <img src="https://latex.codecogs.com/png.latex?%5Cnabla%20U"> が有界になるロジスティックモデルなど，PDMC の応用先は限られると考えられていた．</p>
<!--
MCMCとPDMCではアルゴリズムは全く異なるものの，シミュレートされるマルコフ過程には深い繋がりがある．
例えば，Lifted Metropolis-Hastings と呼ばれるMCMC法の生成するMarkov連鎖$(Z_n)$を
適切に連続時間過程とみなし，過程のステップサイズを小さく，かつ，アルゴリズムの進行速度を加速するスケーリング極限を取ることで，
PDMPの例であるZig-Zag過程に収束することが示されている\cite{Bierkens-Roberts2017}．

上述のようなリフティング（状態空間の拡張）がなされたMCMCとPDMCとの関係は普遍的に見られ，
収束極限として得られるPDMPを従来の方法によらず直接シミュレートすることでアルゴリズムは大きく効率的になる \cite{Tartero-Krauth2023}．
-->
</section>
<section id="sec-2" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-2"><span class="header-section-number">3</span> 自動Poisson剪定と <code>PDMPFlux</code> パッケージの紹介</h2>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="命題 (Poisson 剪定)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
命題 (Poisson 剪定)
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?m%5Cle%20M"> を関数とする．<img src="https://latex.codecogs.com/png.latex?M"> を強度にもつ Poisson 点過程の点 <img src="https://latex.codecogs.com/png.latex?T_1,T_2,%5Ccdots"> のそれぞれについて，確率 <img src="https://latex.codecogs.com/png.latex?m(T_1)/M(T_1),m(T_2)/M(T_2),%5Ccdots"> のみで採択し，他を取り除いて残る点群は，<img src="https://latex.codecogs.com/png.latex?m"> を強度にもつ Poisson 点過程に従う．</p>
</div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?%5B0,t_%7B%5Ctext%7Bmax%7D%7D%5D"> 上の点と <img src="https://latex.codecogs.com/png.latex?%5Bt_%7B%5Ctext%7Bmax%7D%7D,2t_%7B%5Ctext%7Bmax%7D%7D%5D"> 上の点とは互いに独立に決まるため，<img src="https://latex.codecogs.com/png.latex?t_%7B%5Ctext%7Bmax%7D%7D%3E0"> はアルゴリズムのハイパーパラメータとし，最初の点 <img src="https://latex.codecogs.com/png.latex?T_1"> が採択されるまで幅 <img src="https://latex.codecogs.com/png.latex?t_%7B%5Ctext%7Bmax%7D%7D"> の区間上での剪定を繰り返せば良い．<span class="citation" data-cites="Andral-Kamatani2024">(Andral and Kamatani, 2024)</span> にて，一般の関数 <img src="https://latex.codecogs.com/png.latex?m"> に対して，その <img src="https://latex.codecogs.com/png.latex?%5B0,t_%7B%5Ctext%7Bmax%7D%7D%5D"> 上での上界を自動的に求めながら剪定を実行する方法が提案された．その方法とは次の通りである．まずグリッドの数 <img src="https://latex.codecogs.com/png.latex?n"> を固定し，<img src="https://latex.codecogs.com/png.latex?%5B0,t_%7B%5Ctext%7Bmax%7D%7D%5D"> の <img src="https://latex.codecogs.com/png.latex?n"> 等分点 <img src="https://latex.codecogs.com/png.latex?%5C%7B0=t_0%3Ct_1%3C%5Ccdots%3Ct_n=t_%7B%5Ctext%7Bmax%7D%7D%5C%7D"> を考え，各点 <img src="https://latex.codecogs.com/png.latex?t_i"> 上での接線を自動微分 <span class="citation" data-cites="Baydin+2017">(Baydin et al., 2017)</span> を用いて計算する．続いてそれらの接線同士の交点を求め，その <img src="https://latex.codecogs.com/png.latex?y"> 座標と両端点 <img src="https://latex.codecogs.com/png.latex?m(t_i),m(t_%7Bi+1%7D)"> の３点の最大値を，小区間 <img src="https://latex.codecogs.com/png.latex?%5Bt_i,t_%7Bi+1%7D%5D"> 上での <img src="https://latex.codecogs.com/png.latex?m"> の上界とする．</p>
<p>こうして得られた <img src="https://latex.codecogs.com/png.latex?%5B0,t_%7B%5Ctext%7Bmax%7D%7D%5D"> 上の区分定数関数 <img src="https://latex.codecogs.com/png.latex?M"> は，<img src="https://latex.codecogs.com/png.latex?t_%7B%5Ctext%7Bmax%7D%7D%5Cto0"> または <img src="https://latex.codecogs.com/png.latex?n%5Cto%5Cinfty"> の極限で <img src="https://latex.codecogs.com/png.latex?m"> の上界を与えるが，<img src="https://latex.codecogs.com/png.latex?m"> が <img src="https://latex.codecogs.com/png.latex?%5B0,t_%7B%5Ctext%7Bmax%7D%7D%5D"> 上で激しく変化する場合，<img src="https://latex.codecogs.com/png.latex?m"> の上界になっていない場合がある．そこで <span class="citation" data-cites="Andral-Kamatani2024">(Andral and Kamatani, 2024)</span> は，Poisson 剪定の最中に評価される比 <img src="https://latex.codecogs.com/png.latex?m(t)/M(t)%3E1"> が１を超えた場合，<img src="https://latex.codecogs.com/png.latex?t_%7B%5Ctext%7Bmax%7D%7D"> の値を縮めて <img src="https://latex.codecogs.com/png.latex?%5B0,t_%7B%5Ctext%7Bmax%7D%7D%5D"> 上での剪定をやり直す．Andral は Python パッケージ <a href="https://github.com/charlyandral/pdmp_jax"><code>pdmp_jax</code></a> にこのアルゴリズムを実装し，BPS, Zig-Zag Sampler, Forward PDMC を含む５つのサンプラーを利用可能にした．</p>
<p>しかし，この方法は <img src="https://latex.codecogs.com/png.latex?M(t)%3Cm(t)"> が発生してしまっている点 <img src="https://latex.codecogs.com/png.latex?t"> を検出できずに，<img src="https://latex.codecogs.com/png.latex?t%3CT_1"> を満たす到着時刻 <img src="https://latex.codecogs.com/png.latex?T_1"> を提案してしまった場合に，シミュレートしている PDMP に漸近的に消えないバイアスを導入してしまう．従って <img src="https://latex.codecogs.com/png.latex?U"> の性質に対してグリッド数 <img src="https://latex.codecogs.com/png.latex?n"> を小さく，または <img src="https://latex.codecogs.com/png.latex?t_%7B%5Ctext%7Bmax%7D%7D"> を大きく取りすぎた場合，<img src="https://latex.codecogs.com/png.latex?M"> の誤りを検出できず，使用者が知らないうちに大数の法則 (1) が成り立たなくなってしまっている可能性がある．</p>
<p>筆者の開発したパッケージ <code>PDMPFlux</code> <span class="citation" data-cites="PDMPFlux2025">(Shiba, 2025)</span> ではこの問題の解決を図った．<img src="https://latex.codecogs.com/png.latex?M(t)%3Cm(t)"> が小区間 <img src="https://latex.codecogs.com/png.latex?t%5Cin%5Bt_i,t_%7Bi+1%7D%5D"> で発生するためには，<img src="https://latex.codecogs.com/png.latex?m"> が <img src="https://latex.codecogs.com/png.latex?%5Bt_i,t_%7Bi+1%7D%5D"> 上で１つ以上の変曲点を持つ必要があることに注目する．そこでグリッド <img src="https://latex.codecogs.com/png.latex?%5C%7Bt_i%5C%7D_%7Bi=0%7D%5EN"> 上で接線だけでなく２階微分係数も計算し，<img src="https://latex.codecogs.com/png.latex?m"> が <img src="https://latex.codecogs.com/png.latex?%5B0,t_%7B%5Ctext%7Bmax%7D%7D%5D"> 上で高々１つしか変曲点を持たないように <img src="https://latex.codecogs.com/png.latex?t_%7B%5Ctext%7Bmax%7D%7D"> を調整することを提案した．このことにより，<img src="https://latex.codecogs.com/png.latex?U"> の Lipscthiz 係数に関する一定の仮定の下で，<img src="https://latex.codecogs.com/png.latex?t_%7B%5Ctext%7Bmax%7D%7D%5Cto0,N%5Cto%5Cinfty"> の極限を考えずとも，<img src="https://latex.codecogs.com/png.latex?m%3CM"> の成立を保証できるようになる．</p>
<p>こうしてパッケージ <code>PDMPFlux</code> はポテンシャル <img src="https://latex.codecogs.com/png.latex?U"> を与えるだけで <img src="https://latex.codecogs.com/png.latex?%5Cpi"> からの正確な PDMP サンプリングを実行することのできるほとんど唯一のパッケージとなった．加えて，第 4 節で後述する Sticky Zig-Zag を加えた６つのアルゴリズムが利用可能である．MCMC ベースのベイズ推論エンジンである Stan に替わる，新たなバックエンドとしての利用も可能である．</p>
</section>
<section id="sec-3" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="sec-3"><span class="header-section-number">4</span> スパイク付きの非絶対連続分布からのサンプリング</h2>
<p>MCMC では難しく，PDMC で真に新たに可能になったこととして，式 (2) で与えられるような，<img src="https://latex.codecogs.com/png.latex?%5Cdelta">-部分を持った非絶対連続確率分布 <img src="https://latex.codecogs.com/png.latex?p"> からのサンプリングが挙げられる．この事実は次のようにも理解できる．式 (2) で与えられるような <img src="https://latex.codecogs.com/png.latex?%5Cdelta_0">-部分を持った分布 <img src="https://latex.codecogs.com/png.latex?p"> は，<img src="https://latex.codecogs.com/png.latex?%5Cdelta_0">-部分を分散が小さい正規分布 <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BN%7D(dx_i;0,%5Cepsilon%5E2)"> に近似した <span id="eq-continuous-spike-and-slab"><img src="https://latex.codecogs.com/png.latex?%0Ap_%5Cepsilon(dx)=%5Cprod_%7Bi=1%7D%5Ed%5Cbiggr(%5Comega_ip_i(x_i)%5C,dx_i+(1-%5Comega_i)%5Coperatorname%7BN%7D(dx_i;0,%5Cepsilon%5E2)%5Cbiggl)%0A%5Ctag%7B6%7D"></span> という絶対連続分布の，分散が小さくなる極限 <img src="https://latex.codecogs.com/png.latex?%5Cepsilon%5Cto0"> と理解できる．多くの標準的な MCMC は <img src="https://latex.codecogs.com/png.latex?p_%5Cepsilon"> からのサンプリングは可能でも，<img src="https://latex.codecogs.com/png.latex?%5Cepsilon%5Cto0"> の極限で誤った分布 <img src="https://latex.codecogs.com/png.latex?%5Cotimes_%7Bi=1%7D%5Edp_i%5Cne%20p"> に収束するマルコフ過程に収束してしまう（未発表原稿）．さらに <img src="https://latex.codecogs.com/png.latex?%5Cepsilon%3E0"> が小さいほど，長時間の相関が強くなり，非現実的なほど長い時間アルゴリズムを実行しない限り，大きなバイアスを持ってしまう．</p>
<p>一方で標準的な PDMP は <img src="https://latex.codecogs.com/png.latex?%5Cepsilon%5Cto0"> の極限でもまた別の PDMP になり，これは正確に <img src="https://latex.codecogs.com/png.latex?p"> に収束する．この極限過程を直接シミュレーションすることで，<img src="https://latex.codecogs.com/png.latex?p"> からのサンプリングを効率的に実現する手法 Sticky PDMP が <span class="citation" data-cites="Bierkens+2023">(Bierkens et al., 2023)</span> により提案された．</p>
<p>Sticky PDMP はベイズ変数選択に大きな応用を持つ．<span class="citation" data-cites="Mitchell-Beauchamp1988">(Mitchell and Beauchamp, 1988)</span> で提案された spike-and-slab 事前分布はまさに式 (2) で与えられる形をしているが，従来の MCMC では直接の事後分布サンプリングが難しかったため，モデルの空間 <img src="https://latex.codecogs.com/png.latex?%5C%7B0,1%5C%7D%5Ed"> 上で動く Gibbs サンプラーと組み合わせてサンプリングをしたり <span class="citation" data-cites="George-McCulloch1993">(George and McCulloch, 1993)</span>，連続近似 (6) を代わりに用いたりされることが多かった．しかし，連続近似をベイズ変数選択に用いた場合は，説明変数 <img src="https://latex.codecogs.com/png.latex?x_i"> がモデルに含まれる事後確率 (PIP: Posterior Inclusion Probability) を正確に計算するために追加の処理が必要になる <span class="citation" data-cites="Hahn-Carvalho2015">(Hahn and Carvalho, 2015)</span>．</p>
<p>筆者は Sticky PDMP のダイナミクスを分析すると同時に，Sticky Zig-Zag アルゴリズムを <code>PDMPFlux</code> に実装することで，<img src="https://latex.codecogs.com/png.latex?%5Cdelta">-部分を持った非絶対連続分布 <img src="https://latex.codecogs.com/png.latex?p"> からのサンプリングが可能であることの，ベイズ変数選択以外への応用も模索している．例えば，特定の密度推定の問題においてミニマックス最適なベイズ事後密度推定量を与える事前分布は離散分布になる <span class="citation" data-cites="Gangopadhyay-Muhkerjee2021">(Gangopadhyay and Mukherjee, 2021)</span> ように，非絶対連続事前分布を用いることで正確に計算可能なベイズ推定量の幅が広がる可能性がある．</p>
</section>
<section id="参考文献" class="level2" data-number="5">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">5 参考文献</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Andral-Kamatani2024" class="csl-entry">
Andral, C., and Kamatani, K. (2024). <a href="https://arxiv.org/abs/2408.03682">Automated techniques for efficient sampling of piecewise-deterministic markov processes</a>.
</div>
<div id="ref-Andrieu-Livingstone2021" class="csl-entry">
Andrieu, C., and Livingstone, S. (2021). <a href="https://doi.org/10.1214/20-AOS2008"><span class="nocase">Peskun–Tierney ordering for Markovian Monte Carlo: Beyond the reversible scenario</span></a>. <em>The Annals of Statistics</em>, <em>49</em>(4), 1958–1981.
</div>
<div id="ref-Baydin+2017" class="csl-entry">
Baydin, A. G., Pearlmutter, B. A., Radul, A. A., and Siskind, J. M. (2017). <a href="http://www.jmlr.org/papers/v18/17-468.html">Automatic differentiation in machine learning: A survey</a>. <em>J. Mach. Learn. Res.</em>, <em>18</em>(1), 5595–5637.
</div>
<div id="ref-Bernard+2009" class="csl-entry">
Bernard, E. P., Krauth, W., and Wilson, D. B. (2009). <a href="https://doi.org/10.1103/PhysRevE.80.056704">Event-chain monte carlo algorithms for hard-sphere systems</a>. <em>Phys. Rev. E</em>, <em>80</em>, 056704.
</div>
<div id="ref-Besag1994" class="csl-entry">
Besag, J. E. (1994). <a href="https://www.jstor.org/stable/2346184"><span class="nocase">Comments on <span>“Representations of Knowledge in Complex Systems”</span> by U. Grenander and M. I. Miller</span></a>. <em>Journal of the Royal Statistical Society. Series B (Methodological)</em>, <em>56</em>(4), 591–592.
</div>
<div id="ref-Bierkens+2019" class="csl-entry">
Bierkens, J., Fearnhead, P., and Roberts, G. (2019). <a href="https://doi.org/10.1214/18-AOS1715"><span class="nocase">The Zig-Zag Process and Super-Efficient Sampling for Bayesian Analysis of Big Data</span></a>. <em>The Annals of Statistics</em>, <em>47</em>(3), 1288–1320.
</div>
<div id="ref-Bierkens+2023" class="csl-entry">
Bierkens, J., Grazzi, S., Meulen, F. van der, and Schauer, M. (2023). <a href="https://doi.org/10.1007/s11222-022-10180-5"><span class="nocase">Sticky PDMP Samplers for Sparse and Local Inference Problems</span></a>. <em>Statistics and Computing</em>, <em>33</em>(1), 8.
</div>
<div id="ref-Bouchard-Cote+2018-BPS" class="csl-entry">
Bouchard-Côté, A., Vollmer, S. J., and Doucet, A. (2018). <a href="https://www.tandfonline.com/doi/full/10.1080/01621459.2017.1294075">The bouncy particle sampler: A nonreversible rejection-free markov chain monte carlo method</a>. <em>Journal of the American Statistical Association</em>, <em>113</em>(522), 855–867.
</div>
<div id="ref-Doucet+2001" class="csl-entry">
Doucet, A., Freitas, N., and Gordon, N. (Eds.). (2001). <em><a href="https://doi.org/10.1007/978-1-4757-3437-9"><span class="nocase">Sequential Monte Carlo Methods in Practice</span></a></em>. Springer New York.
</div>
<div id="ref-Faulkner+2018" class="csl-entry">
Faulkner, M. F., Qin, L., Maggs, A. C., and Krauth, W. (2018). <a href="https://doi.org/10.1063/1.5036638">All-atom computations with irreversible markov chains</a>. <em>The Journal of Chemical Physics</em>, <em>149</em>(6), 064113.
</div>
<div id="ref-Gangopadhyay-Muhkerjee2021" class="csl-entry">
Gangopadhyay, U., and Mukherjee, G. (2021). <a href="https://doi.org/10.1214/21-EJS1818"><span class="nocase">On discrete priors and sparse minimax optimal predictive densities</span></a>. <em>Electronic Journal of Statistics</em>, <em>15</em>(1), 1636–1660.
</div>
<div id="ref-Geman-Geman1984" class="csl-entry">
Geman, S., and Geman, D. (1984). <a href="https://doi.org/10.1109/TPAMI.1984.4767596"><span class="nocase">Stochastic Relaxation, Gibbs Distributions, and the Bayesian Restoration of Images</span></a>. <em>IEEE Transactions on Pattern Analysis and Machine Intelligence</em>, <em>PAMI-6</em>(6), 721–741.
</div>
<div id="ref-George-McCulloch1993" class="csl-entry">
George, E. I., and McCulloch, R. E. (1993). <a href="http://www.jstor.org/stable/2290777">Variable selection via gibbs sampling</a>. <em>Journal of the American Statistical Association</em>, <em>88</em>(423), 881–889.
</div>
<div id="ref-InPractice1996" class="csl-entry">
Gilks, W. R., Richardson, S., and Spiegelhalter, D. (Eds.). (1996). <em><a href="https://doi.org/10.1201/b14835"><span class="nocase">Markov Chain Monte Carlo in Practice</span></a></em>. Chapman &amp; Hall.
</div>
<div id="ref-Glauber1963" class="csl-entry">
Glauber, R. J. (1963). <a href="https://doi.org/10.1063/1.1703954"><span class="nocase">Time-Dependent Statistics of the Ising Model</span></a>. <em>Journal of Mathematical Physics</em>, <em>4</em>(2), 294–307.
</div>
<div id="ref-Hahn-Carvalho2015" class="csl-entry">
Hahn, P. R., and Carvalho, C. M. (2015). <a href="https://doi.org/10.1080/01621459.2014.993077">Decoupling shrinkage and selection in bayesian linear models: A posterior summary perspective</a>. <em>Journal of the American Statistical Association</em>, <em>110</em>(509), 435–448. doi: 10.1080/01621459.2014.993077.
</div>
<div id="ref-Hastings1970" class="csl-entry">
Hastings, W. K. (1970). <a href="https://www.jstor.org/stable/2334940"><span class="nocase">Monte Carlo Sampling Methods Using Markov Chains and Their Applications</span></a>. <em>Biometrika</em>, <em>57</em>(1), 97–109.
</div>
<div id="ref-Kulik2018" class="csl-entry">
Kulik, A. (2018). <em><a href="https://doi.org/10.1515/9783110458930">Ergodic behavior of markov processes: With applications to limit theorems</a></em>,Vol. 67. De Gruyter: Berlin, Boston.
</div>
<div id="ref-Lewis-Shedler1979" class="csl-entry">
Lewis, P. A. W., and Shedler, G. S. (1979). <a href="https://doi.org/10.1002/nav.3800260304">Simulation of nonhomogeneous poisson processes by thinning</a>. <em>Naval Research Logistics Quarterly</em>, <em>26</em>(3), 403–413.
</div>
<div id="ref-Martin+2024" class="csl-entry">
Martin, G. M., Fraizier, D. T., and Robert, C. P. (2024). <a href="https://projecteuclid.org/journals/statistical-science/volume-39/issue-1/Computing-Bayes-From-Then-Til-Now/10.1214/22-STS876.short">Computing bayes: From then ‘til now</a>. <em>Statistical Science</em>, <em>Advanced Publication</em>, 1–17.
</div>
<div id="ref-Metropolis+1953" class="csl-entry">
Metropolis, N., Rosenbluth, A. W., Rosenbluth, M. N., Teller, A. H., and Teller, E. (1953). <a href="https://doi.org/10.1063/1.1699114">Equation of state calculations by fast computing machines</a>. <em>The Journal of Chemical Physics</em>, <em>21</em>(6), 1087–1092.
</div>
<div id="ref-Michel+2020" class="csl-entry">
Michel, M., Durmus, A., and Sénécal, S. (2020). <a href="https://doi.org/10.1080/10618600.2020.1750417">Forward event-chain monte carlo: Fast sampling by randomness control in irreversible markov chains</a>. <em>Journal of Computational and Graphical Statistics</em>, <em>29</em>(4), 689–702.
</div>
<div id="ref-Mitchell-Beauchamp1988" class="csl-entry">
Mitchell, T. J., and Beauchamp, J. J. (1988). <a href="http://www.jstor.org/stable/2290129">Bayesian variable selection in linear regression</a>. <em>Journal of the American Statistical Association</em>, <em>83</em>(404), 1023–1032.
</div>
<div id="ref-Peters-deWith2012" class="csl-entry">
Peters, E. A. J. F., and de&nbsp;With, G. (2012). <a href="https://journals.aps.org/pre/abstract/10.1103/PhysRevE.85.026703">Rejection-free monte carlo sampling for general potentials</a>. <em>Physical Review E</em>, <em>85</em>(2).
</div>
<div id="ref-PDMPFlux2025" class="csl-entry">
Shiba, H. (2025). <a href="https://doi.org/10.5281/zenodo.14792019">PDMPFlux v0.3.3</a>. Package Release.
</div>
</div></section></div> ]]></description>
  <category>PDMP</category>
  <guid>https://162348.github.io/posts/2025/Posters/第19回日本統計学会春季集会.html</guid>
  <pubDate>Tue, 25 Feb 2025 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2025/Posters/Images/preprint.png" medium="image" type="image/png" height="93" width="144"/>
</item>
<item>
  <title>Implementation Details of PDMPFlux.jl</title>
  <dc:creator>Hirofumi Shiba</dc:creator>
  <link>https://162348.github.io/posts/2024/Julia/Details.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>In this introduction, we quickly give an overview of how the PDMPFlux.jl package works, through a standard example.</p>
<p>Take the Sticky Zig-Zag Sampler <span class="citation" data-cites="Bierkens+2023">(Bierkens et al., 2023)</span> as an example.</p>
<ol type="1">
<li><p><code>sampler = StickyZigZag(dim, ∇U)</code></p>
<p>This instantiates the sampler, an object of an <code>AbstractPDMP</code> subtype.</p></li>
<li><p><code>output = sample_skeleton(sampler, N_sk, xinit, vinit)</code></p>
<p>This takes a sampler object, and returns a <code>PDMPHistory</code> object, by transforming the <code>PDMPState</code> object while pushing its snapshots into the <code>PDMPHistory</code> object.</p></li>
</ol>
</section>
<section id="directory-structure-of-pdmpflux.jlsrc" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="directory-structure-of-pdmpflux.jlsrc"><span class="header-section-number">2</span> Directory Structure of <code>PDMPFlux.jl/src</code></h2>
<section id="sec-Composites" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="sec-Composites"><span class="header-section-number">2.1</span> <code>Composites.jl</code></h3>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>composites / constructs such as <code>BoundBox</code>, <code>PDMPState</code>, <code>PDMPHistory</code> are defined.</p>
<ul>
<li><p><code>BoundBox</code> is basically a grid, together with the values on it, tailored to perform Poisson thinning. 3 constructors are defined in <code>UpperBound.jl</code> Section&nbsp;2.4.</p>
<ul>
<li><code>boundbox.grid</code> is the grid points. Let the dimension be <code>n_grid</code>, which is a field of any <code>AbstractPDMP</code> subtype.</li>
<li>The grid is equi-spaced, with the step size <code>step_size</code>.</li>
<li><code>boundbox.box_max</code> has <code>n_grid - 1</code> elements <img src="https://latex.codecogs.com/png.latex?%0A%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bbox%5C_max%5Bi%5D%7D%7D%20=%20%5Cmax_%7Bt%20%5Cin%20%5B%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bgrid%5Bi%5D%7D%7D,%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bgrid%5Bi+1%5D%7D%7D%5D%7D%20%5Clambda(t),%5Cqquad%20i%5Cin%5B%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bn%5C_grid-1%7D%7D%5D.%0A"></li>
<li><code>boundbox.cum_sum</code> has <code>n_grid</code> elements, and <img src="https://latex.codecogs.com/png.latex?%0A%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bcum%5C_sum%5Bi%5D%7D%7D%20=%20%5Csum_%7Bj=1%7D%5E%7Bi-1%7D%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bbox%5C_max%5Bj%5D%7D%7D%5Ctimes%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bstep%5C_size%7D%7D,%5Cqquad%20i%5Cin%5B%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bn%5C_grid%7D%7D%5D.%0A"> Note that it is not the cumulative sum of <code>box_max</code>, but the cumulative sum of the piecewise constant (upper bound) function represented by <code>box_max</code>’s: <img src="https://latex.codecogs.com/png.latex?%0A%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bcum%5C_sum%5Bi%5D%7D%7D%20=%20%5Cint%5Ei_0%5Csum_%7Bj=1%7D%5E%7B%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bn%5C_grid%7D-1%7D%7D1_%7B%5B%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bgrid%5Bj%5D%7D%7D,%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bgrid%5Bj+1%5D%7D%7D)%7D(t)%5Ccdot%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bbox%5C_max%5Bj%5D%7D%7D%5C,dt,%5Cqquad%20i%5Cin%5B%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bn%5C_grid%7D%7D%5D.%0A"></li>
</ul></li>
<li><p><code>PDMPState</code> is used to keep the position of the sampler, together with caracteristics and diagnostic information. The whole <code>SamplingLoop.jl</code> Section&nbsp;2.3 is implemented as a collection of functions that modify the <code>PDMPState</code> object in place. In addition to the <img src="https://latex.codecogs.com/png.latex?(x,v,t)"> tuple, the fields include</p>
<ul>
<li>methods specific to the sampler.
<ul>
<li><code>state.rate</code> and <code>state.rate_vect</code> are the rate function and its vectorized version. These slots are determined after checking the field <code>pdmp.signed_bound</code> in <code>init_state()</code> in <code>AbstractPDMP.jl</code> Section&nbsp;3.2.</li>
<li><code>state.upper_bound_func()</code> takes <img src="https://latex.codecogs.com/png.latex?(x,v,t)"> and returns the <code>BoundBox</code> object. Basically, <code>state.upper_bound_func()</code> is the only field that differs among samplers.</li>
<li><code>state.velocity_jump()</code> takes <img src="https://latex.codecogs.com/png.latex?(x,v,t)"> and returns the velocity vector after the PDMP’s jump.</li>
<li><code>state.flow()</code> takes <img src="https://latex.codecogs.com/png.latex?(x_0,v_0,t)"> and returns <img src="https://latex.codecogs.com/png.latex?(x_t,v_t)">, which indicates the PDMP’s position after the time <img src="https://latex.codecogs.com/png.latex?t"> from <img src="https://latex.codecogs.com/png.latex?(x_0,v_0)">.</li>
</ul></li>
<li>fields to facilitate the sampling loop.
<ul>
<li>boolean flags to indicate whether Poisson thinning proposal is accepted or not, which is used within <code>ac_step_with_proxy()</code> in the <code>SamplingLoop.jl</code> Section&nbsp;2.3.</li>
<li>proposed jump time <code>tp</code> and time already spent <code>ts</code>. They are using in <code>SamplingLoop.jl</code> Section&nbsp;2.3 to conduct poisson thinning, where <code>tp</code> is the proposed jump time, and is added to <code>ts</code> when rejected.</li>
<li><code>horizon</code> is passed to upper-bounding functions to create a <code>BoundBox</code> object.</li>
</ul></li>
<li>statistics to diagnose the sampler dynamic.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</section>
<section id="sec-sample" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="sec-sample"><span class="header-section-number">2.2</span> <code>sample.jl</code></h3>
<p><code>sample.jl</code> contains functions, called by users, to start MCMC sampling. The <code>ProgressBar</code> package is used to be friendly to users.</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><code>sample.jl</code> contains 2 functions, and <code>sample()</code> that calls them in sequel.</p>
<ul>
<li><code>sample_skeleton() -&gt; PDMPHistory</code> initializes the progress bar and <code>PDMPState</code> &amp; <code>PDMPHistory</code> objects, using <code>init_state()</code> and <code>PDMPHistory()</code> constructor respectively. Then call <code>get_event_state()</code> in <code>SamplingLoop.jl</code> Section&nbsp;2.3 for <code>iter::Int</code> times.</li>
<li><code>sample_from_skeleton() -&gt; Matrix{Float64}</code> is a function that generates samples, which might subsequently be called by the plotting functions in <code>plot.jl</code>.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="sec-SamplingLoop" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="sec-SamplingLoop"><span class="header-section-number">2.3</span> <code>SamplingLoop.jl</code></h3>
<p>This module contains 10 functions. Some of them are summarized in the following figure:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Julia/Files/NewSamplingLoop.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>The main loop for sampling is implemented here.</p>
<ul>
<li><p><code>get_event_state() -&gt; PDMPState</code> is the entering point from <code>sample.jl</code>.</p>
<ul>
<li><p>There is only one thing in <code>get_event_state()</code>, i.e., callling <code>one_step_of_thinning()</code> until <code>state.accept</code> becomes <code>true</code>.</p></li>
<li><p><code>get_event_state()</code> returns a <code>PDMPState</code> object with the field <img src="https://latex.codecogs.com/png.latex?(x,v,t)"> indicating where an accepted event happens, which is pushed to <code>PDMPHistory</code> back in <code>sample_skeleton()</code> in <code>sample.jl</code> Section&nbsp;2.2.</p></li>
</ul></li>
<li><p><code>one_step_of_thinning()</code> returns where simulation has completed up to, with <code>state.accept = false</code> if any proposal isnot accepted yet.</p>
<ul>
<li><p>Firstly, it proposes the next jump event, by simulating <code>exp_rv</code> and calling <code>next_event(upper_bound, exp_rv) -&gt; (tp, lambda_bar)</code>.</p>
<ul>
<li><code>upper_bound</code> is the <code>BoundBox</code> object, which is calculated by <code>state.upper_bound_func()</code> and the current state <code>(x,v,t)</code>.</li>
<li><code>tp</code> is the proposed jump time.</li>
<li><code>lambda_bar</code> is a upper bound, <em>with error</em>, for the rate function <img src="https://latex.codecogs.com/png.latex?%5Clambda">.</li>
</ul></li>
<li><p>Secondly, it checks whether <code>tp &lt;= state.horizon</code>.</p>
<ul>
<li>If not, it calls <code>move_to_horizon()</code> and continues the loop <code>one_step_of_thinning()</code> inside <code>get_event_state()</code>.</li>
<li>If yes, it proceeds to <code>moves_until_horizon()</code>, where another loop, calling <code>ac_step()</code>, is performed until one of the following 2 happens
<ul>
<li>when <code>state.accept</code> becomes <code>true</code>, it gets out of the both loops.</li>
<li>when <code>tp &gt; state.horizon</code>, it calls <code>move_to_horizon2()</code> to get out of <code>ac_step()</code> loop, and continues the loop <code>one_step_of_thinning()</code> inside <code>get_event_state()</code>.</li>
</ul></li>
</ul></li>
</ul></li>
<li><p><code>ac_step()</code>, standing for acceptance-rejection step, is the core of Poisson thinning.</p>
<ul>
<li><p>calculating the <strong>acceptance rate</strong> <code>ar</code>, <em>which might exceed <img src="https://latex.codecogs.com/png.latex?1.0"></em>.</p>
<p>In that case, <code>erroneous_acceptance_rate()</code> is called to shrink the <code>horizon</code> by half, and then continues the <code>ac_step()</code> loop in <code>moves_until_horizon()</code> function. Shrinking <code>horizon</code> leads to a finer grid, since <code>n_grid</code> is fixed.</p></li>
<li><p>Otherwise, it performs the Poisson thinning using the proxy rate <code>lambda_bar</code>, in <code>ac_step_with_proxy()</code> call.</p>
<ul>
<li>Within <code>ac_step_with_proxy()</code>, either <code>if_accept()</code> or <code>if_reject()</code> is called depending on the result of Poisson thinning, followed by <code>move_to_horizon2()</code> if accepted. Whether accepted or not is informed by <code>state.accept</code> flag, which will lead you out of all the loops.</li>
<li>In <code>if_accept()</code>, the flags are updated as <code>state.accept = true</code> &amp; <code>state.accept = true</code>, getting out of both <code>ac_step()</code> loop and <code>one_step_of_thinning()</code> loop, with the correct <img src="https://latex.codecogs.com/png.latex?(x,v,t)"> stored in appropriate <code>state</code>’s fields, which is pushed to <code>PDMPHistory</code> back in <code>sample_skeleton()</code> in <code>sample.jl</code> Section&nbsp;2.2.</li>
<li><code>if_reject()</code> being called, we are still in the <code>ac_step()</code> loop in <code>moves_until_horizon()</code>, until acceptance or <code>tp &gt; state.horizon</code>.</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
</section>
<section id="sec-UpperBound" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="sec-UpperBound"><span class="header-section-number">2.4</span> <code>UpperBound.jl</code></h3>
<p>This module contains <code>next_event()</code> function and 3 constructors for <code>BoundBox</code> object, with the name of <code>upper_bound_**()</code>.</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="3 constructors for `BoundBox` object">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
3 constructors for <code>BoundBox</code> object
</div>
</div>
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">upper_bound_**</span>(func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Function</span>, start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>, horizon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> BoundBox</span></code></pre></div>
<ul>
<li><p><code>upper_bound_constant()</code> computes the constant upper bound for the function <code>func</code> over the interval <code>[start, horizon]</code>.</p>
<p>Technically, it returns the <code>BoundBox</code> object, with just 2 grid points, <code>start</code> and <code>horizon</code>. The maximum value is searched by the Brent’s algorithm via <a href="https://github.com/JuliaNLSolvers/Optim.jl"><code>Optim.jl</code> package</a>.</p></li>
<li><p><code>upper_bound_grid()</code> computes a piecewise constant upper bound, using the <code>n_grid</code> grid points.</p>
<p>The <code>box_max[i]</code> field is the maximum value of the three points in the interval <code>[grid[i], grid[i+1]]</code>, which are the values on the two edges <code>func(grid[i])</code>, <code>func(grid[i+1])</code>, and the intersection point of the two tangents on the two edges of the interval.</p></li>
<li><p><code>upper_bound_grid_vect()</code> is a <code>LinearAlgebra</code> implementation of <code>upper_bound_grid()</code>.</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="`next_event(boundbox, exp_rv)` takes `boundbox` to propose a next event time">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>next_event(boundbox, exp_rv)</code> takes <code>boundbox</code> to propose a next event time
</div>
</div>
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1">index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">searchsortedfirst</span>(boundbox.cum_sum, exp_rv)</span></code></pre></div>
<p>is performed to find the <code>index</code> that satisfies</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bexp%5C_rv%7D%7D%20%5Cin%20%5Cleft%5B%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bcum%5C_sum%5Bindex-1%5D%7D%7D,%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bcum%5C_sum%5Bindex%5D%7D%7D%5Cright).%0A"></p>
<p>Finally, <code>t_prop</code> that satisfies</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cint%5E%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bt%5C_prop%7D%7D_0%20%5Coverline%7B%5Clambda%7D(t)%5C,dt%20=%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bexp%5C_rv%7D%7D,%0A"> where <img src="https://latex.codecogs.com/png.latex?%5Coverline%7B%5Clambda%7D(t)"> is the piecewise constant upper-bounding function defined by <img src="https://latex.codecogs.com/png.latex?%0A%5Coverline%7B%5Clambda%7D(t)%20=%20%5Csum_%7Bj=1%7D%5E%7B%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bn%5C_grid%7D-1%7D%7D1_%7B%5B%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bgrid%5Bj%5D%7D%7D,%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bgrid%5Bj+1%5D%7D%7D)%7D(t)%5Ccdot%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bbox%5C_max%5Bj%5D%7D%7D.%0A"></p>
<p><code>next_event()</code> returns the jump time <code>t_prop</code> and the corresponding upper bound value <code>upper_bound</code>, i.e., <img src="https://latex.codecogs.com/png.latex?%0A%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bupper%5C_bound%7D%7D%20=%20%5Coverline%7B%5Clambda%7D(%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bt%5C_prop%7D%7D)%20=%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bbox%5C_max%5Bindex-1%5D%7D%7D.%0A"></p>
</div>
</div>
</section>
<section id="diagnostic.jl" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="diagnostic.jl"><span class="header-section-number">2.5</span> <code>diagnostic.jl</code></h3>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">anim_traj</span>(</span>
<span id="cb3-2">    history<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">PDMPHistory</span>, </span>
<span id="cb3-3">    N_max<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>; </span>
<span id="cb3-4">    N_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb3-5">    plot_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb3-6">    filename<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Union{String, Nothing}</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>, </span>
<span id="cb3-7">    plot_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2D"</span>, </span>
<span id="cb3-8">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#78C2AD"</span>, </span>
<span id="cb3-9">    background<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FFF"</span>, </span>
<span id="cb3-10">    coordinate_numbers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], </span>
<span id="cb3-11">    dt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb3-12">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Bool</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>, </span>
<span id="cb3-13">    fps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, </span>
<span id="cb3-14">    frame_upper_limit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>, </span>
<span id="cb3-15">    linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, </span>
<span id="cb3-16">    dynamic_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Bool</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span></span>
<span id="cb3-17">)</span></code></pre></div>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="arguments of `anim_traj()`">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
arguments of <code>anim_traj()</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>history</code> takes the output of <code>sample_skeleton()</code>.</li>
<li><code>N_start, N_max</code> are the indeces of <code>history</code> to be plotted. Namely, from <code>N_start</code> th event, including reflection, refreshing, and thawing events, to <code>N_max</code> th event.</li>
<li><code>plot_start</code> is the starting index of the animation. The points of <code>history.x[1:plot_start]</code> will be already there in the first frame of the animation.</li>
<li><code>frame_upper_limit</code> is the maximum number of frames to be plotted.</li>
<li><code>fps</code> is the frame rate of the animation.</li>
<li><code>dynamic_range</code> is a boolean flag to determine whether to use the dynamic range for the animation.</li>
</ul>
</div>
</div>
</section>
<section id="plot.jl" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="plot.jl"><span class="header-section-number">2.6</span> <code>plot.jl</code></h3>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>This file contains functions to plot the samples generated by <code>sample.jl</code>.</p>
</div>
</div>
</div>
</section>
</section>
<section id="implementation-of-the-samplers" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="implementation-of-the-samplers"><span class="header-section-number">3</span> Implementation of the Samplers</h2>
<section id="introduction-1" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="introduction-1"><span class="header-section-number">3.1</span> Introduction</h3>
<p>All samplers are defined as subtypes of <code>AbstractPDMP</code> in <code>Samplers/AbstractPDMP.jl</code> Section&nbsp;3.2.</p>
<p>Different samplers have four different fields in <code>PDMPState</code> object, which are <code>upper_bound_func</code>, <code>rate</code>, <code>rate_vect</code>, and <code>velocity_jump</code>, as we learned in Section&nbsp;2.1.</p>
<p>The four special fields are initialized in the constructor defined in the respective <code>Samplers/&lt;Name&gt;.jl</code> module.</p>
</section>
<section id="sec-AbstractPDMP" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="sec-AbstractPDMP"><span class="header-section-number">3.2</span> <code>Samplers/AbstractPDMP.jl</code></h3>
<p>This module contains one line</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">abstract type</span> AbstractPDMP <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div>
<p>and one function, whose signature is</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">init_state</span>(pdmp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractPDMP</span>, xinit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Array{Float64}</span>, vinit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Array{Float64}</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> PDMPState</span></code></pre></div>
<p>This <code>init_state()</code> is basically a constructor for <code>PDMPState</code>, called in <code>sample_skeleton()</code> Section&nbsp;2.2.</p>
<p>It is defined in <code>AbstractPDMP.jl</code> because the composite <code>PDMPState</code> must have different field values depending on the type of the argument <code>pdmp</code>.</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="`init_state()` mainly does two things">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>init_state()</code> mainly does two things
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Check the field <code>pdmp.signed_bound</code> and modify the 3 fields <code>rate</code>, <code>rate_vect</code>, <code>refresh_rate</code> accordingly, which were already initialized in the respective constructor of <code>pdmp</code>.</li>
<li>Check the field <code>pdmp.grid_size</code> &amp; <code>pdmp.vectorized_bound</code> and initialize the field <code>upper_bound_func</code> as one of the functions in the <code>UpperBound.jl</code> Section&nbsp;2.4 module accordingly.</li>
</ol>
</div>
</div>
<p>The remaining special fields, <code>velocity_jump</code> and <code>flow</code> are defined, together with initialization of <code>rate</code> and <code>rate_vect</code>, in the sampler specific modules, to which we will turnin the following sections.</p>
</section>
<section id="samplerszigzagsamplers.jl" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="samplerszigzagsamplers.jl"><span class="header-section-number">3.3</span> <code>Samplers/ZigZagSamplers.jl</code></h3>
<p>In this module, the declaration</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">mutable struct</span> ZigZag <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;:</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;"> AbstractPDMP</span></span></code></pre></div>
<p>is followed by the 2 constructors, <code>ZigZag()</code> and <code>ZigZagAD()</code>, whose signatures are</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ZigZag</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>, ∇U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Function</span>; refresh_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, grid_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, tmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Union{Float64, Int}</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>, </span>
<span id="cb7-2">                    vectorized_bound<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Bool</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>, signed_bound<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Bool</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>, adaptive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Bool</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb7-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ZigZagAD</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>, U<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Function</span>; refresh_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, grid_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, tmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Union{Float64, Int}</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>, </span>
<span id="cb7-4">                    vectorized_bound<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Bool</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>, signed_bound<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Bool</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>, adaptive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Bool</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>, AD_backend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">String</span>=<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Zygote"</span>)</span></code></pre></div>
<p>Notice the difference in <code>∇U</code> and <code>U</code> in the arguments.</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="In `ZigZag()` and `ZigZagAD()`, two fields are initialized">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
In <code>ZigZag()</code> and <code>ZigZagAD()</code>, two fields are initialized
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><code>flow</code> is defined as</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bflow%7D%7D%5C,(x_0,v_0,t)%20=(x_0+v_0t,%20v_0)%0A%20%20"></p>
<ol start="2" type="1">
<li><p><code>rate_vect</code> is defined component-wisely as</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Brate%5C_vect%5Bi%5D%7D%7D(x_0,v_0,t)%20=%20%5Cmax(0,%20%5Cnabla%20U_i(x_0+v_0t)v_0),%0A"> where <img src="https://latex.codecogs.com/png.latex?%5Cnabla%20U=(%5Cnabla%20U_1,%5Cdots,%5Cnabla%20U_d)%5E%5Ctop"> is the gradient <img src="https://latex.codecogs.com/png.latex?%5Cnabla%20U:%5Cmathbb%7BR%7D%5Ed%5Cto%5Cmathbb%7BR%7D%5Ed">.</p>
<p><code>rate</code> is the sum of <code>rate_vect</code>, i.e.,</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Brate%7D%7D(x_0,v_0,t)%20=%20%5Csum_%7Bi=1%7D%5Ed%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Brate%5C_vect%5Bi%5D%7D%7D(x_0,v_0,t).%0A"></p>
<p><code>signed_rate_vect</code> is a version of <code>rate_vect</code> without taking the <code>max</code> with <img src="https://latex.codecogs.com/png.latex?0">.</p></li>
</ol>
</div>
</div>
<p>Two flags <code>signed_bound</code> and <code>vectorized_bound</code> are <code>true</code> in default, in which case <code>signed_rate_vect</code> is used.</p>
<p>This is called the <em>signed strategy</em>, detailed in <span class="citation" data-cites="Andral-Kamatani2024">(Section 4.4.2 Andral and Kamatani, 2024)</span>.</p>
<p>The <code>vectorized_bound</code> is also special to the Zig-Zag samplers.</p>
</section>
<section id="samplersbouncyparticlesamplers.jl" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="samplersbouncyparticlesamplers.jl"><span class="header-section-number">3.4</span> <code>Samplers/BouncyParticleSamplers.jl</code></h3>
<p>Similar to the Zig-Zag samplers, mutable struct <code>BPS</code> and 2 constructors <code>BPS()</code> and <code>BPSAD()</code> are defined.</p>
<p>Difference is that, in <code>BPS</code>, vectorization is not used, therefore <code>vectorized_bound=false</code> no matter what the user specifies.</p>
<p>Note that typically Bouncy Particle Samplers need nonzero refresh rate, therefore <code>refresh_rate=0.0</code> would result in erronous samples.</p>
</section>
<section id="samplersforwardeventchainmontecarlo.jl" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="samplersforwardeventchainmontecarlo.jl"><span class="header-section-number">3.5</span> <code>Samplers/ForwardEventChainMonteCarlo.jl</code></h3>
<p>Forward ECMC (Event Chain Monte Carlo) is a generalizatione of the Bouncy Particle Sampler, being free from the need of refreshing, substituting it with a ‘informed’ velocity jump.</p>
<p>Regarding the implementation, however, note there is an error in the pseudo-code of <span class="citation" data-cites="Michel+2020">(Michel et al., 2020)</span>’s paper, and in the implementation of the <code>pdmp_jax</code> package.</p>
<p>To sum it up, the velocity jump is implemented separately on <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Cnabla%20U"> and <img src="https://latex.codecogs.com/png.latex?(%5Cmathbb%7BR%7D%5Cnabla%20U)%5E%5Cperp">. To the former, the velocity is newly sampled from the invariant distribution directly, while to the latter, occasionally (tuned by <code>mix_p</code>) only two dimensions of them are changed. (If <code>ran_p=false</code>, they are swaped.)</p>
<p>As a result, the sampler loses ergodicity and confined to a certain subspace when, for example, <img src="https://latex.codecogs.com/png.latex?U"> is completely isotropic and the initial velocity is proportional to its contours.</p>
</section>
<section id="samplersstickyzigzagsamplers.jl" class="level3" data-number="3.6">
<h3 data-number="3.6" class="anchored" data-anchor-id="samplersstickyzigzagsamplers.jl"><span class="header-section-number">3.6</span> <code>Samplers/StickyZigZagSamplers.jl</code></h3>
<p>This module implements the Sticky Zig-Zag sampler, for variable selection with the spike-and-slab prior.</p>
<p>The sampler takes additional argument <code>κ</code>, which has to be positive <code>Float64</code> or <code>Inf</code>, determining the ‘stickyness’ of the sampler.</p>
</section>
<section id="stickysamplingloops.jl" class="level3" data-number="3.7">
<h3 data-number="3.7" class="anchored" data-anchor-id="stickysamplingloops.jl"><span class="header-section-number">3.7</span> <code>StickySamplingLoops.jl</code></h3>
<p><code>StickyPDMP</code> samplers have their own sampling loop, implemented in <code>StickySamplingLoops.jl</code> using multiple dispatch.</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li>In one step of <code>one_step_of_thinning_or_sticking_or_thawing()</code>, it is first checked whether the sampler crosses any axes by <img src="https://latex.codecogs.com/png.latex?%5Cmin(%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Btp%7D%7D,%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Btt%7D%7D,%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bhorizon%7D%7D)0">.
<ul>
<li>If it does cross, <code>move_to_axes_and_stick()</code> is called.</li>
<li>Else, <img src="https://latex.codecogs.com/png.latex?%5Cmin(%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Btp%7D%7D,%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Btt%7D%7D)%20%3E%20%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bhorizon%7D%7D"> is checked.
<ul>
<li>If it is true, <code>move_to_horizon()</code> is called.</li>
</ul></li>
<li>Else, <code>moves_until_horizon_or_axes()</code> is called.
<ul>
<li></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Andral-Kamatani2024" class="csl-entry">
Andral, C., and Kamatani, K. (2024). <a href="https://arxiv.org/abs/2408.03682">Automated techniques for efficient sampling of piecewise-deterministic markov processes</a>.
</div>
<div id="ref-Bierkens+2023" class="csl-entry">
Bierkens, J., Grazzi, S., Meulen, F. van der, and Schauer, M. (2023). <a href="https://doi.org/10.1007/s11222-022-10180-5"><span class="nocase">Sticky PDMP Samplers for Sparse and Local Inference Problems</span></a>. <em>Statistics and Computing</em>, <em>33</em>(1), 8.
</div>
<div id="ref-Michel+2020" class="csl-entry">
Michel, M., Durmus, A., and Sénécal, S. (2020). <a href="https://doi.org/10.1080/10618600.2020.1750417">Forward event-chain monte carlo: Fast sampling by randomness control in irreversible markov chains</a>. <em>Journal of Computational and Graphical Statistics</em>, <em>29</em>(4), 689–702.
</div>
</div></section></div> ]]></description>
  <category>Julia</category>
  <category>PDMP</category>
  <guid>https://162348.github.io/posts/2024/Julia/Details.html</guid>
  <pubDate>Tue, 31 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Slides/zigzag_fps14_WhiteBackground.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>セミパラメトリック重回帰分析</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Stat/Regression.html</link>
  <description><![CDATA[ 





<section id="序" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="序"><span class="header-section-number">1</span> 序</h2>
<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<p>回帰モデルの点推定で最も広く用いられるアルゴリズムは OLS である： <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Cbeta%7D:=%5Coperatorname*%7Bargmin%7D_%7Bb%5Cin%5Cmathbb%7BR%7D%5Ep%7D%5Clvert%20Y-Xb%5Crvert%5E2_2.%0A"></p>
<p>その他の推定法は別稿で扱う：</p>
<div id="listing-lst-survey" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1733875200000" data-listing-reading-time-sort="3" data-listing-word-count-sort="453">
<a href="../../../posts/2024/Survey/BDA1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析５
</h5>
<div class="card-subtitle listing-subtitle">
回帰モデルの概観
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1733788800000" data-listing-file-modified-sort="1754014117005" data-listing-date-modified-sort="1733961600000" data-listing-reading-time-sort="5" data-listing-word-count-sort="945">
<a href="../../../posts/2024/Survey/BayesRegression.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/elpd.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> を用いたベイズ重回帰分析
</h5>
<div class="card-subtitle listing-subtitle">
BMI データを題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-10
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="U3RhdGlzdGljcw==" data-listing-date-sort="1727049600000" data-listing-file-modified-sort="1754014117255" data-listing-date-modified-sort="1735516800000" data-listing-reading-time-sort="3" data-listing-word-count-sort="489">
<a href="../../../posts/2024/Survey/Survey2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/ATE.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析２
</h5>
<div class="card-subtitle listing-subtitle">
平均処置効果の推定とセミパラメトリック法
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-23
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>OLS は応答 <img src="https://latex.codecogs.com/png.latex?Y"> を最もよく復元する推定量 <img src="https://latex.codecogs.com/png.latex?X%5Cwidehat%7B%5Cbeta%7D"> を構成する．損失を <img src="https://latex.codecogs.com/png.latex?Y"> のなす Euclid 空間 <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En"> 内の距離とした <img src="https://latex.codecogs.com/png.latex?M">-推定量である．</p>
<p>尤度を使わない推定法であるが，Gauss-Markov モデル（均一誤差モデル） <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5B%5Cepsilon%7CX%5D=0,%5Cqquad%5Cmathrm%7BC%7D%5B%5Cepsilon%7CX%5D=%5Csigma%5E2I_n%0A"> に関しては，誤差 <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> の分布に依らず，（セミパラメトリック）漸近有効性を持つ．しかも <img src="https://latex.codecogs.com/png.latex?%5Cepsilon_i"> は i.i.d. とは限らない．</p>
<p>その構成から予期される通り，OLS 推定量は極めて良い線型代数的な性質を持つ．実際， <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Cbeta%7D=(X%5E%5Ctop%20X)%5E%7B-1%7DX%5E%5Ctop%20Y%0A"> という表示をもち，<img src="https://latex.codecogs.com/png.latex?X%5Cwidehat%7B%5Cbeta%7D"> は <img src="https://latex.codecogs.com/png.latex?Y"> の <img src="https://latex.codecogs.com/png.latex?X"> の列ベクトルの貼る空間への線型射影である．</p>
<p>ここでは重回帰モデルにおける OLS 推定量の性質を調べる．</p>
</section>
<section id="重回帰" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="重回帰"><span class="header-section-number">2</span> 重回帰</h2>
<section id="設定" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="設定"><span class="header-section-number">2.1</span> 設定</h3>
<p>計画行列 <img src="https://latex.codecogs.com/png.latex?X=(X_1%5C;X_2)"> に関して，回帰モデル <span id="eq-model"><img src="https://latex.codecogs.com/png.latex?%0AY=X%5Cwidehat%7B%5Cbeta%7D+%5Cwidehat%7B%5Cepsilon%7D%0A%5Ctag%7B1%7D"></span> に対して，<img src="https://latex.codecogs.com/png.latex?X_1"> を入れなかった場合 <span id="eq-omitted-model"><img src="https://latex.codecogs.com/png.latex?%0AY=X_2%5Cwidetilde%7B%5Cbeta%7D_2+%5Cwidetilde%7B%5Cepsilon%7D%0A%5Ctag%7B2%7D"></span> を考える．</p>
<p>部分モデル (2) の回帰係数 <img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Cbeta%7D_2"> は <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidetilde%7B%5Cbeta%7D_2=(X_2%5E%5Ctop%20X_2)%5E%7B-1%7DX_2%5E%5Ctop%20Y%0A"> で得られる．</p>
</section>
<section id="frisch-waugh-lovell-の定理" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="frisch-waugh-lovell-の定理"><span class="header-section-number">2.2</span> Frisch-Waugh-Lovell の定理</h3>
<p>次の結果は少なくとも <span class="citation" data-cites="Yule1907">(Yule, 1907)</span> から知られていたが，計量経済学では <span class="citation" data-cites="Frisch-Waugh1933">(Frisch and Waugh, 1933)</span> と <span class="citation" data-cites="Lovell1963">(Lovell, 1963)</span> の名前で知られる．</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="Frisch-Waugh-Lovell の定理">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Frisch-Waugh-Lovell の定理
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?X_1"> の列ベクトルが貼る空間の <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En"> 上の補空間への射影を <img src="https://latex.codecogs.com/png.latex?%0AH_2:=I_n-H_1,%5Cqquad%20H_1:=X_1(X_1%5E%5Ctop%20X_1)%5E%7B-1%7DX_1%5E%5Ctop%0A"> で表すと， <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Cbeta%7D_2=(%5Cwidetilde%7BX%7D_2%5E%5Ctop%5Cwidetilde%7BX%7D_2)%5E%7B-1%7D%5Cwidetilde%7BX%7D_2%5E%5Ctop%5Cwidetilde%7BY%7D,%5Cqquad%5Cwidetilde%7BX%7D_2:=H_2X_2,%5Cwidetilde%7BY%7D:=H_2Y.%0A"></p>
</div>
</div>
<p>すなわち，<img src="https://latex.codecogs.com/png.latex?X_1,X_2"> で回帰した (1) の係数 <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D_2"> は，まず <img src="https://latex.codecogs.com/png.latex?X_2"> を <img src="https://latex.codecogs.com/png.latex?X_1"> を説明変数で回帰した後に，(2) の代わりに <img src="https://latex.codecogs.com/png.latex?Y"> をその残差 <img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7BX%7D_2"> で回帰して得る係数に等しい．</p>
<p>これを重回帰係数の <strong>部分回帰係数</strong> としての解釈とも呼ぶ <span class="citation" data-cites="Ding2024LinearModels">(Ding, 2024, p. 60)</span>．</p>
</section>
<section id="cochran-の公式" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="cochran-の公式"><span class="header-section-number">2.3</span> Cochran の公式</h3>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="[@Cochran1938]^[[@Ding2024LinearModels p.81] 定理9.1．The proof of Theorem 9.1 is very simple. However, it is one of the most insightful formulas in statistics.]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="citation" data-cites="Cochran1938">(Cochran, 1938)</span><sup>1</sup>
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?X_1"> を <img src="https://latex.codecogs.com/png.latex?X_2"> で回帰した際の係数を <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cdelta%7D"> とする： <img src="https://latex.codecogs.com/png.latex?%0AX_1=X_2%5Cwidehat%7B%5Cdelta%7D+%5Cwidehat%7BU%7D.%0A"> このとき， <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidetilde%7B%5Cbeta%7D_2=%5Cwidehat%7B%5Cbeta%7D_2+%5Cwidehat%7B%5Cdelta%7D%5Cwidehat%7B%5Cbeta%7D_1.%0A"></p>
</div>
</div>
<p>これは <img src="https://latex.codecogs.com/png.latex?X_2"> の <img src="https://latex.codecogs.com/png.latex?Y"> への影響のうち，<img src="https://latex.codecogs.com/png.latex?X_1"> を通じたもの <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cdelta%7D%5Cwidehat%7B%5Cbeta%7D_1"> とそうでないものとを分解していると見れる．<img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D_2"> は <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D_1"> の方向に縮小するとも見れる．</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cdelta%7D%5Cwidehat%7B%5Cbeta%7D_1"> の符号によっては，<img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Cbeta%7D_2,%5Cwidehat%7B%5Cbeta%7D_2"> の符号が異なることがある．このような現象は <span class="citation" data-cites="Simpson1951">(Simpson, 1951)</span> のパラドックスともいう．<sup>2</sup></p>
<p>計量経済学では <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cdelta%7D%5Cwidehat%7B%5Cbeta%7D_1"> の項を <strong>欠落変数バイアス</strong> (omitted variable bias) とも呼ぶ． <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Cdelta%7D=%5Cfrac%7B%5Cmathrm%7BC%7D%5BX_1,X_2%5D%7D%7B%5Csqrt%7B%5Cmathrm%7BV%7D%5BX_1%5D%5Cmathrm%7BV%7D%5BX_2%5D%7D%7D%0A"> であるから，<img src="https://latex.codecogs.com/png.latex?X_1,X_2"> が無相関であった場合はこの項は零になる．</p>
<p>すなわち，誤差 <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> が外生性の仮定 <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BE%7D%5B%5Cepsilon%7CX%5D=0"> を満たすまでに十分多くの説明変数を回帰モデルに入れないと，OLS 推定量はバイアスを持ってしまう．軽量経済学において，<img src="https://latex.codecogs.com/png.latex?X"> が <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> と相関を持つことを <strong>内生性</strong> (endogeneity) という <span class="citation" data-cites="Hansen2022">(B. E. Hansen, 2022, p. 335)</span>, <span class="citation" data-cites="Hayashi2000">(Hayashi, 2000, p. 64)</span>．<sup>3</sup></p>
<p><span class="citation" data-cites="Baron-Kenny1986">(Baron and Kenny, 1986)</span> の媒介分析はこのように OLS 推定を複数の回帰モデルに対して実行し，直接効果と間接効果の量を推定する．この手続きは <span class="citation" data-cites="Wright1918">(Wright, 1918)</span> のパス分析と深い関係がある．</p>
</section>
<section id="交絡と共変量統制" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="交絡と共変量統制"><span class="header-section-number">2.4</span> 交絡と共変量統制</h3>
<p>具体的に，処置変数を <img src="https://latex.codecogs.com/png.latex?Z_i%5Cin%5C%7B0,1%5C%7D"> とした回帰分析 <img src="https://latex.codecogs.com/png.latex?%0AY_i=%5Cwidetilde%7B%5Cbeta%7D_0+%5Cwidetilde%7B%5Cbeta%7D_1Z_i+%5Cwidetilde%7B%5Cbeta%7D_2%5E%5Ctop%20X_i+%5Cwidetilde%7B%5Cepsilon%7D_i%0A"> を考える．この際，欠落した説明変数 <img src="https://latex.codecogs.com/png.latex?U_i"> であって，処置変数 <img src="https://latex.codecogs.com/png.latex?Z_i"> と相関を持つものを <strong>交絡因子</strong> という．<sup>4</sup></p>
<p>フルモデル <img src="https://latex.codecogs.com/png.latex?%0AY_i=%5Cwidehat%7B%5Cbeta%7D_0+%5Cwidehat%7B%5Cbeta%7D_1Z_i+%5Cwidehat%7B%5Cbeta%7D_2%5E%5Ctop%20X_i+%5Cwidehat%7B%5Cbeta%7D_3%5E%5Ctop%20U_i+%5Cwidehat%7B%5Cepsilon%7D_i%0A"> に関して，Cochran の公式によれば，<img src="https://latex.codecogs.com/png.latex?Z_i"> を <img src="https://latex.codecogs.com/png.latex?U_i"> に関して回帰した際の <img src="https://latex.codecogs.com/png.latex?U_i"> の係数を <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cdelta%7D"> とすると， <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidetilde%7B%5Cbeta%7D_1-%5Cwidehat%7B%5Cbeta%7D_1=%5Cwidehat%7B%5Cbeta%7D_3%5Cwidehat%7B%5Cdelta%7D%0A"> が成り立つ．加えて，<img src="https://latex.codecogs.com/png.latex?U_i"> を <img src="https://latex.codecogs.com/png.latex?X_i"> に関して回帰して得る残差を <img src="https://latex.codecogs.com/png.latex?e_i"> とすると，<img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cdelta%7D"> の値はこの <img src="https://latex.codecogs.com/png.latex?e_i"> の値のグループ間差に等しい： <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Cdelta%7D=%5Coverline%7Be%7D%5E%7B(1)%7D-%5Coverline%7Be%7D%5E%7B(0)%7D.%0A"></p>
<p>すなわち，<img src="https://latex.codecogs.com/png.latex?X_i"> で説明される分を除いて，<img src="https://latex.codecogs.com/png.latex?U_i"> の値が処置群と管理群とで平均的に大きな差があるほど，交絡によるバイアスは大きいものとなる．</p>
</section>
<section id="leverage-score" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="leverage-score"><span class="header-section-number">2.5</span> leverage score</h3>
<p>射影行列 <img src="https://latex.codecogs.com/png.latex?%0AH:=X(X%5E%5Ctop%20X)%5E%7B-1%7DX%5E%5Ctop%0A"> は鍵となる値で，この対角成分は <strong>leverage score</strong> と呼ばれ，次を満たす<sup>5</sup> <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7Btr%7D(H)=%5Coperatorname%7Brank%7D(H)=p.%0A"></p>
</section>
<section id="vif" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="vif"><span class="header-section-number">2.6</span> VIF</h3>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="命題^[[@Ding2024LinearModels p.130] 定理13.1．]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
命題<sup>6</sup>
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D_j"> を <img src="https://latex.codecogs.com/png.latex?Y"> を <img src="https://latex.codecogs.com/png.latex?(1_n,X_1,%5Ccdots,X_q)"> に関して回帰した際の係数とする．真のモデルがある関数 <img src="https://latex.codecogs.com/png.latex?f"> に関して <img src="https://latex.codecogs.com/png.latex?y_i=f(x_i)+%5Cepsilon_i"> で <img src="https://latex.codecogs.com/png.latex?%5Cepsilon_i%5Csim(0,%5Csigma%5E2)"> が互いに相関を持たない場合，次が成り立つ： <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7BV%7D%5B%5Cwidehat%7B%5Cbeta%7D_j%5D=%5Cfrac%7B%5Csigma%5E2%7D%7B%5Csum_%7Bi=1%7D%5En(x_%7Bij%7D-%5Coverline%7Bx%7D_j)%5E2%7D%5Cfrac%7B1%7D%7B1-R%5E2_j%7D.%0A"> ただし <img src="https://latex.codecogs.com/png.latex?R_j%5E2"> とは <img src="https://latex.codecogs.com/png.latex?X_j"> を <img src="https://latex.codecogs.com/png.latex?(1_n,X_1,%5Ccdots,X_%7Bj-1%7D,X_%7Bj+1%7D,%5Ccdots,X_q)"> に関して回帰した際の決定係数とした．</p>
</div>
</div>
<p>この際，最初の因子は <img src="https://latex.codecogs.com/png.latex?Y"> を <img src="https://latex.codecogs.com/png.latex?(1_n,X_j)"> に関して回帰した際の係数 <img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Cbeta%7D_j"> の分散に一致する．従って次の因子 <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BVIF%7D_j:=1/(1-R_j%5E2)%0A"> は，他の説明変数 <img src="https://latex.codecogs.com/png.latex?X_1,%5Ccdots,X_%7Bj-1%7D,X_%7Bj+1%7D,%5Ccdots,X_q"> を加えたことによる，<img src="https://latex.codecogs.com/png.latex?X_j"> の推定係数の増大具合を表す．</p>
<p>これを <strong>分散拡大係数</strong> (VIF: Variance Inflation Factor) と呼ぶ．</p>
</section>
<section id="bias-variance-tradeoff" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="bias-variance-tradeoff"><span class="header-section-number">2.7</span> Bias-Variance Tradeoff</h3>
<p>一般に全ての関連する説明変数を入れた方が現実に近く，推定・予測精度は高くなると考えられる．</p>
<p>しかし VIF の命題から，説明変数を増やすたびに OLS 推定量の分散は増大することがわかる．</p>
<p>このようなトレードオフを <strong>バイアス-分散トレードオフ</strong> (Bias-Variance Tradeoff) という．</p>
</section>
<section id="操作変数" class="level3" data-number="2.8">
<h3 data-number="2.8" class="anchored" data-anchor-id="操作変数"><span class="header-section-number">2.8</span> 操作変数</h3>
<p>仮に <img src="https://latex.codecogs.com/png.latex?X_2"> が内生性を持つとする： <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5B%5Cepsilon%7CX_1%5D=0,%5Cqquad%5Coperatorname%7BE%7D%5B%5Cepsilon%7CX_2%5D%5Cne0.%0A"></p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>このとき <img src="https://latex.codecogs.com/png.latex?U"> であって次を満たすものを <strong>操作変数</strong> という：</p>
<ol type="1">
<li><p>（広義）外生性 <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7BC%7D%5BU,%5Cepsilon%5D=0%0A"></p></li>
<li><p>関連性 <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7BC%7D%5BU,X_2%5D%5Cne0%0A"></p></li>
</ol>
</div>
</div>
</div>
<p>操作変数 <img src="https://latex.codecogs.com/png.latex?U"> を用いれば，回帰モデル (1) の両辺の <img src="https://latex.codecogs.com/png.latex?U"> との相関を考えると，外生性から <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7BC%7D%5BU,V%5D=%5Cmathrm%7BC%7D%5BU,X%5D%5Cwidehat%7B%5Cbeta%7D%0A"> が成り立ち，これを通じて <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D"> を推定できる．これを <strong>IV 推定量</strong> という．</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cepsilon,%5Cepsilon_2"> の相関を測ることで，内生性の強さを定量化することもできる <span class="citation" data-cites="Chan-Tobias2020">(Chan and Tobias, 2020, p. 14)</span>．</p>
</section>
<section id="段階-ols" class="level3" data-number="2.9">
<h3 data-number="2.9" class="anchored" data-anchor-id="段階-ols"><span class="header-section-number">2.9</span> ２段階 OLS</h3>
<p>以上の手続きは，ここまで議論してきた方法の特別な場合である．</p>
<p>実際，<img src="https://latex.codecogs.com/png.latex?X_2"> を <img src="https://latex.codecogs.com/png.latex?U"> に関して回帰することを考える： <img src="https://latex.codecogs.com/png.latex?%0AX_2=U%5Cdelta+%5Cepsilon_2.%0A"></p>
<p>この回帰により得る推定値 <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7BX%7D_2=U%5Cwidehat%7B%5Cdelta%7D"> は <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> と相関を持たない．相関が取り除かれた成分を射影によって取り出していると見れる．</p>
<p>続いて <img src="https://latex.codecogs.com/png.latex?X_2"> を <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7BX%7D_2"> に取り替えて，<img src="https://latex.codecogs.com/png.latex?Y"> に向かって回帰することで得る推定量を <strong>TSLS (Two-Stage Least Squares) 推定量</strong> という．</p>
<p><img src="https://latex.codecogs.com/png.latex?U"> が２値変数であるときは <span class="citation" data-cites="Wald40-WaldEstimator">(Wald, 1940)</span> 推定量ともいう．<img src="https://latex.codecogs.com/png.latex?X_2"> の次元と <img src="https://latex.codecogs.com/png.latex?U"> の次元が一致するとき，TSLS 推定量は IV 推定量と一致する．</p>
<p>一般に TSLS も一致性と漸近正規性を持つ <span class="citation" data-cites="Hansen2022">(B. E. Hansen, 2022, pp. 351–352)</span>．</p>
</section>
</section>
<section id="不均一分散" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="不均一分散"><span class="header-section-number">3</span> 不均一分散</h2>
<section id="sec-asymptotic-normality" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="sec-asymptotic-normality"><span class="header-section-number">3.1</span> OLS の漸近正規性</h3>
<p>Guass-Markov モデルの線型モデルとしての最大の仮定は，均一の分散 <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2"> を仮定していたことである．</p>
<p>しかしこの仮定を外しても，OLS 推定量は不偏性・一致性・漸近正規性を持つ（この順に追加の条件が厳しくなる）．</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="命題^[[@Ding2024LinearModels p.44] 定理6.1．]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
命題<sup>7</sup>
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%0AY_i=X_i%5Cbeta+%5Cepsilon_i,%5Cqquad%5Cepsilon_i%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7D(0,%5Csigma_i%5E2),%0A"> に関して，計画行列 <img src="https://latex.codecogs.com/png.latex?X"> は最大階数であるとする．このとき，次が成り立つ：</p>
<ol type="1">
<li>OLS 推定量 <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D"> は不偏性を持つ．</li>
<li>次の <img src="https://latex.codecogs.com/png.latex?B_n"> が可逆な極限 <img src="https://latex.codecogs.com/png.latex?B_n%5Cto%20B"> を持つとき，一致性も持つ： <img src="https://latex.codecogs.com/png.latex?%0AB_n:=%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5EnX_i%5E%5Ctop%20X_i%5Cin%5Cmathrm%7BGL%7D_%7Bp%5Cland%20n%7D(%5Cmathbb%7BR%7D).%0A"></li>
<li>２の条件に加えて，<img src="https://latex.codecogs.com/png.latex?x_i,%5Cepsilon_i"> が３次のモーメントを持つとき，漸近正規性も成り立つ：</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="反例">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
反例
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>一致性（と漸近正規性）の成立のために追加の条件が入っていることがわかる．不偏性さえあれば，「極限での不偏性」とも思える一致性が成り立って然るべきな気がする．</p>
<p>この追加の条件は，有限個の <img src="https://latex.codecogs.com/png.latex?Y_i"> の説明にしか参加しない予測子を排除するためにある．</p>
<p>例えばある分布 <img src="https://latex.codecogs.com/png.latex?P(%5Cmu,%5Csigma%5E2)"> に関して <img src="https://latex.codecogs.com/png.latex?Y_i%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7DP(%5Cmu_i,%5Csigma_i%5E2)"> とする． <img src="https://latex.codecogs.com/png.latex?%0AY_i=%5Cbeta_1X_i%5E%7B(1)%7D+%5Cbeta_2X_i%5E%7B(2)%7D+%5Cepsilon_i,%5Cqquad%5Cepsilon_i%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7DP(0,%5Csigma_i%5E2)%0A"> <img src="https://latex.codecogs.com/png.latex?%0AX_i%5E%7B(1)%7D=1_%7B%5Cleft%5C%7B1%5Cright%5C%7D%7D(i),%5Cqquad%20X_i%5E%7B(2)%7D=1_%7B%5Cleft%5C%7B2,%5Ccdots,n%5Cright%5C%7D%7D(i)%0A"> とモデルすると，計画行列はフルランクであるが，OLS 推定量は <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D_1=%5Cepsilon_1%5Csim%20P(0,%5Csigma_1%5E2)"> となる．</p>
<p>これは標本サイズ <img src="https://latex.codecogs.com/png.latex?n"> に依らない値であり，<img src="https://latex.codecogs.com/png.latex?n%5Cto%5Cinfty"> を考えても <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D_1"> は一致性はもたず，漸近正規分布もしない．一方で <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D_2"> はする．</p>
</div>
</div>
</div>
</section>
<section id="sec-EHW" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="sec-EHW"><span class="header-section-number">3.2</span> EHW 頑健標準誤差</h3>
<p>この漸近正規性に基づく分散推定量 <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7BV%7D:=n%5E%7B-1%7D%5Cleft(%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5EnX_i%5E%5Ctop%20X_i%5Cright)%5E%7B-1%7D%5Cleft(%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5En%5Cepsilon_i%5E2X_i%5E%5Ctop%20X_i%5Cright)%5Cleft(%5Cfrac%7B1%7D%7Bn%7D%5Csum_%7Bi=1%7D%5EnX_i%5E%5Ctop%20X_i%5Cright)%5E%7B-1%7D%0A"> は，誤差分布が不均一な場合でも頑健な分散推定量となる．</p>
<p>これを計量経済学では <span class="citation" data-cites="White1980">(White, 1980)</span> の推定量と呼ぶが，初めに提案したのは <span class="citation" data-cites="Eicker1967">(Eicker, 1967)</span> と <span class="citation" data-cites="Huber1967">(Huber, 1967)</span> であるようである．</p>
</section>
<section id="有効性" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="有効性"><span class="header-section-number">3.3</span> 有効性</h3>
<p>では OLS は何を失うのか？</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2"> が不均一になった場合，観測によってノイズの大きさが違うわけである．</p>
<p>したがって特に情報量が大きい観測と，ノイズが大きくてあまり意味をなさない観測というものが相対的に出てくる．</p>
<p>これを峻別して適切に観測に重み付けることが必要である．</p>
<p>これができない OLS は有効性を失う．代わりに重み付けを行った OLS は有効性を持つ．</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="BLUE">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
BLUE
</div>
</div>
<div class="callout-body-container callout-body">
<p>既知の正定値行列 <img src="https://latex.codecogs.com/png.latex?%5CSigma"> に関して， <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5B%5Cepsilon%5D=0,%5Cqquad%5Cmathrm%7BC%7D%5B%5Cepsilon%5D=%5Csigma%5E2%5CSigma,%0A"> を満たすとする．このとき，BLUE は次のように表せる： <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Cbeta%7D_%5CSigma=(X%5E%5Ctop%5CSigma%5E%7B-1%7DX)%5E%7B-1%7DX%5E%5Ctop%5CSigma%5E%7B-1%7DY.%0A"></p>
</div>
</div>
</section>
<section id="wls" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="wls"><span class="header-section-number">3.4</span> WLS</h3>
<p>第 3.1 節で考えた不均一分散の設定は <img src="https://latex.codecogs.com/png.latex?%0A%5CSigma=%5Cmathrm%7Bdiag%7D(%5Csigma_1%5E2,%5Ccdots,%5Csigma_n%5E2)=:%5Cmathrm%7Bdiag%7D(w_1%5E%7B-1%7D,%5Ccdots,w_n%5E%7B-1%7D)%0A"> の場合に当たる．このときの BLUE は次の最適化条件でも特徴付けられる： <span id="eq-GLS"><img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Cbeta%7D_w:=%5Coperatorname*%7Bargmin%7D_%7Bb%5Cin%5Cmathbb%7BR%7D%5Ep%7D(Y-Xb)%5E%5Ctop%5CSigma%5E%7B-1%7D(Y-Xb)=%5Coperatorname*%7Bargmin%7D_%7Bb%5Cin%5Cmathbb%7BR%7D%5Ep%7D%5Csum_%7Bi=1%7D%5Enw_i%5Clvert%20Y_i-X_ib%5Crvert%5E2_2.%0A%5Ctag%7B3%7D"></span> これを <strong>WLS (Weighted Least Squares) 推定量</strong> という．</p>
<p>一般には解析を始める前に <img src="https://latex.codecogs.com/png.latex?%5CSigma"> の形は未知であるから，これの推定から始める．その手続きを計量経済学では FGLS (Feasible Generalized Least Squares) と呼ぶ．</p>
<p>この重み付けの考え方は標本抽出の際にも重要であり，<span class="citation" data-cites="Horvitz-Thompson1952">(Horvitz and Thompson, 1952)</span> の逆確率重み付け法とも呼ばれる：</p>
<div id="listing-lst-embedding1" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1727136000000" data-listing-file-modified-sort="1754014117255" data-listing-date-modified-sort="1727568000000" data-listing-reading-time-sort="6" data-listing-word-count-sort="1038">
<a href="../../../posts/2024/Survey/Survey3.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/Horvitz-Thompson.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析３
</h5>
<div class="card-subtitle listing-subtitle">
標本調査データと欠測データの扱い
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-24
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="局所線型回帰" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="局所線型回帰"><span class="header-section-number">3.5</span> 局所線型回帰</h3>
<p>局所線型回帰 (local linear regression) はカーネル法を用いてデータ点を適切に重み付けることで，非線型な回帰を達成する方法である．</p>
<p>具体的には，基準点 <img src="https://latex.codecogs.com/png.latex?x_0"> の近傍でのベストな線型近似 <img src="https://latex.codecogs.com/png.latex?%0Ay(x)=%5Calpha+%5Cbeta(x-x_0)%0A"> を得るために，あるカーネル <img src="https://latex.codecogs.com/png.latex?K"> と帯域幅 <img src="https://latex.codecogs.com/png.latex?h%3E0"> を通じて <img src="https://latex.codecogs.com/png.latex?%0A(%5Cwidehat%7B%5Calpha%7D,%5Cwidehat%7B%5Cbeta%7D):=%5Coperatorname*%7Bargmin%7D_%7Ba,b%7D%5Csum_%7Bi=1%7D%5Enw_i%5Cbiggl%7Cy_i-a-b(x_i-x_0)%5Cbiggr%7C%5E2_2,%5Cqquad%20w_i:=K%5Cleft(%5Cfrac%7Bx_i-x_0%7D%7Bh%7D%5Cright),%0A"> によって定める．</p>
<div id="listing-lst-embedding" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="S2VybmVs" data-listing-date-sort="1723248000000" data-listing-file-modified-sort="1754014114498" data-listing-date-modified-sort="1723334400000" data-listing-reading-time-sort="3" data-listing-word-count-sort="523">
<a href="../../../posts/2024/Kernels/Kernel.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Kernels/Images/Gibbs.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
カーネル法の概観
</h5>
<div class="card-subtitle listing-subtitle">
半正定値カーネルから距離学習まで
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('S2VybmVs'); return false;">Kernel</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-08-10
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="一般化線型モデルの解放" class="level3" data-number="3.6">
<h3 data-number="3.6" class="anchored" data-anchor-id="一般化線型モデルの解放"><span class="header-section-number">3.6</span> 一般化線型モデルの解放</h3>
<p>一般化線型モデル <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5BY_i%7CX_i%5D=%5Cmu(X_i%5Cbeta)%0A"> は基本的に分布が特定されたパラメトリックモデルである．これについても，EHW 頑健標準偏差推定量 3.2 に当たる，分布の誤特定に頑健な標準偏差推定量が存在する．</p>
<p>その肝となる事実は，あらゆる関数 <img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Csigma%7D%5E2(x,%5Cbeta)"> に関して， <span id="eq-EE"><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5Cleft%5B%5Csum_%7Bi=1%7D%5En%5Cfrac%7BY_i-%5Cmu(X_i%5Cbeta)%7D%7B%5Cwidetilde%7B%5Csigma%7D%5E2(X_i,%5Cbeta)%7D%5Cfrac%7B%5Cpartial%20%5Cmu(X_i%5Cbeta)%7D%7B%5Cpartial%20%5Cbeta%7D%5Cright%5D=0%0A%5Ctag%7B4%7D"></span> が真値 <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> に関して成り立ち続けることである．</p>
<p>したがって <img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Csigma%7D%5E2"> を何らかの方法で決定し，これに関して式 (4) を通じた <img src="https://latex.codecogs.com/png.latex?M">-推定量 <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D"> が構成できる．<img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Csigma%7D%5E2(x_i,%5Cbeta)=%5Cmathrm%7BV%7D%5BY_i%7CX_i=x_i%5D"> と正しく特定できた場合，これは最尤推定量になる．</p>
<p>多くの場合 <img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Csigma%7D%5E2"> は一般化線型モデルの仮定に基づいて算出するが，語特定されているものとしている場合が多く，<strong>作業分散</strong> ともいう．</p>
<p><img src="https://latex.codecogs.com/png.latex?(X_i,Y_i)"> が独立同分布に従うとするとき，第 3.1 節のような漸近正規性の結果は，一般の <img src="https://latex.codecogs.com/png.latex?M">-推定量に関する次の結果から導かれる：</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="Restricted Mean Model に対する $M$-推定^[[@Ding2024LinearModels p.268] 定理24.2．]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Restricted Mean Model に対する <img src="https://latex.codecogs.com/png.latex?M">-推定<sup>8</sup>
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?(X_i,Y_i)"> が独立同分布に従うとする．このとき， <img src="https://latex.codecogs.com/png.latex?%0A%5Csqrt%7Bn%7D(%5Cwidehat%7B%5Cbeta%7D-%5Cbeta)%5CRightarrow%5Coperatorname%7BN%7D(0,B%5E%7B-1%7DMB%5E%7B-1%7D),%0A"> <img src="https://latex.codecogs.com/png.latex?%0AB:=%5Coperatorname%7BE%7D%5Cleft%5B%5Cfrac%7B1%7D%7B%5Cwidetilde%7B%5Csigma%7D%5E2(x,%5Cbeta)%7D%5Cfrac%7B%5Cpartial%20%5Cmu(X%5Cbeta)%7D%7B%5Cpartial%20%5Cbeta%7D%5Cfrac%7B%5Cpartial%20%5Cmu(X%5Cbeta)%7D%7B%5Cpartial%20%5Cbeta%5E%5Ctop%7D%5Cright%5D,%5Cqquad%0AM:=%5Coperatorname%7BE%7D%5Cleft%5B%5Cfrac%7B%5Csigma%5E2(x)%7D%7B%5Cwidetilde%7B%5Csigma%7D%5E2(x,%5Cbeta)%5E2%7D%5Cfrac%7B%5Cpartial%20%5Cmu(X%5Cbeta)%7D%7B%5Cpartial%20%5Cbeta%7D%5Cfrac%7B%5Cpartial%20%5Cmu(X%5Cbeta)%7D%7B%5Cpartial%20%5Cbeta%5E%5Ctop%7D%5Cright%5D.%0A"></p>
</div>
</div>
<p>この結果を用いれば，指数型分布族などのパラメトリックモデルに依らずとも，漸近論に基礎付けられた点推定が達成できる．</p>
<p>なお指数分布族の仮定の下で <img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Csigma%7D%5E2"> がが正しく特定されていた場合，<img src="https://latex.codecogs.com/png.latex?B=M"> は Fisher 情報行列となる．</p>
</section>
<section id="相関の考慮" class="level3" data-number="3.7">
<h3 data-number="3.7" class="anchored" data-anchor-id="相関の考慮"><span class="header-section-number">3.7</span> 相関の考慮</h3>
<p>ここまでの議論をまとめよう．OLS の漸近正規性 3.1 は，誤差分布が不均一であるばかりでなく，<img src="https://latex.codecogs.com/png.latex?Y_i"> が相関を持つ場合（<img src="https://latex.codecogs.com/png.latex?%5CSigma"> の非対角成分が非零の場合）でも成り立つ．</p>
<p>GLS (Generalized Least Squares) はこの相関を持つ場合でもセミパラメトリック漸近最適性を達成する．</p>
<p>この結果を任意の逆リンク <img src="https://latex.codecogs.com/png.latex?%5Cmu"> に関して <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5BY_i%7CX_i%5D=%5Cmu(X_i%5Cbeta)%0A"> という非線型な回帰モデルにも拡張することを考えたいが，前節ではまだ <img src="https://latex.codecogs.com/png.latex?Y_i"> が i.i.d. であるという仮定を置いていた．</p>
<p>最後にこの仮定を取り払い，一般の誤差分布 <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BC%7D%5B%5Cepsilon%7CX%5D=%5CSigma"> を考えたい．</p>
<p>このために開発されたのが <strong>一般化推定方程式</strong> (GEE: Generalized Estimating Equations) <span class="citation" data-cites="Liang-Zeger1986">(Liang and Zeger, 1986)</span> である．</p>
</section>
<section id="一般化推定方程式" class="level3" data-number="3.8">
<h3 data-number="3.8" class="anchored" data-anchor-id="一般化推定方程式"><span class="header-section-number">3.8</span> 一般化推定方程式</h3>
<p><img src="https://latex.codecogs.com/png.latex?(X_i,Y_i)"> を i.i.d. とした場合の推定方程式 (4) を拡張した推定方程式 <span id="eq-GEE"><img src="https://latex.codecogs.com/png.latex?%0A%5Csum_%7Bi=1%7D%5En%5Cfrac%7B%5Cpartial%20%5Cmu(X_i%5Cbeta)%7D%7B%5Cpartial%20%5Cbeta%7D%5Cwidetilde%7B%5CSigma%7D%5E%7B-1%7D(X_i,%5Cbeta)%5Cbiggr(Y_i-%5Cmu(X_i%5Cbeta)%5Cbiggl)=0%0A%5Ctag%7B5%7D"></span> を一般化推定方程式といい，<img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5CSigma%7D(X_i,%5Cbeta)"> を <strong>作業共分散行列</strong> という．</p>
<p>この式は今までで最も一般的な形をしており，最適化条件 (3) で推定を実行する GLS に対して，１次の最適性条件に基づいて導出する方法ということができる．それ故，逆リンク <img src="https://latex.codecogs.com/png.latex?%5Cmu"> の一般性も許容できている．</p>
<p>実際，一般化推定方程式 (5) は，最適化条件 (3) を <img src="https://latex.codecogs.com/png.latex?b"> に関して微分して得る一次の最適性条件に見える．</p>
<p>一般化推定方程式 (5) による推定も，i.i.d. とは限らない場合の <img src="https://latex.codecogs.com/png.latex?M">-推定の理論から，漸近正規性が導ける．この漸近論から得られる EHW 推定量の一般化は，<img src="https://latex.codecogs.com/png.latex?%5Cmu"> の特定さえ正しければ，<img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5CSigma%7D"> の誤特定に頑健な分散推定量となる <span class="citation" data-cites="Liang-Zeger1986">(Liang and Zeger, 1986)</span>, <span class="citation" data-cites="Altonji-Segal1996">(Altonji and Segal, 1996)</span>．</p>
</section>
<section id="gee-の仮定" class="level3" data-number="3.9">
<h3 data-number="3.9" class="anchored" data-anchor-id="gee-の仮定"><span class="header-section-number">3.9</span> GEE の仮定</h3>
<p>しかし GEE には重要な仮定 <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5BY_%7Bit%7D%7CX_i%5D=%5Coperatorname%7BE%7D%5BY_%7Bit%7D%7CX_%7Bit%7D%5D,%5Cqquad%20t%5Cin%5Bn_i%5D,%0A"> が存在する．これは <img src="https://latex.codecogs.com/png.latex?(X_%7Bit%7D,Y_%7Bit%7D)"> が状態空間モデルに従うことを意味する．</p>
<p>しかし <img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5CSigma%7D"> の非対角成分が零になる，独立作業共分散行列を用いた場合は，この仮定が成り立たない場合でも，<img src="https://latex.codecogs.com/png.latex?%5Cmu"> の特定が正しければやはり一致性が成り立つが，推定量の分散は少し膨らむ．</p>
<p>また関数関係 <img src="https://latex.codecogs.com/png.latex?%5Cmu"> が <img src="https://latex.codecogs.com/png.latex?t%5Cin%5Bn_i%5D"> に依存しないという仮定も含まれている．</p>
</section>
</section>



<div id="quarto-appendix" class="default"><section id="終わりに" class="level2 appendix" data-number="4"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">4</span> 終わりに</h2><div class="quarto-appendix-contents">

<p>以上の枠組みは全て <strong>一般化モーメント法</strong> (GMM: Generalized Method of Moments) <span class="citation" data-cites="Hansen82-GMM">(L. P. Hansen, 1982)</span> の枠組みの中に位置する．</p>
<p>GMM という名前は，OLS 推定の１次の最適性条件として得る直交条件 <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5BX(Y-%5Cmu(X%5Cbeta))%5D=0%0A"> が，モーメント法の課す条件と似ており，どれも <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5Bg(%5Cbeta)%5D=0%0A"> という形をしているという点から来る．</p>
<p>さらには経験尤度法 <span class="citation" data-cites="Owen1988">(Owen, 1988)</span>, <span class="citation" data-cites="Qin-Lawless1994">(Qin and Lawless, 1994)</span> も漸近正規性を持つノンパラメトリック手法であり，GMM の後釜として期待されている．特に直交条件の数が多い GMM よりバイアスが少ない．</p>
<p>しかし GMM の方が分散が大きいことがあり，bias-variance のトレードオフがある <span class="citation" data-cites="Newey-Smith2004">(Newey and Smith, 2004)</span>．</p>




</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Altonji-Segal1996" class="csl-entry">
Altonji, J. G., and Segal, L. M. (1996). <a href="http://www.jstor.org/stable/1392447">Small-sample bias in GMM estimation of covariance structures</a>. <em>Journal of Business &amp; Economic Statistics</em>, <em>14</em>(3), 353–366.
</div>
<div id="ref-Baron-Kenny1986" class="csl-entry">
Baron, R. M., and Kenny, D. A. (1986). <a href="https://doi.org/10.1037/0022-3514.51.6.1173">The moderator–mediator variable distinction in social psychological research: Conceptual, strategic, and statistical considerations</a>. <em>Journal of Personality and Social Psychology</em>, <em>51</em>(6), 1173–1182.
</div>
<div id="ref-Chan-Tobias2020" class="csl-entry">
Chan, J., and Tobias, J. L. (2020). <em><a href="https://joshuachan.org/papers/BayesMicroeconometrics.pdf">Bayesian econometric methods</a></em>.
</div>
<div id="ref-Cochran1938" class="csl-entry">
Cochran, W. G. (1938). <a href="http://www.jstor.org/stable/2983654">The omission or addition of an independent variate in multiple linear regression</a>. <em>Supplement to the Journal of the Royal Statistical Society</em>, <em>5</em>(2), 171–176.
</div>
<div id="ref-Ding2024LinearModels" class="csl-entry">
Ding, P. (2024). <a href="https://arxiv.org/abs/2401.00649">Linear model and extensions</a>.
</div>
<div id="ref-Eicker1967" class="csl-entry">
Eicker, F. (1967). <a href="https://projecteuclid.org/proceedings/berkeley-symposium-on-mathematical-statistics-and-probability/Proceedings-of-the-Fifth-Berkeley-Symposium-on-Mathematical-Statistics-and/Chapter/Limit-theorems-for-regressions-with-unequal-and-dependent-errors/bsmsp/1200512981">Limit theorems for regressions with unequal and dependent errors</a>. In L. M. Le&nbsp;Cam and J. Neyman, editors, <em>Proceedings of the fifth berkeley symposium on mathematical statistics and probability, volume 1: statistics</em>,Vol. 1, pages 59–82.
</div>
<div id="ref-Frisch-Waugh1933" class="csl-entry">
Frisch, R., and Waugh, F. V. (1933). <a href="http://www.jstor.org/stable/1907330">Partial time regressions as compared with individual trends</a>. <em>Econometrica</em>, <em>1</em>(4), 387–401.
</div>
<div id="ref-Hansen2022" class="csl-entry">
Hansen, B. E. (2022). <em>Econometrics</em>. Princeton University Press.
</div>
<div id="ref-Hansen82-GMM" class="csl-entry">
Hansen, L. P. (1982). Large sample properties of generalized method of moments estimators. <em>Econometrica</em>, <em>50</em>(4), 1029–1054.
</div>
<div id="ref-Hayashi2000" class="csl-entry">
Hayashi, F. (2000). <em><a href="https://press.princeton.edu/books/ebook/9781400823833/econometrics-1">Econometrics</a></em>. Princeton University Press.
</div>
<div id="ref-Horvitz-Thompson1952" class="csl-entry">
Horvitz, D. G., and Thompson, D. J. (1952). <a href="https://doi.org/10.1080/01621459.1952.10483446">A generalization of sampling without replacement from a finite universe</a>. <em>Journal of the American Statistical Association</em>, <em>47</em>(260), 663–685.
</div>
<div id="ref-Huber1967" class="csl-entry">
Huber, P. J. (1967). <a href="https://projecteuclid.org/proceedings/berkeley-symposium-on-mathematical-statistics-and-probability/Proceedings-of-the-Fifth-Berkeley-Symposium-on-Mathematical-Statistics-and/Chapter/The-behavior-of-maximum-likelihood-estimates-under-nonstandard-conditions/bsmsp/1200512988">The behavior of maximum likelihood estimates under nonstandard conditions</a>. In L. M. Le&nbsp;Cam and J. Neyman, editors, <em>Proceedings of the fifth berkeley symposium on mathematical statistics and probability, volume 1: statistics</em>,Vol. 1, pages 221–233.
</div>
<div id="ref-Liang-Zeger1986" class="csl-entry">
Liang, K.-Y., and Zeger, S. L. (1986). <a href="http://www.jstor.org/stable/2336267">Longitudinal data analysis using generalized linear models</a>. <em>Biometrika</em>, <em>73</em>(1), 13–22.
</div>
<div id="ref-Lovell1963" class="csl-entry">
Lovell, M. C. (1963). <em><span class="nocase">Seasonal Adjustment of Economic Time Series and Multiple Regression</span></em> (Cowles Foundation Discussion Papers No. 151). Cowles Foundation for Research in Economics, Yale University. Retrieved from <a href="https://ideas.repec.org/p/cwl/cwldpp/151.html">https://ideas.repec.org/p/cwl/cwldpp/151.html</a>
</div>
<div id="ref-Newey-Smith2004" class="csl-entry">
Newey, W. K., and Smith, R. J. (2004). <a href="http://www.jstor.org/stable/3598854">Higher order properties of GMM and generalized empirical likelihood estimators</a>. <em>Econometrica</em>, <em>72</em>(1), 219–255.
</div>
<div id="ref-Owen1988" class="csl-entry">
Owen, A. B. (1988). <a href="https://doi.org/10.1093/biomet/75.2.237"><span class="nocase">Empirical likelihood ratio confidence intervals for a single functional</span></a>. <em>Biometrika</em>, <em>75</em>(2), 237–249.
</div>
<div id="ref-Qin-Lawless1994" class="csl-entry">
Qin, J., and Lawless, J. (1994). <a href="https://doi.org/10.1214/aos/1176325370"><span class="nocase">Empirical Likelihood and General Estimating Equations</span></a>. <em>The Annals of Statistics</em>, <em>22</em>(1), 300–325.
</div>
<div id="ref-Simpson1951" class="csl-entry">
Simpson, E. H. (1951). <a href="http://www.jstor.org/stable/2984065">The interpretation of interaction in contingency tables</a>. <em>Journal of the Royal Statistical Society. Series B (Methodological)</em>, <em>13</em>(2), 238–241.
</div>
<div id="ref-Wald40-WaldEstimator" class="csl-entry">
Wald, A. (1940). The fitting of straight lines if both variables are subject to error. <em>The Annals of Mathematical Statistics</em>, <em>11</em>(3), 283–300.
</div>
<div id="ref-White1980" class="csl-entry">
White, H. (1980). <a href="http://www.jstor.org/stable/1912934">A heteroskedasticity-consistent covariance matrix estimator and a direct test for heteroskedasticity</a>. <em>Econometrica</em>, <em>48</em>(4), 817–838.
</div>
<div id="ref-Wright1918" class="csl-entry">
Wright, S. (1918). <a href="https://academic.oup.com/genetics/article/3/4/367/5934526">On the nature of size factors</a>. <em>Genetics</em>, <em>3</em>(4), 367.
</div>
<div id="ref-Yule1907" class="csl-entry">
Yule, G. U. (1907). <a href="https://doi.org/10.1098/rspa.1907.0028">On the theory of correlation for any number of variables, treated by a new system of notation</a>. <em>Proceedings of the Royal Society of London. Series A, Containing Papers of a Mathematical and Physical Character</em>, <em>79</em>(529), 182–193.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><span class="citation" data-cites="Ding2024LinearModels">(Ding, 2024, p. 81)</span> 定理9.1．The proof of Theorem 9.1 is very simple. However, it is one of the most insightful formulas in statistics.↩︎</p></li>
<li id="fn2"><p>生態学的誤謬 (<a href="https://en.wikipedia.org/wiki/Ecological_fallacy">ecological fallacy</a>) ともいう．↩︎</p></li>
<li id="fn3"><p>この意味での「内生性」は，「外生的じゃない」こととも意味がズレてしまう．<img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BE%7D%5B%5Cepsilon%7CX%5D=0"> を満たすならば <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BC%7D%5B%5Cepsilon,X%5D=0"> が必要であるから，「内生的ならば外生的でない」は成り立つ．ここでは内生的じゃないことを <strong>広義外生性</strong> と呼ぼう．また多くの場合他の経済学の文脈では，「モデル内で決定される変数」程度の意味で内生変数と呼ぶことも多い．↩︎</p></li>
<li id="fn4"><p>処置変数と相関を持たないということは，非交絡性 <img src="https://latex.codecogs.com/png.latex?Y_i%5Cperp%5C!%5C!%5C!%5Cperp%20Z_i%5Cmid%20U_i"> よりは弱い条件である．なお，この「非交絡性」は疫学の言い方であり，計量経済学では <strong>無視可能性</strong> または <img src="https://latex.codecogs.com/png.latex?U_i"> が観測可能である場合は selection on observables などとも呼ぶ．逆に言えば，交絡とは selection on unobservables のことである．↩︎</p></li>
<li id="fn5"><p><span class="citation" data-cites="Ding2024LinearModels">(Ding, 2024, p. 95)</span> も参照．↩︎</p></li>
<li id="fn6"><p><span class="citation" data-cites="Ding2024LinearModels">(Ding, 2024, p. 130)</span> 定理13.1．↩︎</p></li>
<li id="fn7"><p><span class="citation" data-cites="Ding2024LinearModels">(Ding, 2024, p. 44)</span> 定理6.1．↩︎</p></li>
<li id="fn8"><p><span class="citation" data-cites="Ding2024LinearModels">(Ding, 2024, p. 268)</span> 定理24.2．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Statistics</category>
  <category>Nonparametrics</category>
  <guid>https://162348.github.io/posts/2024/Stat/Regression.html</guid>
  <pubDate>Sun, 29 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Stat/Images/Cochran.svg" medium="image" type="image/svg+xml"/>
</item>
<item>
  <title>Likelihood of Hierarchical Models</title>
  <dc:creator>Hirofumi Shiba</dc:creator>
  <link>https://162348.github.io/posts/2024/Probability/likelihood.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="problem" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="problem"><span class="header-section-number">1</span> Problem</h2>
<section id="starting-point" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="starting-point"><span class="header-section-number">1.1</span> Starting Point</h3>
<p>As a starting point, consider a simple univariate linear regression model with 3 parameters, i.e., <img src="https://latex.codecogs.com/png.latex?%5Calpha,%5Cbeta,%5Csigma%5E2">: <span id="eq-model1"><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5BY%7CX%5D=%5Calpha+%5Cbeta%20X+%5Cepsilon,%5Cqquad%5Cepsilon%5Csim%20N(0,%5Csigma%5E2).%0A%5Ctag%7B1%7D"></span> Since (1) is just another expression for <img src="https://latex.codecogs.com/png.latex?Y%7CX%5Csim%20N(%5Calpha+%5Cbeta%20X,%5Csigma%5E2)">, the likelihood function is given by <img src="https://latex.codecogs.com/png.latex?%0Ap(y%7C%5Calpha,%5Cbeta,%5Csigma)=%5Cphi(y%7C%5Calpha+%5Cbeta%20x,%5Csigma%5E2),%0A"> given data <img src="https://latex.codecogs.com/png.latex?x%5Cin%5Cmathbb%7BR%7D">, where <img src="https://latex.codecogs.com/png.latex?%5Cphi(-%7C%5Cmu,%5Csigma%5E2)"> represents the Gaussian density for <img src="https://latex.codecogs.com/png.latex?N(%5Cmu,%5Csigma%5E2)">.</p>
</section>
<section id="hierarchical-model" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="hierarchical-model"><span class="header-section-number">1.2</span> Hierarchical Model</h3>
<p>To make our model (1) more realistic, let’s say, we would like to model variation in the intercept <img src="https://latex.codecogs.com/png.latex?%5Calpha"> by imposing another regression structure (you might call it super-population structure): <span id="eq-model2"><img src="https://latex.codecogs.com/png.latex?%0A%5Calpha=%5Cmu_%5Calpha+%5Cepsilon_%5Calpha,%5Cqquad%5Cepsilon_%5Calpha%5Csim%20N(0,%5Csigma_%5Calpha%5E2).%0A%5Ctag%7B2%7D"></span></p>
<p>Now, what does the likelihood function <img src="https://latex.codecogs.com/png.latex?p(y%7C%5Cmu_%5Calpha,%5Csigma_%5Calpha,%5Cbeta,%5Csigma)"> of this model look like?</p>
<p>The answer is <strong>normal likelihood</strong>.</p>
</section>
<section id="sec-calculation" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="sec-calculation"><span class="header-section-number">1.3</span> Likelihood Calculation</h3>
<p>First, rewrite (1) and (2) as <img src="https://latex.codecogs.com/png.latex?%0AY%7CX,%5Calpha%5Csim%20N(%5Calpha+%5Cbeta%20X,%5Csigma%5E2),%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Calpha%7C%5Cmu_%5Calpha,%5Csigma_%5Calpha%5Csim%20N(%5Cmu_%5Calpha,%5Csigma_%5Calpha%5E2).%0A"></p>
<p>Using the formula (note this is not <strong>always</strong> true, see Section&nbsp;2.4) <img src="https://latex.codecogs.com/png.latex?%0Ap(y%7C%5Cmu_%5Calpha,%5Csigma_%5Calpha,%5Cbeta,%5Csigma)=%5Cint_%5Cmathbb%7BR%7Dp(y%7C%5Calpha,%5Cbeta,%5Csigma)p(%5Calpha%7C%5Cmu_%5Calpha,%5Csigma_%5Calpha)%5C,d%5Calpha,%0A"> we get a normal density <img src="https://latex.codecogs.com/png.latex?%0Ap(y%7C%5Cmu_%5Calpha,%5Csigma_%5Calpha,%5Cbeta,%5Csigma)=%5Cphi(y%7C%5Cwidetilde%7B%5Cmu%7D,%5Cwidetilde%7B%5Csigma%7D%5E2),%0A"> where <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidetilde%7B%5Cmu%7D(%5Cbeta,%5Cmu_%5Calpha):=%5Cbeta%20x+%5Cmu_%5Calpha,%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidetilde%7B%5Csigma%7D%5E2(%5Csigma,%5Csigma_%5Calpha):=%5Csigma%5E2+%5Csigma_%5Calpha%5E2.%0A"></p>
<p>This also follows from the <strong>reproducing property</strong> of normal distribution: <img src="https://latex.codecogs.com/png.latex?%0AN(%5Cbeta%20X,%5Csigma%5E2)*N(%5Cmu_%5Calpha,%5Csigma_%5Calpha%5E2)=N(%5Cbeta%20X+%5Cmu_%5Calpha,%5Csigma%5E2+%5Csigma_%5Calpha%5E2).%0A"></p>
</section>
</section>
<section id="background-in-probability" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="background-in-probability"><span class="header-section-number">2</span> Background in Probability</h2>
<section id="core-proposition" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="core-proposition"><span class="header-section-number">2.1</span> Core Proposition</h3>
<p>Abstracting away by setting <img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta:=(%5Cbeta,%5Csigma),%5Cqquad%5Cvarphi:=(%5Cmu_%5Calpha,%5Csigma_%5Calpha),%0A"> the core identity was the following: <span id="eq-core"><img src="https://latex.codecogs.com/png.latex?%0Ap(y%7C%5Ctheta,%5Cvarphi)=%5Cint%20p(y%7C%5Ctheta,%5Calpha)p(%5Calpha%7C%5Cvarphi)%5C,d%5Calpha.%0A%5Ctag%7B3%7D"></span></p>
<p>Having such a good notation, this formula might look obvious for stats people, but how actually do we prove it?</p>
</section>
<section id="conditional-probability" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="conditional-probability"><span class="header-section-number">2.2</span> Conditional Probability</h3>
<p>Essentially, Equation&nbsp;3 comes from the tower property of conditional expectation:</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="Tower Property">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tower Property
</div>
</div>
<div class="callout-body-container callout-body">
<p>For sigma algebras <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D_1,%5Cmathcal%7BG%7D_2">, <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathcal%7BG%7D_1%5Csubset%5Cmathcal%7BG%7D_2%5Cquad%5CRightarrow%5Cquad%5Coperatorname%7BE%7D%5BX%7C%5Cmathcal%7BG%7D_1%5D=%5Coperatorname%7BE%7D%5B%5Coperatorname%7BE%7D%5BX%7C%5Cmathcal%7BG%7D_2%5D%7C%5Cmathcal%7BG%7D_1%5D%5Cquad%5Coperatorname%7BP%7D%5Ctext%7B-a.s.%7D%0A"> for any random variable <img src="https://latex.codecogs.com/png.latex?X"> on <img src="https://latex.codecogs.com/png.latex?(%5COmega,%5Cmathcal%7BF%7D,%5Coperatorname%7BP%7D)">, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BG%7D_1,%5Cmathcal%7BG%7D_2%5Csubset%5Cmathcal%7BF%7D">.</p>
</div>
</div>
<p>Let’s see how we apply this tower property to our problem:</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="[Th'm 8.15 @Kallenberg2021 p.174]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="citation" data-cites="Kallenberg2021">(Th’m 8.15 Kallenberg, 2021, p. 174)</span>
</div>
</div>
<div class="callout-body-container callout-body">
<p>For any <img src="https://latex.codecogs.com/png.latex?A%5Cin%5Cmathcal%7BF%7D">, <span id="eq-Kallenberg"><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5BA%7CX%5D=%5Coperatorname%7BE%7D%5Cbiggl%5B%5Coperatorname%7BP%7D%5BA%7CX,Y%5D%5C,%5Cbigg%7C%5C,X%5Cbiggr%5D%5Cquad%5Coperatorname%7BP%7D%5Ctext%7B-a.s.%7D%0A%5Ctag%7B4%7D"></span></p>
</div>
</div>
<p>Concerning the definition of conditional probability, we first have the definition of conditional expectation, through which we define conditional probability as<sup>1</sup> <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5BA%7CX%5D:=%5Coperatorname%7BE%7D%5B1_A%7CX%5D.%0A"></p>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Proof">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Proof
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5B1_A%7CX%5D=%5Coperatorname%7BE%7D%5Cbiggl%5B%5Coperatorname%7BE%7D%5B1_A%7CX,Y%5D%5C,%5Cbigg%7C%5C,X%5Cbiggr%5D%5Cquad%5Coperatorname%7BP%7D%5Ctext%7B-a.s.%7D%0A"> holds from tower property, noting that <img src="https://latex.codecogs.com/png.latex?%0A%5Csigma(X)%5Csubset%5Csigma(X,Y).%0A"></p>
</div>
</div>
</div>
</section>
<section id="conditional-density" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="conditional-density"><span class="header-section-number">2.3</span> Conditional Density</h3>
<p>The last piece we need is the definition of conditional density.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="Def (Conditional Density)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Def (Conditional Density)
</div>
</div>
<div class="callout-body-container callout-body">
<p>For absolutely continuous random variables <img src="https://latex.codecogs.com/png.latex?X,Y"> on <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Ed">, we define the <strong>conditional density</strong> of <img src="https://latex.codecogs.com/png.latex?Y"> given <img src="https://latex.codecogs.com/png.latex?X"> as <img src="https://latex.codecogs.com/png.latex?%0Ap(y%7Cx):=%5Cfrac%7Bp(x,y)%7D%7Bp(x)%7D1_%7B%5Cleft%5C%7Bp(x)%3E0%5Cright%5C%7D%7D,%0A"> where <img src="https://latex.codecogs.com/png.latex?p(x,y)"> is the joint density of <img src="https://latex.codecogs.com/png.latex?(X,Y)"> and <img src="https://latex.codecogs.com/png.latex?p(x)"> is the marginal density of <img src="https://latex.codecogs.com/png.latex?X">.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="Characterization of Conditional Density">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Characterization of Conditional Density
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BE%7D%5BY%7CX=x%5D=%5Cint_%7B%5Cmathbb%7BR%7D%5Ed%7Dy%5C,p(y%7Cx)%5C,dy%5Cquad%5Coperatorname%7BP%7D%5EX%5Ctext%7B-a.s.%7D%0A"></p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="Proof">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Proof
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Since conditional expectation is unique up to <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BP%7D">-null sets, we’ll check the RHS (right-hand side) satisfies the conditions of conditional expectation.</p>
<ol type="1">
<li><p>By Fubini’s theorem, the RHS is a measurable function of <img src="https://latex.codecogs.com/png.latex?x"> and is <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BP%7D%5EX">-integrable.</p></li>
<li><p>For all <img src="https://latex.codecogs.com/png.latex?%5Csigma(X)">-measurable set <img src="https://latex.codecogs.com/png.latex?A%5Cin%5Csigma(X)">,</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cint_A%5Cint_%7B%5Cmathbb%7BR%7D%5Ed%7Dy%5C,p(y%7Cx)%5C,dy%5C,p(x)%5C,dx=%5Cint_%7BA%5Ctimes%5Cmathbb%7BR%7D%5Ed%7Dy%5C,p(x,y)%5C,dxdy=%5Coperatorname%7BE%7D%5BY1_A%5D.%0A"></p></li>
</ol>
</div>
</div>
</div>
<p>Plugging in this characterization into (4), we get <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5BA%7CX=x%5D=%5Cint_%7B%5Cmathbb%7BR%7D%5Ed%7D%5Coperatorname%7BP%7D%5BA%7CX=x,Y=y%5D%5C,p(y%7Cx)%5C,dy.%0A"> Denoting the density of <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BP%7D%5BA%7CX=x%5D"> as <img src="https://latex.codecogs.com/png.latex?p(a%7Cx)">, we have <img src="https://latex.codecogs.com/png.latex?%0Ap(a%7Cx)=%5Cint_%7B%5Cmathbb%7BR%7D%5Ed%7Dp(a%7Cx,y)%5C,p(y%7Cx)%5C,dy.%0A"></p>
</section>
<section id="sec-last-piece" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="sec-last-piece"><span class="header-section-number">2.4</span> Last Piece</h3>
<p>Reterning to the notation in (3), we have <img src="https://latex.codecogs.com/png.latex?%0Ap(y%7C%5Ctheta,%5Cvarphi)=%5Cint%20p(y%7C%5Ctheta,%5Cvarphi,%5Calpha)p(%5Calpha%7C%5Cvarphi)%5C,d%5Calpha.%0A"></p>
<p>This is slightly different from (3) in that there is <img src="https://latex.codecogs.com/png.latex?p(y%7C%5Ctheta,%5Cvarphi,%5Calpha)"> instead of <img src="https://latex.codecogs.com/png.latex?p(y%7C%5Ctheta,%5Calpha)">.</p>
<p>So the last piece we need is <strong>the modeling assumption</strong> in the regression setting of (1), which is conditional independence between <img src="https://latex.codecogs.com/png.latex?Y"> and the hyperparameters <img src="https://latex.codecogs.com/png.latex?(%5Cmu_%5Calpha,%5Csigma_%5Calpha)"> given <img src="https://latex.codecogs.com/png.latex?%5Calpha">: <img src="https://latex.codecogs.com/png.latex?%0AY%5Cperp%5C!%5C!%5C!%5Cperp%5Cvarphi%5Cmid%5Calpha.%0A"></p>
<p>Under this assumption, we have<sup>2</sup> <img src="https://latex.codecogs.com/png.latex?%0Ap(y%7C%5Ctheta,%5Calpha,%5Cvarphi)=p(y%7C%5Ctheta,%5Calpha).%0A"></p>
<p>In the regression setting of (1), <img src="https://latex.codecogs.com/png.latex?%0Ap(y%7C%5Cbeta,%5Csigma,%5Calpha,%5Cmu_%5Calpha,%5Csigma_%5Calpha)=p(y%7C%5Cbeta,%5Csigma,%5Calpha).%0A"></p>
<div class="callout callout-style-simple callout-important no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We implicitly assumed <img src="https://latex.codecogs.com/png.latex?%0Ap(y%7C%5Cbeta,%5Csigma,%5Calpha,%5Cmu_%5Calpha,%5Csigma_%5Calpha)=p(y%7C%5Cbeta,%5Csigma,%5Calpha),%0A"> since it was reasonable to assume the conditional independence between <img src="https://latex.codecogs.com/png.latex?Y"> and the hyperparameters <img src="https://latex.codecogs.com/png.latex?(%5Cmu_%5Calpha,%5Csigma_%5Calpha)"> given <img src="https://latex.codecogs.com/png.latex?%5Calpha">: <img src="https://latex.codecogs.com/png.latex?%0AY%5Cperp%5C!%5C!%5C!%5Cperp(%5Cmu_%5Calpha,%5Csigma_%5Calpha)%5Cmid%5Calpha.%0A"></p>
</div>
</div>
</div>
</section>
</section>
<section id="real-world-example-ideal-point-model" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="real-world-example-ideal-point-model"><span class="header-section-number">3</span> Real-world Example: Ideal Point Model</h2>
<section id="specification" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="specification"><span class="header-section-number">3.1</span> Specification</h3>
<p>Let’s consider the following hierarchical model with 6 parameters, i.e., <img src="https://latex.codecogs.com/png.latex?%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma%5E2"> and <img src="https://latex.codecogs.com/png.latex?X">: <img src="https://latex.codecogs.com/png.latex?%0AY%5Csim%5Coperatorname%7BBernoulli%7D(%5Cmu),%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7Blogit%7D(%5Cmu)=%5Calpha+%5Cbeta%20X,%0A"> <img src="https://latex.codecogs.com/png.latex?%0AX=%5Cgamma+%5Cdelta%20Z+%5Cepsilon,%5Cqquad%5Cepsilon%5Csim%20N(0,%5Csigma%5E2).%0A"></p>
<p>We see the hierarchical structure <img src="https://latex.codecogs.com/png.latex?%0AY%7CX%5Csim%5Coperatorname%7BBernoulli%7D(%5Coperatorname%7Blogit%7D%5E%7B-1%7D(%5Calpha+%5Cbeta%20X)),%0A"> <img src="https://latex.codecogs.com/png.latex?%0AX%7CZ%5Csim%20N(%5Cgamma+%5Cdelta%20Z,%5Csigma%5E2),%0A"> just as in Section&nbsp;1.3.</p>
<p>This time, however, we cannot detour the calculation by the tower property, while in Section&nbsp;1.3 we could sanity check the result by the reproducing property of normal distribution.</p>
</section>
<section id="likelihood-calculation" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="likelihood-calculation"><span class="header-section-number">3.2</span> Likelihood Calculation</h3>
<p>Through the core Equation&nbsp;3,</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20p(y%7C%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma)&amp;=%5Cint_%5Cmathbb%7BR%7Dp(y%7C%5Calpha,%5Cbeta,x)p(x%7C%5Cgamma,%5Cdelta,%5Csigma)%5C,dx%5C%5C%0A%20%20&amp;=1_%7B%5Cleft%5C%7B1%5Cright%5C%7D%7D(y)%5Cint_%5Cmathbb%7BR%7D%5Coperatorname%7Blogit%7D%5E%7B-1%7D(%5Calpha+%5Cbeta%20x)%5Cphi(x%7C%5Cgamma+%5Cdelta%20z,%5Csigma)%5C,dx%5C%5C%0A%20%20&amp;%5Cqquad+1_%7B%5Cleft%5C%7B0%5Cright%5C%7D%7D(y)%5Cint_%5Cmathbb%7BR%7D%5Cbiggr(1-%5Coperatorname%7Blogit%7D%5E%7B-1%7D(%5Calpha+%5Cbeta%20x)%5Cbiggl)%5Cphi(x%7C%5Cgamma+%5Cdelta%20z,%5Csigma)%5C,dx%5C%5C%0A%20%20&amp;=%5Cqquad%5Ccdots%5Ccdots%0A%5Cend%7Balign*%7D"></p>
<p>We won’t proceed any more, observing the integral is not always tractable.</p>
<p>If the likelihood involves an intractable integral, how can we proceed maximum likelihood / Bayesian estimation?</p>
</section>
<section id="data-augmentation" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="data-augmentation"><span class="header-section-number">3.3</span> Data Augmentation</h3>
<p>We can still find the mode of the likelihood function by the EM algorithm <span class="citation" data-cites="Dempster+1977">(Dempster et al., 1977)</span>.</p>
<p>The case is similar in the Bayesian approach, where we enlarge the parameter space by treating <img src="https://latex.codecogs.com/png.latex?x"> as a parameter (or a latent variable) and sample from <img src="https://latex.codecogs.com/png.latex?x"> as well.</p>
<p>This is called <strong>data augmentation</strong> approach, initiated in the EM algorithm, later applied to Bayesian computations in <span class="citation" data-cites="Tanner-Wong1987">(Tanner and Wong, 1987)</span>.</p>
<p>Although <img src="https://latex.codecogs.com/png.latex?p(y%7C%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma)"> might involve possibly intractable integrals over <img src="https://latex.codecogs.com/png.latex?x">, <img src="https://latex.codecogs.com/png.latex?p(y%7C%5Ctextcolor%7Bred%7D%7Bx%7D,%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma)"> does not, since it holds that <img src="https://latex.codecogs.com/png.latex?%0Ap(y%7Cx,%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma)=p(y%7Cx,%5Calpha,%5Cbeta)%0A"> given that <img src="https://latex.codecogs.com/png.latex?y"> and <img src="https://latex.codecogs.com/png.latex?%5Cgamma,%5Cdelta,%5Csigma"> are conditionally independent given <img src="https://latex.codecogs.com/png.latex?x">.</p>
<p>Therefore, the posterior distribution of <img src="https://latex.codecogs.com/png.latex?(x,%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma)"> is given by</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(x,%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma%7Cy)%5C,%5Cpropto%5C,p(y%7Cx,%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma)p(x,%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma)%0A"> <span id="eq-DA"><img src="https://latex.codecogs.com/png.latex?%0A=p(y%7Cx,%5Calpha,%5Cbeta)p(x%7C%5Cgamma,%5Cdelta,%5Csigma)p(%5Calpha,%5Cbeta,%5Cgamma,%5Cdelta,%5Csigma).%0A%5Ctag%7B5%7D"></span></p>
<p>Basically, higher level parameters <img src="https://latex.codecogs.com/png.latex?%5Cgamma,%5Cdelta,%5Csigma"> are treated as a part of the machinery that systematically defines a prior for the lower level parameter <img src="https://latex.codecogs.com/png.latex?x">. In fact, this was the motivation when the hierarchical structure is first introduced in <span class="citation" data-cites="Lindley-Smith1972">(Lindley and Smith, 1972)</span>.</p>
</section>
<section id="bayesian-computation" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="bayesian-computation"><span class="header-section-number">3.4</span> Bayesian Computation</h3>
<p>Using the decomposition (5), we can readily run MCMC algorithms to sample from the posterior distribution.</p>
<p>Introducing another latent variable, we may also run the Gibbs sampler based on Polya-Gamma decomposition as in <span class="citation" data-cites="Polson+2013">(Polson et al., 2013)</span>.</p>
<p>Alternatively, we can run the HMC (Hamiltonian Monte Carlo) algorithm based on the gradient of the log posterior density.</p>
<p>In the following articles, we prepared you with the codes for gradient-based Bayesian estimation, including HMCs via Stan and Zig-Zag via PDMPFlux. Visit the following articles (although they are in Japanese) for more details:</p>
<div id="lst-IPM" class="listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst quarto-uncaptioned" id="lst-IPM-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;1
</figcaption>
<div aria-describedby="lst-IPM-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>

</div>
</div>
</figure>
</div>




</section>
</section>


<div class="quarto-listing quarto-listing-container-grid" id="listing-lst-embedding">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUiUyQ1N0YW4=" data-listing-date-sort="1734134400000" data-listing-file-modified-sort="1754014116643" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="7" data-listing-word-count-sort="1355">
<a href="../../../posts/2024/Survey/BayesGLMM.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/DIF.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> を用いたベイズ混合ロジスティック回帰分析
</h5>
<div class="card-subtitle listing-subtitle">
項目応答モデルと特異項目機能を題材として
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

<div class="listing-category" onclick="window.quartoListingCategory('Ug=='); return false;">R</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3Rhbg=='); return false;">Stan</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-14
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ1I=" data-listing-date-sort="1727827200000" data-listing-file-modified-sort="1754014117272" data-listing-date-modified-sort="1734825600000" data-listing-reading-time-sort="28" data-listing-word-count-sort="5498">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/IPE_experiment.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
理想点解析のハンズオン
</h5>
<div class="card-subtitle listing-subtitle">
<code>MCMCpack</code> パッケージとオリジナル <code>Stan</code> コードを使って
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

<div class="listing-category" onclick="window.quartoListingCategory('TUNNQw=='); return false;">MCMC</div>

<div class="listing-category" onclick="window.quartoListingCategory('Ug=='); return false;">R</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-10-02
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1721088000000" data-listing-file-modified-sort="1754014117272" data-listing-date-modified-sort="1727827200000" data-listing-reading-time-sort="5" data-listing-word-count-sort="829">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/IdeologyPosition.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
理想点解析・多次元展開法・項目応答理論
</h5>
<div class="card-subtitle listing-subtitle">
空間モデルの特定を目指して
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-07-16
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Dempster+1977" class="csl-entry">
Dempster, A. P., Laird, N. M., and Rubin, D. B. (1977). <a href="https://rss.onlinelibrary.wiley.com/doi/10.1111/j.2517-6161.1977.tb01600.x">Maximum likelihood from incomplete data via the EM algorithm</a>. <em>Journal of the Royal Statistical Society. Series B (Methodological)</em>, <em>39</em>(1), 1–22.
</div>
<div id="ref-Dudley2002" class="csl-entry">
Dudley, R. M. (2002). <em><a href="https://www.cambridge.org/core/books/real-analysis-and-probability/26DDF2D09E526185F2347AA5658B96F6">Real analysis and probability</a></em>,Vol. 74. Cambridge University Press.
</div>
<div id="ref-Kallenberg2021" class="csl-entry">
Kallenberg, O. (2021). <em>Foundations of modern probability</em>,Vol. 99. Springer Cham.
</div>
<div id="ref-Lindley-Smith1972" class="csl-entry">
Lindley, D. V., and Smith, A. F. M. (1972). <a href="http://www.jstor.org/stable/2985048">Bayes estimates for the linear model</a>. <em>Journal of the Royal Statistical Society. Series B (Methodological)</em>, <em>34</em>(1), 1–41.
</div>
<div id="ref-Polson+2013" class="csl-entry">
Polson, N. G., Scott, J. G., and Windle, J. (2013). <a href="https://doi.org/10.1080/01621459.2013.829001">Bayesian inference for logistic models using p<span>ó</span>lya–gamma latent variables</a>. <em>Journal of the American Statistical Association</em>, <em>108</em>(504), 1339–1349.
</div>
<div id="ref-Tanner-Wong1987" class="csl-entry">
Tanner, M. A., and Wong, W. H. (1987). <a href="https://www.jstor.org/stable/2289457">The calculation of posterior distributions by data augmentation</a>. <em>Journal of the American Statistical Association</em>, <em>82</em>(398).
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>For this definition of conditional probability, see <span class="citation" data-cites="Kallenberg2021">(Kallenberg, 2021, p. 167)</span>, <span class="citation" data-cites="Dudley2002">(Dudley, 2002, p. 347)</span>. If we are to define conditional probability first, we need the concept of <strong>regular</strong> conditional probability, which is not discussed here.↩︎</p></li>
<li id="fn2"><p>see, for example, <span class="citation" data-cites="Kallenberg2021">(Th’m 8.9 Kallenberg, 2021, p. 170)</span>↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{shiba2024,
  author = {Shiba, Hirofumi},
  title = {Likelihood of {Hierarchical} {Models}},
  date = {2024-12-23},
  url = {https://162348.github.io/posts/2024/Probability/likelihood.html},
  langid = {en},
  abstract = {We examine how to find \&amp; formally determine the
    likelihood function of hierarchical models. As a real-world example,
    we consider the ideal point model, also known as the 2-parameter
    logistic item response model.}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-shiba2024" class="csl-entry quarto-appendix-citeas">
Shiba, H. (2024, December 23). <a href="https://162348.github.io/posts/2024/Probability/likelihood.html">Likelihood
of Hierarchical Models</a>.
</div></div></section></div> ]]></description>
  <category>Probability</category>
  <category>Statistics</category>
  <guid>https://162348.github.io/posts/2024/Probability/likelihood.html</guid>
  <pubDate>Mon, 23 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Probability/Images/ConditionalLikelihood.svg" medium="image" type="image/svg+xml"/>
</item>
<item>
  <title>On the Identifiability of the Bafumi et. al. Ideal Point Model</title>
  <dc:creator>Hirofumi Shiba</dc:creator>
  <link>https://162348.github.io/posts/2024/TransDimensionalModels/Bafumi.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<section id="the-2pl-model" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="the-2pl-model"><span class="header-section-number">1.1</span> The 2PL Model</h3>
<p>Suppose we have a binary response variable <img src="https://latex.codecogs.com/png.latex?Y_%7Bi,j%7D"> for the <img src="https://latex.codecogs.com/png.latex?i%5Cin%5BN%5D">-th judge and the <img src="https://latex.codecogs.com/png.latex?j%5Cin%5BJ%5D">-th case.</p>
<p>2-parameter logistic model (2PL) can be written as follows: <span id="eq-model1"><img src="https://latex.codecogs.com/png.latex?%0AY_%7Bi,j%7D%5Csim%5Coperatorname%7BBernoulli%7D(%5Cmu_%7Bi,j%7D),%0A%5Ctag%7B1%7D"></span> <span id="eq-model2"><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7Blogit%7D(%5Cmu_%7Bi,j%7D)=%5Calpha_j+%5Cbeta_j%20X_i=:%5Cbeta_j%5Cbiggr(%5Cwidetilde%7B%5Calpha%7D_j+X_i%5Cbiggl).%0A%5Ctag%7B2%7D"></span></p>
<p>Although the model is called the 2PL model, we have three parameters <img src="https://latex.codecogs.com/png.latex?%5Calpha_j,%5Cbeta_j,X_i"> in total, two for the cases <img src="https://latex.codecogs.com/png.latex?j%5Cin%5BJ%5D"> and one for the judges <img src="https://latex.codecogs.com/png.latex?i%5Cin%5BN%5D">.</p>
<p>In IRT (Item Response Theory) vocabulary, we call <img src="https://latex.codecogs.com/png.latex?%5Calpha_j"> the <em>difficulty</em>, and <img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> the <em>discrimination</em> parameter of the <img src="https://latex.codecogs.com/png.latex?j">-th ‘item’.</p>
<p><img src="https://latex.codecogs.com/png.latex?X_i"> may be called the <em>latent trait</em> or <em>ability</em> parameter of the <img src="https://latex.codecogs.com/png.latex?i">-th ‘unit’ in that context, but here we call it the <strong>ideal point</strong> of the <img src="https://latex.codecogs.com/png.latex?i">-th judge.</p>
</section>
<section id="the-problem-of-identifiability" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="the-problem-of-identifiability"><span class="header-section-number">1.2</span> The Problem of Identifiability</h3>
<p>As <span class="citation" data-cites="Bafumi+2005">(Section 2 Bafumi et al., 2005)</span> nicely categorized, the above model has three sources of non-identifiability:</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="Sources of non-identifiability">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Sources of non-identifiability
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Additive aliasing / base point indeterminancy</p>
<p>For any <img src="https://latex.codecogs.com/png.latex?c%5Cin%5Cmathbb%7BR%7D">, the transformation <img src="https://latex.codecogs.com/png.latex?%0A(%5Cbeta_j,%5Cwidetilde%7B%5Calpha%7D_j,X_i)%5Cmapsto(%5Cbeta_j-c,%5Cwidetilde%7B%5Calpha%7D_j+c,X_i+c),%5Cqquad%20c%5Cin%5Cmathbb%7BR%7D,%0A"> does not change the likelihood.</p></li>
<li><p>Multiplicative aliasing / scaling indeterminancy</p>
<p>Same applies to the following transformation: <img src="https://latex.codecogs.com/png.latex?%0A(%5Cbeta_j,%5Cwidetilde%7B%5Calpha%7D_j,X_i)%5Cmapsto(c%5E%7B-1%7D%5Cbeta_j,c%5Cwidetilde%7B%5Calpha%7D_j,cX_i),%5Cqquad%20c%3E0.%0A"></p></li>
<li><p><strong>Reflection invariance</strong> / sign indeterminacy</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A(%5Cbeta_j,%5Cwidetilde%7B%5Calpha%7D_j,X_i)%5Cmapsto(-%5Cbeta_j,-%5Cwidetilde%7B%5Calpha%7D_j,-X_i)%0A"></p></li>
</ol>
</div>
</div>
<p>Although all of the three problems may be settled by setting informative prior distributions to one of the <img src="https://latex.codecogs.com/png.latex?%5Calpha_j,%5Cbeta_j,X_i">’s, e.g., <img src="https://latex.codecogs.com/png.latex?X_i%5Csim%20N(0,1)">, the authors <span class="citation" data-cites="Bafumi+2005">(Bafumi et al., 2005)</span> propose a different approach to the thrid problem, reflection invariance.</p>
</section>
<section id="resolution-by-hierarchical-structure" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="resolution-by-hierarchical-structure"><span class="header-section-number">1.3</span> Resolution by Hierarchical Structure</h3>
<p><span class="citation" data-cites="Bafumi+2005">(Bafumi et al., 2005)</span> proceed to introduce a person(/judge)-level predictor <img src="https://latex.codecogs.com/png.latex?Z_i"> to the model, i.e., <img src="https://latex.codecogs.com/png.latex?%0AX_i%5Csim%5Cmathrm%7BN%7D(%5Cdelta+%5Cgamma%20Z_i,%5Csigma%5E2)%0A"> to indirectly inform the model of the correct sign of the ideal points.</p>
<p>Specifically, <img src="https://latex.codecogs.com/png.latex?Z_i%5Cin%5C%7B%5Cpm1%5C%7D"> corresponds to the <em>party</em> of the nominating president of <img src="https://latex.codecogs.com/png.latex?i">-th judge; <img src="https://latex.codecogs.com/png.latex?Z_i=+1"> corresponds to the <em>Republican</em> party, and <img src="https://latex.codecogs.com/png.latex?Z_i=-1"> corresponds to the <em>Democratic</em> party.</p>
<p>In this way, <span class="citation" data-cites="Bafumi+2005">(Bafumi et al., 2005)</span> tried to guide the model &amp; likelihood to have only one mode, where liberal judges would be on the left and conservative judges would be on the right on the <img src="https://latex.codecogs.com/png.latex?X_i%5Cin%5Cmathbb%7BR%7D"> axis.</p>
</section>
<section id="the-problem-remains" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="the-problem-remains"><span class="header-section-number">1.4</span> The Problem Remains …</h3>
<p>Let us consider the data from the 1994-2004 terms of the U.S. Supreme Court here, although <span class="citation" data-cites="Bafumi+2005">(Bafumi et al., 2005)</span> used the data from the 1954-2000 terms. The data is available as <code>Rehnquist</code> via the <code>MCMCpack</code> package <span class="citation" data-cites="Martin+2011">(Martin et al., 2011)</span> in R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(MCMCpack)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(Rehnquist)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(Rehnquist))</span></code></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Rehnquist</th>
<th style="text-align: right;">Stevens</th>
<th style="text-align: right;">O.Connor</th>
<th style="text-align: right;">Scalia</th>
<th style="text-align: right;">Kennedy</th>
<th style="text-align: right;">Souter</th>
<th style="text-align: right;">Thomas</th>
<th style="text-align: right;">Ginsburg</th>
<th style="text-align: right;">Breyer</th>
<th style="text-align: right;">term</th>
<th style="text-align: right;">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Let us first see the ‘correct’ output from the model. The precise meaning of ‘correct’ will be clarified later in the next Section&nbsp;2, along with the Stan codes.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model1.png" class="img-fluid figure-img"></p>
<figcaption>A ‘correct’ output from <code>bafumi_normal.stan</code></figcaption>
</figure>
</div>
<p>We see four judges classified as <em>liberal</em>, namely Stevens, Souter, Ginsburg &amp; Breyer. The last two judges were nominated by Bill Clinton, a Democrat, while the first two were nominated by Republican presidents.</p>
<p>This result aligns with the common understanding of the Supreme Court justices. For instance, we quote a sentence from the <a href="https://en.wikipedia.org/wiki/John_Paul_Stevens">wikipedia page of John Paul Stevens</a>:</p>
<blockquote class="blockquote">
<p>Despite being a registered Republican who throughout his life identified as a conservative, Stevens was considered to have been on the liberal side of the Court at the time of his retirement.</p>
</blockquote>
<p>The similar situation applies to David Souter.</p>
<p>Here we notice that two liberal judges have <img src="https://latex.codecogs.com/png.latex?Z_i=+1">, while the other two have <img src="https://latex.codecogs.com/png.latex?Z_i=-1">. The predictive ability of the covariate <img src="https://latex.codecogs.com/png.latex?Z_i"> is (presumably) weak during the 1994-2004 term.</p>
<p>Therefore, the information from <img src="https://latex.codecogs.com/png.latex?Z_i"> about the sign of the ideal points may not be strong enough to resolve the identifiability problem. In that case, the posterior distribution would be bimodal. Indeed, this is the case, as we will see next.</p>
</section>
</section>
<section id="sec-bafumi-stan" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="sec-bafumi-stan"><span class="header-section-number">2</span> Estimation by Stan</h2>
<p>The 2PL model (1), (2) can be written in Stan as follows:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>bafumi_normal.stan</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename="bafumi_normal.stan" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">data</span> {</span>
<span id="cb2-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; n;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// n = N * J - #(NA responses)</span></span>
<span id="cb2-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of judges</span></span>
<span id="cb2-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; J;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of cases</span></span>
<span id="cb2-5"></span>
<span id="cb2-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; Y;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// response variable</span></span>
<span id="cb2-7">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] Z;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// covariates for judges</span></span>
<span id="cb2-8">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=N&gt; i;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// indicator for judges i in [N]</span></span>
<span id="cb2-9">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=J&gt; j;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// indicator for cases j in [J]</span></span>
<span id="cb2-10">}</span>
<span id="cb2-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">parameters</span> {</span>
<span id="cb2-12">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] X;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// ideal points for judges</span></span>
<span id="cb2-13">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[J] alpha;</span>
<span id="cb2-14">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[J] beta;</span>
<span id="cb2-15"></span>
<span id="cb2-16">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> delta;</span>
<span id="cb2-17">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> gamma;</span>
<span id="cb2-18">}</span>
<span id="cb2-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">transformed parameters</span> {</span>
<span id="cb2-20">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> lprior = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>;</span>
<span id="cb2-21"></span>
<span id="cb2-22">  lprior += std_normal_lpdf(delta);</span>
<span id="cb2-23">  lprior += std_normal_lpdf(gamma);</span>
<span id="cb2-24">  lprior += std_normal_lpdf(alpha);</span>
<span id="cb2-25">  lprior += std_normal_lpdf(beta);</span>
<span id="cb2-26">  lprior += std_normal_lpdf(X);</span>
<span id="cb2-27">}</span>
<span id="cb2-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">model</span> {</span>
<span id="cb2-29">  X ~ normal(delta + Z * exp(gamma), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb2-30"></span>
<span id="cb2-31">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[n] mu = rep_vector(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, n);</span>
<span id="cb2-32">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (k <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:n) {</span>
<span id="cb2-33">    mu[k] = alpha[j[k]] + beta[j[k]] * X[i[k]];</span>
<span id="cb2-34">  }</span>
<span id="cb2-35">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> bernoulli_logit_lpmf(Y | mu);</span>
<span id="cb2-36">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> lprior;</span>
<span id="cb2-37">}</span></code></pre></div>
</div>
<p>Using this Stan code, we run the following experiment, where we run 4 chains in parallel, each with 4000 iterations, 3000 of which are used for warmup. The chains are initialized randomly.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Files/experiment.r</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="Files/experiment.r" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) {</span>
<span id="cb3-2">  fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bafumi_normal.stan"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4">  all_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X</span>
<span id="cb3-5">  last_1000_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_samples[(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(all_samples) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">999</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(all_samples), ]</span>
<span id="cb3-6">  mean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(last_1000_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, mean)</span>
<span id="cb3-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (mean[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) {</span>
<span id="cb3-8">    count <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-9">  }</span>
<span id="cb3-10">}</span>
<span id="cb3-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(count)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] 52</code></pre>
</div>
</div>
<p>The following plots are some (first 9) of the results from the experiment.</p>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_1.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.99 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_2.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 17.01 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_3.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.30 seconds</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_4.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 15.00 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_5.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 14.98 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_6.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 15.06 seconds</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_7.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.42 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_8.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.57 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_9.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 17.18 seconds</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>We see that the result has two patterns and they are in symmetry with each other.</p>
<p>This phenomenon proves that the posterior distribution of the ideal points is bimodal, indicating the weak identifiability of the model.</p>
</section>
<section id="conclusion" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">3</span> Conclusion</h2>
<p><span class="citation" data-cites="Bafumi+2005">(Bafumi et al., 2005)</span>’s hierarchical resolution of the identifiability problem by the covariate <img src="https://latex.codecogs.com/png.latex?Z_i"> will fail if the covariate <img src="https://latex.codecogs.com/png.latex?Z_i"> is not informative enough.</p>
<p>In that case, the posterior distribution of the ideal points will be bimodal.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Bafumi+2005" class="csl-entry">
Bafumi, J., Gelman, A., Park, D. K., and Kaplan, N. (2005). <a href="https://doi.org/10.1093/pan/mpi010"><span class="nocase">Practical Issues in Implementing and Understanding Bayesian Ideal Point Estimation</span></a>. <em>Political Analysis</em>, <em>13</em>(2), 171–187.
</div>
<div id="ref-Martin+2011" class="csl-entry">
Martin, A. D., Quinn, K. M., and Park, J. H. (2011). <a href="https://doi.org/10.18637/jss.v042.i09"><span class="nocase">MCMCpack: Markov chain Monte Carlo in R</span></a>. <em>Journal of Statistical Software</em>, <em>42</em>(9), 1–21.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-copyright"><h2 class="anchored quarto-appendix-heading">Copyright</h2><div class="quarto-appendix-contents"><div>Copyright Hirofumi Shiba 2024. All Rights Reserved</div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{shiba2024,
  author = {Shiba, Hirofumi},
  title = {On the {Identifiability} of the {Bafumi} Et. Al. {Ideal}
    {Point} {Model}},
  date = {2024-12-22},
  url = {https://162348.github.io/posts/2024/TransDimensionalModels/Bafumi.html},
  langid = {en},
  abstract = {Ideal point models are 2-parameter item response model,
    tailored to the purpose of visualizing / measuring the ideological
    positions of the legislators / judges. {[}@Bafumi+2005{]} introduced
    a hierarchical structure to the model to deal with the problem of
    identifiability. In this article, we re-examine the model and show
    that the posterior distribution of the parameters (ideal points) is
    still **bimodal**, indicating its weak identifiability.}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-shiba2024" class="csl-entry quarto-appendix-citeas">
Shiba, H. (2024, December 22). <a href="https://162348.github.io/posts/2024/TransDimensionalModels/Bafumi.html">On
the Identifiability of the Bafumi et. al. Ideal Point Model</a>.
</div></div></section></div> ]]></description>
  <category>Bayesian</category>
  <category>Statistics</category>
  <category>MCMC</category>
  <category>R</category>
  <guid>https://162348.github.io/posts/2024/TransDimensionalModels/Bafumi.html</guid>
  <pubDate>Sun, 22 Dec 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>brms を用いたベイズ混合ロジスティック回帰分析</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Survey/BayesGLMM.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="項目応答モデル" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="項目応答モデル"><span class="header-section-number">1</span> 項目応答モデル</h2>
<section id="データの概観" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="データの概観"><span class="header-section-number">1.1</span> データの概観</h3>
<p><span class="citation" data-cites="Vansteelandt2001">(Vansteelandt, 2001)</span>, <span class="citation" data-cites="Boeck-Wilson2004">(Boeck and Wilson, 2004)</span> による「怒るかどうか？」のデータ <a href="https://rdrr.io/cran/lme4/man/VerbAgg.html"><code>VerbAgg</code></a> を用いる．混合モデルの点推定のためのパッケージ <code>lme4</code> <span class="citation" data-cites="Bates+2015">(Bates et al., 2015)</span> で利用可能になっている．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lme4)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"VerbAgg"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lme4"</span>)</span>
<span id="cb1-3">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> VerbAgg</span></code></pre></div>
</div>
<p>質問票は「自分が意思表示をしたのにバスが止まってくれなかったので悪態をついた」などのもので，同意できるかを３段階 “yes”, “perhaps”, “no” で評価する <span class="citation" data-cites="Boeck-Wilson2004">(Boeck and Wilson, 2004, pp. 7–8)</span>．</p>
<p>応答は３段階の順序応答 <code>resp</code> とこれを２段階にしたもの <code>r2</code> である．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(df))</span></code></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">Anger</th>
<th style="text-align: left;">Gender</th>
<th style="text-align: left;">item</th>
<th style="text-align: left;">resp</th>
<th style="text-align: left;">id</th>
<th style="text-align: left;">btype</th>
<th style="text-align: left;">situ</th>
<th style="text-align: left;">mode</th>
<th style="text-align: left;">r2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">20</td>
<td style="text-align: left;">M</td>
<td style="text-align: left;">S1WantCurse</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">curse</td>
<td style="text-align: left;">other</td>
<td style="text-align: left;">want</td>
<td style="text-align: left;">N</td>
</tr>
<tr class="even">
<td style="text-align: right;">11</td>
<td style="text-align: left;">M</td>
<td style="text-align: left;">S1WantCurse</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">curse</td>
<td style="text-align: left;">other</td>
<td style="text-align: left;">want</td>
<td style="text-align: left;">N</td>
</tr>
<tr class="odd">
<td style="text-align: right;">17</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">S1WantCurse</td>
<td style="text-align: left;">perhaps</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">curse</td>
<td style="text-align: left;">other</td>
<td style="text-align: left;">want</td>
<td style="text-align: left;">Y</td>
</tr>
<tr class="even">
<td style="text-align: right;">21</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">S1WantCurse</td>
<td style="text-align: left;">perhaps</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">curse</td>
<td style="text-align: left;">other</td>
<td style="text-align: left;">want</td>
<td style="text-align: left;">Y</td>
</tr>
<tr class="odd">
<td style="text-align: right;">17</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">S1WantCurse</td>
<td style="text-align: left;">perhaps</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">curse</td>
<td style="text-align: left;">other</td>
<td style="text-align: left;">want</td>
<td style="text-align: left;">Y</td>
</tr>
<tr class="even">
<td style="text-align: right;">21</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">S1WantCurse</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">curse</td>
<td style="text-align: left;">other</td>
<td style="text-align: left;">want</td>
<td style="text-align: left;">Y</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="固定効果１母数モデル" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="固定効果１母数モデル"><span class="header-section-number">1.2</span> 固定効果１母数モデル</h3>
<p>通常の１母数モデルに，過分散を説明するための固定効果の項 <img src="https://latex.codecogs.com/png.latex?%5Calpha_0"> を加えたモデルを考える：</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ag(%5Coperatorname%7BP%7D%5BY_%7Bik%7D=1%5D)=%5Calpha_%7Bj%5Bi%5D%7D-%5Cbeta_%7Bk%5Bi%5D%7D+%5Calpha_0,%5Cqquad%5Calpha_0%5Csim%5Cmathrm%7Bt%7D(3;0,2.5),%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Calpha_j%5Csim%5Cmathrm%7BN%7D(%5Cmu_%5Calpha,%5Csigma_%5Calpha%5E2),%5Cquad%5Cmu_%5Calpha%5Csim%5Cmathrm%7BN%7D(0,3),%5Cquad%5Csigma_%5Calpha%5Csim%5Cmathrm%7BN%7D(0,3),%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_k%5Csim%5Cmathrm%7BN%7D(%5Cmu_%5Cbeta,%5Csigma_%5Cbeta%5E2),%5Cquad%5Cmu_%5Cbeta%5Csim%5Cmathrm%7BN%7D(0,3),%5Cquad%5Csigma_%5Cbeta%5Csim%5Cmathrm%7BN%7D(0,3).%0A"></p>
<p><code>sd</code> というクラスはグループレベル変数の標準偏差を意味する．</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Calpha_j,%5Cbeta_k"> の定数の違いに関する識別不可能性は，いずれも <img src="https://latex.codecogs.com/png.latex?0"> を中心とした</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">formula_1PL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(r2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>item) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>id))</span>
<span id="cb3-2">prior_1PL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal(0,3)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal(0,3)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"item"</span>)</span>
<span id="cb3-4">fit_1PL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb3-5">  formula_1PL,</span>
<span id="cb3-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df,</span>
<span id="cb3-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brmsfamily</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bernoulli"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>),</span>
<span id="cb3-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> prior_1PL,</span>
<span id="cb3-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb3-10">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior_summary</span>(fit_1PL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior     class      coef group resp dpar nlpar lb ub
 student_t(3, 0, 2.5) Intercept                                      
 student_t(3, 0, 2.5)        sd                                  0   
          normal(0,3)        sd              id                  0   
          normal(0,3)        sd Intercept    id                  0   
          normal(0,3)        sd            item                  0   
          normal(0,3)        sd Intercept  item                  0   
       source
      default
      default
         user
 (vectorized)
         user
 (vectorized)</code></pre>
</div>
</div>
<p><code>vectorized</code> というのは，下記 Stan コード内で尤度は for 文で構成されるが，このループに入れなくて良いものがある場合をいう．</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Stan コードの表示">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Stan コードの表示
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stancode</span>(fit_1PL)</span></code></pre></div>
<p>によって推定に用いられた Stan コードが表示できる．</p>
<p>次を見る限り，確かに意図したモデルになっている：</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// generated with brms 2.21.0</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">functions</span> {</span>
<span id="cb7-3">}</span>
<span id="cb7-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">data</span> {</span>
<span id="cb7-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// total number of observations</span></span>
<span id="cb7-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> Y;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// response variable</span></span>
<span id="cb7-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// data for group-level effects of ID 1</span></span>
<span id="cb7-8">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of grouping levels</span></span>
<span id="cb7-9">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; M_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of coefficients per level</span></span>
<span id="cb7-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; J_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// grouping indicator per observation</span></span>
<span id="cb7-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level predictor values</span></span>
<span id="cb7-12">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] Z_1_1;</span>
<span id="cb7-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// data for group-level effects of ID 2</span></span>
<span id="cb7-14">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of grouping levels</span></span>
<span id="cb7-15">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; M_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of coefficients per level</span></span>
<span id="cb7-16">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; J_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// grouping indicator per observation</span></span>
<span id="cb7-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level predictor values</span></span>
<span id="cb7-18">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] Z_2_1;</span>
<span id="cb7-19">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> prior_only;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// should the likelihood be ignored?</span></span>
<span id="cb7-20">}</span>
<span id="cb7-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">transformed data</span> {</span>
<span id="cb7-22">}</span>
<span id="cb7-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">parameters</span> {</span>
<span id="cb7-24">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> Intercept;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// temporary intercept for centered predictors</span></span>
<span id="cb7-25">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt;[M_1] sd_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level standard deviations</span></span>
<span id="cb7-26">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[M_1] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_1] z_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// standardized group-level effects</span></span>
<span id="cb7-27">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt;[M_2] sd_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level standard deviations</span></span>
<span id="cb7-28">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[M_2] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_2] z_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// standardized group-level effects</span></span>
<span id="cb7-29">}</span>
<span id="cb7-30"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">transformed parameters</span> {</span>
<span id="cb7-31">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_1] r_1_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// actual group-level effects</span></span>
<span id="cb7-32">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_2] r_2_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// actual group-level effects</span></span>
<span id="cb7-33">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> lprior = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// prior contributions to the log posterior</span></span>
<span id="cb7-34">  r_1_1 = (sd_1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] * (z_1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]));</span>
<span id="cb7-35">  r_2_1 = (sd_2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] * (z_2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]));</span>
<span id="cb7-36">  lprior += student_t_lpdf(Intercept | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb7-37">  lprior += normal_lpdf(sd_1 | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb7-38">    - <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> * normal_lccdf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>);</span>
<span id="cb7-39">  lprior += normal_lpdf(sd_2 | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb7-40">    - <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> * normal_lccdf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>);</span>
<span id="cb7-41">}</span>
<span id="cb7-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">model</span> {</span>
<span id="cb7-43">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// likelihood including constants</span></span>
<span id="cb7-44">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (!prior_only) {</span>
<span id="cb7-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// initialize linear predictor term</span></span>
<span id="cb7-46">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] mu = rep_vector(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, N);</span>
<span id="cb7-47">    mu += Intercept;</span>
<span id="cb7-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (n <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:N) {</span>
<span id="cb7-49">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// add more terms to the linear predictor</span></span>
<span id="cb7-50">      mu[n] += r_1_1[J_1[n]] * Z_1_1[n] + r_2_1[J_2[n]] * Z_2_1[n];</span>
<span id="cb7-51">    }</span>
<span id="cb7-52">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> bernoulli_logit_lpmf(Y | mu);</span>
<span id="cb7-53">  }</span>
<span id="cb7-54">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// priors including constants</span></span>
<span id="cb7-55">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> lprior;</span>
<span id="cb7-56">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> std_normal_lpdf(z_1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb7-57">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> std_normal_lpdf(z_2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb7-58">}</span>
<span id="cb7-59"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">generated quantities</span> {</span>
<span id="cb7-60">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// actual population-level intercept</span></span>
<span id="cb7-61">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> b_Intercept = Intercept;</span>
<span id="cb7-62">}</span></code></pre></div>
<p><code>-1*normal_lccdf(0|0,3)</code> というのは定数であり，推定には全く影響を与えないが，後続の <code>bridgesampling</code> パッケージ <span class="citation" data-cites="Gronau-Singmann-Wagenmakers2020">(Gronau et al., 2020)</span> によるモデル比較の API 構築のために付けられたものである <span class="citation" data-cites="Burkner2021">(Bürkner, 2021, p. 21)</span>．</p>
</div>
</div>
</div>
<!-- 



::: {.cell}

```{.r .cell-code}
sum <- summary(fit_1PL)
row1 <- data.frame(sum$fix)
row2 <- data.frame(sum$random[1]) %>%
  setNames(colnames(row1))
row3 <- data.frame(sum$random[2]) %>%
  setNames(colnames(row1))
kable(rbind(row1, row2, row3))
```

::: {.cell-output-display}


|               |   Estimate| Est.Error|   l.95..CI|  u.95..CI|     Rhat|  Bulk_ESS|  Tail_ESS|
|:--------------|----------:|---------:|----------:|---------:|--------:|---------:|---------:|
|Intercept      | -0.1564909| 0.2435213| -0.6341661| 0.3100085| 1.004683|  354.7554|  811.8406|
|sd(Intercept)  |  1.3877896| 0.0728928|  1.2496141| 1.5372286| 1.004518| 1004.1877| 1840.1941|
|sd(Intercept)1 |  1.2233172| 0.1905751|  0.9072381| 1.6420208| 1.000758|  470.7709| 1009.1518|


:::
:::



-->
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit_1PL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: bernoulli 
  Links: mu = logit 
Formula: r2 ~ 1 + (1 | item) + (1 | id) 
   Data: df (Number of observations: 7584) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 316) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.39      0.07     1.25     1.54 1.00     1004     1840

~item (Number of levels: 24) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.22      0.19     0.91     1.64 1.00      471     1009

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    -0.16      0.24    -0.63     0.31 1.00      355      812

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>低い ESS から変動効果の項 <img src="https://latex.codecogs.com/png.latex?%5Cepsilon_i"> の推定に苦労していることがわかる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit_1PL)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLMM_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>ここにはグローバルなパラメータしか表示されておらず，ランダム効果の結果は次のように見る必要がある：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb11-2">ranef_item <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ranef</span>(fit_1PL)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>item</span>
<span id="cb11-3">posterior_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_item[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb11-4">lower_bounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_item[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb11-5">upper_bounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_item[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb11-6">plot_df_item <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb11-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">item =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(ranef_item),</span>
<span id="cb11-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> posterior_means,</span>
<span id="cb11-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> lower_bounds,</span>
<span id="cb11-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> upper_bounds</span>
<span id="cb11-11">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">p_PL1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_df_item, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> item)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Means and 95% Credible Intervals for Items"</span>,</span>
<span id="cb12-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Estimate"</span>,</span>
<span id="cb12-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Item"</span>)</span>
<span id="cb12-8">p_PL1</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLMM_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>多くの参加者にとって腹立たしい例とそうでない例が区別できているようである．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">plot_df_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plot_df_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(mean) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rank =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>())</span>
<span id="cb13-2">p_PL1_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_df_id, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> rank)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Means and 95% Credible Intervals for Individuals"</span>,</span>
<span id="cb13-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Estimate"</span>,</span>
<span id="cb13-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Individual"</span>)</span>
<span id="cb13-9">p_PL1_id</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLMM_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>こうして怒りやすかった人を並べることができる．</p>
<p>しかしガタガタしている区分定数的な模様が見れる．実はこれは item の分だけある．というのも，「何個の項目に Yes と答えたか」だけが <img src="https://latex.codecogs.com/png.latex?%5Calpha_j"> を決める要因になってしまっているためである．</p>
<p>これが項目識別のできない１母数モデルの限界である．</p>
</section>
<section id="固定効果２母数モデル" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="固定効果２母数モデル"><span class="header-section-number">1.3</span> 固定効果２母数モデル</h3>
<p>項目識別力母数 <img src="https://latex.codecogs.com/png.latex?%5Cgamma_k"> を導入する： <img src="https://latex.codecogs.com/png.latex?%0Ag(%5Cmu_i)=%5Cgamma_%7Bk%5Bi%5D%7D%5Cbiggr(%5Calpha_%7Bj%5Bi%5D%7D-%5Cbeta_%7Bk%5Bi%5D%7D%5Cbiggl),%0A"></p>
<p>すると追加の制約が必要になる．ここでは理想点モデルの場合と違い，研究のデザインから <img src="https://latex.codecogs.com/png.latex?%5Cgamma_%7Bk%5Bi%5D%7D"> は正として良いだろう．</p>
<p>これを変数変換 <img src="https://latex.codecogs.com/png.latex?%5Cgamma_k=%5Cexp(%5Clog%5Cgamma_k)"> によってモデルに知らせることとする．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">formula_2PL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb14-2">  r2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(loggamma) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> eta,</span>
<span id="cb14-3">  loggamma <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>item),</span>
<span id="cb14-4">  eta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>item) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>id),</span>
<span id="cb14-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nl =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb14-6">)</span></code></pre></div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?g(%5Cmu_i)"> の右辺はもはや <img src="https://latex.codecogs.com/png.latex?%5Clog%5Cgamma_k"> の線型関数ではないので，これを <code>nl=TRUE</code> によって知らせる必要がある．</p>
<p><code>|i|</code> によって，<img src="https://latex.codecogs.com/png.latex?%5Clog%5Cgamma_k"> と <img src="https://latex.codecogs.com/png.latex?%5Ceta_%7Bjk%7D"> 内の項 <img src="https://latex.codecogs.com/png.latex?%5Cbeta_k"> には相関があることを知らせている <span class="citation" data-cites="Burkner2018">(Bürkner, 2018, p. 397)</span>．項目難易度 <img src="https://latex.codecogs.com/png.latex?%5Cbeta_k"> が低いほど識別力 <img src="https://latex.codecogs.com/png.latex?%5Clog%5Cgamma_k"> は低いとしているのである．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">prior_2PL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal(0,5)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nlpar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal(0,1)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nlpar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loggamma"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constant(1)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nlpar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal(0,3)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"item"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nlpar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal(0,1)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"item"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nlpar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loggamma"</span>)</span>
<span id="cb15-6"></span>
<span id="cb15-7">fit_2PL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb15-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> formula_2PL,</span>
<span id="cb15-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df,</span>
<span id="cb15-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brmsfamily</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bernoulli"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>),</span>
<span id="cb15-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> prior_2PL,</span>
<span id="cb15-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb15-13">)</span></code></pre></div>
</div>
<p>ついに Stan が２分ほどかかるようになった上に，収束に苦労しており，ESS が低くなっている．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit_2PL)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 1 divergent transitions after warmup. Increasing
adapt_delta above 0.8 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: bernoulli 
  Links: mu = logit 
Formula: r2 ~ exp(loggamma) * eta 
         loggamma ~ 1 + (1 | i | item)
         eta ~ 1 + (1 | i | item) + (1 | id)
   Data: df (Number of observations: 7584) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~item (Number of levels: 24) 
                                      Estimate Est.Error l-95% CI u-95% CI Rhat
sd(loggamma_Intercept)                    0.12      0.06     0.01     0.24 1.01
sd(eta_Intercept)                         0.93      0.16     0.68     1.28 1.00
cor(loggamma_Intercept,eta_Intercept)     0.31      0.36    -0.46     0.90 1.01
                                      Bulk_ESS Tail_ESS
sd(loggamma_Intercept)                     712      874
sd(eta_Intercept)                         1076     1826
cor(loggamma_Intercept,eta_Intercept)      264      645

~id (Number of levels: 316) 
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(eta_Intercept)     1.00      0.00     1.00     1.00   NA       NA       NA

Regression Coefficients:
                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
loggamma_Intercept     0.32      0.06     0.20     0.44 1.00     1193     1895
eta_Intercept         -0.14      0.20    -0.52     0.25 1.00     1186     1676

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">ranef_item2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ranef</span>(fit_2PL)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>item</span>
<span id="cb19-2">posterior_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_item2[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta_Intercept"</span>]</span>
<span id="cb19-3">lower_bounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_item2[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta_Intercept"</span>]</span>
<span id="cb19-4">upper_bounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_item2[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta_Intercept"</span>]</span>
<span id="cb19-5">plot_df_item2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb19-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">item =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(ranef_item2),</span>
<span id="cb19-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> posterior_means,</span>
<span id="cb19-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> lower_bounds,</span>
<span id="cb19-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> upper_bounds</span>
<span id="cb19-10">)</span>
<span id="cb19-11">p_PL2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_df_item2, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> item)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb19-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2PL Model"</span>,</span>
<span id="cb19-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Estimate"</span>,</span>
<span id="cb19-17">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Item"</span>)</span>
<span id="cb19-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid.arrange</span>(p_PL1, p_PL2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLMM_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>識別力パラメータ <img src="https://latex.codecogs.com/png.latex?%5Cgamma_k"> が <img src="https://latex.codecogs.com/png.latex?1"> より大きい値をとっており，これが変動を吸収しているため，<img src="https://latex.codecogs.com/png.latex?%5Calpha_j"> は <img src="https://latex.codecogs.com/png.latex?0"> に縮小されて推定されるようになっている．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">ranef_id2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ranef</span>(fit_2PL)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>id</span>
<span id="cb20-2">posterior_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_id2[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta_Intercept"</span>]</span>
<span id="cb20-3">lower_bounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_id2[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta_Intercept"</span>]</span>
<span id="cb20-4">upper_bounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_id2[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta_Intercept"</span>]</span>
<span id="cb20-5">plot_df_id2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb20-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(ranef_id2),</span>
<span id="cb20-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> posterior_means,</span>
<span id="cb20-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> lower_bounds,</span>
<span id="cb20-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> upper_bounds</span>
<span id="cb20-10">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">plot_df_id2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plot_df_id2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(mean) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rank =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>())</span>
<span id="cb21-2">p_PL2_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_df_id2, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> rank)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb21-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2PL Model"</span>,</span>
<span id="cb21-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Estimate"</span>,</span>
<span id="cb21-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Individual"</span>)</span>
<span id="cb21-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid.arrange</span>(p_PL1_id, p_PL2_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLMM_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>少し滑らかになっている．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(ranef_id[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Intercept"</span>], ranef_id2[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eta_Intercept"</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9994873</code></pre>
</div>
</div>
<p>しかし線型の相関になっており，軟化以上の変化は導入されなかったことがわかる．</p>
<p>それもそうである．モデルの表現力はあげたから解像度は高くなったが，モデルに新しい情報を入れたわけではないのである．</p>
</section>
<section id="共変量の追加" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="共変量の追加"><span class="header-section-number">1.4</span> 共変量の追加</h3>
<p>理想点モデルなど多くの項目応答モデルは，<img src="https://latex.codecogs.com/png.latex?%5Calpha_j,%5Cbeta_k"> の推定に終始してきたが，本当のリサーチクエスチョンはその先にある．</p>
<p>個人レベルの共変量を追加した階層モデルを構築して，<img src="https://latex.codecogs.com/png.latex?%5Calpha_j"> の位置や応答の傾向への影響を調べることが真の目標であった．</p>
<section id="項目共変量の追加" class="level4" data-number="1.4.1">
<h4 data-number="1.4.1" class="anchored" data-anchor-id="項目共変量の追加"><span class="header-section-number">1.4.1</span> 項目共変量の追加</h4>
<p>本データにおいて項目は <img src="https://latex.codecogs.com/png.latex?2%5Ctimes2%5Ctimes3"> の split-plot デザインがなされている．</p>
<p><code>mode</code> とは「悪態をつきたい」と「咄嗟についてしまう」という２種の行動を区別するためのものである．この２つの行動容態は，本人の抑制的な意識が実際に働いたかどうかにおいて全く質的に異なる．モデルにこれを教えたらどうなるだろうか？</p>
<p><code>situ</code> とはシチュエーションであり，自分に責任があるか（「店に入ろうとした瞬間閉店時間になった」など）他人に責任があるか（「バスが止まってくれなかった」など）の２項目がある．</p>
<p><code>btype</code> は行動様式であり，「悪態をつく」「叱る」「怒鳴りつける」の３項目がある．後に行くほど他人への攻撃性が強い．</p>
<p>最初に考えられるモデル</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">r2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> btype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> situ <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mode <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>item) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mode<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>id)</span></code></pre></div>
<p>は，元々の１母数モデルに変動切片項を３つ追加した上に，<code>mode</code> の係数を個人ごとに変えることを許したものである．これは <code>mode</code> の効果が個人ごとに異なるだろうという信念による．</p>
<p>しかしこのモデルに至る前に，<code>1</code> を <code>0</code> にすることで <code>modedo</code> と <code>modewant</code> 双方の標準偏差を推定することを考える（<code>1</code> の場合は <code>modewant</code> の標準偏差の代わりに <code>Intercept</code> の標準偏差を推定する）．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1">formula_1PL_cov <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb25-2">  r2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> btype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> situ <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mode <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>item) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mode<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>id)</span>
<span id="cb25-3">)</span>
<span id="cb25-4">fit_1PL_cov <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb25-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> formula_1PL_cov,</span>
<span id="cb25-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df,</span>
<span id="cb25-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brmsfamily</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bernoulli"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>),</span>
<span id="cb25-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> prior_1PL,</span>
<span id="cb25-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb25-10">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit_1PL_cov)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: bernoulli 
  Links: mu = logit 
Formula: r2 ~ btype + situ + mode + (1 | item) + (0 + mode | id) 
   Data: df (Number of observations: 7584) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 316) 
                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
sd(modewant)             1.47      0.09     1.30     1.65 1.00     1898
sd(modedo)               1.67      0.10     1.48     1.88 1.00     1932
cor(modewant,modedo)     0.77      0.04     0.69     0.84 1.00     1674
                     Tail_ESS
sd(modewant)             3005
sd(modedo)               2826
cor(modewant,modedo)     2675

~item (Number of levels: 24) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     0.46      0.09     0.32     0.68 1.00     1643     2370

Regression Coefficients:
           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept      1.88      0.23     1.42     2.32 1.00     1923     2640
btypescold    -1.12      0.24    -1.60    -0.63 1.00     2004     2515
btypeshout    -2.23      0.25    -2.73    -1.74 1.00     1962     2482
situself      -1.12      0.21    -1.53    -0.70 1.00     1941     2500
modedo        -0.77      0.21    -1.18    -0.33 1.00     2114     2523

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p><code>modedo</code> の係数が負になっており，悪態をつきたくなっても，実際にする人の割合は下がることがわかる．</p>
<p>だが係数の <code>-0.77</code> が大きいかどうかがわからない．これには対数オッズ比のスケールから元のスケールに戻す便利な関数がある：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conditional_effects</span>(fit_1PL_cov, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mode"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLMM_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>確率としての減少は軽微だがあることがわかる．次に気づくことは <code>do</code> の方がエラーバーが長いことである．２つの係数は相関しているので，頻度論的な検定は難しいかもしれないが，２つの標準偏差の差の事後分布を見ることでチェックすることができる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">hyp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"modedo - modewant &gt; 0"</span></span>
<span id="cb29-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hypothesis</span>(fit_1PL_cov, hyp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hypothesis Tests for class sd_id:
             Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio
1 (modedo-modewant) &gt; 0      0.2      0.12     0.01     0.39       23.1
  Post.Prob Star
1      0.96    *
---
'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.
'*': For one-sided hypotheses, the posterior probability exceeds 95%;
for two-sided hypotheses, the value tested against lies outside the 95%-CI.
Posterior probabilities of point hypotheses assume equal prior probabilities.</code></pre>
</div>
</div>
<p><code>0.96</code> の確率で <code>modedo</code> の標準偏差の方が大きいことがわかるが，その差も <code>0.2</code> ほどで，対数オッズ比としては大したことがないと思われる．</p>
</section>
<section id="個人共変量の追加" class="level4" data-number="1.4.2">
<h4 data-number="1.4.2" class="anchored" data-anchor-id="個人共変量の追加"><span class="header-section-number">1.4.2</span> 個人共変量の追加</h4>
<p>Trait Anger スコア <span class="citation" data-cites="Spielberger2010">(Spielberger, 2010)</span> が個人ごとに算出されており（<code>Anger</code> 変数），そのスコアによってどのように項目への反応が違うかを調べる．こうするとどんどん心理学の研究っぽくなる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">formula_1PL_cov_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb31-2">  r2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Anger <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> btype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> situ <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mode <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mode<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>Gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>Gender<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>item) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>mode<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>id)</span>
<span id="cb31-3">)</span>
<span id="cb31-4">fit_1PL_cov_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb31-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> formula_1PL_cov_id,</span>
<span id="cb31-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df,</span>
<span id="cb31-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brmsfamily</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bernoulli"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>),</span>
<span id="cb31-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> prior_1PL,</span>
<span id="cb31-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb31-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># これ以上大きくすると GitHub にあげられない</span></span>
<span id="cb31-11">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit_1PL_cov_id)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: bernoulli 
  Links: mu = logit 
Formula: r2 ~ Anger + Gender + btype + situ + mode + mode:Gender + (0 + Gender | item) + (0 + mode | id) 
   Data: df (Number of observations: 7584) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~id (Number of levels: 316) 
                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
sd(modewant)             1.49      0.09     1.32     1.67 1.00     1998
sd(modedo)               1.58      0.10     1.40     1.78 1.00     1715
cor(modewant,modedo)     0.78      0.04     0.70     0.85 1.00     1529
                     Tail_ESS
sd(modewant)             2740
sd(modedo)               2531
cor(modewant,modedo)     2380

~item (Number of levels: 24) 
                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
sd(GenderF)              0.52      0.11     0.35     0.77 1.01     1342
sd(GenderM)              0.34      0.11     0.16     0.57 1.00     1659
cor(GenderF,GenderM)     0.78      0.18     0.32     0.99 1.00     2178
                     Tail_ESS
sd(GenderF)              2491
sd(GenderM)              2553
cor(GenderF,GenderM)     1911

Regression Coefficients:
               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept          0.74      0.44    -0.14     1.59 1.00     1293     2072
Anger              0.06      0.02     0.02     0.09 1.00     1274     2101
GenderM           -0.10      0.24    -0.56     0.38 1.00      931     1839
btypescold        -1.03      0.22    -1.46    -0.60 1.00     1931     2144
btypeshout        -2.43      0.25    -2.90    -1.94 1.00     1472     1396
situself          -1.04      0.18    -1.38    -0.68 1.00     1919     2346
modedo            -0.98      0.23    -1.43    -0.51 1.00     1738     2315
GenderM:modedo     0.89      0.24     0.40     1.35 1.00     2525     2932

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conditional_effects</span>(fit_1PL_cov_id, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Anger"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLMM_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>個人共変量の効果と，特異項目機能</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conditional_effects</span>(fit_1PL_cov_id, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mode:Gender"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLMM_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><img src="https://162348.github.io/posts/2024/Survey/Files/cond_Anger.png" class="img-fluid"></p>
<p><code>Anger</code> の値が大きいほど悪態をつく確率が綺麗に上がっていく様子がわかる．</p>
<p>加えて，女性の方が悪態を吐こうと思っても，実際に行動に移すには大きな壁があることがわかる．こうして <code>mode</code> と <code>Gender</code> の間の交絡が陽の下に明らかになった．</p>
<p>このような，項目共変量と個人共変量の間の交絡は <strong>特異項目機能</strong> (DIF: Differential Item Functioning) と呼ばれる．項目の特性が，被験者のグループによって違った機能を示すことは，例えばテスト理論では個人の潜在特性を推定する際の重大なノイズ要因となっており，これを統制することが重要な課題になる．</p>
</section>
</section>
<section id="特異項目機能の解析" class="level3" data-number="1.5">
<h3 data-number="1.5" class="anchored" data-anchor-id="特異項目機能の解析"><span class="header-section-number">1.5</span> 特異項目機能の解析</h3>
<p>この特異項目機能を，項目の特性ごとにさらに詳しく見ていく．</p>
<p>特に怒鳴りつける行動様式を除き，悪態をつく行為と叱る行為は，男性と女性において違う機能を持っているのではないか？という仮説を検証してみる．</p>
<p>女性が実際に悪態をつく／叱る行為にだけマークをつけるダミー変数 <code>dif</code> を用意する：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dif <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span>(</span>
<span id="cb36-2">  df,</span>
<span id="cb36-3">  Gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> mode <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> btype <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"curse"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scold"</span>)</span>
<span id="cb36-4">))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1">formula_1PL_dif <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb37-2">  r2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dif <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>item) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span>id)</span>
<span id="cb37-3">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">fit_1PL_dif <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb38-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> formula_1PL_dif,</span>
<span id="cb38-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df,</span>
<span id="cb38-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brmsfamily</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bernoulli"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>),</span>
<span id="cb38-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> prior_1PL,</span>
<span id="cb38-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb38-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># iter = 3000  # これ以上大きくすると GitHub にあげられない</span></span>
<span id="cb38-8">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit_1PL_dif)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: bernoulli 
  Links: mu = logit 
Formula: r2 ~ Gender + dif + (1 | item) + (1 | id) 
   Data: df (Number of observations: 7584) 
  Draws: 3 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 3000

Multilevel Hyperparameters:
~id (Number of levels: 316) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.40      0.07     1.26     1.54 1.00      793     1557

~item (Number of levels: 24) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.34      0.21     1.00     1.84 1.01      684     1088

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     0.12      0.31    -0.51     0.72 1.00      304      502
GenderM      -0.01      0.21    -0.45     0.41 1.00      573      864
dif          -0.95      0.14    -1.23    -0.67 1.00     2875     1778

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p><code>dif</code> の係数 <code>-0.94</code> を見ることで，殊に「女性」と「実際に悪態を吐いたり叱ったりする」という組み合わせは特異な項目機能を持っていることがわかる．</p>
<!--

### 極大階層モデルの推論

関連のある共変量を全てモデルに含めて推論する方法が，最終的にはやはり好ましいとされる [@Barr+2013]．

複雑な階層モデルであっても，Stan が実装する HMC サンプラーは効率的に推論を実行してくれるようである．これを見ていこう．




::: {.cell}

```{.r .cell-code}
formula_1PL_maximal <- bf(
  r2 ~ 1 + Anger + Gender + btype + situ + mode + (1 + Anger + Gender | item) + (1 + btype + situ + mode | id)
)
fit_1PL_maximal <- brm(
  formula = formula_1PL_maximal,
  data = df,
  family = brmsfamily("bernoulli", link = "logit"),
  prior = prior_1PL,
  chains = 4, cores = 4
)
```
:::

::: {.cell}

```{.r .cell-code}
summary(fit_1PL_maximal)
```
:::




-->
</section>
</section>


<div class="quarto-listing quarto-listing-container-grid" id="listing-lst-survey">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1735430400000" data-listing-reading-time-sort="2" data-listing-word-count-sort="382">
<a href="../../../posts/2024/Survey/BDA2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析６
</h5>
<div class="card-subtitle listing-subtitle">
応答が質的変数の場合
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1733788800000" data-listing-file-modified-sort="1754014117005" data-listing-date-modified-sort="1733961600000" data-listing-reading-time-sort="5" data-listing-word-count-sort="945">
<a href="../../../posts/2024/Survey/BayesRegression.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/elpd.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> を用いたベイズ重回帰分析
</h5>
<div class="card-subtitle listing-subtitle">
BMI データを題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-10
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ1I=" data-listing-date-sort="1727827200000" data-listing-file-modified-sort="1754014117272" data-listing-date-modified-sort="1734825600000" data-listing-reading-time-sort="28" data-listing-word-count-sort="5498">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/IPE_experiment.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
理想点解析のハンズオン
</h5>
<div class="card-subtitle listing-subtitle">
<code>MCMCpack</code> パッケージとオリジナル <code>Stan</code> コードを使って
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-10-02
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div><div id="quarto-appendix" class="default"><section id="文献案内" class="level2 appendix" data-number="2"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">2</span> 文献案内</h2><div class="quarto-appendix-contents">

<p><span class="citation" data-cites="Burkner2021">(Bürkner, 2021)</span> に項目応答モデルのベイズ的な扱いが取り上げられている．特にパッケージ <code>brms</code> を用いた例が３つある．</p>
<p>DIF に関する日本語文献に <span class="citation" data-cites="熊谷龍一2012">(龍一, 2012)</span> がある．</p>




</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Bates+2015" class="csl-entry">
Bates, D., Mächler, M., Bolker, B., and Walker, S. (2015). <a href="https://doi.org/10.18637/jss.v067.i01">Fitting linear mixed-effects models using lme4</a>. <em>Journal of Statistical Software</em>, <em>67</em>(1), 1–48.
</div>
<div id="ref-Boeck-Wilson2004" class="csl-entry">
Boeck, P., and Wilson, M. (2004). <em><a href="https://doi.org/10.1007/978-1-4757-3990-9">Explanatory item response models: A generalized linear and nonlinear approach</a></em>. Springer New York.
</div>
<div id="ref-Burkner2018" class="csl-entry">
Bürkner, P.-C. (2018). <a href="https://doi.org/10.32614/RJ-2018-017"><span class="nocase">Advanced Bayesian Multilevel Modeling with the R Package brms</span></a>. <em><span>The R Journal</span></em>, <em>10</em>(1), 395–411.
</div>
<div id="ref-Burkner2021" class="csl-entry">
Bürkner, P.-C. (2021). <a href="https://doi.org/10.18637/jss.v100.i05">Bayesian item response modeling in r with brms and stan</a>. <em>Journal of Statistical Software</em>, <em>100</em>(5), 1–54.
</div>
<div id="ref-Gronau-Singmann-Wagenmakers2020" class="csl-entry">
Gronau, Q. F., Singmann, H., and Wagenmakers, E.-J. (2020). <a href="https://doi.org/10.18637/jss.v092.i10">Bridgesampling: An r package for estimating normalizing constants</a>. <em>Journal of Statistical Software</em>, <em>92</em>(10), 1–29.
</div>
<div id="ref-Spielberger2010" class="csl-entry">
Spielberger, C. D. (2010). <a href="https://doi.org/10.1002/9780470479216.corpsy0942">State-trait anger expression inventory</a>. In <em>The corsini encyclopedia of psychology</em>, pages 1–1. John Wiley &amp; Sons, Ltd.
</div>
<div id="ref-Vansteelandt2001" class="csl-entry">
Vansteelandt, K. (2001). <em>Formal models for contextualized personality psychology</em> (PhD thesis). KU Leuven. Retrieved from <a href="https://lirias.kuleuven.be/1784887&amp;lang=en">https://lirias.kuleuven.be/1784887&amp;lang=en</a>
</div>
<div id="ref-熊谷龍一2012" class="csl-entry">
龍一. (2012). <a href="https://doi.org/10.4992/jjpsy.83.35">統合的DIF検出方法の提案──<span>“EasyDIF”</span>の開発──</a>. <em>心理学研究</em>, <em>83</em>(1), 35–43.
</div>
</div></section></div> ]]></description>
  <category>Bayesian</category>
  <category>Statistics</category>
  <category>R</category>
  <category>Stan</category>
  <guid>https://162348.github.io/posts/2024/Survey/BayesGLMM.html</guid>
  <pubDate>Sat, 14 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Survey/Files/DIF.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>ベイズデータ解析７</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Survey/BDA3.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="関連記事" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="関連記事">関連記事</h2>
<div id="listing-lst-survey" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1733875200000" data-listing-reading-time-sort="3" data-listing-word-count-sort="453">
<a href="../../../posts/2024/Survey/BDA1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析５
</h5>
<div class="card-subtitle listing-subtitle">
回帰モデルの概観
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="T3BpbmlvbiUyQ1N0YXRpc3RpY3M=" data-listing-date-sort="1733875200000" data-listing-file-modified-sort="1754014114518" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="3" data-listing-word-count-sort="511">
<a href="../../../posts/2024/Lifestyle/FixedRandom.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Lifestyle/Files/Hierarchical.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
変量効果と固定効果
</h5>
<div class="card-subtitle listing-subtitle">
統一的見解を目指して
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-11
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="U3RhdGlzdGljcyUyQ0tlcm5lbCUyQ1Byb2JhYmlsaXR5JTJDQmF5ZXNpYW4=" data-listing-date-sort="1723420800000" data-listing-file-modified-sort="1754014114480" data-listing-date-modified-sort="1723593600000" data-listing-reading-time-sort="6" data-listing-word-count-sort="1073">
<a href="../../../posts/2024/Kernels/HierarchicalModel.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Kernels/Images/MM.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
階層モデル再論
</h5>
<div class="card-subtitle listing-subtitle">
多変量解析から機械学習へ
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-08-12
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="はじめに" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">1</span> はじめに</h2>
<section id="階層モデル" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="階層モデル"><span class="header-section-number">1.1</span> 階層モデル</h3>
<p>データが自然な <strong>階層構造</strong> を持つとする．例えば標本がクラスター抽出された場合，パネルデータや経時的繰り返し観測による標本，共変量統制とマッチングなど，自然な階層構造を持つデータは多い．</p>
<p>このようなデータに対して，個々のサブグループに対して全く同じ回帰モデルを繰り返し適用し，結果のプロットを小窓に分割して並べることで，グループごとの効果の違いを比較することができる．</p>
<p>この方法はナイーブながらも有力で，<span class="citation" data-cites="Gelman-Hill-Vehtari2020">(10.9 節 Gelman et al., 2020, p. 148)</span> では “secret weapon” と呼んでいる．</p>
<p>この別々の回帰モデルはベイズ的に統合して推論することができる．このグループごとに変動する係数を許したモデルが（ベイズ）<strong>階層モデル</strong> である．</p>
</section>
<section id="いつ使うか" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="いつ使うか"><span class="header-section-number">1.2</span> いつ使うか？</h3>
<p>線型回帰の枠組みで交差項を入れることで，グループごとに緩やかに異なる回帰係数を許すことができる．</p>
<p>さらには一般化線型モデルを用いることで，連続・離散データの簡単な非線型関係まで扱うことができる．</p>
<div id="listing-lst-regression" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1733788800000" data-listing-file-modified-sort="1754014117005" data-listing-date-modified-sort="1733961600000" data-listing-reading-time-sort="5" data-listing-word-count-sort="945">
<a href="../../../posts/2024/Survey/BayesRegression.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/elpd.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> を用いたベイズ重回帰分析
</h5>
<div class="card-subtitle listing-subtitle">
BMI データを題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-10
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1733875200000" data-listing-reading-time-sort="3" data-listing-word-count-sort="453">
<a href="../../../posts/2024/Survey/BDA1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析５
</h5>
<div class="card-subtitle listing-subtitle">
回帰モデルの概観
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1735430400000" data-listing-reading-time-sort="2" data-listing-word-count-sort="382">
<a href="../../../posts/2024/Survey/BDA2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析６
</h5>
<div class="card-subtitle listing-subtitle">
応答が質的変数の場合
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>それでも階層モデルに進む動機として次のような点が挙げられる：</p>
<div class="callout callout-style-default callout-important no-icon callout-titled" title="階層モデルの美点^[[11.5 節 @Gelman-Hill2006 p.246] も参照．]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
階層モデルの美点<sup>1</sup>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>説明変数が多すぎる場合は馬蹄事前分布などの構造を持った事前分布が使用可能である．しかしデータが階層構造を持つ場合は，その構造に関する事前知識を用いて，自然な事前分布を組織的に導入することができる．これが階層モデリングに他ならないとも見れる．その結果大量の説明変数がある場合でも，その関連度をモデルに知らせて適切に推定する方法にもなる<sup>2</sup>．</li>
<li>単一のグループではデータ数が小さい場合に，グループレベルの回帰係数 <img src="https://latex.codecogs.com/png.latex?%5Calpha_%7Bj%5Bi%5D%7D"> を安定して推定する手法とも理解できる．他のグループの回帰モデルと組み合わせた大きな階層モデルをベイズすることで，確度が低い（が関連する）モデルも捨てずに推定に利用するため (partial pooling)，より好ましい統計的推定を実行できる．これは <strong>縮小推定</strong> のキーワードの下でも追及されており，階層モデルは自然な縮小推定が実行される典型的な設定である．<sup>3</sup></li>
<li>グループ毎の回帰係数の違いに興味がある場合，グループレベルの変動の分散 <img src="https://latex.codecogs.com/png.latex?%5Csigma_j%5E2"> を推定する最も自然なモデルである．実際，一階層の回帰分析は <img src="https://latex.codecogs.com/png.latex?%5Csigma_j=0"> の場合，グループ毎に別々の回帰分析を実行する場合は <img src="https://latex.codecogs.com/png.latex?%5Csigma_j=%5Cinfty"> という（場合によっては非現実的な）仮定を置いた縮退した階層モデルと見れる．</li>
</ol>
</div>
</div>
<p>全体の係数のみに興味がある場合，グループレベルの変動やデータの階層構造は局外構造である．このような状況では，誤差が相関を持つ場合にも頑健な点推定手法として，一般化推定方程式法なども用いることができる．<sup>4</sup></p>
</section>
</section>
<section id="線型変動係数モデル" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="線型変動係数モデル"><span class="header-section-number">2</span> 線型変動係数モデル</h2>
<section id="変量効果モデル" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="変量効果モデル"><span class="header-section-number">2.1</span> 変量効果モデル</h3>
<p>階層モデル <span id="eq-model-1"><img src="https://latex.codecogs.com/png.latex?%0Ay_i=%5Calpha_%7Bj%5Bi%5D%7D+%5Cbeta%20x_i+%5Cepsilon_i,%5Cqquad%5Cepsilon_i%5Csim%5Coperatorname%7BN%7D(0,%5Csigma%5E2_y),%0A%5Ctag%7B1%7D"></span> <span id="eq-model-2"><img src="https://latex.codecogs.com/png.latex?%0A%5Calpha_j=%5Cmu_%5Calpha+%5Ceta_j,%5Cqquad%5Ceta_j%5Csim%5Coperatorname%7BN%7D(0,%5Csigma%5E2_%5Calpha),%0A%5Ctag%7B2%7D"></span> は２つの別の階層にある回帰モデルが，１つに統合された形をしている．<sup>5</sup></p>
<p>(1), (2) は <strong>変量効果モデル</strong>，または NER (Nest Error Regression) model <span class="citation" data-cites="Battese+1988">(Battese et al., 1988)</span> と呼ばれる．<sup>6</sup></p>
</section>
<section id="中庸としての階層モデル" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="中庸としての階層モデル"><span class="header-section-number">2.2</span> 中庸としての階層モデル</h3>
<p>全く等価だが <img src="https://latex.codecogs.com/png.latex?D_i"> を <img src="https://latex.codecogs.com/png.latex?i"> 番目の成分のみが <img src="https://latex.codecogs.com/png.latex?1"> のベクトル，<img src="https://latex.codecogs.com/png.latex?%5Calpha=(%5Calpha_1,%5Ccdots,%5Calpha_J)%5E%5Ctop"> として <img src="https://latex.codecogs.com/png.latex?%0Ay_i=D_i%5Calpha+%5Cbeta%20x_i+%5Cepsilon_i%0A"> と表すことができる．</p>
<p>こうみると <img src="https://latex.codecogs.com/png.latex?J"> 個のクラスそれぞれに関する指示変数 <img src="https://latex.codecogs.com/png.latex?D_1,%5Ccdots,D_J"> で定数項を置き換えた単一の回帰モデルと見ることもできる．仮に複数の変動係数が存在しても共線型性が問題にならないのは，<img src="https://latex.codecogs.com/png.latex?%5Calpha"> の事前分布に構造が入っているためである．</p>
<p>階層モデル (1), (2) において <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_%5Calpha%5Cto0"> の極限を考えると，グループ毎に変動がないという単一の線型回帰モデルに帰着する．</p>
<p>他方で実は <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_%5Calpha%5Cto%5Cinfty"> の極限を考えると，古典的な点推定の文脈では，<img src="https://latex.codecogs.com/png.latex?J"> グループのそれぞれに別々の線型回帰を実行するというモデルに帰着する．</p>
<p>これは「グループ毎に全く別々で互いに関係がない」というモデルであり，真実は２つの中庸にあると思われる．</p>
<p>グループ毎の変動と，その間の緩い関係性の双方を許し，１つのモデルに取り込んだものが <strong>階層モデル</strong> である．グループレベルの変動 <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_%5Calpha"> を推定するための自然なモデルでもある．</p>
</section>
<section id="blue" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="blue"><span class="header-section-number">2.3</span> BLUE</h3>
<p>線型最良不偏推定量 (BLUE) は <span class="citation" data-cites="Henderson1950">(Henderson, 1950)</span> によって提案された，<img src="https://latex.codecogs.com/png.latex?%5Cbeta,%5Calpha_%7Bj%5Bi%5D%7D"> の推定量である．</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbeta"> の推定量は計量経済学の文脈で変量効果推定量と呼ばれる GLS 推定量に他ならない．<sup>7</sup></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Calpha_%7Bj%5Bi%5D%7D"> の BLUE は，モデル (1), (2) においては <img src="https://latex.codecogs.com/png.latex?%0A%5Cwidehat%7B%5Calpha%7D_j=%5Cfrac%7B%5Cfrac%7Bn_j%7D%7B%5Calpha_y%5E2%7D%7D%7B%5Cfrac%7Bn_j%7D%7B%5Calpha_y%5E2%7D+%5Cfrac%7B1%7D%7B%5Csigma%5E2_%5Calpha%7D%7D(%5Coverline%7By%7D_j-%5Cbeta%5Coverline%7Bx%7D_j)+%5Cfrac%7B%5Cfrac%7B1%7D%7B%5Csigma%5E2_%5Calpha%7D%7D%7B%5Cfrac%7Bn_j%7D%7B%5Calpha_y%5E2%7D+%5Cfrac%7B1%7D%7B%5Csigma%5E2_%5Calpha%7D%7D%5Cmu_%5Calpha%0A"> と表せる．<sup>8</sup></p>
<!-- 
([-@eq-model-1]) のような線型モデルでは，$\al_{j[i]}$ の存在などの分布構造の要因に依らず平均が不偏推定できるのである．
-->
</section>
<section id="分散成分モデル" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="分散成分モデル"><span class="header-section-number">2.4</span> 分散成分モデル</h3>
<section id="一般的な定義" class="level4" data-number="2.4.1">
<h4 data-number="2.4.1" class="anchored" data-anchor-id="一般的な定義"><span class="header-section-number">2.4.1</span> 一般的な定義</h4>
<p><span class="citation" data-cites="Henderson1950">(Henderson, 1950)</span> に始まる分散成分モデルは，一般的には <img src="https://latex.codecogs.com/png.latex?%0Ay_%7Bij%7D=%5Cbeta%20x_i+%5Calpha_%7Bj_1%5Bi%5D%7D+%5Ccdots+%5Calpha_%7Bj_k%5Bi%5D%7D+%5Cepsilon_%7Bij%7D%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Calpha_%7Bj_l%7D%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7D%5Coperatorname%7BN%7D(0,%5Ctau_l%5E2),%0A"> と表されるモデルと理解される <span class="citation" data-cites="菅澤-久保川2023">(Sugasawa and Kubokawa, 2023, p. 73)</span>．<img src="https://latex.codecogs.com/png.latex?k=1"> の場合は <span class="citation" data-cites="Fay-Herriot1979">(Fay and Herriot, 1979)</span> モデルともいう．</p>
<p>変量効果モデルにおいて誤差には完全な階層関係があったが，分散成分モデルはその non-nested な場合への拡張とみなせる．</p>
</section>
<section id="分散成分モデルの例" class="level4" data-number="2.4.2">
<h4 data-number="2.4.2" class="anchored" data-anchor-id="分散成分モデルの例"><span class="header-section-number">2.4.2</span> 分散成分モデルの例</h4>
<p>この場合データ <img src="https://latex.codecogs.com/png.latex?y_%7Bij%7D"> の変動を成分ごとに分解しようという志向が，分散分析の発展と見れる．例えば <img src="https://latex.codecogs.com/png.latex?%0Ay_%7Bijk%7D=%5Cmu+%5Cmu_%7B1i%7D+%5Cmu_%7B2j%7D+%5Cepsilon_%7Bijk%7D%0A"> という形の場合は特に <strong>二元分類モデル</strong>，<img src="https://latex.codecogs.com/png.latex?%5Cmu_%7B3ij%7D"> も加えた場合は二元交差モデルと呼ばれる．</p>
<p>さらにグループ階層のモデルに関して，分散成分モデルではグループレベル変数 <img src="https://latex.codecogs.com/png.latex?%5Calpha_%7Bj_l%7D"> は互いに独立であるとしているが，空間モデルでは互いに相関を持つと仮定することもある．</p>
<p>さらにこの階層は潜在変数の階層とみるとコピュラモデルや理想点モデルに近くなる．項目反応モデルは，個人毎の変動と項目毎の変動の，non-nested な２つの変動を持ったロジスティック階層モデル 3 になる．</p>
</section>
<section id="分散成分の点推定法" class="level4" data-number="2.4.3">
<h4 data-number="2.4.3" class="anchored" data-anchor-id="分散成分の点推定法"><span class="header-section-number">2.4.3</span> 分散成分の点推定法</h4>
<p>変量効果モデルや分散成分モデルにも適用可能な，一般の階層モデルに適用可能な分散成分の推定法として，一般化推定方程式法がある．</p>
<p>その特別な荷重を取った場合に REML (Restricted Maximum Likelihood) 推定量がある <span class="citation" data-cites="菅澤-久保川2023">(2.3 節 Sugasawa and Kubokawa, 2023, p. 13)</span>．</p>
<p>こうして得た分散成分，特に分散比 <img src="https://latex.codecogs.com/png.latex?%5Crho:=%5Csigma%5E2_v/%5Csigma%5E2_e"> の推定量を得たあと，これを BLUE <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Cbeta%7D"> に代入して得る２段階推定量を <strong>経験 BLUE</strong> という <span class="citation" data-cites="久保川達也2006">(久保川達也, 2006, p. 143)</span>．</p>
<p>その縮小効果については次稿も参照：</p>
<div id="listing-lst-embed" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNNQ01DJTJDUiUyQ1N0YW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1715472000000" data-listing-file-modified-sort="1754014114286" data-listing-date-modified-sort="1734480000000" data-listing-reading-time-sort="9" data-listing-word-count-sort="1605">
<a href="../../../posts/2024/Computation/brms.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Computation/brms_files/figure-html/unnamed-chunk-4-1.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> によるベイズ混合モデリング入門
</h5>
<div class="card-subtitle listing-subtitle">
ポアソン混合効果モデルを例に
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-05-12
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
</section>
<section id="ベイズ推定" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="ベイズ推定"><span class="header-section-number">2.5</span> ベイズ推定</h3>
<p>ベイズ階層モデルの基礎は <span class="citation" data-cites="Lindley-Smith1972">(Lindley and Smith, 1972)</span> が敷いたと言われる．</p>
</section>
</section>
<section id="sec-multilevel-logistic" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-multilevel-logistic"><span class="header-section-number">3</span> 階層ロジスティックモデル</h2>
<section id="項目応答モデル" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="項目応答モデル"><span class="header-section-number">3.1</span> 項目応答モデル</h3>
<section id="母数ロジットモデル" class="level4" data-number="3.1.1">
<h4 data-number="3.1.1" class="anchored" data-anchor-id="母数ロジットモデル"><span class="header-section-number">3.1.1</span> １母数ロジットモデル</h4>
<p><img src="https://latex.codecogs.com/png.latex?%0Ag(x):=%5Coperatorname%7Blogit%7D(x)=%5Clog%5Cfrac%7Bx%7D%7B1-x%7D%0A"> <img src="https://latex.codecogs.com/png.latex?%0Ag(%5Cmu_%7Bi%7D)=%5Calpha_%7Bj%5Bi%5D%7D-%5Cbeta_%7Bk%5Bi%5D%7D,%5Cqquad%5Cmu_%7Bi%7D=%5Coperatorname%7BP%7D%5BY_%7Bik%7D=1%5D,%0A"> というモデルを <a href="../../../posts/2024/TransDimensionalModels/IdealPoint.html#sec-binary-IRT"><strong>１母数応答モデル</strong></a> または <span class="citation" data-cites="Rasch1960">(Rasch, 1960)</span> モデルという．</p>
<p>このモデルは <img src="https://latex.codecogs.com/png.latex?(%5Calpha_j,%5Cbeta_k)"> 上の平行移動に関して識別不可能であるため，点推定の文脈では追加の制約条件が導入される．しかしベイズの文脈では不適な事前分布を避けることで自然に回避される．</p>
<p>階層ベイズモデルでは，自然に関心が能力パラメータ <img src="https://latex.codecogs.com/png.latex?%5Calpha_j"> と難易度パラメータ <img src="https://latex.codecogs.com/png.latex?%5Cbeta_k"> の分散に向けられる： <img src="https://latex.codecogs.com/png.latex?%0A%5Calpha_j=%5Cmu_%5Calpha+%5Cgamma_%5Calpha%20X%5E%5Calpha_j+%5Cepsilon_j,%5Cqquad%5Cepsilon_j%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7D%5Coperatorname%7BN%7D(0,%5Csigma%5E2_%5Calpha),%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_k=%5Cmu_%5Cbeta+X%5E%5Cbeta_k+%5Cepsilon_k,%5Cqquad%5Cepsilon_k%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7D%5Coperatorname%7BN%7D(0,%5Csigma%5E2_%5Cbeta).%0A"></p>
</section>
<section id="母数ロジットモデル-1" class="level4" data-number="3.1.2">
<h4 data-number="3.1.2" class="anchored" data-anchor-id="母数ロジットモデル-1"><span class="header-section-number">3.1.2</span> ２母数ロジットモデル</h4>
<p>さらに項目毎の <strong>識別力母数</strong> (discrimination parameter) <img src="https://latex.codecogs.com/png.latex?%5Cgamma_k"> を導入したモデル <img src="https://latex.codecogs.com/png.latex?%0Ag(%5Cmu_i)=%5Cgamma_%7Bk%5Bi%5D%7D%5Cbiggr(%5Calpha_%7Bj%5Bi%5D%7D-%5Cbeta_%7Bk%5Bi%5D%7D%5Cbiggl),%0A"> を <a href="../../../posts/2024/TransDimensionalModels/IdealPoint.html#sec-binary-IRT"><strong>２母数ロジットモデル</strong></a> という．</p>
</section>
<section id="多次元の潜在空間" class="level4" data-number="3.1.3">
<h4 data-number="3.1.3" class="anchored" data-anchor-id="多次元の潜在空間"><span class="header-section-number">3.1.3</span> 多次元の潜在空間</h4>
<p>読解力と数学力の別々の能力を要求するテストなどのデータに対して，多次元の潜在空間を持つモデルを考えたい．</p>
<p>両方が要求される AND の論理の場合は <img src="https://latex.codecogs.com/png.latex?%0A%5Cmu_i=g%5E%7B-1%7D%5Cbiggr(%5Cgamma%5E%7B(1)%7D_%7Bk%5Bi%5D%7D(%5Calpha_%7Bj%5Bi%5D%7D-%5Cbeta%5E%7B(1)%7D_%7Bk%5Bi%5D%7D)%5Cbiggl)g%5E%7B-1%7D%5Cbiggr(%5Cgamma%5E%7B(2)%7D_%7Bk%5Bi%5D%7D(%5Calpha_%7Bj%5Bi%5D%7D-%5Cbeta%5E%7B(2)%7D_%7Bk%5Bi%5D%7D)%5Cbiggl)%0A"> というモデルが考えられるかもしれない．OR の論理の各因数を <img src="https://latex.codecogs.com/png.latex?1-%5Cmu_i,%201-g%5E%7B-1%7D(-)"> で置き換えれば良い．</p>
<p>一方で潜在空間からの関数を設定しても良いだろう．最も直感的には能力値の和で <img src="https://latex.codecogs.com/png.latex?%0A%5Cmu_i=g%5E%7B-1%7D%5Cbiggr(%5Cgamma%5E%7B(1)%7D_%7Bk%5Bi%5D%7D(%5Calpha_%7Bj%5Bi%5D%7D-%5Cbeta%5E%7B(1)%7D_%7Bk%5Bi%5D%7D)+%5Cgamma%5E%7B(2)%7D_%7Bk%5Bi%5D%7D(%5Calpha_%7Bj%5Bi%5D%7D-%5Cbeta%5E%7B(2)%7D_%7Bk%5Bi%5D%7D)%5Cbiggl)%0A"> と表すものである．</p>
</section>
<section id="応答曲線" class="level4" data-number="3.1.4">
<h4 data-number="3.1.4" class="anchored" data-anchor-id="応答曲線"><span class="header-section-number">3.1.4</span> 応答曲線</h4>
<p>リンク関数 <img src="https://latex.codecogs.com/png.latex?g"> の選択は，潜在変数 <img src="https://latex.codecogs.com/png.latex?%5Calpha_j,%5Cbeta_k,%5Cgamma_k"> の変化が応答確率の変化にどう関係するかを規定する．</p>
<p><img src="https://latex.codecogs.com/png.latex?g"> のプロットは ICC (Item Characteristic Curve) または trace line と呼ばれる <span class="citation" data-cites="Fox2010">(Fox, 2010, p. 6)</span>．</p>
<p>これは <img src="https://latex.codecogs.com/png.latex?g(0.5)"> を中心に対称になっているが，この対称性が不適切な場合も多い．</p>
<p><span class="citation" data-cites="Bafumi+2005">(Bafumi et al., 2005)</span> などは <img src="https://latex.codecogs.com/png.latex?%0A%5Cmu_i=%5Cpi_1+(1-%5Cpi_0-%5Cpi_1)g%5E%7B-1%7D%5Cbiggr(%5Cgamma_k(%5Calpha_j-%5Cbeta_k)%5Cbiggl)%0A"> として，最低限の <img src="https://latex.codecogs.com/png.latex?y_i=0,1"> への反応確率 <img src="https://latex.codecogs.com/png.latex?%5Cpi_0,%5Cpi_1"> をあらかじめ設定し，<img src="https://latex.codecogs.com/png.latex?%5B%5Cpi_0,%5Cpi_1%5D%5Csubset%5B0,1%5D"> の範囲だけに応答曲線をフィッティングすることを考えた．</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cpi_0,%5Cpi_1"> も推定すべきパラメータとする．</p>
</section>
</section>
<section id="sec-choice-model" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="sec-choice-model"><span class="header-section-number">3.2</span> 選択モデル</h3>
<section id="はじめに-1" class="level4" data-number="3.2.1">
<h4 data-number="3.2.1" class="anchored" data-anchor-id="はじめに-1"><span class="header-section-number">3.2.1</span> はじめに</h4>
<p>ロジスティックモデルは１次元の潜在空間を持つ <a href="../../../posts/2024/Survey/BDA2.html#sec-latent-variable">選択モデルと見ることができる</a>．</p>
<p>これをさらに精緻化し，価値関数や効用関数などを通じてアクターの意思決定と行動をより詳細にモデリングすることも考え得る．</p>
<p>このようなモデルはミクロ計量経済学で歴史的に考えられたほか，政治科学における <a href="../../../posts/2024/TransDimensionalModels/IdealPoint.html#sec-Clinton">理想点モデルはこのような選択モデルを通じて生まれた</a>．</p>
</section>
<section id="ロジットモデルになる場合" class="level4" data-number="3.2.2">
<h4 data-number="3.2.2" class="anchored" data-anchor-id="ロジットモデルになる場合"><span class="header-section-number">3.2.2</span> ロジットモデルになる場合</h4>
<p>個人 <img src="https://latex.codecogs.com/png.latex?i%5Cin%5BN%5D"> ごとのパラメータ <img src="https://latex.codecogs.com/png.latex?a_i,b_i,c_i"> が存在して， <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5BY_i=1%5D=%5Coperatorname%7BP%7D%5Ba_i%3Eb_i+c_iX_i%5D=%5Coperatorname%7BP%7D%5Cleft%5B%5Cfrac%7Ba_i-b_i%7D%7Bc_i%7D%3EX_i%5Cright%5D%0A"> によって意思決定が決まるとした場合，<img src="https://latex.codecogs.com/png.latex?d_i:=%5Cfrac%7Ba_i-b_i%7D%7Bc_i%7D"> と潜在変数 <img src="https://latex.codecogs.com/png.latex?x_i"> との大小によって応答が変わると要約できる．</p>
<p>すると <img src="https://latex.codecogs.com/png.latex?d_i"> の分布関数 <img src="https://latex.codecogs.com/png.latex?F_i"> がロジスティックであるか正規分布であるか <img src="https://latex.codecogs.com/png.latex?t">-分布であるかに依って，ロジスティック回帰・プロビット回帰・ロビット回帰というモデルが得られる．</p>
</section>
<section id="tobit-モデル" class="level4" data-number="3.2.3">
<h4 data-number="3.2.3" class="anchored" data-anchor-id="tobit-モデル"><span class="header-section-number">3.2.3</span> Tobit モデル</h4>
<p>さらに <img src="https://latex.codecogs.com/png.latex?y_i"> の観測値が <img src="https://latex.codecogs.com/png.latex?x_i"> の値に依存するというモデルが <span class="citation" data-cites="Tobin58-Tobit">(Tobin, 1958)</span> によって提案されている： <img src="https://latex.codecogs.com/png.latex?%0AY=Y%5E*%5Clor0.%0A"> <img src="https://latex.codecogs.com/png.latex?%0AY%5E*_i=%5Cbeta%20X_i+%5Cepsilon_i,%0A"></p>
<p>このモデルは（１型）トービットモデルの他に，<strong>打ち切り回帰</strong> (censored regression) とも呼ばれる．</p>
<p>ある閾値を超えた場合にプライバシーの問題で公開を制限する top-coding データなどに用いられる．</p>
</section>
<section id="heckman-モデル" class="level4" data-number="3.2.4">
<h4 data-number="3.2.4" class="anchored" data-anchor-id="heckman-モデル"><span class="header-section-number">3.2.4</span> Heckman モデル</h4>
<p><span class="citation" data-cites="Heckman79-SelectionBias-as-SpecificationError">(Heckman, 1979)</span> は標本に入るかどうかのメカニズムをモデリングする，選択バイアスのためのモデル <img src="https://latex.codecogs.com/png.latex?%0AY=%5Cbegin%7Bcases%7DY%5E*&amp;S=1%5C%5C%5Ctext%7Bmissing%7D&amp;S=0%5Cend%7Bcases%7D%0A"> <img src="https://latex.codecogs.com/png.latex?%0AY%5E*=%5Cbeta%20X+%5Cepsilon,%0A"> <img src="https://latex.codecogs.com/png.latex?%0AS=1_%7B%5Cmathbb%7BR%7D_+%7D(S%5E*),%5Cqquad%20S%5E*=%5Cgamma%20Z+%5Ceta.%0A"> を提案した．これは２型トービットモデルとも呼ばれる．</p>
<p>そしてこの共分散構造 <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bpmatrix%7D%5Cepsilon%5C%5C%5Ceta%5Cend%7Bpmatrix%7D%5Csim%5Coperatorname%7BN%7D%5Cbiggr(0,%5Cbegin%7Bpmatrix%7D%5Csigma%5E2_%5Cepsilon&amp;%5Csigma_%7B%5Cepsilon%5Ceta%7D%5C%5C%5Csigma_%7B%5Cepsilon%5Ceta%7D&amp;1%5Cend%7Bpmatrix%7D%5Cbiggl)%0A"> を局外母数として <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> を一致推定する．</p>
</section>
</section>
</section>



<div id="quarto-appendix" class="default"><section id="文献紹介" class="level2 appendix" data-number="4"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">4</span> 文献紹介</h2><div class="quarto-appendix-contents">

<p><span class="citation" data-cites="Gelman-Hill2006">(12 章 Gelman and Hill, 2006)</span> が筆者の知る限り最も丁寧な階層モデルへの導入である．</p>
<p>変動係数モデルに関して <span class="citation" data-cites="菅澤-久保川2023">(Sugasawa and Kubokawa, 2023)</span> が極めて見通しが良い．小地域推定を主なテーマとしている．</p>
<p>項目応答モデルと理想点モデルは <span class="citation" data-cites="Gelman-Hill2006">(14.3 Gelman and Hill, 2006)</span> において一般化線型階層モデルの文脈で扱われている．</p>
<p>選択モデルは <span class="citation" data-cites="Hansen2022">(27 章 Hansen, 2022)</span> を参照．</p>




</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Bafumi+2005" class="csl-entry">
Bafumi, J., Gelman, A., Park, D. K., and Kaplan, N. (2005). <a href="https://doi.org/10.1093/pan/mpi010"><span class="nocase">Practical Issues in Implementing and Understanding Bayesian Ideal Point Estimation</span></a>. <em>Political Analysis</em>, <em>13</em>(2), 171–187.
</div>
<div id="ref-Battese+1988" class="csl-entry">
Battese, G. E., Harter, R. M., and Fuller, W. A. (1988). <a href="https://doi.org/10.1080/01621459.1988.10478561">An error-components model for prediction of county crop areas using survey and satellite data</a>. <em>Journal of the American Statistical Association</em>, <em>83</em>(401), 28–36.
</div>
<div id="ref-Carlin+2001" class="csl-entry">
Carlin, J. B., Wolfe, R., Brown, C. H., and Gelman, A. (2001). <a href="https://doi.org/10.1093/biostatistics/2.4.397">A case study on the choice, interpretation and checking of multilevel models for longitudinal binary outcomes</a>. <em>Biostatistics</em>, <em>2</em>(4), 397–416.
</div>
<div id="ref-Fay-Herriot1979" class="csl-entry">
Fay, R. E., and Herriot, R. A. (1979). <a href="http://www.jstor.org/stable/2286322">Estimates of income for small places: An application of james-stein procedures to census data</a>. <em>Journal of the American Statistical Association</em>, <em>74</em>(366), 269–277.
</div>
<div id="ref-Fox2010" class="csl-entry">
Fox, J.-P. (2010). <em><a href="https://doi.org/10.1007/978-1-4419-0742-4"><span>Bayesian Item Response Modeling</span></a></em>. Springer New York.
</div>
<div id="ref-Gelman2005" class="csl-entry">
Gelman, A. (2005). <a href="https://doi.org/10.1214/009053604000001048"><span class="nocase">Analysis of variance—why it is more important than ever</span></a>. <em>The Annals of Statistics</em>, <em>33</em>(1), 1–53.
</div>
<div id="ref-Gelman-Hill2006" class="csl-entry">
Gelman, A., and Hill, J. (2006). <em><a href=" https://doi.org/10.1017/CBO9780511790942">Data analysis using regression and multilevel/hierarchical models</a></em>. Cambridge University Press.
</div>
<div id="ref-Gelman-Hill-Vehtari2020" class="csl-entry">
Gelman, A., Hill, J., and Vehtari, A. (2020). <em><a href="https://avehtari.github.io/ROS-Examples/">Regression and other stories</a></em>. Cambridge University Press.
</div>
<div id="ref-Hansen2022" class="csl-entry">
Hansen, B. E. (2022). <em>Econometrics</em>. Princeton University Press.
</div>
<div id="ref-Heckman79-SelectionBias-as-SpecificationError" class="csl-entry">
Heckman, J. J. (1979). Sample selection bias as a specification error. <em>Econometrica</em>, <em>47</em>(1), 153–161.
</div>
<div id="ref-Henderson1950" class="csl-entry">
Henderson, C. R. (1950). <a href="https://www.jstor.org/stable/2236913">Estimation of genetic parameters</a>. <em>The Annals of Mathematical Statistics</em>, <em>21</em>(2), 302–315.
</div>
<div id="ref-Lindley-Smith1972" class="csl-entry">
Lindley, D. V., and Smith, A. F. M. (1972). <a href="http://www.jstor.org/stable/2985048">Bayes estimates for the linear model</a>. <em>Journal of the Royal Statistical Society. Series B (Methodological)</em>, <em>34</em>(1), 1–41.
</div>
<div id="ref-Rasch1960" class="csl-entry">
Rasch, G. W. (1960). <em><a href="">Studies in mathematical psychology: I. Probabilistic models for some intelligence and attainment tests</a></em>. Nielsen &amp; Lydiche.
</div>
<div id="ref-菅澤-久保川2023" class="csl-entry">
Sugasawa, S., and Kubokawa, T. (2023). <em><a href="https://doi.org/10.1007/978-981-19-9486-9">Mixed-effects models and small area estimation</a></em>. Springer Singapore.
</div>
<div id="ref-Tobin58-Tobit" class="csl-entry">
Tobin, J. (1958). Estimation of relationships for limited dependent variables. <em>Econometrica</em>, <em>26</em>(1), 24–36.
</div>
<div id="ref-久保川達也2006" class="csl-entry">
久保川達也. (2006). <a href="https://doi.org/10.5023/jappstat.35.139">線形混合モデルと小地域の推定</a>. <em>応用統計学</em>, <em>35</em>(3), 139–161.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><span class="citation" data-cites="Gelman-Hill2006">(11.5 節 Gelman and Hill, 2006, p. 246)</span> も参照．↩︎</p></li>
<li id="fn2"><p>一般に階層モデルは，全ての説明変数を組み込んだモデルから，特定の係数の部分集合を括り出し，その部分集合に super-population model を仮定したものと見れる．<span class="citation" data-cites="Gelman-Hill2006">(13.6 節 Gelman and Hill, 2006, p. 296)</span> の議論も参照．↩︎</p></li>
<li id="fn3"><p>例えば小地域推定においては極めて自然なモデルである <span class="citation" data-cites="久保川達也2006">(久保川達也, 2006)</span>, <span class="citation" data-cites="菅澤-久保川2023">(Sugasawa and Kubokawa, 2023)</span> も参照．↩︎</p></li>
<li id="fn4"><p>この点については <span class="citation" data-cites="Gelman-Hill2006">(11.6 節 Gelman and Hill, 2006, p. 248)</span>，<span class="citation" data-cites="Carlin+2001">(Carlin et al., 2001)</span> などを参照．↩︎</p></li>
<li id="fn5"><p>この第二階層の構造を <img src="https://latex.codecogs.com/png.latex?%5Calpha_j%5Csim%5Coperatorname%7BN%7D(%5Cmu_%5Calpha,%5Csigma%5E2_%5Calpha)"> という事前分布とみて，この未知パラメータの推定から始める点推定法を経験ベイズという <span class="citation" data-cites="菅澤-久保川2023">(Sugasawa and Kubokawa, 2023, pp. 11–12)</span>．↩︎</p></li>
<li id="fn6"><p><span class="citation" data-cites="菅澤-久保川2023">(Sugasawa and Kubokawa, 2023)</span> では，<img src="https://latex.codecogs.com/png.latex?%5Cbeta"> が <img src="https://latex.codecogs.com/png.latex?j%5Bi%5D%5Cin%5BJ%5D"> 毎に異なるとき，これを変量係数モデルと呼んでいる．ここでは <span class="citation" data-cites="Gelman2005">(Gelman, 2005)</span> などに倣って，全てまとめて変動係数 (varying coefficient) モデルと呼ぶことにする．↩︎</p></li>
<li id="fn7"><p><span class="citation" data-cites="菅澤-久保川2023">(Sugasawa and Kubokawa, 2023, p. 10)</span> に GLS 推定量が BLUE であることの証明がある．変量効果推定量については <span class="citation" data-cites="Hansen2022">(17.6 Hansen, 2022, pp. 601–603)</span> を参照した．↩︎</p></li>
<li id="fn8"><p>正規性の仮定の下では一般に経験ベイズ推定量と一致することが <span class="citation" data-cites="菅澤-久保川2023">(Sugasawa and Kubokawa, 2023, pp. 11–12)</span> で示されている．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Bayesian</category>
  <category>Statistics</category>
  <guid>https://162348.github.io/posts/2024/Survey/BDA3.html</guid>
  <pubDate>Thu, 12 Dec 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>brms を用いたベイズロジスティック回帰分析</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Survey/BayesGLM.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="はじめに" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">1</span> はじめに</h2>
<p>多くの社会的なデータは非数値的である．しかしその背後には潜在的な連続変数を想定することが多い．</p>
<p>加えて，線型回帰分析の結果複雑な非線型関係が予期された際，本格的なノンパラメトリック推論に移る前に，離散変数の設定に換言して非線型性を扱いやすくするなど，離散変数を扱う積極的理由もある．</p>
<p>本稿ではロジスティック回帰を主に扱う．</p>
<div id="listing-lst-survey" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1735430400000" data-listing-reading-time-sort="2" data-listing-word-count-sort="382">
<a href="../../../posts/2024/Survey/BDA2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析６
</h5>
<div class="card-subtitle listing-subtitle">
応答が質的変数の場合
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1733788800000" data-listing-file-modified-sort="1754014117005" data-listing-date-modified-sort="1733961600000" data-listing-reading-time-sort="5" data-listing-word-count-sort="945">
<a href="../../../posts/2024/Survey/BayesRegression.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/elpd.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> を用いたベイズ重回帰分析
</h5>
<div class="card-subtitle listing-subtitle">
BMI データを題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-10
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUiUyQ1N0YW4=" data-listing-date-sort="1734134400000" data-listing-file-modified-sort="1754014116643" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="7" data-listing-word-count-sort="1355">
<a href="../../../posts/2024/Survey/BayesGLMM.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/DIF.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> を用いたベイズ混合ロジスティック回帰分析
</h5>
<div class="card-subtitle listing-subtitle">
項目応答モデルと特異項目機能を題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-14
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="多項ロジスティック回帰" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="多項ロジスティック回帰"><span class="header-section-number">2</span> 多項ロジスティック回帰</h2>
<section id="はじめに-1" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="はじめに-1"><span class="header-section-number">2.1</span> はじめに</h3>
<p>ここでは BMI と LDL コレステロールの関係を見る．</p>
<section id="bmi-と-ldl-の関係" class="level4" data-number="2.1.1">
<h4 data-number="2.1.1" class="anchored" data-anchor-id="bmi-と-ldl-の関係"><span class="header-section-number">2.1.1</span> BMI と LDL の関係</h4>
<p>一般に HDL コレステロールは BMI と正の相関がある（特に<a href="https://ja.wikipedia.org/wiki/2型糖尿病">２型糖尿病</a>患者では <span class="citation" data-cites="Hussai+2019">(Hussain et al., 2019)</span>）．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI, raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>HDL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.3689261</code></pre>
</div>
</div>
<p>一方で LDL コレステロールと BMI の相関は弱い：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI, raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LDL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.158966</code></pre>
</div>
</div>
<p>しかし全く無関係ではないように見える：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">boxplot</span>(</span>
<span id="cb5-2">  raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LDL <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>obesity,</span>
<span id="cb5-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pink"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgreen"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"skyblue"</span>),</span>
<span id="cb5-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LDL classified by BMI"</span>,</span>
<span id="cb5-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BMI"</span>,</span>
<span id="cb5-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LDL"</span></span>
<span id="cb5-7">)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>これは LDL と BMI の関係は非線型性が高く，その非線型関係が男女，さらに年齢で違うためかもしれない <span class="citation" data-cites="Li+2021">(Li et al., 2021)</span>．</p>
<p>この関係を詳しく見ていくことで何か発見があるかもしれないだろう．</p>
</section>
<section id="lab" class="level4" data-number="2.1.2">
<h4 data-number="2.1.2" class="anchored" data-anchor-id="lab"><span class="header-section-number">2.1.2</span> LAB</h4>
<p>LAB <span class="citation" data-cites="Inoue+2010">(Inoue et al., 2010)</span> は酸化変性した LDL のことで，別名超悪玉コレステロールと知られる．LDL コレステロールよりも動脈硬化リスクを（特に残余リスクとして）反映する新しいバイオマーカーになり得ると期待されている <span class="citation" data-cites="Okamura+2013">(Okamura et al., 2013)</span>．</p>
<p>LAB と LDL の相関は高くない：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI, raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1952133</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">boxplot</span>(</span>
<span id="cb8-2">  raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>obesity,</span>
<span id="cb8-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pink"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"skyblue"</span>),</span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB classified by BMI"</span>,</span>
<span id="cb8-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BMI"</span>,</span>
<span id="cb8-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span></span>
<span id="cb8-7">)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>ここでは LAB と LDL の BMI への影響を比較したい．</p>
</section>
<section id="bmi-の離散化" class="level4" data-number="2.1.3">
<h4 data-number="2.1.3" class="anchored" data-anchor-id="bmi-の離散化"><span class="header-section-number">2.1.3</span> BMI の離散化</h4>
<p>BMI と LDL の関数関係は非線型性が予期される <span class="citation" data-cites="Li+2021">(Li et al., 2021)</span>．</p>
<p>そこで BMI を直接被説明変数とするのではなく，離散化した順序変数 <code>obesity</code> を導入する：</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">raw_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obesity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb9-3">  BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">18.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># underweight</span></span>
<span id="cb9-4">  BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normal</span></span>
<span id="cb9-5">  BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># obese</span></span>
<span id="cb9-6">  ))</span></code></pre></div>
</section>
</section>
<section id="ldl-の予測力" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="ldl-の予測力"><span class="header-section-number">2.2</span> LDL の予測力</h3>
<p>LDL を直接用いて推定すると係数が極めて小さくなるため，対数変換によりスケールを変換して説明変数に入れる：</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5B%5Ctexttt%7Bobesity%7D%3E1%5D=g%5E%7B-1%7D(%5Cbeta_%7B%5Ctexttt%7BLDL%7D%7D%5Ccdot%5Clog(%5Ctexttt%7BLDL%7D)-c_1)%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5B%5Ctexttt%7Bobesity%7D%3E2%5D=g%5E%7B-1%7D(%5Cbeta_%7B%5Ctexttt%7BLDL%7D%7D%5Ccdot%5Clog(%5Ctexttt%7BLDL%7D)-c_2)%0A"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">formula_LDL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb10-2">  obesity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(LDL),</span>
<span id="cb10-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumulative</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb10-4">)</span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prior_LDL &lt;- prior(normal(0,0.1), class = b, coef = "logLDL")</span></span>
<span id="cb10-6">fit_LDL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb10-7">  formula_LDL,</span>
<span id="cb10-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb10-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  prior = prior_LDL</span></span>
<span id="cb10-11">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit_LDL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: cumulative 
  Links: mu = logit; disc = identity 
Formula: obesity ~ log(LDL) 
   Data: raw_df (Number of observations: 839) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept[1]     2.05      1.26    -0.42     4.52 1.00     2671     2228
Intercept[2]     5.62      1.27     3.12     8.12 1.00     2606     2280
logLDL           0.97      0.27     0.46     1.50 1.00     2622     2226

Further Distributional Parameters:
     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
disc     1.00      0.00     1.00     1.00   NA       NA       NA

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>LDL が上がるごとに，<code>normal</code> や <code>underweight</code> から <code>obese</code> に移る確率が上がるのが見える．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conditional_effects</span>(fit_LDL, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LDL"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">categorical =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior_summary</span>(fit_LDL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior     class   coef group resp dpar nlpar lb ub       source
               (flat)         b                                         default
               (flat)         b logLDL                             (vectorized)
 student_t(3, 0, 2.5) Intercept                                         default
 student_t(3, 0, 2.5) Intercept      1                             (vectorized)
 student_t(3, 0, 2.5) Intercept      2                             (vectorized)</code></pre>
</div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?c_1,c_2"> には <img src="https://latex.codecogs.com/png.latex?0"> を中心とした <img src="https://latex.codecogs.com/png.latex?t">-事前分布が置かれているため，識別性は保たれると考えて良い．</p>
</section>
<section id="lab-との比較" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="lab-との比較"><span class="header-section-number">2.3</span> LAB との比較</h3>
<p>実は LDL よりも LAB の方が少し予測力が高い．しかも LAB は <img src="https://latex.codecogs.com/png.latex?%5B1,10%5D"> に値を取るので，対数変換をするよりも平方根変換をする方が自然である：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">formula_LAB <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb16-2">  obesity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(LAB),</span>
<span id="cb16-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumulative</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb16-4">)</span>
<span id="cb16-5">fit_LAB <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb16-6">  formula_LAB,</span>
<span id="cb16-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb16-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb16-9">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit_LDL), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit_LAB))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        elpd_diff se_diff
fit_LAB  0.0       0.0   
fit_LDL -2.2       3.9   </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conditional_effects</span>(fit_LAB, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">categorical =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>LAB が上昇すると <code>underweight</code>, <code>normal</code> から <code>obese</code> に移る確率がグンと上がるのが見える．</p>
</section>
<section id="双方の採用" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="双方の採用"><span class="header-section-number">2.4</span> 双方の採用</h3>
<p>前節で <code>LAB</code> と <code>LDL</code> を比較すると，前者のみを用いたモデルの方が予測力が高いことを見た．</p>
<p>では両方をモデルに入れてベイズ推論をすることで，２つの情報を統合したより良いモデルができるだろうか？</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">df_double <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb20-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obesity =</span> raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>obesity,</span>
<span id="cb20-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z_sqrt_LAB =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB)),</span>
<span id="cb20-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z_log_LDL =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LDL))</span>
<span id="cb20-5">)</span>
<span id="cb20-6">formula_double <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb20-7">  obesity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> z_sqrt_LAB <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z_log_LDL,</span>
<span id="cb20-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumulative</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb20-9">)</span>
<span id="cb20-10">fit_double <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb20-11">  formula_double,</span>
<span id="cb20-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df_double,</span>
<span id="cb20-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb20-14">)</span></code></pre></div>
</div>
<p>実際予測性能の面では両方入れたモデルの方が良いようである：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit_LAB), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit_double))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           elpd_diff se_diff
fit_double  0.0       0.0   
fit_LAB    -0.3       1.7   </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit_double, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_z_sqrt_LAB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_z_log_LDL"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>LDL の方が僅かに縮小されて推定されていることがわかる．</p>
<p>さらには <code>LAB</code> と <code>LDL</code> がモデルに入っている確率を出す方法は別稿で追求する：</p>
<div id="listing-lst-embedding" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1733788800000" data-listing-file-modified-sort="1754014117262" data-listing-date-modified-sort="1735948800000" data-listing-reading-time-sort="4" data-listing-word-count-sort="723">
<a href="../../../posts/2024/TransDimensionalModels/BayesSelection.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-embedding:posts/2024/TransDimensionalModels/BayesSelection.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズ変数選択
</h5>
<div class="card-subtitle listing-subtitle">
BMI データの重線型回帰を題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-10
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="交絡の存在" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="交絡の存在"><span class="header-section-number">2.5</span> 交絡の存在</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">formula_double_confound <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb24-2">  obesity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> z_sqrt_LAB <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z_log_LDL,</span>
<span id="cb24-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumulative</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb24-4">)</span>
<span id="cb24-5">fit_double_confound <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb24-6">  formula_double_confound,</span>
<span id="cb24-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df_double,</span>
<span id="cb24-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb24-9">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit_double_confound, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_z_sqrt_LAB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_z_log_LDL"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_z_sqrt_LAB:z_log_LDL"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>若干の交絡の存在が疑われる．LDL が大きいほど，LAB と BMI との関係は減少していき，逆もまた然りである．</p>
<p>これは共線型性が強いので当然とも思われる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(df_double<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>z_sqrt_LAB, df_double<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>z_log_LDL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5204453</code></pre>
</div>
</div>
<p>しかし必ずしも条件数が大きいわけではない．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> z_sqrt_LAB <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z_log_LDL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df_double)</span>
<span id="cb28-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kappa</span>(X)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.879479</code></pre>
</div>
</div>
</section>
<section id="名目モデルを使ってしまったら" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="名目モデルを使ってしまったら"><span class="header-section-number">2.6</span> 名目モデルを使ってしまったら？</h3>
<p><code>underweight</code>, <code>normal</code>, <code>obese</code> 間の順序構造を無視して，カテゴリカル分布を通じてモデリングをしても，実は当てはまりは必ずしも悪くない．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">formula_nominal <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb30-2">  obesity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> LAB,</span>
<span id="cb30-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categorical</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb30-4">)</span>
<span id="cb30-5">fit_nominal <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb30-6">  formula_nominal,</span>
<span id="cb30-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb30-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb30-9">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">waic</span>(fit_LAB)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 839 log-likelihood matrix.

          Estimate   SE
elpd_waic   -686.0 18.5
p_waic         2.8  0.1
waic        1372.0 37.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">waic</span>(fit_nominal)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 839 log-likelihood matrix.

          Estimate   SE
elpd_waic   -685.8 18.6
p_waic         3.7  0.2
waic        1371.6 37.2</code></pre>
</div>
</div>
<p>ほとんど質的には一致した結果を得る：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conditional_effects</span>(fit_nominal, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">categorical =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>ひょっとしたら，BMI を離散化したという点で順序変数に思えるかもしれないが，これは単なる思い込みで，「痩せている」ことと「太っている」ことに順序関係を仮定することはむしろノイズになっているのかもしれない．</p>
<!-- 


::: {.cell}

```{.r .cell-code}
p1_ppc <- pp_check(fit_nominal, ndraws = 100)
p2_ppc <- pp_check(fit_LAB, ndraws = 100)
grid.arrange(p1_ppc, p2_ppc, nrow = 1)
```

::: {.cell-output-display}
![](BayesGLM_files/figure-html/unnamed-chunk-24-1.png){width=672}
:::
:::


-->
</section>
<section id="非線型関係の追求" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="非線型関係の追求"><span class="header-section-number">2.7</span> 非線型関係の追求</h3>
<div id="listing-lst-embedding-nonlinear" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1734307200000" data-listing-file-modified-sort="1754014117005" data-listing-date-modified-sort="1734307200000" data-listing-reading-time-sort="1" data-listing-word-count-sort="32">
<a href="../../../posts/2024/Survey/BayesNonparametrics.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-embedding-nonlinear:posts/2024/Survey/BayesNonparametrics.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> を用いたノンパラメトリック回帰分析
</h5>
<div class="card-subtitle listing-subtitle">
BMI データを題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-16
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="共変量の追加と効果の観察" class="level3" data-number="2.8">
<h3 data-number="2.8" class="anchored" data-anchor-id="共変量の追加と効果の観察"><span class="header-section-number">2.8</span> 共変量の追加と効果の観察</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sqrt_LAB <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB)</span>
<span id="cb36-2">raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>log_Age <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Age)</span>
<span id="cb36-3">formula_LAB_cov <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb36-4">  obesity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> log_Age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> SEX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> log_Age<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>SEX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> SEX <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> sqrt_LAB),</span>
<span id="cb36-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categorical</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb36-6">)</span>
<span id="cb36-7">fit_LAB_cov <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb36-8">  formula_LAB_cov,</span>
<span id="cb36-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb36-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb36-11">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit_LAB_cov)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: categorical 
  Links: mu2 = logit; mu3 = logit 
Formula: obesity ~ log_Age + SEX + log_Age:SEX + (0 + SEX | sqrt_LAB) 
   Data: raw_df (Number of observations: 839) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~sqrt_LAB (Number of levels: 56) 
                               Estimate Est.Error l-95% CI u-95% CI Rhat
sd(mu2_SEXfemale)                  0.20      0.14     0.01     0.54 1.00
sd(mu2_SEXmale)                    0.20      0.14     0.01     0.53 1.00
sd(mu3_SEXfemale)                  0.48      0.23     0.05     0.94 1.01
sd(mu3_SEXmale)                    0.28      0.19     0.01     0.70 1.00
cor(mu2_SEXfemale,mu2_SEXmale)    -0.12      0.57    -0.97     0.92 1.00
cor(mu3_SEXfemale,mu3_SEXmale)    -0.10      0.54    -0.96     0.90 1.00
                               Bulk_ESS Tail_ESS
sd(mu2_SEXfemale)                  1288     1735
sd(mu2_SEXmale)                    1118     1308
sd(mu3_SEXfemale)                   792      963
sd(mu3_SEXmale)                    1027     1614
cor(mu2_SEXfemale,mu2_SEXmale)     2097     2182
cor(mu3_SEXfemale,mu3_SEXmale)     1638     1708

Regression Coefficients:
                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
mu2_Intercept          -4.06      1.92    -7.89    -0.26 1.00     2108     2674
mu3_Intercept          -6.39      2.35   -11.05    -1.71 1.00     2049     2334
mu2_log_Age             1.55      0.50     0.55     2.56 1.00     2069     2656
mu2_SEXmale            12.79      5.40     2.66    24.16 1.00      994     1566
mu2_log_Age:SEXmale    -2.98      1.34    -5.79    -0.43 1.00     1004     1534
mu3_log_Age             1.81      0.61     0.63     3.02 1.00     2028     2315
mu3_SEXmale            14.91      5.62     4.64    26.55 1.00      933     1490
mu3_log_Age:SEXmale    -3.31      1.40    -6.16    -0.73 1.00      945     1525

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conditional_effects</span>(fit_LAB_cov, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SEX"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">categorical =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>一般に男性の方が太っている確率が高くなる．これはよく知られているようである．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conditional_effects</span>(fit_LAB_cov, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_Age"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conditions =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">SEX =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"male"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">categorical =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">conditional_effects</span>(fit_LAB_cov, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log_Age"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conditions =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">SEX =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"female"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">categorical =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-28-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>女性は年齢とともに太る傾向が見えるが，男性はそうでもない（むしろ逆である）ようである．</p>
<p>そして共変量を追加したことでモデルの予測力が大きく良くなっている：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit_LAB), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit_LAB_cov))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Not all models have the same y variable. ('yhash' attributes do not
match)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            elpd_diff se_diff
fit_LAB_cov   0.0       0.0  
fit_LAB     -11.2       8.1  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pp_check</span>(fit_LAB_cov)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using 10 posterior draws for ppc type 'dens_overlay' by default.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesGLM_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="その他の共変量の探索" class="level3" data-number="2.9">
<h3 data-number="2.9" class="anchored" data-anchor-id="その他の共変量の探索"><span class="header-section-number">2.9</span> その他の共変量の探索</h3>
<p>BMI と LDL は，骨ミネラル密度 (BMD: Bone Mineral Density) に因果的な影響を与えることが知られている <span class="citation" data-cites="Wu+2024">(Wu, 2024)</span>．</p>
<p><code>P1NP</code> は骨形成マーカー，<code>ALP</code> は骨の形成や骨疾患の評価に役立つ酵素である．</p>
<p><code>deoxypyridinolin</code> (DPD) は骨を構成するⅠ型コラーゲンを束ねる蛋白質で、骨吸収の指標になる．</p>
<p>他に <code>Ca</code>, <code>Mg</code> などの値もある．</p>
</section>
</section>
<section id="階層ロジットモデル" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="階層ロジットモデル"><span class="header-section-number">3</span> 階層ロジットモデル</h2>
<section id="はじめに-2" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="はじめに-2"><span class="header-section-number">3.1</span> はじめに</h3>
<p>データの不均衡性に着想を得て，「太っているかいないか？」の後に「痩せ気味かどうか？」という２つのロジット回帰の連続とみることを考える．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1">raw_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb47-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obesity_former =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb47-3">  BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normal</span></span>
<span id="cb47-4">  BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># obese</span></span>
<span id="cb47-5">  ))</span>
<span id="cb47-6">raw_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb47-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obesity_latter =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb47-8">  BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">18.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># underweight</span></span>
<span id="cb47-9">  BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">18.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normal</span></span>
<span id="cb47-10">  ))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1">formula_former <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb48-2">  obesity_former <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> LAB,</span>
<span id="cb48-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bernoulli</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb48-4">)</span>
<span id="cb48-5">fit_former <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb48-6">  formula_former,</span>
<span id="cb48-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb48-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb48-9">)</span>
<span id="cb48-10">formula_latter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb48-11">  obesity_latter <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> LAB,</span>
<span id="cb48-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bernoulli</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>)</span>
<span id="cb48-13">)</span>
<span id="cb48-14">fit_latter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb48-15">  formula_latter,</span>
<span id="cb48-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb48-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb48-18">)</span></code></pre></div>
</div>




</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Hussai+2019" class="csl-entry">
Hussain, A., Ali, iftikhar, Kaleem, W. A., and Yasmeen, F. (2019). <a href="https://doi.org/10.12669/pjms.35.3.7">Correlation between body mass index and lipid profile in patients with type 2 diabetes attending a tertiary care hospital in peshawar: Correlation between BMI &amp;amp; lipid profile in patients with T2DM</a>. <em>Pakistan Journal of Medical Sciences</em>, <em>35</em>(3).
</div>
<div id="ref-Inoue+2010" class="csl-entry">
Inoue, N., Okamura, T., Kokubo, Y., Fujita, Y., Sato, Y., Nakanishi, M., … Sawamura, T. (2010). <a href="https://doi.org/10.1373/clinchem.2009.140707">LOX index, a novel predictive biochemical marker for coronary heart disease and stroke</a>. <em>Clinical Chemistry</em>, <em>56</em>(4), 550–558.
</div>
<div id="ref-Li+2021" class="csl-entry">
Li, H., Ma, J., Zheng, D., Li, X., Guo, X., Wang, J., and Su, P. (2021). <a href="https://doi.org/10.1186/s12944-021-01591-w">Sex differences in the non-linear association between BMI and LDL cholesterol in middle-aged and older adults: Findings from two nationally representative surveys in china</a>. <em>Lipids in Health and Disease</em>, <em>20</em>(1), 162.
</div>
<div id="ref-Okamura+2013" class="csl-entry">
Okamura, T., Sekikawa, A., Sawamura, T., Kadowaki, T., Barinas-Mitchell, E., Mackey, R. H., … Ueshima, H. (2013). <a href="https://doi.org/10.1016/j.atherosclerosis.2013.04.023">LOX-1 ligands containing apolipoprotein b and carotid intima-media thickness in middle-aged community-dwelling US caucasian and&amp;<span>#</span>xa0;japanese men</a>. <em>Atherosclerosis</em>, <em>229</em>(1), 240–245. doi: 10.1016/j.atherosclerosis.2013.04.023.
</div>
<div id="ref-Wu+2024" class="csl-entry">
Wu, W. A. C., Yuxiang AND Ma. (2024). <a href="https://doi.org/10.1371/journal.pone.0298610">Causal relationships between body mass index, low-density lipoprotein and bone mineral density: Univariable and multivariable mendelian randomization</a>. <em>PLOS ONE</em>, <em>19</em>(6), 1–14.
</div>
</div></section></div> ]]></description>
  <category>Bayesian</category>
  <category>Statistics</category>
  <category>R</category>
  <category>Stan</category>
  <guid>https://162348.github.io/posts/2024/Survey/BayesGLM.html</guid>
  <pubDate>Thu, 12 Dec 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>変量効果と固定効果</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Lifestyle/FixedRandom.html</link>
  <description><![CDATA[ 





<section id="概要" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="概要"><span class="header-section-number">1</span> 概要</h2>
<p>階層モデル <span id="eq-model1"><img src="https://latex.codecogs.com/png.latex?%0Ay_%7Bij%7D=%5Ctheta_j+%5Cepsilon_%7Bij%7D%0A%5Ctag%7B1%7D"></span> <span id="eq-model2"><img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta_j=%5Cmu+%5Cgamma_j%0A%5Ctag%7B2%7D"></span> を考える．<img src="https://latex.codecogs.com/png.latex?j%5Cin%5BJ%5D"> がグループ，<img src="https://latex.codecogs.com/png.latex?i%5Cin%5Bn_j%5D"> はそのグループに所属する単位とする．層別・クラスター抽出された標本，パネルデータなど，好きなように解釈してほしい．</p>
<p>(1), (2) を階層モデルと呼ぶ理由は，(1) で <img src="https://latex.codecogs.com/png.latex?y_%7Bij%7D"> が最小単位として回帰されているのと同時に，(2) でグループごとの変数 <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> にもモデルが設定されているためである．個人単位とグループ単位の２つの階層で回帰モデルが設定されているために <strong>階層モデル</strong> という．</p>
<p>(1) は他の個人レベル説明変数を含んでいても良い <span id="eq-model3"><img src="https://latex.codecogs.com/png.latex?%0Ay_%7Bij%7D=x_%7Bij%7D%5E%5Ctop%5Cbeta+%5Ctheta_j+%5Cepsilon_%7Bij%7D%0A%5Ctag%7B3%7D"></span> が，ここでは問題にしない．</p>
<p>本稿で問題にするのは，グループレベル変数 <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> に対する２つの扱い方：「変量効果」と「固定効果」の違いである．</p>
<p>この名称の違いが表すものとして，単にモデルの違いなのか，それともモデルは同じで単に推定方法の違いなのか，という点からすでに混乱が見られる．</p>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="筆者の結論">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
筆者の結論
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are only two ways to make sense of the terminology “fixed effects” and “random effects”:</p>
<ol type="1">
<li>Econometric manner:</li>
</ol>
<p>If <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> is not correlated with the vector of covariates <img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D">, then it is a random effect. Otherwise, it is a fixed effect. Random effects can be estimated via Generalized Least Squares (GLS).</p>
<ol start="2" type="1">
<li>Biostatic manner:</li>
</ol>
<p>If we assume a super-population model on <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j">, then it is a random effect. If we don’t assume any additional hierarchical structure on <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> (or just a flat prior), then it is a fixed effect.</p>
</div>
</div>
<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
</section>
<section id="サーベイ" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="サーベイ"><span class="header-section-number">2</span> サーベイ</h2>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li>計量経済学では，<img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D"> と <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> の相関の有無に関する仮定の違いと，これに起因する自然な後続の（最小自乗）推定法の違いである．</li>
</ul>
</div>
</div>
</div>
<section id="sec-econometrics" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="sec-econometrics"><span class="header-section-number">2.1</span> 計量経済学</h3>
<p><span class="citation" data-cites="Hansen2022">(Hansen, 2022)</span> を参照して，計量経済学で主流な固定効果と変量効果の違いの解釈を見る．</p>
<p><span class="citation" data-cites="Hansen2022">(17.7 Hansen, 2022, pp. 603–)</span> では，固定効果モデルは (3) のような他の説明変数 <img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D"> が存在する場合，<img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D"> と <img src="https://latex.codecogs.com/png.latex?u_%7Bi%7D"> の相関が危惧される際に使える「推定手法」（あるいは推定量の名前）として導入される．</p>
<blockquote class="blockquote">
<p>In the econometrics literature if the stochastic structure of <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> is treated as unknown and possibly correlated with <img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D"> then <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> is called a fixed effect. <span class="citation" data-cites="Hansen2022">(Hansen, 2022, p. 604)</span></p>
</blockquote>
<p>その推定手法とは，within transformation <img src="https://latex.codecogs.com/png.latex?%5Cdot%7B-%7D"> を <img src="https://latex.codecogs.com/png.latex?%0A%5Cdot%7By%7D_%7Bij%7D=y_%7Bij%7D-%5Coverline%7By%7D_j,%5Cqquad%5Coverline%7By%7D_j:=%5Cfrac%7B1%7D%7Bn_j%7D%5Csum_%7Bi=1%7D%5E%7Bn_j%7Dy_%7Bij%7D%0A"> と定めて，この変換をデータに適用してから回帰 <span id="eq-within"><img src="https://latex.codecogs.com/png.latex?%0A%5Cdot%7By%7D_%7Bij%7D=%5Cdot%7Bx%7D_%7Bij%7D%5E%5Ctop%5Cbeta+%5Cdot%7B%5Cepsilon%7D_%7Bij%7D%0A%5Ctag%7B4%7D"></span> を解く．この変換は <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> を消去するように出来ているため，<img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> の性質や <img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D"> との相関に依らずに係数 <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> を推定できるというのである．</p>
<p>一方で within transformation を施さずに直接 GLS 推定して得る推定量を変量効果推定量，OLS 推定して得る推定量を pooled OLS と呼ぶ <span class="citation" data-cites="Hansen2022">(17.6 Hansen, 2022, pp. 601–603)</span>．</p>
<p>多くの場合，変量効果モデル (3) では <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> と <img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D"> との無相関性の他に，誤差の均一性 <img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta_j%5Csim(0,%5Csigma%5E2_%5Ctheta)%0A"> も仮定されるため，同グループ内の残差に <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7BV%7D%5B%5Ctheta_j+%5Cepsilon_%7Bij%7D%5D=%5Cbegin%7Bpmatrix%7D%0A%5Csigma%5E2_%5Ctheta+%5Csigma%5E2_%5Cepsilon&amp;%5Csigma%5E2_%5Ctheta&amp;%5Ccdots&amp;%5Csigma%5E2_%5Ctheta%5C%5C%0A%5Csigma%5E2_%5Ctheta&amp;%5Csigma%5E2_%5Ctheta+%5Csigma%5E2_%5Cepsilon&amp;%5Ccdots&amp;%5Csigma%5E2_%5Ctheta%5C%5C%0A%5Cvdots&amp;%5Cvdots&amp;%5Cddots&amp;%5Cvdots%5C%5C%0A%5Csigma%5E2_%5Ctheta&amp;%5Csigma%5E2_%5Ctheta&amp;%5Ccdots&amp;%5Csigma%5E2_%5Ctheta+%5Csigma%5E2_%5Cepsilon%0A%5Cend%7Bpmatrix%7D%0A"> という共分散構造が仮定されていることになる．このような設定では GLS 推定量が BLUE を与える <span class="citation" data-cites="Hayashi2000">(Hayashi, 2000, p. 55)</span>．</p>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="筆者の結論">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
筆者の結論
</div>
</div>
<div class="callout-body-container callout-body">
<p>計量経済学で変量効果モデル・固定効果モデルと呼んだときは，<img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> と <img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D"> との相関の有無に関する仮定の違いで呼び分けている．</p>
<p>それぞれのモデルで自然な OLS 様推定量があり，「変量効果」「固定効果」という名称はそのまま推定手法の違いも指すようである（もはや仮定の違いから始まるワークフローの名前になっている）．</p>
</div>
</div>
</section>
<section id="sec-BDA" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="sec-BDA"><span class="header-section-number">2.2</span> Gelman の見解</h3>
<p>以上の違いをモデルの違いとして理解した場合，変動効果モデルは <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> に無相関性や等分散性を初めとするモデルをおいており，固定効果モデルはモデリングを放棄している，とも見れる．</p>
<p>Gelman もこのような観点に立っているものと思われる．</p>
<blockquote class="blockquote">
<p>The term fixed effects is used in contrast to random effects—but not in a consistent way! Fixed eﬀects are usually deﬁned as varying coeﬃcients that are not themselves modeled. <span class="citation" data-cites="Gelman-Hill2006">(Gelman and Hill, 2006, p. 245)</span></p>
</blockquote>
<p>これをよく理解するために，<img src="https://latex.codecogs.com/png.latex?0,1"> の指示変数（ダミー変数）からなる計画行列 <img src="https://latex.codecogs.com/png.latex?X"> を導入した (1) の別の定式化を考える： <span id="eq-dummy"><img src="https://latex.codecogs.com/png.latex?%0A%5Cboldsymbol%7By%7D=X%5Cboldsymbol%7B%5Ctheta%7D+%5Cboldsymbol%7B%5Cepsilon%7D%0A%5Ctag%7B5%7D"></span> <img src="https://latex.codecogs.com/png.latex?%0AX=%5Cbegin%7Bpmatrix%7D%0A%5Cboldsymbol%7B1%7D_%7Bn_1%7D&amp;O&amp;O&amp;O%5C%5C%0AO&amp;%5Cboldsymbol%7B1%7D_%7Bn_2%7D&amp;O&amp;O%5C%5C%0A%5Cvdots&amp;%5Cvdots&amp;%5Cddots&amp;%5Cvdots%5C%5C%0AO&amp;O&amp;O&amp;%5Cboldsymbol%7B1%7D_%7Bn_J%7D%0A%5Cend%7Bpmatrix%7D%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Cboldsymbol%7B%5Ctheta%7D=%5Cbegin%7Bpmatrix%7D%5Ctheta_1%5C%5C%5Cvdots%5C%5C%5Ctheta_J%5Cend%7Bpmatrix%7D,%5Cqquad%5Cleft.%5Cboldsymbol%7B1%7D_%7Bn_j%7D:=%5Cbegin%7Bpmatrix%7D1%5C%5C%5Cvdots%5C%5C1%5Cend%7Bpmatrix%7D%5Cright%5C%7Dn_j%0A"></p>
<p>これ以上何も考えず，(5) に対して OLS 推定を行うと，固定効果推定量と全く同じものが得られる <span class="citation" data-cites="Hansen2022">(定理 17.1 Hansen, 2022, p. 610)</span>．残差も同じである．</p>
<p>すると Gelman による次の固定効果モデルの定義は，最終的に得られる MAP 推定量としては，計量経済学の文脈 2.1 のものと一致することになる：</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="[15.2 節 @BDA p.383]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="citation" data-cites="BDA">(15.2 節 Gelman et al., 2014, p. 383)</span>
</div>
</div>
<div class="callout-body-container callout-body">
<p>独立な一様事前分布 <img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta_j%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7D%5Coperatorname%7BN%7D(%5Cmu,%5Cinfty)%0A"> を仮定した場合の <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> を <strong>固定効果</strong> と呼ぶ．</p>
<p>階層的なモデル <img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta_j=%5Cmu+%5Cgamma_j,%5Cqquad%5Cgamma_j%5Csim%5Coperatorname%7BN%7D(0,%5Csigma%5E2_%5Ctheta)%0A"> を仮定した場合の <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> を <strong>変量効果</strong> と呼ぶ．</p>
<p>２つが同居するモデルを <strong>混合効果モデル</strong> (mixed-effects model) という．</p>
</div>
</div>
<p>この語用法は，<img src="https://latex.codecogs.com/png.latex?%5Ctheta_j%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7D%5Coperatorname%7BN%7D(%5Cmu,%5Cinfty)"> の事前分布の下で MAP 推定した場合が，最尤推定量と一部の OLS 推定量と一致するため，計量経済学の文脈 2.1 のものと一致する．</p>
<p>それだけでなく変量効果モデルとは階層モデルであり，推定の際に縮小が働く．このような方法で推定されるモデルは疫学や生物統計学の分野でもよく使われてランダム効果モデルと呼ばれている（例えば <span class="citation" data-cites="Robinson1991">(Robinson, 1991)</span>, <span class="citation" data-cites="Solomon2005">(Solomon, 2005)</span>）ため，この語用法とも一致することになる．</p>
<p>以上の見解は <span class="citation" data-cites="Gelman2005">(Gelman, 2005, p. 20)</span> に端的に現れている：</p>
<blockquote class="blockquote">
<p>In the Bayesian framework, this definition implies that fixed effects <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> are estimated conditional on <img src="https://latex.codecogs.com/png.latex?%5Csigma_%5Ctheta=%5Cinfty"> and random effects <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j"> are estimated conditional on <img src="https://latex.codecogs.com/png.latex?%5Csigma_%5Ctheta"> from the posterior distribution. <span class="citation" data-cites="Gelman2005">(Gelman, 2005, p. 20)</span></p>
</blockquote>
</section>
<section id="fix-random-の名前の由来は" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="fix-random-の名前の由来は"><span class="header-section-number">2.3</span> ‘fix’, ‘random’ の名前の由来は？</h3>
<p>この生物統計学的な語用法は，必ずしも fixed effects と対置するわけではない．グループ <img src="https://latex.codecogs.com/png.latex?j%5Cin%5BJ%5D"> に依存せず一定の値を取るいわば普通の「係数」と「変動係数」があるだけである．</p>
<p>多くの場合，ランダム効果は局外母数であり，<img src="https://latex.codecogs.com/png.latex?%5Cbeta"> （多くの場合処置効果）の不偏推定が最大の目的である．計量経済学のように深刻な外生性が疑われる状況を扱うわけでもない．それゆえ階層モデルによる縮小推定が選好されるという背景もある．</p>
<p>一方で計量経済学では効率が落ちても外生性への頑健性が選好されることが多いようである．</p>
<p>すると次の語用法が出現し，‘fix’, ‘random’ の名前の由来も同時にうまく説明するように見える：</p>
<blockquote class="blockquote">
<p>Effects are ﬁxed if they are interesting in themselves or random if there is interest in the underlying population. <span class="citation" data-cites="Searle-Casella-McCulloch1992">(Searle et al., 1992, p. 7)</span></p>
</blockquote>
<p>だがこうするともはやモデルとしてどのような仮定の違いを表しているのかわからなくなり，専門用語というよりは日常用語である．</p>
<p>そこで <span class="citation" data-cites="Gelman2005">(Gelman, 2005, p. 21)</span> ではこの意味では別の用語を採用するとしている：</p>
<blockquote class="blockquote">
<p>We prefer to sidestep the overloaded terms “ﬁxed” and “random” with a cleaner distinction by simply renaming the terms. We deﬁne effects (or coefﬁcients) in a multilevel model as <em>constant</em> if they are identical for all groups in a population and <em>varying</em> if they are allowed to differ from group to group. <span class="citation" data-cites="Gelman2005">(Gelman, 2005, p. 21)</span></p>
</blockquote>
<!-- 

[@Gelman2005 p.20] と [@Gelman-Hill2006 p.245] では「固定効果」「変動効果」という名称のもう一つの意味として，$\theta_j$ が $y_{i_1j},y_{i_2j},\cdots$ の間で変動するか？という違いを指すこともあるとしている：

> Fixed effects are constant across individuals, and random effects vary. [@Gelman2005 p.20]

文字通りに取ると，$\theta_j$ が固定効果で，$\theta_j+\ep_{ij}$ をひとまとまりで見ると変動効果ということになる．

ここまで２つの見解を見てきたが，無事意味の通る統一的見解が得られそうである．しかし「固定」「変動」の名前の由来については全く謎のままである．

-->
</section>
<section id="その他のベイジアンの見解" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="その他のベイジアンの見解"><span class="header-section-number">2.4</span> その他のベイジアンの見解</h3>
<p><span class="citation" data-cites="Hoff2009">(Hoff, 2009, p. 147)</span> には次の記述がある：</p>
<blockquote class="blockquote">
<p>the <img src="https://latex.codecogs.com/png.latex?%5Ctheta_j">’s (or <img src="https://latex.codecogs.com/png.latex?%5Cgamma_j">’s) may be referred to as either “fixed effects” or “random effects” depending on how they are estimated.</p>
</blockquote>
<p>つまり推定手法の違いで呼び分けるとしている．</p>
<p>これを見ると，前節 2.2 の BDA が開陳しているような，（無理に）モデルの違いとして理解しようという立場はやや急進的であり，ここまでいくともはや「固定効果」「変量効果」という名称が意味を持たないとも思える．</p>
<p>実際 <span class="citation" data-cites="BDA">(Gelman et al., 2014, p. 383)</span> には次の注がある：</p>
<blockquote class="blockquote">
<p>The terms ‘fixed’ and ‘random’ come from the non-Bayesian statistical tradition and are somewhat confusing in a Bayesian context where all unknown parameters are treated as ‘random’ or, equivalently, as having ﬁxed but unknown values.</p>
</blockquote>
<p>ベイズの立場では潜在変数だろうがパラメータだろうが，未知である限り「固定」「変動」の区別はない，というのは正しいが，だとしたらこの名称は捨てるべきである．</p>
</section>
</section>
<section id="筆者の結論" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="筆者の結論"><span class="header-section-number">3</span> 筆者の結論</h2>
<p>筆者は基本的には BDA の見解 2.2 を採用し，「固定効果」と「変動効果」の違いは，係数にモデルを想定しているかどうかの違いと理解することにした．</p>
<p>「固定効果」と「変量効果」の語は（慣習を踏襲すべき場合を除いて）使わず，「変動係数」 (varying coefficient) と呼ぶつもりである．</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Gelman2005" class="csl-entry">
Gelman, A. (2005). <a href="https://doi.org/10.1214/009053604000001048"><span class="nocase">Analysis of variance—why it is more important than ever</span></a>. <em>The Annals of Statistics</em>, <em>33</em>(1), 1–53.
</div>
<div id="ref-BDA" class="csl-entry">
Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., and Rubin, D. B. (2014). <em><a href="http://www.stat.columbia.edu/~gelman/book/">Bayesian data analysis</a></em>. Boca Raton : CRC Press.
</div>
<div id="ref-Gelman-Hill2006" class="csl-entry">
Gelman, A., and Hill, J. (2006). <em><a href=" https://doi.org/10.1017/CBO9780511790942">Data analysis using regression and multilevel/hierarchical models</a></em>. Cambridge University Press.
</div>
<div id="ref-Hansen2022" class="csl-entry">
Hansen, B. E. (2022). <em>Econometrics</em>. Princeton University Press.
</div>
<div id="ref-Hayashi2000" class="csl-entry">
Hayashi, F. (2000). <em><a href="https://press.princeton.edu/books/ebook/9781400823833/econometrics-1">Econometrics</a></em>. Princeton University Press.
</div>
<div id="ref-Hoff2009" class="csl-entry">
Hoff, P. D. (2009). <em><a href="https://doi.org/10.1007/978-0-387-92407-6">A first course in bayesian statistical methods</a></em>. Springer New York.
</div>
<div id="ref-Robinson1991" class="csl-entry">
Robinson, G. K. (1991). <a href="https://doi.org/10.1214/ss/1177011926"><span class="nocase">That BLUP is a Good Thing: The Estimation of Random Effects</span></a>. <em>Statistical Science</em>, <em>6</em>(1), 15–32.
</div>
<div id="ref-Searle-Casella-McCulloch1992" class="csl-entry">
Searle, S. R., Csella, G., and McCulloch, C. E. (1992). <em><a href="https://onlinelibrary.wiley.com/doi/book/10.1002/9780470316856">Variance components</a></em>. John Wiley &amp; Sons.
</div>
<div id="ref-Solomon2005" class="csl-entry">
Solomon, P. J. (2005). <a href="https://doi.org/10.1002/0470011815.b2a09056">Variance components</a>. In <em>Encyclopedia of biostatistics</em>. John Wiley &amp; Sons, Ltd.
</div>
</div></section></div> ]]></description>
  <category>Opinion</category>
  <category>Statistics</category>
  <guid>https://162348.github.io/posts/2024/Lifestyle/FixedRandom.html</guid>
  <pubDate>Wed, 11 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Lifestyle/Files/Hierarchical.svg" medium="image" type="image/svg+xml"/>
</item>
<item>
  <title>ベイズ変数選択</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/TransDimensionalModels/BayesSelection.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="はじめに" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">1</span> はじめに</h2>
<section id="復習ベイズデータ解析の第一歩" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="復習ベイズデータ解析の第一歩"><span class="header-section-number">1.1</span> （復習）ベイズデータ解析の第一歩</h3>
<p>データの非線型変換も取り入れたベイズ線型重回帰分析は，多くの場合，データを理解するための最初の解析手法として選択される．</p>
<p>その方法を <code>brms</code> パッケージを用いて実践したのが次の記事である：</p>
<div id="listing-lst-embedding" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1733788800000" data-listing-file-modified-sort="1754014117005" data-listing-date-modified-sort="1733961600000" data-listing-reading-time-sort="5" data-listing-word-count-sort="945">
<a href="../../../posts/2024/Survey/BayesRegression.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/elpd.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> を用いたベイズ重回帰分析
</h5>
<div class="card-subtitle listing-subtitle">
BMI データを題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-10
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>前稿では BMI を LAB と LDL から予測する問題を，線型回帰モデルから始めた．</p>
<p>交差項を追加することで，LDL が違う群に対して LAB がどう変わるかの層別の違いを見ることができる．</p>
<p>事後予測分布によるモデルのチェックは残差プロットと同様に，極めて手軽かつ有力なモデル検証の方法である．</p>
<p>これにより関数関係の非線型性が疑われたため，被説明変数 BMI に対して対数変換を施して線型回帰をすると，予測性能の改善が見られた．</p>
<p>事後予測分布のプロットだけでなく，その「よさ」の定量的な指標として交差検証による事後予測スコア elpd <span class="citation" data-cites="Vehtari+2017">(Vehtari et al., 2017)</span> があることを学んだ．</p>
</section>
<section id="ベイズから見た変数選択" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="ベイズから見た変数選択"><span class="header-section-number">1.2</span> ベイズから見た変数選択</h3>
<p>こうして予測力を基にモデル選択をする方法は得たわけであるが，純粋にベイズ的な観点から変数選択を行う方法が大きく分けて２つある．</p>
<section id="縮小事前分布による方法" class="level4" data-number="1.2.1">
<h4 data-number="1.2.1" class="anchored" data-anchor-id="縮小事前分布による方法"><span class="header-section-number">1.2.1</span> 縮小事前分布による方法</h4>
<p>１つ目が「モデルに含まれる変数は少ないはずである」という信念を表現した事前分布を用いる方法である（第 2 節）．</p>
<p>これは馬蹄事前分布 <span class="citation" data-cites="Carvalho+2009">(Carvalho et al., 2009)</span>, <span class="citation" data-cites="Carvalho+2010">(Carvalho et al., 2010)</span>，Laplace 事前分布 / Bayesian Lasso <span class="citation" data-cites="Park-Casella2008">(Park and Casella, 2008)</span> などの global-local shrinkage prior を用いる方法である．</p>
<p>この方法は点推定や頻度論的な方法ではほとんど唯一の変数選択の方法であり，正則化または<strong>スパース性</strong> のキーワードの下で盛んに研究されている <span class="citation" data-cites="Hastie+2015">(Hastie et al., 2015)</span>．</p>
</section>
<section id="sec-spike-and-slab" class="level4" data-number="1.2.2">
<h4 data-number="1.2.2" class="anchored" data-anchor-id="sec-spike-and-slab"><span class="header-section-number">1.2.2</span> ベイズ変数選択</h4>
<p>２つ目が spike-and-slab 事前分布 <span class="citation" data-cites="Mitchell-Beauchamp1988">(Mitchell and Beauchamp, 1988)</span> という <img src="https://latex.codecogs.com/png.latex?0"> にマスを持つ事前分布を用いる方法である： <span id="eq-spike-and-slab"><img src="https://latex.codecogs.com/png.latex?%0Ap(dx)=%5Cprod_%7Bi=1%7D%5Ed%5Cbiggr(%5Comega_i%5Cphi_i(x_i)%5C,dx_i+(1-%5Comega_i)%5Cdelta_0(dx_i)%5Cbiggl)%0A%5Ctag%7B1%7D"></span></p>
<p>この方法では当該変数の <strong>事後包含確率</strong> (PIP: Posterior Inclusion Probability) を導出することができる．実際 (1) は混合分布の形をしており，spike <img src="https://latex.codecogs.com/png.latex?%5Cdelta_0"> と slab <img src="https://latex.codecogs.com/png.latex?%5Cphi_i"> のどちらからサンプリングされるかを表す潜在変数 <img src="https://latex.codecogs.com/png.latex?%5Cgamma_i%5Cin%5C%7B0,1%5C%7D"> を導入すれば，<img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BP%7D%5B%5Cgamma=0%7C%5Cmathcal%7BD%7D%5D"> という事後確率こそが変数 <img src="https://latex.codecogs.com/png.latex?x_i"> がモデルに入る事後確率である．</p>
<p>PIP を用いることで「当該変数がモデルに含まれるか？」という問題に直接ベイズ的に答えることができる．これを <strong>ベイズ変数選択</strong> という 3．</p>
<p>一方で前述の global-local shrinkage prior でも，post-processing を通じて同様に PIP を近似的に算出することができる <span class="citation" data-cites="Hahn-Carvalho2015">(Hahn and Carvalho, 2015)</span>．</p>
</section>
</section>
<section id="ベイズモデル平均を見据えて" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="ベイズモデル平均を見据えて"><span class="header-section-number">1.3</span> ベイズモデル平均を見据えて</h3>
<p>このようにベイズ変数選択 1.2.2 では，変数選択も統計的推論の問題として解く．</p>
<p>この方法は最適なレートで縮小する効果を持ち <span class="citation" data-cites="Castillo+2015">(Castillo et al., 2015)</span>，また予測力にも優れる <span class="citation" data-cites="Porwal-Raftery2022">(Porwal and Raftery, 2022)</span>．</p>
<p>最終的には，適切に構造と事前分布が設定されたベイズモデルを用いて，ベイズ推論により変数の関連度を自動で判断して結果を出すことが理想である．その意味では全ての変数を（適切に）入れたモデルを用いることが好ましい．<sup>1</sup></p>
<p>ベイズ変数選択はこの最終目標に向かうまでの探索的な中途解析と見ることもできる．</p>
<p>実際，ベイズ変数選択により得た事後包含確率 PIP は，ベイズモデル平均 (BMA: Bayesian Model Averaging) <span class="citation" data-cites="Hoeting+1999">(Hoeting et al., 1999)</span> に用いることができる．</p>
<p>変数選択・モデル選択を実行し，選ばれた単一のモデルで推論・予測を実行するよりも，尤度が必ずしも最も高いわけではないモデルも捨てずに推論に用いることで精度を上げることができる．</p>
<p>これがベイズモデル平均の考え方であり，ベイズの美点をフルに発揮する枠組みであると言える．実際，<span class="citation" data-cites="Porwal-Raftery2022">(Porwal and Raftery, 2022)</span> では線型回帰モデルの変数選択において，３つの適応的 BMA 手法が全てのタスクでベストな予測性能を示したことを報告している．</p>
</section>
</section>
<section id="sec-Bayesian-regularization" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="sec-Bayesian-regularization"><span class="header-section-number">2</span> 縮小事前分布による方法</h2>
<section id="多くの説明変数が存在する場合の事前分布" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="多くの説明変数が存在する場合の事前分布"><span class="header-section-number">2.1</span> 多くの説明変数が存在する場合の事前分布</h3>
<p><code>stan_glm</code> では回帰係数には適切な分散を持った独立な正規分布（<img src="https://latex.codecogs.com/png.latex?g">-prior）をデフォルトの事前分布としている．</p>
<p><code>brms</code> では一様事前分布である．</p>
<p>仮に説明変数が極めて多い場合，このデフォルト事前分布を採用し続けることは適切ではない．</p>
<p>実際，独立な正規・一様分布に従う説明変数が大量にある場合，これは「ベイズ（事後平均）推定量の分散が大きい」という事前分布を採用していることに含意してしまう．</p>
<p>仮に <img src="https://latex.codecogs.com/png.latex?%5Csigma"> にも同様の分散の大きい事前分布をおいているのならば辻褄は合うが，そうでないならばベイズ決定係数 <img src="https://latex.codecogs.com/png.latex?R%5E2"> にほとんど <img src="https://latex.codecogs.com/png.latex?1"> 近くの事前分布をおいていることに等価である．</p>
<p>すなわち過学習されたモデルに強い事前分布をおいていることになる <span class="citation" data-cites="Gelman-Hill-Vehtari2020">(Gelman et al., 2020, p. 208)</span>．これは我々の信念と食い違うだろう．そもそも弱情報であるべきデフォルト事前分布としては相応しくない．</p>
</section>
<section id="縮小事前分布" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="縮小事前分布"><span class="header-section-number">2.2</span> 縮小事前分布</h3>
<p>まずは各変数の正規事前分布の分散を十分小さくして，誤差 <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> の分散 <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2"> のスケールと同一にすることが考えられる．</p>
<p>この際 <img src="https://latex.codecogs.com/png.latex?R%5E2"> にはほとんど無情報な事前分布が仮定されるのと同一である．</p>
<p>さらに，仮に「多くの説明変数のうち，一部しか重要なものはなく，他の大部分はほとんど無関係である」と思っている，あるいは思いたいとする．変数選択を行いたい場合がこれにあたる．</p>
<p>この信念を正確に表現する事前分布の一つに馬蹄事前分布 (horseshoe prior) <span class="citation" data-cites="Carvalho+2009">(Carvalho et al., 2009)</span>, <span class="citation" data-cites="Carvalho+2010">(Carvalho et al., 2010)</span> とその正則化バージョン <span class="citation" data-cites="Piironen-Vehtari2017">(Piironen and Vehtari, 2017b)</span> がある．</p>
<p>これらの分布は global-local shrinkage prior と呼ばれ，<img src="https://latex.codecogs.com/png.latex?R%5E2"> 上の事前分布に，<img src="https://latex.codecogs.com/png.latex?0"> 上にスパイクを生じさせる．モデルに支持されない説明変数の係数を <img src="https://latex.codecogs.com/png.latex?0"> に向かって縮小する効果があり，結果としてシンプルなモデルを選好することになる．</p>
<p>Stan においては <code>prior=hs</code> によって指定できる <span class="citation" data-cites="Gelman-Hill-Vehtari2020">(Gelman et al., 2020, p. 209)</span>．</p>
</section>
<section id="local-scale-mixture" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="local-scale-mixture"><span class="header-section-number">2.3</span> Local Scale Mixture</h3>
<p>多くの正則化事前分布は次のような正規分布の local scale mixture <span class="citation" data-cites="West1987">(West, 1987)</span> の形をしている：<sup>2</sup> <img src="https://latex.codecogs.com/png.latex?%0A%5Cpi(%5Cbeta_j%7C%5Clambda)=%5Cint_%5Cmathbb%7BR%7D%5Cphi(%5Cbeta_j%7C0,%5Clambda%5E2%5Clambda%5E2_j)%5Cpi(%5Clambda_j%5E2)%5C,d%5Clambda_j.%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cpi"> が２点のみに台を持つ場合が spike-and-slab (1) であった <span class="citation" data-cites="Polson-Scott2011">(Polson and Scott, 2011)</span>．SSVS （第 3.2 節）も含む．<img src="https://latex.codecogs.com/png.latex?%5Cpi"> が絶対連続である場合も次のような例を持つ <span class="citation" data-cites="Polson-Scott2012">(Polson and Scott, 2012)</span>：</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li>二重指数分布 (double exponential) / Bayesian Lasso <span class="citation" data-cites="Park-Casella2008">(Park and Casella, 2008)</span>, <span class="citation" data-cites="Hans2009">(Hans, 2009)</span></li>
<li>馬蹄事前分布 (horseshoe prior) <span class="citation" data-cites="Carvalho+2009">(Carvalho et al., 2009)</span>, <span class="citation" data-cites="Carvalho+2010">(Carvalho et al., 2010)</span></li>
<li>Bayesian elastic net <span class="citation" data-cites="Hans2011">(Hans, 2011)</span></li>
</ul>
</div>
</div>
</div>
<p><span class="citation" data-cites="Ishwaran-Rao2005">(Ishwaran and Rao, 2005)</span> はこれらの研究より早い段階で，<img src="https://latex.codecogs.com/png.latex?%5Cpi"> に <img src="https://latex.codecogs.com/png.latex?0"> の近くと <img src="https://latex.codecogs.com/png.latex?0"> から大きく離れた二峰を持つ分布を用意している．</p>
</section>
<section id="ベイズ縮小の効果" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="ベイズ縮小の効果"><span class="header-section-number">2.4</span> ベイズ縮小の効果</h3>
<p>スケールパラメータ <img src="https://latex.codecogs.com/png.latex?%5Clambda"> は，LASSO <span class="citation" data-cites="Tibshirani1996">(Tibshirani, 1996)</span> では CV などの基準により選択することになるが，<img src="https://latex.codecogs.com/png.latex?%5Clambda"> を推定してモデル平均を行うことでより高い推定精度を得ることができる <span class="citation" data-cites="Hans2009">(Hans, 2009)</span>．</p>
<p>同様にして事後平均推定量により推定精度は改善されるが，ほとんど確実にこれはスパースではない．従って推定量のスパース性と推定精度はトレードオフの関係にあり，完全にベイジアンに Bayesian LASSO を実行すると本末転倒に陥るという一面もある．</p>
<p>このためベイズ縮小事前分布を用いた場合，自動的にスパース性に基づいたモデル選択ができるというわけではなく，事後モデル確率 (posterior model probability) を最大にするものを見つけるという post-processing が必要になる <span class="citation" data-cites="Hahn-Carvalho2015">(Section 1.5 Hahn and Carvalho, 2015, p. 438)</span>, <span class="citation" data-cites="Piironen+2020">(Piironen et al., 2020)</span>, <span class="citation" data-cites="Griffin2024">(Jim E. Griffin, 2024)</span>．</p>
<p>しかし以上のベイズモデル選択の手続きを踏むことによって，事後モデル確率を最大にするものという統計的・決定理論的に根拠を持ったモデル選択を実行することができる．</p>
<p>LASSO はベイズモデル選択の結果よりも予測性能が必ずしも高いわけではないにも拘らず，より多くの変数をモデルに残しがちであることも報告されている <span class="citation" data-cites="Porwal-Raftery2022">(Porwal and Raftery, 2022, p. 3)</span>．これは馬蹄事前分布などの最新の縮小事前分布は，回帰係数の効果量やモデルの大きさなどに応じて適応的に正則化の強さを加減しているためだとも言える <span class="citation" data-cites="Li-Dutta-Roy2023">(Li et al., 2023)</span>．</p>
</section>
<section id="馬蹄事前分布" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="馬蹄事前分布"><span class="header-section-number">2.5</span> 馬蹄事前分布</h3>
<p>馬蹄事前分布 <img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_j%7C%5Clambda_j,%5Ctau%5Csim%5Cmathrm%7BN%7D(0,%5Clambda_j%5E2%5Ctau%5E2),%5Cqquad%5Clambda_j%5Csim%5Coperatorname%7Bhalf-Cauchy%7D(0,1),%0A"> は global-local shrinkage prior の１つである．</p>
<p>というのも，hyperparameter <img src="https://latex.codecogs.com/png.latex?%5Ctau"> で決まる大域的な縮小効果がある一方で，半 Cauchy 分布による混合の構造が局所的なスケールパラメータ <img src="https://latex.codecogs.com/png.latex?%5Clambda_j"> を調整し，縮小される変数とされない変数とにコントラストをつけてくれる．</p>
<p>つまり，馬蹄事前分布は「少数の変数のみが大きなスケールを持つ」という信念を，階層的な構造で表現したものと理解できる．</p>
<p>最後の問題はハイパーパラメータ <img src="https://latex.codecogs.com/png.latex?%5Ctau"> の調整である．</p>
<p>交差検証法や周辺尤度の値，情報量規準により <img src="https://latex.codecogs.com/png.latex?%5Ctau"> の値を選んで推定を実行することもできる（経験ベイズ）．<span class="citation" data-cites="Polson-Scott2011">(Polson and Scott, 2011)</span> では <img src="https://latex.codecogs.com/png.latex?%0A%5Ctau%7C%5Csigma%5Csim%5Coperatorname%7Bhalf-Cauchy%7D(0,%5Csigma%5E2)%0A"> という hyperprior を推奨している．ただし <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2"> は誤差の分散と共通とする．一方で <span class="citation" data-cites="Piironen-Vehtari2017Choice">(Piironen and Vehtari, 2017a)</span> は事前の信念から非零の係数を持つべき変数の数 <img src="https://latex.codecogs.com/png.latex?p_0"> に対して <img src="https://latex.codecogs.com/png.latex?%0A%5Ctau%7C%5Csigma%5Csim%5Coperatorname%7Bhalf-Cauchy%7D(0,%5Ctau%5E2_0),%5Cqquad%5Ctau_0:=%5Cfrac%7Bp_0%7D%7Bp-p_0%7D%5Cfrac%7B%5Csigma%5E2%7D%7B%5Csqrt%7Bn%7D%7D,%0A"> により hyperprior を置くことを推奨している．</p>
</section>
<section id="正則化" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="正則化"><span class="header-section-number">2.6</span> 正則化</h3>
<p>馬蹄事前分布はモデルに支持される変数の係数はほとんど縮小させないように設計されている．これは美点である一方で，正則化の効果を弱めてしまい，縮小事前分布であるはずが推定の安定化が望めない場合がある．</p>
<p>例えばロジスティック回帰に馬蹄事前分布をおくと，<a href="../../../posts/2024/Survey/BDA2.html#sec-separation">分離</a> などが起こって識別性が弱い場合に Cauchy 分布と同様の裾を持つために事後平均推定量が存在しなくなってしまう <span class="citation" data-cites="Ghosh+2018">(Ghosh et al., 2018)</span>．</p>
<p>また従来の馬蹄事前分布では，ときに事後分布が漏斗型を持ってしまい，収束が劇的に遅くなるという現象も観測されていた <span class="citation" data-cites="Piironen-Vehtari2015">(Piironen and Vehtari, 2015)</span>．</p>
<p>これらの問題を解決するために spike-and-slab 事前分布の slab width と同様の正則化ハイパーパラメータ <img src="https://latex.codecogs.com/png.latex?c%3E0"> を導入した <strong>正則化馬蹄事前分布</strong> (regularized horseshoe prior) <span class="citation" data-cites="Piironen-Vehtari2017">(Piironen and Vehtari, 2017b)</span> が提案されている： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_j%7C%5Clambda_j,%5Ctau,c%5Csim%5Cmathrm%7BN%7D(0,%5Ctau%5E2%5Cwidetilde%7B%5Clambda%7D_j%5E2),%5Cqquad%5Cwidetilde%7B%5Clambda%7D_j:=%5Cfrac%7Bc%5E2%5Clambda_j%5E2%7D%7Bc%5E2+%5Ctau%5E2%5Clambda_j%5E2%7D,%5Clambda_j%5Csim%5Coperatorname%7Bhalf-Cauchy%7D(0,1).%0A"> <img src="https://latex.codecogs.com/png.latex?c%5Cto%5Cinfty"> の極限では馬蹄事前分布に一致する．この <img src="https://latex.codecogs.com/png.latex?c"> には次の hyperprior を推奨している： <img src="https://latex.codecogs.com/png.latex?%0Ac%5E2%5Csim%5Coperatorname%7BInv-Gamma%7D(%5Cnu/2,%5Cnu%20s%5E2/2).%0A"> これにより最大の係数に対して <img src="https://latex.codecogs.com/png.latex?t_%5Cnu(0,s%5E2)"> の事前分布を置くことに等価になる <span class="citation" data-cites="Piironen-Vehtari2017">((2.11) Piironen and Vehtari, 2017b, p. 5025)</span>．</p>
</section>
<section id="rstanarm-での利用" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="rstanarm-での利用"><span class="header-section-number">2.7</span> <code>rstanarm</code> での利用</h3>
<p><code>rstanarm</code> では <code>hs</code> (hierarchical shrinkage) 事前分布</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">global_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">global_scale =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slab_scale =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span></code></pre></div>
<p>が利用可能である．これは <img src="https://latex.codecogs.com/png.latex?%0A%5Ctau%7C%5Csigma%5Csim%5Coperatorname%7Bhalf-t%7D(%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bglobal_df%7D%7D),%5Cqquad%5Clambda_j%5Csim%5Coperatorname%7Bhalf-t%7D(%5Ctextcolor%7Bpurple%7D%7B%5Cmathtt%7Bdf%7D%7D)%0A"> というものであるから，<code>df=1</code>, <code>global_df=1</code> が正則化馬蹄事前分布に対応する．</p>
<p><code>global_scale</code> が <img src="https://latex.codecogs.com/png.latex?%5Ctau_0"> に，<code>slab_scale</code> が <img src="https://latex.codecogs.com/png.latex?s">，<code>slab_df</code> が <img src="https://latex.codecogs.com/png.latex?%5Cnu"> に対応する．</p>
</section>
</section>
<section id="sec-Bayesian-variable-selection" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-Bayesian-variable-selection"><span class="header-section-number">3</span> ベイズ変数選択</h2>
<section id="sec-hierarchical-modeling" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="sec-hierarchical-modeling"><span class="header-section-number">3.1</span> はじめに：階層モデリング</h3>
<p><strong>ベイズ変数選択</strong> では，説明変数 <img src="https://latex.codecogs.com/png.latex?%5C%7Bx_i%5C%7D_%7Bi=1%7D%5Ep"> のそれぞれがモデルに含まれるかを意味する潜在変数 <img src="https://latex.codecogs.com/png.latex?%5C%7B%5Cgamma_i%5C%7D_%7Bi=1%7D%5Ep%5Cin%5C%7B0,1%5C%7D%5Ep=:%5CGamma"> の事後分布を算出して，特定の変数がモデルに含まれる確率を算出する．</p>
<p>最終的にこの確率分布は，ベイズモデル平均 (BMA: Bayesian Model Averaging) と言って，それぞれのモデルの事後予測を平均するためのプライヤーとして用いることもできる．</p>
<p>この方法では <img src="https://latex.codecogs.com/png.latex?%0Ap(%5Cgamma)=%5Cprod_%7Bi=1%7D%5Ep%5Comega_i%5E%7B%5Cgamma_i%7D(1-%5Comega_i)%5E%7B1-%5Cgamma_i%7D,%5Cqquad%20p(%5Csigma%5E2)%5C,%5Cpropto%5C,%5Csigma%5E%7B-2%7D%0A"> <img src="https://latex.codecogs.com/png.latex?%0Ap(%5Cbeta%7C%5Csigma,%5Cgamma)%5C,d%5Cbeta=%5Cmathrm%7BN%7D_p(0,%5CSigma(%5Csigma,%5Cgamma))%0A"> という階層構造を通じて，回帰モデルに潜在変数 <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> を導入する．<img src="https://latex.codecogs.com/png.latex?%5CSigma"> は <span class="citation" data-cites="Liang+2022">(X. Liang et al., 2022)</span> では独立，<span class="citation" data-cites="George-McCulloch1997">(George and McCulloch, 1997)</span> では <img src="https://latex.codecogs.com/png.latex?g">-prior とする： <img src="https://latex.codecogs.com/png.latex?%0A%5CSigma(%5Csigma,%5Cgamma):=g%5Csigma%5E2(X%5E%5Ctop_%5Cgamma%20X_%5Cgamma)%5E%7B-1%7D.%0A"> <img src="https://latex.codecogs.com/png.latex?g"> は global scale parameter と呼ばれ，これにさらに hyperprior を設定することもある <span class="citation" data-cites="Liang+2008">(F. Liang et al., 2008)</span>, <span class="citation" data-cites="Lay-Steel2009">(Ley and Steel, 2009)</span>．</p>
<p>このアプローチは <span class="citation" data-cites="George-McCulloch1997">(George and McCulloch, 1997)</span> らによって創始された．（仮に <img src="https://latex.codecogs.com/png.latex?p"> が比例的に増えるとしても） <img src="https://latex.codecogs.com/png.latex?n%5Cto%5Cinfty"> の極限で PIP は正しいモデル上の Delta 測度に収束する <span class="citation" data-cites="Shang-Clayton2011">(Shang and Clayton, 2011)</span>．</p>
</section>
<section id="sec-SSVS" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="sec-SSVS"><span class="header-section-number">3.2</span> 確率的探索法</h3>
<p>特に <span class="citation" data-cites="George-McCulloch1993">(George and McCulloch, 1993)</span> では <span id="eq-SSVS"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_i%7C%5Cgamma_i%5Csim(1-%5Cgamma_i)%5Cmathrm%7BN%7D(0,%5Csigma_i%5E2)+%5Cgamma_i%5Cmathrm%7BN%7D(0,c_i%5E2%5Csigma_i%5E2)%0A%5Ctag%7B2%7D"></span> という構造を設定し，データ拡張に基づく Gibbs サンプラーによって推定することを提案した．</p>
<p>この方法は <strong>確率的探索法</strong> (SSVS: Stochastic Search Variable Selection) と呼ばれる．<sup>3</sup></p>
<p>しかし (2) は spike-and-slab (1) の近似になっているため，<img src="https://latex.codecogs.com/png.latex?%5Cgamma_i=1"> の事後確率は正確に PIP になっているわけではない．</p>
<p>この近似は Gibbs サンプラーを高速にするという利点はあったかもしれないが，現代では spike-and-slab (1) に直接適用できる高速なサンプラーが多数開発されている．</p>
</section>
<section id="sec-Add-Delete-Swap" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="sec-Add-Delete-Swap"><span class="header-section-number">3.3</span> Add-Delete-Swap による探索</h3>
<p>計量化学 (chemometrics) では <img src="https://latex.codecogs.com/png.latex?p"> が特に高次元になり得る．<span class="citation" data-cites="Brown+1998">(Brown et al., 1998)</span> は近赤外線分光法で得られたデータから，予測に有用な波長を選択する問題に対処するためにベイズ変数選択の方法を用いることを考えた．</p>
<p>そのためにまず第 3.1 節の階層モデルを多次元化し，推定には乱歩 MH 法を用いた．</p>
<p><span class="citation" data-cites="Brown+1998">(Brown et al., 1998)</span> の乱歩 MH 法の提案核は，Add-Delete-Swap の動きをするものであった：</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>次の２つの動きを，それぞれ確率 <img src="https://latex.codecogs.com/png.latex?%5Cphi,1-%5Cphi"> で行う；</p>
<ol type="1">
<li><p>Adding or Deleting</p>
<p>新たな変数 <img src="https://latex.codecogs.com/png.latex?x_i"> をランダムに選び，まだモデルに入っていない場合は入れ，すでにモデルに含まれている場合は取り除く．</p></li>
<li><p>Swapping</p>
<p>モデルに含まれていない変数 <img src="https://latex.codecogs.com/png.latex?x_i"> と含まれている変数 <img src="https://latex.codecogs.com/png.latex?x_j"> をそれぞれランダムに選び，入れ替える．</p></li>
</ol>
</div>
</div>
</div>
<p><span class="citation" data-cites="Yang+2016">(Yang et al., 2016)</span> は MH 法の計算複雑性を解析し，<img src="https://latex.codecogs.com/png.latex?p"> が大きい場合にも計算量が線型にしか増加しない乱歩 MH 法を提案した．</p>
</section>
<section id="超次元-mcmc-による-pip-算出" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="超次元-mcmc-による-pip-算出"><span class="header-section-number">3.4</span> 超次元 MCMC による PIP 算出</h3>
<p>事後包含確率を出すにあたって，Reversible-Jump MCMC <span class="citation" data-cites="Green1995">(Green, 1995)</span> などの超次元手法を用いることも考えられる．</p>
<p>超次元 MCMC とは，一般に複数のモデルから同時にサンプリングするための用いられ，ベイズ変数選択法は分解可能なグラフィカルモデルに対する超次元 MCMC 法の特別な場合と見れる <span class="citation" data-cites="Godsill2001">(Godsill, 2001, p. 232)</span>．</p>
<p>詳しくは別稿で取り上げるが，特に Sticky PDMP <span class="citation" data-cites="Bierkens+2023">(Bierkens et al., 2023)</span> は有力な PIP 算出法になる．</p>
<div id="listing-lst-survey" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNNQ01DJTJDU3RhdGlzdGljcw==" data-listing-date-sort="1726963200000" data-listing-file-modified-sort="1754014117263" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="2" data-listing-word-count-sort="349">
<a href="../../../posts/2024/TransDimensionalModels/BayesTrans.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/StickyComparison.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
超次元 MCMC
</h5>
<div class="card-subtitle listing-subtitle">
モデル選択のためのマルコフ連鎖モンテカルロ法
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-22
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUERNUA==" data-listing-date-sort="1734739200000" data-listing-file-modified-sort="1754014117263" data-listing-date-modified-sort="1737849600000" data-listing-reading-time-sort="2" data-listing-word-count-sort="253">
<a href="../../../posts/2024/TransDimensionalModels/BayesSticky.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-survey:posts/2024/TransDimensionalModels/BayesSticky.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
Sticky PDMP によるベイズ変数選択
</h5>
<div class="card-subtitle listing-subtitle">
非絶対連続分布からの正確なサンプリング
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-21
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQw==" data-listing-date-sort="1734739200000" data-listing-file-modified-sort="1754014117263" data-listing-date-modified-sort="1734739200000" data-listing-reading-time-sort="1" data-listing-word-count-sort="97">
<a href="../../../posts/2024/TransDimensionalModels/BayesTraverse.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-survey:posts/2024/TransDimensionalModels/BayesTraverse.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
連続・離散を往来する MCMC サンプラー
</h5>
<div class="card-subtitle listing-subtitle">
Zig-Zag within Gibbs という考え方
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-21
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="計算の問題" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="計算の問題"><span class="header-section-number">3.5</span> 計算の問題</h3>
<p>ベイズ変数選択とはモデル空間 <img src="https://latex.codecogs.com/png.latex?%5CGamma=%5C%7B0,1%5C%7D%5Ep"> 上の事後分布を計算することであるが，これを効率的に行う MCMC を構成することが中心的な問題になる．</p>
<p>ここまで叙述してきた Gibbs サンプラー（例えば確率的探索法 3.2 など）は，<img src="https://latex.codecogs.com/png.latex?p=2"> の極めて簡単な設定で簡単に崩壊する．というのも，２つの同等な説明力を持つ確率変数が強い相関を持つ場合，<img src="https://latex.codecogs.com/png.latex?(%5Cbeta,%5Cgamma)"> の同時分布は強い二峰性を持つ．</p>
<p>その結果ただナイーブに Gibbs サンプラーを適用しただけでは片方の峰しか見つけることができず，PIP について偏った結果を出してしまう <span class="citation" data-cites="Zanella-Roberts2019">(Section 5.1 Zanella and Roberts, 2019)</span>．</p>
<p>推定したいモデルが階層モデルである限り，多峰性の問題は常に付きものである．</p>
<div id="listing-lst-embedding1" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ1I=" data-listing-date-sort="1734825600000" data-listing-file-modified-sort="1754014117262" data-listing-date-modified-sort="1734912000000" data-listing-reading-time-sort="5" data-listing-word-count-sort="954">
<a href="../../../posts/2024/TransDimensionalModels/Bafumi.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-embedding1:posts/2024/TransDimensionalModels/Bafumi.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
On the Identifiability of the Bafumi et. al.&nbsp;Ideal Point Model
</h5>
<div class="card-subtitle listing-subtitle">
Rethinking of the Hierarchical Model of Bafumi et. al.&nbsp;(2005)
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-22
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?p=2"> の時でさえ深刻になり得る多峰性の問題に加えて，共変量の数 <img src="https://latex.codecogs.com/png.latex?p"> が大きい現代的な問題に対処する必要もあることを思えば，ベイズ変数選択の問題は，多峰性に強い効率的なベイズ計算法を開発するという普遍的な課題に回収されるのである．</p>
</section>
<section id="tempered-gibbs-サンプラー" class="level3" data-number="3.6">
<h3 data-number="3.6" class="anchored" data-anchor-id="tempered-gibbs-サンプラー"><span class="header-section-number">3.6</span> Tempered Gibbs サンプラー</h3>
<p>目標分布の条件付き分布 <img src="https://latex.codecogs.com/png.latex?f(x_i%7Cx_%7B-i%7D)"> が多峰性を持つ場合，何らかの軟化 <img src="https://latex.codecogs.com/png.latex?g(x_i%7Cx_%7B-i%7D)"> を考えることがあり得る．これに対して <img src="https://latex.codecogs.com/png.latex?%0Ap_i(x):=%5Cfrac%7Bg(x_i%7Cx_%7B-i%7D)%7D%7Bf(x_i%7Cx_%7B-i%7D)%7D%0A"> と定め，まず <img src="https://latex.codecogs.com/png.latex?(p_1(x),%5Ccdots,p_p(x))"> に従って <img src="https://latex.codecogs.com/png.latex?i%5Cin%5Bp%5D"> を選び，続いて <img src="https://latex.codecogs.com/png.latex?x_i%5Csim%20g(x_i%7Cx_%7B-i%7D)"> をサンプリングする random scan Gibbs サンプラーを考えると，これはやはり <img src="https://latex.codecogs.com/png.latex?f"> を不変分布にもつ．</p>
<p>この方法では <img src="https://latex.codecogs.com/png.latex?p_i(x)"> で各説明変数 <img src="https://latex.codecogs.com/png.latex?x_i"> に傾斜をつけているために，特に PIP の高い <img src="https://latex.codecogs.com/png.latex?i%5Cin%5Bp%5D"> から優先的にサンプリングすることができる．この方法は後述 3.7 節の informed MCMC の先駆けとなった．</p>
<!--
### SVEN

[@Hans+2007] では確率的探索法 [-@sec-SSVS] を，Add-Delete-Swap [-@sec-Add-Delete-Swap] の動きを取り入れることでさらに洗練させることを考えた．

１つの変数のみを Add-Delete-Swap して得る配置のみ

SVEN (Selection of Variables with Embedded screeNing) [@Li-Dutta-Roy2023]．
-->
</section>
<section id="sec-Locally-Informed-MH-Samplers" class="level3" data-number="3.7">
<h3 data-number="3.7" class="anchored" data-anchor-id="sec-Locally-Informed-MH-Samplers"><span class="header-section-number">3.7</span> Locally Informed MH Samplers</h3>
<p>Add-Delete-Swap による乱歩 MH 法 3.3 の設計は，見通しの良い素朴な構成であるが，効率的な動きである保証は全くない．さらには <img src="https://latex.codecogs.com/png.latex?%5Cphi"> やそれぞれの候補を持ってくる確率など，ユーザーが調整する必要があるハイパーパラメータも多い．</p>
<p>対称かつ局所的なサンプラーの中では，採択率が高いほど効率が良い <span class="citation" data-cites="Peskun1973">(Peskun, 1973)</span>, <span class="citation" data-cites="Tierney1998">(Tierney, 1998)</span>．そこで離散空間上の乱歩 MH 法の採択率を上げるために，現在位置の周囲の点の情報を収集して次の動きを決めるサンプラーが <strong>Informed MCMC</strong> の名前の下で開発されている <span class="citation" data-cites="Liang+2022">(X. Liang et al., 2022, p. 84)</span>．</p>
<p>多くの locally informed MCMC <span class="citation" data-cites="Zanella2020">(Zanella, 2020)</span> では，通常の乱歩 MH 核 <img src="https://latex.codecogs.com/png.latex?Q"> を基底核 (base kernel) として，これを近傍での事後分布の様子を要約した <strong>釣り合い関数</strong> (balancing function) <img src="https://latex.codecogs.com/png.latex?g"> を用いて修正することで効率的な動きを達成する： <img src="https://latex.codecogs.com/png.latex?%0Aq_g(%5Cgamma,%5Cgamma')%5C,%5Cpropto%5C,g%5Cleft(%5Cfrac%7B%5Cpi(%5Cgamma')%7D%7B%5Cpi(%5Cgamma)%7D%5Cright)q(%5Cgamma,%5Cgamma').%0A"></p>
<p>この中でも LIT (Locally Informed and Thresholded proposal) <span class="citation" data-cites="Zhou+2022">(Zhou et al., 2022)</span> は釣り合い関数として閾値関数 (threshold function) <img src="https://latex.codecogs.com/png.latex?%0Ag(t)=p%5EL%5Cland(p%5El%5Clor%20t),%5Cqquad-%5Cinfty%3Cl%3CL%3C%5Cinfty.%0A"> を用い，さらに提案核 <img src="https://latex.codecogs.com/png.latex?Q"> を単なる一様分布ではなく第 3.3 節で考えられた Add-Delete-Swap 核 <span class="citation" data-cites="Brown+1998">(Brown et al., 1998)</span> にとることで，一定の条件の下で <strong>次元 <img src="https://latex.codecogs.com/png.latex?p"> に依存しない収束速度</strong> を達成することを示した．</p>
</section>
<section id="適応的なサンプラー" class="level3" data-number="3.8">
<h3 data-number="3.8" class="anchored" data-anchor-id="適応的なサンプラー"><span class="header-section-number">3.8</span> 適応的なサンプラー</h3>
<p>LIT は固定した基底核 <img src="https://latex.codecogs.com/png.latex?Q"> を取り，そこから <img src="https://latex.codecogs.com/png.latex?g"> で修正することを基本戦略としていた．一方でそもそも基底核 <img src="https://latex.codecogs.com/png.latex?Q"> を適応的に調整していくメカニズムを導入することができる．</p>
<p>ASI (Adaptively Scaled Individual adaptation) <span class="citation" data-cites="Griffin+2021">(J. E. Griffin et al., 2021)</span> では，<span class="citation" data-cites="Brown+1998">(Brown et al., 1998)</span> の Add-Delete-Swap 核 3.3 <img src="https://latex.codecogs.com/png.latex?%0Aq_%5Ceta(%5Cgamma,%5Cgamma')=%5Cprod_%7Bj=1%7D%5Epq_%7B%5Ceta,j%7D(%5Cgamma_j,%5Cgamma_j'),%5Cqquad%20%5Ceta=(A_1,%5Ccdots,A_p,D_1,%5Ccdots,D_p)%5Cin(0,1)%5E%7B2p%7D,%0A"> <img src="https://latex.codecogs.com/png.latex?%0Aq_%7B%5Ceta,j%7D(0,1)=%5Ceta_j=A_j,%5Cqquad%20q_%7B%5Ceta,j%7D(1,0)=%5Ceta_%7Bp+j%7D=D_j,%0A"> を元にして，<img src="https://latex.codecogs.com/png.latex?%5Ceta=(A,D)"> を適応的に更新していくことを考える．その際の目安は，<img src="https://latex.codecogs.com/png.latex?x_j"> の PIP <img src="https://latex.codecogs.com/png.latex?%5Cpi_j"> から定まる <img src="https://latex.codecogs.com/png.latex?%0AA_j%5E%5Cmathrm%7Bopt%7D:=1%5Cland%5Cfrac%7B%5Cpi_j%7D%7B1-%5Cpi_j%7D,%5Cqquad%20D_j%5E%5Cmathrm%7Bopt%7D:=1%5Cland%5Cfrac%7B1-%5Cpi_j%7D%7B%5Cpi_j%7D,%0A"> である．これの推定量 <img src="https://latex.codecogs.com/png.latex?%5Ceta%5E%7B(i)%7D"> を各段階で構成した上で，総じた採択率を調整する学習率のようなパラメータ <img src="https://latex.codecogs.com/png.latex?%5Czeta%5E%7B(i)%7D"> も導入し，<span class="citation" data-cites="Robbins-Monro1951">(Robbins and Monro, 1951)</span> の方法で更新していく．</p>
<p>実は ASI は <span class="citation" data-cites="Liang+2023">(X. Liang et al., 2023)</span> がいう <strong>確率近傍サンプラー</strong> (random neighbourhood sampler) の例になっている．これは Add-Delete-Swap <span class="citation" data-cites="Brown+1998">(Brown et al., 1998)</span> のように提案される近傍が，補助的な離散確率変数 <img src="https://latex.codecogs.com/png.latex?k%5Cin%5BK%5D"> によって定まるような乱歩 MH 法をいう．</p>
<p><span class="citation" data-cites="Liang+2023">(X. Liang et al., 2023)</span> では ASI によって構成される確率的近傍の中から，さらに locally informed に次の動きを選ぶことを提案し， <strong>適応的確率近傍</strong> (ARNI: Adaptive Random Neighbourhood Informed) サンプラーと呼んでいる．これにより ASI で上がりきらなかった採択率を押し上げつつ，計算量を抑えつつも良い近傍を提案するメカニズムを取り入れることができる．</p>
<p>これにより <img src="https://latex.codecogs.com/png.latex?p"> に依らない収束だけでなく，計算複雑性も <img src="https://latex.codecogs.com/png.latex?p"> の次元に対してスケールするものが得られると期待される．</p>
</section>
<section id="非可逆なサンプラー" class="level3" data-number="3.9">
<h3 data-number="3.9" class="anchored" data-anchor-id="非可逆なサンプラー"><span class="header-section-number">3.9</span> 非可逆なサンプラー</h3>
<p>Informed MCMC とは，連続空間上で言えば，MALA などの勾配情報を利用したサンプラーである．このような乱歩 MH 法の修正として得られる効率的なサンプラーを <span class="citation" data-cites="Liang+2022">(X. Liang et al., 2022)</span> は <strong>近傍サンプラー</strong> (neighbourhood sampler) と呼んでいる．</p>
<p>MALA などの Langevin 拡散を元にした乱歩 MH 法は革新的であったが，現在最も効率的なサンプラーは，局所的な動きを廃した HMC 法と，非可逆な動きを達成する PDMP (Piecewise Deterministic Markov Process) / ECMC (Event-Chain Monte Carlo) である．</p>
<p>離散空間上でもこれらのサンプラーに対応するものは高い効率を示すだろうと思われる．</p>
<p>一般の離散空間上でも局所性の打開には <span class="citation" data-cites="Nishimura+2020">(Nishimura et al., 2020)</span>，可逆性の打開には <span class="citation" data-cites="Koskela2022">(Koskela, 2022)</span> などの試みがあるが，殊に変数選択に関しては Sticky PDMP <span class="citation" data-cites="Bierkens+2023">(Bierkens et al., 2023)</span> という画期的な手法が開発されている．</p>
<p>これに関しては次稿で詳しく取り上げる：</p>
<div id="listing-lst-embedding2" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUERNUA==" data-listing-date-sort="1734739200000" data-listing-file-modified-sort="1754014117263" data-listing-date-modified-sort="1737849600000" data-listing-reading-time-sort="2" data-listing-word-count-sort="253">
<a href="../../../posts/2024/TransDimensionalModels/BayesSticky.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-embedding2:posts/2024/TransDimensionalModels/BayesSticky.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
Sticky PDMP によるベイズ変数選択
</h5>
<div class="card-subtitle listing-subtitle">
非絶対連続分布からの正確なサンプリング
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-21
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
</section>



<div id="quarto-appendix" class="default"><section id="文献紹介" class="level2 appendix" data-number="4"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">4</span> 文献紹介</h2><div class="quarto-appendix-contents">

<p>変数選択のための事前分布とその <img src="https://latex.codecogs.com/png.latex?R%5E2"> 上に定める事前分布については <span class="citation" data-cites="Gelman-Hill-Vehtari2020">(12.7 節 Gelman et al., 2020)</span> で丁寧に議論されている．</p>
<p>この第一のアプローチ・縮小事前分布については <span class="citation" data-cites="Bhadra+2019">(Bhadra et al., 2019)</span> のレビューがある．他には <span class="citation" data-cites="Griffin-Brown2021">(Jim E. Griffin and Brown, 2021)</span>, <span class="citation" data-cites="Griffin-Brown2017">(Jim E. Griffin and Brown, 2017)</span>, <span class="citation" data-cites="Hahn-Carvalho2015">(Hahn and Carvalho, 2015)</span> が詳しい．</p>
<p><span class="citation" data-cites="George-McCulloch1993">(George and McCulloch, 1993)</span> による変数選択法が <span class="citation" data-cites="Hoff2009">(Chapter 9 Hoff, 2009)</span> で取り上げられている．</p>
<p>ベイズ変数選択手法の概観は <span class="citation" data-cites="Liang+2023">(X. Liang et al., 2023)</span> や <span class="citation" data-cites="Griffin2024">(Jim E. Griffin, 2024)</span> のイントロに圧倒されるほどまとまっている．<span class="citation" data-cites="Griffin2024">(Jim E. Griffin, 2024)</span> ではモデルの空間上に得られた事後分布の情報を効果的に表示するための「信用区間」の構成法を提案している．</p>




</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Barr+2013" class="csl-entry">
Barr, D. J., Levy, R., Scheepers, C., and Tily, H. J. (2013). <a href="https://doi.org/10.1016/j.jml.2012.11.001">Random effects structure for confirmatory hypothesis testing: Keep it maximal</a>. <em>Journal of Memory and Language</em>, <em>68</em>(3), 255–278.
</div>
<div id="ref-Bhadra+2019" class="csl-entry">
Bhadra, A., Datta, J., Polson, N. G., and Willard, B. (2019). <a href="https://doi.org/10.1214/19-STS700"><span>Lasso Meets Horseshoe: A Survey</span></a>. <em>Statistical Science</em>, <em>34</em>(3), 405–427.
</div>
<div id="ref-Bierkens+2023" class="csl-entry">
Bierkens, J., Grazzi, S., Meulen, F. van der, and Schauer, M. (2023). <a href="https://doi.org/10.1007/s11222-022-10180-5"><span class="nocase">Sticky PDMP Samplers for Sparse and Local Inference Problems</span></a>. <em>Statistics and Computing</em>, <em>33</em>(1), 8.
</div>
<div id="ref-Brown+1998" class="csl-entry">
Brown, P. J., Vannucci, M., and Fearn, T. (1998). <a href="https://doi.org/10.1002/(SICI)1099-128X(199805/06)12:3<173::AID-CEM505>3.0.CO;2-0">Bayesian wavelength selection in multicomponent analysis</a>. <em>Journal of Chemometrics</em>, <em>12</em>(3), 173–182.
</div>
<div id="ref-Carvalho+2009" class="csl-entry">
Carvalho, C. M., Polson, N. G., and Scott, J. G. (2009). <a href="https://proceedings.mlr.press/v5/carvalho09a.html">Handling sparsity via the horseshoe</a>. In D. van Dyk and M. Welling, editors, <em>Proceedings of the twelfth international conference on artificial intelligence and statistics</em>,Vol. 5, pages 73–80. Hilton Clearwater Beach Resort, Clearwater Beach, Florida USA: PMLR.
</div>
<div id="ref-Carvalho+2010" class="csl-entry">
Carvalho, C. M., Polson, N. G., and Scott, J. G. (2010). <a href="https://doi.org/10.1093/biomet/asq017"><span class="nocase">The horseshoe estimator for sparse signals</span></a>. <em>Biometrika</em>, <em>97</em>(2), 465–480.
</div>
<div id="ref-Castillo+2015" class="csl-entry">
Castillo, I., Schmidt-Hieber, J., and Vaart, A. van der. (2015). <a href="https://doi.org/10.1214/15-AOS1334"><span class="nocase">Bayesian linear regression with sparse priors</span></a>. <em>The Annals of Statistics</em>, <em>43</em>(5), 1986–2018.
</div>
<div id="ref-Gelman-Hill-Vehtari2020" class="csl-entry">
Gelman, A., Hill, J., and Vehtari, A. (2020). <em><a href="https://avehtari.github.io/ROS-Examples/">Regression and other stories</a></em>. Cambridge University Press.
</div>
<div id="ref-George-McCulloch1993" class="csl-entry">
George, E. I., and McCulloch, R. E. (1993). <a href="http://www.jstor.org/stable/2290777">Variable selection via gibbs sampling</a>. <em>Journal of the American Statistical Association</em>, <em>88</em>(423), 881–889.
</div>
<div id="ref-George-McCulloch1997" class="csl-entry">
George, E. I., and McCulloch, R. E. (1997). <a href="http://www.jstor.org/stable/24306083">APPROACHES FOR BAYESIAN VARIABLE SELECTION</a>. <em>Statistica Sinica</em>, <em>7</em>(2), 339–373.
</div>
<div id="ref-Ghosh+2018" class="csl-entry">
Ghosh, J., Li, Y., and Mitra, R. (2018). <a href="https://doi.org/10.1214/17-BA1051"><span class="nocase">On the Use of Cauchy Prior Distributions for Bayesian Logistic Regression</span></a>. <em>Bayesian Analysis</em>, <em>13</em>(2), 359–383.
</div>
<div id="ref-Godsill2001" class="csl-entry">
Godsill, S. J. (2001). <a href="https://doi.org/10.1198/10618600152627924">On the relationship between markov chain monte carlo methods for model uncertainty</a>. <em>Journal of Computational and Graphical Statistics</em>, <em>10</em>(2), 230–248. doi: 10.1198/10618600152627924.
</div>
<div id="ref-Green1995" class="csl-entry">
Green, P. J. (1995). <a href="http://www.jstor.org/stable/2337340">Reversible jump markov chain monte carlo computation and bayesian model determination</a>. <em>Biometrika</em>, <em>82</em>(4), 711–732.
</div>
<div id="ref-Griffin2024" class="csl-entry">
Griffin, Jim E. (2024). <a href="https://arxiv.org/abs/2402.12323">Expressing and visualizing model uncertainty in bayesian variable selection using cartesian credible sets</a>.
</div>
<div id="ref-Griffin-Brown2017" class="csl-entry">
Griffin, Jim E., and Brown, P. (2017). <a href="https://doi.org/10.1214/15-BA990"><span class="nocase">Hierarchical Shrinkage Priors for Regression Models</span></a>. <em>Bayesian Analysis</em>, <em>12</em>(1), 135–159.
</div>
<div id="ref-Griffin-Brown2021" class="csl-entry">
Griffin, Jim E., and Brown, P. J. (2021). <a href="https://doi.org/10.1016/j.chemolab.2021.104255">Bayesian global-local shrinkage methods for regularisation in the high dimension linear model</a>. <em>Chemometrics and Intelligent Laboratory Systems</em>, <em>210</em>, 104255.
</div>
<div id="ref-Griffin+2021" class="csl-entry">
Griffin, J. E., Łatuszyński, K. G., and Steel, M. F. J. (2021). <a href="https://doi.org/10.1093/biomet/asaa055">In search of lost mixing time: Adaptive markov chain monte carlo schemes for bayesian variable selection with very large p</a>. <em>Biometrika</em>, <em>108</em>(1), 53–69.
</div>
<div id="ref-Hahn-Carvalho2015" class="csl-entry">
Hahn, P. R., and Carvalho, C. M. (2015). <a href="https://doi.org/10.1080/01621459.2014.993077">Decoupling shrinkage and selection in bayesian linear models: A posterior summary perspective</a>. <em>Journal of the American Statistical Association</em>, <em>110</em>(509), 435–448. doi: 10.1080/01621459.2014.993077.
</div>
<div id="ref-Hans2009" class="csl-entry">
Hans, C. (2009). <a href="http://www.jstor.org/stable/27798870">Bayesian lasso regression</a>. <em>Biometrika</em>, <em>96</em>(4), 835–845.
</div>
<div id="ref-Hans2011" class="csl-entry">
Hans, C. (2011). <a href="https://doi.org/10.1198/jasa.2011.tm09241">Elastic net regression modeling with the orthant normal prior</a>. <em>Journal of the American Statistical Association</em>, <em>106</em>(496), 1383–1393. doi: 10.1198/jasa.2011.tm09241.
</div>
<div id="ref-Hastie+2015" class="csl-entry">
Hastie, T., Tibshirani, R., and Wainwright, M. (2015). <em><a href="https://doi.org/10.1201/b18401">Statistical learning with sparsity: The lasso and generalizations</a></em>. Chapman; Hall/CRC.
</div>
<div id="ref-Hoeting+1999" class="csl-entry">
Hoeting, J. A., Madigan, D., Raftery, A. E., and Volinsky, C. T. (1999). <a href="https://doi.org/10.1214/ss/1009212519"><span class="nocase">Bayesian model averaging: a tutorial (with comments by M. Clyde, David Draper and E. I. George, and a rejoinder by the authors</span></a>. <em>Statistical Science</em>, <em>14</em>(4), 382–417.
</div>
<div id="ref-Hoff2009" class="csl-entry">
Hoff, P. D. (2009). <em><a href="https://doi.org/10.1007/978-0-387-92407-6">A first course in bayesian statistical methods</a></em>. Springer New York.
</div>
<div id="ref-Ishwaran-Rao2005" class="csl-entry">
Ishwaran, H., and Rao, J. S. (2005). <a href="https://doi.org/10.1214/009053604000001147"><span class="nocase">Spike and slab variable selection: Frequentist and Bayesian strategies</span></a>. <em>The Annals of Statistics</em>, <em>33</em>(2), 730–773.
</div>
<div id="ref-Koskela2022" class="csl-entry">
Koskela, J. (2022). <a href="https://doi.org/10.1080/10618600.2022.2032722">Zig-zag sampling for discrete structures and nonreversible phylogenetic MCMC</a>. <em>Journal of Computational and Graphical Statistics</em>, <em>31</em>(3), 684–694. doi: 10.1080/10618600.2022.2032722.
</div>
<div id="ref-Lay-Steel2009" class="csl-entry">
Ley, E., and Steel, M. F. J. (2009). <a href="https://doi.org/10.1002/jae.1057">On the effect of prior assumptions in bayesian model averaging with applications to growth regression</a>. <em>Journal of Applied Econometrics</em>, <em>24</em>(4), 651–674.
</div>
<div id="ref-Li-Dutta-Roy2023" class="csl-entry">
Li, D., Dutta, S., and Roy, V. (2023). <a href="https://doi.org/10.1080/10618600.2022.2074428">Model based screening embedded bayesian variable selection for ultra-high dimensional settings</a>. <em>Journal of Computational and Graphical Statistics</em>, <em>32</em>(1), 61–73.
</div>
<div id="ref-Liang+2008" class="csl-entry">
Liang, F., Paulo, R., Molina, G., Clyde, M. A., and Berger, J. O. (2008). <a href="https://doi.org/10.1198/016214507000001337">Mixtures of g priors for bayesian variable selection</a>. <em>Journal of the American Statistical Association</em>, <em>103</em>(481), 410–423. doi: 10.1198/016214507000001337.
</div>
<div id="ref-Liang+2022" class="csl-entry">
Liang, X., Livingstone, S., and Griffin, J. (2022). <a href="https://doi.org/10.1007/s11222-022-10137-8">Adaptive random neighbourhood informed markov chain monte carlo for high-dimensional bayesian variable selection</a>. <em>Statistics and Computing</em>, <em>32</em>(5), 84.
</div>
<div id="ref-Liang+2023" class="csl-entry">
Liang, X., Livingstone, S., and Griffin, J. (2023). <a href="https://doi.org/10.3390/e25091310">Adaptive MCMC for bayesian variable selection in generalised linear models and survival models</a>. <em>Entropy</em>, <em>25</em>(9).
</div>
<div id="ref-Mitchell-Beauchamp1988" class="csl-entry">
Mitchell, T. J., and Beauchamp, J. J. (1988). <a href="http://www.jstor.org/stable/2290129">Bayesian variable selection in linear regression</a>. <em>Journal of the American Statistical Association</em>, <em>83</em>(404), 1023–1032.
</div>
<div id="ref-Nishimura+2020" class="csl-entry">
Nishimura, A., Dunson, D. B., and Lu, J. (2020). <a href="https://doi.org/10.1093/biomet/asz083">Discontinuous hamiltonian monte carlo for discrete parameters and discontinuous likelihoods</a>. <em>Biometrika</em>, <em>107</em>(2), 365–380.
</div>
<div id="ref-Park-Casella2008" class="csl-entry">
Park, T., and Casella, G. (2008). <a href="https://doi.org/10.1198/016214508000000337">The bayesian lasso</a>. <em>Journal of the American Statistical Association</em>, <em>103</em>(482), 681–686. doi: 10.1198/016214508000000337.
</div>
<div id="ref-Peskun1973" class="csl-entry">
Peskun, P. H. (1973). <a href="https://doi.org/10.1093/biomet/60.3.607">Optimum monte-carlo sampling using markov chains</a>. <em>Biometrika</em>, <em>60</em>(3), 607–612.
</div>
<div id="ref-Piironen+2020" class="csl-entry">
Piironen, J., Paasiniemi, M., and Vehtari, A. (2020). <a href="https://doi.org/10.1214/20-EJS1711"><span class="nocase">Projective inference in high-dimensional problems: Prediction and feature selection</span></a>. <em>Electronic Journal of Statistics</em>, <em>14</em>(1), 2155–2197.
</div>
<div id="ref-Piironen-Vehtari2015" class="csl-entry">
Piironen, J., and Vehtari, A. (2015). <a href="https://arxiv.org/abs/1508.02502">Projection predictive variable selection using stan+r</a>.
</div>
<div id="ref-Piironen-Vehtari2017Choice" class="csl-entry">
Piironen, J., and Vehtari, A. (2017a). <a href="https://proceedings.mlr.press/v54/piironen17a.html"><span class="nocase">On the Hyperprior Choice for the Global Shrinkage Parameter in the Horseshoe Prior</span></a>. In A. Singh and J. Zhu, editors, <em>Proceedings of the 20th international conference on artificial intelligence and statistics</em>,Vol. 54, pages 905–913. PMLR.
</div>
<div id="ref-Piironen-Vehtari2017" class="csl-entry">
Piironen, J., and Vehtari, A. (2017b). <a href="https://doi.org/10.1214/17-EJS1337SI"><span class="nocase">Sparsity information and regularization in the horseshoe and other shrinkage priors</span></a>. <em>Electronic Journal of Statistics</em>, <em>11</em>(2), 5018–5051.
</div>
<div id="ref-Polson-Scott2011" class="csl-entry">
Polson, N. G., and Scott, J. G. (2011). <a href="https://doi.org/10.1093/acprof:oso/9780199694587.003.0017">501Shrink globally, act locally: Sparse bayesian regularization and prediction</a>. In <em>Bayesian statistics 9</em>. Oxford University Press.
</div>
<div id="ref-Polson-Scott2012" class="csl-entry">
Polson, N. G., and Scott, J. G. (2012). <a href="https://doi.org/10.1214/12-BA730"><span class="nocase">On the Half-Cauchy Prior for a Global Scale Parameter</span></a>. <em>Bayesian Analysis</em>, <em>7</em>(4), 887–902.
</div>
<div id="ref-Porwal-Raftery2022" class="csl-entry">
Porwal, A., and Raftery, A. E. (2022). <a href="https://doi.org/10.1073/pnas.2120737119">Comparing methods for statistical inference with model uncertainty</a>. <em>Proceedings of the National Academy of Sciences</em>, <em>119</em>(16), e2120737119.
</div>
<div id="ref-Robbins-Monro1951" class="csl-entry">
Robbins, H., and Monro, S. (1951). <a href="https://www.jstor.org/stable/2236626">A stochastic approximation method</a>. <em>The Annals of Mathematical Statistics</em>, <em>22</em>(3), 400–407.
</div>
<div id="ref-Shang-Clayton2011" class="csl-entry">
Shang, Z., and Clayton, M. K. (2011). <a href="https://doi.org/10.1016/j.jspi.2011.05.002">Consistency of bayesian linear model selection with a growing number of parameters</a>. <em>Journal of Statistical Planning and Inference</em>, <em>141</em>(11), 3463–3474.
</div>
<div id="ref-Tibshirani1996" class="csl-entry">
Tibshirani, R. (1996). <a href="https://doi.org/10.1111/j.2517-6161.1996.tb02080.x">Regression shrinkage and selection via the lasso</a>. <em>Journal of the Royal Statistical Society: Series B (Methodological)</em>, <em>58</em>(1), 267–288.
</div>
<div id="ref-Tierney1998" class="csl-entry">
Tierney, L. (1998). <a href="http://www.jstor.org/stable/2667233">A note on metropolis-hastings kernels for general state spaces</a>. <em>The Annals of Applied Probability</em>, <em>8</em>(1), 1–9.
</div>
<div id="ref-Vehtari+2017" class="csl-entry">
Vehtari, A., Gelman, A., and Gabry, J. (2017). <a href="https://doi.org/10.1007/s11222-016-9696-4">Practical bayesian model evaluation using leave-one-out cross-validation and WAIC</a>. <em>Statistics and Computing</em>, <em>27</em>(5), 1413–1432.
</div>
<div id="ref-West1987" class="csl-entry">
West, M. (1987). <a href="https://doi.org/10.1093/biomet/74.3.646">On scale mixtures of normal distributions</a>. <em>Biometrika</em>, <em>74</em>(3), 646–648.
</div>
<div id="ref-Yang+2016" class="csl-entry">
Yang, Y., Wainwright, M. J., and Jordan, M. I. (2016). <a href="https://doi.org/10.1214/15-AOS1417"><span class="nocase">On the computational complexity of high-dimensional Bayesian variable selection</span></a>. <em>The Annals of Statistics</em>, <em>44</em>(6), 2497–2532.
</div>
<div id="ref-Zanella2020" class="csl-entry">
Zanella, G. (2020). <a href="https://doi.org/10.1080/01621459.2019.1585255">Informed proposals for local MCMC in discrete spaces</a>. <em>Journal of the American Statistical Association</em>, <em>115</em>(530), 852–865.
</div>
<div id="ref-Zanella-Roberts2019" class="csl-entry">
Zanella, G., and Roberts, G. (2019). <a href="https://doi.org/10.1111/rssb.12316">Scalable importance tempering and bayesian variable selection</a>. <em>Journal of the Royal Statistical Society Series B: Statistical Methodology</em>, <em>81</em>(3), 489–517.
</div>
<div id="ref-Zhou+2022" class="csl-entry">
Zhou, Q., Yang, J., Vats, D., Roberts, G. O., and Rosenthal, J. S. (2022). <a href="https://doi.org/10.1111/rssb.12546">Dimension-free mixing for high-dimensional bayesian variable selection</a>. <em>Journal of the Royal Statistical Society Series B: Statistical Methodology</em>, <em>84</em>(5), 1751–1784.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>例えば <span class="citation" data-cites="Barr+2013">(Barr et al., 2013)</span> では検証的仮説検定の設定で，どこまでランダム効果をモデルに入れるかを議論しており，「全部入れるべき」という結論を一定の前提の下で導いている．↩︎</p></li>
<li id="fn2"><p><span class="citation" data-cites="Hahn-Carvalho2015">(Hahn and Carvalho, 2015, p. 436)</span> は local scale mixture と呼んでいる．他にこの観点は <span class="citation" data-cites="Griffin-Brown2017">(Jim E. Griffin and Brown, 2017)</span>, <span class="citation" data-cites="Polson-Scott2012">(Polson and Scott, 2012)</span> でも議論されている．↩︎</p></li>
<li id="fn3"><p>変数減少法やステップワイズ法などのヒューリスティックな方法に対しての「確率的探索法」という名称だったのだと思われる．特に <span class="citation" data-cites="George-McCulloch1993">(George and McCulloch, 1993)</span> ではデータ拡張に基づく Gibbs サンプラーを用いており，その様子が「確率的探索」に見えるのだと思われる．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Bayesian</category>
  <category>Statistics</category>
  <category>R</category>
  <guid>https://162348.github.io/posts/2024/TransDimensionalModels/BayesSelection.html</guid>
  <pubDate>Tue, 10 Dec 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>brms を用いたベイズ重回帰分析</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Survey/BayesRegression.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="はじめに" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">1</span> はじめに</h2>
<p>ベイズ線型回帰分析は多くのデータ解析における「最初の一歩」である．ベイズ回帰分析から始まるベイズのワークフローや，理論的な背景は次稿を参照：</p>
<div id="listing-lst-survey" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1727136000000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1733702400000" data-listing-reading-time-sort="5" data-listing-word-count-sort="861">
<a href="../../../posts/2024/Survey/BayesANOVA.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/House.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズ分散分析のモデル解析
</h5>
<div class="card-subtitle listing-subtitle">
心理学実験を題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-24
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNNQ01DJTJDUiUyQ1N0YW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1715472000000" data-listing-file-modified-sort="1754014114286" data-listing-date-modified-sort="1734480000000" data-listing-reading-time-sort="9" data-listing-word-count-sort="1605">
<a href="../../../posts/2024/Computation/brms.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Computation/brms_files/figure-html/unnamed-chunk-4-1.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> によるベイズ混合モデリング入門
</h5>
<div class="card-subtitle listing-subtitle">
ポアソン混合効果モデルを例に
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-05-12
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1733875200000" data-listing-reading-time-sort="3" data-listing-word-count-sort="453">
<a href="../../../posts/2024/Survey/BDA1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析５
</h5>
<div class="card-subtitle listing-subtitle">
回帰モデルの概観
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>ここではベイズ回帰モデルに変数を増やしていく際の解釈の変化や，変数の選択の問題などの実際的な問題を扱う．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readxl)</span>
<span id="cb1-2">raw_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_excel</span>(path)</span></code></pre></div>
</div>
</section>
<section id="ベイズ線型重回帰" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="ベイズ線型重回帰"><span class="header-section-number">2</span> ベイズ線型重回帰</h2>
<section id="ベイズ単回帰の実行と視覚化" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="ベイズ単回帰の実行と視覚化"><span class="header-section-number">2.1</span> ベイズ単回帰の実行と視覚化</h3>
<!-- 


::: {.cell}

```{.r .cell-code}
library(rstanarm)
options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

fit1 <- stan_glm(
  formula = BMI ~ LAB,
  data = raw_df,
  chains = 4, iter = 5000, cores = 4
)
```
:::

::: {.cell}

```{.r .cell-code}
prior_summary(fit1)
```

::: {.cell-output .cell-output-stdout}

```
Priors for model 'fit1' 
------
Intercept (after predictors centered)
  Specified prior:
    ~ normal(location = 23, scale = 2.5)
  Adjusted prior:
    ~ normal(location = 23, scale = 8.7)

Coefficients
  Specified prior:
    ~ normal(location = 0, scale = 2.5)
  Adjusted prior:
    ~ normal(location = 0, scale = 7.8)

Auxiliary (sigma)
  Specified prior:
    ~ exponential(rate = 1)
  Adjusted prior:
    ~ exponential(rate = 0.29)
------
See help('prior_summary.stanreg') for more details
```


:::
:::

::: {.cell}

```{.r .cell-code}
print(fit1)
```

::: {.cell-output .cell-output-stdout}

```
stan_glm
 family:       gaussian [identity]
 formula:      BMI ~ LAB
 observations: 839
 predictors:   2
------
            Median MAD_SD
(Intercept) 20.7    0.4  
LAB          0.6    0.1  

Auxiliary parameter(s):
      Median MAD_SD
sigma 3.4    0.1   

------
* For help interpreting the printed output see ?print.stanreg
* For info on the priors used see ?prior_summary.stanreg
```


:::
:::


-->
<p>最終的には <img src="https://latex.codecogs.com/png.latex?%0A%5Ctexttt%7BBMI%7D%20=%20%5Cbeta_0%20+%20%5Cbeta_%7B%5Ctexttt%7BLAB%7D%7D%5Ccdot%5Cmathtt%7BLAB%7D%20+%20%5Cbeta_%7B%5Ctexttt%7BLDL%7D%7D%5Ccdot%5Cmathtt%7BLDL%7D%20+%20%5Cbeta_%7B%5Ctexttt%7BLAB:LDL%7D%7D%5Ccdot%5Cmathtt%7BLAB%7D%5Ccdot%5Cmathtt%7BLDL%7D%20+%20%5Cepsilon%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_0%5Csim%5Cmathrm%7Bt%7D(3;%5Cmu_0,3.4),%5Cqquad%5Cepsilon%5Csim%5Cmathrm%7BN%7D(0,%5Csigma%5E2),%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_%7B%5Ctexttt%7BLAB%7D%7D,%5Cbeta_%7B%5Ctexttt%7BLDL%7D%7D,%5Cbeta_%7B%5Ctexttt%7BLAB:LDL%7D%7D%5Csim%5Cmathrm%7BN%7D(0,%5Cinfty),%5Cqquad%5Csigma%5Csim%5Cmathrm%7Bt%7D(3;0,3.4),%0A"> という５つのパラメータを持ったモデルを考えるが，ここではまず１つの説明変数 LAB にのみ注目する．</p>
<p>なお，分散パラメータに出てくる <img src="https://latex.codecogs.com/png.latex?3.4"> の数字は，被説明変数 BMI の標本分散である：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.471758</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(brms)</span>
<span id="cb4-2">model1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb4-3">  BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> LAB</span>
<span id="cb4-4">)</span>
<span id="cb4-5">fit1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb4-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> model1,</span>
<span id="cb4-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb4-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb4-9">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(knitr)</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_prior</span>(</span>
<span id="cb5-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> model1,</span>
<span id="cb5-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df</span>
<span id="cb5-5">))</span></code></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 32%">
<col style="width: 13%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">prior</th>
<th style="text-align: left;">class</th>
<th style="text-align: left;">coef</th>
<th style="text-align: left;">group</th>
<th style="text-align: left;">resp</th>
<th style="text-align: left;">dpar</th>
<th style="text-align: left;">nlpar</th>
<th style="text-align: left;">lb</th>
<th style="text-align: left;">ub</th>
<th style="text-align: left;">source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">b</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">b</td>
<td style="text-align: left;">LAB</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
<tr class="odd">
<td style="text-align: left;">student_t(3, 22.7, 3.4)</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
<tr class="even">
<td style="text-align: left;">student_t(3, 0, 3.4)</td>
<td style="text-align: left;">sigma</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_Intercept"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_LAB"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fixed</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Estimate Est.Error   l-95% CI   u-95% CI     Rhat Bulk_ESS Tail_ESS
Intercept 20.7016164 0.4252379 19.8602962 21.5361855 1.000239 10139.53 7329.774
LAB        0.6106412 0.1044871  0.4069246  0.8194326 1.000457 10303.02 6531.444</code></pre>
</div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctexttt%7BLAB%7D%7D"> の最頻値＝最尤推定量は <img src="https://latex.codecogs.com/png.latex?0.6"> である．これは，LAB が <img src="https://latex.codecogs.com/png.latex?1"> 違う個人の間で BMI の値が約 <img src="https://latex.codecogs.com/png.latex?0.6"> 違うと解釈できる．</p>
<p>例えば LAB が <img src="https://latex.codecogs.com/png.latex?3.0"> の個人の予測される BMI は <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathtt%7BBMI%7D%5Capprox20.7+0.6%5Ctimes3.0=22.5%0A"> となる．</p>
<div class="cell" data-fig-caption="回帰直線のプロット">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB, raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BMI"</span>)</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fixed[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fixed[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-fit1-line" class="quarto-float quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fit1-line-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/fig-fit1-line-1.png" id="fig-fit1-line" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-fit1-line-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
図&nbsp;1
</figcaption>
</figure>
</div>
</div>
</div>
<p>しかしこの図を見ればわかる通り，LAB は BMI の変動の一部しか説明しておらず，上述ような点推定的な議論にどれほど意味があるかは疑問である．</p>
<p>ベイズ回帰では幅を持って結果を理解できるため，その美点を活かさない理由はない．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB, raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BMI"</span>)</span>
<span id="cb10-2">sims <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(fit1)</span>
<span id="cb10-3">sims_to_display <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sims), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb10-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sims_to_display) {</span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(sims[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], sims[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span>
<span id="cb10-6">}</span>
<span id="cb10-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fixed[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fixed[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-pp-check1" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="sec-pp-check1"><span class="header-section-number">2.2</span> モデルのチェック：事後予測分布と残差プロット</h3>
<p>さらにベイズ模型は事後予測分布をプロットし，実際の観測データと比べることで，モデルがデータ生成過程をどれほど反映できているかが瞬時に把握できる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">synthetic_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_predict</span>(fit1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">LAB =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>)</span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(synthetic_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nclass =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BMI"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted BMI for a person with LAB = 3.0"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pp_check</span>(fit1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb12-2">p1</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>事後予測分布のプロットを見ると，モデルが取り逃がしている構造として，BMI の分布が左右で非対称であることがあることがわかる．回帰直線のプロット 図&nbsp;1 を見ても，直線の上側の点の方が裾が広く分散している．</p>
<p>「やせ」と「肥満」は対称ではないのである．</p>
<p>残差をプロットすることでさらに明らかになる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">residuals</span>(fit1)</span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB, res[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Residuals"</span>)</span>
<span id="cb13-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-fit1-res" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fit1-res-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/fig-fit1-res-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fit1-res-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
図&nbsp;2: 残差のプロット
</figcaption>
</figure>
</div>
</div>
</div>
<p>ただし，残差と事後予測分布には，標本内のデータを見ているか，標本外のデータを想定しているかという大きな違いがある．</p>
<p>この２つの結果が乖離している場合，モデルが標本に過適合していることを疑う必要がある．具体的には次節 3 参照．</p>
</section>
<section id="変数の追加による係数の解釈の変化" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="変数の追加による係数の解釈の変化"><span class="header-section-number">2.3</span> 変数の追加による係数の解釈の変化</h3>
<p>ここに新たな変数 LDL を追加すると，LAB の係数 <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctexttt%7BLAB%7D%7D"> は <img src="https://latex.codecogs.com/png.latex?0.6"> から <img src="https://latex.codecogs.com/png.latex?0.5"> に減少する．これはどういう意味だろうか？</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">model2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(model1, BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> LAB <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> LDL)</span>
<span id="cb14-2">fit2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb14-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> model2,</span>
<span id="cb14-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb14-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb14-6">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_Intercept"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_LAB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_LDL"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>一般に係数の追加は層別に当たる．例えばこの結果は，<strong>LDL の値が同じ人の中では</strong> LAB が <img src="https://latex.codecogs.com/png.latex?1"> 違う人の BMI の値が <img src="https://latex.codecogs.com/png.latex?0.5"> 違うと解釈できる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fixed</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Estimate   Est.Error      l-95% CI    u-95% CI     Rhat  Bulk_ESS
Intercept 20.163355017 0.517973058  1.914440e+01 21.17476148 1.000687 12617.051
LAB        0.483922973 0.124983258  2.390836e-01  0.72708676 1.000109  9080.697
LDL        0.008582008 0.004412872 -8.612193e-05  0.01716285 1.000207  9537.469
          Tail_ESS
Intercept 7619.117
LAB       7383.503
LDL       7324.199</code></pre>
</div>
</div>
<p>ここで <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctexttt%7BLDL%7D%7D"> の値が極めて小さいことに気づくかもしれない．これは LAB に比べて LDL の影響が小さいことを意味しない．なぜならばこの２つの変数はスケールが約 <img src="https://latex.codecogs.com/png.latex?10%5E2"> 違うためである．LDL は 100 のスケール，LAB は 1 のスケールである．</p>
<p>説明変数 LAB と LDL のどちらが重要か，どっちをモデルに含めるべきかは全く別の方法で議論する必要がある．</p>
</section>
<section id="sec-standardization" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="sec-standardization"><span class="header-section-number">2.4</span> データの正規化：係数同士の比較</h3>
<p>係数同士の比較をするためには，説明変数のスケールを揃える必要がある．</p>
<p>そこでデータを正規化してみる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb18-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sBMI =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI),</span>
<span id="cb18-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sLAB =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB),</span>
<span id="cb18-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sLDL =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LDL)</span>
<span id="cb18-5">)</span>
<span id="cb18-6"></span>
<span id="cb18-7">model2s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(sBMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sLAB <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sLDL)</span>
<span id="cb18-8">fit2s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb18-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> model2s,</span>
<span id="cb18-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df,</span>
<span id="cb18-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb18-12">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit2s, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_Intercept"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_sLAB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_sLDL"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctexttt%7BLDL%7D%7D"> の方が <img src="https://latex.codecogs.com/png.latex?0"> に近く推定されていることがわかる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit2s)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fixed</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Estimate  Est.Error      l-95% CI   u-95% CI     Rhat  Bulk_ESS
Intercept 0.0002000558 0.03413500 -0.0678288418 0.06679971 1.000381 10219.138
sLAB      0.1549410096 0.03976303  0.0768082214 0.23239875 1.000207  9432.452
sLDL      0.0773993520 0.03996238 -0.0009089375 0.15622134 1.000184  9099.179
          Tail_ESS
Intercept 6757.463
sLAB      7405.609
sLDL      7524.666</code></pre>
</div>
</div>
<p>データを正規化してしまったため，直接的な係数の解釈はできないが，係数を相互に比較できる．</p>
<p>係数の大小を見ることで，LAB の方が有効な説明変数であるように思える．だが元々 LAB は <img src="https://latex.codecogs.com/png.latex?0"> から離れた値だったが，LDL を入れた途端にいずれも <img src="https://latex.codecogs.com/png.latex?0"> にかぶりかけている．これは２つの間に共線型性が存在するためである．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sLAB, df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sLDL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LDL"</span>)</span>
<span id="cb22-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(sLDL <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sLAB, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>()</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>またその他のモデルの性質は変わらない．例えば事後予測分布も変わらない．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gridExtra)</span>
<span id="cb23-2">p2s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pp_check</span>(fit2s, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb23-3">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pp_check</span>(fit2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb23-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid.arrange</span>(p2, p2s, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="交差項の係数の解釈" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="交差項の係数の解釈"><span class="header-section-number">2.5</span> 交差項の係数の解釈</h3>
<p>再び正規化する前のデータに戻る．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">model3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(model2, BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> LAB <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> LDL)</span>
<span id="cb24-2">fit3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb24-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> model3,</span>
<span id="cb24-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb24-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb24-6">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variable =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_Intercept"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_LAB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_LDL"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b_LAB:LDL"</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit3)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fixed</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Estimate   Est.Error     l-95% CI     u-95% CI     Rhat Bulk_ESS
Intercept 18.359567486 1.602638690 15.239030706 21.511927719 1.000538 3653.578
LAB        0.946655585 0.410287745  0.146005654  1.745291095 1.000150 3690.989
LDL        0.023793589 0.013531229 -0.002859942  0.050046848 1.000415 3761.381
LAB:LDL   -0.003753507 0.003173122 -0.009944571  0.002469838 1.000165 3555.572
          Tail_ESS
Intercept 4433.506
LAB       4735.780
LDL       4718.947
LAB:LDL   4255.115</code></pre>
</div>
</div>
<p>交差項を含む線型回帰における係数の解釈はさらに限定的になる．</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctexttt%7BLAB%7D%7D"> は LDL が <img src="https://latex.codecogs.com/png.latex?0"> である人が仮にいたとした場合の，LAB が <img src="https://latex.codecogs.com/png.latex?1"> 違う人の間の BMI の平均的な違いを表す，と解釈できる．（LDL の平均が <img src="https://latex.codecogs.com/png.latex?0"> になるように変数変換をして回帰するともっと自然な解釈ができる）．</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctexttt%7BLAB:LDL%7D%7D"> は片方の係数 <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctexttt%7BLAB%7D%7D"> を固定した際，LDL が <img src="https://latex.codecogs.com/png.latex?1"> だけ違うグループにおける係数 <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctexttt%7BLDL%7D%7D"> との違いを表す．</p>
<p>すなわち交差項の追加は，LDL に依って層別し，それぞれのグループに異なる <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctexttt%7BLAB%7D%7D"> を推定することを可能にする．この点で階層モデリングに似ている．</p>
</section>
<section id="交差項の層別効果の視覚化" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="交差項の層別効果の視覚化"><span class="header-section-number">2.6</span> 交差項の層別効果の視覚化</h3>
<p>交差項 <code>LAB*LDL</code> の追加は，LDL の違うサブグループの間に異なる LAB をフィッティングすることを可能にする．</p>
<p>このことを最もよく見るには，LDL が上半分か下半分かで LAB の係数がどう変わるかを見るのが良い．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LDLcate2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LDL <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LDL), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"High"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Low"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1">model3_cate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(BMI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> LAB <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> LDLcate2)</span>
<span id="cb29-2">fit3_cate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb29-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> model3_cate,</span>
<span id="cb29-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb29-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb29-6">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB, raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BMI"</span>)</span>
<span id="cb30-2">b_hat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit3_cate)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>fixed</span>
<span id="cb30-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(b_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], b_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span>
<span id="cb30-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(b_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], b_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>)</span>
<span id="cb30-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topleft"</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># または "topright", "bottomleft", "bottomright" など</span></span>
<span id="cb30-6">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"High"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Low"</span>),</span>
<span id="cb30-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>),</span>
<span id="cb30-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>LDL が大きいと，LAB の BMI に与える影響は緩やかになることがわかる．LDL の方が LAB の代わりに BMI の増加を説明してしまっているとも考えられる．</p>
<!--

### まとめ

線型回帰において，説明変数の追加は，「他の説明変数を固定したグループ内での」係数の推定に変化する（階層モデリングにつながる見方）．



::: {.cell}

```{.r .cell-code}
model3s <- update(model2s, sBMI ~ sLAB * sLDL)
fit3s <- brm(
  formula = model3s,
  data = df,
  chains = 4, iter = 5000, cores = 4
)
```
:::

::: {.cell}

```{.r .cell-code}
plot(fit3s, variable = c("b_Intercept", "b_sLAB", "b_sLDL", "b_sLAB:sLDL"))
```

::: {.cell-output-display}
![](BayesRegression_files/figure-html/unnamed-chunk-32-1.png){width=672}
:::
:::

::: {.cell}

```{.r .cell-code}
summary(fit3s)$fixed
```

::: {.cell-output .cell-output-stdout}

```
             Estimate  Est.Error     l-95% CI   u-95% CI      Rhat  Bulk_ESS
Intercept  0.01961391 0.03754898 -0.053888391 0.09452453 1.0010878 11368.540
sLAB       0.15684539 0.03976921  0.078153575 0.23599796 1.0002083 10873.281
sLDL       0.08193502 0.03998232  0.003726138 0.16136846 0.9999750  9660.573
sLAB:sLDL -0.03691679 0.03109320 -0.098651142 0.02357867 0.9998178 11541.571
          Tail_ESS
Intercept 6912.316
sLAB      7571.400
sLDL      7330.971
sLAB:sLDL 7521.834
```


:::
:::



全ての係数がほとんど０に近い値になってしまった．

しかし事後予測分布はあまり変わらないようである．



::: {.cell}

```{.r .cell-code}
p3s <- pp_check(fit3s, ndraws = 100)
grid.arrange(p2s, p3s, nrow = 1)
```

::: {.cell-output-display}
![](BayesRegression_files/figure-html/unnamed-chunk-34-1.png){width=672}
:::
:::


-->
</section>
</section>
<section id="sec-model-validation" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-model-validation"><span class="header-section-number">3</span> モデル検証</h2>
<section id="はじめに-1" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="はじめに-1"><span class="header-section-number">3.1</span> はじめに</h3>
<p>残差プロットや事後予測プロットによるモデルの検証は，解析と並行して見てきた．</p>
<p>ここではより詳細に，モデルの予測性能に基づいた検証・比較方法を見る．</p>
<p>交差検証法によるスコア <code>elpd_loo</code> によるモデル比較が一つ推奨される．</p>
</section>
<section id="決定係数" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="決定係数"><span class="header-section-number">3.2</span> 決定係数</h3>
<p>図&nbsp;1 の回帰直線のプロットと 図&nbsp;2 の残差プロットを見ると，残差がまだ構造を持っていることがわかる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">residuals</span>(fit3)</span>
<span id="cb31-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB, res[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Residuals"</span>)</span>
<span id="cb31-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
<div class="cell-output-display">
<div id="fig-fit3-res" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fit3-res-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/fig-fit3-res-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fit3-res-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
図&nbsp;3: fit3 の残差のプロット
</figcaption>
</figure>
</div>
</div>
</div>
<p>この残差は標本分散 <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7B%5Csigma%7D%5E2"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">sigma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(res)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb32-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(sigma)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.394462</code></pre>
</div>
</div>
<p>を持っている．</p>
<p>ひとまず LAB と LDL について回帰をすることで，データの変動がどれほど説明できたかを考えてみよう．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR%5E2:=1-%5Cfrac%7B%5Cwidehat%7B%5Csigma%7D%5E2%7D%7Bs_y%5E2%7D=%5Cfrac%7Bs_y%5E2-%5Cwidehat%7B%5Csigma%7D%5E2%7D%7Bs_y%5E2%7D%0A"></p>
<p>という値は <a href="https://ja.wikipedia.org/wiki/決定係数"><strong>決定係数</strong></a> と呼ばれ，データ <img src="https://latex.codecogs.com/png.latex?y"> の分散 <img src="https://latex.codecogs.com/png.latex?s_y%5E2"> のうち「説明された分散」の割合を表す．<sup>1</sup></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>sigma<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04403279</code></pre>
</div>
</div>
<p>データの変動の <img src="https://latex.codecogs.com/png.latex?4%5C%25"> しか説明できていないことがわかる．</p>
</section>
<section id="ベイズ決定係数" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="ベイズ決定係数"><span class="header-section-number">3.3</span> ベイズ決定係数</h3>
<p>ベイズ決定係数 <span class="citation" data-cites="Gelman+2019">(Andrew Gelman and Vehtari, 2019)</span> は <code>brms</code> パッケージで次のように計算できる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bayes_R2</span>(fit3)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Estimate  Est.Error       Q2.5      Q97.5
R2 0.04734955 0.01373743 0.02254274 0.07643401</code></pre>
</div>
</div>
<p>以上の <img src="https://latex.codecogs.com/png.latex?R%5E2"> の議論では係数を点推定して「残差」を議論していたが，モデルのパラメータ（の関数）である以上，ベイズ推定することもできる．</p>
<p>ベイズ決定係数（の事後予測値）は，事後予測分布からのサンプルを用いて複数回予測値 <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7By%7D_i"> を計算し， <img src="https://latex.codecogs.com/png.latex?%0AR%5E2_%7B%5Ctexttt%7BBayes%7D%7D:=%5Cfrac%7B%5Cmathrm%7BV%7D%5B%5Cwidehat%7By%7D%5D%7D%7B%5Cmathrm%7BV%7D%5B%5Cwidehat%7By%7D%5D+%5Csigma%5E2%7D%0A"> という値で「データの変動のうち説明された割合」を表す．</p>
</section>
<section id="aic" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="aic"><span class="header-section-number">3.4</span> AIC</h3>
<p><span class="citation" data-cites="Akaike74-AIC">(Akaike, 1974)</span> は次のように定義される： <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathtt%7BAIC%7D=-2%5Cbiggr(%5Csup_%5Ctheta%5Clog%20p(y%7C%5Ctheta)%5Cbiggl)+2p.%0A"></p>
<p>第１項は deviance とも呼ばれ，残差を表す．</p>
<p>AIC は新たなデータ点が観測された際の，そのデータ点に対するデビアンス（ある種の損失）の推定量となっており，小さいほどよい．</p>
<p>AIC と同様の推定を，計算機集約的に行う方法に次節の交差検証法がある：</p>
</section>
<section id="交差検証と-elpd" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="交差検証と-elpd"><span class="header-section-number">3.5</span> 交差検証と elpd</h3>
<p>事後予測検証では事後分布と観測を比較したが，よりこの好ましくは新しい（推定に用いていない）データと突き合わせることである．</p>
<p>LOO (Leave-One-Out) 交差検証 <span class="citation" data-cites="Stone1974">(Stone, 1974)</span> では，データを１つだけ抜いてモデルを推定し，このモデルの予測値と実際の値を比較するモデル検証法である．</p>
<p><code>brms</code> パッケージでは <a href="https://mc-stan.org/loo/reference/loo-glossary.html"><code>loo</code> パッケージ</a> を内部で利用して高速に計算することができる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit3)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 10000 by 839 log-likelihood matrix.

         Estimate   SE
elpd_loo  -2220.7 26.7
p_loo         5.6  0.7
looic      4441.4 53.5
------
MCSE of elpd_loo is 0.0.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.0]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>回帰分析において予測値と実際の（省いていた）データの乖離は，AIC を踏襲して事後予測分布のスコア関数で測る <span class="citation" data-cites="Vehtari+2017">(Vehtari et al., 2017, p. 1414)</span>．</p>
<p>elpd (expected log predictive density) は，LOO 交差検証により得る，（省いていた）データの対数尤度の平均である： <span id="eq-def-elpd"><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathrm%7Belpd%7D_%7B%5Ctext%7Bloo%7D%7D:=%5Csum_%7Bi=1%7D%5En%5Clog%20p(y_i%7Cy_%7B-i%7D)=%5Csum_%7Bi=1%7D%5En%5Cint%20p(y_i%7C%5Ctheta)p(%5Ctheta%7Cy_%7B-i%7D)%5C,d%5Ctheta.%0A%5Ctag%7B1%7D"></span></p>
<p>この値が大きいほどモデルの予測が良い．一般に elpd は，一度見たことあるデータ点に対する事後予測スコアよりも低くなる．<sup>2</sup> この際の差は <code>p_loo</code> が測っており，乖離が大きすぎるとモデルがデータに過適合していることを表す．</p>
<p><code>p_loo</code> は有効パラメータ数の（一致）推定量である．今回のモデルには切片項と <code>LAB</code>, <code>LDL</code>, <code>LAB:LDL</code> そして <code>sigma</code> の５つのパラメータがあるが，それより <img src="https://latex.codecogs.com/png.latex?0.6"> だけ大きい値が出ている．</p>
<p>最後の列は情報量規準のスケールにしたものである： <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathtt%7Blooic%7D=-2%5Ctimes%5Cmathrm%7Belpd%7D_%7B%5Ctext%7Bloo%7D%7D.%0A"></p>
<p>一般に LOO-CV は計算が大変であるが，<code>loo</code> パッケージは Pareto Smoothed Importance Sampling (PSIS) <span class="citation" data-cites="Vehtari+2015">(Vehtari et al., 2024)</span> を用いて高速に計算している．</p>
<p><img src="https://latex.codecogs.com/png.latex?k%3E0.7"> の場合はこれがうまくいっていないことを示唆する．この下で <img src="https://latex.codecogs.com/png.latex?%5Cmathtt%7Bp_loo%7D%3Ep"> はモデルの誤特定を示唆する．</p>
</section>
<section id="sec-posterior-predictive-score" class="level3" data-number="3.6">
<h3 data-number="3.6" class="anchored" data-anchor-id="sec-posterior-predictive-score"><span class="header-section-number">3.6</span> 事後予測スコアによるモデル比較</h3>
<p><code>brms</code> パッケージでは <code>loo_compare</code> 関数で２つのモデルの elpd スコアを比較できる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit1), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit2))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     elpd_diff se_diff
fit2  0.0       0.0   
fit1 -0.7       2.1   </code></pre>
</div>
</div>
<p><code>elpd_diff</code> の値は標準偏差と比べて大変に小さい．交差検証の観点からは，<code>LDL</code> の追加は BMI の予測の観点から全く違いがないことがわかる．</p>
</section>
<section id="ベイズワークフロー" class="level3" data-number="3.7">
<h3 data-number="3.7" class="anchored" data-anchor-id="ベイズワークフロー"><span class="header-section-number">3.7</span> ベイズワークフロー</h3>
<p>この elpd を基本としたモデルの比較は極めて強力である．</p>
<p>線型モデルが適切な場合，適切な説明変数を新たに作ったり，不要な説明変数を除去して推定を安定化させることで，最適な予測力を持つ線型モデルが特定できる．</p>
<p><span class="citation" data-cites="Gelman-Hill-Vehtari2020">(Gelman et al., 2020, p. 206)</span> などの解析例も参照．</p>
<p>その際に elpd は，事後予測分布のプロットを見るという視覚的な方法よりも定量的な指標として大活躍することになる．</p>
<p>しかし時には線型性の仮定が不適切であるという仮説・結論に行き着く場合もある．</p>
</section>
</section>
<section id="非線型性への憧憬" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="非線型性への憧憬"><span class="header-section-number">4</span> 非線型性への憧憬</h2>
<section id="はじめに-2" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="はじめに-2"><span class="header-section-number">4.1</span> はじめに</h3>
<p>LAB による BMI への回帰の残差には，左右の非対称性が見られる 2.2．</p>
<p>そして更なる変数 LDL の追加は予測の観点では特に影響がないことがわかった 3.6．</p>
<p>そこでここでは手軽に非線型性を取り入れる方法として，データを変換することを考える．</p>
<p>第 2.4 節でデータを標準化すると回帰モデルの係数の解釈が容易になることみた．</p>
<p>しかしデータの線型変換は線型回帰モデルを変えず，推定には何の影響も与えない．</p>
<p>そこでここでは非線型な変換に注目する．</p>
</section>
<section id="被説明変数の対数変換" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="被説明変数の対数変換"><span class="header-section-number">4.2</span> 被説明変数の対数変換</h3>
<p>線型回帰モデリングにおける最大の仮定は，説明変数の加法性と，<img src="https://latex.codecogs.com/png.latex?y"> への効果の線型性である： <img src="https://latex.codecogs.com/png.latex?%0Ay=%5Cbeta_0+%5Cbeta_1x_1+%5Cbeta_2x_2+%5Ccdots.%0A"></p>
<p>LAB や LDL の BMI への影響が線型であると見るのは相当横暴な仮定である．LAB と LDL が両方高いことが相乗的に BMI を高めるシナリオの方があり得そうである．</p>
<p>BMI も LAB も LDL も正の値しか取らないこともあり，対数変換を考えることは良い第一歩だろう．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1">model1_log <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(model1, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(BMI) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> LAB)</span>
<span id="cb42-2">fit1_log <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb42-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> model1_log,</span>
<span id="cb42-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb42-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb42-6">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">residuals</span>(fit1_log)</span>
<span id="cb43-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>LAB, res[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LAB"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Residuals (on log scale)"</span>)</span>
<span id="cb43-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>残差プロットを見ると，元のスケールでの線型回帰 図&nbsp;2 と比べて非対称性は軽減している．</p>
<!-- 


::: {.cell}

```{.r .cell-code}
pp_check(fit1_log, ndraws = 100)
```

::: {.cell-output-display}
![](BayesRegression_files/figure-html/unnamed-chunk-43-1.png){width=672}
:::
:::


-->
<div class="cell">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(bayesplot)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1">yrep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_predict</span>(fit1_log, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb45-2">p1_log <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_dens_overlay</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(yrep))</span>
<span id="cb45-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid.arrange</span>(p1, p1_log, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>事後予測分布も改善しているのがわかる．</p>
</section>
<section id="変換前後のモデルの比較jacobian-の補正" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="変換前後のモデルの比較jacobian-の補正"><span class="header-section-number">4.3</span> 変換前後のモデルの比較：Jacobian の補正</h3>
<p>ただし，説明変数を対数スケールに変換してしまったので，直接 LOO スコアを比較することはできないことに注意する：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1">loo_fit1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit1)</span>
<span id="cb46-2">loo_fit1_log <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit1_log)</span>
<span id="cb46-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(loo_fit1, loo_fit1_log)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Not all models have the same y variable. ('yhash' attributes do not
match)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         elpd_diff se_diff
fit1_log     0.0       0.0
fit1     -2656.8       8.2</code></pre>
</div>
</div>
<p>実際，<code>fit1</code> の elpd が <img src="https://latex.codecogs.com/png.latex?-2211"> であるのに対し，<code>fit1_log</code> は <img src="https://latex.codecogs.com/png.latex?426"> とスケールが全く違う：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1">loo_fit1_log</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 10000 by 839 log-likelihood matrix.

         Estimate   SE
elpd_loo    435.6 21.8
p_loo         3.0  0.3
looic      -871.3 43.6
------
MCSE of elpd_loo is 0.0.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.6, 1.1]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>しかし elpd の定義 (1) を見ると，<img src="https://latex.codecogs.com/png.latex?y_i"> の密度変換をするために，Jacobian の値を加えれば良いことがわかる．</p>
<p>それぞれの項は <code>loo(fit1_log)$pointwise[,1]</code> に格納されている：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(loo_fit1_log<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pointwise[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 435.6273</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1">loo_fit1_Jacobian <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> loo_fit1_log</span>
<span id="cb53-2">loo_fit1_Jacobian<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pointwise[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> loo_fit1_log<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pointwise[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI)</span>
<span id="cb53-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(loo_fit1_Jacobian<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pointwise[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2189.131</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(loo_fit1_Jacobian, loo_fit1)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Not all models have the same y variable. ('yhash' attributes do not
match)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         elpd_diff se_diff
fit1_log   0.0       0.0  
fit1     -32.0       6.7  </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="背景">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
背景
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?x"> を BMI，<img src="https://latex.codecogs.com/png.latex?y:=%5Clog%20x"> とする．<code>fit1_log</code> の elpd は <img src="https://latex.codecogs.com/png.latex?%0A%5Clog%20p(y)%0A"> によって計算されているところを，変数変換 <img src="https://latex.codecogs.com/png.latex?%0Ap(y)%5C,dy=%5Cfrac%7Bp%5Cleft(%5Clog%20x%5Cright)%7D%7Bx%7D%5C,dx%0A"> を施すことで <img src="https://latex.codecogs.com/png.latex?%0A%5Clog%20p(y)%5Cmapsto%5Clog%20p(%5Clog%20x)-%5Clog%20x%0A"> という関係を得る．</p>
<p>左辺が <code>fit1_log</code> の elpd のスケールであり，右辺の <img src="https://latex.codecogs.com/png.latex?%5Clog%20p(%5Clog%20x)"> の部分が <code>fit1</code> の elpd のスケールである．<img src="https://latex.codecogs.com/png.latex?-%5Clog%20x"> の Jacobian に対応する部分を加える必要がある．</p>
</div>
</div>
</div>
<p>被説明変数に対数変換を施すことで，モデルの予測性能が改善したことがわかる．</p>
</section>
<section id="説明変数の対数変換log-log-モデル" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="説明変数の対数変換log-log-モデル"><span class="header-section-number">4.4</span> 説明変数の対数変換：log-log モデル</h3>
<p>同様に説明変数にも対数変換を施すことができる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1">model1_loglog <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update</span>(model1_log, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(BMI) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(LAB))</span>
<span id="cb58-2">fit1_loglog <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb58-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">formula =</span> model1_loglog,</span>
<span id="cb58-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> raw_df,</span>
<span id="cb58-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb58-6">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1">yrep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">posterior_predict</span>(fit1_loglog, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb59-2">p1_loglog <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_dens_overlay</span>(raw_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>BMI, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(yrep))</span>
<span id="cb59-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid.arrange</span>(p1_log, p1_loglog, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Survey/BayesRegression_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>予測性能はわずかに悪化していることがわかる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit1_log), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit1_loglog))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            elpd_diff se_diff
fit1_log     0.0       0.0   
fit1_loglog -1.8       1.1   </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_R2</span>(fit1_log))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.02481491</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_R2</span>(fit1_loglog))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.02229489</code></pre>
</div>
</div>
<p>しかし log-log モデルの係数は弾力性 (elasticity) としての解釈ができることもあり，解釈性の観点から選好されることがある <span class="citation" data-cites="Gelman-Hill-Vehtari2020">(Gelman et al., 2020, p. 195)</span>．</p>
</section>
<section id="離散変数化" class="level3" data-number="4.5">
<h3 data-number="4.5" class="anchored" data-anchor-id="離散変数化"><span class="header-section-number">4.5</span> 離散変数化</h3>
<p>離散変数の扱いは連続変数よりも難しくなる．基本的に一般化線型モデルの枠組みが必要になる．</p>
<div id="listing-lst-embedding" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1735430400000" data-listing-reading-time-sort="2" data-listing-word-count-sort="382">
<a href="../../../posts/2024/Survey/BDA2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析６
</h5>
<div class="card-subtitle listing-subtitle">
応答が質的変数の場合
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>しかし連続変数間の関数関係が複雑だと思われる場合，ノンパラメトリック手法を求める前に，変数を離散化して解析することも得るものが大きい場合が多い．</p>
<p>このような設定は，離散変数を扱う積極的な理由になる．非線型性を扱うために設定を簡略化するのである．</p>
</section>
</section>
<section id="おわりに" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="おわりに"><span class="header-section-number">5</span> おわりに</h2>
<p>BMI を LAB と LDL から予測する問題を，線型回帰モデルから始めた．</p>
<p>交差項を追加することで，LDL が違う群に対して LAB がどう変わるかの層別の違いを見ることができる．</p>
<p>事後予測分布によるモデルのチェックは残差プロットと同様に，極めて手軽かつ有力なモデル検証の方法である．</p>
<p>これにより関数関係の非線型性が疑われたため，被説明変数 BMI に対して対数変換を施して線型回帰をすると，予測性能の改善が見られた．</p>
<p>事後予測分布のプロットだけでなく，その「よさ」の定量的な指標として交差検証による事後予測スコア elpd <span class="citation" data-cites="Vehtari+2017">(Vehtari et al., 2017)</span> があることを学んだ．</p>
<div id="listing-lst-embedding2" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1733788800000" data-listing-file-modified-sort="1754014117262" data-listing-date-modified-sort="1735948800000" data-listing-reading-time-sort="4" data-listing-word-count-sort="723">
<a href="../../../posts/2024/TransDimensionalModels/BayesSelection.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-embedding2:posts/2024/TransDimensionalModels/BayesSelection.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズ変数選択
</h5>
<div class="card-subtitle listing-subtitle">
BMI データの重線型回帰を題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-10
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>



<div id="quarto-appendix" class="default"><section id="文献紹介" class="level2 appendix" data-number="6"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">6</span> 文献紹介</h2><div class="quarto-appendix-contents">

<p><span class="citation" data-cites="Gelman-Hill-Vehtari2020">(10 節 Gelman et al., 2020)</span> に線型重回帰モデルにおいて，係数の解釈法が丁寧に解説されている．</p>
<p><span class="citation" data-cites="Gelman-Hill-Vehtari2020">(11 節 Gelman et al., 2020)</span> はモデルの検証法を扱っている．</p>
<p><span class="citation" data-cites="Gelman-Hill-Vehtari2020">(Gelman et al., 2020)</span> では基本的に <code>rstanarm</code> パッケージを用いているが，本稿では <code>brms</code> パッケージを用いた．</p>




</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Akaike74-AIC" class="csl-entry">
Akaike, H. (1974). <a href="https://doi.org/10.1109/TAC.1974.1100705">A new look at the statistical model identification</a>. <em>IEEE Transaction on Automatic Control</em>, <em>19</em>(6), 716–723.
</div>
<div id="ref-Gelman+2019" class="csl-entry">
Andrew Gelman, J. G., Ben Goodrich, and Vehtari, A. (2019). <a href="https://doi.org/10.1080/00031305.2018.1549100">R-squared for bayesian regression models</a>. <em>The American Statistician</em>, <em>73</em>(3), 307–309.
</div>
<div id="ref-Gelman-Hill-Vehtari2020" class="csl-entry">
Gelman, A., Hill, J., and Vehtari, A. (2020). <em><a href="https://avehtari.github.io/ROS-Examples/">Regression and other stories</a></em>. Cambridge University Press.
</div>
<div id="ref-Mudholkar2014" class="csl-entry">
Mudholkar, G. S. (2014). <a href="https://doi.org/10.1002/9781118445112.stat00641">Multiple correlation coefficient</a>. In <em>Wiley StatsRef: Statistics reference online</em>. John Wiley &amp; Sons, Ltd.
</div>
<div id="ref-Olkin-Pratt58-UMVestimator-CorrelationCoefficient" class="csl-entry">
Olkin, I., and Pratt, J. W. (1958). Unbiased estimation of certain correlation coefficients. <em>The Annals of Mathematical Statistics</em>, <em>29</em>(1), 201–211.
</div>
<div id="ref-Stone1974" class="csl-entry">
Stone, M. (1974). <a href="http://www.jstor.org/stable/2984809">Cross-validatory choice and assessment of statistical predictions</a>. <em>Journal of the Royal Statistical Society. Series B (Methodological)</em>, <em>36</em>(2), 111–147.
</div>
<div id="ref-Vehtari+2017" class="csl-entry">
Vehtari, A., Gelman, A., and Gabry, J. (2017). <a href="https://doi.org/10.1007/s11222-016-9696-4">Practical bayesian model evaluation using leave-one-out cross-validation and WAIC</a>. <em>Statistics and Computing</em>, <em>27</em>(5), 1413–1432.
</div>
<div id="ref-Vehtari+2015" class="csl-entry">
Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J. (2024). <a href="https://arxiv.org/abs/1507.02646">Pareto smoothed importance sampling</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>決定係数は，回帰が OLS 推定量により推定された場合には <img src="https://latex.codecogs.com/png.latex?Y"> と説明変数のベクトル <img src="https://latex.codecogs.com/png.latex?X"> との間の <strong>重相関係数</strong> とも一致する <span class="citation" data-cites="Mudholkar2014">(Mudholkar, 2014)</span>．<span class="citation" data-cites="Gelman-Hill-Vehtari2020">(Gelman et al., 2020, p. 168)</span> も参照．一般に決定係数は母集団の多重相関係数の一致推定量だと見れる．こうみた場合のバイアスを低減・脱離した値に，自由度調整済み決定係数，<span class="citation" data-cites="Olkin-Pratt58-UMVestimator-CorrelationCoefficient">(Olkin and Pratt, 1958)</span> 推定量などが存在する．↩︎</p></li>
<li id="fn2"><p>訓練に用いたデータ点に関する事後予測スコアはdeviance と関係があり，<img src="https://latex.codecogs.com/png.latex?-2"> を乗じたものは deviance と同じスケールになる <span class="citation" data-cites="Gelman-Hill-Vehtari2020">(Gelman et al., 2020, p. 174)</span>, <span class="citation" data-cites="Vehtari+2017">(Vehtari et al., 2017, p. 1427)</span>．AIC は deviance から <img src="https://latex.codecogs.com/png.latex?2p"> を引いたものである <span class="citation" data-cites="Gelman-Hill-Vehtari2020">(Gelman et al., 2020, p. 175)</span>．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Bayesian</category>
  <category>Statistics</category>
  <category>R</category>
  <guid>https://162348.github.io/posts/2024/Survey/BayesRegression.html</guid>
  <pubDate>Tue, 10 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Survey/Files/elpd.svg" medium="image" type="image/svg+xml"/>
</item>
<item>
  <title>ベイズデータ解析６</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Survey/BDA2.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="関連記事" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="関連記事">関連記事</h2>
<p>回帰モデルや分散分析では，暗黙裡に応答変数が連続であることが仮定されている．</p>
<div id="listing-lst-survey" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1733875200000" data-listing-reading-time-sort="3" data-listing-word-count-sort="453">
<a href="../../../posts/2024/Survey/BDA1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析５
</h5>
<div class="card-subtitle listing-subtitle">
回帰モデルの概観
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1733788800000" data-listing-file-modified-sort="1754014117005" data-listing-date-modified-sort="1733961600000" data-listing-reading-time-sort="5" data-listing-word-count-sort="945">
<a href="../../../posts/2024/Survey/BayesRegression.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/elpd.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> を用いたベイズ重回帰分析
</h5>
<div class="card-subtitle listing-subtitle">
BMI データを題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-10
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1727136000000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1733702400000" data-listing-reading-time-sort="5" data-listing-word-count-sort="861">
<a href="../../../posts/2024/Survey/BayesANOVA.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/House.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズ分散分析のモデル解析
</h5>
<div class="card-subtitle listing-subtitle">
心理学実験を題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-24
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>本節では質的な変数，特に順序構造がある離散変数のモデリングを考える．このようなものを <strong>順序応答</strong> (ordinal response) という．</p>
<p>このようなデータには，多くの場合背後に <strong>連続潜在変数</strong> を仮定してモデリングを行う．</p>
<p>その結果，潜在変数の存在が Gibbs サンプラーの構成を容易にする．</p>
</section>
<section id="項モデル" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="項モデル"><span class="header-section-number">1</span> ２項モデル</h2>
<section id="はじめに" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">1.1</span> はじめに</h3>
<p><img src="https://latex.codecogs.com/png.latex?0,1"> の確率変数の分布は，Bernoulli 分布 <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BBer%7D(p)=%5Cmathrm%7BBin%7D(1,p)"> によって記述できる．</p>
<p>この際，パラメータ <img src="https://latex.codecogs.com/png.latex?p"> を代理の応答変数として回帰分析がなされることになる．</p>
<p>多くの場合，リンク関数 <img src="https://latex.codecogs.com/png.latex?g"> に関して，<img src="https://latex.codecogs.com/png.latex?g(p)"> を線型の予測子 <img src="https://latex.codecogs.com/png.latex?%5Cbeta%5E%5Ctop%20X"> で回帰する．Bernoulli 分布は指数型分布族の例であるため，このようなモデルは <strong>一般化線型モデル</strong> の例になる．</p>
</section>
<section id="ロジスティックモデル" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="ロジスティックモデル"><span class="header-section-number">1.2</span> ロジスティックモデル</h3>
<p>仮に変数 <img src="https://latex.codecogs.com/png.latex?y_i%5Csim%5Cmathrm%7BBer%7D(p)"> に応じて， <img src="https://latex.codecogs.com/png.latex?%0AX_i%7CY_i=i%5Csim%5Coperatorname%7BN%7D(%5Cmu_i,%5Csigma%5E2),%5Cqquad%20i%5Cin%5C%7B0,1%5C%7D%0A"> として説明変数 <img src="https://latex.codecogs.com/png.latex?X_i"> が決まっていたとする．</p>
<p>このような状況で，<img src="https://latex.codecogs.com/png.latex?X_i"> はある <img src="https://latex.codecogs.com/png.latex?%5Calpha,%5Cbeta"> に関して次のロジットモデルを満たす：<sup>1</sup> <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7Blogit%7D(p_i)=%5Calpha+%5Cbeta%20x_i.%0A"></p>
</section>
<section id="sec-latent-variable" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="sec-latent-variable"><span class="header-section-number">1.3</span> 潜在変数解釈</h3>
<p><img src="https://latex.codecogs.com/png.latex?P(%5Cmu,%5Csigma%5E2)"> を正規分布やロジスティック分布などの対称な分布，<img src="https://latex.codecogs.com/png.latex?F"> を <img src="https://latex.codecogs.com/png.latex?P(0,1)"> の分布関数とする．このとき，プロビットまたはロジスティックモデル <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5BY_i=1%7CX_i%5D=F(X_i%5E%5Ctop%5Cbeta)%0A"> は，潜在変数 <img src="https://latex.codecogs.com/png.latex?Y_i%5E*"> が存在して <span id="eq-latent-logistic"><img src="https://latex.codecogs.com/png.latex?%0AY_i=1_%7B%5Cmathbb%7BR%7D_+%7D(Y_i%5E*),%5Cqquad%20Y_i%5E*%5Csim%20P(X_i%5E%5Ctop%5Cbeta,1)%0A%5Ctag%7B1%7D"></span> として結果が決まっているものとも解釈できる．これは <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5BY_i=1%7CX_i%5D=%5Coperatorname%7BP%7D%5BY_i%5E*%3E0%7CX_i%5D=%5Coperatorname%7BP%7D%5B-U%5Cle%20X_i%5E%5Ctop%5Cbeta%5D,%5Cqquad%20U%5Csim%20P(0,1),%0A"> が成り立つためである．</p>
<p>この潜在変数 <img src="https://latex.codecogs.com/png.latex?Y_i%5E*"> は単位 <img src="https://latex.codecogs.com/png.latex?i%5Cin%5BN%5D"> の潜在的な尺度として解釈できる．これを用いて因子分析様の解析を行う例には <a href="../../../posts/2024/TransDimensionalModels/IdealPoint.html">理想点推定</a> もある．</p>
<div id="listing-lst-ideal" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-2">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1721088000000" data-listing-file-modified-sort="1754014117272" data-listing-date-modified-sort="1727827200000" data-listing-reading-time-sort="5" data-listing-word-count-sort="829">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/IdeologyPosition.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
理想点解析・多次元展開法・項目応答理論
</h5>
<div class="card-subtitle listing-subtitle">
空間モデルの特定を目指して
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-07-16
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ1I=" data-listing-date-sort="1727827200000" data-listing-file-modified-sort="1754014117272" data-listing-date-modified-sort="1734825600000" data-listing-reading-time-sort="28" data-listing-word-count-sort="5498">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/IPE_experiment.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
理想点解析のハンズオン
</h5>
<div class="card-subtitle listing-subtitle">
<code>MCMCpack</code> パッケージとオリジナル <code>Stan</code> コードを使って
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-10-02
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>一方で <img src="https://latex.codecogs.com/png.latex?Y_i%5E*"> の存在は Gibbs サンプラーの構成を容易にする <span class="citation" data-cites="Albert-Chib1993">(Albert and Chib, 1993)</span>．</p>
<p><img src="https://latex.codecogs.com/png.latex?F"> を <img src="https://latex.codecogs.com/png.latex?t">-分布とした場合，これを robit モデル <span class="citation" data-cites="Liu2004-robit">(Liu, 2004)</span> という <span class="citation" data-cites="Gelman-Hill-Vehtari2020">(15.6 節 Gelman et al., 2020)</span>．<img src="https://latex.codecogs.com/png.latex?t"> 分布の自由度を無限大にした場合が probit モデルに相当する．</p>
<p>第 2.3 節でまた別の，効用関数による潜在変数表現を扱う．</p>
</section>
<section id="順序応答" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="順序応答"><span class="header-section-number">1.4</span> 順序応答</h3>
<p>前節 1.3 の潜在変数解釈は容易に２値応答以外の場合に拡張できる．その結果多項モデルを用いたソフトマックス回帰 2.2 などとは別のアプローチが，多値順序応答に対して可能になる．</p>
<p><img src="https://latex.codecogs.com/png.latex?y%5Cin%20n+1:=%5C%7B0,1,%5Ccdots,n%5C%7D"> という順序を持った順序応答の場合でも <img src="https://latex.codecogs.com/png.latex?%0A%5Cchi(u)=1_%7B(c_0,%5Cinfty)%7D(u)+1_%7B(c_1,%5Cinfty)%7D(u)+%5Ccdots+1_%7B(c_n,%5Cinfty)%7D(u)%0A"> という階段関数を用いて <img src="https://latex.codecogs.com/png.latex?%0AY_i=%5Cchi(Y_i%5E*),%5Cqquad%20Y_i%5E*%5Csim%20P(X_i%5E%5Ctop%5Cbeta,1)%0A"> というデータ生成過程を想定できる．</p>
<p>これはそのまま <strong>順序多項回帰</strong> (ordered multinomial regression) <span class="citation" data-cites="Walker-Duncan1967">(Walker and Duncan, 1967)</span> に相当する．</p>
<p>この場合 <img src="https://latex.codecogs.com/png.latex?c_0=0"> とし，それに応じて <img src="https://latex.codecogs.com/png.latex?Y_i%5E*%5Csim%20P(X_i%5E%5Ctop%5Cbeta-c_0,1)"> とする径数付けを採用する場合も多い．</p>
<p>ベイズ推論は <img src="https://latex.codecogs.com/png.latex?%5Cchi"> を特徴付ける点 <img src="https://latex.codecogs.com/png.latex?(c_0,c_1,%5Ccdots,c_n)"> 上に事前分布を置くことで実行できるが，<strong>順位尤度</strong> (rank likelihood) を通じた議論により，<img src="https://latex.codecogs.com/png.latex?g"> を特定せずとも Gibbs サンプラーによる推論が可能である <span class="citation" data-cites="Hoff2009">(Section 12.1.2 Hoff, 2009)</span>．</p>
</section>
<section id="sec-separation" class="level3" data-number="1.5">
<h3 data-number="1.5" class="anchored" data-anchor-id="sec-separation"><span class="header-section-number">1.5</span> 識別可能性と分離</h3>
<p>線型回帰において，<a href="../../../posts/2024/Survey/BDA1.html#sec-collinearity">共線型性</a> があると識別可能性が失われる．ロジスティック回帰にはもう一つ識別不可能性の典型的な原因がある．</p>
<p>多くの点推定手法において，説明変数の線型変換が極めて強力な説明変数になる場合，やはり「正解」が何個も存在する状況が現れるため，モデルの非識別性が暗黙のうちに問題になる．これを <strong>分離</strong> (separation) という <span class="citation" data-cites="BDA">(Gelman et al., 2014, p. 412)</span>．</p>
<p>特に最尤推定法，一様事前分布を持ったベイズ推定は不安定になるが，このような場合でも裾の重い事前分布を採用することでベイズ推論が安定的に実行可能である（同様にして正則化を加えた最尤推定も可能である） <span class="citation" data-cites="Gelman-Hill2006">(Gelman and Hill, 2006, p. 104)</span>．</p>
<p>特に係数に（互いに独立な） <img src="https://latex.codecogs.com/png.latex?t">-分布 <img src="https://latex.codecogs.com/png.latex?t(%5Cnu,0,s)"> を仮定する，ロバスト性を意識した設定がデフォルトと理解されている <span class="citation" data-cites="BDA">(Gelman et al., 2014, p. 412)</span>．</p>
<p>ただし，<img src="https://latex.codecogs.com/png.latex?%5Cnu,s"> は説明変数のスケールに合わせてなるべく無情報になるように設定される．<img src="https://latex.codecogs.com/png.latex?s%5Cto%5Cinfty"> の極限が一様分布になり，分離の問題にセンシティブになっていく．</p>
<p><img src="https://latex.codecogs.com/png.latex?g(%5Cmu)=:%5Ctheta"> のそれぞれの値に関して，成功試行と失敗試行が同数現れる尤度は <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Be%5E%7B%5Ctheta/2%7D%7D%7B1+e%5E%5Ctheta%7D"> となり，これは <img src="https://latex.codecogs.com/png.latex?t(7,0,2.5)"> でよく近似される．</p>
<p><img src="https://latex.codecogs.com/png.latex?t(1,0,2.5)"> から <img src="https://latex.codecogs.com/png.latex?t(7,0,2.5)"> はいずれも <img src="https://latex.codecogs.com/png.latex?%5B-5,5%5D"> に多くの重みを持つが，<img src="https://latex.codecogs.com/png.latex?%5Cnu=1"> に近いほど裾が重くなる．<img src="https://latex.codecogs.com/png.latex?g(%5Cmu)"> のスケールで <img src="https://latex.codecogs.com/png.latex?+5"> をすることは，確率を <img src="https://latex.codecogs.com/png.latex?0.01"> から <img src="https://latex.codecogs.com/png.latex?0.5"> にすることに等しいため，切片項への <img src="https://latex.codecogs.com/png.latex?t">-事前分布は <img src="https://latex.codecogs.com/png.latex?%5Cmu%5Cin%5B0.01,0.99%5D"> を強く仮定していることは含意する．</p>
</section>
<section id="ベイズ計算" class="level3" data-number="1.6">
<h3 data-number="1.6" class="anchored" data-anchor-id="ベイズ計算"><span class="header-section-number">1.6</span> ベイズ計算</h3>
<p>一般に二項回帰モデルはベイズ計算法の良いベンチマークになる．</p>
<p>大規模なモデルでは事前調整ありの期待伝搬と乱歩 MH が強いが，Gibbs サンプラーや SMC サンプラーも十分良い性能を示す一方で，NUTS などの HMC ベースの手法は苦しむという <span class="citation" data-cites="Chopin-Ridgway2017">(Chopin and Ridgway, 2017)</span>．</p>
<p>特に説明変数の次元 <img src="https://latex.codecogs.com/png.latex?p"> が大きい場合の事後分布サンプリングはまだまだ難しいことが知られている．</p>
</section>
<section id="分散分析" class="level3" data-number="1.7">
<h3 data-number="1.7" class="anchored" data-anchor-id="分散分析"><span class="header-section-number">1.7</span> 分散分析</h3>
<p><span class="citation" data-cites="BDA">(Gelman et al., 2014, p. 423)</span> 16.5 節は良い例である．アメリカ合衆国における国民の投票行動をロジットリンクにより二項モデルで一般化線型回帰をしている．Bayes ANOVA により人種による大きな効果と同時に，人種と州の強い交差効果が発見できている．</p>
</section>
<section id="選択モデル" class="level3" data-number="1.8">
<h3 data-number="1.8" class="anchored" data-anchor-id="選択モデル"><span class="header-section-number">1.8</span> 選択モデル</h3>
<p>計量経済学の分野で古くから使われている潜在変数表現 1.3 の拡張として，<strong>選択モデル</strong> (choice model) がある．</p>
<p>これに関しては <a href="../../../posts/2024/Survey/BDA3.html#sec-choice-model">階層ロジスティックモデルの稿</a> で詳しく扱う．</p>
<div id="listing-lst-embed" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733961600000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1734048000000" data-listing-reading-time-sort="2" data-listing-word-count-sort="295">
<a href="../../../posts/2024/Survey/BDA3.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-embed:posts/2024/Survey/BDA3.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析７
</h5>
<div class="card-subtitle listing-subtitle">
ベイズ階層モデル
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-12
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
</section>
<section id="多項モデル" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="多項モデル"><span class="header-section-number">2</span> 多項モデル</h2>
<section id="はじめに-1" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="はじめに-1"><span class="header-section-number">2.1</span> はじめに</h3>
<p>順序応答 <img src="https://latex.codecogs.com/png.latex?y%5Cin%5C%7B1,%5Ccdots,k%5C%7D"> の場合，<img src="https://latex.codecogs.com/png.latex?y"> がカウントを表す場合は Poisson モデル，複数回繰り返される独立試行の成功回数である場合は二項モデルが考えられる．</p>
<p>一方で多項モデル（正確にはカテゴリカルモデル） <img src="https://latex.codecogs.com/png.latex?%0AY%5Csim%5Coperatorname%7BCat%7D(%5Calpha_1,%5Ccdots,%5Calpha_k),%5Cqquad%5Csum_%7Bj=1%7D%5Ek%5Calpha_j=1,%0A"> も想定できる．<img src="https://latex.codecogs.com/png.latex?y"> が全く構造を持たない名目 (nominal) 応答である場合，ほぼ唯一の選択である．</p>
</section>
<section id="sec-softmax-regression" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="sec-softmax-regression"><span class="header-section-number">2.2</span> 名目応答に対する多項モデル</h3>
<p>名目応答が <img src="https://latex.codecogs.com/png.latex?k"> 次元ベクトル <img src="https://latex.codecogs.com/png.latex?y_i%5Cin%5Cmathbb%7BN%7D%5Ek"> の形で与えられている場合， <img src="https://latex.codecogs.com/png.latex?%0Ay_i%5Csim%5Cmathrm%7BMult%7D(n_i;%5Calpha_%7Bi1%7D,%5Ccdots,%5Calpha_%7Bik%7D),%5Cqquad%5Csum_%7Bj=1%7D%5Ek%5Calpha_%7Bij%7D=1,%0A"> というモデルを想定できる．<img src="https://latex.codecogs.com/png.latex?n_i%5Cequiv1"> の場合，応答を one-hot 表現にしたカテゴリカルモデルに対応する．</p>
<p>リンク関数 <img src="https://latex.codecogs.com/png.latex?g"> は，特定のカテゴリ <img src="https://latex.codecogs.com/png.latex?j=1"> を <strong>基準</strong> (reference) として <img src="https://latex.codecogs.com/png.latex?g(%5Calpha):=%5Clog%5Cfrac%7B%5Calpha%7D%7B%5Calpha_%7Bi1%7D%7D"> と定めることが多い： <img src="https://latex.codecogs.com/png.latex?%0A%5Clog%5Cfrac%7B%5Calpha_%7Bij%7D%7D%7B%5Calpha_%7Bi1%7D%7D=X_i%5Cbeta%5E%7B(j)%7D.%0A"> これを <strong>多項ロジスティック回帰</strong> (multinomial logistic regression) <span class="citation" data-cites="Ding2024LinearModels">(Ding, 2024, p. 228)</span> または <strong>ソフトマックス回帰</strong> (softmax regression) <span class="citation" data-cites="Kruschke2015">(Kruschke, 2015, p. 650)</span> という： <img src="https://latex.codecogs.com/png.latex?%0A%5Calpha_%7Bij%7D=%5Coperatorname%7Bsoftmax%7D(X_i%5Cbeta%5E%7B(j)%7D)=%5Cfrac%7Be%5E%7BX_i%5Cbeta%5E%7B(j)%7D%7D%7D%7B%5Csum_%7Bl=1%7D%5Eke%5E%7BX_i%5Cbeta%5E%7B(l)%7D%7D%7D,%5Cqquad%20%5Cbeta%5E%7B(1)%7D=0.%0A"></p>
<p>係数は，説明変数が <img src="https://latex.codecogs.com/png.latex?1"> 単位増加した際の，参照カテゴリ <img src="https://latex.codecogs.com/png.latex?j=1"> に対する対数オッズ比の変化を表す．</p>
<p>一方で条件付きロジスティック回帰 (conditional logistic regression) なる方法もある <span class="citation" data-cites="Kruschke2015">(22.2節 Kruschke, 2015, pp. 655–)</span>．</p>
</section>
<section id="sec-utility" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="sec-utility"><span class="header-section-number">2.3</span> 効用による表現</h3>
<p>多項ロジスティックモデルも潜在変数解釈 1.3 が可能である．</p>
<p><img src="https://latex.codecogs.com/png.latex?k"> 次元の標準 Gumbel 分布に従う誤差 <img src="https://latex.codecogs.com/png.latex?%5Cepsilon_%7Bi-%7D%5Cin%5Cmathbb%7BR%7D%5Ek"> に関して， <img src="https://latex.codecogs.com/png.latex?%0AU_%7Bil%7D:=%5Cbeta_l%5E%5Ctop%20X_l+%5Cepsilon_%7Bil%7D,%5Cqquad%20l%5Cin%5Bk%5D,%0A"> を潜在的な効用とし， <img src="https://latex.codecogs.com/png.latex?%0AY_i:=%5Coperatorname*%7Bargmax%7D_%7Bl%5Cin%5Bk%5D%7DU_%7Bil%7D%0A"> によって応答が定まると見ることができる <span class="citation" data-cites="McFadden1974">(McFadden, 1974)</span>．</p>
<p>ただしこの表示からはっきりわかるように，各選択肢を選ぶ効用は他の選択肢とは独立に決まることが仮定されている．これを IIA (Independence of Irrelevant Alternatives) ともいう．</p>
<p>このような仮定は，文脈効果（「選択肢セットの配置によって消費者の選好する選択肢が容易に変化する」 <span class="citation" data-cites="竹内真登-猪狩良介2022">(竹内真登 and 猪狩良介, 2022)</span> 現象）を主な関心とするマーケティングの分野では非常に不適当なものになる．</p>
</section>
<section id="順序応答に対する多項モデル" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="順序応答に対する多項モデル"><span class="header-section-number">2.4</span> 順序応答に対する多項モデル</h3>
<p>応答 <img src="https://latex.codecogs.com/png.latex?y_i%5Cin%5C%7B1,%5Ccdots,k%5C%7D"> に自然な順序がある場合，カテゴリ確率 <img src="https://latex.codecogs.com/png.latex?%5Calpha_%7Bi1%7D,%5Ccdots,%5Calpha_%7Bik%7D"> の代わりに累積確率 <img src="https://latex.codecogs.com/png.latex?%0A%5Cpi_%7Bij%7D:=%5Csum_%7Bl%5Cle%20j%7D%5Calpha_%7Bil%7D=%5Coperatorname%7BP%7D%5BY_i%5Cle%20j%5D%0A"> を考え，モデルにその順序構造を自然に伝えることができる．</p>
<p>この場合リンク関数はロジットやプロビットが使える： <img src="https://latex.codecogs.com/png.latex?%0A%5Clog%5Cfrac%7B%5Cpi_%7Bij%7D%7D%7B1-%5Cpi_%7Bij%7D%7D=X_i%5Cbeta%5E%7B(j)%7D.%0A"> <img src="https://latex.codecogs.com/png.latex?%5Cbeta%5E%7B(j)%7D%5Cequiv%5Cbeta"> と取ることも多い．</p>
<p>このモデルを，<img src="https://latex.codecogs.com/png.latex?g"> がロジットである場合順序ロジスティック回帰 (ordinal / ordered logistic regression) <span class="citation" data-cites="McCullagh1980">(McCullagh, 1980)</span> といい <span class="citation" data-cites="Kruschke2015">(Kruschke, 2015, p. 671)</span>，<img src="https://latex.codecogs.com/png.latex?g"> がプロビットである場合順序プロビット回帰 (ordered probit regression) という．</p>
<p>異なるパラメータ付け <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7Blogit%7D(%5Cpi_%7Bij%7D)=%5Cbeta_0%5E%7B(j)%7D-X_i%5Cbeta%0A"> を用いた場合，これを <strong>比例オッズロジットモデル</strong> (proportional odds logit model) ともいう <span class="citation" data-cites="Ding2024LinearModels">(Ding, 2024, p. 232)</span>．</p>
</section>
<section id="poisson-モデル" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="poisson-モデル"><span class="header-section-number">2.5</span> Poisson モデル</h3>
<p>応答が <img src="https://latex.codecogs.com/png.latex?%5C%7B1,%5Ccdots,k%5C%7D"> カテゴリのカウント <img src="https://latex.codecogs.com/png.latex?y=(y_1,%5Ccdots,y_k)"> である場合， <img src="https://latex.codecogs.com/png.latex?%0Ay_i%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7D%5Cmathrm%7BPois%7D(%5Clambda_i)%0A"> というモデルを想定できる．</p>
<p>カウント総数 <img src="https://latex.codecogs.com/png.latex?n:=%5Csum_%7Bi=1%7D%5Eky_i"> が既知である場合，これに関して条件付けると <img src="https://latex.codecogs.com/png.latex?%0Ay%5Cbigg%7C%5Csum_%7Bi=1%7D%5Eky_i=n%5Csim%5Cmathrm%7BMult%7D(n;%5Calpha_1,%5Ccdots,%5Calpha_k),%5Cqquad%5Calpha_i:=%5Cfrac%7B%5Clambda_i%7D%7B%5Csum_%7Bj=1%7D%5Ek%5Clambda_j%7D%0A"> という周辺モデルを想定したことになる．</p>
<p>リンク関数には対数関数 <img src="https://latex.codecogs.com/png.latex?g=%5Clog"> を用いることが多い．</p>
</section>
<section id="トーナメントデータ" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="トーナメントデータ"><span class="header-section-number">2.6</span> トーナメントデータ</h3>
<p>一度に２人の単位が勝負をし，どちらが勝利したかのデータに対する標準的なモデルに，<span class="citation" data-cites="Bradley-Terry1952">(Bradley and Terry, 1952)</span> モデルがある．国際チェス連盟や欧州囲碁連盟で選手のランクづけにも採用されている <span class="citation" data-cites="Hastie-Tibshirani1998">(Hastie and Tibshirani, 1998)</span>．</p>
<p>このモデルでは各プレイヤーに能力パラメータ <img src="https://latex.codecogs.com/png.latex?%5Calpha_i"> を与え，能力の差のロジスティック関数 <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5Bi%5C;%5Ctext%7Bdefeats%7D%5C;j%5D=%5Cfrac%7Be%5E%7B%5Calpha_i-%5Calpha_j%7D%7D%7B1+e%5E%7B%5Calpha_i-%5Calpha_j%7D%7D%0A"> という確率で勝敗が決まるとする．<img src="https://latex.codecogs.com/png.latex?%5Clambda_i:=e%5E%7B%5Calpha_i%7D"> というパラメータづけもよく用いられる．</p>
<p>このモデルは「勝利」「引き分け」「敗北」の３応答に対する確率モデルを調節することで，引き分け <span class="citation" data-cites="Rao-Kupper1967">(Rao and Kupper, 1967)</span> や先手有利 <span class="citation" data-cites="Davidson-Beaver1977">(Davidson and Beaver, 1977)</span>, <span class="citation" data-cites="Agresti12-CategoricalData">(Agresti, 2012)</span> などの情報も取り入れられるように簡単に拡張できる．</p>
<p>このように２値応答ではなく多値応答とみても，前節の Poisson モデルの定式化に帰着させることで，一般化線型モデリングの枠組みに合流させることができる <span class="citation" data-cites="BDA">(Gelman et al., 2014, pp. 427–428)</span>．</p>
</section>
<section id="順位データ" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="順位データ"><span class="header-section-number">2.7</span> 順位データ</h3>
<p>ランキングデータは，トーナメントのような常に１対１比較のみを通じて情報が得られるわけではない．多者比較 (multiple comparison) も取り入れた Bradley-Terry モデルより一般的なものが <span class="citation" data-cites="Plackett1975">(Plackett, 1975)</span>-<span class="citation" data-cites="Luce1959">(Luce, 1959)</span> モデルである．</p>
<p>Plackett-Luce モデルでは，参加者 <img src="https://latex.codecogs.com/png.latex?%5BK%5D:=%5Cleft%5C%7B1,%5Ccdots,K%5Cright%5C%7D"> の強さに当たる潜在変数 <img src="https://latex.codecogs.com/png.latex?%5Clambda_k%3E0"> を導入し，これに比例した「優勝」確率を持つとする．そして順位の決定は，参加者のプールから「勝ち抜け」の１人を決定する独立試行の繰り返しと見て， <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5BY=y%7C%5Clambda%5D=%5Cprod_%7Bj=1%7D%5E%7BK-1%7D%5Cfrac%7B%5Clambda_%7By_j%7D%7D%7B%5Csum_%7Bl=j%7D%5EK%5Clambda_%7By_l%7D%7D%0A"> としてモデリングする．</p>
<p>このモデルは，「陽の目を見る瞬間」 <img src="https://latex.codecogs.com/png.latex?%0AW_k%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7D%5Coperatorname%7BExp%7D(%5Clambda_k)%0A"> という到着時刻があり，この時刻の早さで順位が決まる <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BP%7D%5BW_%7By_1%7D%3C%5Ccdots%3CW_%7By_K%7D%7C%5Clambda%5D=%5Coperatorname%7BP%7D%5BY=y%7C%5Clambda%5D=%5Cprod_%7Bj=1%7D%5E%7BK-1%7D%5Cfrac%7B%5Clambda_%7By_j%7D%7D%7B%5Csum_%7Bl=j%7D%5EK%5Clambda_%7By_l%7D%7D%0A"> という潜在変数表現を持つ．これは Thurstone 表現 <span class="citation" data-cites="Thurstone1927">(Thurstone, 1927)</span>，またはランダム効用モデルと呼ばれる <span class="citation" data-cites="Diaconis1988">(Chapter 9 Diaconis, 1988, p. 167)</span>．</p>
<p>このような潜在変数表現を元にした MM アルゴリズム <span class="citation" data-cites="Hunter2004">(Hunter, 2004)</span> や Gibbs サンプラー <span class="citation" data-cites="Caron-Doucet2012">(Caron and Doucet, 2012)</span> に基づく推論法が存在する．<code>PlackettLuce</code> パッケージ <span class="citation" data-cites="Turner+2020">(Turner et al., 2020)</span> も参照．</p>
<p>さらに Plackett-Luce モデルで引き分けを許すように拡張したものが Gibbs サンプラーとともに <span class="citation" data-cites="Henderson2024">(Henderson, 2024)</span> で提案されている．順位データとレーティング（点数付け）のデータを同時に扱うことができるような拡張が <span class="citation" data-cites="Pearce-Erosheva2025">(Pearce and Erosheva, 2025)</span> で提案されている．</p>
</section>
<section id="対数線型モデル" class="level3" data-number="2.8">
<h3 data-number="2.8" class="anchored" data-anchor-id="対数線型モデル"><span class="header-section-number">2.8</span> 対数線型モデル</h3>
<p><img src="https://latex.codecogs.com/png.latex?y"> も <img src="https://latex.codecogs.com/png.latex?x"> も名目応答である場合，これは分割表解析の問題になる．</p>
<p>この際には <a href="https://en.wikipedia.org/wiki/Log-linear_analysis"><strong>対数線型モデル</strong></a> (log-linear model) も考えられる．</p>
<p>それぞれのセルに Poisson モデルをおき，そのパラメータを代理応答変数として，対数リンクにより一般化線型回帰を行うものである．</p>
<p>このモデルは，サンプルサイズ <img src="https://latex.codecogs.com/png.latex?N"> が既知の場合などの下では，周辺分布に多項モデルをおくことに等価である <span class="citation" data-cites="Yates1934">(Yates, 1934)</span>．</p>
<p>対数線型モデルは分割表解析だけでなく，<a href="../../../posts/2024/Survey/Survey3.html#sec-MI">多重代入法</a> などの欠測データ解析にも応用される．</p>
</section>
</section>
<section id="コピュラモデル" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="コピュラモデル"><span class="header-section-number">3</span> コピュラモデル</h2>
<section id="はじめに-2" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="はじめに-2"><span class="header-section-number">3.1</span> はじめに</h3>
<p>以上の質的変数のモデルは，いずれも潜在的な連続変数の離散化としてデータを理解するものであった．</p>
<p>仮にこの潜在変数により興味がある場合，この潜在変数をより具体的に，特にその相関構造をモデリングしたいということになる．</p>
<p><span class="citation" data-cites="Lopez-Paz+2013">(Lopez-Paz et al., 2013)</span></p>
</section>
</section>



<div id="quarto-appendix" class="default"><section id="文献紹介" class="level2 appendix" data-number="4"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">4</span> 文献紹介</h2><div class="quarto-appendix-contents">

<p><span class="citation" data-cites="BDA">(Gelman et al., 2014)</span> の 16 章で一般化線型モデルが扱われている．<span class="citation" data-cites="Kruschke2015">(Kruschke, 2015)</span> はさらに詳しく，22 章で名目応答，23 章で順序応答，24 章でカウントデータを扱っている．</p>
<p><span class="citation" data-cites="Hoff2009">(12 章 Hoff, 2009)</span> にて正規コピュラモデルが ordinal probit モデルの，潜在変数を多次元に拡張した場合として導入されている．</p>
<p><span class="citation" data-cites="Chib-Winkelmann2001">(Chib and Winkelmann, 2001)</span> はリンクを対数関数とし，Poisson 周辺分布を持つカウントデータのコピュラモデリングを実行している．</p>
<p><span class="citation" data-cites="Quinn2004">(Quinn, 2017)</span> は連続確率変数に対してコピュラモデリングを実行している．</p>




</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Agresti12-CategoricalData" class="csl-entry">
Agresti, A. (2012). <em>Categorical data analysis</em>. John Wiley &amp; Sons, Inc.
</div>
<div id="ref-Albert-Chib1993" class="csl-entry">
Albert, J. H., and Chib, S. (1993). <a href="https://doi.org/10.1080/01621459.1993.10476321">Bayesian analysis of binary and polychotomous response data</a>. <em>Journal of the American Statistical Association</em>, <em>88</em>(422), 669–679.
</div>
<div id="ref-Bradley-Terry1952" class="csl-entry">
Bradley, R. A., and Terry, M. E. (1952). <a href="http://www.jstor.org/stable/2334029">Rank analysis of incomplete block designs: I. The method of paired comparisons</a>. <em>Biometrika</em>, <em>39</em>(3/4), 324–345.
</div>
<div id="ref-Caron-Doucet2012" class="csl-entry">
Caron, F., and Doucet, A. (2012). <a href="https://doi.org/10.1080/10618600.2012.638220">Efficient bayesian inference for generalized bradley–terry models</a>. <em>Journal of Computational and Graphical Statistics</em>, <em>21</em>(1), 174–196.
</div>
<div id="ref-Chib-Winkelmann2001" class="csl-entry">
Chib, S., and Winkelmann, R. (2001). <a href="https://doi.org/10.1198/07350010152596673">Markov chain monte carlo analysis of correlated count data</a>. <em>Journal of Business &amp; Economic Statistics</em>, <em>19</em>(4), 428–435.
</div>
<div id="ref-Chopin-Ridgway2017" class="csl-entry">
Chopin, N., and Ridgway, J. (2017). <a href="https://doi.org/10.1214/16-STS581"><span class="nocase">Leave Pima Indians Alone: Binary Regression as a Benchmark for Bayesian Computation</span></a>. <em>Statistical Science</em>, <em>32</em>(1), 64–87.
</div>
<div id="ref-Davidson-Beaver1977" class="csl-entry">
Davidson, R. R., and Beaver, R. J. (1977). <a href="http://www.jstor.org/stable/2529467">On extending the bradley-terry model to incorporate within-pair order effects</a>. <em>Biometrics</em>, <em>33</em>(4), 693–702.
</div>
<div id="ref-Diaconis1988" class="csl-entry">
Diaconis, P. (1988). <em><a href="https://doi.org/10.1214/lnms/1215467407">Group representations in probability and statistics</a></em>,Vol. 11. Institute of Mathematical Statistics.
</div>
<div id="ref-Ding2024LinearModels" class="csl-entry">
Ding, P. (2024). <a href="https://arxiv.org/abs/2401.00649">Linear model and extensions</a>.
</div>
<div id="ref-BDA" class="csl-entry">
Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., and Rubin, D. B. (2014). <em><a href="http://www.stat.columbia.edu/~gelman/book/">Bayesian data analysis</a></em>. Boca Raton : CRC Press.
</div>
<div id="ref-Gelman-Hill2006" class="csl-entry">
Gelman, A., and Hill, J. (2006). <em><a href=" https://doi.org/10.1017/CBO9780511790942">Data analysis using regression and multilevel/hierarchical models</a></em>. Cambridge University Press.
</div>
<div id="ref-Gelman-Hill-Vehtari2020" class="csl-entry">
Gelman, A., Hill, J., and Vehtari, A. (2020). <em><a href="https://avehtari.github.io/ROS-Examples/">Regression and other stories</a></em>. Cambridge University Press.
</div>
<div id="ref-Hastie-Tibshirani1998" class="csl-entry">
Hastie, T., and Tibshirani, R. (1998). <a href="https://doi.org/10.1214/aos/1028144844"><span class="nocase">Classification by pairwise coupling</span></a>. <em>The Annals of Statistics</em>, <em>26</em>(2), 451–471.
</div>
<div id="ref-Henderson2024" class="csl-entry">
Henderson, D. A. (2024). <a href="https://doi.org/10.1214/24-BA1434"><span class="nocase">Modelling and Analysis of Rank Ordered Data with Ties via a Generalized Plackett-Luce Model</span></a>. <em>Bayesian Analysis</em>, 1–29.
</div>
<div id="ref-Hoff2009" class="csl-entry">
Hoff, P. D. (2009). <em><a href="https://doi.org/10.1007/978-0-387-92407-6">A first course in bayesian statistical methods</a></em>. Springer New York.
</div>
<div id="ref-Hunter2004" class="csl-entry">
Hunter, D. R. (2004). <a href="https://doi.org/10.1214/aos/1079120141"><span class="nocase">MM algorithms for generalized Bradley-Terry models</span></a>. <em>The Annals of Statistics</em>, <em>32</em>(1), 384–406.
</div>
<div id="ref-Kruschke2015" class="csl-entry">
Kruschke, J. K. (2015). <em><a href="https://www.sciencedirect.com/book/9780124058880/doing-bayesian-data-analysis">Doing bayesian data analysis: A tutorial with r, JAGS, and stan</a></em>. London ; Tokyo : Academic Press.
</div>
<div id="ref-Liu2004-robit" class="csl-entry">
Liu, C. (2004). <a href="https://doi.org/10.1002/0470090456.ch21">Robit regression: A simple robust alternative to logistic and probit regression</a>. In <em>Applied bayesian modeling and causal inference from incomplete‐data perspectives</em>, pages 227–238. John Wiley &amp; Sons, Ltd.
</div>
<div id="ref-Lopez-Paz+2013" class="csl-entry">
Lopez-Paz, D., Hernández-Lobato, J. M., and Zoubin, G. (2013). <a href="https://proceedings.mlr.press/v28/lopez-paz13.html">Gaussian process vine copulas for multivariate dependence</a>. In S. Dasgupta and D. McAllester, editors, <em>Proceedings of the 30th international conference on machine learning</em>,Vol. 28, pages 10–18. Atlanta, Georgia, USA: PMLR.
</div>
<div id="ref-Luce1959" class="csl-entry">
Luce, R. D. (1959). <em><a href="">Individual choice behavior</a></em>. John Wiley.
</div>
<div id="ref-McCullagh1980" class="csl-entry">
McCullagh, P. (1980). <a href="https://doi.org/10.1111/j.2517-6161.1980.tb01109.x">Regression models for ordinal data</a>. <em>Journal of the Royal Statistical Society: Series B (Methodological)</em>, <em>42</em>(2), 109–127.
</div>
<div id="ref-McFadden1974" class="csl-entry">
McFadden, D. (1974). <a href="https://eml.berkeley.edu/reprints/mcfadden/zarembka.pdf">Frontiers in econometrics</a>. In P. Zarembka, editor, pages 105–142. Academic Press.
</div>
<div id="ref-Pearce-Erosheva2025" class="csl-entry">
Pearce, M., and Erosheva, E. A. (2025). <a href="https://doi.org/10.1080/01621459.2024.2444700">Modeling preferences: A bayesian mixture of finite mixtures for rankings and ratings</a>. <em>Journal of the American Statistical Association</em>, <em>0</em>(0), 1–12.
</div>
<div id="ref-Plackett1975" class="csl-entry">
Plackett, R. L. (1975). <a href="http://www.jstor.org/stable/2346567">The analysis of permutations</a>. <em>Journal of the Royal Statistical Society. Series C (Applied Statistics)</em>, <em>24</em>(2), 193–202.
</div>
<div id="ref-Quinn2004" class="csl-entry">
Quinn, K. M. (2017). <a href="https://doi.org/10.1093/pan/mph022">Bayesian factor analysis for mixed ordinal and continuous responses</a>. <em>Political Analysis</em>, <em>12</em>(4), 338–353.
</div>
<div id="ref-Rao-Kupper1967" class="csl-entry">
Rao, P. V., and Kupper, L. L. (1967). <a href="https://doi.org/10.1080/01621459.1967.10482901">Ties in paired-comparison experiments: A generalization of the bradley-terry model</a>. <em>Journal of the American Statistical Association</em>, <em>62</em>(317), 194–204.
</div>
<div id="ref-Thurstone1927" class="csl-entry">
Thurstone, L. L. (1927). <a href="https://doi.org/10.1037/h0070288">A law of comparative judgement</a>. <em>Psychological Review</em>, <em>34</em>(4), 273–286.
</div>
<div id="ref-Turner+2020" class="csl-entry">
Turner, H. L., Etten, J. van, Firth, D., and Kosmidis, I. (2020). <a href="https://doi.org/10.1007/s00180-020-00959-3">Modelling rankings in r: The PlackettLuce package</a>. <em>Computational Statistics</em>, <em>35</em>(3), 1027–1057.
</div>
<div id="ref-Walker-Duncan1967" class="csl-entry">
Walker, S. H., and Duncan, D. B. (1967). <a href="https://doi.org/10.1093/biomet/54.1-2.167">Estimation of the probability of an event as a function of several independent variables</a>. <em>Biometrika</em>, <em>54</em>(1-2), 167–179.
</div>
<div id="ref-Yates1934" class="csl-entry">
Yates, F. (1934). <a href="https://doi.org/10.2307/2983604">Contingency tables involving small numbers and the χ2 test</a>. <em>Supplement to the Journal of the Royal Statistical Society</em>, <em>1</em>(2), 217–235.
</div>
<div id="ref-竹内真登-猪狩良介2022" class="csl-entry">
竹内真登, and 猪狩良介. (2022). <a href="https://doi.org/10.5844/jsmd.24.2_17">文脈効果を考慮したコンジョイント分析による購買予測</a>. <em>流通研究</em>, <em>24</em>(2), 17–32.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><span class="citation" data-cites="Ding2024LinearModels">(Ding, 2024, p. 222)</span> も参照．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Bayesian</category>
  <category>Statistics</category>
  <guid>https://162348.github.io/posts/2024/Survey/BDA2.html</guid>
  <pubDate>Thu, 05 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" medium="image" type="image/svg+xml"/>
</item>
<item>
  <title>ベイズデータ解析５</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Survey/BDA1.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="関連記事" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="関連記事">関連記事</h2>
<div id="listing-lst-survey" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNNQ01DJTJDUiUyQ1N0YW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1715472000000" data-listing-file-modified-sort="1754014114286" data-listing-date-modified-sort="1734480000000" data-listing-reading-time-sort="9" data-listing-word-count-sort="1605">
<a href="../../../posts/2024/Computation/brms.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Computation/brms_files/figure-html/unnamed-chunk-4-1.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> によるベイズ混合モデリング入門
</h5>
<div class="card-subtitle listing-subtitle">
ポアソン混合効果モデルを例に
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-05-12
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1733356800000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1735430400000" data-listing-reading-time-sort="2" data-listing-word-count-sort="382">
<a href="../../../posts/2024/Survey/BDA2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析６
</h5>
<div class="card-subtitle listing-subtitle">
応答が質的変数の場合
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-05
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1727049600000" data-listing-file-modified-sort="1754014117255" data-listing-date-modified-sort="1733616000000" data-listing-reading-time-sort="3" data-listing-word-count-sort="564">
<a href="../../../posts/2024/Survey/Survey1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesANOVA.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析１
</h5>
<div class="card-subtitle listing-subtitle">
分散分析
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-23
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="3" data-categories="U3RhdGlzdGljcw==" data-listing-date-sort="1727049600000" data-listing-file-modified-sort="1754014117255" data-listing-date-modified-sort="1735516800000" data-listing-reading-time-sort="3" data-listing-word-count-sort="489">
<a href="../../../posts/2024/Survey/Survey2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/ATE.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析２
</h5>
<div class="card-subtitle listing-subtitle">
平均処置効果の推定とセミパラメトリック法
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-23
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="4" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1727136000000" data-listing-file-modified-sort="1754014117255" data-listing-date-modified-sort="1727568000000" data-listing-reading-time-sort="6" data-listing-word-count-sort="1038">
<a href="../../../posts/2024/Survey/Survey3.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/Horvitz-Thompson.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析３
</h5>
<div class="card-subtitle listing-subtitle">
標本調査データと欠測データの扱い
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-24
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="5" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1727136000000" data-listing-file-modified-sort="1754014117255" data-listing-date-modified-sort="1727395200000" data-listing-reading-time-sort="2" data-listing-word-count-sort="269">
<a href="../../../posts/2024/Survey/Survey4.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/DataIntegration.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析４
</h5>
<div class="card-subtitle listing-subtitle">
アンケートデータとデータ統合
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-24
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="回帰分析の一般事項" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="回帰分析の一般事項"><span class="header-section-number">1</span> 回帰分析の一般事項</h2>
<section id="はじめに正規線型回帰" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="はじめに正規線型回帰"><span class="header-section-number">1.1</span> はじめに：正規線型回帰</h3>
<p>回帰分析とは，２つの確率変数 <img src="https://latex.codecogs.com/png.latex?X,Y"> の実現と見られるデータが得られている際に，<img src="https://latex.codecogs.com/png.latex?Y"> に対して（より正確にはその条件付き期待値 <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BE%7D%5BY%7CX%5D"> に対して），<img src="https://latex.codecogs.com/png.latex?x%5Cin%5Cmathcal%7BX%7D"> に依存する関数としてモデル <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathcal%7BX%7D%5Cni%20x%5Cmapsto%20P_%7B%5Ctheta,x%7D%5Cin%5Cmathcal%7BP%7D(%5Cmathcal%7BY%7D)%0A"> を考えることをいう．</p>
<p>例えば <img src="https://latex.codecogs.com/png.latex?%0AP_%7B%5Ctheta,x%7D=%5Coperatorname%7BN%7D(%5Cbeta%5E%5Ctop%20x,%5Csigma%5E2),%5Cqquad%5Ctheta=(%5Cbeta,%5Csigma),%0A"> とした場合を <strong>正規線型回帰モデル</strong> (normal linear model) という．</p>
<p><img src="https://latex.codecogs.com/png.latex?Y"> のモデリングに集中しており，<img src="https://latex.codecogs.com/png.latex?X"> には分布の仮定を置いていない点が回帰モデルの特徴である．主に <img src="https://latex.codecogs.com/png.latex?X"> を用いた <img src="https://latex.codecogs.com/png.latex?Y"> の予測や，<img src="https://latex.codecogs.com/png.latex?X"> の <img src="https://latex.codecogs.com/png.latex?Y"> への（因果）効果を推定するために用いられる．<sup>1</sup></p>
</section>
<section id="ベイズ回帰分析" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="ベイズ回帰分析"><span class="header-section-number">1.2</span> ベイズ回帰分析</h3>
<!-- しかしベイズ回帰分析では，条件付き期待値 $\E[Y|X]$ を推定するというより，本質的には結合変数 $(X,Y)$ の結合分布をモデリングしているとみなすべきである． -->
<p>ベイズ回帰分析では，<img src="https://latex.codecogs.com/png.latex?Y"> の条件付き構造 <img src="https://latex.codecogs.com/png.latex?Y%7CX"> をモデリングするにあたって，パラメータ <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> との結合分布 <img src="https://latex.codecogs.com/png.latex?(Y,%5CTheta)%7CX"> をモデリングする．</p>
<p>実際，ベイズ回帰分析では事前分布 <img src="https://latex.codecogs.com/png.latex?P_%5Cvarphi"> も併せて次の２つのモデルが想定される： <img src="https://latex.codecogs.com/png.latex?%0AY%7C(%5CTheta,X)%5Csim%20P_%7B%5Ctheta,x%7D,%5Cqquad%20%5CTheta%5Csim%20P_%5Cvarphi.%0A"> <img src="https://latex.codecogs.com/png.latex?%5Cvarphi"> はハイパーパラメータとも呼ばれる．</p>
<p>パラメータ <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> の空間（または <img src="https://latex.codecogs.com/png.latex?(%5Ctheta,%5Cvarphi)"> ）上からの確率核 <img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta%5Cmapsto%20P_%7B%5Ctheta,x%7D(dy)%5Cin%5Cmathcal%7BP%7D(%5Cmathcal%7BY%7D)%0A"> を <strong>尤度</strong> という．よく密度 <img src="https://latex.codecogs.com/png.latex?p(y%7Cx,%5Ctheta)"> の形で表される．</p>
<p>尤度によりデータ <img src="https://latex.codecogs.com/png.latex?y"> の空間 <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BY%7D"> 上の確率分布に関する問題を，パラメータ <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> の空間上に移送し，事前分布 <img src="https://latex.codecogs.com/png.latex?P_%5Cvarphi"> からの変化を見ることが <strong>（ベイズ）推論</strong> である．</p>
<p>ベイズ回帰分析とは，尤度がパラメータ <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> の他にデータ <img src="https://latex.codecogs.com/png.latex?x"> の関数でもある場合のベイズモデリングに過ぎない．換言すれば，<img src="https://latex.codecogs.com/png.latex?Y%7CX"> の依存構造に焦点がある際に行うベイズ推論である．</p>
<!-- $\Theta\indep\Phi$ の仮定を置いていることが特徴であるが，$(X,Y)$ の結合分布の想定が簡単になる点が，ここまで人口に膾炙している理由であると思われる． -->
</section>
<section id="sec-collinearity" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="sec-collinearity"><span class="header-section-number">1.3</span> 強線型性</h3>
<p>仮に２つの説明変数に完全な線型関係がある場合，複数のパラメータ値が同一のモデルを表現するため，パラメータ推定が複数の解を持つ（＝識別不可能）．</p>
<p>この場合 OLS 推定は数値的に不安定になる危険性がある．</p>
<p>一方でベイズ推定は事前分布から与えられる情報によりこのような不安定性が回避でき，多くのデフォルト事前分布はそのように設計されている．<span class="citation" data-cites="Gelman-Hill-Vehtari2020">(8.4 節 Gelman, Hill, et al., 2020, p. 109)</span> も参照．<sup>2</sup></p>
<p>この美点は階層モデリングにおいても引き継がれる．<img src="https://latex.codecogs.com/png.latex?J"> 個の指示変数（ダミー変数）を用いた回帰においては，切片項を除けば <img src="https://latex.codecogs.com/png.latex?J-1"> 個の指示変数しか追加してはならない．共線型性をもつためである．</p>
<p>しかし階層モデリングにおいては係数に超階層モデルが想定されるため，ここから伝ってくる事前情報が自然に正則化を行い，適切にベイズ推定が行われる <span class="citation" data-cites="Gelman-Hill2006">(Gelman and Hill, 2006, p. 393)</span>．さらに縮小推定が働き，ほとんどの場合より推定の効率が上がる 2.5．</p>
</section>
<section id="sec-Bayesian-workflow" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="sec-Bayesian-workflow"><span class="header-section-number">1.4</span> ベイズ回帰分析ワークフロー</h3>
<ol type="1">
<li><img src="https://latex.codecogs.com/png.latex?(X,Y)"> の依存構造が単純（線型）になるような変数変換を行う（一般化線型モデルの利用を含む）．</li>
<li><img src="https://latex.codecogs.com/png.latex?(%5CTheta,%5CPhi)"> の事前分布を設定する（初めは一様分布やデフォルトの無情報事前分布で良い）．</li>
<li>事後分布を計算し，事後予測分布を見てデータが再現できているかを基にモデルを検証する．</li>
</ol>
<p>その後，十分に階層化をして，パラメータの空間上の事前分布がほとんど情報を持たなくて良いようにする，完全ベイズ推論が一つの悲願とされる．<sup>3</sup></p>
<p>モデルの挙動がもはや事前分布に依存しなくなった際，モデルの階層構造や尤度の構造が十分にデータを反映できていると思われるためである．<sup>4</sup></p>
<blockquote class="blockquote">
<p>推定すべきものはモデルの尤度であってパラメターの値ではないというのが赤池氏の主張です．いいかえると，推定すべきは確率構造であってパラメターではないというのです．<span class="citation" data-cites="田邉國士2010">(田邉國士, 2010)</span></p>
</blockquote>
<div class="callout callout-style-simple callout-important no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>この階層化と尤度の推定を探索的に実行できる点がベイズの真の美点だと筆者は考える．そして一度モデルの構造・尤度が明瞭化された際は，もはやベイズである必要はない場合が多い．<sup>5</sup></p>
</div>
</div>
</div>
</section>
<section id="ベイズ線型回帰からの脱出" class="level3" data-number="1.5">
<h3 data-number="1.5" class="anchored" data-anchor-id="ベイズ線型回帰からの脱出"><span class="header-section-number">1.5</span> ベイズ線型回帰からの脱出</h3>
<p>前節の立場にたてば，最初の解析は常に（弱い情報を持った事前分布による）ベイズ回帰分析であるべきである．<sup>6</sup></p>
<p>これは若干の正則化を加えたロバスト最尤推定に，不確実性の定量化を加えたものと等価であるが，これを MCMC を回すことで一度に実行できる点が美点である．</p>
<p>多くのデフォルト事前分布が開発されており，ほとんど自動的に最初のベイズ回帰分析が実行できる．共線型性が懸念される場合や，小さなデータセットに大きなモデルをフィッティングしようとしている場合などの識別不可能性が生じる状況でも安定した推定値が得られる．</p>
<p>事後分布は豊富な情報を持っており，何より事後予測分布を計算することで予測モデルとしての妥当性を即時に確認できる (PPC: Posterior Predictive Check)．</p>
<p>同時に解析の目標は，適切な関数関係や階層関係を持った階層モデルの発見と，これに適合する（ベイズだろうと点推定だろうと）パラメータ推定法の構成による，ナイーブなベイズ線型回帰からの脱出である．</p>
<p>それにあたって，MCMC の収束鈍化も大きな情報である <span class="citation" data-cites="Burkner2021">(Bürkner, 2021, p. 32)</span>．</p>
<p>This is the game we (should) play.</p>
</section>
</section>
<section id="階層モデル" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="階層モデル"><span class="header-section-number">2</span> 階層モデル</h2>
<section id="はじめに" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">2.1</span> はじめに</h3>
<p>階層モデルは複雑なモデルを構築するための強力なツールであり，ベイズのワークフローにおいて基本的な要素になる．</p>
<p>層別抽出やクラスター抽出をはじめとして，多くの場合階層別に知識が存在し，これらを系統的に組み込んだ形でモデルを構築できる．</p>
<p>しかし同時に計算が困難になり，第一近似として正規性が仮定される場合が多い．</p>
</section>
<section id="混合効果モデル" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="混合効果モデル"><span class="header-section-number">2.2</span> 混合効果モデル</h3>
<p>標本を <img src="https://latex.codecogs.com/png.latex?J"> 個のグループにわけ，これへの所属を表す２値変数 <img src="https://latex.codecogs.com/png.latex?x_i%5Cin%5Cmathbb%7BR%7D%5EJ"> を説明変数に追加するとする．</p>
<p>このような所属変数 <img src="https://latex.codecogs.com/png.latex?x_i"> の回帰係数 <img src="https://latex.codecogs.com/png.latex?%5Cbeta%5Cin%5Cmathbb%7BR%7D%5EJ"> に対して階層モデルが考えられる場合が多い．</p>
<p>例えば <img src="https://latex.codecogs.com/png.latex?%5Calpha%5Cin%5Cmathbb%7BR%7D,%5Csigma_%5Cbeta%3E0"> をスカラーとして <img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta%5Csim%5Coperatorname%7BN%7D_J(%5Calpha%5Cboldsymbol%7B1%7D,%5Csigma%5E2_%5Cbeta%20I_J),%0A"> という正規モデルを想定した場合，<img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D"> の係数 <img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> は各グループ <img src="https://latex.codecogs.com/png.latex?j%5Cin%5BJ%5D"> 固有の切片項であり，<strong>変量効果</strong> (random effect) と呼ばれる．</p>
<p>変量効果の追加は，同一グループ内の <img src="https://latex.codecogs.com/png.latex?y_i"> に相関を生じさせるが，グループが違う場合は相変わらず独立のままとする効果がある．</p>
<p>さらに <img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> の分散 <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_%7B%5Cbeta_j%7D"> を <img src="https://latex.codecogs.com/png.latex?%5Cinfty"> とした場合，すなわち（もはや確率分布ではないが）一様分布を仮定した場合を <strong>固定効果</strong> (fixed effect) という．<sup>7</sup></p>
<p>ベイズの立場からは，「変量」と「固定」の名称は歴史的なもので，実質的な違いは「次の階層で回帰モデルを仮定するか，モデルを持たない最終階層の変数と扱い一様事前分布に従うとするか」という仮定の違いにすぎない．詳しくは次節：</p>
<div id="listing-lst-embedding" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="T3BpbmlvbiUyQ1N0YXRpc3RpY3M=" data-listing-date-sort="1733875200000" data-listing-file-modified-sort="1754014114518" data-listing-date-modified-sort="NaN" data-listing-reading-time-sort="3" data-listing-word-count-sort="511">
<a href="../../../posts/2024/Lifestyle/FixedRandom.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Lifestyle/Files/Hierarchical.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
変量効果と固定効果
</h5>
<div class="card-subtitle listing-subtitle">
統一的見解を目指して
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-11
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>この２種の取り扱いをする回帰係数を混在させた場合は <strong>混合モデル</strong> (mixed model) という <span class="citation" data-cites="BDA">(Gelman et al., 2014, p. 383)</span>．</p>
</section>
<section id="階層モデルから見た分散分析" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="階層モデルから見た分散分析"><span class="header-section-number">2.3</span> 階層モデルから見た分散分析</h3>
<p>ベイズのワークフローにおいて，複数の説明変数間の階層関係の特定や「どのグループの回帰係数を共通とするか」の見極めが極めて重要である 1.4．</p>
<p>特に，膨大な説明変数の中から「因子」（性別・教育水準・出身地など）とその「水準」（女性・大学院生・山形県民など）とを峻別することが重要であり，どのクラスに独自の回帰係数 <img src="https://latex.codecogs.com/png.latex?%5Cbeta%5E%7B(m)%7D%5Csim%5Coperatorname%7BN%7D_%7BJ_m%7D(%5Calpha_%7Bm%7D%5Cboldsymbol%7B1%7D_%7BJ_m%7D,%5Csigma%5E2_%7Bm%7DI_%7BJ_m%7D)"> を与えるかの決定が，モデルの尤度の改善において大きな効果を持つ <span class="citation" data-cites="Gelman2005">(Gelman, 2005)</span>．</p>
<p><img src="https://latex.codecogs.com/png.latex?M"> 元配置の分散分析において，各因子 <img src="https://latex.codecogs.com/png.latex?m%5Cin%5BM%5D"> に対応する回帰係数は，<img src="https://latex.codecogs.com/png.latex?J_m"> 個の水準ごとに次のように決まるバラバラの変動係数を持つとする： <img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta%5E%7B(m)%7D_j%5Csim%5Coperatorname%7BN%7D(0,%5Csigma%5E2_m),%5Cqquad%20j%5Cin%5BJ_m%5D.%0A"> この変量効果としての解釈により，ANOVA は階層モデルの推定とみなせる <span class="citation" data-cites="Gelman2005">(3.2節 Gelman, 2005, p. 9)</span>．<sup>8</sup></p>
<p>この際の <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_m"> に対する共役（超）事前分布は逆 <img src="https://latex.codecogs.com/png.latex?%5Cchi%5E2">-分布である <span class="citation" data-cites="BDA">(Gelman et al., 2014, p. 396)</span> <img src="https://latex.codecogs.com/png.latex?%0A%5Csigma%5E2_%7Bm%7D%5Csim%5Cchi%5E%7B-2%7D(%5Cmu_m,%5Csigma%5E2_%7B0m%7D)%0A"> であり，<img src="https://latex.codecogs.com/png.latex?%5Cnu_m=-1,%5Csigma%5E2_%7B0m%7D=0"> とすることで一様事前分布を得る．</p>
<blockquote class="blockquote">
<p>Analysis of variance (Anova) represents a key idea in statistical modeling of complex data structures. <span class="citation" data-cites="BDA">(Gelman et al., 2014, p. 395)</span></p>
</blockquote>
<p>こうして設定された各因子の各水準ごとの係数 <img src="https://latex.codecogs.com/png.latex?%5Cbeta%5E%7B(m)%7D_j"> の事後分布を見ることで「分散分析」を実行することになる．これがベイズによる分散分析の再解釈である．</p>
<div id="listing-lst-ANOVA" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDUg==" data-listing-date-sort="1727136000000" data-listing-file-modified-sort="1754014116627" data-listing-date-modified-sort="1733702400000" data-listing-reading-time-sort="5" data-listing-word-count-sort="861">
<a href="../../../posts/2024/Survey/BayesANOVA.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/House.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズ分散分析のモデル解析
</h5>
<div class="card-subtitle listing-subtitle">
心理学実験を題材として
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-24
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1727049600000" data-listing-file-modified-sort="1754014117255" data-listing-date-modified-sort="1733616000000" data-listing-reading-time-sort="3" data-listing-word-count-sort="564">
<a href="../../../posts/2024/Survey/Survey1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Survey/Files/BayesANOVA.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズデータ解析１
</h5>
<div class="card-subtitle listing-subtitle">
分散分析
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-23
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNNQ01DJTJDUiUyQ1N0YW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1715472000000" data-listing-file-modified-sort="1754014114286" data-listing-date-modified-sort="1734480000000" data-listing-reading-time-sort="9" data-listing-word-count-sort="1605">
<a href="../../../posts/2024/Computation/brms.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Computation/brms_files/figure-html/unnamed-chunk-4-1.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
<code>brms</code> によるベイズ混合モデリング入門
</h5>
<div class="card-subtitle listing-subtitle">
ポアソン混合効果モデルを例に
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-05-12
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="水準ごとの分散" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="水準ごとの分散"><span class="header-section-number">2.4</span> 水準ごとの分散</h3>
<p>このように分散分析を階層モデルのベイズ推定と再解釈することで，膨大な数の水準の組み合わせに関して，その効果量を定量的に比較することができる．</p>
<p>ここからさらに，<img src="https://latex.codecogs.com/png.latex?M"> 個の因子ごとに全ての水準で共通した分散 <img src="https://latex.codecogs.com/png.latex?%5Csigma_1%5E2,%5Ccdots,%5Csigma_M%5E2"> の <img src="https://latex.codecogs.com/png.latex?M"> 個のみを考えるのではなく， <img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta%5E%7B(m)%7D%5Csim%5Coperatorname%7BN%7D_%7BJ_m%7D(%5Calpha_m%5Cboldsymbol%7B1%7D_%7BJ_m%7D,%5Cmathrm%7Bdiag%7D(%5Csigma%5E2_%7Bm1%7D,%5Ccdots,%5Csigma%5E2_%7BmJ_m%7D)),%5Cqquad%20m%5Cin%5BM%5D,%0A"> として，水準ごとにも異なる <img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bm=1%7D%5EM%20J_m"> 個の分散を考えることもできる <span class="citation" data-cites="BDA">(15.7 節 Gelman et al., 2014, p. 397)</span>．</p>
<p>この際， <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BCauchy%7D(0,A),%5Cqquad%20A%5Csim%20U(%5Cmathbb%7BR%7D_+),%0A"> という形の半 Cauchy 分布が <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_%7Bmj%7D"> の事前分布として用いられる <span class="citation" data-cites="BDA">(Gelman et al., 2014, p. 399)</span>．これは一部の水準にのみ大きな分散を認め，その他の水準にはほとんど分散への寄与がないという仮定を表している．</p>
</section>
<section id="sec-shrinkage" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="sec-shrinkage"><span class="header-section-number">2.5</span> 縮小推定</h3>
<p>階層モデルでは，自然に他のグループの情報が共有され，各グループの平均が全体の平均に向けて「縮小」されて推定される．これを <span class="citation" data-cites="Stein1956">(Stein, 1956)</span> から Stein 効果ともいう <span class="citation" data-cites="Hoff2009">(Hoff, 2009, p. 146)</span>．<sup>9</sup></p>
</section>
</section>
<section id="一般化線型モデル" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="一般化線型モデル"><span class="header-section-number">3</span> 一般化線型モデル</h2>
<section id="線型-gauss-性からの乖離" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="線型-gauss-性からの乖離"><span class="header-section-number">3.1</span> 線型 Gauss 性からの乖離</h3>
<p>正規線型モデルから，次の２つの自由度を追加したモデルを <strong>一般化線型モデル</strong> <span class="citation" data-cites="Nelder-Wedderburn72-GLM">(Nelder and Wedderburn, 1972)</span> という：</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ol type="1">
<li>リンク関数 <img src="https://latex.codecogs.com/png.latex?g"></li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20g%5Ccirc%5Coperatorname%7BE%7D%5BY%7CX%5D=%5Cbeta%5E%5Ctop%20X%0A%20%20"></p>
<ol start="2" type="1">
<li>（正規分布以外の）分布族 <img src="https://latex.codecogs.com/png.latex?P"></li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20Y%7CX%5Csim%20P(%5Coperatorname%7BE%7D%5BY%7CX%5D,%5Cphi)%0A%20%20"></p>
</div>
</div>
</div>
<p>その結果質的データ解析にも応用可能な広いクラスのモデルを得る．</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="カウントデータに対する Poisson モデル">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
カウントデータに対する Poisson モデル
</div>
</div>
<div class="callout-body-container callout-body">
<p>自然数値のデータに対して，<img src="https://latex.codecogs.com/png.latex?y_i%5Csim%5Cmathrm%7BPois%7D(%5Clambda_i)"> の <img src="https://latex.codecogs.com/png.latex?%5Clambda_i"> を，正準リンク関数 <img src="https://latex.codecogs.com/png.latex?g=%5Clog"> を通じて <img src="https://latex.codecogs.com/png.latex?%0A%5Clog%5Clambda_i=X_i%5E%5Ctop%5Cbeta%0A"> とモデリングすることが考えられる．このモデルを <strong>Poisson 回帰</strong> ともいう．</p>
</div>
</div>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="成功回数データに対する二項モデル">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
成功回数データに対する二項モデル
</div>
</div>
<div class="callout-body-container callout-body">
<p>２値データや成功回数を表すデータの場合，<img src="https://latex.codecogs.com/png.latex?y_i%5Csim%5Cmathrm%7BBin%7D(n_i,%5Cmu_i)"> の <img src="https://latex.codecogs.com/png.latex?%5Cmu_i"> を <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BP%7D%5BY_i=1%7CX_i%5D"> の形でモデリングすることを考えることができる．</p>
<p>この場合，正準リンク関数は <img src="https://latex.codecogs.com/png.latex?%0Ag(%5Cmu)=%5Clog%5Cfrac%7B%5Cmu%7D%7B1-%5Cmu%7D%0A"> という logit 変換で与えられる．より効率的な推論を促進するために probit リンクや，非対称性を導入する complementary log-log リンク <img src="https://latex.codecogs.com/png.latex?%0Ag(%5Cmu)=%5Clog(-%5Clog%5Cmu)%0A"> が用いられることもある <span class="citation" data-cites="BDA">(Gelman et al., 2014, p. 407)</span>．</p>
</div>
</div>
</section>
<section id="指数分布族" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="指数分布族"><span class="header-section-number">3.2</span> 指数分布族</h3>
<p>なお正準リンクとは，Poisson 分布族や二項分布族を指数分布族とみなした際のリンク関数のことである．</p>
<p>例えば二項分布族 <img src="https://latex.codecogs.com/png.latex?%5C%7B%5Cmathrm%7BBin%7D(n,%5Cmu)%5C%7D_%7B%5Cmu%5Cin(0,1)%7D"> は，計数測度 <img src="https://latex.codecogs.com/png.latex?%5Cnu"> に対して， <img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7Bd%20%5Cmathrm%7BBin%7D(n,%5Cmu)%7D%7Bd%20%5Cnu%7D(x)=%5Cbegin%7Bpmatrix%7Dn%5C%5Cx%5Cend%7Bpmatrix%7D%5Cexp%5Cleft(x%5Clog%5Cfrac%7B%5Cmu%7D%7B1-%5Cmu%7D+n%5Clog(1-%5Cmu)%5Cright)%0A"> と表せる．<img src="https://latex.codecogs.com/png.latex?g(%5Cmu)"> を <strong>自然な十分統計量</strong> ともいう．</p>
<p>指数分布族と正準リンク関数を用いた一般化線型モデリングは，パラメトリック分布族の十分統計量を代理の応答変数として線型回帰を行なっているものとみなせる．</p>
<div class="callout callout-style-default callout-important no-icon callout-titled" title="変換の意味">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
変換の意味
</div>
</div>
<div class="callout-body-container callout-body">
<p>このような数理統計学的な理由とは別に，<img src="https://latex.codecogs.com/png.latex?g(%5Cmu)"> の意味を直接解釈することもできる．</p>
<ul>
<li>Poisson 回帰はオフセット <img src="https://latex.codecogs.com/png.latex?%5Clog%20y_i"> を作ることで， <img src="https://latex.codecogs.com/png.latex?%0A%5Clog%5Cfrac%7B%5Clambda_i%7D%7By_i%7D=X_i%5E%5Ctop%5Cbeta%0A"> と見ることもできる．<img src="https://latex.codecogs.com/png.latex?%5Clambda_i/y_i"> は観測カウント <img src="https://latex.codecogs.com/png.latex?y_i"> に対する平均 <img src="https://latex.codecogs.com/png.latex?%5Clambda_i"> の <strong>率比</strong> (rate ratio) と呼ばれ，<img src="https://latex.codecogs.com/png.latex?g(%5Clambda_i/y_i)"> は対数率比と解釈できる．</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cmu%7D%7B1-%5Cmu%7D"> という値は成功確率 <img src="https://latex.codecogs.com/png.latex?%5Cmu"> に対するオッズ比と呼ばれ，<img src="https://latex.codecogs.com/png.latex?g(%5Cmu)"> は <strong>対数オッズ比</strong> (log odds ratio) と呼ばれる．</li>
</ul>
</div>
</div>
</section>
<section id="分散分析" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="分散分析"><span class="header-section-number">3.3</span> 分散分析</h3>
<p>線型モデルにおいて分散分析は，第一義的には帰無モデルの検定であった．後続の多重比較による解析は，説明変数ごとの効果量の比較を行う．</p>
<p>しかし線型モデルにおいてその方法は分散の分解に基づいており，この一般化線型モデルへの拡張は自明ではない．</p>
<p>一般化線型モデルにおいても残差を定義し，これに基づいてモデルの検証を行うことはできる <span class="citation" data-cites="Davison-Tsai1992">(Davison and Tsai, 1992)</span>．</p>
</section>
</section>



<div id="quarto-appendix" class="default"><section id="終わりに" class="level2 appendix" data-number="4"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">4</span> 終わりに</h2><div class="quarto-appendix-contents">



</div></section><section id="文献紹介" class="level3 appendix" data-number="4.1"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">4.1</span> 文献紹介</h2><div class="quarto-appendix-contents">

<p><span class="citation" data-cites="BDA">(Gelman et al., 2014)</span> 第14章で回帰分析，15章で階層モデルが議論されている．15.6, 15.7 章で Bayesian Anova が解説されている．</p>
<p><span class="citation" data-cites="Gelman-Hill-Vehtari2020">(Gelman, Hill, et al., 2020)</span> が回帰に特化した本である．</p>
<p><code>rstanarm</code> パッケージを通じて</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstanarm)</span>
<span id="cb1-2">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_glm</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> mydata)</span></code></pre></div>
<p>というコードでベイズ線型回帰を実行できる．<code>family</code> を指定していないため，線型モデルと解釈される．<span class="citation" data-cites="Muth-Oravecz-Gabry2018">(Muth, 2018)</span> が最適なイントロダクションである．</p>
<p><code>rstanarm</code> パッケージは特に <code>R</code> の built-in の OLS 推定をする関数</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> mydata)</span></code></pre></div>
<p>や <code>lmer</code> との接続性を意識されているパッケージで，古典的な解析とベイズ分析との往復が容易にできる．</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_glm</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> mydata, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">algorithm =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"optimizing"</span>)</span></code></pre></div>
<p>により変分推論による高速な近似推定も可能である．ベイズ回帰は探索的な用途でも多く使われることを考えると大変有用な機能である．</p>
</div></section><section id="回帰という名前" class="level3 appendix" data-number="4.2"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">4.2</span> 「回帰」という名前</h2><div class="quarto-appendix-contents">

<p>回帰分析は従って，<img src="https://latex.codecogs.com/png.latex?(X,Y)"> の結合分布の形を捉える行為である．</p>
<p><img src="https://latex.codecogs.com/png.latex?X,Y"> の間に不完全な線型関係があり，回帰係数が <img src="https://latex.codecogs.com/png.latex?1"> より小さい場合，<img src="https://latex.codecogs.com/png.latex?X"> が平均より大きい場合，<img src="https://latex.codecogs.com/png.latex?Y"> が平均より大きい確率は小さくなる．</p>
<p>これが「平均への回帰」と呼ばれ，regression の名前の由来となった．</p>
<p>この現象は利用可能性バイアスにより人間に偽の因果関係を簡単に知覚させる <span class="citation" data-cites="Tversky-Kahneman1973">(Tversky and Kahneman, 1973)</span>．regression fallacy という名前もついている．</p>
<p>Galton の例では <img src="https://latex.codecogs.com/png.latex?X"> が親の身長で <img src="https://latex.codecogs.com/png.latex?Y"> が子の身長であった．背の高い両親に恵まれた子供に「残念だね」と声をかける者が居るだろうか？</p>
<p>仮に <img src="https://latex.codecogs.com/png.latex?X"> が「褒めたかどうか」で <img src="https://latex.codecogs.com/png.latex?Y"> が対象のパフォーマンスであったとするとさらに奇妙なことが起こる．「褒める」ことが激烈に大きな効果を生むわけではない以上，パフォーマンスがよかった場合に褒めると，次にパフォーマンスが落ちる確率が大きくなる．</p>
<p>日常の場面で体感される利用可能な情報がそれだけである以上，これを「褒めると逆効果だ」と知覚しがちなのである．<span class="citation" data-cites="Kahneman-Tversky1973">(Kahneman and Tversky, 1973)</span> に素晴らしい例がある．</p>
<p>これゆえ定量的な評価が必要なのである．<span class="citation" data-cites="Gelman-Hill-Vehtari2020">(6.5 節 Gelman, Hill, et al., 2020, p. 87)</span> も参照．</p>




</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Bafumi-Gelman2007" class="csl-entry">
Bafumi, J., and Gelman, A. (2007). <a href="https://dx.doi.org/10.2139/ssrn.1010095"><span class="nocase">Fitting Multilevel Models When Predictors and Group Effects Correlate</span></a>. <em>SSRN</em>.
</div>
<div id="ref-Burkner2021" class="csl-entry">
Bürkner, P.-C. (2021). <a href="https://doi.org/10.18637/jss.v100.i05">Bayesian item response modeling in r with brms and stan</a>. <em>Journal of Statistical Software</em>, <em>100</em>(5), 1–54.
</div>
<div id="ref-Davison-Tsai1992" class="csl-entry">
Davison, A. C., and Tsai, C.-L. (1992). <a href="http://www.jstor.org/stable/1403682">Regression model diagnostics</a>. <em>International Statistical Review / Revue Internationale de Statistique</em>, <em>60</em>(3), 337–353.
</div>
<div id="ref-Efron-Morris1973" class="csl-entry">
Efron, B., and Morris, C. (1973). <a href="http://www.jstor.org/stable/2284155">Stein’s estimation rule and its competitors–an empirical bayes approach</a>. <em>Journal of the American Statistical Association</em>, <em>68</em>(341), 117–130.
</div>
<div id="ref-Efron-Morris1975" class="csl-entry">
Efron, B., and Morris, C. (1975). <a href="http://www.jstor.org/stable/2285814">Data analysis using stein’s estimator and its generalizations</a>. <em>Journal of the American Statistical Association</em>, <em>70</em>(350), 311–319.
</div>
<div id="ref-Gelman2005" class="csl-entry">
Gelman, A. (2005). <a href="https://doi.org/10.1214/009053604000001048"><span class="nocase">Analysis of variance—why it is more important than ever</span></a>. <em>The Annals of Statistics</em>, <em>33</em>(1), 1–53.
</div>
<div id="ref-Gelman2014" class="csl-entry">
Gelman, A. (2014). <a href="https://doi.org/10.1214/13-STS458"><span class="nocase">How Bayesian Analysis Cracked the Red-State, Blue-State Problem</span></a>. <em>Statistical Science</em>, <em>29</em>(1), 26–35.
</div>
<div id="ref-BDA" class="csl-entry">
Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., and Rubin, D. B. (2014). <em><a href="http://www.stat.columbia.edu/~gelman/book/">Bayesian data analysis</a></em>. Boca Raton : CRC Press.
</div>
<div id="ref-Gelman-Hill2006" class="csl-entry">
Gelman, A., and Hill, J. (2006). <em><a href=" https://doi.org/10.1017/CBO9780511790942">Data analysis using regression and multilevel/hierarchical models</a></em>. Cambridge University Press.
</div>
<div id="ref-Gelman-Hill-Vehtari2020" class="csl-entry">
Gelman, A., Hill, J., and Vehtari, A. (2020). <em><a href="https://avehtari.github.io/ROS-Examples/">Regression and other stories</a></em>. Cambridge University Press.
</div>
<div id="ref-Gelman+2020" class="csl-entry">
Gelman, A., Vehtari, A., Simpson, D., Margossian, C. C., Carpenter, B., Yao, Y., … Modrák, M. (2020). <a href="https://arxiv.org/abs/2011.01808">Bayesian workflow</a>.
</div>
<div id="ref-Hoff2009" class="csl-entry">
Hoff, P. D. (2009). <em><a href="https://doi.org/10.1007/978-0-387-92407-6">A first course in bayesian statistical methods</a></em>. Springer New York.
</div>
<div id="ref-Kahneman-Tversky1973" class="csl-entry">
Kahneman, D., and Tversky, A. (1973). <a href="https://doi.org/10.1037/h0034747">On the psychology of prediction</a>. <em>Psychological Review</em>, <em>80</em>(4), 237–251.
</div>
<div id="ref-Muth-Oravecz-Gabry2018" class="csl-entry">
Muth, Z. A. G., Chelsea AND Oravecz. (2018). <a href="https://doi.org/10.20982/tqmp.14.2.p099">User-friendly bayesian regression modeling: A tutorial with rstanarm and shinystan</a>. <em>The Quantitative Methods for Psychology</em>, <em>14</em>(2), 99–119.
</div>
<div id="ref-Nelder-Wedderburn72-GLM" class="csl-entry">
Nelder, J. A., and Wedderburn, R. W. M. (1972). Generalized linear models. <em>Journal of the Royal Statistical Society, Series A (General)</em>, <em>135</em>(3), 370–384.
</div>
<div id="ref-Stein1956" class="csl-entry">
Stein, C. (1956). <a href="https://projecteuclid.org/ebooks/berkeley-symposium-on-mathematical-statistics-and-probability/Proceedings-of-the-Third-Berkeley-Symposium-on-Mathematical-Statistics-and/chapter/Inadmissibility-of-the-Usual-Estimator-for-the-Mean-of-a/bsmsp/1200501656">Inadmissibility of the usual estimator for the mean of a multivariate normal distribution</a>. <em>Proceedings of the Third Berkeley Symposium on Mathematical Statistics and Probability, Volume 1: Contributions to the Theory of Statistics</em>, 197–206.
</div>
<div id="ref-Tversky-Kahneman1973" class="csl-entry">
Tversky, A., and Kahneman, D. (1973). <a href="https://doi.org/10.1016/0010-0285(73)90033-9">Availability: A heuristic for judging frequency and probability</a>. <em>Cognitive Psychology</em>, <em>5</em>(2), 207–232.
</div>
<div id="ref-久保川達也2006" class="csl-entry">
久保川達也. (2006). <a href="https://doi.org/10.5023/jappstat.35.139">線形混合モデルと小地域の推定</a>. <em>応用統計学</em>, <em>35</em>(3), 139–161.
</div>
<div id="ref-田邉國士2010" class="csl-entry">
田邉國士. (2010). <a href="https://doi.org/10.11540/bjsiam.20.2_162">赤池弘次先生を悼む</a>. <em>応用数理</em>, <em>20</em>(2), 162–164.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>ただし回帰モデルを「因果効果」の推定に用いる際には，通常とは異なる，仮定に対する精査が必要になる．最も安全には，<img src="https://latex.codecogs.com/png.latex?x"> が変化した際の <img src="https://latex.codecogs.com/png.latex?y"> の変化量を単なる「比較」の文脈で説明することである．この「違い」が <img src="https://latex.codecogs.com/png.latex?x"> の変化により生み出されたとは限らないためである．<span class="citation" data-cites="Gelman-Hill-Vehtari2020">(6.4 節 Gelman, Hill, et al., 2020, p. 85)</span> も参照．↩︎</p></li>
<li id="fn2"><p>improper な一様事前分布を用いた場合，引き続き不安定なままな可能性はある．だが多くのデフォルト事前分布は，weakly informative というように，軽微な情報を加えることで正則化が働くように設定されている裾の（適度に）広い事前分布であることが多い．↩︎</p></li>
<li id="fn3"><p>従来は事前分布の経験ベイズ推定と呼ばれていた考え方である <span class="citation" data-cites="Gelman+2020">(Gelman, Vehtari, et al., 2020, p. 6)</span>．↩︎</p></li>
<li id="fn4"><p>一方で多くの頻度論的な手法は，無情報事前分布を仮定したベイズ推論とみなせる．そこでベイズの，有効な頻度論的モデルを探索するための方法としての美点が見えてくるのである．↩︎</p></li>
<li id="fn5"><p>この点については <span class="citation" data-cites="Gelman2014">(Gelman, 2014)</span> も参照．大統領選における有権者の行動のモデリングを，ベイズ階層モデルに基づいて探索的に実行しており，“multilevel Bayesian modeling can be considered as an elaborate form of exploratory data analysis” と結論している．↩︎</p></li>
<li id="fn6"><p>もちろん重要な事前情報や予備解析が存在する場合は，これを事前分布としてどう更新されるかをみるのが良い．<span class="citation" data-cites="Gelman-Hill-Vehtari2020">(1.6 節 Gelman, Hill, et al., 2020, p. 16)</span> に簡潔な概観的議論がある．↩︎</p></li>
<li id="fn7"><p><span class="citation" data-cites="Bafumi-Gelman2007">(Bafumi and Gelman, 2007)</span> では unmodeled varying intercept と呼んでいる．↩︎</p></li>
<li id="fn8"><p>すると「自由度」とは変動係数の数に他ならない．↩︎</p></li>
<li id="fn9"><p>同様の縮小効果を得るための点推定手続きが，<strong>経験ベイズ</strong> の名称で研究されている <span class="citation" data-cites="Efron-Morris1973">(Efron and Morris, 1973)</span>, <span class="citation" data-cites="Efron-Morris1975">(Efron and Morris, 1975)</span>．これについては <span class="citation" data-cites="久保川達也2006">(久保川達也, 2006)</span> も参照．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Bayesian</category>
  <category>Statistics</category>
  <guid>https://162348.github.io/posts/2024/Survey/BDA1.html</guid>
  <pubDate>Thu, 05 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Survey/Files/BayesianWorkflow.svg" medium="image" type="image/svg+xml"/>
</item>
<item>
  <title>英国研究滞在記</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Life/UCL.html</link>
  <description><![CDATA[ 





<section id="はじまり" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="はじまり"><span class="header-section-number">1</span> はじまり</h2>
<div class="article-card-container">
  <blockquote class="twitter-tweet blockquote"><p lang="ja" dir="ltr">11/4 からロンドンに１ヶ月ほど滞在します。<br><br>ロンドン（広くイギリス）は自分の中ではベイズ計算の中心地の１つと目してますので大変楽しみです。 <a href="https://t.co/gaGrnnLTRl">https://t.co/gaGrnnLTRl</a></p>— Hirofumi Shiba (@ano2math5) <a href="https://twitter.com/ano2math5/status/1839560243795386756?ref_src=twsrc%5Etfw">September 27, 2024</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
</div>
<p>11月3日から12月3日までの１ヶ月間，総研大の<a href="https://www.soken.ac.jp/education/dispatch/sokendai_studentdispatchprogram/">研究派遣プログラム</a>の援助を受けて，イギリス・ロンドンの <a href="https://en.wikipedia.org/wiki/University_College_London">UCL</a> (University College London) の Alexandros Beskos 教授を訪問した．</p>
<p>Alex は拡散過程の Monte Carlo シミュレーションや MCMC (Markov Chain Monte Carlo)，さらには SMC (Sequential Monte Carlo) と幅広い守備範囲を持つベイズ計算 (Bayesian Computation) の大家である．</p>
<p>UCL はロンドン大学 (University of London) に所属するカレッジの１つであり，「功利主義」の哲学で有名な Jeremy Bentham によって，世界で初めての性別・宗教・出自・肌の色に依らず入学できる大学として 19 世紀前半に創立された．</p>
<!--
> 当時のオックスフォード大学・ケンブリッジ大学が、男性・イギリス国教徒・貴族出身者という差別的な入学条件を設けていたのに対して、UCLはイギリスで初めて平等な基準によって女性を受け入れ、宗教・政治的思想・人種による入学差別を撤廃した。このような歴史から、UCLは自由主義・平等主義の大学として知られている。
> [Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%A6%E3%83%8B%E3%83%B4%E3%82%A1%E3%83%BC%E3%82%B7%E3%83%86%E3%82%A3%E3%83%BB%E3%82%AB%E3%83%AC%E3%83%83%E3%82%B8%E3%83%BB%E3%83%AD%E3%83%B3%E3%83%89%E3%83%B3) より 

この動きには当然反動もあり，ロンドン大学の別のカレッジである King's College London が，その後すぐに男性・イギリス国教徒・貴族出身に限定された Oxford や Cambridge を踏襲する大学として設立されたという．
-->
<p>このような歴史もあり，UCL の統計の博士課程には極めて多様な背景（国籍・人種・宗教など）を持った学生が揃っている．自分はそのことが最も気に入った．Alex の学生にはイギリス出身の Chris や日本出身の井口さんがいた．他に筆者と仲良くしてくれた学生は，カナダ，ギリシャ，マレーシア，中国出身と，誰ひとり被っていなかった．</p>
<p>受入教員である Alex も元はギリシャの出身であり，滞在最後に一緒にご飯を食べたときには UCL で採用に至るまでの面接の苦労を話してくれた．</p>
<p>この多様性にみんな慣れていることもあってか，初のヨーロッパ体験に借りてきた猫状態だった自分も，滞在一週間も経たずに「馴染めた」「仲間にしてもらえた」と感じた．それにはイギリスのパブ文化の影響もあっただろう．</p>
<p>金曜日の夜にパブに行く文化があると事前に聞いていたから，勇気を出して Ph.D.&nbsp;部屋に残っていた人を誘ってみた．５時だったが部屋にはほとんど人はいなかった．UCL はロンドンの中心にあり，その近くは大変家賃が高いため，多くの生徒は郊外に住む（Oxford から通っている学生もいる）．そのため５時には大抵の学生は帰ろうとし始めるのだ．（そして寮は博士１年生しか利用できない．）</p>
<p>中でも Teresa は帰って作り置きの夕飯を食べる予定だったところを変更してまで，僕の誘いを快諾してくれた．結局メンバーは５人にまで増え，まずはピザを食べにいき，その後パブで一杯飲んだ．</p>
<p>Teresa は台湾の出身であるが，カナダの McGill 大学で数学を専攻してから UCL の統計博士課程に進み，今は同時に医局で統計スタッフとして働いてもいる．自分が「イギリスどころかヨーロッパが初めてで，パブに行ってみたいが勇気が出ない」と素直に伝えると，当時の自分の境遇と重なったこともあってか，大変歓迎して友人も誘い合わせてパブへ連れて行ってくれたのである．</p>
<p>日本の飲み屋は食事とアルコールを同時に提供するが，イギリスではその２つの機能はレストランとパブが別々に担っているのだと自分は理解した．するとパブが必然的に「二軒目」になっており，その頃にはすっかり仲間だという感じになって腹をわった話ができる．大変不思議な感覚である．</p>
</section>
<section id="研究環境" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="研究環境"><span class="header-section-number">2</span> 研究環境</h2>
<p>正直学生のレベル感は ISM とほとんど差を感じない．だが「ロンドン界隈」全体としては，総じて環境は全く違うと言わざるを得ないと感じた．</p>
<p>かの Thomas Bayes もロンドンがうんだように，イギリスでは現在もベイズの豊かな土壌があり，一週間のうちに必ずどこかではベイズ計算に関連するセミナーが開催されている．そして大変多くの人が集まるのである．この環境だけは世界の他のどこにもないだろう．</p>
<p>さらに滞在の最後に当たる 11/25（月）から 11/29（金）までの５日間，<a href="https://en.wikipedia.org/wiki/Isaac_Newton_Institute">INI</a> (Isaac Newton Institute) にてベイズ計算に特化したワークショップ <a href="https://www.newton.ac.uk/event/ssdw04/">Monte Carlo Sampling: Beyond the Diffusive Regime</a> が行われた．</p>
<div class="article-card-container">
  <blockquote class="twitter-tweet blockquote"><p lang="en" dir="ltr">I’m here! <a href="https://t.co/N4YTmmJFCo">https://t.co/N4YTmmJFCo</a></p>— Hirofumi Shiba (@ano2math5) <a href="https://twitter.com/ano2math5/status/1861151663911817696?ref_src=twsrc%5Etfw">November 25, 2024</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<p>この INI というのが大変興味深い組織である．1992 年に Cambridge 大学の２つのカレッジ St.&nbsp;Jones と Trinity の出資により設立された数理に特化した研究施設であるが，ここにパーマネントに所属する研究者というのは原則存在せず，基本は６ヶ月ごとに入れ替わる．しかしこの６ヶ月間というのは，テーマを決めてそれに関連する研究者を世界中から呼び込み，INI という一箇所に集めての「６ヶ月」なのである．</p>
<p>私が参加したこの５日間のワークショップも，Monte Carlo 法に関する研究プログラム <a href="https://www.newton.ac.uk/event/ssd/">Stochastic systems for anomalous diffusion</a> の一環として開催されている．このワークショップの参加者も，希望すれば一定期間オフィスをもらい，ワークショップの前後に渡って滞在することができる．</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Life/Images/INI.jpeg" class="img-fluid figure-img"></p>
<figcaption>INI 最上階からの写真．写真左手前が Alex である．</figcaption>
</figure>
</div>
<p>INI にはありとあらゆるところに黒板が用意されている．トイレの中にもある．そのことがこんなにも違いを生むとは思わなかった．参加者は年齢に依らず，休み時間になると活発に議論をした．</p>
<div class="article-card-container">
  <blockquote class="twitter-tweet blockquote"><p lang="en" dir="ltr">Even in the bathroom, we have blackboard here.<br><br>Really good environment. <a href="https://t.co/61nZzXMSaw">pic.twitter.com/61nZzXMSaw</a></p>— Hirofumi Shiba (@ano2math5) <a href="https://twitter.com/ano2math5/status/1862170446273135070?ref_src=twsrc%5Etfw">November 28, 2024</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</section>
<section id="monte-carlo-ワークショップ" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="monte-carlo-ワークショップ"><span class="header-section-number">3</span> Monte Carlo ワークショップ</h2>
<p>このワークショップの最大の特徴は統計と物理の２分野の邂逅であった．Monte Carlo 法は物理学に端を発する計算技術であるが，今では統計学にも大きな研究コミュニティがあり，「ベイズ計算」はその一つである．統計と物理の研究者が語彙をすり合わせながら互いに歩み寄る極めて貴重な機会だったと言えるだろう．</p>
<div class="article-card-container">
  <blockquote class="twitter-tweet blockquote"><p lang="ja" dir="ltr">Mpemba 効果（より熱い水の方が冷たい水より先に凍ることがある）への理解を深めれば，より速く収束する MCMC が作れるかもしれない……？<br><br>Check out "Anomalous thermal relaxation on dense graphs with Metropolis-Hastings dynamics" by Marija Vucelja<a href="https://t.co/c9N7Eftmqx">https://t.co/c9N7Eftmqx</a></p>— Hirofumi Shiba (@ano2math5) <a href="https://twitter.com/ano2math5/status/1861411397676007652?ref_src=twsrc%5Etfw">November 26, 2024</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
</div>
<p>最初の講演は “beyond the diffusive regime” という副題を象徴する統計物理学者である Werner Krauth 氏の発表から始まった．公式 YouTube チャンネルに <a href="https://www.youtube.com/watch?v=PNtIrA88ae4">アーカイブ</a> が残っている．Werner は ECMC (Event Chain Monte Carlo) という新たな Monte Carlo 法を開発することで，水の融解の全粒子シミュレーションを世界で初めて成功させた．</p>
<p><a href="https://www.youtube.com/watch?v=PNtIrA88ae4"><img src="https://162348.github.io/posts/2024/Life/Images/WernerKrauth.png" class="img-fluid"></a></p>
<p>diffusive regime とは熱平衡にある系が示す特徴である．したがって多峰性分布からも効率的にサンプリングができるような次世代の Monte Carlo 法をデザインするためには，diffusive regime から脱すること (= beyond the diffusive regime) がいくらか必要条件になる，ということから始まった．</p>
<p>続いて Werner は diffusive regime を超越する Monte Carlo 法に，「局所性」を破る HMC (Hamiltonian / Hybrid Monte Carlo) と「対称性」を破る ECMC / PDMP (Piecewise Deterministic Markov Process) の２つがあるとして，現状のベイズ計算を概観した．（ここでも二分野の語彙の違いが出ている，統計が PDMP と呼ぶものを物理は ECMC と呼ぶ．）</p>
<p>このプレゼンはワークショップ全体のアジェンダを設定したと言えるものであった．それだけでなく，その後ワークショップの全体を通して，Werner は最も影響力を持つ存在であった．何より，５日間を通して最前列で最も活発に質問するだけでなく，筆者のような修士の学生とも議論する時間を惜しまなかった．「英語では教授は Sir をつけて呼ぶべきなのだろうか」とか考えてひたすら恐れ入っている自分に “I’m also a learner here.” と対等に議論しようとふっかけてくれたことが嬉しかった．</p>
<p>Werner は７時にお腹が空いてどうしようもなくなるまで INI に残っていた．言語の壁を超えて伝わってくる人格があった．どこか現代の Feynman に出会ったような感覚であった．僕はこの仕事がますます好きになるばかりだ．</p>
<p>そこで翌日も INI に残っていたらどんな人に出会うかとワクワクしていたが，気づけば 10 時過ぎまでカードゲームをしていた．Andi Q. Wang 氏は MCMC の収束を関数不等式を用いて議論する研究をしている．彼はどの学会にもスウェーデンで買ったカードゲームを持参するようで，今回は Blood on Clocktower という人狼をさらに複雑にしたようなゲームを８人でプレイした．スウェーデンでは毎年１つボードゲームが無料でもらえるらしい．</p>
<p>研究の話じゃなくなると本当に英語は難しい．オランダ・ギリシャ・スロベニア・インドと，英語が母語じゃない研究者もたくさんプレイしていたはずであるが，彼らはとんでもなく英語がうまい．全く気後れしている様子がなかった．やはりインド・ヨーロッパ語族から外れた母語を持つと，ハンディキャップが大きいのだろうかなどと考えざるを得なかった．正直，ゲームは楽しいというより苦しかった．</p>
<div class="article-card-container">
  <blockquote class="twitter-tweet blockquote"><p lang="en" dir="ltr">Although some of my colleagues (might) praise me for my Englisg skills, I am useless itself when playing cardgame with people here.</p>— Hirofumi Shiba (@ano2math5) <a href="https://twitter.com/ano2math5/status/1861569171902865744?ref_src=twsrc%5Etfw">November 27, 2024</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</section>
<section id="共同研究" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="共同研究"><span class="header-section-number">4</span> 共同研究</h2>
<p>今回のロンドン滞在の話は，実は最初は断るつもりであった．英語以前にも，そもそも自分は修士２年でまだ論文もなく，「滞在先の先生に何も提供できないのではないか」という懸念が後ろ髪を引いた．しかし，副指導教員の先生や家族に「失敗しても失うものはない」と大きく背中を押されたこともあり，自分の運命を受け入れることにした．</p>
<p>修士２年で夏休みを終えたばかりの自分はというと，いまいち指導教員の先生がやっているような MCMC や SMC の理論解析には踏み切れずにいた．MCMC や PDMP のアルゴリズムは十分理解したつもりだったし，使う数学にも慣れてきたが，いまいち心がついてこなかった．</p>
<p>そのような中で９月に奇縁でソウル大学の政治学者（かつベイジアン！）である Jong Hee Park （박종희）氏に PDMP について発表する機会があった．全く新しい MCMC であるからしばらくは戸惑っていたようであるが，話すうちに「これは使える！」という反応をもらった．</p>
<p>そのアイデアは要するに「モデル選択に使えるのではないか？」ということであった．すごく意外だった．</p>
<p>PDMP とは，従来の Metropolis-Hastings 法を非可逆化したアルゴリズムの，さらに提案分布の分散を小さくしていく極限を取ったものと考えることができる．その結果，割り切った (ballistic) ダイナミクスとより速いエルゴード収束レートをもつ．これにより Monte Carlo 分散を従来の MCMC より小さくできることが期待されていた．</p>
<p>自分はこのことを数学的に証明できたかもしれないが，だからといって PDMP が何の役に立つかを全く知らなかったのである．</p>
<p>そこで出発までの１ヶ月で PDMP サンプリングを実行するための <a href="../../../posts/2024/Julia/PDMPFlux.html">パッケージ</a> を作ってみた．ギリギリ動くものができた段階でロンドンに向かったのである．</p>
<p>正直，本当の興味はどちらかというと SMC と最適輸送の関係にあった．こちらの話も，なるほど interesting だと共感はしてもらえたが，アイデアが未成熟で具体的に次のステップに繋げることができなかった．しかしこの PDMP パッケージの話が出ると新たな方向が見えた．Alex 自身に PDMP に関する著作はないが，昨今 Graphical Model のベイズモデル選択には大きな興味があった．</p>
<p>そこで，パッケージの応用先の例として筆者がそれとなく挙げた巨大な階層モデル（<a href="../../../posts/2024/TransDimensionalModels/IdealPoint.html">理想点モデル</a>）を PDMP で推定することと，そのモデル選択のための新種のトリックに大きく興味を持ったようだった．</p>
<p>INI の３日目（中間日）は午後には講演はなく，参加者は思い思いの場所で議論に耽っていた．Alex は自分のアイデアに大変興味を持ってくれて，PDMP の大家である Samuel Livingstone とその学生である Luke も誘い合わせてミーティングを企画してくれた．Luke は，殊に PDMP の具体的な統計モデルへの応用については現時点で世界で最も詳しい人間かもしれない．</p>
<p>僕が黒板に文字を書くなり，奥から Samuel が羽衣チョークを持ち出してきたときには笑った．Samuel は６ヶ月 INI に滞在しているメンバーであり，自室に羽衣チョークのストックを作っていたのである（UCL に黒板はない）．他の INI 滞在メンバーである，これまた PDMP の専門家である Georgios Vasdekis に至っては，６ヶ月の会期が終わると使い所がないからと１本プレゼントしてくれた．</p>
<div class="article-card-container">
  <blockquote class="twitter-tweet blockquote"><p lang="en" dir="ltr">Hagoromo （羽衣） chalk presented by Georgios <a href="https://t.co/3x9POrgti3">pic.twitter.com/3x9POrgti3</a></p>— Hirofumi Shiba (@ano2math5) <a href="https://twitter.com/ano2math5/status/1862128963239256497?ref_src=twsrc%5Etfw">November 28, 2024</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
</div>
</section>
<section id="終わりに" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="終わりに"><span class="header-section-number">5</span> 終わりに</h2>
<p>３週間という長い期間 UCL に滞在でき，他の Ph.D.&nbsp;学生と交流できたことと，今回の極めて自分の専門に焦点のあった INI のワークショップに参加できた意義は，計り知れないほど大きい．</p>
<p>自分は海を隔てれば同志がいることを知った．また INI ワークショップの講演者は，まるで自分が読んできた論文の著者リストであった．</p>
<p>論文を読むだけでなく，それについて他人とディスカッションすることは，全く別の行為であることを学んだ．ディスカッションを通じて，既存のリテラチャーに +1 をするような考え方だけでなく，遠く離れた２つのアイデアを結びつける「核」というものが特定できる気がする．</p>
<!-- 自分は論文というものが好きだ．それ自体で完結しており，世界中のどこに生まれようとも，数学と英語を学べばその最先端の発見を共有できる．身近に識者がおらずとも，参考文献を辿れば真実に辿り着ける．博士学生にとって真の師とは論文であり，指導教員は補助をしたり，読むべき論文を教えたりすることしかできない．

だが論文を書くことは，論文を読んでいるだけ -->
<p>実際，自分の原稿であろうと，いざ黒板の前に立って思い出せることはごく一部なのである．アイデアは論文ではなく人に宿るのである……．</p>
<div class="article-card-container">
  <blockquote class="twitter-tweet blockquote"><p lang="ja" dir="ltr">いろんな人と将来コラボしたいから広い知見と深い数学が欲しい。だが自分だけのオリジナルな結果も博士で欲しい。二つのバランスをずっと考えている。</p>— Hirofumi Shiba (@ano2math5) <a href="https://twitter.com/ano2math5/status/1861567988073222543?ref_src=twsrc%5Etfw">November 27, 2024</a></blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>


</section>

 ]]></description>
  <category>Life</category>
  <guid>https://162348.github.io/posts/2024/Life/UCL.html</guid>
  <pubDate>Sun, 01 Dec 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Life/Images/INI.jpeg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>PDMPFlux.jl パッケージ</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Julia/PDMPFlux.html</link>
  <description><![CDATA[ 





<section id="速習-pdmp" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="速習-pdmp"><span class="header-section-number">1</span> 速習 PDMP</h2>
<section id="はじめに" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">1.1</span> はじめに</h3>
<p>PDMP (Piecewise Deterministic Markov Process) または <strong>連続時間 MCMC</strong> とは，名前の通り MCMC のサンプリングを連続時間で行うアルゴリズムである：</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Slides/zigzag_fps14_WhiteBackground.gif" class="img-fluid figure-img"></p>
<figcaption>Zig-Zag サンプラーが２次元の正規分布からサンプリングを実行している様子</figcaption>
</figure>
</div>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="PDMP サンプラーの特徴">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
PDMP サンプラーの特徴
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>方向転換をするオレンジ色の点を一定の法則（Poisson 点過程）に従って定めることで，<strong>軌跡全体が目標の分布に従う</strong>．</p></li>
<li><p>目標の関数を緑色の軌跡上で線積分をすれば期待値が得られる．一定のステップサイズで切り出してサンプルとし，従来の MCMC output と同様に使っても良い．</p></li>
<li><p><strong>非可逆</strong> なダイナミクスをもち，HMC や MALA などの可逆なサンプラーよりも高次元分布や多様性に強いと期待されている．</p></li>
</ul>
</div>
</div>
<p>詳しくは次の記事も参照：</p>
<div id="listing-PDMP-listing" class="quarto-listing quarto-listing-container-grid">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="TUNNQyUyQ0NvbXB1dGF0aW9uJTJDSnVsaWElMkNTYW1wbGluZw==" data-listing-date-sort="1721260800000" data-listing-file-modified-sort="1754014116605" data-listing-date-modified-sort="1724889600000" data-listing-reading-time-sort="14" data-listing-word-count-sort="2629">
<a href="../../../posts/2024/Stat/ZigZagSubsampling.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Stat/MeanOfGaussian.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
Zig-Zag サンプラーのサブサンプリングによるスケーラビリティ
</h5>
<div class="card-subtitle listing-subtitle">
大規模モデル・大規模データに対する MCMC を目指して
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('TUNNQw=='); return false;">MCMC</div>

<div class="listing-category" onclick="window.quartoListingCategory('Q29tcHV0YXRpb24='); return false;">Computation</div>

<div class="listing-category" onclick="window.quartoListingCategory('SnVsaWE='); return false;">Julia</div>

<div class="listing-category" onclick="window.quartoListingCategory('U2FtcGxpbmc='); return false;">Sampling</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-07-18
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="UHJvY2VzcyUyQ1NhbXBsaW5nJTJDSnVsaWElMkNNQ01D" data-listing-date-sort="1719964800000" data-listing-file-modified-sort="1754014115568" data-listing-date-modified-sort="1721260800000" data-listing-reading-time-sort="13" data-listing-word-count-sort="2488">
<a href="../../../posts/2024/Process/ZigZag.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:PDMP-listing:posts/2024/Process/ZigZag.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
Zig-Zag 過程によるサンプリング
</h5>
<div class="card-subtitle listing-subtitle">
ジャンプと確定的な動きによる新たな MCMC 手法
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('UHJvY2Vzcw=='); return false;">Process</div>

<div class="listing-category" onclick="window.quartoListingCategory('U2FtcGxpbmc='); return false;">Sampling</div>

<div class="listing-category" onclick="window.quartoListingCategory('SnVsaWE='); return false;">Julia</div>

<div class="listing-category" onclick="window.quartoListingCategory('TUNNQw=='); return false;">MCMC</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-07-03
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="UHJvY2VzcyUyQ1NhbXBsaW5nJTJDUg==" data-listing-date-sort="1706659200000" data-listing-file-modified-sort="1754014115565" data-listing-date-modified-sort="1719878400000" data-listing-reading-time-sort="7" data-listing-word-count-sort="1230">
<a href="../../../posts/2024/Process/PureJump.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Process/PureJump_files/figure-html/unnamed-chunk-1-1.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
純粋跳躍過程の生成作用素と区分的確定的 Markov 過程
</h5>
<div class="card-subtitle listing-subtitle">
ジャンプと確定的な動きによる新たな MCMC 手法
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('UHJvY2Vzcw=='); return false;">Process</div>

<div class="listing-category" onclick="window.quartoListingCategory('U2FtcGxpbmc='); return false;">Sampling</div>

<div class="listing-category" onclick="window.quartoListingCategory('Ug=='); return false;">R</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-01-31
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
</section>
<section id="使い方" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="使い方"><span class="header-section-number">1.2</span> 使い方</h3>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">PDMPFlux</span></span></code></pre></div>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="自動微分を使う場合（推奨）">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
自動微分を使う場合（推奨）
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>まずポテンシャル＝<strong>負の対数尤度</strong>を（定数倍の違いを除いて）自分で定義する：</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">U_Gauss</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector</span>)</span>
<span id="cb2-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.^</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div>
<p>標準正規分布 <img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7BN%7D_d(0,I_d)"> だと，対数尤度は <img src="https://latex.codecogs.com/png.latex?%0A%5Clog%5Cphi(x)%20=%20-%20%5Cfrac%7B1%7D%7B2%7D%5Csum_%7Bi=1%7D%5Ed%20x_i%5E2%20-%20%5Cfrac%7Bd%7D%7B2%7D%5Clog(2%5Cpi)%0A"> 第二項は定数であるから無視して良い．<img src="https://latex.codecogs.com/png.latex?U(x)%20=%20-%5Clog%5Cphi(x)"> とすべき点に注意（先頭のマイナス符号は落とす）．</p></li>
<li><p>次のようにしてサンプラーをインスタンス化する：</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1">dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb3-2">sampler <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ZigZagAD</span>(dim, U_Gauss)</span></code></pre></div></li>
<li><p>ハイパーパラメータを与えてサンプリングを実行する．</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1">N_sk, N, xinit, vinit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1_000_000</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1_000_000</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(dim), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ones</span>(dim)</span>
<span id="cb4-2">samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(sampler, N_sk, N, xinit, vinit, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>)</span></code></pre></div></li>
<li><p>結果の可視化を行う．</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jointplot</span>(samples)</span></code></pre></div></li>
</ol>
<p><img src="https://162348.github.io/posts/2024/Julia/Files/jointplot_Zygote.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="自動微分を使わず，ポテンシャルの勾配を手動で与える場合">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
自動微分を使わず，ポテンシャルの勾配を手動で与える場合
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1">sampler <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ZigZag</span>(dim, grad_U, grid_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>grid_size)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize your Zig-Zag sampler</span></span>
<span id="cb6-2">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample_skeleton</span>(sampler, N_sk, xinit, vinit, verbose <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># simulate skeleton points</span></span>
<span id="cb6-3">samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample_from_skeleton</span>(sampler, N, output)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get samples from the skeleton points</span></span></code></pre></div>
<p>とできる．</p>
<p><code>output::PDMPHistory</code> にはサンプラーの挙動を確認するための多くのメソッドが定義されている：</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_traj</span>(output, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>)</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diagnostic</span>(output)</span></code></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="pdmp_jax-パッケージ" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="pdmp_jax-パッケージ"><span class="header-section-number">2</span> <a href="https://github.com/charlyandral/pdmp_jax"><code>pdmp_jax</code></a> パッケージ</h2>
<p>本節では PDMP のシミュレーションに自動微分を応用した <span class="citation" data-cites="Andral-Kamatani2024">(Andral and Kamatani, 2024)</span> のアルゴリズムを紹介する．</p>
<section id="デモ" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="デモ"><span class="header-section-number">2.1</span> デモ</h3>
<p><span class="citation" data-cites="Neal2003">(Neal, 2003)</span> が slice sampling のデモ用に定義した <strong>漏斗分布</strong> を考える： <img src="https://latex.codecogs.com/png.latex?%0Ap(y,x)=%5Cphi(y;0,3)%5Cprod_%7Bi=1%7D%5E9%5Cphi(x_i;0,e%5E%7By/2%7D),%5Cqquad%20y%5Cin%5Cmathbb%7BR%7D,x%5Cin%5Cmathbb%7BR%7D%5E9.%0A"></p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax</span>
<span id="cb8-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jax.scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> multivariate_normal</span>
<span id="cb8-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jax.scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> norm</span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax.numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jnp</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> funnel(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, sig<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, clip_y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>):</span>
<span id="cb8-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Funnel distribution for testing. Returns energy and sample functions."""</span></span>
<span id="cb8-9"></span>
<span id="cb8-10">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> unbatched(x):</span>
<span id="cb8-11">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb8-12">    log_density_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb8-13"></span>
<span id="cb8-14">    variance_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.exp(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-15"></span>
<span id="cb8-16">    log_density_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> jnp.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> variance_other)</span>
<span id="cb8-17"></span>
<span id="cb8-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> log_density_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> log_density_other</span>
<span id="cb8-19"></span>
<span id="cb8-20">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sample_data(n_samples):</span>
<span id="cb8-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from Nd funnel distribution</span></span>
<span id="cb8-22">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (sig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jnp.array(np.random.randn(n_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))).clip(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>clip_y, clip_y)</span>
<span id="cb8-23">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.array(np.random.randn(n_samples, d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jnp.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> jnp.concatenate((y, x), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-25"></span>
<span id="cb8-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> unbatched, sample_data</span></code></pre></div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pdmp_jax <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pdmp</span>
<span id="cb9-2">dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb9-3">U, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> funnel(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dim)</span>
<span id="cb9-4">grad_U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.grad(U)</span>
<span id="cb9-5">seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb9-6">xinit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.ones((dim,)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initial position</span></span>
<span id="cb9-7">vinit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.ones((dim,))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initial velocity</span></span>
<span id="cb9-8">grid_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb9-9">N_sk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of skeleton points</span></span>
<span id="cb9-10">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of samples</span></span>
<span id="cb9-11">sampler <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pdmp.ZigZag(dim, grad_U, grid_size)</span>
<span id="cb9-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample the skeleton of the process</span></span>
<span id="cb9-13">out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sampler.sample_skeleton(N_sk, xinit, vinit, seed, verbose <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># takes only 3 seconds on my M1 Mac</span></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from the skeleton</span></span>
<span id="cb9-15">sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sampler.sample_from_skeleton(N,out)</span></code></pre></div>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb10-2">sns.jointplot(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sample[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sample[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb10-3">plt.show()</span></code></pre></div>
<p><img src="https://162348.github.io/posts/2024/Julia/Files/funnel_pdmp_jax.png" class="img-fluid"></p>
<p><img src="https://162348.github.io/posts/2024/Julia/Files/funnel_pdmp_jax_diagnostics.png" class="img-fluid"></p>
<p>number of error bound : 46817</p>
</section>
<section id="サンプリングループの構造" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="サンプリングループの構造"><span class="header-section-number">2.2</span> サンプリングループの構造</h3>
<!--


::::::{.cell layout-align="default"}

:::::{.cell-output-display}

::::{}
`<figure class=''>`{=html}

:::{}

<pre class="mermaid mermaid-js">flowchart LR
  A[&quot;one_step()
  while !state.indicator
  state=one_step_while()
  &quot;]--|`tp &lt;= state.horizon`|B
</pre>
:::
`</figure>`{=html}
::::
:::::
::::::

-->
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD;
  A["one_step()"] --&gt;|state.indicator=false| B["one_step_while()"]
  B --&gt; C{tp &lt;= state.horizon}
    C --&gt;|No| D[move_to_horizon]
    C --&gt;|Yes| E[move_before_horizon]
    E --&gt;|state.accept=false| G[inner_while]
    G --&gt; I{ar &lt;= 1.0}
    I --&gt;|No| J[error_acceptance]
    I --&gt;|Yes| K[ok_acceptance]
    K --&gt;|reject| L["if_reject()"]
    L --&gt;|場合によっては move_to_horizon2| N["inner_while() か one_step_while() まで戻る"]
    K --&gt;|accept| O["if_accept()
    state.indicator=true
    "]
    D --&gt; B
    J --&gt;|horizon を縮める| N
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ol type="1">
<li><p><code>ar=lambda_t/state.lambda_bar</code> によって Poisson thinning を行う．</p>
<p>ただし，<code>lambda_bar</code> とは近似的な上界であり，「最も近い直前の grid 上の点での値」でしかない．当然 <code>lambda_t</code> を超過し得る．そのような場合に <code>error_acceptance()</code> に入る．</p></li>
<li><p><code>error_acceptance()</code> に入った場合，<code>horizon</code> を縮めてより慎重に同じ区間を Poisson thinning しなおす．<code>adaptive=true</code> の場合はこのタイミングで <code>horizon</code> を恒久的に縮める．</p></li>
<li><p>最後 <code>if_reject()</code> に入った場合，<code>horizon</code> に到達したら <code>one_step_while()</code> まで戻るが，そうでない場合は <code>inner_while()</code> まで戻る実装がなされている．</p></li>
</ol>
<p><img src="https://162348.github.io/posts/2024/Julia/Files/SamplingLoop.jpg" class="img-fluid"></p>
</section>
<section id="適応的なステップサイズ" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="適応的なステップサイズ"><span class="header-section-number">2.3</span> 適応的なステップサイズ</h3>
</section>
</section>
<section id="pdmpflux.jl-パッケージ" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="pdmpflux.jl-パッケージ"><span class="header-section-number">3</span> <a href="https://github.com/162348/PDMPFlux.jl"><code>PDMPFlux.jl</code></a> パッケージ</h2>
<section id="デモ-1" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="デモ-1"><span class="header-section-number">3.1</span> デモ</h3>
<div id="96f99731" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">PDMPFlux</span></span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Random</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Distributions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Plots</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LaTeXStrings</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Zygote</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LinearAlgebra</span></span>
<span id="cb11-4"></span>
<span id="cb11-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb11-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Funnel distribution for testing. Returns energy and sample functions.</span></span>
<span id="cb11-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    For reference, see Neal, R. M. (2003). Slice sampling. The Annals of Statistics, 31(3), 705–767.</span></span>
<span id="cb11-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb11-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">funnel</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, σ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span>, clip_y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)</span>
<span id="cb11-10"></span>
<span id="cb11-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">neg_energy</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector{Float64}</span>)</span>
<span id="cb11-12">        v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb11-13">        log_density_v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logpdf</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Normal</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span>), v)</span>
<span id="cb11-14">        variance_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(v)</span>
<span id="cb11-15">        other_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-16">        cov_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> variance_other</span>
<span id="cb11-17">        mean_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zeros</span>(other_dim)</span>
<span id="cb11-18">        log_density_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">logpdf</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MvNormal</span>(mean_other, cov_other), x[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span>])</span>
<span id="cb11-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> log_density_v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> log_density_other</span>
<span id="cb11-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb11-21"></span>
<span id="cb11-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample_data</span>(n_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>)</span>
<span id="cb11-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from Nd funnel distribution</span></span>
<span id="cb11-24">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clamp</span>.(σ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">randn</span>(n_samples, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>clip_y, clip_y)</span>
<span id="cb11-25">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">randn</span>(n_samples, d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>.(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb11-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hcat</span>(y, x)</span>
<span id="cb11-27">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb11-28"></span>
<span id="cb11-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> neg_energy, sample_data</span>
<span id="cb11-30"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb11-31"></span>
<span id="cb11-32"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_funnel</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, n_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>)</span>
<span id="cb11-33">    _, sample_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">funnel</span>(d)</span>
<span id="cb11-34">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample_data</span>(n_samples)</span>
<span id="cb11-35"></span>
<span id="cb11-36">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最初の2次元を抽出（yとx1）</span></span>
<span id="cb11-37">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb11-38">    x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb11-39"></span>
<span id="cb11-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 散布図をプロット</span></span>
<span id="cb11-41">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scatter</span>(y, x1, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, markersize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>L<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>L<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x_1"</span>, </span>
<span id="cb11-42">            title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Funnel Distribution (First Two Dimensions' Ground Truth)"</span>, grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>, legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#78C2AD"</span>)</span>
<span id="cb11-43"></span>
<span id="cb11-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># xlim と ylim を追加</span></span>
<span id="cb11-45">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlims!</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x軸の範囲を -8 から 8 に設定</span></span>
<span id="cb11-46">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylims!</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># y軸の範囲を -7 から 7 に設定</span></span>
<span id="cb11-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb11-48"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_funnel</span>()</span>
<span id="cb11-49"></span>
<span id="cb11-50"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_ZigZag_on_funnel</span>(N_sk<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100_000</span>, N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100_000</span>, d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>=<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Bool</span>=<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>)</span>
<span id="cb11-51">    U, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">funnel</span>(d)</span>
<span id="cb11-52">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grad_U</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector{Float64}</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gradient</span>(U, x)[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb11-53">    xinit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ones</span>(d)</span>
<span id="cb11-54">    vinit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ones</span>(d)</span>
<span id="cb11-55">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span></span>
<span id="cb11-56">    grid_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># constant bounds</span></span>
<span id="cb11-57">    sampler <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ZigZag</span>(d, grad_U, grid_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>grid_size)</span>
<span id="cb11-58">    out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample_skeleton</span>(sampler, N_sk, xinit, vinit, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed, verbose <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> verbose)</span>
<span id="cb11-59">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample_from_skeleton</span>(sampler, N, out)</span>
<span id="cb11-60">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> out, samples</span>
<span id="cb11-61"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb11-62">output, samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_ZigZag_on_funnel</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ４分かかる</span></span>
<span id="cb11-63"></span>
<span id="cb11-64"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jointplot</span>(samples)</span></code></pre></div>
</div>
<p><img src="https://162348.github.io/posts/2024/Julia/Files/funnel_PDMPFlux.png" class="img-fluid"></p>
<p><img src="https://162348.github.io/posts/2024/Julia/Files/funnel_PDMPFlux_diagnostics.svg" class="img-fluid"></p>
<p>このデモコードは <code>Zygote.jl</code> による自動微分を用いると 5:29 かかっていたところが，<code>ForwardDiff.jl</code> による自動微分を用いると 0:21 に短縮された．</p>
</section>
<section id="zygote.jl-と-forwarddiff.jl-による自動微分" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="zygote.jl-と-forwarddiff.jl-による自動微分"><span class="header-section-number">3.2</span> <code>Zygote.jl</code> と <code>ForwardDiff.jl</code> による自動微分</h3>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li><a href="https://juliadiff.org/">JuliaDiff</a>：Differentiation tools in Julia</li>
<li>Zygote (<a href="https://fluxml.ai/Zygote.jl/stable/">Docs</a> / <a href="https://github.com/FluxML/Zygote.jl">GitHub</a>)</li>
<li>ForwardDiff (<a href="https://juliadiff.org/ForwardDiff.jl/dev/">Docs</a> / <a href="https://github.com/JuliaDiff/ForwardDiff.jl">GitHub</a>)</li>
</ul>
</div>
</div>
</div>
<p><code>Zygote.jl</code> は FluxML が開発する Julia の自動微分パッケージである．</p>
<div id="63847cad" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Zygote</span></span>
<span id="cb12-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@time</span> Zygote.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gradient</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0.830714 seconds (3.45 M allocations: 168.328 MiB, 3.95% gc time, 99.98% compilation time)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>(32.0,)</code></pre>
</div>
</div>
<div id="18ec22b9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Vector{Float64}</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>x[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>x[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">g</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Zygote.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gradient</span>(f,x)</span>
<span id="cb15-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">g</span>([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>([6.0, 2.0],)</code></pre>
</div>
</div>
<p>大変柔軟な実装を持っており，広い Julia 関数を微分できる．</p>
<p><code>ForwardDiff.jl</code> <span class="citation" data-cites="Revels+2016">(Revels et al., 2016)</span> は <code>Zygote.jl</code> よりも高速な自動微分を特徴としている．</p>
<div id="5c810516" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ForwardDiff</span></span>
<span id="cb17-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@time</span> ForwardDiff.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">derivative</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0.068804 seconds (260.59 k allocations: 12.725 MiB, 16.89% gc time, 99.92% compilation time)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>32</code></pre>
</div>
</div>
<p><a href="https://github.com/JuliaDiff/ReverseDiff.jl">しかし定義域の次元が <img src="https://latex.codecogs.com/png.latex?100"> 以上の場合は <code>ReverseDiff.jl</code> の方が高速になる</a>．</p>
</section>
<section id="brent-の最適化" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="brent-の最適化"><span class="header-section-number">3.3</span> Brent の最適化</h3>
<p><code>Optim.jl</code> は Julia の最適化パッケージであり，デフォルトで Brent の最適化アルゴリズムを提供する．</p>
<div id="502968bd" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Optim</span></span>
<span id="cb20-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb20-3">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optimize</span>(f, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb20-4">result.minimizer</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>0.999999984947842</code></pre>
</div>
</div>
</section>
<section id="statsplots.jl-による可視化" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="statsplots.jl-による可視化"><span class="header-section-number">3.4</span> <code>StatsPlots.jl</code> による可視化</h3>
<p><a href="https://github.com/JuliaPlots/Plots.jl/tree/v2/StatsPlots"><code>StatsPlots</code> は現在 <code>Plots.jl</code> に統合されている</a>．</p>
<p>また <code>PDMPFlux.jl</code> は <a href="https://github.com/JuliaPlots/Plots.jl/blob/v2/StatsPlots/src/marginalhist.jl"><code>marginalhist</code></a> を wrap した <code>jointplot()</code> 関数を提供する．</p>
</section>
<section id="progressbars.jl-による進捗表示" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="progressbars.jl-による進捗表示"><span class="header-section-number">3.5</span> <code>ProgressBars.jl</code> による進捗表示</h3>
<p><a href="https://github.com/cloud-oak/ProgressBars.jl"><code>ProgressBars.jl</code> は tqdm の Julia wrapper を提供する</a>．<code>PDMPFlux.jl</code> ではこちらを採用して，サンプリングの実行進捗を表示する．</p>
<p>なお <a href="https://github.com/timholy/ProgressMeter.jl"><code>ProgressMeter.jl</code></a> も同様の機能を提供しており，有名な別の PDMP パッケージである <a href="https://github.com/mschauer/ZigZagBoomerang.jl"><code>ZigZagBoomerang.jl</code></a> ではこちらを採用している．</p>
<!-- ### デバッグ

1. `sample_skeleton(sampler::AbstractPDMP, n_sk::Int, xinit::Vector{Float64}, vinit::Vector{Float64}, seed::Int; verbose::Bool=true)::PDMPHistory)::PDMPHistory` が呼ばれる．
2. `init_state(pdmp::AbstractPDMP, xinit::Array{Float64}, vinit::Array{Float64}, seed::Int)` が呼ばれる．
3. 取得した `initial_state` から `PDMPHistory(initial_state)` が呼ばれる．
4. その後 `n_sk` の回数だけ `SamplingLoop.one_step` が実行される． -->
</section>
</section>




<div id="quarto-appendix" class="default"><section id="終わりに" class="level2 appendix" data-number="4"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">4</span> 終わりに</h2><div class="quarto-appendix-contents">

<p>今後の確率的プログラミングの１つの焦点は自動微分かもしれない．</p>
<p>今回のパッケージ開発で，少なくとも <code>v0.2.0</code> の時点では，プログラムに与える <code>U_grad</code> は多くの場合（10 次元の多変量 Gauss，50 次元の Banana など） <code>Zygote.jl</code> が少し速い（Funnel 分布では <code>ForwardDiff.jl</code> が速い）．</p>
<p>しかし上界を構成する際の <code>func</code> の微分は <code>ForwardDiff.jl</code> の方が圧倒的に速い．大変に不可思議である．</p>
<p>だから現在の実装は <code>Zygote.jl</code> と <code>ForwardDiff.jl</code> の両方を用いている．</p>
</div></section><section id="todo" class="level2 appendix" data-number="5"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">5</span> ToDo</h2><div class="quarto-appendix-contents">

<ul>
<li><p>Zig-Zag 以外のサンプラーの実装</p></li>
<li><p>ZigZag(dim) は自動で知ってほしい</p></li>
<li><p>Try clause 内の else を用いているので Julia 1.8 以上が必要．</p></li>
<li><p>MCMCChains のような plot.jl を完成させる．</p></li>
<li><p><code>PDMPFlux.jl</code> のドキュメントを整備する．</p></li>
<li><p><code>ZigZagBoomerang.jl</code> を見習って統合したり API をつけたり？</p></li>
<li><p>Turing エコシステムと統合できたりしないか？</p></li>
<li><p><code>Rng</code> を指定できるようにする？</p></li>
<li><p><code>pdmp-jax</code> では 37 秒前後かかる Banana density の例が，<code>PDMPFlux.jl</code> では 2 分前後かかる．</p>
<ul>
<li>しかし，Julia の方が数値誤差が少ないのか，banana potential の対称性がうまく結果に出る．尾が消えたりしない．</li>
<li>→ <code>ForwardDiff.jl</code> を採用したところ，02:05 から 10 分以上に変化した．<code>ReverseDiff.jl</code> を採用したところ 4:44 になった．50 次元というのが微妙なところなのかもしれない．</li>
</ul></li>
<li><p>Funnel 分布で試したところ，<code>PDMPFlux.jl</code> の棄却率が極めて高い．</p></li>
</ul>
</div></section><section id="付録他に模索した可能性" class="level2 appendix" data-number="6"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">6</span> 付録：他に模索した可能性</h2><div class="quarto-appendix-contents">


</div></section><section id="seaborn.jl-による可視化" class="level3 appendix" data-number="6.1"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">6.1</span> <code>Seaborn.jl</code> による可視化</h2><div class="quarto-appendix-contents">

<p><a href="https://github.com/JuliaPy/Seaborn.jl/blob/master/src/Seaborn.jl"><code>Seaborn.jl</code> は Python の Seaborn の Julia wrapper を提供する</a>．</p>




</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Andral-Kamatani2024" class="csl-entry">
Andral, C., and Kamatani, K. (2024). <a href="https://arxiv.org/abs/2408.03682">Automated techniques for efficient sampling of piecewise-deterministic markov processes</a>.
</div>
<div id="ref-Corbella+2022" class="csl-entry">
Corbella, A., Spencer, S. E. F., and Roberts, G. O. (2022). <a href="https://doi.org/10.1007/s11222-022-10142-x"><span class="nocase">Automatic Zig-Zag Sampling in Practice</span></a>. <em>Statistics and Computing</em>, <em>32</em>(6), 107.
</div>
<div id="ref-Neal2003" class="csl-entry">
Neal, R. M. (2003). <a href="https://doi.org/10.1214/aos/1056562461"><span class="nocase">Slice sampling</span></a>. <em>The Annals of Statistics</em>, <em>31</em>(3), 705–767.
</div>
<div id="ref-Revels+2016" class="csl-entry">
Revels, J., Lubin, M., and Papamarkou, T. (2016). <a href="https://arxiv.org/abs/1607.07892">Forward-mode automatic differentiation in julia</a>.
</div>
<div id="ref-Sutton-Fearnhead2023" class="csl-entry">
Sutton, M., and Fearnhead, P. (2023). <a href="https://doi.org/10.1080/10618600.2023.2203735"><span class="nocase">Concave-Convex PDMP-based Sampling</span></a>. <em>Journal of Computational and Graphical Statistics</em>, <em>32</em>(4), 1425–1435.
</div>
</div></section></div> ]]></description>
  <category>Julia</category>
  <category>MCMC</category>
  <guid>https://162348.github.io/posts/2024/Julia/PDMPFlux.html</guid>
  <pubDate>Thu, 17 Oct 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Slides/zigzag_fps14_WhiteBackground.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>雑音除去拡散サンプラー</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Bridges/SB2-HandsOn.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="関連ページ" class="level3 unnumbered unlisted">
<h3 class="unnumbered unlisted anchored" data-anchor-id="関連ページ">関連ページ</h3>
<div id="listing-diffusion-listing" class="quarto-listing quarto-listing-container-grid">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="UHJvY2VzcyUyQ1NhbXBsaW5nJTJDUChYKQ==" data-listing-date-sort="1722643200000" data-listing-file-modified-sort="1754014114212" data-listing-date-modified-sort="1728691200000" data-listing-reading-time-sort="2" data-listing-word-count-sort="300">
<a href="../../../posts/2024/Bridges/SB0.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:diffusion-listing:posts/2024/Bridges/SB0.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
拡散モデルによる事後分布サンプリング
</h5>
<div class="card-subtitle listing-subtitle">
Langevin 拡散の時間反転を用いたシミュレーションベースのサンプリング法
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-08-03
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="UHJvY2VzcyUyQ1NhbXBsaW5nJTJDUChYKQ==" data-listing-date-sort="1722643200000" data-listing-file-modified-sort="1754014114212" data-listing-date-modified-sort="1728604800000" data-listing-reading-time-sort="2" data-listing-word-count-sort="219">
<a href="../../../posts/2024/Bridges/SB1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Bridges/Files/SB.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
拡散モデルからシュレディンガー橋へ
</h5>
<div class="card-subtitle listing-subtitle">
Iterative Proportional Fitting アルゴリズムについて
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-08-03
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="U2FtcGxpbmclMkNQcm9jZXNz" data-listing-date-sort="1722643200000" data-listing-file-modified-sort="1754014114219" data-listing-date-modified-sort="1728172800000" data-listing-reading-time-sort="1" data-listing-word-count-sort="96">
<a href="../../../posts/2024/Bridges/SB2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Bridges/Files/sde_animation.gif" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
雑音除去拡散サンプラー
</h5>
<div class="card-subtitle listing-subtitle">
デノイジング・ディフュージョンによるベイズ計算
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-08-03
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="はじめに" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">1</span> はじめに</h2>
<section id="雑音除去過程サンプラー" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="雑音除去過程サンプラー"><span class="header-section-number">1.1</span> 雑音除去過程サンプラー</h3>
<p>DDS (Denoising Diffusion Sampler) は <span class="citation" data-cites="Vargas-Grathwohl-Doucet2023">(Vargas et al., 2023)</span> によって提案された，雑音除去過程 (Denoising Process) を用いたサンプリング法である．</p>
<p>雑音除去過程に関しては次の記事を参照：</p>
<div id="listing-lst-embedding" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="UHJvY2VzcyUyQ1NhbXBsaW5n" data-listing-date-sort="1724630400000" data-listing-file-modified-sort="1754014115774" data-listing-date-modified-sort="1724803200000" data-listing-reading-time-sort="2" data-listing-word-count-sort="350">
<a href="../../../posts/2024/Samplers/DD1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Samplers/Files/DSM.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
雑音除去過程
</h5>
<div class="card-subtitle listing-subtitle">
Ornstein-Uhlenbeck 過程の時間反転
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-08-26
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>DDS については次の記事を参照：</p>
<div id="listing-lst-embedding1" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="U2FtcGxpbmclMkNQcm9jZXNz" data-listing-date-sort="1722643200000" data-listing-file-modified-sort="1754014114219" data-listing-date-modified-sort="1728172800000" data-listing-reading-time-sort="1" data-listing-word-count-sort="96">
<a href="../../../posts/2024/Bridges/SB2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Bridges/Files/sde_animation.gif" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
雑音除去拡散サンプラー
</h5>
<div class="card-subtitle listing-subtitle">
デノイジング・ディフュージョンによるベイズ計算
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-08-03
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>本記事では <a href="https://github.com/franciscovargas/denoising_diffusion_samplers">著者の GitHub</a> を参照にして DDS の実装を吟味する．</p>
</section>
<section id="funnel-分布" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="funnel-分布"><span class="header-section-number">1.2</span> <code>funnel</code> 分布</h3>
<p><span class="citation" data-cites="Neal2003">(Neal, 2003)</span> が slice sampling のデモ用に定義した <strong>漏斗分布</strong> を考える： <img src="https://latex.codecogs.com/png.latex?%0Ap(y,x)=%5Cphi(y;0,3)%5Cprod_%7Bi=1%7D%5E9%5Cphi(x_i;0,e%5E%7By/2%7D),%5Cqquad%20y%5Cin%5Cmathbb%7BR%7D,x%5Cin%5Cmathbb%7BR%7D%5E9.%0A"></p>
<div id="aee4d390" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>漏斗分布 <code>funnel()</code> を定義</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jax.scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> multivariate_normal</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jax.scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> norm</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jax.numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> jnp</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> funnel(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, sig<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, clip_y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>):</span>
<span id="cb1-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Funnel distribution for testing. Returns energy and sample functions."""</span></span>
<span id="cb1-9"></span>
<span id="cb1-10">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> neg_energy(x):</span>
<span id="cb1-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> unbatched(x):</span>
<span id="cb1-12">      v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb1-13">      log_density_v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> norm.logpdf(v,</span>
<span id="cb1-14">                                  loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span>,</span>
<span id="cb1-15">                                  scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.</span>)</span>
<span id="cb1-16">      variance_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.exp(v)</span>
<span id="cb1-17">      other_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-18">      cov_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.eye(other_dim) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> variance_other</span>
<span id="cb1-19">      mean_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.zeros(other_dim)</span>
<span id="cb1-20">      log_density_other <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> multivariate_normal.logpdf(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:],</span>
<span id="cb1-21">                                                     mean<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mean_other,</span>
<span id="cb1-22">                                                     cov<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cov_other)</span>
<span id="cb1-23">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> log_density_v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> log_density_other</span>
<span id="cb1-24">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jax.vmap(unbatched)(x)</span>
<span id="cb1-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output</span>
<span id="cb1-26"></span>
<span id="cb1-27">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sample_data(n_samples):</span>
<span id="cb1-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from Nd funnel distribution</span></span>
<span id="cb1-29">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (sig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jnp.array(np.random.randn(n_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))).clip(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>clip_y, clip_y)</span>
<span id="cb1-30">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jnp.array(np.random.randn(n_samples, d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> jnp.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> jnp.concatenate((y, x), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-32"></span>
<span id="cb1-33">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> neg_energy, sample_data</span></code></pre></div>
</details>
</div>
<div id="41fcba53" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>サンプルデータを生成 (ground truth)</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ファンネル分布のサンプルデータを生成</span></span>
<span id="cb2-5">neg_energy, sample_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> funnel(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb2-6">n_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># サンプル数</span></span>
<span id="cb2-7">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sample_data(n_samples)</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最初の2次元を抽出（yとx1）</span></span>
<span id="cb2-10">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb2-11">x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 散布図をプロット</span></span>
<span id="cb2-14">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb2-15">plt.scatter(y, x1, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-16">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>)</span>
<span id="cb2-17">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x1'</span>)</span>
<span id="cb2-18">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Funnel Distribution (First Two Dimensions)'</span>)</span>
<span id="cb2-19">plt.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-20"></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># xlim と ylim を追加</span></span>
<span id="cb2-22">plt.xlim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x軸の範囲を -10 から 10 に設定</span></span>
<span id="cb2-23">plt.ylim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># y軸の範囲を -20 から 20 に設定</span></span>
<span id="cb2-24"></span>
<span id="cb2-25">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Bridges/SB2-HandsOn_files/figure-html/cell-3-output-1.png" width="666" height="523" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="f5e6c573" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>3Dプロットの作成</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">neg_energy, sample_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> funnel(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># y と x1 の範囲を設定</span></span>
<span id="cb3-4">y_min, y_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb3-5">x1_min, x1_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb3-6">num_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># グリッドの解像度</span></span>
<span id="cb3-7"></span>
<span id="cb3-8">y_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(y_min, y_max, num_points)</span>
<span id="cb3-9">x1_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(x1_min, x1_max, num_points)</span>
<span id="cb3-10">Y, X1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.meshgrid(y_values, x1_values)</span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># グリッド上の点を作成</span></span>
<span id="cb3-13">inputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.stack([Y.ravel(), X1.ravel()], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 対数密度を計算</span></span>
<span id="cb3-16">log_density <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> neg_energy(inputs)</span>
<span id="cb3-17">density <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(log_density)</span>
<span id="cb3-18"></span>
<span id="cb3-19">log_density <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt(density)</span>
<span id="cb3-20"></span>
<span id="cb3-21">Density <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> log_density.reshape(Y.shape)</span>
<span id="cb3-22"></span>
<span id="cb3-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3Dプロットの作成</span></span>
<span id="cb3-24">fig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb3-25">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fig.add_subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">111</span>, projection<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'3d'</span>)</span>
<span id="cb3-26"></span>
<span id="cb3-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 軸のラベルを設定</span></span>
<span id="cb3-28">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>)</span>
<span id="cb3-29">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x1'</span>)</span>
<span id="cb3-30">ax.set_zlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Density (Transformed)'</span>)</span>
<span id="cb3-31"></span>
<span id="cb3-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># サーフェスプロットを作成</span></span>
<span id="cb3-33">surf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.plot_surface(Y, X1, Density, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'none'</span>)</span>
<span id="cb3-34"></span>
<span id="cb3-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># カラーバーを追加</span></span>
<span id="cb3-36">fig.colorbar(surf, shrink<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, aspect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb3-37"></span>
<span id="cb3-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># タイトルを設定</span></span>
<span id="cb3-39">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Funnel Distribution Density on (x1,y)'</span>)</span>
<span id="cb3-40"></span>
<span id="cb3-41">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Bridges/SB2-HandsOn_files/figure-html/cell-4-output-1.png" width="753" height="631" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="962d87cd" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>2Dヒートマップの作成</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2Dヒートマップの作成</span></span>
<span id="cb4-2">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pcolormeshを使用してヒートマップを作成</span></span>
<span id="cb4-5">im <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.pcolormesh(X1, Y, Density, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'binary'</span>, shading<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'auto'</span>)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 軸のラベルを設定</span></span>
<span id="cb4-8">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x1'</span>)</span>
<span id="cb4-9">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>)</span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># カラーバーを追加</span></span>
<span id="cb4-12">cbar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fig.colorbar(im, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Density (Transformed)'</span>)</span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># タイトルを設定</span></span>
<span id="cb4-15">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Funnel Distribution Density over y and x1'</span>)</span>
<span id="cb4-16"></span>
<span id="cb4-17">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Bridges/SB2-HandsOn_files/figure-html/cell-5-output-1.png" width="665" height="523" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="実験" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="実験"><span class="header-section-number">2</span> 実験</h2>
<p>DDS を Funnel 分布からのサンプリングに適用してみる．</p>
<p>実際の実験は <a href="https://colab.research.google.com/drive/1TU8IhZ-U_BNdhiQbTJ_E3_NhtEWu57l6?usp=sharing">こちらの Colab</a> で行なった．</p>
<p>途中で <a href="https://www.wandb.jp/">WandB (Weights &amp; Biases)</a> を使う．</p>
<div id="b3e8acdc" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>データの読み込み</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb5-2"></span>
<span id="cb5-3">sde_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Files/sde_data.npy'</span>)</span>
<span id="cb5-4">ode_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.load(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Files/ode_data.npy'</span>)</span></code></pre></div>
</details>
</div>
<div id="02952d31" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>データのプロット</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb6-2"></span>
<span id="cb6-3">ode_targ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ode_data[:, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb6-4">sde_targ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sde_data[:, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb6-5"></span>
<span id="cb6-6">plt.plot(ode_targ[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], ode_targ[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"."</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>)</span>
<span id="cb6-7">plt.plot(sde_targ[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], sde_targ[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"."</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'orange'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Bridges/SB2-HandsOn_files/figure-html/cell-7-output-1.png" width="590" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="70b1230f" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>SDE サンプルのアニメーション</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.animation <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> animation</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Density のヒートマップ作成（前述のコードから）</span></span>
<span id="cb7-4">neg_energy, sample_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> funnel(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-5"></span>
<span id="cb7-6">y_min, y_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb7-7">x1_min, x1_max <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb7-8">num_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># グリッドの解像度を下げて処理を軽くする</span></span>
<span id="cb7-9"></span>
<span id="cb7-10">y_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(y_min, y_max, num_points)</span>
<span id="cb7-11">x1_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(x1_min, x1_max, num_points)</span>
<span id="cb7-12">Y, X1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.meshgrid(y_values, x1_values)</span>
<span id="cb7-13"></span>
<span id="cb7-14">inputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.stack([Y.ravel(), X1.ravel()], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb7-15">log_density <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> neg_energy(inputs)</span>
<span id="cb7-16">density <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt(np.exp(log_density))</span>
<span id="cb7-17">Density <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> density.reshape(Y.shape)</span>
<span id="cb7-18"></span>
<span id="cb7-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># プロットの設定</span></span>
<span id="cb7-20">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb7-21"></span>
<span id="cb7-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ヒートマップを描画（Density.T ではなく Density を使用）</span></span>
<span id="cb7-23">im <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.imshow(Density, extent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[y_min, y_max, x1_min, x1_max], </span>
<span id="cb7-24">               origin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lower'</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'binary'</span>, aspect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'auto'</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>)</span>
<span id="cb7-25"></span>
<span id="cb7-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># カラーバーを追加</span></span>
<span id="cb7-27">plt.colorbar(im, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Density'</span>)</span>
<span id="cb7-28"></span>
<span id="cb7-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 初期データの取得</span></span>
<span id="cb7-30">y0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sde_data[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># y軸（第1次元）</span></span>
<span id="cb7-31">x0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sde_data[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x軸（第2次元）</span></span>
<span id="cb7-32">data0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.column_stack((y0, x0))</span>
<span id="cb7-33"></span>
<span id="cb7-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 散布図を描画</span></span>
<span id="cb7-35">scat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.scatter(data0[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], data0[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'orange'</span>)</span>
<span id="cb7-36"></span>
<span id="cb7-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 軸の範囲を設定</span></span>
<span id="cb7-38">ax.set_xlim(y_min, y_max)</span>
<span id="cb7-39">ax.set_ylim(x1_min, x1_max)</span>
<span id="cb7-40">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>)</span>
<span id="cb7-41">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x1'</span>)</span>
<span id="cb7-42">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SDE Samples Animation'</span>)</span>
<span id="cb7-43"></span>
<span id="cb7-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 初期化関数</span></span>
<span id="cb7-45"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> init():</span>
<span id="cb7-46">    scat.set_offsets(data0)</span>
<span id="cb7-47">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> scat,</span>
<span id="cb7-48"></span>
<span id="cb7-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># フレームごとの更新関数</span></span>
<span id="cb7-50"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> animate(i):</span>
<span id="cb7-51">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sde_data[:, i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># y軸（第1次元）</span></span>
<span id="cb7-52">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sde_data[:, i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x軸（第2次元）</span></span>
<span id="cb7-53">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.column_stack((y, x))</span>
<span id="cb7-54">    scat.set_offsets(data)</span>
<span id="cb7-55">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> scat,</span>
<span id="cb7-56"></span>
<span id="cb7-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># アニメーションの作成</span></span>
<span id="cb7-58">ani <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> animation.FuncAnimation(</span>
<span id="cb7-59">    fig, animate, init_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>init, frames<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sde_data.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb7-60">    interval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, blit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb7-61"></span>
<span id="cb7-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># アニメーションの保存</span></span>
<span id="cb7-63">ani.save(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sde_animation.gif'</span>, writer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pillow'</span>, fps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
</details>
</div>
<p><img src="https://162348.github.io/posts/2024/Bridges/Files/sde_animation.gif" class="img-fluid"></p>
<p><img src="https://162348.github.io/posts/2024/Bridges/Files/ode_animation.gif" class="img-fluid"></p>
</section>
<section id="実装" class="level2" data-number="3">





</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">3 実装</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Neal2003" class="csl-entry">
Neal, R. M. (2003). <a href="https://doi.org/10.1214/aos/1056562461"><span class="nocase">Slice sampling</span></a>. <em>The Annals of Statistics</em>, <em>31</em>(3), 705–767.
</div>
<div id="ref-Vargas-Grathwohl-Doucet2023" class="csl-entry">
Vargas, F., Grathwohl, W. S., and Doucet, A. (2023). <a href="https://openreview.net/forum?id=8pvnfTAbu1f"><span>Denoising Diffusion Samplers</span></a>. In <em>The eleventh international conference on learning representations</em>.
</div>
</div></section></div> ]]></description>
  <category>Sampling</category>
  <category>Process</category>
  <category>Python</category>
  <guid>https://162348.github.io/posts/2024/Bridges/SB2-HandsOn.html</guid>
  <pubDate>Sun, 06 Oct 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Bridges/Files/Funnel.png" medium="image" type="image/png" height="113" width="144"/>
</item>
<item>
  <title>流体モデル概観</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/Particles/Lorenz95.html</link>
  <description><![CDATA[ 





<section id="関連記事" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="関連記事">関連記事</h2>
<div id="listing-lst-listing" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="UGFydGljbGVzJTJDU3VydmV5" data-listing-date-sort="1712448000000" data-listing-file-modified-sort="1754014114610" data-listing-date-modified-sort="1728345600000" data-listing-reading-time-sort="2" data-listing-word-count-sort="353">
<a href="../../../posts/2024/Particles/ParticleMethods.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/Particles/Files/lorenz96_animation.gif" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
粒子法の概観
</h5>
<div class="card-subtitle listing-subtitle">
分子動力学法から SMC サンプラーまで
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-04-07
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="UGFydGljbGVzJTJDTUNNQyUyQ1N1cnZleQ==" data-listing-date-sort="1702512000000" data-listing-file-modified-sort="1754014117956" data-listing-date-modified-sort="1722816000000" data-listing-reading-time-sort="3" data-listing-word-count-sort="489">
<a href="../../../posts/Surveys/SMCSamplers.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/Surveys/SMCSamplers_LowResolution.jpg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
粒子フィルターを用いたサンプリング | About SMC Samplers
</h5>
<div class="card-subtitle listing-subtitle">
テンパリングを通じたもう一つの万能サンプラー
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2023-12-14
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="UGFydGljbGVzJTJDU3VydmV5JTJDQ29tcHV0YXRpb24=" data-listing-date-sort="1700870400000" data-listing-file-modified-sort="1754014113975" data-listing-date-modified-sort="1702598400000" data-listing-reading-time-sort="5" data-listing-word-count-sort="821">
<a href="../../../posts/2023/Surveys/ParticleFilter.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2023/Surveys/cover_LowResolution.jpg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
粒子フィルターとは何か
</h5>
<div class="card-subtitle listing-subtitle">
非線型フィルタリング手法としての粒子フィルタ
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2023-11-25
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li><a href="https://github.com/milankl/Lorenz96.jl/tree/v0.3.0"><code>Loorenz96.jl</code></a> パッケージ <span class="citation" data-cites="Milan2021">(K, 2021)</span></li>
<li><code>DynamicalSystems.jl</code> (<a href="https://github.com/JuliaDynamics/DynamicalSystems.jl">GitHub</a> / <a href="https://juliadynamics.github.io/DynamicalSystems.jl/dev/">Docs</a>) パッケージ</li>
<li><code>EnsembleKalmanProcesses.jl</code> (<a href="https://github.com/CliMA/EnsembleKalmanProcesses.jl">GitHub</a> / <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/dev/examples/lorenz_example/">Docs</a>) パッケージ</li>
</ul>
</div>
</div>
</div>
</section>
<section id="lorenz-96-モデル" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="lorenz-96-モデル"><span class="header-section-number">1</span> Lorenz 96 モデル</h2>
<section id="モデル定義" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="モデル定義"><span class="header-section-number">1.1</span> モデル定義</h3>
<p>Lorenz 96 とは，<span class="citation" data-cites="Lorenz1995">(Lorenz, 1995)</span> によって導入された力学系の通称である：</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7Bd%20x_i%7D%7Bd%20t%7D=%5Cbiggr(x_%7Bi+1%7D-x_%7Bi-2%7D%5Cbiggl)x_%7Bi-1%7D-x_i+F,%5Cqquad%20F%5Cin%5Cmathbb%7BR%7D.%0A"></p>
<p>ただし，係数については，空間の次元 <img src="https://latex.codecogs.com/png.latex?x%5Cin%5Cmathbb%7BR%7D%5EN"> について <img src="https://latex.codecogs.com/png.latex?x_%7Bi-N%7D=x_%7Bi+N%7D=x_i"> と約束する．</p>
</section>
<section id="dynamicalsystems.jl-でシミュレーション" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="dynamicalsystems.jl-でシミュレーション"><span class="header-section-number">1.2</span> <code>DynamicalSystems.jl</code> でシミュレーション</h3>
<p><code>DynamicalSystems.jl</code> (<a href="https://github.com/JuliaDynamics/DynamicalSystems.jl">GitHub</a> / <a href="https://juliadynamics.github.io/DynamicalSystems.jl/dev/">Docs</a>) パッケージの<a href="https://juliadynamics.github.io/DynamicalSystems.jl/dev/tutorial/#Example:-Lorenz96">チュートリアルに Lorenz96 の例がある</a>．</p>
<p><img src="https://latex.codecogs.com/png.latex?F=8"> の場合はカオス的な振る舞いを示す：</p>
<div id="ba454242" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">DynamicalSystems</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lorenz96_rule!</span>(du, u, p, t)</span>
<span id="cb1-4">    F <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]; N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(u)</span>
<span id="cb1-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3 edge cases</span></span>
<span id="cb1-6">    du[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> u[N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u[N] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> F</span>
<span id="cb1-7">    du[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> u[N]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> F</span>
<span id="cb1-8">    du[N] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> u[N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u[N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> u[N] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> F</span>
<span id="cb1-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># then the general case</span></span>
<span id="cb1-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-11">        du[n] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (u[n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> u[n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u[n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> u[n] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> F</span>
<span id="cb1-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb1-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># always `return nothing` for in-place form!</span></span>
<span id="cb1-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb1-15"></span>
<span id="cb1-16">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb1-17">u0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>; length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> N)</span>
<span id="cb1-18">p0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.0</span>]</span>
<span id="cb1-19">lorenz96 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CoupledODEs</span>(lorenz96_rule!, u0, p0)</span>
<span id="cb1-20"></span>
<span id="cb1-21">total_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.5</span></span>
<span id="cb1-22">sampling_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span></span>
<span id="cb1-23">Y, t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trajectory</span>(lorenz96, total_time; Ttr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>, Δt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sampling_time)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>(6-dimensional StateSpaceSet{Float64} with 626 points, 2.2:0.02:14.7)</code></pre>
</div>
</div>
<div id="dba37dcc" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Plots</span></span>
<span id="cb3-2"></span>
<span id="cb3-3">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(xlabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>, ylabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"variable"</span>, legend <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span>)</span>
<span id="cb3-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> var <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachcol</span>(Y)</span>
<span id="cb3-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(p, t, var)</span>
<span id="cb3-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb3-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(p)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="672" height="480" viewbox="0 0 2688 1920">
<defs>
  <clippath id="clip350">
    <rect x="0" y="0" width="2688" height="1920"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip350)" d="M0 1920 L2688 1920 L2688 -4.26326e-14 L0 -4.26326e-14  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip351">
    <rect x="537" y="0" width="1883" height="1883"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip350)" d="M217.252 1734.12 L2640.76 1734.12 L2640.76 47.2441 L217.252 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip352">
    <rect x="217" y="47" width="2425" height="1688"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="249.26,1734.12 249.26,47.2441 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="615.072,1734.12 615.072,47.2441 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="980.884,1734.12 980.884,47.2441 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1346.7,1734.12 1346.7,47.2441 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1712.51,1734.12 1712.51,47.2441 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2078.32,1734.12 2078.32,47.2441 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2444.13,1734.12 2444.13,47.2441 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="217.252,1526.03 2640.76,1526.03 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="217.252,1092.66 2640.76,1092.66 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="217.252,659.284 2640.76,659.284 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="217.252,225.913 2640.76,225.913 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="217.252,1734.12 2640.76,1734.12 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="249.26,1734.12 249.26,1715.22 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="615.072,1734.12 615.072,1715.22 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="980.884,1734.12 980.884,1715.22 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1346.7,1734.12 1346.7,1715.22 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1712.51,1734.12 1712.51,1715.22 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2078.32,1734.12 2078.32,1715.22 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2444.13,1734.12 2444.13,1715.22 "></polyline>
<path clip-path="url(#clip350)" d="M243.913 1794.89 L260.232 1794.89 L260.232 1798.82 L238.288 1798.82 L238.288 1794.89 Q240.95 1792.13 245.533 1787.5 Q250.14 1782.85 251.32 1781.51 Q253.566 1778.98 254.445 1777.25 Q255.348 1775.49 255.348 1773.8 Q255.348 1771.04 253.404 1769.31 Q251.482 1767.57 248.381 1767.57 Q246.182 1767.57 243.728 1768.34 Q241.297 1769.1 238.52 1770.65 L238.52 1765.93 Q241.344 1764.79 243.797 1764.21 Q246.251 1763.64 248.288 1763.64 Q253.658 1763.64 256.853 1766.32 Q260.047 1769.01 260.047 1773.5 Q260.047 1775.63 259.237 1777.55 Q258.45 1779.45 256.344 1782.04 Q255.765 1782.71 252.663 1785.93 Q249.561 1789.12 243.913 1794.89 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M618.081 1768.34 L606.276 1786.78 L618.081 1786.78 L618.081 1768.34 M616.855 1764.26 L622.734 1764.26 L622.734 1786.78 L627.665 1786.78 L627.665 1790.67 L622.734 1790.67 L622.734 1798.82 L618.081 1798.82 L618.081 1790.67 L602.48 1790.67 L602.48 1786.16 L616.855 1764.26 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M981.289 1779.68 Q978.141 1779.68 976.289 1781.83 Q974.461 1783.98 974.461 1787.73 Q974.461 1791.46 976.289 1793.64 Q978.141 1795.79 981.289 1795.79 Q984.437 1795.79 986.266 1793.64 Q988.118 1791.46 988.118 1787.73 Q988.118 1783.98 986.266 1781.83 Q984.437 1779.68 981.289 1779.68 M990.572 1765.02 L990.572 1769.28 Q988.812 1768.45 987.007 1768.01 Q985.224 1767.57 983.465 1767.57 Q978.836 1767.57 976.382 1770.7 Q973.951 1773.82 973.604 1780.14 Q974.97 1778.13 977.03 1777.06 Q979.09 1775.97 981.567 1775.97 Q986.775 1775.97 989.785 1779.15 Q992.817 1782.29 992.817 1787.73 Q992.817 1793.06 989.669 1796.27 Q986.521 1799.49 981.289 1799.49 Q975.294 1799.49 972.123 1794.91 Q968.951 1790.3 968.951 1781.58 Q968.951 1773.38 972.84 1768.52 Q976.729 1763.64 983.28 1763.64 Q985.039 1763.64 986.822 1763.98 Q988.627 1764.33 990.572 1765.02 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M1346.7 1782.41 Q1343.36 1782.41 1341.44 1784.19 Q1339.54 1785.97 1339.54 1789.1 Q1339.54 1792.22 1341.44 1794.01 Q1343.36 1795.79 1346.7 1795.79 Q1350.03 1795.79 1351.95 1794.01 Q1353.87 1792.2 1353.87 1789.1 Q1353.87 1785.97 1351.95 1784.19 Q1350.05 1782.41 1346.7 1782.41 M1342.02 1780.42 Q1339.01 1779.68 1337.32 1777.62 Q1335.65 1775.56 1335.65 1772.59 Q1335.65 1768.45 1338.59 1766.04 Q1341.56 1763.64 1346.7 1763.64 Q1351.86 1763.64 1354.8 1766.04 Q1357.74 1768.45 1357.74 1772.59 Q1357.74 1775.56 1356.05 1777.62 Q1354.38 1779.68 1351.4 1780.42 Q1354.77 1781.21 1356.65 1783.5 Q1358.55 1785.79 1358.55 1789.1 Q1358.55 1794.12 1355.47 1796.81 Q1352.41 1799.49 1346.7 1799.49 Q1340.98 1799.49 1337.9 1796.81 Q1334.84 1794.12 1334.84 1789.1 Q1334.84 1785.79 1336.74 1783.5 Q1338.64 1781.21 1342.02 1780.42 M1340.31 1773.03 Q1340.31 1775.72 1341.97 1777.22 Q1343.66 1778.73 1346.7 1778.73 Q1349.71 1778.73 1351.4 1777.22 Q1353.11 1775.72 1353.11 1773.03 Q1353.11 1770.35 1351.4 1768.84 Q1349.71 1767.34 1346.7 1767.34 Q1343.66 1767.34 1341.97 1768.84 Q1340.31 1770.35 1340.31 1773.03 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M1687.2 1794.89 L1694.83 1794.89 L1694.83 1768.52 L1686.52 1770.19 L1686.52 1765.93 L1694.79 1764.26 L1699.46 1764.26 L1699.46 1794.89 L1707.1 1794.89 L1707.1 1798.82 L1687.2 1798.82 L1687.2 1794.89 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M1726.55 1767.34 Q1722.94 1767.34 1721.11 1770.9 Q1719.3 1774.45 1719.3 1781.58 Q1719.3 1788.68 1721.11 1792.25 Q1722.94 1795.79 1726.55 1795.79 Q1730.18 1795.79 1731.99 1792.25 Q1733.82 1788.68 1733.82 1781.58 Q1733.82 1774.45 1731.99 1770.9 Q1730.18 1767.34 1726.55 1767.34 M1726.55 1763.64 Q1732.36 1763.64 1735.41 1768.24 Q1738.49 1772.83 1738.49 1781.58 Q1738.49 1790.3 1735.41 1794.91 Q1732.36 1799.49 1726.55 1799.49 Q1720.74 1799.49 1717.66 1794.91 Q1714.6 1790.3 1714.6 1781.58 Q1714.6 1772.83 1717.66 1768.24 Q1720.74 1763.64 1726.55 1763.64 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M2053.81 1794.89 L2061.45 1794.89 L2061.45 1768.52 L2053.13 1770.19 L2053.13 1765.93 L2061.4 1764.26 L2066.07 1764.26 L2066.07 1794.89 L2073.71 1794.89 L2073.71 1798.82 L2053.81 1798.82 L2053.81 1794.89 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M2087.19 1794.89 L2103.51 1794.89 L2103.51 1798.82 L2081.56 1798.82 L2081.56 1794.89 Q2084.22 1792.13 2088.81 1787.5 Q2093.41 1782.85 2094.59 1781.51 Q2096.84 1778.98 2097.72 1777.25 Q2098.62 1775.49 2098.62 1773.8 Q2098.62 1771.04 2096.68 1769.31 Q2094.76 1767.57 2091.65 1767.57 Q2089.45 1767.57 2087 1768.34 Q2084.57 1769.1 2081.79 1770.65 L2081.79 1765.93 Q2084.62 1764.79 2087.07 1764.21 Q2089.52 1763.64 2091.56 1763.64 Q2096.93 1763.64 2100.13 1766.32 Q2103.32 1769.01 2103.32 1773.5 Q2103.32 1775.63 2102.51 1777.55 Q2101.72 1779.45 2099.62 1782.04 Q2099.04 1782.71 2095.94 1785.93 Q2092.83 1789.12 2087.19 1794.89 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M2418.58 1794.89 L2426.22 1794.89 L2426.22 1768.52 L2417.91 1770.19 L2417.91 1765.93 L2426.17 1764.26 L2430.85 1764.26 L2430.85 1794.89 L2438.48 1794.89 L2438.48 1798.82 L2418.58 1798.82 L2418.58 1794.89 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M2460.78 1768.34 L2448.97 1786.78 L2460.78 1786.78 L2460.78 1768.34 M2459.55 1764.26 L2465.43 1764.26 L2465.43 1786.78 L2470.36 1786.78 L2470.36 1790.67 L2465.43 1790.67 L2465.43 1798.82 L2460.78 1798.82 L2460.78 1790.67 L2445.17 1790.67 L2445.17 1786.16 L2459.55 1764.26 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M1368.16 1837.53 L1368.16 1847.65 L1380.23 1847.65 L1380.23 1852.2 L1368.16 1852.2 L1368.16 1871.56 Q1368.16 1875.92 1369.34 1877.16 Q1370.55 1878.4 1374.21 1878.4 L1380.23 1878.4 L1380.23 1883.3 L1374.21 1883.3 Q1367.43 1883.3 1364.85 1880.79 Q1362.28 1878.24 1362.28 1871.56 L1362.28 1852.2 L1357.98 1852.2 L1357.98 1847.65 L1362.28 1847.65 L1362.28 1837.53 L1368.16 1837.53 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M1387.93 1847.65 L1393.79 1847.65 L1393.79 1883.3 L1387.93 1883.3 L1387.93 1847.65 M1387.93 1833.78 L1393.79 1833.78 L1393.79 1841.19 L1387.93 1841.19 L1387.93 1833.78 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M1433.79 1854.5 Q1435.99 1850.55 1439.05 1848.67 Q1442.1 1846.79 1446.24 1846.79 Q1451.81 1846.79 1454.83 1850.71 Q1457.86 1854.59 1457.86 1861.78 L1457.86 1883.3 L1451.97 1883.3 L1451.97 1861.98 Q1451.97 1856.85 1450.15 1854.37 Q1448.34 1851.89 1444.62 1851.89 Q1440.06 1851.89 1437.42 1854.91 Q1434.78 1857.93 1434.78 1863.15 L1434.78 1883.3 L1428.89 1883.3 L1428.89 1861.98 Q1428.89 1856.82 1427.08 1854.37 Q1425.26 1851.89 1421.48 1851.89 Q1416.99 1851.89 1414.35 1854.94 Q1411.71 1857.97 1411.71 1863.15 L1411.71 1883.3 L1405.82 1883.3 L1405.82 1847.65 L1411.71 1847.65 L1411.71 1853.19 Q1413.71 1849.91 1416.51 1848.35 Q1419.31 1846.79 1423.16 1846.79 Q1427.05 1846.79 1429.75 1848.77 Q1432.49 1850.74 1433.79 1854.5 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M1500.03 1864.01 L1500.03 1866.88 L1473.1 1866.88 Q1473.48 1872.92 1476.73 1876.11 Q1480.01 1879.26 1485.83 1879.26 Q1489.21 1879.26 1492.36 1878.43 Q1495.54 1877.6 1498.66 1875.95 L1498.66 1881.49 Q1495.51 1882.82 1492.2 1883.52 Q1488.89 1884.22 1485.48 1884.22 Q1476.95 1884.22 1471.96 1879.26 Q1466.99 1874.29 1466.99 1865.83 Q1466.99 1857.07 1471.7 1851.95 Q1476.44 1846.79 1484.47 1846.79 Q1491.66 1846.79 1495.83 1851.44 Q1500.03 1856.06 1500.03 1864.01 M1494.17 1862.29 Q1494.11 1857.49 1491.47 1854.62 Q1488.86 1851.76 1484.53 1851.76 Q1479.63 1851.76 1476.67 1854.53 Q1473.74 1857.3 1473.29 1862.33 L1494.17 1862.29 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="217.252,1734.12 217.252,47.2441 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="217.252,1526.03 236.149,1526.03 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="217.252,1092.66 236.149,1092.66 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="217.252,659.284 236.149,659.284 "></polyline>
<polyline clip-path="url(#clip350)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="217.252,225.913 236.149,225.913 "></polyline>
<path clip-path="url(#clip350)" d="M116.214 1526.48 L145.89 1526.48 L145.89 1530.41 L116.214 1530.41 L116.214 1526.48 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M156.029 1508.75 L174.385 1508.75 L174.385 1512.68 L160.311 1512.68 L160.311 1521.15 Q161.33 1520.81 162.348 1520.64 Q163.367 1520.46 164.385 1520.46 Q170.172 1520.46 173.552 1523.63 Q176.932 1526.8 176.932 1532.22 Q176.932 1537.8 173.46 1540.9 Q169.987 1543.98 163.668 1543.98 Q161.492 1543.98 159.223 1543.61 Q156.978 1543.24 154.571 1542.5 L154.571 1537.8 Q156.654 1538.93 158.876 1539.49 Q161.098 1540.04 163.575 1540.04 Q167.58 1540.04 169.918 1537.94 Q172.256 1535.83 172.256 1532.22 Q172.256 1528.61 169.918 1526.5 Q167.58 1524.39 163.575 1524.39 Q161.7 1524.39 159.825 1524.81 Q157.973 1525.23 156.029 1526.11 L156.029 1508.75 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M164.987 1078.45 Q161.376 1078.45 159.548 1082.02 Q157.742 1085.56 157.742 1092.69 Q157.742 1099.8 159.548 1103.36 Q161.376 1106.9 164.987 1106.9 Q168.622 1106.9 170.427 1103.36 Q172.256 1099.8 172.256 1092.69 Q172.256 1085.56 170.427 1082.02 Q168.622 1078.45 164.987 1078.45 M164.987 1074.75 Q170.797 1074.75 173.853 1079.36 Q176.932 1083.94 176.932 1092.69 Q176.932 1101.42 173.853 1106.02 Q170.797 1110.61 164.987 1110.61 Q159.177 1110.61 156.098 1106.02 Q153.043 1101.42 153.043 1092.69 Q153.043 1083.94 156.098 1079.36 Q159.177 1074.75 164.987 1074.75 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M156.029 642.004 L174.385 642.004 L174.385 645.939 L160.311 645.939 L160.311 654.411 Q161.33 654.064 162.348 653.902 Q163.367 653.717 164.385 653.717 Q170.172 653.717 173.552 656.888 Q176.932 660.06 176.932 665.476 Q176.932 671.055 173.46 674.157 Q169.987 677.235 163.668 677.235 Q161.492 677.235 159.223 676.865 Q156.978 676.495 154.571 675.754 L154.571 671.055 Q156.654 672.189 158.876 672.745 Q161.098 673.3 163.575 673.3 Q167.58 673.3 169.918 671.194 Q172.256 669.087 172.256 665.476 Q172.256 661.865 169.918 659.759 Q167.58 657.652 163.575 657.652 Q161.7 657.652 159.825 658.069 Q157.973 658.486 156.029 659.365 L156.029 642.004 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M125.636 239.258 L133.275 239.258 L133.275 212.892 L124.964 214.559 L124.964 210.299 L133.228 208.633 L137.904 208.633 L137.904 239.258 L145.543 239.258 L145.543 243.193 L125.636 243.193 L125.636 239.258 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M164.987 211.711 Q161.376 211.711 159.548 215.276 Q157.742 218.818 157.742 225.948 Q157.742 233.054 159.548 236.619 Q161.376 240.16 164.987 240.16 Q168.622 240.16 170.427 236.619 Q172.256 233.054 172.256 225.948 Q172.256 218.818 170.427 215.276 Q168.622 211.711 164.987 211.711 M164.987 208.008 Q170.797 208.008 173.853 212.614 Q176.932 217.198 176.932 225.948 Q176.932 234.674 173.853 239.281 Q170.797 243.864 164.987 243.864 Q159.177 243.864 156.098 239.281 Q153.043 234.674 153.043 225.948 Q153.043 217.198 156.098 212.614 Q159.177 208.008 164.987 208.008 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M25.9905 1019.46 L25.9905 1013.25 L55.9093 1002.11 L25.9905 990.972 L25.9905 984.766 L61.6384 998.134 L61.6384 1006.09 L25.9905 1019.46 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M43.719 960.481 Q43.719 967.578 45.3422 970.316 Q46.9655 973.053 50.8804 973.053 Q53.9996 973.053 55.8457 971.016 Q57.6599 968.947 57.6599 965.414 Q57.6599 960.544 54.2224 957.616 Q50.7531 954.656 45.0239 954.656 L43.719 954.656 L43.719 960.481 M41.3 948.799 L61.6384 948.799 L61.6384 954.656 L56.2276 954.656 Q59.4741 956.661 61.0337 959.653 Q62.5615 962.645 62.5615 966.974 Q62.5615 972.448 59.5059 975.695 Q56.4186 978.909 51.2623 978.909 Q45.2467 978.909 42.1912 974.899 Q39.1357 970.857 39.1357 962.868 L39.1357 954.656 L38.5628 954.656 Q34.5205 954.656 32.3244 957.329 Q30.0964 959.971 30.0964 964.777 Q30.0964 967.833 30.8284 970.729 Q31.5605 973.626 33.0246 976.299 L27.6137 976.299 Q26.3724 973.085 25.7677 970.061 Q25.1311 967.037 25.1311 964.173 Q25.1311 956.438 29.1415 952.619 Q33.1519 948.799 41.3 948.799 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M31.465 916.08 Q30.8921 917.066 30.6375 918.244 Q30.351 919.39 30.351 920.79 Q30.351 925.756 33.5975 928.429 Q36.8122 931.071 42.8596 931.071 L61.6384 931.071 L61.6384 936.959 L25.9905 936.959 L25.9905 931.071 L31.5287 931.071 Q28.2821 929.225 26.7225 926.265 Q25.1311 923.305 25.1311 919.072 Q25.1311 918.467 25.2266 917.735 Q25.2903 917.003 25.4494 916.112 L31.465 916.08 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M25.9905 909.937 L25.9905 904.08 L61.6384 904.08 L61.6384 909.937 L25.9905 909.937 M12.1132 909.937 L12.1132 904.08 L19.5293 904.08 L19.5293 909.937 L12.1132 909.937 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M43.719 875.626 Q43.719 882.723 45.3422 885.461 Q46.9655 888.198 50.8804 888.198 Q53.9996 888.198 55.8457 886.161 Q57.6599 884.092 57.6599 880.559 Q57.6599 875.689 54.2224 872.761 Q50.7531 869.801 45.0239 869.801 L43.719 869.801 L43.719 875.626 M41.3 863.945 L61.6384 863.945 L61.6384 869.801 L56.2276 869.801 Q59.4741 871.806 61.0337 874.798 Q62.5615 877.79 62.5615 882.119 Q62.5615 887.593 59.5059 890.84 Q56.4186 894.054 51.2623 894.054 Q45.2467 894.054 42.1912 890.044 Q39.1357 886.002 39.1357 878.013 L39.1357 869.801 L38.5628 869.801 Q34.5205 869.801 32.3244 872.475 Q30.0964 875.116 30.0964 879.922 Q30.0964 882.978 30.8284 885.874 Q31.5605 888.771 33.0246 891.444 L27.6137 891.444 Q26.3724 888.23 25.7677 885.206 Q25.1311 882.182 25.1311 879.318 Q25.1311 871.583 29.1415 867.764 Q33.1519 863.945 41.3 863.945 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M43.8463 826.291 Q37.3851 826.291 33.7248 828.965 Q30.0327 831.607 30.0327 836.254 Q30.0327 840.901 33.7248 843.574 Q37.3851 846.216 43.8463 846.216 Q50.3075 846.216 53.9996 843.574 Q57.6599 840.901 57.6599 836.254 Q57.6599 831.607 53.9996 828.965 Q50.3075 826.291 43.8463 826.291 M31.4013 846.216 Q28.2185 844.37 26.6907 841.569 Q25.1311 838.736 25.1311 834.821 Q25.1311 828.328 30.2873 824.286 Q35.4436 820.212 43.8463 820.212 Q52.249 820.212 57.4052 824.286 Q62.5615 828.328 62.5615 834.821 Q62.5615 838.736 61.0337 841.569 Q59.4741 844.37 56.2912 846.216 L61.6384 846.216 L61.6384 852.104 L12.1132 852.104 L12.1132 846.216 L31.4013 846.216 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M12.1132 810.504 L12.1132 804.648 L61.6384 804.648 L61.6384 810.504 L12.1132 810.504 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip350)" d="M42.3504 761.902 L45.2149 761.902 L45.2149 788.829 Q51.2623 788.447 54.4452 785.201 Q57.5962 781.922 57.5962 776.098 Q57.5962 772.724 56.7687 769.573 Q55.9411 766.39 54.2861 763.271 L59.8242 763.271 Q61.161 766.422 61.8612 769.732 Q62.5615 773.042 62.5615 776.448 Q62.5615 784.978 57.5962 789.975 Q52.631 794.94 44.1646 794.94 Q35.4117 794.94 30.2873 790.23 Q25.1311 785.487 25.1311 777.466 Q25.1311 770.273 29.7781 766.104 Q34.3932 761.902 42.3504 761.902 M40.6316 767.759 Q35.8255 767.822 32.9609 770.464 Q30.0964 773.074 30.0964 777.403 Q30.0964 782.304 32.8654 785.264 Q35.6345 788.193 40.6634 788.638 L40.6316 767.759 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip352)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="285.841,819.313 289.5,857.437 293.158,897.563 296.816,939.181 300.474,981.727 304.132,1024.58 307.79,1067.06 311.448,1108.42 315.106,1147.91 318.765,1184.71 322.423,1218.02 326.081,1247.06 329.739,1271.14 333.397,1289.63 337.055,1302.07 340.713,1308.13 344.371,1307.66 348.029,1300.71 351.688,1287.51 355.346,1268.53 359.004,1244.41 362.662,1216.05 366.32,1184.51 369.978,1151.04 373.636,1116.96 377.294,1083.62 380.953,1052.29 384.611,1024.12 388.269,1000.02 391.927,980.625 395.585,966.249 399.243,956.872 402.901,952.131 406.559,951.343 410.218,953.55 413.876,957.593 417.534,962.216 421.192,966.184 424.85,968.422 428.508,968.133 432.166,964.882 435.824,958.631 439.482,949.706 443.141,938.708 446.799,926.38 450.457,913.461 454.115,900.552 457.773,888.026 461.431,875.994 465.089,864.333 468.747,852.751 472.406,840.871 476.064,828.314 479.722,814.753 483.38,799.96 487.038,783.824 490.696,766.353 494.354,747.678 498.012,728.039 501.671,707.776 505.329,687.321 508.987,667.188 512.645,647.977 516.303,630.377 519.961,615.165 523.619,603.203 527.277,595.425 530.935,592.817 534.594,596.381 538.252,607.087 541.91,625.8 545.568,653.189 549.226,689.615 552.884,735.019 556.542,788.831 560.2,849.922 563.859,916.629 567.517,986.85 571.175,1058.2 574.833,1128.2 578.491,1194.5 582.149,1255.1 585.807,1308.42 589.465,1353.47 593.123,1389.78 596.782,1417.4 600.44,1436.74 604.098,1448.46 607.756,1453.32 611.414,1452.05 615.072,1445.27 618.73,1433.46 622.388,1416.98 626.047,1396.09 629.705,1371.06 633.363,1342.25 637.021,1310.23 640.679,1275.86 644.337,1240.29 647.995,1204.96 651.653,1171.48 655.312,1141.45 658.97,1116.28 662.628,1096.98 666.286,1083.98 669.944,1077.09 673.602,1075.5 677.26,1077.86 680.918,1082.55 684.576,1087.88 688.235,1092.32 691.893,1094.75 695.551,1094.51 699.209,1091.42 702.867,1085.69 706.525,1077.79 710.183,1068.27 713.841,1057.67 717.5,1046.37 721.158,1034.6 724.816,1022.41 728.474,1009.74 732.132,996.454 735.79,982.41 739.448,967.482 743.106,951.572 746.765,934.598 750.423,916.484 754.081,897.142 757.739,876.474 761.397,854.397 765.055,830.882 768.713,806.007 772.371,780.019 776.029,753.39 779.688,726.845 783.346,701.364 787.004,678.135 790.662,658.468 794.32,643.676 797.978,634.942 801.636,633.2 805.294,639.047 808.953,652.703 812.611,674.018 816.269,702.524 819.927,737.508 823.585,778.102 827.243,823.36 830.901,872.311 834.559,924 838.218,977.495 841.876,1031.88 845.534,1086.27 849.192,1139.74 852.85,1191.4 856.508,1240.35 860.166,1285.72 863.824,1326.74 867.482,1362.73 871.141,1393.18 874.799,1417.73 878.457,1436.18 882.115,1448.48 885.773,1454.66 889.431,1454.8 893.089,1449.06 896.747,1437.72 900.406,1421.23 904.064,1400.33 907.722,1376.11 911.38,1349.98 915.038,1323.52 918.696,1298.3 922.354,1275.53 926.012,1255.91 929.67,1239.39 933.329,1225.3 936.987,1212.43 940.645,1199.31 944.303,1184.49 947.961,1166.74 951.619,1145.2 955.277,1119.43 958.935,1089.38 962.594,1055.33 966.252,1017.8 969.91,977.473 973.568,935.072 977.226,891.337 980.884,846.973 984.542,802.62 988.2,758.849 991.859,716.157 995.517,674.966 999.175,635.625 1002.83,598.405 1006.49,563.496 1010.15,531.003 1013.81,500.95 1017.47,473.292 1021.12,447.932 1024.78,424.758 1028.44,403.667 1032.1,384.593 1035.76,367.524 1039.41,352.498 1043.07,339.599 1046.73,328.949 1050.39,320.699 1054.05,315.025 1057.7,312.127 1061.36,312.234 1065.02,315.589 1068.68,322.448 1072.34,333.061 1076,347.653 1079.65,366.406 1083.31,389.442 1086.97,416.811 1090.63,448.482 1094.29,484.334 1097.94,524.158 1101.6,567.654 1105.26,614.422 1108.92,663.961 1112.58,715.655 1116.23,768.752 1119.89,822.343 1123.55,875.346 1127.21,926.494 1130.87,974.349 1134.53,1017.36 1138.18,1053.96 1141.84,1082.71 1145.5,1102.49 1149.16,1112.66 1152.82,1113.27 1156.47,1105.07 1160.13,1089.52 1163.79,1068.64 1167.45,1044.77 1171.11,1020.31 1174.76,997.37 1178.42,977.582 1182.08,961.902 1185.74,950.543 1189.4,942.992 1193.06,938.102 1196.71,934.255 1200.37,929.573 1204.03,922.154 1207.69,910.301 1211.35,892.725 1215,868.679 1218.66,838.027 1222.32,801.237 1225.98,759.325 1229.64,713.746 1233.29,666.272 1236.95,618.85 1240.61,573.441 1244.27,531.86 1247.93,495.612 1251.59,465.76 1255.24,442.84 1258.9,426.857 1262.56,417.343 1266.22,413.461 1269.88,414.119 1273.53,418.083 1277.19,424.078 1280.85,430.889 1284.51,437.46 1288.17,442.981 1291.82,446.946 1295.48,449.173 1299.14,449.786 1302.8,449.174 1306.46,447.935 1310.11,446.835 1313.77,446.781 1317.43,448.803 1321.09,454.053 1324.75,463.794 1328.41,479.364 1332.06,502.107 1335.72,533.257 1339.38,573.77 1343.04,624.13 1346.7,684.16 1350.35,752.863 1354.01,828.369 1357.67,907.987 1361.33,988.392 1364.99,1065.93 1368.64,1136.98 1372.3,1198.33 1375.96,1247.47 1379.62,1282.77 1383.28,1303.52 1386.94,1309.84 1390.59,1302.53 1394.25,1282.93 1397.91,1252.72 1401.57,1213.87 1405.23,1168.49 1408.88,1118.76 1412.54,1066.81 1416.2,1014.64 1419.86,963.977 1423.52,916.222 1427.17,872.396 1430.83,833.133 1434.49,798.709 1438.15,769.101 1441.81,744.058 1445.47,723.172 1449.12,705.945 1452.78,691.843 1456.44,680.337 1460.1,670.925 1463.76,663.151 1467.41,656.606 1471.07,650.933 1474.73,645.818 1478.39,640.984 1482.05,636.185 1485.7,631.198 1489.36,625.813 1493.02,619.833 1496.68,613.066 1500.34,605.331 1504,596.453 1507.65,586.282 1511.31,574.696 1514.97,561.621 1518.63,547.055 1522.29,531.098 1525.94,513.982 1529.6,496.118 1533.26,478.145 1536.92,460.984 1540.58,445.888 1544.23,434.486 1547.89,428.79 1551.55,431.147 1555.21,444.1 1558.87,470.114 1562.53,511.172 1566.18,568.222 1569.84,640.586 1573.5,725.472 1577.16,817.796 1580.82,910.482 1584.47,995.306 1588.13,1064.11 1591.79,1110.11 1595.45,1129.06 1599.11,1120.07 1602.76,1086.13 1606.42,1034.13 1610.08,974.173 1613.74,918.081 1617.4,877.21 1621.06,860.19 1624.71,871.08 1628.37,908.377 1632.03,965.245 1635.69,1031.3 1639.35,1095.72 1643,1150.56 1646.66,1192.55 1650.32,1222.65 1653.98,1243.83 1657.64,1258.72 1661.29,1268.43 1664.95,1272.63 1668.61,1270.59 1672.27,1262.23 1675.93,1248.64 1679.58,1231.92 1683.24,1214.66 1686.9,1199.24 1690.56,1187.43 1694.22,1180.13 1697.88,1177.46 1701.53,1178.93 1705.19,1183.65 1708.85,1190.52 1712.51,1198.39 1716.17,1206.09 1719.82,1212.53 1723.48,1216.72 1727.14,1217.79 1730.8,1215.13 1734.46,1208.43 1738.11,1197.83 1741.77,1183.96 1745.43,1167.97 1749.09,1151.32 1752.75,1135.46 1756.41,1121.46 1760.06,1109.65 1763.72,1099.56 1767.38,1090.09 1771.04,1079.95 1774.7,1068.09 1778.35,1054.07 1782.01,1038.09 1785.67,1020.77 1789.33,1002.88 1792.99,984.992 1796.64,967.326 1800.3,949.739 1803.96,931.856 1807.62,913.246 1811.28,893.532 1814.94,872.407 1818.59,849.582 1822.25,824.722 1825.91,797.443 1829.57,767.407 1833.23,734.498 1836.88,699.055 1840.54,662.064 1844.2,625.227 1847.86,590.826 1851.52,561.378 1855.17,539.153 1858.83,525.726 1862.49,521.713 1866.15,526.751 1869.81,539.711 1873.47,559.027 1877.12,583.028 1880.78,610.189 1884.44,639.266 1888.1,669.334 1891.76,699.752 1895.41,730.1 1899.07,760.118 1902.73,789.647 1906.39,818.594 1910.05,846.911 1913.7,874.584 1917.36,901.627 1921.02,928.081 1924.68,954.003 1928.34,979.462 1932,1004.52 1935.65,1029.21 1939.31,1053.52 1942.97,1077.37 1946.63,1100.57 1950.29,1122.82 1953.94,1143.71 1957.6,1162.72 1961.26,1179.25 1964.92,1192.68 1968.58,1202.46 1972.23,1208.18 1975.89,1209.65 1979.55,1206.94 1983.21,1200.46 1986.87,1190.82 1990.53,1178.84 1994.18,1165.37 1997.84,1151.14 2001.5,1136.63 2005.16,1121.99 2008.82,1106.98 2012.47,1091.08 2016.13,1073.5 2019.79,1053.4 2023.45,1029.95 2027.11,1002.53 2030.76,970.722 2034.42,934.395 2038.08,893.685 2041.74,848.959 2045.4,800.771 2049.06,749.818 2052.71,696.901 2056.37,642.884 2060.03,588.675 2063.69,535.186 2067.35,483.302 2071,433.837 2074.66,387.491 2078.32,344.816 2081.98,306.202 2085.64,271.886 2089.29,241.982 2092.95,216.515 2096.61,195.454 2100.27,178.733 2103.93,166.27 2107.58,157.986 2111.24,153.835 2114.9,153.823 2118.56,158.022 2122.22,166.567 2125.88,179.633 2129.53,197.399 2133.19,220.011 2136.85,247.542 2140.51,279.965 2144.17,317.136 2147.82,358.794 2151.48,404.563 2155.14,453.965 2158.8,506.432 2162.46,561.315 2166.11,617.883 2169.77,675.311 2173.43,732.656 2177.09,788.838 2180.75,842.619 2184.41,892.617 2188.06,937.354 2191.72,975.356 2195.38,1005.32 2199.04,1026.29 2202.7,1037.88 2206.35,1040.38 2210.01,1034.8 2213.67,1022.83 2217.33,1006.57 2220.99,988.288 2224.64,970.081 2228.3,953.595 2231.96,939.822 2235.62,929.009 2239.28,920.663 2242.94,913.661 2246.59,906.438 2250.25,897.214 2253.91,884.244 2257.57,866.047 2261.23,841.575 2264.88,810.323 2268.54,772.358 2272.2,728.287 2275.86,679.188 2279.52,626.514 2283.17,571.987 2286.83,517.494 2290.49,464.962 2294.15,416.223 2297.81,372.867 2301.47,336.099 2305.12,306.63 2308.78,284.633 2312.44,269.76 2316.1,261.22 2319.76,257.897 2323.41,258.48 2327.07,261.608 2330.73,266.01 2334.39,270.639 2338.05,274.768 2341.7,278.047 2345.36,280.51 2349.02,282.558 2352.68,284.919 2356.34,288.61 2360,294.898 2363.65,305.254 2367.31,321.281 2370.97,344.618 2374.63,376.796 2378.29,419.058 2381.94,472.165 2385.6,536.211 2389.26,610.477 2392.92,693.342 2396.58,782.275 2400.23,873.907 2403.89,964.202 2407.55,1048.73 2411.21,1123.07 2414.87,1183.2 2418.53,1226.02 2422.18,1249.62 2425.84,1253.54 2429.5,1238.7 2433.16,1207.22 2436.82,1162.16 2440.47,1107.13 2444.13,1045.97 2447.79,982.402 2451.45,919.747 2455.11,860.743 2458.76,807.429 2462.42,761.134 2466.08,722.544 2469.74,691.817 2473.4,668.73 2477.06,652.818 2480.71,643.491 2484.37,640.123 2488.03,642.097 2491.69,648.821 2495.35,659.713 2499,674.175 2502.66,691.551 2506.32,711.096 2509.98,731.95 2513.64,753.133 2517.29,773.57 2520.95,792.133 2524.61,807.724 2528.27,819.37 2531.93,826.337 2535.58,828.244 2539.24,825.165 2542.9,817.686 2546.56,806.916 2550.22,794.412 2553.88,782.026 2557.53,771.65 2561.19,764.909 2564.85,762.84 2568.51,765.63 2572.17,772.532 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="285.841,1474.45 289.5,1473.42 293.158,1468.55 296.816,1460.19 300.474,1448.65 304.132,1434.16 307.79,1416.9 311.448,1397.07 315.106,1374.92 318.765,1350.78 322.423,1325.11 326.081,1298.51 329.739,1271.73 333.397,1245.56 337.055,1220.82 340.713,1198.23 344.371,1178.32 348.029,1161.34 351.688,1147.26 355.346,1135.71 359.004,1126.06 362.662,1117.46 366.32,1109 369.978,1099.74 373.636,1088.89 377.294,1075.82 380.953,1060.17 384.611,1041.81 388.269,1020.85 391.927,997.628 395.585,972.614 399.243,946.381 402.901,919.532 406.559,892.642 410.218,866.199 413.876,840.563 417.534,815.937 421.192,792.356 424.85,769.702 428.508,747.74 432.166,726.164 435.824,704.656 439.482,682.944 443.141,660.852 446.799,638.343 450.457,615.544 454.115,592.753 457.773,570.426 461.431,549.142 465.089,529.567 468.747,512.401 472.406,498.342 476.064,488.054 479.722,482.148 483.38,481.165 487.038,485.559 490.696,495.682 494.354,511.768 498.012,533.923 501.671,562.112 505.329,596.164 508.987,635.776 512.645,680.524 516.303,729.874 519.961,783.184 523.619,839.707 527.277,898.579 530.935,958.813 534.594,1019.28 538.252,1078.72 541.91,1135.72 545.568,1188.78 549.226,1236.35 552.884,1276.91 556.542,1309.11 560.2,1331.82 563.859,1344.28 567.517,1346.11 571.175,1337.41 574.833,1318.73 578.491,1291.1 582.149,1256 585.807,1215.27 589.465,1171.03 593.123,1125.52 596.782,1080.94 600.44,1039.33 604.098,1002.37 607.756,971.35 611.414,947.109 615.072,930.011 618.73,919.977 622.388,916.506 626.047,918.721 629.705,925.422 633.363,935.161 637.021,946.336 640.679,957.322 644.337,966.608 647.995,972.957 651.653,975.526 655.312,973.951 658.97,968.368 662.628,959.348 666.286,947.786 669.944,934.726 673.602,921.191 677.26,908.024 680.918,895.779 684.576,884.684 688.235,874.666 691.893,865.429 695.551,856.551 699.209,847.581 702.867,838.109 706.525,827.811 710.183,816.465 713.841,803.955 717.5,790.259 721.158,775.435 724.816,759.617 728.474,743.002 732.132,725.857 735.79,708.523 739.448,691.425 743.106,675.074 746.765,660.075 750.423,647.116 754.081,636.955 757.739,630.411 761.397,628.341 765.055,631.618 768.713,641.093 772.371,657.546 776.029,681.615 779.688,713.693 783.346,753.833 787.004,801.644 790.662,856.227 794.32,916.162 797.978,979.568 801.636,1044.24 805.294,1107.82 808.953,1168.04 812.611,1222.91 816.269,1270.84 819.927,1310.79 823.585,1342.18 827.243,1364.9 830.901,1379.15 834.559,1385.32 838.218,1383.88 841.876,1375.31 845.534,1360.06 849.192,1338.58 852.85,1311.38 856.508,1279.08 860.166,1242.55 863.824,1202.92 867.482,1161.66 871.141,1120.48 874.799,1081.28 878.457,1045.98 882.115,1016.32 885.773,993.744 889.431,979.166 893.089,972.894 896.747,974.56 900.406,983.139 904.064,997.068 907.722,1014.44 911.38,1033.27 915.038,1051.78 918.696,1068.56 922.354,1082.73 926.012,1093.87 929.67,1101.89 933.329,1106.89 936.987,1109 940.645,1108.34 944.303,1104.96 947.961,1098.96 951.619,1090.48 955.277,1079.74 958.935,1067.05 962.594,1052.75 966.252,1037.12 969.91,1020.41 973.568,1002.74 977.226,984.106 980.884,964.444 984.542,943.622 988.2,921.521 991.859,898.095 995.517,873.442 999.175,847.866 1002.83,821.929 1006.49,796.471 1010.15,772.608 1013.81,751.668 1017.47,735.108 1021.12,724.372 1024.78,720.752 1028.44,725.237 1032.1,738.4 1035.76,760.333 1039.41,790.627 1043.07,828.424 1046.73,872.493 1050.39,921.342 1054.05,973.33 1057.7,1026.77 1061.36,1080.01 1065.02,1131.51 1068.68,1179.93 1072.34,1224.14 1076,1263.29 1079.65,1296.81 1083.31,1324.48 1086.97,1346.36 1090.63,1362.76 1094.29,1374.18 1097.94,1381.23 1101.6,1384.56 1105.26,1384.74 1108.92,1382.27 1112.58,1377.48 1116.23,1370.6 1119.89,1361.74 1123.55,1350.94 1127.21,1338.29 1130.87,1323.92 1134.53,1308.1 1138.18,1291.26 1141.84,1273.93 1145.5,1256.62 1149.16,1239.75 1152.82,1223.48 1156.47,1207.65 1160.13,1191.84 1163.79,1175.44 1167.45,1157.84 1171.11,1138.57 1174.76,1117.44 1178.42,1094.55 1182.08,1070.24 1185.74,1045.01 1189.4,1019.41 1193.06,993.931 1196.71,968.918 1200.37,944.539 1204.03,920.779 1207.69,897.469 1211.35,874.334 1215,851.042 1218.66,827.237 1222.32,802.565 1225.98,776.692 1229.64,749.346 1233.29,720.382 1236.95,689.881 1240.61,658.27 1244.27,626.42 1247.93,595.691 1251.59,567.848 1255.24,544.861 1258.9,528.603 1262.56,520.527 1266.22,521.424 1269.88,531.34 1273.53,549.652 1277.19,575.269 1280.85,606.881 1284.51,643.176 1288.17,682.992 1291.82,725.39 1295.48,769.66 1299.14,815.294 1302.8,861.942 1306.46,909.357 1310.11,957.355 1313.77,1005.77 1317.43,1054.4 1321.09,1103.01 1324.75,1151.21 1328.41,1198.48 1332.06,1244.1 1335.72,1287.15 1339.38,1326.51 1343.04,1360.92 1346.7,1389.1 1350.35,1409.86 1354.01,1422.25 1357.67,1425.74 1361.33,1420.3 1364.99,1406.55 1368.64,1385.75 1372.3,1359.71 1375.96,1330.63 1379.62,1300.81 1383.28,1272.26 1386.94,1246.51 1390.59,1224.35 1394.25,1205.82 1397.91,1190.32 1401.57,1176.8 1405.23,1164.01 1408.88,1150.68 1412.54,1135.78 1416.2,1118.56 1419.86,1098.64 1423.52,1075.97 1427.17,1050.78 1430.83,1023.51 1434.49,994.672 1438.15,964.824 1441.81,934.483 1445.47,904.09 1449.12,873.99 1452.78,844.428 1456.44,815.558 1460.1,787.455 1463.76,760.132 1467.41,733.563 1471.07,707.696 1474.73,682.467 1478.39,657.822 1482.05,633.721 1485.7,610.152 1489.36,587.145 1493.02,564.776 1496.68,543.177 1500.34,522.55 1504,503.173 1507.65,485.41 1511.31,469.721 1514.97,456.671 1518.63,446.934 1522.29,441.286 1525.94,440.6 1529.6,445.805 1533.26,457.843 1536.92,477.584 1540.58,505.712 1544.23,542.585 1547.89,588.061 1551.55,641.325 1555.21,700.732 1558.87,763.731 1562.53,826.913 1566.18,886.266 1569.84,937.65 1573.5,977.48 1577.16,1003.51 1580.82,1015.5 1584.47,1015.45 1588.13,1007.23 1591.79,995.425 1595.45,983.713 1599.11,973.41 1602.76,962.856 1606.42,948.074 1610.08,924.498 1613.74,889.037 1617.4,841.595 1621.06,785.503 1624.71,726.834 1628.37,672.876 1632.03,630.223 1635.69,603.045 1639.35,592.225 1643,595.76 1646.66,610.14 1650.32,631.832 1653.98,658.106 1657.64,687.092 1661.29,717.358 1664.95,747.482 1668.61,775.879 1672.27,800.962 1675.93,821.482 1679.58,836.816 1683.24,847.05 1686.9,852.837 1690.56,855.138 1694.22,854.953 1697.88,853.157 1701.53,850.431 1705.19,847.292 1708.85,844.15 1712.51,841.372 1716.17,839.316 1719.82,838.328 1723.48,838.707 1727.14,840.637 1730.8,844.105 1734.46,848.835 1738.11,854.267 1741.77,859.607 1745.43,863.964 1749.09,866.539 1752.75,866.801 1756.41,864.579 1760.06,860.003 1763.72,853.34 1767.38,844.801 1771.04,834.409 1774.7,821.99 1778.35,807.256 1782.01,789.933 1785.67,769.877 1789.33,747.147 1792.99,722.035 1796.64,695.066 1800.3,666.973 1803.96,638.68 1807.62,611.303 1811.28,586.145 1814.94,564.694 1818.59,548.595 1822.25,539.598 1825.91,539.504 1829.57,550.1 1833.23,573.065 1836.88,609.806 1840.54,661.191 1844.2,727.208 1847.86,806.613 1851.52,896.735 1855.17,993.559 1858.83,1092.14 1862.49,1187.3 1866.15,1274.3 1869.81,1349.55 1873.47,1410.82 1877.12,1457.36 1880.78,1489.65 1884.44,1509.05 1888.1,1517.5 1891.76,1517.1 1895.41,1509.93 1899.07,1497.88 1902.73,1482.54 1906.39,1465.17 1910.05,1446.72 1913.7,1427.89 1917.36,1409.1 1921.02,1390.6 1924.68,1372.49 1928.34,1354.77 1932,1337.35 1935.65,1320.1 1939.31,1302.89 1942.97,1285.59 1946.63,1268.12 1950.29,1250.47 1953.94,1232.71 1957.6,1215.01 1961.26,1197.64 1964.92,1180.91 1968.58,1165.15 1972.23,1150.63 1975.89,1137.51 1979.55,1125.79 1983.21,1115.29 1986.87,1105.69 1990.53,1096.59 1994.18,1087.57 1997.84,1078.26 2001.5,1068.38 2005.16,1057.76 2008.82,1046.29 2012.47,1033.93 2016.13,1020.68 2019.79,1006.51 2023.45,991.44 2027.11,975.469 2030.76,958.605 2034.42,940.846 2038.08,922.165 2041.74,902.503 2045.4,881.766 2049.06,859.844 2052.71,836.657 2056.37,812.223 2060.03,786.746 2063.69,760.719 2067.35,735.019 2071,710.966 2074.66,690.311 2078.32,675.134 2081.98,667.629 2085.64,669.814 2089.29,683.211 2092.95,708.576 2096.61,745.747 2100.27,793.643 2103.93,850.398 2107.58,913.596 2111.24,980.52 2114.9,1048.4 2118.56,1114.6 2122.22,1176.79 2125.88,1233.03 2129.53,1281.9 2133.19,1322.52 2136.85,1354.59 2140.51,1378.35 2144.17,1394.5 2147.82,1404.03 2151.48,1408.11 2155.14,1407.89 2158.8,1404.41 2162.46,1398.51 2166.11,1390.77 2169.77,1381.55 2173.43,1371 2177.09,1359.17 2180.75,1346.03 2184.41,1331.6 2188.06,1315.95 2191.72,1299.32 2195.38,1281.99 2199.04,1264.28 2202.7,1246.43 2206.35,1228.48 2210.01,1210.28 2213.67,1191.52 2217.33,1171.8 2220.99,1150.8 2224.64,1128.39 2228.3,1104.63 2231.96,1079.79 2235.62,1054.29 2239.28,1028.57 2242.94,1003.02 2246.59,977.899 2250.25,953.333 2253.91,929.29 2257.57,905.625 2261.23,882.113 2264.88,858.485 2268.54,834.44 2272.2,809.665 2275.86,783.854 2279.52,756.753 2283.17,728.246 2286.83,698.472 2290.49,667.959 2294.15,637.738 2297.81,609.388 2301.47,584.943 2305.12,566.653 2308.78,556.628 2312.44,556.461 2316.1,566.946 2319.76,587.992 2323.41,618.736 2327.07,657.796 2330.73,703.575 2334.39,754.504 2338.05,809.209 2341.7,866.566 2345.36,925.694 2349.02,985.898 2352.68,1046.6 2356.34,1107.25 2360,1167.26 2363.65,1225.99 2367.31,1282.62 2370.97,1336.24 2374.63,1385.83 2378.29,1430.34 2381.94,1468.78 2385.6,1500.27 2389.26,1524.16 2392.92,1539.98 2396.58,1547.52 2400.23,1546.77 2403.89,1538.07 2407.55,1522.19 2411.21,1500.4 2414.87,1474.51 2418.53,1446.66 2422.18,1418.97 2425.84,1393.09 2429.5,1369.91 2433.16,1349.38 2436.82,1330.74 2440.47,1312.8 2444.13,1294.33 2447.79,1274.37 2451.45,1252.44 2455.11,1228.53 2458.76,1203.12 2462.42,1176.98 2466.08,1151.05 2469.74,1126.29 2473.4,1103.53 2477.06,1083.4 2480.71,1066.29 2484.37,1052.31 2488.03,1041.34 2491.69,1033.04 2495.35,1026.89 2499,1022.29 2502.66,1018.55 2506.32,1014.97 2509.98,1010.92 2513.64,1005.81 2517.29,999.187 2520.95,990.689 2524.61,980.055 2528.27,967.079 2531.93,951.557 2535.58,933.233 2539.24,911.766 2542.9,886.726 2546.56,857.641 2550.22,824.091 2553.88,785.83 2557.53,742.914 2561.19,695.792 2564.85,645.32 2568.51,592.683 2572.17,539.234 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="285.841,1089.95 289.5,1058.42 293.158,1032.51 296.816,1012.52 300.474,998.479 304.132,990.104 307.79,986.869 311.448,988.023 315.106,992.633 318.765,999.651 322.423,1007.98 326.081,1016.55 329.739,1024.42 333.397,1030.81 337.055,1035.2 340.713,1037.28 344.371,1037.02 348.029,1034.54 351.688,1030.12 355.346,1024.07 359.004,1016.67 362.662,1008.16 366.32,998.665 369.978,988.218 373.636,976.769 377.294,964.212 380.953,950.409 384.611,935.219 388.269,918.502 391.927,900.14 395.585,880.043 399.243,858.166 402.901,834.532 406.559,809.266 410.218,782.625 413.876,755.035 417.534,727.105 421.192,699.638 424.85,673.61 428.508,650.136 432.166,630.42 435.824,615.689 439.482,607.122 443.141,605.779 446.799,612.527 450.457,627.97 454.115,652.389 457.773,685.7 461.431,727.435 465.089,776.756 468.747,832.493 472.406,893.205 476.064,957.26 479.722,1022.91 483.38,1088.36 487.038,1151.89 490.696,1211.87 494.354,1266.89 498.012,1315.83 501.671,1357.88 505.329,1392.62 508.987,1419.96 512.645,1440.12 516.303,1453.51 519.961,1460.67 523.619,1462.15 527.277,1458.42 530.935,1449.87 534.594,1436.78 538.252,1419.43 541.91,1398.16 545.568,1373.49 549.226,1346.22 552.884,1317.42 556.542,1288.44 560.2,1260.74 563.859,1235.66 567.517,1214.23 571.175,1196.93 574.833,1183.63 578.491,1173.58 582.149,1165.54 585.807,1158.05 589.465,1149.63 593.123,1138.98 596.782,1125.18 600.44,1107.74 604.098,1086.56 607.756,1061.94 611.414,1034.45 615.072,1004.82 618.73,973.903 622.388,942.55 626.047,911.549 629.705,881.569 633.363,853.111 637.021,826.477 640.679,801.756 644.337,778.833 647.995,757.424 651.653,737.124 655.312,717.472 658.97,698.017 662.628,678.379 666.286,658.302 669.944,637.687 673.602,616.616 677.26,595.357 680.918,574.339 684.576,554.121 688.235,535.33 691.893,518.607 695.551,504.561 699.209,493.733 702.867,486.577 706.525,483.46 710.183,484.652 713.841,490.34 717.5,500.621 721.158,515.513 724.816,534.957 728.474,558.826 732.132,586.933 735.79,619.038 739.448,654.856 743.106,694.059 746.765,736.276 750.423,781.084 754.081,827.998 757.739,876.463 761.397,925.832 765.055,975.352 768.713,1024.15 772.371,1071.21 776.029,1115.41 779.688,1155.52 783.346,1190.27 787.004,1218.41 790.662,1238.87 794.32,1250.79 797.978,1253.71 801.636,1247.6 805.294,1232.95 808.953,1210.76 812.611,1182.48 816.269,1149.95 819.927,1115.21 823.585,1080.34 827.243,1047.27 830.901,1017.66 834.559,992.732 838.218,973.251 841.876,959.452 845.534,951.074 849.192,947.391 852.85,947.277 856.508,949.304 860.166,951.863 863.824,953.306 867.482,952.107 871.141,947.018 874.799,937.194 878.457,922.285 882.115,902.465 885.773,878.403 889.431,851.179 893.089,822.158 896.747,792.828 900.406,764.628 904.064,738.789 907.722,716.206 911.38,697.366 915.038,682.352 918.696,670.902 922.354,662.521 926.012,656.585 929.67,652.439 933.329,649.453 936.987,647.048 940.645,644.708 944.303,641.986 947.961,638.527 951.619,634.09 955.277,628.581 958.935,622.066 962.594,614.781 966.252,607.109 969.91,599.555 973.568,592.718 977.226,587.261 980.884,583.895 984.542,583.365 988.2,586.452 991.859,593.954 995.517,606.665 999.175,625.336 1002.83,650.599 1006.49,682.879 1010.15,722.285 1013.81,768.501 1017.47,820.711 1021.12,877.566 1024.78,937.23 1028.44,997.493 1032.1,1055.95 1035.76,1110.23 1039.41,1158.18 1043.07,1198.03 1046.73,1228.54 1050.39,1248.93 1054.05,1258.93 1057.7,1258.67 1061.36,1248.61 1065.02,1229.48 1068.68,1202.26 1072.34,1168.15 1076,1128.58 1079.65,1085.12 1083.31,1039.5 1086.97,993.47 1090.63,948.733 1094.29,906.853 1097.94,869.176 1101.6,836.781 1105.26,810.455 1108.92,790.691 1112.58,777.695 1116.23,771.399 1119.89,771.473 1123.55,777.334 1127.21,788.163 1130.87,802.936 1134.53,820.485 1138.18,839.578 1141.84,859.021 1145.5,877.757 1149.16,894.929 1152.82,909.9 1156.47,922.223 1160.13,931.586 1163.79,937.75 1167.45,940.516 1171.11,939.709 1174.76,935.192 1178.42,926.877 1182.08,914.736 1185.74,898.816 1189.4,879.249 1193.06,856.278 1196.71,830.275 1200.37,801.773 1204.03,771.479 1207.69,740.292 1211.35,709.308 1215,679.808 1218.66,653.247 1222.32,631.224 1225.98,615.444 1229.64,607.663 1233.29,609.616 1236.95,622.904 1240.61,648.841 1244.27,688.233 1247.93,741.131 1251.59,806.58 1255.24,882.471 1258.9,965.585 1262.56,1051.87 1266.22,1136.92 1269.88,1216.56 1273.53,1287.4 1277.19,1347.14 1280.85,1394.73 1284.51,1430.24 1288.17,1454.56 1291.82,1469.16 1295.48,1475.68 1299.14,1475.77 1302.8,1470.84 1306.46,1462.04 1310.11,1450.13 1313.77,1435.61 1317.43,1418.66 1321.09,1399.27 1324.75,1377.38 1328.41,1352.89 1332.06,1325.92 1335.72,1296.85 1339.38,1266.45 1343.04,1235.9 1346.7,1206.74 1350.35,1180.65 1354.01,1159.22 1357.67,1143.59 1361.33,1134.18 1364.99,1130.61 1368.64,1131.75 1372.3,1135.93 1375.96,1141.36 1379.62,1146.42 1383.28,1149.94 1386.94,1151.22 1390.59,1150.05 1394.25,1146.51 1397.91,1140.85 1401.57,1133.33 1405.23,1124.21 1408.88,1113.72 1412.54,1102.08 1416.2,1089.54 1419.86,1076.36 1423.52,1062.86 1427.17,1049.34 1430.83,1036.06 1434.49,1023.24 1438.15,1010.98 1441.81,999.32 1445.47,988.216 1449.12,977.572 1452.78,967.258 1456.44,957.133 1460.1,947.066 1463.76,936.951 1467.41,926.716 1471.07,916.336 1474.73,905.836 1478.39,895.298 1482.05,884.861 1485.7,874.73 1489.36,865.17 1493.02,856.507 1496.68,849.127 1500.34,843.458 1504,839.964 1507.65,839.113 1511.31,841.348 1514.97,847.045 1518.63,856.468 1522.29,869.712 1525.94,886.657 1529.6,906.921 1533.26,929.833 1536.92,954.43 1540.58,979.482 1544.23,1003.56 1547.89,1025.12 1551.55,1042.68 1555.21,1055 1558.87,1061.24 1562.53,1061.21 1566.18,1055.39 1569.84,1044.93 1573.5,1031.25 1577.16,1015.66 1580.82,998.852 1584.47,980.717 1588.13,960.638 1591.79,938.013 1595.45,912.748 1599.11,885.312 1602.76,856.342 1606.42,826.088 1610.08,794.095 1613.74,759.279 1617.4,720.267 1621.06,675.785 1624.71,625.085 1628.37,568.5 1632.03,508.067 1635.69,447.805 1639.35,393.141 1643,349.508 1646.66,320.746 1650.32,308.169 1653.98,310.588 1657.64,325.043 1661.29,347.793 1664.95,375.184 1668.61,404.223 1672.27,432.808 1675.93,459.68 1679.58,484.207 1683.24,506.121 1686.9,525.294 1690.56,541.599 1694.22,554.861 1697.88,564.858 1701.53,571.354 1705.19,574.138 1708.85,573.048 1712.51,567.994 1716.17,558.975 1719.82,546.095 1723.48,529.581 1727.14,509.791 1730.8,487.21 1734.46,462.423 1738.11,436.066 1741.77,408.762 1745.43,381.066 1749.09,353.44 1752.75,326.272 1756.41,299.944 1760.06,274.918 1763.72,251.802 1767.38,231.377 1771.04,214.573 1774.7,202.413 1778.35,195.961 1782.01,196.253 1785.67,204.248 1789.33,220.756 1792.99,246.379 1796.64,281.439 1800.3,325.945 1803.96,379.579 1807.62,441.722 1811.28,511.487 1814.94,587.76 1818.59,669.218 1822.25,754.333 1825.91,841.355 1829.57,928.268 1833.23,1012.74 1836.88,1092.1 1840.54,1163.36 1844.2,1223.37 1847.86,1269.09 1851.52,1297.96 1855.17,1308.32 1858.83,1299.71 1862.49,1273.01 1866.15,1230.42 1869.81,1175.11 1873.47,1110.94 1877.12,1041.96 1880.78,972.037 1884.44,904.506 1888.1,842.01 1891.76,786.412 1895.41,738.824 1899.07,699.711 1902.73,669.026 1906.39,646.353 1910.05,631.033 1913.7,622.279 1917.36,619.249 1921.02,621.11 1924.68,627.06 1928.34,636.351 1932,648.286 1935.65,662.216 1939.31,677.523 1942.97,693.617 1946.63,709.92 1950.29,725.873 1953.94,740.936 1957.6,754.614 1961.26,766.473 1964.92,776.176 1968.58,783.504 1972.23,788.364 1975.89,790.783 1979.55,790.882 1983.21,788.828 1986.87,784.793 1990.53,778.915 1994.18,771.279 1997.84,761.914 2001.5,750.814 2005.16,737.959 2008.82,723.344 2012.47,707.008 2016.13,689.055 2019.79,669.68 2023.45,649.182 2027.11,627.983 2030.76,606.637 2034.42,585.834 2038.08,566.392 2041.74,549.249 2045.4,535.45 2049.06,526.129 2052.71,522.495 2056.37,525.799 2060.03,537.29 2063.69,558.123 2067.35,589.223 2071,631.098 2074.66,683.612 2078.32,745.783 2081.98,815.647 2085.64,890.286 2089.29,966.033 2092.95,1038.85 2096.61,1104.82 2100.27,1160.56 2103.93,1203.55 2107.58,1232.27 2111.24,1246.13 2114.9,1245.35 2118.56,1230.78 2122.22,1203.81 2125.88,1166.24 2129.53,1120.24 2133.19,1068.29 2136.85,1013.04 2140.51,957.151 2144.17,903.142 2147.82,853.196 2151.48,809.056 2155.14,771.981 2158.8,742.745 2162.46,721.695 2166.11,708.816 2169.77,703.79 2173.43,706.05 2177.09,714.809 2180.75,729.081 2184.41,747.708 2188.06,769.408 2191.72,792.836 2195.38,816.674 2199.04,839.719 2202.7,860.942 2206.35,879.527 2210.01,894.852 2213.67,906.461 2217.33,914.018 2220.99,917.288 2224.64,916.117 2228.3,910.43 2231.96,900.238 2235.62,885.641 2239.28,866.839 2242.94,844.153 2246.59,818.04 2250.25,789.121 2253.91,758.199 2257.57,726.265 2261.23,694.507 2264.88,664.299 2268.54,637.179 2272.2,614.822 2275.86,598.999 2279.52,591.528 2283.17,594.2 2286.83,608.678 2290.49,636.327 2294.15,677.982 2297.81,733.664 2301.47,802.289 2305.12,881.505 2308.78,967.74 2312.44,1056.54 2316.1,1143.14 2319.76,1223.17 2323.41,1293.22 2327.07,1351.14 2330.73,1396.15 2334.39,1428.55 2338.05,1449.36 2341.7,1459.95 2345.36,1461.7 2349.02,1455.8 2352.68,1443.08 2356.34,1424.07 2360,1399.03 2363.65,1368.12 2367.31,1331.59 2370.97,1290.01 2374.63,1244.46 2378.29,1196.65 2381.94,1148.94 2385.6,1104.21 2389.26,1065.52 2392.92,1035.74 2396.58,1017.07 2400.23,1010.65 2403.89,1016.33 2407.55,1032.61 2411.21,1056.91 2414.87,1086.01 2418.53,1116.61 2422.18,1145.83 2425.84,1171.54 2429.5,1192.38 2433.16,1207.63 2436.82,1217.04 2440.47,1220.67 2444.13,1218.88 2447.79,1212.24 2451.45,1201.57 2455.11,1187.89 2458.76,1172.26 2462.42,1155.71 2466.08,1139.09 2469.74,1123.04 2473.4,1107.92 2477.06,1093.87 2480.71,1080.84 2484.37,1068.66 2488.03,1057.09 2491.69,1045.89 2495.35,1034.82 2499,1023.67 2502.66,1012.3 2506.32,1000.57 2509.98,988.368 2513.64,975.59 2517.29,962.103 2520.95,947.746 2524.61,932.327 2528.27,915.626 2531.93,897.401 2535.58,877.404 2539.24,855.38 2542.9,831.076 2546.56,804.24 2550.22,774.64 2553.88,742.1 2557.53,706.567 2561.19,668.231 2564.85,627.699 2568.51,586.202 2572.17,545.807 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#c271d2; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="285.841,1050.47 289.5,1035.17 293.158,1016.41 296.816,994.912 300.474,971.477 304.132,946.912 307.79,921.987 311.448,897.382 315.106,873.655 318.765,851.216 322.423,830.312 326.081,811.03 329.739,793.31 333.397,776.975 337.055,761.76 340.713,747.36 344.371,733.462 348.029,719.781 351.688,706.085 355.346,692.21 359.004,678.066 362.662,663.642 366.32,649.002 369.978,634.28 373.636,619.685 377.294,605.495 380.953,592.063 384.611,579.824 388.269,569.292 391.927,561.066 395.585,555.817 399.243,554.281 402.901,557.236 406.559,565.466 410.218,579.723 413.876,600.662 417.534,628.78 421.192,664.339 424.85,707.303 428.508,757.277 432.166,813.483 435.824,874.748 439.482,939.542 443.141,1006.03 446.799,1072.19 450.457,1135.89 454.115,1195.07 457.773,1247.86 461.431,1292.69 465.089,1328.41 468.747,1354.26 472.406,1369.88 476.064,1375.28 479.722,1370.72 483.38,1356.69 487.038,1333.91 490.696,1303.32 494.354,1266.15 498.012,1223.9 501.671,1178.37 505.329,1131.55 508.987,1085.54 512.645,1042.38 516.303,1003.94 519.961,971.736 523.619,946.89 527.277,930.028 530.935,921.268 534.594,920.22 538.252,926.016 541.91,937.371 545.568,952.688 549.226,970.201 552.884,988.161 556.542,1005.03 560.2,1019.64 563.859,1031.29 567.517,1039.76 571.175,1045.23 574.833,1048.08 578.491,1048.76 582.149,1047.65 585.807,1044.95 589.465,1040.69 593.123,1034.78 596.782,1027.08 600.44,1017.43 604.098,1005.71 607.756,991.859 611.414,975.82 615.072,957.557 618.73,937.037 622.388,914.245 626.047,889.217 629.705,862.088 633.363,833.14 637.021,802.851 640.679,771.916 644.337,741.249 647.995,711.953 651.653,685.27 655.312,662.511 658.97,644.984 662.628,633.914 666.286,630.369 669.944,635.19 673.602,648.927 677.26,671.783 680.918,703.576 684.576,743.733 688.235,791.304 691.893,845.016 695.551,903.348 699.209,964.616 702.867,1027.07 706.525,1088.97 710.183,1148.68 713.841,1204.72 717.5,1255.86 721.158,1301.12 724.816,1339.88 728.474,1371.84 732.132,1397.01 735.79,1415.72 739.448,1428.48 743.106,1435.94 746.765,1438.8 750.423,1437.69 754.081,1433.17 757.739,1425.66 761.397,1415.45 765.055,1402.74 768.713,1387.65 772.371,1370.34 776.029,1351.07 779.688,1330.24 783.346,1308.45 787.004,1286.44 790.662,1265.08 794.32,1245.15 797.978,1227.26 801.636,1211.67 805.294,1198.23 808.953,1186.39 812.611,1175.28 816.269,1163.92 819.927,1151.35 823.585,1136.8 827.243,1119.81 830.901,1100.23 834.559,1078.24 838.218,1054.25 841.876,1028.82 845.534,1002.6 849.192,976.206 852.85,950.172 856.508,924.88 860.166,900.537 863.824,877.158 867.482,854.592 871.141,832.55 874.799,810.658 878.457,788.503 882.115,765.684 885.773,741.857 889.431,716.771 893.089,690.328 896.747,662.635 900.406,634.057 904.064,605.258 907.722,577.19 911.38,551.026 915.038,528.045 918.696,509.471 922.354,496.32 926.012,489.284 929.67,488.676 933.329,494.438 936.987,506.203 940.645,523.39 944.303,545.309 947.961,571.246 951.619,600.534 955.277,632.587 958.935,666.913 962.594,703.106 966.252,740.83 969.91,779.799 973.568,819.755 977.226,860.454 980.884,901.644 984.542,943.044 988.2,984.328 991.859,1025.09 995.517,1064.84 999.175,1102.95 1002.83,1138.67 1006.49,1171.15 1010.15,1199.43 1013.81,1222.56 1017.47,1239.68 1021.12,1250.09 1024.78,1253.43 1028.44,1249.75 1032.1,1239.55 1035.76,1223.79 1039.41,1203.85 1043.07,1181.36 1046.73,1157.99 1050.39,1135.32 1054.05,1114.57 1057.7,1096.53 1061.36,1081.43 1065.02,1068.99 1068.68,1058.46 1072.34,1048.77 1076,1038.65 1079.65,1026.84 1083.31,1012.17 1086.97,993.749 1090.63,970.96 1094.29,943.534 1097.94,911.514 1101.6,875.219 1105.26,835.181 1108.92,792.094 1112.58,746.753 1116.23,700.015 1119.89,652.761 1123.55,605.862 1127.21,560.153 1130.87,516.395 1134.53,475.24 1138.18,437.202 1141.84,402.634 1145.5,371.719 1149.16,344.49 1152.82,320.854 1156.47,300.63 1160.13,283.594 1163.79,269.514 1167.45,258.19 1171.11,249.491 1174.76,243.392 1178.42,240.006 1182.08,239.6 1185.74,242.601 1189.4,249.568 1193.06,261.164 1196.71,278.093 1200.37,301.035 1204.03,330.578 1207.69,367.151 1211.35,410.964 1215,461.964 1218.66,519.807 1222.32,583.828 1225.98,653.02 1229.64,726.015 1233.29,801.061 1236.95,876.008 1240.61,948.319 1244.27,1015.14 1247.93,1073.45 1251.59,1120.31 1255.24,1153.16 1258.9,1170.19 1262.56,1170.66 1266.22,1155.02 1269.88,1124.95 1273.53,1083.15 1277.19,1033.05 1280.85,978.354 1284.51,922.691 1288.17,869.276 1291.82,820.708 1295.48,778.889 1299.14,745.038 1302.8,719.774 1306.46,703.217 1310.11,695.1 1313.77,694.854 1317.43,701.667 1321.09,714.516 1324.75,732.186 1328.41,753.282 1332.06,776.265 1335.72,799.512 1339.38,821.433 1343.04,840.621 1346.7,856.034 1350.35,867.142 1354.01,874.017 1357.67,877.293 1361.33,878.021 1364.99,877.424 1368.64,876.626 1372.3,876.444 1375.96,877.276 1379.62,879.116 1383.28,881.658 1386.94,884.429 1390.59,886.91 1394.25,888.619 1397.91,889.146 1401.57,888.161 1405.23,885.41 1408.88,880.711 1412.54,873.956 1416.2,865.122 1419.86,854.281 1423.52,841.601 1427.17,827.338 1430.83,811.815 1434.49,795.398 1438.15,778.46 1441.81,761.361 1445.47,744.429 1449.12,727.948 1452.78,712.157 1456.44,697.259 1460.1,683.424 1463.76,670.801 1467.41,659.525 1471.07,649.725 1474.73,641.526 1478.39,635.051 1482.05,630.418 1485.7,627.732 1489.36,627.076 1493.02,628.495 1496.68,631.978 1500.34,637.442 1504,644.711 1507.65,653.501 1511.31,663.416 1514.97,673.947 1518.63,684.494 1522.29,694.397 1525.94,702.996 1529.6,709.688 1533.26,714.013 1536.92,715.712 1540.58,714.785 1544.23,711.5 1547.89,706.34 1551.55,699.904 1555.21,692.734 1558.87,685.141 1562.53,677.062 1566.18,668.023 1569.84,657.252 1573.5,643.891 1577.16,627.228 1580.82,606.814 1584.47,582.429 1588.13,553.975 1591.79,521.424 1595.45,484.93 1599.11,445.071 1602.76,403.118 1606.42,361.21 1610.08,322.407 1613.74,290.636 1617.4,270.588 1621.06,267.536 1624.71,286.991 1628.37,334.057 1632.03,412.377 1635.69,522.755 1639.35,661.937 1643,822.299 1646.66,992.859 1650.32,1161.3 1653.98,1316.17 1657.64,1448.49 1661.29,1552.6 1664.95,1626.19 1668.61,1669.87 1672.27,1686.38 1675.93,1679.73 1679.58,1654.5 1683.24,1615.17 1686.9,1565.79 1690.56,1509.74 1694.22,1449.61 1697.88,1387.3 1701.53,1324.1 1705.19,1260.76 1708.85,1197.7 1712.51,1135.1 1716.17,1072.96 1719.82,1011.31 1723.48,950.222 1727.14,889.946 1730.8,831.037 1734.46,774.451 1738.11,721.632 1741.77,674.54 1745.43,635.593 1749.09,607.486 1752.75,592.904 1756.41,594.154 1760.06,612.793 1763.72,649.321 1767.38,703.025 1771.04,771.982 1774.7,853.224 1778.35,943.007 1782.01,1037.13 1785.67,1131.29 1789.33,1221.34 1792.99,1303.69 1796.64,1375.56 1800.3,1435.18 1803.96,1481.92 1807.62,1516.2 1811.28,1539.23 1814.94,1552.66 1818.59,1558.18 1822.25,1557.24 1825.91,1550.9 1829.57,1539.73 1833.23,1524.02 1836.88,1504 1840.54,1480.11 1844.2,1453.27 1847.86,1424.94 1851.52,1396.92 1855.17,1370.95 1858.83,1348.2 1862.49,1328.92 1866.15,1312.37 1869.81,1297.04 1873.47,1281.09 1877.12,1262.82 1880.78,1240.91 1884.44,1214.64 1888.1,1183.83 1891.76,1148.78 1895.41,1110.11 1899.07,1068.62 1902.73,1025.18 1906.39,980.665 1910.05,935.815 1913.7,891.266 1917.36,847.5 1921.02,804.862 1924.68,763.569 1928.34,723.735 1932,685.399 1935.65,648.549 1939.31,613.147 1942.97,579.146 1946.63,546.502 1950.29,515.185 1953.94,485.178 1957.6,456.48 1961.26,429.103 1964.92,403.08 1968.58,378.467 1972.23,355.354 1975.89,333.885 1979.55,314.263 1983.21,296.759 1986.87,281.708 1990.53,269.499 1994.18,260.547 1997.84,255.277 2001.5,254.088 2005.16,257.339 2008.82,265.324 2012.47,278.265 2016.13,296.303 2019.79,319.496 2023.45,347.824 2027.11,381.189 2030.76,419.421 2034.42,462.283 2038.08,509.464 2041.74,560.582 2045.4,615.165 2049.06,672.633 2052.71,732.264 2056.37,793.162 2060.03,854.207 2063.69,914.032 2067.35,971.015 2071,1023.32 2074.66,1069.01 2078.32,1106.25 2081.98,1133.52 2085.64,1149.92 2089.29,1155.4 2092.95,1150.87 2096.61,1138.17 2100.27,1119.78 2103.93,1098.53 2107.58,1077.05 2111.24,1057.44 2114.9,1040.91 2118.56,1027.74 2122.22,1017.27 2125.88,1008.15 2129.53,998.61 2133.19,986.807 2136.85,971.085 2140.51,950.206 2144.17,923.458 2147.82,890.67 2151.48,852.147 2155.14,808.553 2158.8,760.794 2162.46,709.899 2166.11,656.94 2169.77,602.978 2173.43,549.03 2177.09,496.055 2180.75,444.941 2184.41,396.492 2188.06,351.404 2191.72,310.237 2195.38,273.389 2199.04,241.08 2202.7,213.354 2206.35,190.099 2210.01,171.085 2213.67,156.014 2217.33,144.573 2220.99,136.492 2224.64,131.599 2228.3,129.867 2231.96,131.437 2235.62,136.627 2239.28,145.912 2242.94,159.879 2246.59,179.17 2250.25,204.41 2253.91,236.137 2257.57,274.73 2261.23,320.365 2264.88,372.965 2268.54,432.179 2272.2,497.359 2275.86,567.537 2279.52,641.4 2283.17,717.254 2286.83,792.997 2290.49,866.113 2294.15,933.725 2297.81,992.745 2301.47,1040.14 2305.12,1073.31 2308.78,1090.5 2312.44,1091.17 2316.1,1076.19 2319.76,1047.78 2323.41,1009.26 2327.07,964.574 2330.73,917.793 2334.39,872.653 2338.05,832.238 2341.7,798.818 2345.36,773.808 2349.02,757.827 2352.68,750.778 2356.34,751.944 2360,760.061 2363.65,773.386 2367.31,789.783 2370.97,806.839 2374.63,822.039 2378.29,833.013 2381.94,837.812 2385.6,835.199 2389.26,824.867 2392.92,807.537 2396.58,784.9 2400.23,759.401 2403.89,733.875 2407.55,711.126 2411.21,693.503 2414.87,682.586 2418.53,679.044 2422.18,682.68 2425.84,692.621 2429.5,707.559 2433.16,725.98 2436.82,746.324 2440.47,767.093 2444.13,786.933 2447.79,804.703 2451.45,819.535 2455.11,830.873 2458.76,838.477 2462.42,842.388 2466.08,842.861 2469.74,840.278 2473.4,835.073 2477.06,827.662 2480.71,818.402 2484.37,807.573 2488.03,795.364 2491.69,781.887 2495.35,767.186 2499,751.254 2502.66,734.047 2506.32,715.509 2509.98,695.576 2513.64,674.202 2517.29,651.364 2520.95,627.079 2524.61,601.418 2528.27,574.528 2531.93,546.66 2535.58,518.209 2539.24,489.766 2542.9,462.174 2546.56,436.592 2550.22,414.558 2553.88,398.033 2557.53,389.407 2561.19,391.45 2564.85,407.157 2568.51,439.455 2572.17,490.742 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#ac8d18; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="285.841,928.065 289.5,913.656 293.158,898.401 296.816,882.139 300.474,864.752 304.132,846.167 307.79,826.371 311.448,805.426 315.106,783.49 318.765,760.843 322.423,737.886 326.081,715.143 329.739,693.243 333.397,672.883 337.055,654.795 340.713,639.701 344.371,628.269 348.029,621.087 351.688,618.632 355.346,621.253 359.004,629.166 362.662,642.454 366.32,661.07 369.978,684.854 373.636,713.545 377.294,746.798 380.953,784.195 384.611,825.256 388.269,869.441 391.927,916.147 395.585,964.703 399.243,1014.36 402.901,1064.3 406.559,1113.59 410.218,1161.26 413.876,1206.27 417.534,1247.57 421.192,1284.12 424.85,1315 428.508,1339.38 432.166,1356.64 435.824,1366.32 439.482,1368.21 443.141,1362.34 446.799,1349.07 450.457,1329.05 454.115,1303.35 457.773,1273.4 461.431,1240.97 465.089,1208 468.747,1176.45 472.406,1148.07 476.064,1124.17 479.722,1105.49 483.38,1092.09 487.038,1083.38 490.696,1078.22 494.354,1075.03 498.012,1072.08 501.671,1067.65 505.329,1060.24 508.987,1048.75 512.645,1032.56 516.303,1011.52 519.961,985.96 523.619,956.569 527.277,924.323 530.935,890.36 534.594,855.878 538.252,822.027 541.91,789.819 545.568,760.05 549.226,733.241 552.884,709.618 556.542,689.124 560.2,671.47 563.859,656.212 567.517,642.844 571.175,630.868 574.833,619.857 578.491,609.476 582.149,599.486 585.807,589.728 589.465,580.114 593.123,570.611 596.782,561.256 600.44,552.16 604.098,543.537 607.756,535.716 611.414,529.146 615.072,524.401 618.73,522.162 622.388,523.207 626.047,528.376 629.705,538.541 633.363,554.55 637.021,577.163 640.679,606.969 644.337,644.307 647.995,689.186 651.653,741.227 655.312,799.632 658.97,863.189 662.628,930.308 666.286,999.095 669.944,1067.45 673.602,1133.19 677.26,1194.19 680.918,1248.53 684.576,1294.62 688.235,1331.25 691.893,1357.7 695.551,1373.65 699.209,1379.13 702.867,1374.51 706.525,1360.36 710.183,1337.46 713.841,1306.77 717.5,1269.47 721.158,1226.93 724.816,1180.72 728.474,1132.57 732.132,1084.27 735.79,1037.59 739.448,994.141 743.106,955.327 746.765,922.253 750.423,895.699 754.081,876.106 757.739,863.587 761.397,857.944 765.055,858.686 768.713,865.061 772.371,876.082 776.029,890.587 779.688,907.304 783.346,924.953 787.004,942.352 790.662,958.52 794.32,972.753 797.978,984.643 801.636,994.044 805.294,1000.99 808.953,1005.6 812.611,1007.96 816.269,1008.13 819.927,1006.05 823.585,1001.65 827.243,994.806 830.901,985.409 834.559,973.382 838.218,958.672 841.876,941.26 845.534,921.168 849.192,898.475 852.85,873.345 856.508,846.061 860.166,817.055 863.824,786.933 867.482,756.483 871.141,726.672 874.799,698.631 878.457,673.628 882.115,653.033 885.773,638.273 889.431,630.774 893.089,631.886 896.747,642.791 900.406,664.375 904.064,697.094 907.722,740.838 911.38,794.813 915.038,857.504 918.696,926.718 922.354,999.742 926.012,1073.58 929.67,1145.24 933.329,1211.99 936.987,1271.65 940.645,1322.68 944.303,1364.26 947.961,1396.29 951.619,1419.22 955.277,1433.95 958.935,1441.62 962.594,1443.49 966.252,1440.75 969.91,1434.49 973.568,1425.57 977.226,1414.67 980.884,1402.21 984.542,1388.47 988.2,1373.56 991.859,1357.5 995.517,1340.29 999.175,1321.97 1002.83,1302.69 1006.49,1282.72 1010.15,1262.5 1013.81,1242.63 1017.47,1223.74 1021.12,1206.43 1024.78,1191.13 1028.44,1177.99 1032.1,1166.84 1035.76,1157.19 1039.41,1148.37 1043.07,1139.62 1046.73,1130.28 1050.39,1119.87 1054.05,1108.17 1057.7,1095.18 1061.36,1081.07 1065.02,1066.1 1068.68,1050.53 1072.34,1034.59 1076,1018.42 1079.65,1002.05 1083.31,985.49 1086.97,968.683 1090.63,951.566 1094.29,934.067 1097.94,916.109 1101.6,897.602 1105.26,878.433 1108.92,858.478 1112.58,837.619 1116.23,815.785 1119.89,793.01 1123.55,769.503 1127.21,745.718 1130.87,722.409 1134.53,700.657 1138.18,681.838 1141.84,667.532 1145.5,659.368 1149.16,658.835 1152.82,667.084 1156.47,684.778 1160.13,712.008 1163.79,748.299 1167.45,792.692 1171.11,843.863 1174.76,900.258 1178.42,960.212 1182.08,1022.04 1185.74,1084.07 1189.4,1144.75 1193.06,1202.62 1196.71,1256.38 1200.37,1304.96 1204.03,1347.56 1207.69,1383.72 1211.35,1413.27 1215,1436.36 1218.66,1453.33 1222.32,1464.64 1225.98,1470.76 1229.64,1472.07 1233.29,1468.84 1236.95,1461.29 1240.61,1449.64 1244.27,1434.31 1247.93,1415.99 1251.59,1395.68 1255.24,1374.58 1258.9,1353.85 1262.56,1334.29 1266.22,1316.11 1269.88,1298.8 1273.53,1281.32 1277.19,1262.36 1280.85,1240.64 1284.51,1215.21 1288.17,1185.54 1291.82,1151.54 1295.48,1113.52 1299.14,1072.07 1302.8,1027.93 1306.46,981.931 1310.11,934.902 1313.77,887.631 1317.43,840.832 1321.09,795.137 1324.75,751.083 1328.41,709.107 1332.06,669.53 1335.72,632.541 1339.38,598.185 1343.04,566.355 1346.7,536.815 1350.35,509.244 1354.01,483.308 1357.67,458.741 1361.33,435.42 1364.99,413.41 1368.64,392.962 1372.3,374.468 1375.96,358.37 1379.62,345.075 1383.28,334.872 1386.94,327.893 1390.59,324.117 1394.25,323.39 1397.91,325.477 1401.57,330.096 1405.23,336.958 1408.88,345.788 1412.54,356.337 1416.2,368.381 1419.86,381.72 1423.52,396.161 1427.17,411.519 1430.83,427.603 1434.49,444.222 1438.15,461.189 1441.81,478.326 1445.47,495.477 1449.12,512.514 1452.78,529.341 1456.44,545.897 1460.1,562.15 1463.76,578.095 1467.41,593.741 1471.07,609.104 1474.73,624.193 1478.39,638.999 1482.05,653.485 1485.7,667.574 1489.36,681.146 1493.02,694.026 1496.68,705.99 1500.34,716.765 1504,726.041 1507.65,733.478 1511.31,738.726 1514.97,741.437 1518.63,741.28 1522.29,737.947 1525.94,731.156 1529.6,720.642 1533.26,706.149 1536.92,687.423 1540.58,664.219 1544.23,636.328 1547.89,603.617 1551.55,566.101 1555.21,523.998 1558.87,477.779 1562.53,428.18 1566.18,376.189 1569.84,323.033 1573.5,270.21 1577.16,219.574 1580.82,173.478 1584.47,134.884 1588.13,107.375 1591.79,94.9858 1595.45,101.851 1599.11,131.712 1602.76,187.358 1606.42,270.113 1610.08,379.496 1613.74,513.092 1617.4,666.593 1621.06,833.891 1624.71,1007.15 1628.37,1176.98 1632.03,1332.89 1635.69,1464.39 1639.35,1562.61 1643,1621.76 1646.66,1639.93 1650.32,1618.7 1653.98,1562.26 1657.64,1476.65 1661.29,1369.18 1664.95,1248.03 1668.61,1121.57 1672.27,997.575 1675.93,882.413 1679.58,780.562 1683.24,694.434 1686.9,624.558 1690.56,569.991 1694.22,528.839 1697.88,498.767 1701.53,477.423 1705.19,462.75 1708.85,453.183 1712.51,447.755 1716.17,446.127 1719.82,448.581 1723.48,455.97 1727.14,469.613 1730.8,491.152 1734.46,522.325 1738.11,564.666 1741.77,619.139 1745.43,685.765 1749.09,763.305 1752.75,849.12 1756.41,939.271 1760.06,1028.9 1763.72,1112.79 1767.38,1186.06 1771.04,1244.66 1774.7,1285.74 1778.35,1307.72 1782.01,1310.19 1785.67,1293.76 1789.33,1260.03 1792.99,1211.51 1796.64,1151.65 1800.3,1084.74 1803.96,1015.6 1807.62,949.141 1811.28,889.909 1814.94,841.667 1818.59,807.143 1822.25,787.928 1825.91,784.495 1829.57,796.254 1833.23,821.639 1836.88,858.219 1840.54,902.879 1844.2,952.12 1847.86,1002.46 1851.52,1050.89 1855.17,1095.13 1858.83,1133.8 1862.49,1166.2 1866.15,1192.1 1869.81,1211.46 1873.47,1224.34 1877.12,1230.91 1880.78,1231.58 1884.44,1227 1888.1,1218.06 1891.76,1205.82 1895.41,1191.35 1899.07,1175.61 1902.73,1159.35 1906.39,1143.05 1910.05,1126.95 1913.7,1111.08 1917.36,1095.26 1921.02,1079.22 1924.68,1062.64 1928.34,1045.18 1932,1026.58 1935.65,1006.65 1939.31,985.363 1942.97,962.833 1946.63,939.395 1950.29,915.594 1953.94,892.202 1957.6,870.2 1961.26,850.743 1964.92,835.095 1968.58,824.537 1972.23,820.255 1975.89,823.218 1979.55,834.064 1983.21,853.005 1986.87,879.774 1990.53,913.617 1994.18,953.333 1997.84,997.371 2001.5,1043.95 2005.16,1091.18 2008.82,1137.28 2012.47,1180.62 2016.13,1219.9 2019.79,1254.21 2023.45,1283.04 2027.11,1306.29 2030.76,1324.15 2034.42,1337.08 2038.08,1345.64 2041.74,1350.41 2045.4,1351.93 2049.06,1350.57 2052.71,1346.61 2056.37,1340.16 2060.03,1331.29 2063.69,1320.05 2067.35,1306.6 2071,1291.26 2074.66,1274.6 2078.32,1257.35 2081.98,1240.31 2085.64,1224.14 2089.29,1209.17 2092.95,1195.32 2096.61,1182.11 2100.27,1168.8 2103.93,1154.71 2107.58,1139.36 2111.24,1122.58 2114.9,1104.56 2118.56,1085.65 2122.22,1066.29 2125.88,1046.85 2129.53,1027.59 2133.19,1008.61 2136.85,989.911 2140.51,971.458 2144.17,953.197 2147.82,935.077 2151.48,917.042 2155.14,899.007 2158.8,880.839 2162.46,862.366 2166.11,843.405 2169.77,823.812 2173.43,803.562 2177.09,782.823 2180.75,762.043 2184.41,742.004 2188.06,723.842 2191.72,709.005 2195.38,699.133 2199.04,695.882 2202.7,700.698 2206.35,714.613 2210.01,738.081 2213.67,770.92 2217.33,812.342 2220.99,861.061 2224.64,915.439 2228.3,973.644 2231.96,1033.77 2235.62,1093.95 2239.28,1152.43 2242.94,1207.64 2246.59,1258.25 2250.25,1303.25 2253.91,1341.98 2257.57,1374.19 2261.23,1399.94 2264.88,1419.61 2268.54,1433.76 2272.2,1442.99 2275.86,1447.84 2279.52,1448.73 2283.17,1445.91 2286.83,1439.51 2290.49,1429.66 2294.15,1416.61 2297.81,1400.84 2301.47,1383.09 2305.12,1364.3 2308.78,1345.28 2312.44,1326.55 2316.1,1308.04 2319.76,1289.15 2323.41,1268.87 2327.07,1246.11 2330.73,1220.01 2334.39,1190.06 2338.05,1156.25 2341.7,1118.96 2345.36,1078.88 2349.02,1036.89 2352.68,993.953 2356.34,951.012 2360,908.93 2363.65,868.421 2367.31,830.002 2370.97,793.951 2374.63,760.286 2378.29,728.766 2381.94,698.929 2385.6,670.159 2389.26,641.779 2392.92,613.158 2396.58,583.816 2400.23,553.541 2403.89,522.487 2407.55,491.247 2411.21,460.848 2414.87,432.634 2418.53,408.035 2422.18,388.278 2425.84,374.127 2429.5,365.754 2433.16,362.753 2436.82,364.285 2440.47,369.286 2444.13,376.657 2447.79,385.412 2451.45,394.747 2455.11,404.058 2458.76,412.907 2462.42,420.98 2466.08,428.039 2469.74,433.89 2473.4,438.367 2477.06,441.326 2480.71,442.65 2484.37,442.263 2488.03,440.144 2491.69,436.332 2495.35,430.945 2499,424.186 2502.66,416.351 2506.32,407.847 2509.98,399.197 2513.64,391.051 2517.29,384.201 2520.95,379.575 2524.61,378.238 2528.27,381.365 2531.93,390.209 2535.58,406.044 2539.24,430.085 2542.9,463.394 2546.56,506.763 2550.22,560.583 2553.88,624.703 2557.53,698.283 2561.19,779.653 2564.85,866.208 2568.51,954.385 2572.17,1039.76 "></polyline>
<polyline clip-path="url(#clip352)" style="stroke:#00a9ad; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="285.841,732.812 289.5,718.184 293.158,705.552 296.816,695.463 300.474,688.478 304.132,685.159 307.79,686.055 311.448,691.676 315.106,702.467 318.765,718.772 322.423,740.796 326.081,768.563 329.739,801.89 333.397,840.355 337.055,883.302 340.713,929.846 344.371,978.915 348.029,1029.3 351.688,1079.71 355.346,1128.85 359.004,1175.51 362.662,1218.61 366.32,1257.25 369.978,1290.77 373.636,1318.74 377.294,1340.96 380.953,1357.41 384.611,1368.21 388.269,1373.55 391.927,1373.68 395.585,1368.83 399.243,1359.21 402.901,1345.06 406.559,1326.65 410.218,1304.39 413.876,1278.84 417.534,1250.8 421.192,1221.33 424.85,1191.7 428.508,1163.32 432.166,1137.58 435.824,1115.7 439.482,1098.54 443.141,1086.46 446.799,1079.26 450.457,1076.18 454.115,1075.99 457.773,1077.23 461.431,1078.41 465.089,1078.21 468.747,1075.72 472.406,1070.47 476.064,1062.47 479.722,1052.07 483.38,1039.86 487.038,1026.51 490.696,1012.59 494.354,998.5 498.012,984.428 501.671,970.346 505.329,956.072 508.987,941.328 512.645,925.812 516.303,909.237 519.961,891.348 523.619,871.93 527.277,850.804 530.935,827.843 534.594,803 538.252,776.364 541.91,748.215 545.568,719.082 549.226,689.762 552.884,661.31 556.542,634.968 560.2,612.062 563.859,593.874 567.517,581.515 571.175,575.829 574.833,577.329 578.491,586.187 582.149,602.252 585.807,625.106 589.465,654.144 593.123,688.642 596.782,727.838 600.44,770.973 604.098,817.33 607.756,866.234 611.414,917.052 615.072,969.165 618.73,1021.94 622.388,1074.73 626.047,1126.79 629.705,1177.35 633.363,1225.53 637.021,1270.41 640.679,1311.08 644.337,1346.61 647.995,1376.19 651.653,1399.12 655.312,1414.9 658.97,1423.19 662.628,1423.85 666.286,1416.97 669.944,1402.88 673.602,1382.23 677.26,1355.97 680.918,1325.43 684.576,1292.25 688.235,1258.26 691.893,1225.35 695.551,1195.18 699.209,1169.07 702.867,1147.78 706.525,1131.45 710.183,1119.63 713.841,1111.32 717.5,1105.18 721.158,1099.65 724.816,1093.18 728.474,1084.37 732.132,1072.13 735.79,1055.73 739.448,1034.81 743.106,1009.41 746.765,979.868 750.423,946.767 754.081,910.867 757.739,873.032 761.397,834.163 765.055,795.155 768.713,756.848 772.371,719.989 776.029,685.199 779.688,652.941 783.346,623.503 787.004,596.993 790.662,573.355 794.32,552.397 797.978,533.845 801.636,517.381 805.294,502.694 808.953,489.502 812.611,477.573 816.269,466.728 819.927,456.847 823.585,447.881 827.243,439.865 830.901,432.934 834.559,427.342 838.218,423.468 841.876,421.816 845.534,423.003 849.192,427.736 852.85,436.778 856.508,450.904 860.166,470.843 863.824,497.215 867.482,530.472 871.141,570.83 874.799,618.227 878.457,672.278 882.115,732.253 885.773,797.066 889.431,865.273 893.089,935.093 896.747,1004.44 900.406,1071 904.064,1132.34 907.722,1186.04 911.38,1229.9 915.038,1262.11 918.696,1281.39 922.354,1287.14 926.012,1279.44 929.67,1259.05 933.329,1227.39 936.987,1186.4 940.645,1138.4 944.303,1085.95 947.961,1031.66 951.619,977.988 955.277,927.085 958.935,880.705 962.594,840.145 966.252,806.251 969.91,779.453 973.568,759.836 977.226,747.209 980.884,741.163 984.542,741.129 988.2,746.407 991.859,756.188 995.517,769.576 999.175,785.598 1002.83,803.236 1006.49,821.471 1010.15,839.342 1013.81,856.012 1017.47,870.839 1021.12,883.415 1024.78,893.571 1028.44,901.338 1032.1,906.872 1035.76,910.364 1039.41,911.968 1043.07,911.751 1046.73,909.689 1050.39,905.688 1054.05,899.62 1057.7,891.363 1061.36,880.83 1065.02,867.988 1068.68,852.871 1072.34,835.585 1076,816.315 1079.65,795.332 1083.31,772.993 1086.97,749.753 1090.63,726.167 1094.29,702.892 1097.94,680.679 1101.6,660.367 1105.26,642.862 1108.92,629.125 1112.58,620.156 1116.23,616.967 1119.89,620.557 1123.55,631.861 1127.21,651.675 1130.87,680.549 1134.53,718.651 1138.18,765.627 1141.84,820.482 1145.5,881.53 1149.16,946.45 1152.82,1012.45 1156.47,1076.56 1160.13,1135.88 1163.79,1187.92 1167.45,1230.8 1171.11,1263.24 1174.76,1284.62 1178.42,1294.8 1182.08,1294.01 1185.74,1282.75 1189.4,1261.75 1193.06,1231.94 1196.71,1194.55 1200.37,1151.13 1204.03,1103.59 1207.69,1054.15 1211.35,1005.27 1215,959.458 1218.66,919.111 1222.32,886.331 1225.98,862.766 1229.64,849.494 1233.29,846.927 1236.95,854.767 1240.61,872.002 1244.27,896.969 1247.93,927.518 1251.59,961.254 1255.24,995.827 1258.9,1029.2 1262.56,1059.79 1266.22,1086.49 1269.88,1108.58 1273.53,1125.63 1277.19,1137.39 1280.85,1143.82 1284.51,1145.09 1288.17,1141.59 1291.82,1133.87 1295.48,1122.58 1299.14,1108.3 1302.8,1091.54 1306.46,1072.6 1310.11,1051.57 1313.77,1028.38 1317.43,1002.86 1321.09,974.79 1324.75,944.063 1328.41,910.768 1332.06,875.319 1335.72,838.54 1339.38,801.715 1343.04,766.568 1346.7,735.177 1350.35,709.81 1354.01,692.703 1357.67,685.817 1361.33,690.591 1364.99,707.746 1368.64,737.155 1372.3,777.829 1375.96,827.991 1379.62,885.253 1383.28,946.857 1386.94,1009.92 1390.59,1071.69 1394.25,1129.68 1397.91,1181.86 1401.57,1226.68 1405.23,1263.14 1408.88,1290.78 1412.54,1309.62 1416.2,1320.11 1419.86,1323.07 1423.52,1319.53 1427.17,1310.65 1430.83,1297.63 1434.49,1281.62 1438.15,1263.65 1441.81,1244.58 1445.47,1225.13 1449.12,1205.84 1452.78,1187.08 1456.44,1169.11 1460.1,1152.05 1463.76,1135.94 1467.41,1120.74 1471.07,1106.37 1474.73,1092.67 1478.39,1079.5 1482.05,1066.64 1485.7,1053.9 1489.36,1041.06 1493.02,1027.92 1496.68,1014.26 1500.34,999.879 1504,984.6 1507.65,968.244 1511.31,950.645 1514.97,931.645 1518.63,911.092 1522.29,888.836 1525.94,864.73 1529.6,838.642 1533.26,810.457 1536.92,780.109 1540.58,747.605 1544.23,713.08 1547.89,676.869 1551.55,639.613 1555.21,602.399 1558.87,566.92 1562.53,535.633 1566.18,511.834 1569.84,499.593 1573.5,503.437 1577.16,527.754 1580.82,575.968 1584.47,649.614 1588.13,747.585 1591.79,865.77 1595.45,997.268 1599.11,1133.22 1602.76,1264.14 1606.42,1381.41 1610.08,1478.59 1613.74,1551.95 1617.4,1600.17 1621.06,1623.37 1624.71,1622.27 1628.37,1598.03 1632.03,1553.17 1635.69,1492.85 1639.35,1425.44 1643,1361.2 1646.66,1309.38 1650.32,1275.22 1653.98,1258.49 1657.64,1254.31 1661.29,1255.3 1664.95,1254.07 1668.61,1244.99 1672.27,1225 1675.93,1193.56 1679.58,1152.17 1683.24,1103.68 1686.9,1051.61 1690.56,999.576 1694.22,950.866 1697.88,908.184 1701.53,873.556 1705.19,848.348 1708.85,833.356 1712.51,828.904 1716.17,834.926 1719.82,851 1723.48,876.339 1727.14,909.745 1730.8,949.543 1734.46,993.535 1738.11,1039.02 1741.77,1082.9 1745.43,1121.92 1749.09,1153.02 1752.75,1173.76 1756.41,1182.76 1760.06,1179.98 1763.72,1166.88 1767.38,1146.2 1771.04,1121.61 1774.7,1096.94 1778.35,1075.49 1782.01,1059.31 1785.67,1048.85 1789.33,1042.92 1792.99,1038.96 1796.64,1033.65 1800.3,1023.64 1803.96,1006.14 1807.62,979.431 1811.28,943.043 1814.94,897.677 1818.59,844.999 1822.25,787.338 1825.91,727.397 1829.57,667.999 1833.23,611.881 1836.88,561.504 1840.54,518.883 1844.2,485.43 1847.86,461.84 1851.52,448.079 1855.17,443.459 1858.83,446.808 1862.49,456.648 1866.15,471.356 1869.81,489.265 1873.47,508.748 1877.12,528.288 1880.78,546.565 1884.44,562.544 1888.1,575.537 1891.76,585.22 1895.41,591.603 1899.07,594.964 1902.73,595.76 1906.39,594.547 1910.05,591.913 1913.7,588.437 1917.36,584.667 1921.02,581.126 1924.68,578.325 1928.34,576.775 1932,577.009 1935.65,579.589 1939.31,585.105 1942.97,594.162 1946.63,607.348 1950.29,625.184 1953.94,648.064 1957.6,676.171 1961.26,709.402 1964.92,747.293 1968.58,788.976 1972.23,833.17 1975.89,878.228 1979.55,922.238 1983.21,963.157 1986.87,998.987 1990.53,1027.94 1994.18,1048.57 1997.84,1059.9 2001.5,1061.47 2005.16,1053.36 2008.82,1036.18 2012.47,1010.99 2016.13,979.262 2019.79,942.775 2023.45,903.468 2027.11,863.328 2030.76,824.255 2034.42,787.959 2038.08,755.883 2041.74,729.16 2045.4,708.599 2049.06,694.688 2052.71,687.601 2056.37,687.203 2060.03,693.05 2063.69,704.397 2067.35,720.218 2071,739.269 2074.66,760.187 2078.32,781.628 2081.98,802.411 2085.64,821.62 2089.29,838.632 2092.95,853.066 2096.61,864.686 2100.27,873.304 2103.93,878.727 2107.58,880.759 2111.24,879.226 2114.9,874.018 2118.56,865.12 2122.22,852.619 2125.88,836.719 2129.53,817.732 2133.19,796.083 2136.85,772.317 2140.51,747.094 2144.17,721.194 2147.82,695.506 2151.48,671.001 2155.14,648.711 2158.8,629.686 2162.46,614.975 2166.11,605.602 2169.77,602.549 2173.43,606.74 2177.09,619.002 2180.75,639.999 2184.41,670.123 2188.06,709.363 2191.72,757.159 2195.38,812.283 2199.04,872.808 2202.7,936.185 2206.35,999.447 2210.01,1059.51 2213.67,1113.47 2217.33,1158.94 2220.99,1194.12 2224.64,1217.93 2228.3,1229.88 2231.96,1230.03 2235.62,1218.84 2239.28,1197.1 2242.94,1165.99 2246.59,1127 2250.25,1081.98 2253.91,1033.13 2257.57,982.895 2261.23,933.818 2264.88,888.411 2268.54,848.974 2272.2,817.449 2275.86,795.318 2279.52,783.522 2283.17,782.404 2286.83,791.673 2290.49,810.389 2294.15,837.011 2297.81,869.508 2301.47,905.571 2305.12,942.869 2308.78,979.294 2312.44,1013.12 2316.1,1043.04 2319.76,1068.12 2323.41,1087.75 2327.07,1101.56 2330.73,1109.45 2334.39,1111.54 2338.05,1108.15 2341.7,1099.69 2345.36,1086.58 2349.02,1069.15 2352.68,1047.6 2356.34,1022.01 2360,992.411 2363.65,958.891 2367.31,921.714 2370.97,881.459 2374.63,839.114 2378.29,796.134 2381.94,754.431 2385.6,716.309 2389.26,684.337 2392.92,661.182 2396.58,649.403 2400.23,651.215 2403.89,668.218 2407.55,701.122 2411.21,749.487 2414.87,811.554 2418.53,884.256 2422.18,963.446 2425.84,1044.34 2429.5,1122.07 2433.16,1192.27 2436.82,1251.49 2440.47,1297.4 2444.13,1328.9 2447.79,1345.96 2451.45,1349.43 2455.11,1340.8 2458.76,1321.93 2462.42,1294.84 2466.08,1261.58 2469.74,1224.06 2473.4,1183.99 2477.06,1142.91 2480.71,1102.09 2484.37,1062.67 2488.03,1025.6 2491.69,991.73 2495.35,961.839 2499,936.635 2502.66,916.776 2506.32,902.857 2509.98,895.389 2513.64,894.754 2517.29,901.16 2520.95,914.581 2524.61,934.71 2528.27,960.918 2531.93,992.238 2535.58,1027.38 2539.24,1064.79 2542.9,1102.71 2546.56,1139.27 2550.22,1172.64 2553.88,1201.06 2557.53,1223.03 2561.19,1237.35 2564.85,1243.31 2568.51,1240.88 2572.17,1230.92 "></polyline>
</svg>
</div>
</div>
<p>最初の３成分を取り出して，３次元空間にプロットしてみる：<sup>1</sup></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/Particles/Files/lorenz96_animation.gif" class="img-fluid figure-img"></p>
<figcaption>Lorenz 96 Model</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-important no-icon callout-titled" title="ODE ソルバーの選択">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
ODE ソルバーの選択
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>CoupledODEs</code> のデフォルトのソルバーは</p>
<blockquote class="blockquote">
<p><a href="https://docs.sciml.ai/DiffEqDocs/latest/solvers/ode_solve/">Tsit5 - Tsitouras 5/4 Runge-Kutta method. (free 4th order interpolant).</a></p>
</blockquote>
<p>である <span class="citation" data-cites="Tsitouras2011">(Tsitouras, 2011)</span>．次のようにカスタマイズもできる</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">OrdinaryDiffEq</span>: Vern9 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># accessing the ODE solvers</span></span>
<span id="cb4-2">diffeq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (alg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Vern9</span>(), abstol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-9</span>, reltol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-9</span>)</span>
<span id="cb4-3">lorenz96_vern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ContinuousDynamicalSystem</span>(lorenz96_rule!, u0, p0; diffeq)</span>
<span id="cb4-4"></span>
<span id="cb4-5">Y, t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">trajectory</span>(lorenz96_vern, total_time; Ttr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>, Δt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sampling_time)</span>
<span id="cb4-6">Y[<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span>]</span></code></pre></div>
</div>
</div>
</section>
<section id="タイムスケール版" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="タイムスケール版"><span class="header-section-number">1.3</span> ２タイムスケール版</h3>
<p><span class="citation" data-cites="Lorenz1995">(Section 4 Lorenz, 1995)</span> では２タイムスケール版の Lorenz 96 モデルが導入されている： <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%0A%20%20%5Cfrac%7Bd%20x_i%7D%7Bd%20t%7D&amp;=-x_%7Bi-1%7D(x_%7Bi-2%7D-x_%7Bi+1%7D)-x_i+F-%5Cleft(%5Cfrac%7Bhc%7D%7Bb%7D%5Cright)%5Csum_%7Bj=1%7D%5E%7BJ-1%7DY_%7Bj,i%7D,%5C%5C%0A%20%20%5Cfrac%7Bd%20y_%7Bj,i%7D%7D%7Bd%20t%7D&amp;=-cbY_%7Bj+1,i%7D(Y_%7Bj+2,i%7D-Y_%7Bj-1,i%7D)-cY_%7Bj,i%7D+%5Cfrac%7Bhc%7D%7Bb%7DX_i.%0A%5Cend%7Balign*%7D"></p>
</section>
</section>
<section id="非圧縮粘性-navier-stokes-方程式" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="非圧縮粘性-navier-stokes-方程式"><span class="header-section-number">2</span> 非圧縮・粘性 Navier-Stokes 方程式</h2>
<section id="モデル定義-1" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="モデル定義-1"><span class="header-section-number">2.1</span> モデル定義</h3>
<p><img src="https://latex.codecogs.com/png.latex?M%5En"> を <img src="https://latex.codecogs.com/png.latex?n">-次元可微分多様体，<img src="https://latex.codecogs.com/png.latex?v:M%5Ctimes%5Cmathbb%7BR%7D_+%5Cto%5Cmathbb%7BR%7D%5En"> を <img src="https://latex.codecogs.com/png.latex?M"> 上のベクトル場とする．<img src="https://latex.codecogs.com/png.latex?v"> に関する非圧縮・粘性 Navier-Stokes 方程式は次のように表せる <span class="citation" data-cites="Temam1995">(Temam, 1995)</span>, <span class="citation" data-cites="Evans2010">(Evans, 2010, p. 6)</span>：</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cpartial_tv-%5Cnu%5Cmathop%7B%7D%5C!%5Cmathbin%5Cbigtriangleup%20v+v%5Ccdot%5Cnabla%20v=f-%5Cnabla%20p,%5Cqquad%5Cnu%3E0,%0A"> <img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7Bdiv%7Dv=0,%5Cquad%5Cint_M%20v_j(x,-)%5C,dx=0%5Cquad(j%5Cin%5Bn%5D),%5Cquad%20v(x,0)=:u(x).%0A"> <img src="https://latex.codecogs.com/png.latex?%5Cnu%3E0"> を <strong>粘性</strong> (viscosity) 係数，<img src="https://latex.codecogs.com/png.latex?p:M%5Ctimes%5Cmathbb%7BR%7D_+%5Cto%5Cmathbb%7BR%7D"> を <strong>圧力</strong> (pressure) という．<img src="https://latex.codecogs.com/png.latex?f"> は時間一定の外力である．<sup>2</sup></p>
</section>
<section id="数値解法" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="数値解法"><span class="header-section-number">2.2</span> 数値解法</h3>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="周期的境界条件">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
周期的境界条件
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?M%5En=:%5COmega"> を <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En"> の領域とし，周期的な境界条件 <img src="https://latex.codecogs.com/png.latex?%0Av(x+Le_i,t)=v(x,t),%5Cqquad(x,t)%5Cin%20M%5En%5Ctimes%5Cmathbb%7BR%7D_+%0A"> を考える．ただし，<img src="https://latex.codecogs.com/png.latex?e_i"> は <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En"> の標準基底ベクトルである．</p>
<p>この設定の下では数学的に理想的な取り扱いができる．物理的には例えばトーラス上の流体を考えていることに相当する．</p>
</div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?v"> を数値的に得るためには <a href="https://en.wikipedia.org/wiki/Projection_method_(fluid_dynamics)"><strong>射影法</strong></a> (projection method) <span class="citation" data-cites="Chorin1967">(Chorin, 1967)</span>, <span class="citation" data-cites="Chorin1968">(Chorin, 1968)</span> を用いる．</p>
<p>この方法では Helmholtz-Hodge の射影作用素 <img src="https://latex.codecogs.com/png.latex?P"> が用いられる．</p>
<p>これは <span id="eq-projected-navier-stokes"><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7Bd%20v%7D%7Bd%20t%7D+%5Cnu%20Av+B(v,v)=P(f),%5Cqquad%20v(0)=u%0A%5Ctag%7B1%7D"></span> という（無限次元空間 <img src="https://latex.codecogs.com/png.latex?v%5Cin%20V'"> 上の） ODE への帰着を可能にする．ただし， <img src="https://latex.codecogs.com/png.latex?%0AB(v,w):=%5Cfrac%7B1%7D%7B2%7DP(v%5Ccdot%5Cnabla%20w)+%5Cfrac%7B1%7D%7B2%7DP(w%5Ccdot%5Cnabla%20v).%0A"></p>
<p>あとは ODE (1) をソルバーで解くのである．</p>
</section>
<section id="数学的詳細" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="数学的詳細"><span class="header-section-number">2.3</span> 数学的詳細<sup>3</sup></h3>
<p><img src="https://latex.codecogs.com/png.latex?H%5Em(%5COmega)%5Csubset%20L%5E2(%5COmega)"> を <img src="https://latex.codecogs.com/png.latex?m"> 階までの導関数が全て <img src="https://latex.codecogs.com/png.latex?L%5E2(%5COmega)"> に属する関数からなる Sobolev 空間とする．</p>
<p><img src="https://latex.codecogs.com/png.latex?H_p%5Em(%5COmega)"> を <img src="https://latex.codecogs.com/png.latex?H_%5Cmathrm%7Bloc%7D%5Em(%5Cmathbb%7BR%7D%5En)"> の部分空間のうち，<img src="https://latex.codecogs.com/png.latex?%5COmega"> 上で周期的なものとすると，次の表示を持つ： <img src="https://latex.codecogs.com/png.latex?%0AH_p%5Em(%5COmega)=%5Cleft%5C%7Bu=%5Csum_%7Bk%5Cin%5Cmathbb%7BZ%7D%5En%7Dc_ke%5E%7B2i%5Cpi%20k%5Ccdot%20x/L%7D%5C,%5Cmiddle%7C%5C,%5Coverline%7Bc%7D_k=c_%7B-k%7D,%5Csum_%7Bk%5Cin%5Cmathbb%7BZ%7D%5En%7D%5Clvert%20k%5Crvert%5E%7B2m%7D%5Clvert%20c_k%5Crvert%5E2%3C%5Cinfty%5Cright%5C%7D.%0A"> <img src="https://latex.codecogs.com/png.latex?%5Cdot%7BH%7D_p%5Em(%5COmega)"> を <img src="https://latex.codecogs.com/png.latex?H_p%5Em(%5COmega)"> のうち <img src="https://latex.codecogs.com/png.latex?c_0=0"> を満たすものの部分空間とする．上の表示をもとにして，任意の <img src="https://latex.codecogs.com/png.latex?m%5Cin%5Cmathbb%7BR%7D"> について <img src="https://latex.codecogs.com/png.latex?%5Cdot%7BH%7D%5Em_p(%5COmega)"> が定まる．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AV:=%5Cleft%5C%7Bu%5Cin%20H%5E1_p(%5COmega)%5C,%5Cmiddle%7C%5C,%5Coperatorname%7Bdiv%7Du=0%5C,%5Cmathrm%7Bon%7D%5C;%5Cmathbb%7BR%7D%5En%5Cright%5C%7D,%5Cqquad%20H:=%5Cleft%5C%7Bu%5Cin%20H%5E0_p(%5COmega)%5C,%5Cmiddle%7C%5C,%5Coperatorname%7Bdiv%7Du=0%5C,%5Cmathrm%7Bon%7D%5C;%5Cmathbb%7BR%7D%5En%5Cright%5C%7D%0A"> について <img src="https://latex.codecogs.com/png.latex?V%5Csubset%20H%5Csubset%20V%5E*"> が成り立つ．</p>
<p>以上の設定では，<img src="https://latex.codecogs.com/png.latex?A:V%5Coverset%7B%5Csim%7D%7B%5Cto%7DV%5E*"> は同型，<img src="https://latex.codecogs.com/png.latex?B:V%5Ctimes%20V%5Chookrightarrow%20V%5E*"> は連続な双線型作用素になる．</p>
<p><img src="https://latex.codecogs.com/png.latex?P"> は Helmholtz 射影と呼ばれ，<img src="https://latex.codecogs.com/png.latex?V%5E*"> 上への射影を与える．<sup>4</sup></p>
</section>
<section id="galerkin-近似" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="galerkin-近似"><span class="header-section-number">2.4</span> Galerkin 近似</h3>
<p><img src="https://latex.codecogs.com/png.latex?A"> の固有関数を <img src="https://latex.codecogs.com/png.latex?(w_i)"> とし，最初の <img src="https://latex.codecogs.com/png.latex?m"> 個の固有関数が定める空間上への射影を <img src="https://latex.codecogs.com/png.latex?P_m"> とし， <img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7Bd%20v_m%7D%7Bd%20t%7D+%5Cnu%20Av_m+P_mB(v_m)=P_mf,%5Cqquad%20t%3E0,v_m(0)=P_mv_0.%0A"> を解く．この <img src="https://latex.codecogs.com/png.latex?v_m"> を <img src="https://latex.codecogs.com/png.latex?v"> の <strong>Galerkin 近似</strong> という <span class="citation" data-cites="Temam1995">(Temam, 1995, p. 109)</span>．</p>
<p>こうして得る有限次元空間上の ODE はまだ <a href="https://ja.wikipedia.org/wiki/硬い方程式"><strong>硬い方程式</strong></a> であり，例えば指数的な有限差分を取る <span class="citation" data-cites="Cox-Matthews2002">(Cox and Matthews, 2002)</span> などの処置が必要である．</p>
<p><span class="citation" data-cites="Kantas+2014">(Section 5 Kantas et al., 2014)</span> はデータ同化の文脈でこれを解いている．</p>
</section>
<section id="シミュレーション" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="シミュレーション"><span class="header-section-number">2.5</span> シミュレーション</h3>
<p><code>IncompressibleNavierStokes.jl</code> (<a href="https://github.com/agdestein/IncompressibleNavierStokes.jl">GitHub</a> / <a href="https://agdestein.github.io/IncompressibleNavierStokes.jl/dev/">Docs</a>) パッケージを用いて，非圧縮 Navier-Stokes 方程式を解くことができる．</p>
<p><a href="https://en.wikipedia.org/wiki/Rayleigh%E2%80%93B%C3%A9nard_convection">Rayleigh-Bénard 対流</a> 問題を実行するサンプルコードが提示されている．</p>
<p>Rayleigh-Bénard 対流は二次元空間を下から加熱した際の流体の対流で，<a href="https://ja.wikipedia.org/wiki/%E3%83%99%E3%83%8A%E3%83%BC%E3%83%AB%E3%83%BB%E3%82%BB%E3%83%AB">Bénard 細胞</a> と呼ばれる散逸構造が現れるはずである．</p>
<div id="31ee622a" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">GLMakie</span></span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">IncompressibleNavierStokes</span></span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Setup</span></span>
<span id="cb5-5">setup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Setup</span>(</span>
<span id="cb5-6">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tanh_grid</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tanh_grid</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>)),</span>
<span id="cb5-7">    boundary_conditions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DirichletBC</span>(), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DirichletBC</span>()), (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DirichletBC</span>(), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DirichletBC</span>())),</span>
<span id="cb5-8">    temperature <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">temperature_equation</span>(;</span>
<span id="cb5-9">        Pr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.71</span>,</span>
<span id="cb5-10">        Ra <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e7</span>,</span>
<span id="cb5-11">        Ge <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,</span>
<span id="cb5-12">        boundary_conditions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb5-13">            (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SymmetricBC</span>(), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SymmetricBC</span>()),</span>
<span id="cb5-14">            (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DirichletBC</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DirichletBC</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)),</span>
<span id="cb5-15">        ),</span>
<span id="cb5-16">    ),</span>
<span id="cb5-17">)</span>
<span id="cb5-18"></span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solve equation</span></span>
<span id="cb5-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve_unsteady</span>(;</span>
<span id="cb5-21">    setup,</span>
<span id="cb5-22">    ustart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">velocityfield</span>(setup, (dim, x, y) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero</span>(x)),</span>
<span id="cb5-23">    tempstart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">temperaturefield</span>(setup, (x, y) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sinpi</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>),</span>
<span id="cb5-24">    tlims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">30.0</span>),</span>
<span id="cb5-25">    Δt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>,</span>
<span id="cb5-26">    processors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (;</span>
<span id="cb5-27">        anim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">animator</span>(;</span>
<span id="cb5-28">            setup,</span>
<span id="cb5-29">            path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature.mp4"</span>,</span>
<span id="cb5-30">            fieldname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>temperature,</span>
<span id="cb5-31">            colorrange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>),</span>
<span id="cb5-32">            size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">900</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>),</span>
<span id="cb5-33">            colormap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>seaborn_icefire_gradient,</span>
<span id="cb5-34">            nupdate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb5-35">        ),</span>
<span id="cb5-36">    ),</span>
<span id="cb5-37">)</span></code></pre></div>
</div>
<p><img src="https://162348.github.io/posts/2024/Particles/Files/temperature.gif" class="img-fluid"></p>
<p><a href="https://agdestein.github.io/IncompressibleNavierStokes.jl/dev/manual/solver#Solvers-2"><code>solve_unsteady()</code></a> 関数は <code>method = RKMethods.RK44(; T = eltype(ustart[1])),</code> がデフォルトである．</p>
<p><code>RK44</code> は 4 次の Runge-Kutta 法である．４次の Runge-Kutta 法は圧力に懸念があることを除いて，速度場の解法としては悪くない性能を示すようである <span class="citation" data-cites="Sanderse-Koren2012">(Sanderse and Koren, 2012)</span>．</p>
<p>例えば非一様な風が障害物に当たる場合のシミュレーション例では，圧力も２次まで計算する <code>RK44P2()</code> を用いている．</p>
<div id="25a733bc" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">IncompressibleNavierStokes</span></span>
<span id="cb6-2"></span>
<span id="cb6-3">n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span></span>
<span id="cb6-4">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LinRange</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LinRange</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plotgrid</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span>; figure <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (; size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)))</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inflow</span>(dim, x, y, t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sinpi</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sinpi</span>(t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb6-8">boundary_conditions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DirichletBC</span>(inflow), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PressureBC</span>()), (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PressureBC</span>(), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">PressureBC</span>()))</span>
<span id="cb6-9"></span>
<span id="cb6-10">xc, yc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Disk center</span></span>
<span id="cb6-11">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Disk diameter</span></span>
<span id="cb6-12">δ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.11</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Disk thickness</span></span>
<span id="cb6-13">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Thrust coefficient</span></span>
<span id="cb6-14">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> δ)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normalize</span></span>
<span id="cb6-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inside</span>(x, y) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xc) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">≤</span> δ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yc) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">≤</span> D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb6-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bodyforce</span>(dim, x, y, t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inside</span>(x, y)</span>
<span id="cb6-17"></span>
<span id="cb6-18">setup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Setup</span>(; x, Re <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>, boundary_conditions, bodyforce, issteadybodyforce <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>);</span>
<span id="cb6-19"></span>
<span id="cb6-20">ustart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">velocityfield</span>(setup, (dim, x, y) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inflow</span>(dim, x, y, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>))</span>
<span id="cb6-21"></span>
<span id="cb6-22">state, outputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve_unsteady</span>(;</span>
<span id="cb6-23">    setup,</span>
<span id="cb6-24">    ustart,</span>
<span id="cb6-25">    tlims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.0</span>),</span>
<span id="cb6-26">    method <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RKMethods.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RK44P2</span>(),</span>
<span id="cb6-27">    Δt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb6-28">    processors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb6-29">        anim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">animator</span>(;</span>
<span id="cb6-30">            setup,</span>
<span id="cb6-31">            path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"navier_stokes_animation.mp4"</span>,</span>
<span id="cb6-32">            fieldname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>vorticity,</span>
<span id="cb6-33">            colorrange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),</span>
<span id="cb6-34">            size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>),</span>
<span id="cb6-35">            colormap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>bam,</span>
<span id="cb6-36">            nupdate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb6-37">        ),</span>
<span id="cb6-38">        log <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">timelogger</span>(; nupdate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>),</span>
<span id="cb6-39">    ),</span>
<span id="cb6-40">);</span></code></pre></div>
</div>
<p><img src="https://162348.github.io/posts/2024/Particles/Files/navier_stokes_animation.gif" class="img-fluid"></p>
<p>blade の両端で過度が生じていることがわかる．</p>
</section>
</section>



<div id="quarto-appendix" class="default"><section id="文献紹介" class="level2 appendix" data-number="3"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">3</span> 文献紹介</h2><div class="quarto-appendix-contents">

<p><span class="citation" data-cites="vanKekem2018">(van/ Kekem, 2018)</span>, <span class="citation" data-cites="Kerin-Engler2022">(Kerin and Engler, 2022)</span> が概観に良い．<span class="citation" data-cites="Balwada+2023">(Balwada and Zanna, 2023)</span> は２タイムスケール版について詳しい．</p>
<p>Navier-Stokes 方程式のデータ同化に関しては <span class="citation" data-cites="Kantas+2014">(Kantas et al., 2014)</span> などで考えられている．</p>




</div></section><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Balwada+2023" class="csl-entry">
Balwada, A., D., and Zanna, L. (2023). <em><a href="https://m2lines.github.io/L96_demo/intro.html"><span class="nocase">Learning Machine Learning with Lorenz-96</span></a></em>. Authorea Preprints.
</div>
<div id="ref-Chorin1967" class="csl-entry">
Chorin, A. J. (1967). <a href="https://projecteuclid.org/journals/bulletin-of-the-american-mathematical-society-new-series/volume-73/issue-6/The-numerical-solution-of-the-Navier-Stokes-equations-for-an/bams/1183529112.full"><span class="nocase">The numerical solution of the Navier-Stokes equations for an incompressible fluid</span></a>. <em>Bulletin of the American Mathematical Society</em>, <em>73</em>(6), 928–931.
</div>
<div id="ref-Chorin1968" class="csl-entry">
Chorin, A. J. (1968). <a href="http://www.jstor.org/stable/2004575">Numerical solution of the navier-stokes equations</a>. <em>Mathematics of Computation</em>, <em>22</em>(104), 745–762.
</div>
<div id="ref-Cox-Matthews2002" class="csl-entry">
Cox, S. M., and Matthews, P. C. (2002). <a href="https://doi.org/10.1006/jcph.2002.6995">Exponential time differencing for stiff systems</a>. <em>Journal of Computational Physics</em>, <em>176</em>(2), 430–455.
</div>
<div id="ref-Evans2010" class="csl-entry">
Evans, L. C. (2010). <em><a href="https://bookstore.ams.org/gsm-19-r">Partial differential equations</a></em>,Vol. 19. American Mathematical Society.
</div>
<div id="ref-Milan2021" class="csl-entry">
K, M. (2021, July). <a href="https://doi.org/10.5281/zenodo.5121430">Milankl/Lorenz96.jl: v0.3.0</a> (Version v0.3.0). Zenodo.
</div>
<div id="ref-Kantas+2014" class="csl-entry">
Kantas, N., Beskos, A., and Jasra, A. (2014). <a href="https://doi.org/10.1137/130930364">Sequential monte carlo methods for high-dimensional inverse problems: A case study for the navier–stokes equations</a>. <em>SIAM/ASA Journal on Uncertainty Quantification</em>, <em>2</em>(1), 464–489.
</div>
<div id="ref-Kerin-Engler2022" class="csl-entry">
Kerin, J., and Engler, H. (2022). <a href="https://doi.org/10.3934/dcdsb.2021064">On the lorenz ’96 model and some generalizations</a>. <em>Discrete and Continuous Dynamical Systems - B</em>.
</div>
<div id="ref-Lorenz1963" class="csl-entry">
Lorenz, E. N. (1963). <a href="https://doi.org/10.1175/1520-0469(1963)020<0130:DNF>2.0.CO;2">Deterministic nonperiodic flow</a>. <em>Journal of Atmospheric Sciences</em>, <em>20</em>(2), 130–141.
</div>
<div id="ref-Lorenz1995" class="csl-entry">
Lorenz, E. N. (1995). <a href="https://www.ecmwf.int/en/elibrary/75462-predictability-problem-partly-solved">Predictability: A problem partly solved</a>. In <em>Seminar on predictability, 4-8 september 1995</em>. ECMWF.
</div>
<div id="ref-Sanderse-Koren2012" class="csl-entry">
Sanderse, B., and Koren, B. (2012). <a href="https://doi.org/10.1016/j.jcp.2011.11.028">Accuracy analysis of explicit runge–kutta methods applied to the incompressible navier–stokes equations</a>. <em>Journal of Computational Physics</em>, <em>231</em>(8), 3041–3063.
</div>
<div id="ref-Temam1995" class="csl-entry">
Temam, R. M. (1995). <em><a href="https://doi.org/10.1137/1.9781611970050">Navier–stokes equations and nonlinear functional analysis</a></em>. Society for Industrial; Applied Mathematics.
</div>
<div id="ref-Tsai2018" class="csl-entry">
Tsai, T.-P. (2018). <em><a href="https://doi.org/10.1090/gsm/192">Lectures on navier-stokes equations</a></em>,Vol. 192. American Mathematical Society.
</div>
<div id="ref-Tsitouras2011" class="csl-entry">
Tsitouras, Ch. (2011). <a href="https://doi.org/10.1016/j.camwa.2011.06.002">Runge–kutta pairs of order 5(4) satisfying only the first column simplifying assumption</a>. <em>Computers &amp; Mathematics with Applications</em>, <em>62</em>(2), 770–775.
</div>
<div id="ref-vanKekem2018" class="csl-entry">
van/ Kekem, D. L. (2018). <em>Dynamics of the lorenz-96 model: Bifurcations, symmetries and waves</em> (PhD thesis). University of Groningen. Retrieved from <a href="https://research.rug.nl/en/publications/dynamics-of-the-lorenz-96-model-bifurcations-symmetries-and-waves">https://research.rug.nl/en/publications/dynamics-of-the-lorenz-96-model-bifurcations-symmetries-and-waves</a>
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>コードは<a href="Files/Lorenz96.jl">こちら</a>を参照．↩︎</p></li>
<li id="fn2"><p>上述の方程式は，係数を正規化した場合とも，正規化した関数に関する方程式とも解釈できる．後者の解釈では，<img src="https://latex.codecogs.com/png.latex?%5Cnu%5E%7B-1%7D"> は Reynolds 数に対応する．↩︎</p></li>
<li id="fn3"><p>本小節は <span class="citation" data-cites="Temam1995">(Section 2 Temam, 1995)</span> を参考にしている．↩︎</p></li>
<li id="fn4"><p><span class="citation" data-cites="Tsai2018">(Tsai, 2018, p. 16)</span> も参照．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Nature</category>
  <category>Julia</category>
  <guid>https://162348.github.io/posts/2024/Particles/Lorenz95.html</guid>
  <pubDate>Sat, 05 Oct 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/Particles/Files/navier_stokes_animation.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>理想点解析のハンズオン</title>
  <dc:creator>司馬博文 </dc:creator>
  <link>https://162348.github.io/posts/2024/TransDimensionalModels/IdealPoint1.html</link>
  <description><![CDATA[ 





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="関連記事" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="関連記事">関連記事</h2>
<div id="listing-lst-embedding" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1721088000000" data-listing-file-modified-sort="1754014117272" data-listing-date-modified-sort="1727827200000" data-listing-reading-time-sort="5" data-listing-word-count-sort="829">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/IdeologyPosition.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
理想点解析・多次元展開法・項目応答理論
</h5>
<div class="card-subtitle listing-subtitle">
空間モデルの特定を目指して
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-07-16
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ0NvbXB1dGF0aW9u" data-listing-date-sort="1732233600000" data-listing-file-modified-sort="1754014117372" data-listing-date-modified-sort="1734048000000" data-listing-reading-time-sort="1" data-listing-word-count-sort="186">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-embedding:posts/2024/TransDimensionalModels/IdealPoint2.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズ理想点解析
</h5>
<div class="card-subtitle listing-subtitle">
PDMP サンプラーによる変数選択と共に
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

<div class="listing-category" onclick="window.quartoListingCategory('TUNNQw=='); return false;">MCMC</div>

<div class="listing-category" onclick="window.quartoListingCategory('Q29tcHV0YXRpb24='); return false;">Computation</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-11-22
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ0NvbXB1dGF0aW9u" data-listing-date-sort="1734220800000" data-listing-file-modified-sort="1754014117372" data-listing-date-modified-sort="1734220800000" data-listing-reading-time-sort="1" data-listing-word-count-sort="76">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint3.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-embedding:posts/2024/TransDimensionalModels/IdealPoint3.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
階層ベイズ理想点解析
</h5>
<div class="card-subtitle listing-subtitle">
PDMP サンプラーによる特異項目機能を取り込んだ大規模ベイズ推定
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

<div class="listing-category" onclick="window.quartoListingCategory('TUNNQw=='); return false;">MCMC</div>

<div class="listing-category" onclick="window.quartoListingCategory('Q29tcHV0YXRpb24='); return false;">Computation</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-15
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>本稿では実際に理想点モデルの推定を，<a href="http://mqscores.wustl.edu/replication.php">Martin-Quinn</a> により公開されている連邦最高裁判所の 1937 年から 2022 年までのデータを（<code>MCMCpack</code> パッケージを通じて）用いて行う．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(MCMCpack)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(Rehnquist)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MCMCpackに含まれる U.S. Supreme Court（連邦最高裁）のデータ</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(Rehnquist))</span></code></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Rehnquist</th>
<th style="text-align: right;">Stevens</th>
<th style="text-align: right;">O.Connor</th>
<th style="text-align: right;">Scalia</th>
<th style="text-align: right;">Kennedy</th>
<th style="text-align: right;">Souter</th>
<th style="text-align: right;">Thomas</th>
<th style="text-align: right;">Ginsburg</th>
<th style="text-align: right;">Breyer</th>
<th style="text-align: right;">term</th>
<th style="text-align: right;">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>このデータは保守的な判断をする場合が <img src="https://latex.codecogs.com/png.latex?y_i=1">，リベラルな判断をする場合が <img src="https://latex.codecogs.com/png.latex?y_i=0"> の２値データとなっている．</p>
</section>
<section id="理想点モデルとは何か" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="理想点モデルとは何か"><span class="header-section-number">1</span> 理想点モデルとは何か？</h2>
<section id="mcmcpack-パッケージ" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="mcmcpack-パッケージ"><span class="header-section-number">1.1</span> <code>MCMCpack</code> パッケージ</h3>
<p>はじめに，理想点モデルではどのようなことができるかをみるために，<code>MCMCpack</code> パッケージを通じて理想点推定を簡単に実行する方法を見る．</p>
<p>理想点モデルでは識別性が一つの論点になる（第 2.5 節）が，ここでは簡単に，Stevens 判事と Thomas 判事の位置を固定する方法を用いてみよう．</p>
<p><code>MCMCpack</code> パッケージでは，時系列理想点モデルの推定に <a href="https://github.com/cran/MCMCpack/blob/master/man/MCMCdynamicIRT1d.Rd"><code>MCMCdynamicIRT1d()</code></a> 関数が用意されている．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 初期値の設定</span></span>
<span id="cb2-2">theta.start <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 9人の裁判官の初期値</span></span>
<span id="cb2-3">theta.start[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stevens裁判官の初期値</span></span>
<span id="cb2-4">theta.start[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Thomas裁判官の初期値</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MCMCの実行</span></span>
<span id="cb2-7">out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MCMCdynamicIRT1d</span>(</span>
<span id="cb2-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(Rehnquist[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>]),           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データ行列（転置して裁判官×案件の形に）</span></span>
<span id="cb2-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">item.time.map=</span>Rehnquist<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 各案件の時期情報</span></span>
<span id="cb2-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">theta.start=</span>theta.start,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 初期値</span></span>
<span id="cb2-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mcmc=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>,                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MCMCの反復回数</span></span>
<span id="cb2-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">burnin=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>,                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># バーンイン期間</span></span>
<span id="cb2-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">thin=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,                       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 間引き数</span></span>
<span id="cb2-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>,                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 進捗表示間隔</span></span>
<span id="cb2-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tau2.start=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>),      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># τ²の初期値</span></span>
<span id="cb2-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">e0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">E0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># θの事前分布パラメータ</span></span>
<span id="cb2-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># αの事前分布パラメータ</span></span>
<span id="cb2-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">B0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># βの事前分布パラメータ</span></span>
<span id="cb2-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c0=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d0=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># τ²の事前分布パラメータ</span></span>
<span id="cb2-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">store.item=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># アイテムパラメータを保存しない</span></span>
<span id="cb2-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">theta.constraints=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Stevens=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Thomas=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 識別制約</span></span>
<span id="cb2-22">)</span>
<span id="cb2-23"></span>
<span id="cb2-24">theta_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"theta"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(out), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-25">theta_mcmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> out[, theta_cols]</span>
<span id="cb2-26"></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># library(coda)</span></span>
<span id="cb2-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># summary(theta_mcmc)  # codaのsummary関数で要約</span></span>
<span id="cb2-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(theta_mcmc)</span></code></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/plot.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</section>
<section id="理想点の推定" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="理想点の推定"><span class="header-section-number">1.2</span> 理想点の推定</h3>
<p>出力は各最高裁判事の理想点の事後分布である．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">theta_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(theta_mcmc)</span>
<span id="cb3-2">pattern <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t11"</span></span>
<span id="cb3-3">col_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(theta_mcmc)</span>
<span id="cb3-4">selected_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span>(pattern, col_names)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 正規表現にマッチする列のインデックスを取得</span></span>
<span id="cb3-5">selected_theta_mcmc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> theta_mcmc[, selected_cols]</span>
<span id="cb3-6"></span>
<span id="cb3-7">quantiles_2_5 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(selected_theta_mcmc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>))</span>
<span id="cb3-8">quantiles_97_5 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(selected_theta_mcmc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(x, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>))</span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb3-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legislator =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(Rehnquist)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>],</span>
<span id="cb3-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(theta_means[selected_cols]),</span>
<span id="cb3-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(quantiles_2_5),</span>
<span id="cb3-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(quantiles_97_5)</span>
<span id="cb3-15">), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> legislator)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimated Ideal Points (11th term)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ideal Point"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Legislator"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/IdealPoint1_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="時系列化" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="時系列化"><span class="header-section-number">1.3</span> 時系列化</h3>
<p><span class="citation" data-cites="Martin-Quinn2002">(Martin and Quinn, 2002)</span> ではこの理想点の時系列的な変化を調べた．</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">time_points <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(Rehnquist<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time)</span>
<span id="cb4-2">n_subjects <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 裁判官の数</span></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 各裁判官の軌跡をプロット</span></span>
<span id="cb4-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(time_points, theta_means[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_points)], </span>
<span id="cb4-6">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(theta_means),</span>
<span id="cb4-7">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ideal Point"</span>,</span>
<span id="cb4-8">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimated Ideal Points Over Time"</span>)</span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 各裁判官を異なる色で追加</span></span>
<span id="cb4-11">colors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rainbow</span>(n_subjects)</span>
<span id="cb4-12">colors[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span></span>
<span id="cb4-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)) {</span>
<span id="cb4-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(time_points, </span>
<span id="cb4-15">          theta_means[((i<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_points)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_points))],</span>
<span id="cb4-16">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>colors[i],</span>
<span id="cb4-17">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb4-18">}</span>
<span id="cb4-19"></span>
<span id="cb4-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 凡例を追加</span></span>
<span id="cb4-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>, </span>
<span id="cb4-22">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(Rehnquist)[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)]),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 裁判官の名前</span></span>
<span id="cb4-23">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>colors[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)], </span>
<span id="cb4-24">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/plot3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>たしかに <a href="https://en.wikipedia.org/wiki/William_Rehnquist">William Rehnquist</a> は共和党，<a href="https://en.wikipedia.org/wiki/Ruth_Bader_Ginsburg">Ruth Bader Ginsburg</a> と <a href="https://en.wikipedia.org/wiki/Stephen_Breyer">Stephen Breyer</a> は民主党である．</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/plot2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p><img src="https://latex.codecogs.com/png.latex?0"> の上に位置している <a href="https://ja.wikipedia.org/wiki/アンソニー・ケネディ">Anthony Kennedy</a> や <a href="https://en.wikipedia.org/wiki/Sandra_Day_O%27Connor">Sandra Day O’Connor</a> はほとんど中道的だが，やや保守党寄りである． <a href="https://en.wikipedia.org/wiki/Antonin_Scalia">Antonin Scalia</a> は特に保守的な立場であることが知られている．</p>
<p><img src="https://latex.codecogs.com/png.latex?0"> よりも下に位置するもう一人は <a href="https://en.wikipedia.org/wiki/David_Souter">David Souter</a> であるが，彼はもともと保守系と目されていたが，後年リベラルな傾向を示したとされる．<sup>1</sup></p>
</section>
</section>
<section id="母数ロジットモデルの推定" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="母数ロジットモデルの推定"><span class="header-section-number">2</span> ２母数ロジットモデルの推定</h2>
<section id="はじめに" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">2.1</span> はじめに</h3>
<p><code>MCMCpack</code> パッケージで理想点推定の出力がつかめたいま，より詳しくモデルを見ていく．</p>
<p>本節では <code>rstan</code> パッケージを用いて，項目反応モデルとして具体的な手順を踏んで推定してみる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb5-2">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Rehnquist <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを長形式に変換</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(term, time), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ケース ID を追加</span></span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case =</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%/%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
</section>
<section id="母数モデルbrms-パッケージ" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="母数モデルbrms-パッケージ"><span class="header-section-number">2.2</span> １母数モデル（<code>brms</code> パッケージ）</h3>
<p>まずは最も簡単な項目反応モデルとして，<img src="https://latex.codecogs.com/png.latex?g"> を logit リンクとして， <img src="https://latex.codecogs.com/png.latex?%0Ag(%5Coperatorname%7BP%7D%5BY_%7Bij%7D=1%5D)=%5Calpha_0+%5Calpha_j-x_i%0A"> というモデルを推定することを考えよう．</p>
<p><code>brms</code> パッケージを用いれば，他の R パッケージと同様のインターフェイスで推定を行うことができる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(brms)</span>
<span id="cb6-2">formula <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bf</span>(</span>
<span id="cb6-3">  y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> case) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> name)</span>
<span id="cb6-4">)</span>
<span id="cb6-5">fit_1PL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(</span>
<span id="cb6-6">  formula,</span>
<span id="cb6-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df,</span>
<span id="cb6-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brmsfamily</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bernoulli"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">link =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit"</span>),</span>
<span id="cb6-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb6-10">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit_1PL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: bernoulli 
  Links: mu = logit 
Formula: y ~ 1 + (1 | case) + (1 | name) 
   Data: df (Number of observations: 4343) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~case (Number of levels: 485) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.05      0.06     0.93     1.18 1.00     2016     2773

~name (Number of levels: 9) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.62      0.47     0.99     2.75 1.01      875     1534

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    -0.11      0.54    -1.15     1.00 1.00      652     1263

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>簡単なモデルであるが切片項の ESS が低く，すでに暗雲が立ち込めている．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit_1PL)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/IdealPoint1_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>ここには変動係数（我々の欲しい潜在変数）はパラメータとみなされておらず，推定値が表示されないので次のようにしてプロットする必要がある：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">ranef_legislator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ranef</span>(fit_1PL)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>name</span>
<span id="cb10-2">posterior_means <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_legislator[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Intercept"</span>]</span>
<span id="cb10-3">lower_bounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_legislator[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Intercept"</span>]</span>
<span id="cb10-4">upper_bounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ranef_legislator[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Intercept"</span>]</span>
<span id="cb10-5">plot_legislator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb10-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legislator =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(ranef_legislator),</span>
<span id="cb10-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> posterior_means,</span>
<span id="cb10-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> lower_bounds,</span>
<span id="cb10-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> upper_bounds</span>
<span id="cb10-10">)</span>
<span id="cb10-11">p_1PL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_legislator, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> legislator)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1PL Model"</span>,</span>
<span id="cb10-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Estimate"</span>,</span>
<span id="cb10-17">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Legislator"</span>)</span>
<span id="cb10-18">p_1PL</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/IdealPoint1_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Thomas や Scalia，そして Stevens が極端であることはとらえているが，Stevens や Ginsburg らリベラルな判事は左側に来て欲しいのであった．</p>
<p>誘導が成功しておらず，片方の峯からサンプリングしてしまっている．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior_summary</span>(fit_1PL)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior     class      coef group resp dpar nlpar lb ub
 student_t(3, 0, 2.5) Intercept                                      
 student_t(3, 0, 2.5)        sd                                  0   
 student_t(3, 0, 2.5)        sd            case                  0   
 student_t(3, 0, 2.5)        sd Intercept  case                  0   
 student_t(3, 0, 2.5)        sd            name                  0   
 student_t(3, 0, 2.5)        sd Intercept  name                  0   
       source
      default
      default
 (vectorized)
 (vectorized)
 (vectorized)
 (vectorized)</code></pre>
</div>
</div>
</section>
<section id="母数モデルrstan-パッケージ" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="母数モデルrstan-パッケージ"><span class="header-section-number">2.3</span> １母数モデル（<code>rstan</code> パッケージ）</h3>
<p><code>brms</code> パッケージ内で生成される Stan コードを参考にして，自分で Stan コードを書いて推定することもできる．</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="Stan コードの出力">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Stan コードの出力
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stancode</span>(fit_1PL)</span></code></pre></div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// generated with brms 2.21.0</span></span>
<span id="cb14-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">functions</span> {</span>
<span id="cb14-3">}</span>
<span id="cb14-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">data</span> {</span>
<span id="cb14-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// total number of observations</span></span>
<span id="cb14-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> Y;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// response variable</span></span>
<span id="cb14-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// data for group-level effects of ID 1</span></span>
<span id="cb14-8">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of grouping levels</span></span>
<span id="cb14-9">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; M_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of coefficients per level</span></span>
<span id="cb14-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; J_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// grouping indicator per observation</span></span>
<span id="cb14-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level predictor values</span></span>
<span id="cb14-12">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] Z_1_1;</span>
<span id="cb14-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// data for group-level effects of ID 2</span></span>
<span id="cb14-14">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of grouping levels</span></span>
<span id="cb14-15">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; M_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of coefficients per level</span></span>
<span id="cb14-16">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; J_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// grouping indicator per observation</span></span>
<span id="cb14-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level predictor values</span></span>
<span id="cb14-18">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] Z_2_1;</span>
<span id="cb14-19">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> prior_only;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// should the likelihood be ignored?</span></span>
<span id="cb14-20">}</span>
<span id="cb14-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">transformed data</span> {</span>
<span id="cb14-22">}</span>
<span id="cb14-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">parameters</span> {</span>
<span id="cb14-24">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> Intercept;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// temporary intercept for centered predictors</span></span>
<span id="cb14-25">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt;[M_1] sd_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level standard deviations</span></span>
<span id="cb14-26">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[M_1] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_1] z_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// standardized group-level effects</span></span>
<span id="cb14-27">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt;[M_2] sd_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level standard deviations</span></span>
<span id="cb14-28">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[M_2] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_2] z_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// standardized group-level effects</span></span>
<span id="cb14-29">}</span>
<span id="cb14-30"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">transformed parameters</span> {</span>
<span id="cb14-31">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_1] r_1_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// actual group-level effects</span></span>
<span id="cb14-32">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_2] r_2_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// actual group-level effects</span></span>
<span id="cb14-33">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> lprior = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// prior contributions to the log posterior</span></span>
<span id="cb14-34">  r_1_1 = (sd_1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] * (z_1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]));</span>
<span id="cb14-35">  r_2_1 = (sd_2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] * (z_2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]));</span>
<span id="cb14-36">  lprior += student_t_lpdf(Intercept | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb14-37">  lprior += student_t_lpdf(sd_1 | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb14-38">    - <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> * student_t_lccdf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb14-39">  lprior += student_t_lpdf(sd_2 | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb14-40">    - <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> * student_t_lccdf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb14-41">}</span>
<span id="cb14-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">model</span> {</span>
<span id="cb14-43">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// likelihood including constants</span></span>
<span id="cb14-44">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (!prior_only) {</span>
<span id="cb14-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// initialize linear predictor term</span></span>
<span id="cb14-46">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] mu = rep_vector(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, N);</span>
<span id="cb14-47">    mu += Intercept;</span>
<span id="cb14-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (n <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:N) {</span>
<span id="cb14-49">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// add more terms to the linear predictor</span></span>
<span id="cb14-50">      mu[n] += r_1_1[J_1[n]] * Z_1_1[n] + r_2_1[J_2[n]] * Z_2_1[n];</span>
<span id="cb14-51">    }</span>
<span id="cb14-52">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> bernoulli_logit_lpmf(Y | mu);</span>
<span id="cb14-53">  }</span>
<span id="cb14-54">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// priors including constants</span></span>
<span id="cb14-55">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> lprior;</span>
<span id="cb14-56">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> std_normal_lpdf(z_1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb14-57">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> std_normal_lpdf(z_2[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb14-58">}</span>
<span id="cb14-59"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">generated quantities</span> {</span>
<span id="cb14-60">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// actual population-level intercept</span></span>
<span id="cb14-61">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> b_Intercept = Intercept;</span>
<span id="cb14-62">}</span></code></pre></div>
</div>
</div>
</div>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb15-2">stan_code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb15-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb15-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; n;  // data size: n = N * J - #(NA responses)</span></span>
<span id="cb15-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; N;  // number of judges</span></span>
<span id="cb15-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; J;  // number of cases</span></span>
<span id="cb15-7"></span>
<span id="cb15-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[n] int&lt;lower=0, upper=1&gt; Y;  // response variable</span></span>
<span id="cb15-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[n] int&lt;lower=1, upper=N&gt; i;  // indicator for judges i in [N]</span></span>
<span id="cb15-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[n] int&lt;lower=1, upper=J&gt; j;  // indicator for cases j in [J]</span></span>
<span id="cb15-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb15-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] X;  // ideal points</span></span>
<span id="cb15-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real alpha_zero;  // intercepts</span></span>
<span id="cb15-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[J] alpha;  // item effects</span></span>
<span id="cb15-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb15-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real lprior = 0;</span></span>
<span id="cb15-19"></span>
<span id="cb15-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  lprior += student_t_lpdf(alpha_zero | 3, 0, 2.5);</span></span>
<span id="cb15-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  lprior += student_t_lpdf(alpha | 3, 0, 2.5);</span></span>
<span id="cb15-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  lprior += student_t_lpdf(X | 3, 0, 2.5);</span></span>
<span id="cb15-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb15-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[n] mu = rep_vector(0, n);</span></span>
<span id="cb15-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (k in 1:n) {</span></span>
<span id="cb15-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    mu[k] = alpha[j[k]] - X[i[k]];</span></span>
<span id="cb15-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb15-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  target += bernoulli_logit_lpmf(Y | mu + alpha_zero);</span></span>
<span id="cb15-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  target += lprior;</span></span>
<span id="cb15-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb15-33">case_number <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb15-34">indicator_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> case_number)</span>
<span id="cb15-35">indicator_j <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>case_number, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb15-36">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> indicator_i</span>
<span id="cb15-37">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>j <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> indicator_j</span>
<span id="cb15-38"></span>
<span id="cb15-39">df_NA <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(y))</span>
<span id="cb15-40"></span>
<span id="cb15-41">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> df_NA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df_NA), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">J =</span> case_number, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i =</span> df_NA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">j =</span> df_NA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>j)</span>
<span id="cb15-42">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model_code =</span> stan_code, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>)</span></code></pre></div>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">all_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X</span>
<span id="cb16-2">x_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_samples[(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(all_samples) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">999</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(all_samples), ]</span>
<span id="cb16-3"></span>
<span id="cb16-4">plot_dataframe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb16-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legislator =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(Rehnquist)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>],</span>
<span id="cb16-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(x_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, mean),</span>
<span id="cb16-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(x_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>),</span>
<span id="cb16-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(x_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)</span>
<span id="cb16-9">)</span>
<span id="cb16-10">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_dataframe, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> legislator)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb16-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Legislator"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1PL Model (RStan)"</span>)</span></code></pre></div>
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/1PL.png" class="img-fluid"></p>
<p><code>brms</code> による推定結果と，左右が逆になっている．これはモデル式を <code>alpha[j[k]] - X[i[k]]</code> と Stan コードに記入しており，<code>brms</code> の設定と（たまたま）逆になったためである．</p>
<p>余談であるが，<img src="https://latex.codecogs.com/png.latex?%5Calpha_0"> を固定された切片項でなくて，変動させる（変量効果にする）ことで，事後分散は大きく縮まる．</p>
<p>係数 <img src="https://latex.codecogs.com/png.latex?%5Calpha_j,x_i"> の事前分布を正規分布に変更したりしても結果はほとんど変わらない．</p>
</section>
<section id="sec-2PL" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="sec-2PL"><span class="header-section-number">2.4</span> ２母数モデル</h3>
<p><span class="citation" data-cites="Bafumi+2005">(Bafumi et al., 2005)</span> など，多くの理想点モデルでは２母数ロジットモデルが用いられる： <img src="https://latex.codecogs.com/png.latex?%0Ag(x):=%5Coperatorname%7Blogit%7D(x)=%5Clog%5Cfrac%7Bx%7D%7B1-x%7D,%0A"> <img src="https://latex.codecogs.com/png.latex?%0Ag(%5Cmu_%7Bi,j%7D)=%5Calpha_j+%5Cbeta_j%20x_i=%5Cbeta_j%5Cbiggr(%5Cwidetilde%7B%5Calpha%7D_j+x_i%5Cbiggl).%0A"> この際 <img src="https://latex.codecogs.com/png.latex?x_i"> は <img src="https://latex.codecogs.com/png.latex?i"> 番目の判事の <strong>理想点</strong> といい，<img src="https://latex.codecogs.com/png.latex?%5Calpha_j,%5Cbeta_j"> は <img src="https://latex.codecogs.com/png.latex?j"> 番目の事件の性質を表すパラメータである．</p>
<p>ものによっては判事の立場が関係ない事件もあるため，<img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> が用意されている．</p>
<p>基本的にこの識別パラメータが正になるように調整したいが，明示的にそうすることはしない．</p>
<p>次節で説明する方法により，理想点 <img src="https://latex.codecogs.com/png.latex?x_i"> が大きい場合は保守的な判断を下しやすいものと解釈できるように設計することができる（<img src="https://latex.codecogs.com/png.latex?x_i"> を数直線上にプロットした際に，リベラルな場合に左に，保守的な場合に右に来るようにする）が，ここではストレートに実装してみよう．</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb17-2">stan_code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb17-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb17-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; n;  // n = N * J - #(NA responses)</span></span>
<span id="cb17-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; N;  // number of judges</span></span>
<span id="cb17-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; J;  // number of cases</span></span>
<span id="cb17-7"></span>
<span id="cb17-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[n] int&lt;lower=0, upper=1&gt; Y;  // response variable</span></span>
<span id="cb17-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[n] int&lt;lower=1, upper=N&gt; i;  // indicator for judges i in [N]</span></span>
<span id="cb17-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[n] int&lt;lower=1, upper=J&gt; j;  // indicator for cases j in [J]</span></span>
<span id="cb17-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb17-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb17-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] X;  // ideal points</span></span>
<span id="cb17-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[J] alpha;  // item effects</span></span>
<span id="cb17-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[J] beta;  // item discremination</span></span>
<span id="cb17-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb17-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb17-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real lprior = 0;</span></span>
<span id="cb17-19"></span>
<span id="cb17-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  lprior += std_normal_lpdf(alpha);</span></span>
<span id="cb17-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  lprior += std_normal_lpdf(beta);</span></span>
<span id="cb17-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  lprior += std_normal_lpdf(X);</span></span>
<span id="cb17-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb17-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb17-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[n] mu = rep_vector(0, n);</span></span>
<span id="cb17-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (k in 1:n) {</span></span>
<span id="cb17-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    mu[k] = alpha[j[k]] + beta[j[k]] * X[i[k]];</span></span>
<span id="cb17-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb17-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  target += bernoulli_logit_lpmf(Y | mu);</span></span>
<span id="cb17-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  target += lprior;</span></span>
<span id="cb17-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb17-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb17-33">case_number <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb17-34">indicator_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> case_number)</span>
<span id="cb17-35">indicator_j <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>case_number, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)</span>
<span id="cb17-36">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> indicator_i</span>
<span id="cb17-37">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>j <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> indicator_j</span>
<span id="cb17-38"></span>
<span id="cb17-39">df_NA <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(y))</span>
<span id="cb17-40"></span>
<span id="cb17-41">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y =</span> df_NA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df_NA), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">J =</span> case_number, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i =</span> df_NA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">j =</span> df_NA<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>j)</span>
<span id="cb17-42">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model_code =</span> stan_code, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>)</span></code></pre></div>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">all_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X</span>
<span id="cb18-2">x_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_samples[(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(all_samples) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">999</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(all_samples), ]</span>
<span id="cb18-3"></span>
<span id="cb18-4">plot_dataframe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb18-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legislator =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(Rehnquist)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>],</span>
<span id="cb18-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(x_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, mean),</span>
<span id="cb18-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(x_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>),</span>
<span id="cb18-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(x_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)</span>
<span id="cb18-9">)</span>
<span id="cb18-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_dataframe, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> legislator)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb18-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Legislator"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ideal Points of Rehnquist"</span>)</span></code></pre></div>
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/2PL.png" class="img-fluid"></p>
<p>２つを並べてみると</p>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/1PL.png" class="img-fluid figure-img"></p>
<figcaption>1PL Model</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/2PL.png" class="img-fluid figure-img"></p>
<figcaption>2PL Model</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>モデルの自由度が上がったことにより，事後分散が大幅に小さくなっていることがわかる．</p>
<p>また，1PL の場合と再び左右が反転し，最後のリベラルな判事の２人 Ginsburg と Breyer が右に来てしまっている．</p>
<p>これはモデル式を <code>mu[k] = alpha[j[k]] + beta[j[k]] * X[i[k]];</code> と足し算に戻したからだろうか？</p>
<p>実はそうではない．実際，何度か MCMC を回し直すと，ちゃんとリベラルな判事が左に来てくれることもある．</p>
<p>即ち，<strong>事後分布が多峰性を持つ</strong> のである！</p>
<!-- 

```r
formula_2PL <- bf(
  y ~ 0 + (1 + name | case)
)
fit_2PL <- update(fit_1PL, formula = formula_2PL, cores = 4, iter = 3000)
```

```r
summary(fit_2PL)
```

    Family: bernoulli 
      Links: mu = logit 
    Formula: y ~ (1 | case) + (case | name) - 1 
      Data: df (Number of observations: 4343) 
      Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
            total post-warmup draws = 4000

    Multilevel Hyperparameters:
    ~case (Number of levels: 485) 
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    sd(Intercept)     1.05      0.06     0.93     1.18 1.00     1800     2643

    ~name (Number of levels: 9) 
                        Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    sd(Intercept)           1.59      0.44     0.96     2.70 1.00      767     1456
    sd(case)                0.00      0.00     0.00     0.00 1.00     1144     2343
    cor(Intercept,case)    -0.06      0.48    -0.87     0.87 1.00     4220     2337

    Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
    and Tail_ESS are effective sample size measures, and Rhat is the potential
    scale reduction factor on split chains (at convergence, Rhat = 1).


```r
plot(fit_2PL)
```

![](Images/plot_2PL.png){width=70% fig-align=center}

```r
ranef_legislator <- ranef(fit_2PL)$name
posterior_means <- ranef_legislator[,1,"Intercept"]
lower_bounds <- ranef_legislator[,3,"Intercept"]
upper_bounds <- ranef_legislator[,4,"Intercept"]
plot_legislator <- data.frame(
  legislator = rownames(ranef_legislator),
  mean = posterior_means,
  lower = lower_bounds,
  upper = upper_bounds
)
p_2PL <- ggplot(plot_legislator, aes(x = mean, y = legislator)) +
  geom_point() +
  geom_errorbar(aes(xmin = lower, xmax = upper), width = 0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "2PL Model",
       x = "Posterior Estimate",
       y = "Legislator")
grid.arrange(p_1PL, p_2PL, nrow = 1)
```

![](Images/grid_arrange.png)

よりモデルの不確実性が減って，$0$ の周りに縮小されたことがわかる．これは一般の項目反応モデルで見られる：

::: {#lst-embedding}
:::

左派が右に表示されてしまっていることは変わらない．
-->
</section>
<section id="sec-identification" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="sec-identification"><span class="header-section-number">2.5</span> 識別可能性</h3>
<p>実は２母数ロジットモデルでは３つ識別不可能性を引き起こす対称性がある：</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="[Section 2 @Bafumi+2005]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="citation" data-cites="Bafumi+2005">(Section 2 Bafumi et al., 2005)</span>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>加法的別名 (additive aliasing)</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Calpha%7D_j,x_i"> に同じ数を足した場合と <img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> と <img src="https://latex.codecogs.com/png.latex?(%5Cwidetilde%7B%5Calpha%7D_j,x_i)"> に同じ数を乗じた／除した場合，全く等価なモデルが得られる．すなわちスケールを定める必要がある．</p></li>
<li><p>乗法的別名 (additive aliasing)</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> を <img src="https://latex.codecogs.com/png.latex?a%3E0"> 倍し，<img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Calpha%7D_j,x_i"> を <img src="https://latex.codecogs.com/png.latex?1/a"> 倍すると等価な尤度を定める．</p></li>
<li><p>反転対称性 (reflection invariance)</p>
<p>最後に <img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> の符号の問題があるためである．<img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> を <img src="https://latex.codecogs.com/png.latex?-1"> 倍させることで <img src="https://latex.codecogs.com/png.latex?%5Cwidetilde%7B%5Calpha%7D_j,x_i"> の役割を <img src="https://latex.codecogs.com/png.latex?-1"> 倍させることができる．このまま推定すると事後分布は <img src="https://latex.codecogs.com/png.latex?0"> に関して対称な形を持つことになる．</p></li>
</ul>
</div>
</div>
<!-- 
ベイズ推定では，次のような事前分布と階層構造を置くことでこの問題を回避できる：
$$
x_i\iidsim\rN(0,1),\qquad \al_j=\mu_\al+\ep_\al,\qquad\ep_\al\iidsim\rN(0,\sigma^2_\al),
$$
$$
\beta_j=\mu_\beta+\ep_\beta,\qquad\ep_\beta\iidsim\rN(0,\sigma^2_\beta).
$$

```r
library(rstan)
stan_code <- "
data {
  int<lower=1> n;  // n = N * J - #(NA responses)
  int<lower=1> N;  // number of judges
  int<lower=1> J;  // number of cases

  array[n] int<lower=0, upper=1> Y;  // response variable
  array[n] int<lower=1, upper=N> i;  // indicator for judges i in [N]
  array[n] int<lower=1, upper=J> j;  // indicator for cases j in [J]
}
parameters {
  vector[N] X;  // ideal points
  vector[J] alpha_zero;  // item effects
  vector[J] beta_zero;  // item discremination

  real<lower=0> sigma_al;  // sd of alpha
  real<lower=0> sigma_beta;  // sd of beta

  vector[J] alpha;  // real values of alpha
  vector[J] beta;  // real values of beta
}
transformed parameters {
  real lprior = 0;

  lprior += student_t_lpdf(alpha_zero | 3, 0, 2.5);
  lprior += student_t_lpdf(beta_zero | 3, 0, 2.5);
  lprior += student_t_lpdf(sigma_al | 3, 0, 2.5);
  lprior += student_t_lpdf(sigma_beta | 3, 0, 2.5);
  lprior += std_normal_lpdf(X);
}
model {
  alpha ~ normal(alpha_zero, sigma_al);
  beta ~ normal(beta_zero, sigma_beta);
  vector[n] mu = rep_vector(0, n);
  for (k in 1:n) {
    mu[k] = alpha[j[k]] + beta[j[k]] * X[i[k]];
  }
  target += bernoulli_logit_lpmf(Y | mu);
  target += lprior;
}
"
case_number <- as.integer(nrow(df) / 9)
indicator_i <- rep(1:9, times = case_number)
indicator_j <- rep(1:case_number, each = 9)
df$i <- indicator_i
df$j <- indicator_j

df_NA <- df %>% filter(!is.na(y))

data <- list(Y = df_NA$y, n = nrow(df_NA), N = 9, J = case_number, i = df_NA$i, j = df_NA$j)
fit <- stan(model_code = stan_code, data = data, chains = 4, cores = 4, verbose = TRUE, iter = 4000, warmup = 3000)
```

```r
all_samples <- extract(fit, pars = "X")$X
x_samples <- all_samples[(nrow(all_samples) - 999):nrow(all_samples), ]

plot_dataframe <- data.frame(
  legislator = colnames(Rehnquist)[1:9],
  mean = apply(x_samples, 2, mean),
  lower = apply(x_samples, 2, quantile, probs = 0.025),
  upper = apply(x_samples, 2, quantile, probs = 0.975)
)
ggplot(plot_dataframe, aes(x = mean, y = legislator)) +
  geom_point() +
  geom_errorbar(aes(xmin = lower, xmax = upper), width = 0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Mean", y = "Legislator", title = "Ideal Points of Rehnquist")
```

::: {layout-ncol=2}
![2PL Model](Images/stan2.png)

![Identified 2PL hierarchical model](Images/stan3.png)
:::
-->
<p><img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> の符号を制約したり，特定の判事の <img src="https://latex.codecogs.com/png.latex?x_i"> を固定して参照点とするなどの方法があるかもしれないが，ここでは <span class="citation" data-cites="Bafumi+2005">(2.2.3 節 Bafumi et al., 2005, p. 178)</span> に倣って，階層モデルの方法により，構造的なやり方でモデルに情報を伝える．</p>
<p>というのも，理想点 <img src="https://latex.codecogs.com/png.latex?x_i"> に次の階層構造を入れるのである： <img src="https://latex.codecogs.com/png.latex?%0Ax_i=%5Cdelta+%5Cgamma%20z_i+%5Cepsilon_i%5Cqquad%5Cepsilon_i%5Coverset%7B%5Ctext%7Bi.i.d.%7D%7D%7B%5Csim%7D%5Cmathrm%7BN%7D(0,1).%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?z_i"> は当該判事を示した大統領の所属政党を表す２値変数で，共和党ならば <img src="https://latex.codecogs.com/png.latex?z_i=1"> とする．そして <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> に <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D_+"> 上に台を持つ事前分布を置く．</p>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="[@Bafumi+2005] による理想点モデルの階層化">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="citation" data-cites="Bafumi+2005">(Bafumi et al., 2005)</span> による理想点モデルの階層化
</div>
</div>
<div class="callout-body-container callout-body">
<p>このように共変量を適切な階層に追加することは，モデルに自然な形で正則化情報を伝えることに繋がり，モデルの識別やより現実的な推定値の獲得に繋がる．</p>
</div>
</div>
</section>
<section id="階層ベイズ推定" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="階層ベイズ推定"><span class="header-section-number">2.6</span> 階層ベイズ推定</h3>
<section id="指名大統領の政党属性" class="level4" data-number="2.6.1">
<h4 data-number="2.6.1" class="anchored" data-anchor-id="指名大統領の政党属性"><span class="header-section-number">2.6.1</span> 指名大統領の政党属性</h4>
<p>続いて 2.5 で検討した，<span class="citation" data-cites="Bafumi+2005">(Bafumi et al., 2005)</span> による階層ベイズモデルにより緩やかに情報を伝えることで識別可能性を保つ方法を検討する（第 2.6.2 節）．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb19-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb19-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nominator =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb19-4">      name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rehnquist"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stevens"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nixon"</span>,</span>
<span id="cb19-5">      name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"O.Connor"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Scalia"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kennedy"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Reagan"</span>,</span>
<span id="cb19-6">      name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Souter"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Thomas"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bush"</span>,</span>
<span id="cb19-7">      name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Breyer"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ginsburg"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Clinton"</span></span>
<span id="cb19-8">    )</span>
<span id="cb19-9">  )</span>
<span id="cb19-10">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(</span>
<span id="cb19-11">  df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nominator <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nixon"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Reagan"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bush"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Trump"</span>),</span>
<span id="cb19-12">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
</section>
<section id="sec-Bafumi" class="level4" data-number="2.6.2">
<h4 data-number="2.6.2" class="anchored" data-anchor-id="sec-Bafumi"><span class="header-section-number">2.6.2</span> 階層２母数モデル</h4>
<p><code>x</code> の情報を階層的に伝えるには，もはや <code>brms</code> パッケージでは実行できないようである．</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="`fit_2PL::brmsfit` で用いた Stan コードの出力">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<code>fit_2PL::brmsfit</code> で用いた Stan コードの出力
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>brms</code> パッケージでは <a href="https://paulbuerkner.com/brms/reference/stancode.html"><code>stancode()</code></a> 関数を用いて Stan コードを出力できる．</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stancode</span>(fit_2PL)</span></code></pre></div>
<p>結果は以下の通りになる：</p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// generated with brms 2.21.0</span></span>
<span id="cb21-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">functions</span> {</span>
<span id="cb21-3"> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* compute correlated group-level effects</span></span>
<span id="cb21-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  * Args:</span></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  *   z: matrix of unscaled group-level effects</span></span>
<span id="cb21-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  *   SD: vector of standard deviation parameters</span></span>
<span id="cb21-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  *   L: cholesky factor correlation matrix</span></span>
<span id="cb21-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  * Returns:</span></span>
<span id="cb21-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  *   matrix of scaled group-level effects</span></span>
<span id="cb21-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  */</span></span>
<span id="cb21-11">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matrix</span> scale_r_cor(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matrix</span> z, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span> SD, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matrix</span> L) {</span>
<span id="cb21-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// r is stored in another dimension order than z</span></span>
<span id="cb21-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> transpose(diag_pre_multiply(SD, L) * z);</span>
<span id="cb21-14">  }</span>
<span id="cb21-15">}</span>
<span id="cb21-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">data</span> {</span>
<span id="cb21-17">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// total number of observations</span></span>
<span id="cb21-18">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> Y;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// response variable</span></span>
<span id="cb21-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// data for group-level effects of ID 1</span></span>
<span id="cb21-20">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of grouping levels</span></span>
<span id="cb21-21">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; M_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of coefficients per level</span></span>
<span id="cb21-22">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; J_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// grouping indicator per observation</span></span>
<span id="cb21-23">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level predictor values</span></span>
<span id="cb21-24">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] Z_1_1;</span>
<span id="cb21-25">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// data for group-level effects of ID 2</span></span>
<span id="cb21-26">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; N_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of grouping levels</span></span>
<span id="cb21-27">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; M_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of coefficients per level</span></span>
<span id="cb21-28">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; J_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// grouping indicator per observation</span></span>
<span id="cb21-29">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level predictor values</span></span>
<span id="cb21-30">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] Z_2_1;</span>
<span id="cb21-31">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] Z_2_2;</span>
<span id="cb21-32">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; NC_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// number of group-level correlations</span></span>
<span id="cb21-33">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> prior_only;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// should the likelihood be ignored?</span></span>
<span id="cb21-34">}</span>
<span id="cb21-35"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">transformed data</span> {</span>
<span id="cb21-36">}</span>
<span id="cb21-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">parameters</span> {</span>
<span id="cb21-38">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt;[M_1] sd_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level standard deviations</span></span>
<span id="cb21-39">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[M_1] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_1] z_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// standardized group-level effects</span></span>
<span id="cb21-40">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt;[M_2] sd_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// group-level standard deviations</span></span>
<span id="cb21-41">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matrix</span>[M_2, N_2] z_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// standardized group-level effects</span></span>
<span id="cb21-42">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">cholesky_factor_corr</span>[M_2] L_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// cholesky factor of correlation matrix</span></span>
<span id="cb21-43">}</span>
<span id="cb21-44"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">transformed parameters</span> {</span>
<span id="cb21-45">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_1] r_1_1;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// actual group-level effects</span></span>
<span id="cb21-46">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matrix</span>[N_2, M_2] r_2;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// actual group-level effects</span></span>
<span id="cb21-47">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// using vectors speeds up indexing in loops</span></span>
<span id="cb21-48">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_2] r_2_1;</span>
<span id="cb21-49">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N_2] r_2_2;</span>
<span id="cb21-50">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> lprior = <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// prior contributions to the log posterior</span></span>
<span id="cb21-51">  r_1_1 = (sd_1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] * (z_1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]));</span>
<span id="cb21-52">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compute actual group-level effects</span></span>
<span id="cb21-53">  r_2 = scale_r_cor(z_2, sd_2, L_2);</span>
<span id="cb21-54">  r_2_1 = r_2[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>];</span>
<span id="cb21-55">  r_2_2 = r_2[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>];</span>
<span id="cb21-56">  lprior += student_t_lpdf(sd_1 | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb21-57">    - <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> * student_t_lccdf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb21-58">  lprior += student_t_lpdf(sd_2 | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb21-59">    - <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> * student_t_lccdf(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb21-60">  lprior += lkj_corr_cholesky_lpdf(L_2 | <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb21-61">}</span>
<span id="cb21-62"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">model</span> {</span>
<span id="cb21-63">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// likelihood including constants</span></span>
<span id="cb21-64">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (!prior_only) {</span>
<span id="cb21-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// initialize linear predictor term</span></span>
<span id="cb21-66">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[N] mu = rep_vector(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, N);</span>
<span id="cb21-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (n <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:N) {</span>
<span id="cb21-68">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// add more terms to the linear predictor</span></span>
<span id="cb21-69">      mu[n] += r_1_1[J_1[n]] * Z_1_1[n] + r_2_1[J_2[n]] * Z_2_1[n] + r_2_2[J_2[n]] * Z_2_2[n];</span>
<span id="cb21-70">    }</span>
<span id="cb21-71">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> bernoulli_logit_lpmf(Y | mu);</span>
<span id="cb21-72">  }</span>
<span id="cb21-73">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// priors including constants</span></span>
<span id="cb21-74">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> lprior;</span>
<span id="cb21-75">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> std_normal_lpdf(z_1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb21-76">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">target +=</span> std_normal_lpdf(to_vector(z_2));</span>
<span id="cb21-77">}</span>
<span id="cb21-78"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">generated quantities</span> {</span>
<span id="cb21-79">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// compute group-level correlations</span></span>
<span id="cb21-80">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">corr_matrix</span>[M_2] Cor_2 = multiply_lower_tri_self_transpose(L_2);</span>
<span id="cb21-81">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=-<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt;[NC_2] cor_2;</span>
<span id="cb21-82">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// extract upper diagonal of correlation matrix</span></span>
<span id="cb21-83">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (k <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:M_2) {</span>
<span id="cb21-84">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:(k - <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) {</span>
<span id="cb21-85">      cor_2[choose(k - <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) + j] = Cor_2[j, k];</span>
<span id="cb21-86">    }</span>
<span id="cb21-87">  }</span>
<span id="cb21-88">}</span></code></pre></div>
<p><code>function</code> ブロックでは <code>scale_r_cor()</code> 関数が定義されている．標準化された項目変数 <img src="https://latex.codecogs.com/png.latex?(%5Calpha_j,%5Cbeta_j)"> を <code>z</code> として，その各次元の標準偏差を含む２次元ベクトルを <code>sd_2</code>，Cholesky 因子を <code>L_2</code> として，行列積 <code>sd_2*L2</code> にベクトル <code>z</code> を掛けて返している．これは <img src="https://latex.codecogs.com/png.latex?(%5Calpha_j,%5Cbeta_j)"> を３つの要素（対角行列・Cholesky 因子・標準化されたベクトル）に因数分解して計算していることに起因する．</p>
<p><code>data</code> ブロックでデータのコーディングを定めている．<code>Y</code> は <img src="https://latex.codecogs.com/png.latex?NJ"> 行列である．<code>case</code> が <code>ID2</code> で <code>name</code> が <code>ID1</code> に対応する．判事 <img src="https://latex.codecogs.com/png.latex?i%5Cin%5Bn%5D"> は <code>N_1</code> 人，件数 <img src="https://latex.codecogs.com/png.latex?j%5Cin%5BJ%5D"> は <code>N_2</code> 件．このデータから <code>M_1=1</code> 次元の理想点を持った <code>M_2=2</code> パラメータモデルを推定する．<code>Z_1_1</code> が判事を表す標示変数で，項目を表す標示変数は <code>Z_2_1</code> と <code>Z_2_2</code> である．</p>
<p><code>parameter</code> ブロックでは標準化された理想点 <code>z_1</code> と項目パラメータ <code>z_2</code>，それぞれの標準偏差 <code>sd_1</code>, <code>sd_2</code> を宣言している．<code>z_1</code> だけ <code>N_1</code> ベクトル，<code>z_2</code> は <code>N_2</code> 行 <code>M_2</code> 列の行列であることに注意．</p>
<p><code>transformed_parameters</code> で真のスケールに戻す．<code>r_1_1=(sd_1[1]*(z_1[1]))</code> は理想点 <img src="https://latex.codecogs.com/png.latex?x_1"> にあたり，<code>r_2=scale_r_cor(z_2,sd_2,L_2)</code> は項目パラメータ <img src="https://latex.codecogs.com/png.latex?(%5Calpha_j,%5Cbeta_j)"> にあたる．その後 <code>r_2_1=r_2[,1]</code> と <code>r_2_2=r_2[,2]</code> でそれぞれ <img src="https://latex.codecogs.com/png.latex?%5Calpha_j"> と <img src="https://latex.codecogs.com/png.latex?%5Cbeta_j"> に分解している．最後に <code>sd_1</code>, <code>sd_2</code> に t-分布，<code>L_2</code> に Cholesky 分布を事前分布として定義している．</p>
<p><code>model</code> で尤度を定義している．<code>mu</code> はこのブロックでしか使われない線型予測子の格納変数である．</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb22-1">mu[n] += r_1_1[J_1[n]] * Z_1_1[n] + r_2_1[J_2[n]] * Z_2_1[n] + r_2_2[J_2[n]] * Z_2_2[n];</span></code></pre></div>
<p>により <img src="https://latex.codecogs.com/png.latex?%5Calpha_j+%5Cbeta_j%20x_i"> が計算されている．<img src="https://latex.codecogs.com/png.latex?j"> は <code>J_2[n]</code>, <img src="https://latex.codecogs.com/png.latex?i"> は <code>J_1[n]</code> で表されている．最後に <code>bernoulli_logit_lpmf(Y | mu)</code> で尤度が定義される．</p>
<p><code>generated quantities</code> ブロックでは相関行列 <code>cor_2</code> を計算している．</p>
</div>
</div>
</div>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Files/bafumi.stan</strong></pre>
</div>
<div class="sourceCode" id="cb23" data-filename="Files/bafumi.stan" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1">data {</span>
<span id="cb23-2">  int<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>lower<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> n;  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> J <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#(NA responses)</span></span>
<span id="cb23-3">  int<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>lower<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> N;  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> number of judges</span>
<span id="cb23-4">  int<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>lower<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> J;  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> number of cases</span>
<span id="cb23-5"></span>
<span id="cb23-6">  array[n] int<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>lower<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, upper<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> Y;  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> response variable</span>
<span id="cb23-7">  vector[N] Z;  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> covariates <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> judges</span>
<span id="cb23-8">  array[n] int<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>lower<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, upper<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>N<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> i;  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> indicator <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> judges i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [N]</span>
<span id="cb23-9">  array[n] int<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>lower<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, upper<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>J<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> j;  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> indicator <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> cases j <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [J]</span>
<span id="cb23-10">}</span>
<span id="cb23-11">parameters {</span>
<span id="cb23-12">  vector[N] X;  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> ideal points <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> judges</span>
<span id="cb23-13">  vector[J] alpha;</span>
<span id="cb23-14">  vector[J] beta;</span>
<span id="cb23-15"></span>
<span id="cb23-16">  real delta;</span>
<span id="cb23-17">  real gamma;</span>
<span id="cb23-18">  real<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>lower<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> sigma;</span>
<span id="cb23-19">}</span>
<span id="cb23-20">transformed parameters {</span>
<span id="cb23-21">  real lprior <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>;</span>
<span id="cb23-22"></span>
<span id="cb23-23">  lprior <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">student_t_lpdf</span>(delta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb23-24">  lprior <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">student_t_lpdf</span>(gamma <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb23-25">  lprior <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">student_t_lpdf</span>(alpha <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb23-26">  lprior <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">student_t_lpdf</span>(beta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb23-27">  lprior <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">std_normal_lpdf</span>(X);</span>
<span id="cb23-28">  lprior <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">student_t_lpdf</span>(sigma <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>)</span>
<span id="cb23-29">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">student_t_lccdf</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>);</span>
<span id="cb23-30">}</span>
<span id="cb23-31">model {</span>
<span id="cb23-32">  X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">normal</span>(delta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Z <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(gamma), sigma);</span>
<span id="cb23-33"></span>
<span id="cb23-34">  vector[n] mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep_vector</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, n);</span>
<span id="cb23-35">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (k <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n) {</span>
<span id="cb23-36">    mu[k] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> alpha[j[k]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> beta[j[k]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X[i[k]];</span>
<span id="cb23-37">  }</span>
<span id="cb23-38">  target <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bernoulli_logit_lpmf</span>(Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> mu);</span>
<span id="cb23-39">  target <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> lprior;</span>
<span id="cb23-40">}</span></code></pre></div>
</div>
<!-- 
```r
## fit without initial values

library(rstan)
case_number <- as.integer(nrow(df) / 9)
indicator_i <- rep(1:9, times = case_number)
indicator_j <- rep(1:case_number, each = 9)
df$i <- indicator_i
df$j <- indicator_j

df_NA <- df %>% filter(!is.na(y))

data <- list(Y = df_NA$y, n = nrow(df_NA), N = 9, J = case_number, Z = df_NA$x[1:9], i = df_NA$i, j = df_NA$j)

fit <- stan("Files/bafumi_modified.stan", data = data, chains = 4, cores = 4, verbose = TRUE, iter = 4000, warmup = 3000)
```

```r
## fit with erronous initial values

init_values <- list(X = c(-1.0,1.0,1.0,-1.0,-1.0,0.0,0.0,1.0,1.0), alpha = rep(0.0, case_number), beta = rep(0.0, case_number), delta = 0.0, gamma = 0.0, sigma = 1.0)
fit <- stan("Files/bafumi.stan", data = data, chains = 4, cores = 4, verbose = TRUE, iter = 4000, warmup = 3000, init = rep(list(init_values), 4))
```

```r
## fit with correct initial values

#| output: false
init_values <- list(X = -1.0 * c(-1.0,1.0,1.0,-1.0,-1.0,0.0,0.0,1.0,1.0), alpha = rep(0.0, case_number), beta = rep(0.0, case_number), delta = 0.0, gamma = 0.0, sigma = 1.0)
fit <- stan("Files/bafumi.stan", data = data, chains = 4, cores = 4, verbose = TRUE, iter = 4000, warmup = 3000, init = rep(list(init_values), 4))
```

```r
## plot X (ideal points)

all_samples <- extract(fit, pars = "X")$X
x_samples <- all_samples[(nrow(all_samples) - 999):nrow(all_samples), ]

plot_dataframe <- data.frame(
  legislator = colnames(Rehnquist)[1:9],
  mean = apply(x_samples, 2, mean),
  lower = apply(x_samples, 2, quantile, probs = 0.025),
  upper = apply(x_samples, 2, quantile, probs = 0.975)
)
p <- ggplot(plot_dataframe, aes(x = mean, y = legislator)) +
  geom_point() +
  geom_errorbar(aes(xmin = lower, xmax = upper), width = 0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Mean", y = "Legislator", title = "Ideal Points of Rehnquist")
p
# ggsave("Files/Bafumi_Model1.png", p)
```
-->
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/stan4.png" class="img-fluid figure-img"></p>
<figcaption>階層モデルの推定結果</figcaption>
</figure>
</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/stan4.png" class="img-fluid figure-img"></p>
<figcaption>今回の推定結果</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Images/2PL.png" class="img-fluid figure-img"></p>
<figcaption>２母数モデル 2.4 の推定結果</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="識別性の影響" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="識別性の影響"><span class="header-section-number">2.7</span> 識別性の影響</h3>
<p>実は階層的に緩やかにしか情報を伝えていないために，今回の <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> への事前分布の設定では，まだ <img src="https://latex.codecogs.com/png.latex?0"> の近くに密集することでもう一つの峰を作り出してしまうようである．</p>
<p>例えば，Stevens, Souter, Ginsburg, Breyer らリベラルな判事の初期位置を右側の <img src="https://latex.codecogs.com/png.latex?1"> に，Thomas, Scalia ら保守派の判事の初期位置を <img src="https://latex.codecogs.com/png.latex?-1"> に，そのほか中道的な判事の初期位置を <img src="https://latex.codecogs.com/png.latex?0"> にしてサンプリングをすると，ほぼ確実に左右が逆になった結果が出てくる．</p>
<p>その際は <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> の事後分布が大きく違う．</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">init_values <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, case_number), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, case_number), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delta =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamma =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sigma =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb24-2">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Files/bafumi.stan"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">init =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(init_values), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div>
<!-- 
```r
gamma_all_samples <- extract(fit, pars = "gamma")$gamma
gamma_samples <- gamma_all_samples[(nrow(gamma_all_samples) - 999):nrow(gamma_all_samples)]
p <- ggplot(data.frame(gamma = exp(gamma_samples)), aes(x = gamma)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "blue", alpha = 0.5) +
  geom_density(color = "red") +
  # xlim(0, 1) +
  labs(x = "Gamma", y = "Density", title = "Posterior Distribution of Gamma")
# ggsave("Files/Bafumi_Model_erronous_Gamma.png", p)
p
```
-->
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model1_Gamma.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が正しい場合の回帰係数 <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> の事後分布</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model_erronous_Gamma.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が間違っている場合の回帰係数 <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> の事後分布</figcaption>
</figure>
</div>
</div>
</div>
</div>
<!--
```r
delta_all_samples <- extract(fit, pars = "delta")$delta
delta_samples <- delta_all_samples[(nrow(delta_all_samples) - 999):nrow(delta_all_samples)]
p <- ggplot(data.frame(delta = delta_samples), aes(x = delta)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "blue", alpha = 0.5) +
  geom_density(color = "red") +
  labs(x = "Delta", y = "Density", title = "Posterior Distribution of Delta")
# ggsave("Files/Bafumi_Model_erronous_Delta.png", p)
p
```
-->
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model1_Delta.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が正しい場合の回帰係数 <img src="https://latex.codecogs.com/png.latex?%5Cdelta"> の事後分布</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model_erronous_Delta.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が間違っている場合の回帰係数 <img src="https://latex.codecogs.com/png.latex?%5Cdelta"> の事後分布</figcaption>
</figure>
</div>
</div>
</div>
</div>
<!-- 
```r
X_calc <- delta_samples + df_NA$x[1:9] * exp(gamma_samples)
p <- ggplot(data.frame(x = X_calc), aes(x = x)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "blue", alpha = 0.5) +
  geom_density(color = "red") +
  labs(x = "X", y = "Density", title = "Posterior Distribution of X")
# ggsave("Files/Bafumi_Model_erronous_X.png", p)
p
```
-->
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model1_X.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が正しい場合の理想点の事後分布</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model_erronous_X.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が間違っている場合の理想点の事後分布</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="事後分布の２峰性" class="level3" data-number="2.8">
<h3 data-number="2.8" class="anchored" data-anchor-id="事後分布の２峰性"><span class="header-section-number">2.8</span> 事後分布の２峰性</h3>
<!-- この階層モデルは極めて事前分布の影響を受けやすい． -->
<p>しかし <img src="https://latex.codecogs.com/png.latex?%5Calpha_j,%5Cbeta_j,%5Cdelta,%5Cgamma"> の事前分布はあまり大きな影響はないようである．<img src="https://latex.codecogs.com/png.latex?%5Cgamma"> の中心も少しズラしたくらいでは関係ない．<img src="https://latex.codecogs.com/png.latex?%5Cgamma"> を分散 <img src="https://latex.codecogs.com/png.latex?1"> で平均 <img src="https://latex.codecogs.com/png.latex?10"> の正規分布などにすると，<img src="https://latex.codecogs.com/png.latex?%5Cgamma"> の事後分布は右に引っ張れる．</p>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model_erronous_Gamma.png" class="img-fluid figure-img"></p>
<figcaption>元々の事前分布</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model_artificial_Gamma.png" class="img-fluid figure-img"></p>
<figcaption><img src="https://latex.codecogs.com/png.latex?%5Cgamma"> を右に引っ張った場合の事後分布</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>しかし理想点の結果自体は（左右の別を除いて）ほとんど変わらない：</p>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model1.png" class="img-fluid figure-img"></p>
<figcaption>元々のモデルの結果</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/Bafumi_Model_artificial.png" class="img-fluid figure-img"></p>
<figcaption><img src="https://latex.codecogs.com/png.latex?%5Cgamma"> の事後分布を右に引っ張った場合</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>次は初期値をランダムとして９回実行して得る結果である：</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>experiment.r</strong></pre>
</div>
<div class="sourceCode" id="cb25" data-filename="experiment.r" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>) {</span>
<span id="cb25-2">  execution_time <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system.time</span>({</span>
<span id="cb25-3">    fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Files/bafumi_normal.stan"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>)</span>
<span id="cb25-4">  })[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'elapsed'</span>]</span>
<span id="cb25-5">  all_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X</span>
<span id="cb25-6">  last_1000_samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_samples[(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(all_samples) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">999</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(all_samples), ]</span>
<span id="cb25-7">  plot_dataframe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb25-8">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legislator =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(Rehnquist)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>],</span>
<span id="cb25-9">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(last_1000_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, mean),</span>
<span id="cb25-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(last_1000_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>),</span>
<span id="cb25-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(last_1000_samples, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)</span>
<span id="cb25-12">  )</span>
<span id="cb25-13">  title <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Elapsed time: "</span>, execution_time, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" seconds"</span>)</span>
<span id="cb25-14">  p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(plot_dataframe, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> legislator)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-15">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-16">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb25-18">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mean"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Legislator"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> title)</span>
<span id="cb25-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Files/experiment_"</span>, i, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".png"</span>), p)</span>
<span id="cb25-20">}</span></code></pre></div>
</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_1.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.99 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_2.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 17.01 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_3.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.30 seconds</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_4.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 15.00 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_5.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 14.98 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_6.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 15.06 seconds</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_7.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.42 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_8.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.57 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/Files/experiment_9.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 17.18 seconds</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>なんと，緩やかな情報伝達に拘らず，判事の理想点はほぼ完全に識別されているが，<strong>方向が違う</strong>！</p>
<p>サンプリングを繰り返すことで結果がよく移り変わる．即ち，この事後分布は２峰あるようである．</p>
<p>そして burn-in 後の 1000 回のサンプリング期間では，異なる峰の間を移り変わることはほとんどないようである．</p>
<p>この点については次の稿も参照：</p>
<div id="listing-lst-embedding1" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ1I=" data-listing-date-sort="1734825600000" data-listing-file-modified-sort="1754014117262" data-listing-date-modified-sort="1734912000000" data-listing-reading-time-sort="5" data-listing-word-count-sort="954">
<a href="../../../posts/2024/TransDimensionalModels/Bafumi.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<!-- img(9CEB782EFEE6)[progressive=false, height=150px]:lst-embedding1:posts/2024/TransDimensionalModels/Bafumi.html -->
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
On the Identifiability of the Bafumi et. al.&nbsp;Ideal Point Model
</h5>
<div class="card-subtitle listing-subtitle">
Rethinking of the Hierarchical Model of Bafumi et. al.&nbsp;(2005)
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

<div class="listing-category" onclick="window.quartoListingCategory('TUNNQw=='); return false;">MCMC</div>

<div class="listing-category" onclick="window.quartoListingCategory('Ug=='); return false;">R</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-22
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
</section>
<section id="理想点解析パッケージ一覧" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="理想点解析パッケージ一覧"><span class="header-section-number">3</span> 理想点解析パッケージ一覧</h2>
<p>本節では次の３つのパッケージを紹介する：</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li><code>pscl</code> <span class="citation" data-cites="Zeileis+2008">(Zeileis et al., 2008)</span>：<a href="https://github.com/atahk/pscl">GitHub</a>, <a href="https://cran.r-project.org/web/packages/pscl/index.html">CRAN</a>．<span class="citation" data-cites="Arnold2018">(Arnold, 2018)</span> も参照．</li>
<li><code>MCMCpack</code> <span class="citation" data-cites="Martin+2011">(Martin et al., 2011)</span>：<a href="https://github.com/cran/MCMCpack">GitHub</a>, <a href="https://cran.r-project.org/web/packages/MCMCpack/index.html">CRAN</a></li>
<li><code>emIRT</code> <span class="citation" data-cites="Imai+2016">(Imai et al., 2016)</span>：<a href="https://github.com/kosukeimai/emIRT">GitHub</a>, <a href="https://cran.r-project.org/web/packages/emIRT/index.html">CRAN</a></li>
</ul>
</div>
</div>
</div>
<section id="pscl-パッケージ" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="pscl-パッケージ"><span class="header-section-number">3.1</span> <code>pscl</code> パッケージ</h3>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pscl"</span>)</span></code></pre></div>
<section id="voteview-データ" class="level4" data-number="3.1.1">
<h4 data-number="3.1.1" class="anchored" data-anchor-id="voteview-データ"><span class="header-section-number">3.1.1</span> <code>voteview</code> データ</h4>
<p>このパッケージでは，Keith T. Poole と Howard Rosenthal が 1995 年から運営しているサイト <a href="https://voteview.com/"><code>voteview.com</code></a> のデータを利用するための関数 <code>readKH()</code> が提供されている．</p>
<p>例えば連邦議会 (U.S. Congress) 117 議会期 (Congress) 2021.1.3-2023.1.3 の上院 (Senate) の点呼投票データを読み込むには以下のようにする：<sup>2</sup></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pscl)</span>
<span id="cb27-2">s117 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readKH</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://voteview.com/static/data/out/votes/S117_votes.ord"</span>,</span>
<span id="cb27-3">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">desc=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"117th U.S. Senate"</span>)</span></code></pre></div>
</div>
<p><code>s117</code> は <code>rollcall</code> オブジェクト，８つのフィールドを持った配列である．</p>
<p><code>s117$votes</code> データは <img src="https://latex.codecogs.com/png.latex?n=104"> 議員の計 <img src="https://latex.codecogs.com/png.latex?m=949"> 回の投票からなる <img src="https://latex.codecogs.com/png.latex?10">-値の行列である．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(s117)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Summary of rollcall object s117 

Description:     117th U.S. Senate 
Source:      https://voteview.com/static/data/out/votes/S117_votes.ord 

Number of Legislators:       104
Number of Roll Call Votes:   949


Using the following codes to represent roll call votes:
Yea:         1 2 3 
Nay:         4 5 6 
Abstentions:     7 8 9 
Not In Legislature:  0 

Party Composition:
    D Indep     R 
   50     2    52 

Vote Summary:
               Count Percent
0 (notInLegis)  3544     3.6
1 (yea)        55542    56.3
6 (nay)        35995    36.5
7 (missing)        5     0.0
9 (missing)     3610     3.7

Use summary(s117,verbose=TRUE) for more detailed information.</code></pre>
</div>
</div>
</section>
<section id="点呼投票データ" class="level4" data-number="3.1.2">
<h4 data-number="3.1.2" class="anchored" data-anchor-id="点呼投票データ"><span class="header-section-number">3.1.2</span> 点呼投票データ</h4>
<p>点呼投票データとは <img src="https://latex.codecogs.com/png.latex?n%5Ctimes%20m"> の行列で，そのエントリーは２値変数である（今回は <img src="https://latex.codecogs.com/png.latex?1"> か <img src="https://latex.codecogs.com/png.latex?6">）．</p>
<p>しかし実際には種々の欠測により，<img src="https://latex.codecogs.com/png.latex?0,7,9"> も使われる．</p>
<p>これをヒートマップで可視化してみる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb30-2"></span>
<span id="cb30-3">votes_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(s117<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>votes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames_to_column</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Legislator"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 投票データをデータフレームに変換し、行名を列として追加</span></span>
<span id="cb30-4"></span>
<span id="cb30-5">votes_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> votes_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Legislator, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vote"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを長形式に変換</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(votes_long, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Vote, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Legislator, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_tile</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_gradient</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">low =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">angle =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Votes"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Legislators"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Voting Patterns"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ヒートマップを作成</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/IdealPoint1_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="政党毎の賛成率" class="level4" data-number="3.1.3">
<h4 data-number="3.1.3" class="anchored" data-anchor-id="政党毎の賛成率"><span class="header-section-number">3.1.3</span> 政党毎の賛成率</h4>
<p>政党でソートし，賛成率を最初の 15 法案についてプロットしたものは次の通り：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb32-2"></span>
<span id="cb32-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 政党ごとの賛成票の割合を計算</span></span>
<span id="cb32-4">party_votes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> s117<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>votes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb32-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb32-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">party =</span> s117<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>legis.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>party) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb32-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(party) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb32-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(. <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)))</span>
<span id="cb32-9"></span>
<span id="cb32-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データを長形式に変換</span></span>
<span id="cb32-11">party_votes_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> party_votes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>party, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vote"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>)</span>
<span id="cb32-12"></span>
<span id="cb32-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DとRのデータのみを抽出</span></span>
<span id="cb32-14">party_votes_d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> party_votes_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(party <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>)</span>
<span id="cb32-15">party_votes_r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> party_votes_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(party <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)</span>
<span id="cb32-16"></span>
<span id="cb32-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Democrats (D) のデータのみをプロット</span></span>
<span id="cb32-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(party_votes_d, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vote "</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, Vote)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb32-21">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.ticks.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb32-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Votes"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of Yea votes"</span>,</span>
<span id="cb32-23">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of Yea votes for Democrats"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Democrats (D) と Republicans (R) のデータを同じプロットに追加</span></span>
<span id="cb33-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> party_votes_d[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vote "</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, Vote)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Democrat"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> party_votes_r[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vote "</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, Vote)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Republican"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Democrat"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Republican"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb33-7">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.ticks.x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb33-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Votes"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of Yea votes"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Party"</span>,</span>
<span id="cb33-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion of Yea votes by Party"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/IdealPoint1_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>民主党の 0-1 がはっきりした投票行動が見られる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1">s109 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readKH</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://voteview.com/static/data/out/votes/S109_votes.ord"</span>,</span>
<span id="cb34-2">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">desc=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"109th U.S. Senate"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Attempting to read file in Keith Poole/Howard Rosenthal (KH) format.
Attempting to create roll call object
109th U.S. Senate 
102 legislators and 645 roll calls
Frequency counts for vote types:
rollCallMatrix
    0     1     6     7     9 
  645 40207 22650     1  2287 </code></pre>
</div>
</div>
</section>
<section id="ベイズ推定" class="level4" data-number="3.1.4">
<h4 data-number="3.1.4" class="anchored" data-anchor-id="ベイズ推定"><span class="header-section-number">3.1.4</span> ベイズ推定</h4>
<p><code>pscl</code> パッケージでは，<code>rollcall</code> オブジェクトに対して <code>ideal()</code> 関数を用いてデータ拡張に基づく Gibbs サンプラーを通じた理想点解析を行うことができる．</p>
<p><a href="https://github.com/atahk/pscl/blob/master/man/ideal.Rd"><code>ideal()</code> 関数のマニュアル</a> に記載された例では <code>maxiter=260E3, burnin=10E3, thin=100</code> での実行が例示されているが，ここでは簡単に実行してみる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(s117<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>legis.data)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb36-2">x0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,n)</span>
<span id="cb36-3">x0[s117<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>legis.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>party<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb36-4">x0[s117<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>legis.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>party<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb36-5"></span>
<span id="cb36-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tictoc)</span>
<span id="cb36-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tic</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ideal() fitting"</span>)</span>
<span id="cb36-8"></span>
<span id="cb36-9">id1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ideal</span>(s117,</span>
<span id="cb36-10">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb36-11">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">startvals=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x0),</span>
<span id="cb36-12">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">normalize=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb36-13">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">store.item=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb36-14">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxiter=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MCMCの反復回数</span></span>
<span id="cb36-15">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">burnin=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>,</span>
<span id="cb36-16">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">thin=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 間引き間隔</span></span>
<span id="cb36-17">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb36-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toc</span>()</span></code></pre></div>
</div>
<p><code>ideal() fitting: 43.938 sec elapsed</code> であった．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(id1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Looking up legislator names and party affiliations
in rollcall object s117 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/IdealPoint1_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><a href="https://github.com/atahk/pscl/blob/master/man/plot.ideal.Rd"><code>plot.ideal()</code> 関数のマニュアル</a> にある通り，<code>shoALLNames = FALSE</code> がデフォルトになっている．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(id1)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 全議員の正確な推定値が見れる．</span></span></code></pre></div>
</div>
<p>もっとも保守的な議員として Trump，５番目にリベラルな議員として Biden の名前がみえる．Harris は中道である．</p>
</section>
</section>
<section id="mcmcpack-パッケージ-1" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="mcmcpack-パッケージ-1"><span class="header-section-number">3.2</span> <code>MCMCpack</code> パッケージ</h3>
<section id="ロジットモデルの推定" class="level4" data-number="3.2.1">
<h4 data-number="3.2.1" class="anchored" data-anchor-id="ロジットモデルの推定"><span class="header-section-number">3.2.1</span> ロジットモデルの推定</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(MCMCpack)</span>
<span id="cb40-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データの生成</span></span>
<span id="cb40-3">x1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 説明変数1</span></span>
<span id="cb40-4">x2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 説明変数2</span></span>
<span id="cb40-5">Xdata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, x1, x2)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># デザイン行列</span></span>
<span id="cb40-6"></span>
<span id="cb40-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 真のパラメータ</span></span>
<span id="cb40-8">true_beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb40-9"></span>
<span id="cb40-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 応答変数の生成</span></span>
<span id="cb40-11">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(Xdata <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> true_beta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(Xdata <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> true_beta))</span>
<span id="cb40-12">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, p)</span>
<span id="cb40-13"></span>
<span id="cb40-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MCMClogitでサンプリング</span></span>
<span id="cb40-15">posterior <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MCMClogit</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x2,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># モデル式</span></span>
<span id="cb40-16">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">burnin =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># バーンイン期間</span></span>
<span id="cb40-17">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mcmc =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MCMCの反復回数</span></span>
<span id="cb40-18">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">thin =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 間引き数</span></span>
<span id="cb40-19">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 進捗表示間隔</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 結果の確認</span></span>
<span id="cb41-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(posterior)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Iterations = 1001:11000
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 10000 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

               Mean      SD  Naive SE Time-series SE
(Intercept)  0.4464 0.07613 0.0007613       0.002471
x1          -0.8935 0.08239 0.0008239       0.002677
x2           0.9617 0.08706 0.0008706       0.002880

2. Quantiles for each variable:

               2.5%     25%     50%     75%   97.5%
(Intercept)  0.2962  0.3953  0.4464  0.4972  0.6027
x1          -1.0560 -0.9485 -0.8931 -0.8391 -0.7310
x2           0.7910  0.9017  0.9608  1.0206  1.1369</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(posterior)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://162348.github.io/posts/2024/TransDimensionalModels/IdealPoint1_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="変化点解析" class="level4" data-number="3.2.2">
<h4 data-number="3.2.2" class="anchored" data-anchor-id="変化点解析"><span class="header-section-number">3.2.2</span> 変化点解析</h4>
<p><span class="citation" data-cites="Chib1998">(Chib, 1998)</span> に基づく変化点モデルのベイズ推定の関数 <code>MCMCpoissonChange()</code> も実装されている．詳しくは <span class="citation" data-cites="Martin+2011">(Martin et al., 2011)</span> 第4節参照．</p>
</section>
</section>
<section id="emirt-パッケージ" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="emirt-パッケージ"><span class="header-section-number">3.3</span> <code>emIRT</code> パッケージ</h3>
<div class="sourceCode" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"emIRT"</span>)</span></code></pre></div>
<p>このパッケージには備え付けの 80-110 議会期の上院における点呼投票データ <code>dwnom</code> がある．</p>
<p>このデータに対して，階層モデルを用いた理想点解析を行う関数 <code>hierIRT()</code> がある．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(emIRT)</span>
<span id="cb45-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(dwnom)</span>
<span id="cb45-3"></span>
<span id="cb45-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## This takes about 10 minutes to run on 8 threads</span></span>
<span id="cb45-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## You may need to reduce threads depending on what your machine can support</span></span>
<span id="cb45-6">lout <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hierIRT</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.data =</span> dwnom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data.in,</span>
<span id="cb45-7">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.starts =</span> dwnom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>cur,</span>
<span id="cb45-8">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.priors =</span> dwnom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>priors,</span>
<span id="cb45-9">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.control =</span> {<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb45-10">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">threads =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb45-11">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb45-12">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">thresh =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span>,</span>
<span id="cb45-13">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,</span>
<span id="cb45-14">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">checkfreq=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb45-15">                        )})</span>
<span id="cb45-16"></span>
<span id="cb45-17"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bind ideal point estimates back to legislator data</span></span>
<span id="cb45-18">final <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(dwnom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>legis, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idealpt.hier=</span>lout<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>means<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x_implied)</span>
<span id="cb45-19"></span>
<span id="cb45-20"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## These are estimates from DW-NOMINATE as given on the Voteview example</span></span>
<span id="cb45-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## From file "SL80110C21.DAT"</span></span>
<span id="cb45-22">nomres <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dwnom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>nomres</span>
<span id="cb45-23"></span>
<span id="cb45-24"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Merge the DW-NOMINATE estimates to model results by legislator ID</span></span>
<span id="cb45-25"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Check correlation between hierIRT() and DW-NOMINATE scores</span></span>
<span id="cb45-26">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(final, nomres, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"senate"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">all.x=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">all.y=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb45-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>idealpt.hier, res<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dwnom1d)</span></code></pre></div>
</div>




</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Arnold2018" class="csl-entry">
Arnold, J. B. (2018). <em><a href="https://jrnold.github.io/bugs-examples-in-stan/"><span class="nocase">Simon Jackman’s Bayesian Model Examples in Stan</span></a></em>.
</div>
<div id="ref-Bafumi+2005" class="csl-entry">
Bafumi, J., Gelman, A., Park, D. K., and Kaplan, N. (2005). <a href="https://doi.org/10.1093/pan/mpi010"><span class="nocase">Practical Issues in Implementing and Understanding Bayesian Ideal Point Estimation</span></a>. <em>Political Analysis</em>, <em>13</em>(2), 171–187.
</div>
<div id="ref-Chib1998" class="csl-entry">
Chib, S. (1998). <a href="https://doi.org/10.1016/S0304-4076(97)00115-2">Estimation and comparison of multiple change-point models</a>. <em>Journal of Econometrics</em>, <em>86</em>(2), 221–241.
</div>
<div id="ref-Imai+2016" class="csl-entry">
Imai, K., Lo, J., and Olmsted, J. (2016). <a href=""><span class="nocase">Fast Estimation of Ideal Points with Massive Data</span></a>. <em>American Political Science Review</em>, <em>110</em>(4), 631–656.
</div>
<div id="ref-Martin-Quinn2002" class="csl-entry">
Martin, A. D., and Quinn, K. M. (2002). <a href="http://www.jstor.org/stable/25791672">Dynamic ideal point estimation via markov chain monte carlo for the u.s. Supreme court, 1953–1999</a>. <em>Political Analysis</em>, <em>10</em>(2), 134–153.
</div>
<div id="ref-Martin+2011" class="csl-entry">
Martin, A. D., Quinn, K. M., and Park, J. H. (2011). <a href="https://doi.org/10.18637/jss.v042.i09"><span class="nocase">MCMCpack: Markov chain Monte Carlo in R</span></a>. <em>Journal of Statistical Software</em>, <em>42</em>(9), 1–21.
</div>
<div id="ref-Zeileis+2008" class="csl-entry">
Zeileis, A., Kleiber, C., and Jackman, S. (2008). <a href="https://www.jstatsoft.org/v27/i08/">Regression models for count data in <span>R</span></a>. <em>Journal of Statistical Software</em>, <em>27</em>(8).
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>“Souter was nominated to the Supreme Court without a significant”paper trail” but was expected to be a conservative justice. Within a few years of his appointment, Souter moved towards the ideological center. He eventually came to vote reliably with the Court’s liberal wing.” <a href="https://en.wikipedia.org/wiki/David_Souter">Wikipedia</a> より引用．↩︎</p></li>
<li id="fn2"><p>１つの議会期 (Congress) は２つの会期 (Session)，第１会期と第２会期から構成される．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Bayesian</category>
  <category>Statistics</category>
  <category>MCMC</category>
  <category>R</category>
  <guid>https://162348.github.io/posts/2024/TransDimensionalModels/IdealPoint1.html</guid>
  <pubDate>Wed, 02 Oct 2024 00:00:00 GMT</pubDate>
  <media:content url="https://162348.github.io/posts/2024/TransDimensionalModels/Images/IPE_experiment.png" medium="image" type="image/png" height="120" width="144"/>
</item>
</channel>
</rss>
