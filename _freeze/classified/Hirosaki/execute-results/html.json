{
  "hash": "d17d8972a01a904b88f09f57e17e55c2",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"BMI と LAB の関係\"\nsubtitle: \"`hirosaki_data` を用いて\"\nauthor: \"司馬博文\"\ndate: 12/9/2024\nexecute: \n  cache: true\n# format:\n#   pdf:\n#     fig-format: png\n#     template-partials:\n#       - ../assets/before-body.tex\n# pdf-engine: lualatex\n# documentclass: ltjsarticle\n# format:\n#   typst:\n#     margin:\n#       x: 1.5em\n#       y: 1.5em\n#     mainfont: \"UDEV Gothic NF\"\n#     fig-format: svg\n---\n\n\n## データの概観\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\nraw_df <- read_excel(\"../../Desktop/NurtureOfMentalism/3-BayesianDataAnalysis/Files/hirosaki_data.xlsx\")\nraw_df\n```\n:::\n\n\n<!--\n\n::: {.cell overflow='wrap'}\n\n```{.r .cell-code}\ncolnames(raw_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  [1] \"ID\"                      \"SEX\"                    \n  [3] \"Height\"                  \"Weight\"                 \n  [5] \"BMI\"                     \"BMI_cate...6\"           \n  [7] \"Age\"                     \"Age_cate\"               \n  [9] \"healty\"                  \"dis_have\"               \n [11] \"med\"                     \"LD_cate\"                \n [13] \"bp_cate\"                 \"db_cate\"                \n [15] \"hf_cate\"                 \"UA_cate\"                \n [17] \"BMI_cate...17\"           \"bp_cate2\"               \n [19] \"db_cate2\"                \"hf_cate2\"               \n [21] \"UA_cate2\"                \"pregnant\"               \n [23] \"pasemaker\"               \"artificial joint\"       \n [25] \"high_bp\"                 \"low_bp\"                 \n [27] \"bp_cate3\"                \"Umbilical_circumference\"\n [29] \"Visceralfat_cate\"        \"WBC\"                    \n [31] \"RBC\"                     \"hemo\"                   \n [33] \"hemato\"                  \"MCV\"                    \n [35] \"MCH\"                     \"MCHC\"                   \n [37] \"Stab\"                    \"Seg\"                    \n [39] \"Lympho\"                  \"Mono\"                   \n [41] \"Eosino\"                  \"Baso\"                   \n [43] \"platelet\"                \"HbA1c\"                  \n [45] \"bilirubin\"               \"AST\"                    \n [47] \"ALT\"                     \"GTP\"                    \n [49] \"Tprotein\"                \"creatinine...50\"        \n [51] \"UN\"                      \"UA\"                     \n [53] \"T_Cholesterol\"           \"TG\"                     \n [55] \"Na\"                      \"K\"                      \n [57] \"CL\"                      \"Ca\"                     \n [59] \"P\"                       \"Mg\"                     \n [61] \"Fe\"                      \"IronBindCapa\"           \n [63] \"BloodSugar\"              \"HDL\"                    \n [65] \"ALB\"                     \"Unsaturatedironbindcapa\"\n [67] \"IgA\"                     \"IgG\"                    \n [69] \"IgM\"                     \"C3\"                     \n [71] \"C4\"                      \"ApoA\"                   \n [73] \"ApoB\"                    \"ApoE\"                   \n [75] \"LDL\"                     \"Lpa_co\"                 \n [77] \"AG_co\"                   \"hyaluronicacid_co\"      \n [79] \"RLP_c_co\"                \"glycoalbumin\"           \n [81] \"MMP3_co\"                 \"CRP_co\"                 \n [83] \"cystatinC\"               \"LRG_co\"                 \n [85] \"ALP\"                     \"P1NP\"                   \n [87] \"FAT\"                     \"insulin_co\"             \n [89] \"HBs\"                     \"ferritin\"               \n [91] \"CCP_co\"                  \"Cpeptide\"               \n [93] \"COI\"                     \"creatinine...94\"        \n [95] \"B2MG\"                    \"NA_U\"                   \n [97] \"K_U\"                     \"BUN_u\"                  \n [99] \"alubumin\"                \"creatinine...100\"       \n[101] \"deoxypyridinoline\"       \"cortisol\"               \n[103] \"aldosterone_U\"           \"ABI_ave\"                \n[105] \"heartrate\"               \"CAVI_ave\"               \n[107] \"vascularage_ave\"         \"sLOX1_100\"              \n[109] \"LAB_100\"                 \"LOXindex_100\"           \n[111] \"Risk\"                    \"LOX1_retest\"            \n[113] \"LAB_retest\"              \"LOXindex_retest1\"       \n[115] \"LOX1_retest_100\"         \"LAB_retest_100\"         \n[117] \"LOXindex_retest1_100\"    \"LOX1_color\"             \n[119] \"LAB_color\"               \"LOXindex_color\"         \n[121] \"LOX1_color_100\"          \"LAB_color_100\"          \n[123] \"LOXindex_color_100\"      \"Smoke\"                  \n[125] \"Smoke_count\"             \"Passive_smoking\"        \n[127] \"Exercise_Habits\"         \"Sleep_Time\"             \n[129] \"Sleep_Quolity\"           \"Sleep_Trable\"           \n[131] \"LifeQuolity_Mental\"      \"FFQ_kcal\"               \n[133] \"FFQ_Protein\"             \"FFQ_Fat\"                \n[135] \"FFQ_FattyAcid\"           \"FFQ_Carbo\"              \n[137] \"FFQ_Fiber\"               \"FFQ_K\"                  \n[139] \"FFQ_Ca\"                  \"FFQ_Fe\"                 \n[141] \"FFQ_Carotene\"            \"FFQ_Vit6\"               \n[143] \"FFQ_VitB12\"              \"FFQ_FolicAcid\"          \n[145] \"FFQ_VitC\"                \"FFQ_Salt\"               \n[147] \"FFQ_n3FattyAcids\"        \"FFQ_n6FattyAcids\"       \n[149] \"FFQ_Isoflavones\"         \"FFQ_LipidEnergyRatio\"   \n[151] \"FFQ_Grain\"               \"FFQ_Potatoes\"           \n[153] \"FFQ_Beans\"               \"FFQ_vegs\"               \n[155] \"FFQ_YAGvegs\"             \"FFQ_Fruits\"             \n[157] \"FFQ_Mushroom\"            \"FFQ_Algae\"              \n[159] \"FFQ_Fishes\"              \"FFQ_Meats\"              \n[161] \"FFQ_Egg\"                 \"FFQ_Milk\"               \n[163] \"FFQ_AlcoholicDrinks\"    \n```\n\n\n:::\n:::\n\n-->\n\n初めに `BMI` を３つのカテゴリに分類して解析する．\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nraw_df <- raw_df %>%\n  mutate(BMIcate_3 = case_when(\n  BMI < 18.5 ~ \"underweight\",\n  BMI < 25 ~ \"normal\",\n  BMI >= 25 ~ \"obese\",\n  TRUE ~ \"E\"\n  ))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nboxplot(\n  raw_df$LAB_color_100 ~ raw_df$BMIcate_3,\n  col = c(\"gray\", \"pink\", \"skyblue\"),\n  main = \"LAB classified by BMI\",\n  xlab = \"BMI\",\n  ylab = \"LAB\"\n)\n```\n\n::: {.cell-output-display}\n![](Hirosaki_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## 多項ロジスティック回帰\n\nまずはデフォルトのまま適用してみる．\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(brms)\nlogit_model <- bf(\n  BMIcate_3 ~ LAB_color_100,\n  family = categorical(link = \"logit\")\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(knitr) # used for the \"kable\" command\nkable(get_prior(logit_model, data = raw_df))\n```\n\n::: {.cell-output-display}\n\n\n|prior                |class     |coef          |group |resp |dpar          |nlpar |lb |ub |source  |\n|:--------------------|:---------|:-------------|:-----|:----|:-------------|:-----|:--|:--|:-------|\n|                     |b         |              |      |     |muobese       |      |   |   |default |\n|                     |b         |LAB_color_100 |      |     |muobese       |      |   |   |default |\n|student_t(3, 0, 2.5) |Intercept |              |      |     |muobese       |      |   |   |default |\n|                     |b         |              |      |     |muunderweight |      |   |   |default |\n|                     |b         |LAB_color_100 |      |     |muunderweight |      |   |   |default |\n|student_t(3, 0, 2.5) |Intercept |              |      |     |muunderweight |      |   |   |default |\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_logistic <- brm(\n  logit_model,\n  data = raw_df,\n  chains = 4, iter = 5000, cores = 4\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(model_logistic)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Family: categorical \n  Links: muobese = logit; muunderweight = logit \nFormula: BMIcate_3 ~ LAB_color_100 \n   Data: raw_df (Number of observations: 839) \n  Draws: 4 chains, each with iter = 5000; warmup = 2500; thin = 1;\n         total post-warmup draws = 10000\n\nRegression Coefficients:\n                            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS\nmuobese_Intercept              -2.05      0.31    -2.67    -1.45 1.00     9617\nmuunderweight_Intercept        -1.76      0.48    -2.71    -0.83 1.00    10574\nmuobese_LAB_color_100           0.30      0.07     0.16     0.44 1.00    10179\nmuunderweight_LAB_color_100    -0.12      0.13    -0.37     0.13 1.00     9694\n                            Tail_ESS\nmuobese_Intercept               7171\nmuunderweight_Intercept         7415\nmuobese_LAB_color_100           7771\nmuunderweight_LAB_color_100     7490\n\nDraws were sampled using sampling(NUTS). For each parameter, Bulk_ESS\nand Tail_ESS are effective sample size measures, and Rhat is the potential\nscale reduction factor on split chains (at convergence, Rhat = 1).\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(model_logistic)\n```\n\n::: {.cell-output-display}\n![](Hirosaki_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n結構 obese と underweight で効果が非対称なのがわかる．肥満のリスクは上がるが，「痩せるリスク」というのはあまり変わらないように思える．\n\n係数の事前分布を正規分布に変更した場合を考えてみる．\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprior_normal <- c(\n  set_prior(\"normal(0, 2)\", class = \"b\", coef = \"LAB_color_100\", dpar = \"muobese\"),\n  set_prior(\"normal(0, 2)\", class = \"b\", coef = \"LAB_color_100\", dpar = \"muunderweight\")\n)\nmodel_logistic_normalprior <- update(model_logistic, prior = prior_normal)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(model_logistic_normalprior)\n```\n\n::: {.cell-output-display}\n![](Hirosaki_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n### 事後予測チェック\n\n２種類の事前分布を用いたから，そのどちらが適切かを事後予測チェックで確認する．\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\npp_check(model_logistic, type=\"bars\", ndraws=NULL) + \n  scale_x_discrete(\"BMI\", breaks=c(1,2,3), labels=c(\"underweight\", \"normal\", \"obese\")) + \n  ylab(\"LAB\") + ggtitle(\"Posterior predictive check\", \"Uniform prior\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nScale for x is already present.\nAdding another scale for x, which will replace the existing scale.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](Hirosaki_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npp_check(model_logistic_normalprior, type=\"bars\", ndraws=NULL) + \n  scale_x_discrete(\"BMI\", breaks=c(1,2,3), labels=c(\"underweight\", \"normal\", \"obese\")) + \n  ylab(\"LAB\") + ggtitle(\"Posterior predictive check\", \"Normal prior\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nScale for x is already present.\nAdding another scale for x, which will replace the existing scale.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](Hirosaki_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gridExtra)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- pp_check(model_logistic, ndraws=NULL) + theme(legend.position = \"none\")\np2 <- pp_check(model_logistic_normalprior, ndraws=NULL) + theme(legend.position = \"none\")\ngrid.arrange(p1, p2, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](Hirosaki_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nほとんど変わらないように思われる．係数の事前分布を正規分布にするか，一様分布（デフォルト）のままにするかは（予測の観点からは）ほとんど影響がないと見て良いだろう．\n\n## BMI への回帰\n\n`BMI` を３カテゴリに分けてロジスティック回帰を行うと，モデルの非線型性から変数の選択が少し困難になるため，`BMI` そのものを回帰することを考える：\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlinear_model <- lm(\n  BMI ~ LAB_color_100 * LDL,\n  data = raw_df\n)\nsummary(linear_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = BMI ~ LAB_color_100 * LDL, data = raw_df)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-7.6230 -2.2672 -0.4406  2.1128 16.0498 \n\nCoefficients:\n                   Estimate Std. Error t value Pr(>|t|)    \n(Intercept)       18.396284   1.582141  11.627   <2e-16 ***\nLAB_color_100      0.937527   0.405151   2.314   0.0209 *  \nLDL                0.023515   0.013380   1.757   0.0792 .  \nLAB_color_100:LDL -0.003691   0.003132  -1.179   0.2388    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 3.4 on 835 degrees of freedom\nMultiple R-squared:  0.0441,\tAdjusted R-squared:  0.04066 \nF-statistic: 12.84 on 3 and 835 DF,  p-value: 3.305e-08\n```\n\n\n:::\n:::\n\n\n`LAB_color_100` と `LDL` は強い共線型性を持つため，この結果はあまり意味を持たないと思って良い．\n\n### 分散分析\n\n`LAB_color_100` と `LDL` の２つの変数に関して分散分析を行なってみる．\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(BayesFactor)\n```\n:::\n\n\n`generalTestBF` 関数を用いて，特定の変数のみをモデルに含めた場合のベイズ因子の値を計算することができる：\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbf = generalTestBF(\n  formula = BMI ~ LAB_color_100 + LDL + LAB_color_100 * LDL,\n  data = raw_df,\n  whichModels = \"all\"\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: data coerced from tibble to data frame\n```\n\n\n:::\n\n```{.r .cell-code}\nbf\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nBayes factor analysis\n--------------\n[1] LAB_color_100                           : 695269.2 ±0%\n[2] LDL                                     : 2925.818 ±0.01%\n[3] LAB_color_100:LDL                       : 610709.4 ±0%\n[4] LAB_color_100 + LDL                     : 481116.4 ±0%\n[5] LAB_color_100 + LAB_color_100:LDL       : 209337.9 ±0.01%\n[6] LDL + LAB_color_100:LDL                 : 69213.86 ±0.01%\n[7] LAB_color_100 + LDL + LAB_color_100:LDL : 125175.6 ±0%\n\nAgainst denominator:\n  Intercept only \n---\nBayes factor type: BFlinearModel, JZS\n```\n\n\n:::\n:::\n\n\n[1] が最大で，[3] が少し遅れて次点である．`LDL` より `LAB_color_100` が `BMI` をよく予測することがわかる．\n\n交差項 `LDL*LAB_color_100` を入れてもモデルの予測力は上がるわけではないが，邪魔をするわけでもない．`LDL`, `LAB_color_100` には線型な相関があることを踏まえると，`LAB_color_100` の二次の効果もあまりないと思われる．\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncross_term_model <- lmBF(\n  formula = BMI ~ LAB_color_100 + LDL + LAB_color_100 * LDL,\n  data = raw_df\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: data coerced from tibble to data frame\n```\n\n\n:::\n\n```{.r .cell-code}\nchains <- posterior(cross_term_model, iterations = 10000)\nplot(chains[,2])\n```\n\n::: {.cell-output-display}\n![](Hirosaki_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(chains[,3:4])\n```\n\n::: {.cell-output-display}\n![](Hirosaki_files/figure-html/unnamed-chunk-19-2.png){width=672}\n:::\n:::\n\n\n`LAB_color_100` の係数は $1$ 前後が推定されているが，そのほかの係数はほとんど $0$ にまで縮小されていることがわかる．\n\nこれもやはり `LAB_color_100` 以外の変数が追加の予測力を持たないことを示している．\n\n<!--\n\n::: {.cell}\n\n```{.r .cell-code}\nposterior_samples <- as.data.frame(as.matrix(chains))\ncolnames(posterior_samples)[2:4] <- c(\"LAB\", \"LDL\", \"LAB*LDL\")\n\nposterior_long <- posterior_samples %>%\n  dplyr::select(`LAB`, `LDL`, `LAB*LDL`) %>%\n  tidyr::pivot_longer(\n    cols = everything(),\n    names_to = \"x\",\n    values_to = \"y\"\n  )\nggplot(posterior_long, aes(x = y, fill = x, color = x)) +\n  geom_density(alpha = 0.4) +\n  labs(\n    title = \"Posterior Distributions of Effects\",\n    x = \"Coefficient Value\",\n    y = \"Density\"\n  ) +\n  scale_fill_manual(values = c(\"pink\", \"skyblue\", \"yellow\")) +\n  scale_color_manual(values = c(\"pink\", \"skyblue\", \"yellow\")) +\n  xlim(-0.1, 0.5) +\n  ylim(0, 10) +\n  theme_minimal()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 8479 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](Hirosaki_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n-->\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}