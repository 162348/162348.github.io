---
title: "粒子フィルターとは何か | About Particle Filter"
author: "Hirofumi Shiba"
date: "11/25/2023"
date-modified: "12/15/2023"
categories: [Particles, Survey, Computation]
toc: true
number-sections: true
twitter-card: true
image: cover_LowResolution.jpg
bibliography: ../../../mathematics.bib
csl: ../../../apa.csl
abstract-title: 概要
abstract: 粒子フィルターは今年で誕生30周年を迎える「万能」非線型フィルタリング手法である．相関を持つ粒子系によって分布を逐次的に近似する遺伝的アルゴリズムであり，多くの科学分野にまたがる応用を持つと同時に，数理的対象としても豊かな構造を持つ．その発明の歴史と今後の研究方向を紹介する．
crossref:
    sec-prefix: 節
    eq-prefix: 式
---

{{< include ../../../_preamble.qmd >}}

## フィルタリング問題の歴史

### フィルタリング（濾波）問題とは何か？

フィルタ（濾波器）の第一義は，液体から不純物を取り除くための装置である．そのアナロジーで「フィルタリング問題」と言った場合は，信号処理の意味で電圧や電波の信号を「濾過」してノイズを除去し本当に注目したい部分を純粋化する営みのことを指す．凡ゆる通信機器において装置の熱運動によるノイズが入ることは避けられぬ自然の摂理であり，フィルタリング問題は普遍的な課題である．^[[@Anderson-Moore1979-OptimalFiltering] 第1.1節．]

Gauss は天体観測の経験から「誤差論」と最小二乗法を発明し，これが現代の統計的推定理論の先駆けとなった．これと同じように，通信と制御の分野では「時々刻々と受信するデータから時々刻々と変化する信号をどのようにうまく濾波するか」という独自の課題から，独自の理論が発展していった．^[[@有本卓1970]．]

特に，デジタル回路がない時代では，「どのような電気回路のシステムとして濾波機をデザインすれば良いか？」という電気工学的な回路設計の問題としての側面も大きかった．

### 最初のフィルタリング理論

このアナログフィルタの時代で，フィルタリングの問題を統計的技術で解くための理論^[このフィルタリング問題の統計的な側面を，前述の電気工学的な側面から区別して，stochastic filteringと呼んだりもする．] が，まず離散時間の場合が [@Kolmogorov1941]，続いて連続時間の場合が [@Wiener1949] によって模索された．^[[@Bain-Crisan2009-StochasticFiltering] 1.3節．]

しかし，この Kolmogorov と Wiener 理論では「信号とノイズの過程が定常である」という仮定の下で展開されており，この**定常性の制約が Kolmogorov-Wiener 理論の広い応用を阻んでいた**．

だがこれは，「当時の技術（抵抗器やコンデンサーなど）で実装出来る範囲」という制約がある上で考えられた理論としては，仕方ないことでもあった．更なる理論的発展も，デジタル技術の登場を待つ必要があった．

### デジタルフィルタリングの登場

トランジスタというデジタル技術が使われるようになり，集積回路の製造技術が発達すると，「フィルタ（濾波器）」はアナログデジタル変換器，レジスタ，メモリ，マイクロプロセッサから構成された**デジタルフィルタが主に使われるようになった**．アナログフィルタから物理的な姿は全く変わり，もはや肉眼では見えない装置になってしまったのである．^[[@青山友紀1986] 「当初は大型コンピュータを用いたシミュレーションの技法であったディジタルフィルタが，今では超LSI 1チップで実現されるまでになった．」他にも，発表時1986年では，音声信号を中心とする低周波帯域ではデジタルフィルタがアナログフィルタを駆逐しつつあること，通信システムのデジタル化に伴ってこの勢いは完全に代替するまで進むだろうとの筆者の考えが述べられている．]

その中で [@Kalman1960] が，定常性の仮定が満たされない場合でも使えるアルゴリズムである [**カルマンフィルター**](https://ja.wikipedia.org/wiki/%E3%82%AB%E3%83%AB%E3%83%9E%E3%83%B3%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%BC) を提案すると，すぐに Apollo 計画に導入されてスペースシャトルの制御へ実用化され，更には海軍の潜水艦などにも応用されていった．^[[@NASA1985] がNASAからの資料．また，[@DelMoral-Penev2014] も参照．加えて，[@Kalman1960] からちょうど10周年の文献 [@有本卓1970] に当時の雰囲気も感じさせる良いサーベイがある．]

あらゆるシステムがデジタル化されていく中で，アナログフィルタは徹底的にデジタルフィルタに代替されるようになった．これに伴い，現代でフィルタリング問題と言った場合，**現在 $t$ までの観測 $Y_1,\cdots,Y_t$ からノイズを除去してメッセージ部分 $X_t$ をなるべく正確に推定するアルゴリズム** という完全に数学的で抽象的な存在として研究が進められていくことになる．

### 状態空間モデルという語彙

Kalman の論文 [@Kalman1960] の新規性はアルゴリズムだけではなく，[**状態空間モデル**](../Surveys/SSM.qmd#sec-SSM) という枠組みを導入し，**どのようなシステムに適用可能かに関する共通言語を提供した**ことが，即時的な応用に寄与した面もあるだろう．^[[@Ristic+2004 p.3] "The state-space approach is convenient for handling multivariate data and nonlinear/non-Gaussian processes and it provides a significant advantage over traditional time-series techniques for these problems."] 例えばこの語彙に従えば，「Kalman filter は状態空間モデルが線型正規であれば最適なフィルタリング手法」ということになる．

この状態空間モデルの枠組みと同様なものが [@Baum-Petrie1966] によって隠れ Markov モデルとして展開され，こちらは [@Baker1975] により音声認識に応用された．現代でも多くの音声認識システムは隠れ Markov モデルに基づく．^[[@Rabiner1989]．[@Gales-Young2007] には "almost all present day large vocabulary continuous speech recognition (LVCSR) systems are based on HMMs" とある．]

状態空間モデルはその後，[@Akaike1974] で時系列モデリングに応用され，再び統計学の分野と深く関わるようになる．^[[@Kitagawa1998] で指摘されている．]

### カルマンフィルターの限界 {#sec-EKF}

しかし Kalman filter にも大きな制約があった．それは **モデルに線型かつ正規であるという大きな制約があった** ということである．一方で現実のシステムは殆どが非線型性を持つ．

そこで NASA の [Ames 研究センター](https://ja.wikipedia.org/wiki/%E3%82%A8%E3%82%A4%E3%83%A0%E3%82%BA%E7%A0%94%E7%A9%B6%E3%82%BB%E3%83%B3%E3%82%BF%E3%83%BC) ではすぐに [**拡張 Kalman フィルタ**](https://en.wikipedia.org/wiki/Extended_Kalman_filter) と共分散行列の二乗根を保持する実装が考案され，これが本当の意味で Kalman フィルターを実用に耐えるものにした [@NASA1985]．^[また，同様にアポロ計画の中で，飛行体に載積出来るような小規模な計算資源と短い単語長でも安定してKalman filterが動くように，共分散行列の二乗根を保持するという "square-root" formulation of the filter が 1972年に考案されたことが，summary でも触れられている [@NASA1985]．]

だが，「拡張」の名前の通り本質的な解決とは言えず，システムの非線型性が強い場合は性能が伸びない．^[[@Julier-Uhlmann2004 p.402] など．拡張 Kalman filter は遷移関数を線型近似することに基づく．よって Jacobi 行列の計算が必要であり，このため **解析的方法** とも呼ばれる [@Ristic+2004 p.21]．よって遷移関数が可微分でない場合も実行不可能である．とはいっても，拡張 Kalman filter はナビゲーションシステムや GPS のデファクトスタンダードである [Wikipedia](https://en.wikipedia.org/wiki/Extended_Kalman_filter#Disadvantages_and_alternatives)．[@Ristic+2004] 第7章では距離のみでの追跡 (range-only tracking) では拡張 Kalman filter の性能と大差なく，計算量の問題から EKF の選択を推奨している．第8章でも弾道物体追跡の問題で，限られた設定では粒子フィルターと同等の性能を見せている．] こうして，計算機や情報通信技術の発展と共に複雑化していくシステムに併せて，様々なフィルターが考案されていく必要があるのである．統計計算の時代の黎明である．

### 非線型性・非正規性という強敵

実は，1960年に開発された Kalman filter を真に超克する手法は，1990年代に入るのを待つ必要がある．他のシミュレーションに基づく [ベイズ計算手法](../Surveys/BayesianComp.qmd#sec-MCMC-SMC) と同じく，計算機の十分な発達を待つ必要があったのである．

というのも，Kalman filter は，線型正規状態空間モデルの下でフィルタリング分布
$$
\L[X_t|Y_1,\cdots,Y_t]
$$ {#eq-filtering-distribution}
は再び正規分布であり，平均と共分散という２つの量のみで完全に特徴付けられるため，これらのみを考慮し，微分方程式を解いて更新規則を事前に得ておくことで，計算量を大幅に削減することが出来る，というトリックに基づく．

このように線型性と正規性が同在する状況，または状態空間が有限であるなどの限られた状況でない限り，フィルタリング分布 @eq-filtering-distribution は有限次元の十分統計量を持たない．^[[@Ristic+2004 p.16]．]

従って，一般の状況に対応出来るフィルタには，上述のような計算量削減のトリックは絶対に存在せず，正面から分布 @eq-filtering-distribution を近似する方法を考える必要がある．これには新しいアイデアが必要であると同時に，一定の性能を持つ計算機の出現を待つ必要もあったのである．

### 種々の近似戦略

フィルタリング分布 @eq-filtering-distribution
$$\bP_t(X_t\in dx_t):=\L[X_t|Y_{0:t}]$$
は Bayes の定理を通じて再帰的な関係
$$
\begin{align*}
    &\bP_{t-1}(X_t\in dx_t|Y_{0:t-1})\\
    &=\int_{x_{t-1}\in E}\bP_{t-1}(X_{t-1}\in dx_{t-1}|\\
    &\qquad Y_{0:t-1}=y_{0:t-1})P_t(x_{t-1},dx_t),\\
    &\bP_t(X_t\in dx_t|Y_{0:t}=y_{0:t})\\
    &=\frac{1}{p_t(y_t|y_{0:t-1})}f_t(x_t|y_t)\\
    &\qquad\bP_{t-1}(X_t\in dx_t|Y_{0:t-1}=y_{0:t-1}).
\end{align*}
$$
を満たすが，この積分を計算する必要がある．^[この結果は [@Chopin-Papaspiliopoulos20-SMC] 第5章 など．記法 $Y_{0:t}$ は [本サイトの数学記法一覧](../Surveys/Notations.qmd#sec-tuples) を参照]

粒子フィルターでは相関を持った粒子系により，これらの値を逐次的に近似していくが，このアルゴリズムが出来る前に提案された近似手法を総覧する．

#### 解析的な方法

@sec-EKF で紹介した拡張 Kalman filter は，モデルが線型に近い場合には有効な近似手法であるが，一致推定量にはならない．この点を修正するために，線型近似の誤差を修正する IEKF (Iterated EKF) などが開発された．

#### 数値積分による方法

状態空間 $E$ の次元が3以下である場合，積分は数値積分法によっても効率的に近似できる [@Kitagawa1987]．^[[@Crisan-Doucet2002] に3の数字が例示されている．]

特に状態空間が有限である場合は積分は加法に退化するため，正確に実行することができる．^[[@Chopin-Papaspiliopoulos20-SMC] 第6章，[@Ristic+2004] 2.2節．] この場合が隠れMarkovモデルに当たる．

隠れMarkovモデルに於て MAP 推定量を動的計画法に基づいて探索する Viterbi 算譜 [@Forney1973], [@Viterbi1982] とパラメータ推定のための EM アルゴリズムの変種 Baum-Welch 算譜 [@Baum-Eagon1967], [@Gopalakrishnan+1989] とは音声認識の分野で広く使われており，また状態空間が近似的に離散である場合にも近似手法として採用される．^[[@Ristic+2004 p.24]．]

#### Gauss混合で近似する方法

フィルタリング分布 @eq-filtering-distribution を正規分布の有限混合で近似する方法は **Gaussian sum filter** と呼ばれる [@Sorenson-Alspach1971]．これは多峰性を帯びる事後分布のモデリングに強く，物体追跡の分野で広く使われることとなったが，一般の設定に使える普遍的な手法ではなかった．^[[@Ristic+2004 p.25]．]

#### アンサンブルによる近似

フィルタリング分布 @eq-filtering-distribution を正規分布を表現する決定論的に設計された粒子系によって近似し，これをシステムモデルに従って伝播させる．これにより，フィルタリング分布の2次以下の積率までは性格に近似できていることになる．この手法を **無香 Kalman filter** (Unscented Kalman filter) という [@Julier+2000], [@Julier-Uhlmann2004]．

この手法は，宇宙から大気圏に再突入する弾道物体の追跡などの場面で，粒子フィルターよりやや正確性が劣るが計算が速く，実用的であることも知られている [@Ristic+2004 p.101]．

この手法は本質的に [@Evensen1994] の EnKF (Ensemble Kalman filter) によって拡張された（ @sec-EnKF も参照）．

## 粒子フィルターの発明

線型性や正規性の仮定を **全く** 必要とせず，あらゆる状態空間モデルに使えて，加えて高次元でも適用可能な夢の新フィルタリング手法は，**確率的シミュレーションを利用する Monte Carlo 法の一種** であった．[@Gordon+1993] はこれを bootstrap filter という名前で発表し，角度観測のみを用いた物体追跡の問題 (bearings-only tracking) への応用も付した．

実は，この bearings-only tracking は極めて非線型性が強い問題として古典的なものであり，従来の拡張 Kalman filter の方法では精度が全く伸びなかった．これに比べて **bootstrap filter では圧倒的な性能改善が見られた**のであった．^[[@Gordon+1993] の結果であると同時に，[@Ristic+2004] 第6章でも種々の手法と比較した数値実験がなされている．一方第7章にて，距離のみでの追跡 (range-only tracking) では拡張 Kalman filter の性能と大差なく，計算量の問題から EKF の選択を推奨している．]

それだけでなく，この手法はフィルタリング問題の範疇を超えて広範な応用先を見つけつつあり，MCMC と並ぶ [ベイズ計算法](../Surveys/BayesianComp.qmd#sec-MCMC-SMC) となっている（ @sec-non-sequential ）．

なお，北川源四郎も同年（1993年）のカンファレンスにて，Monte Carlo filter の名前で同様のアルゴリズムを発表している．そのジャーナル版は [@北川1996]．^[[Del MoralのWebサイト](https://people.bordeaux.inria.fr/pierre.delmoral/simulinks.html)も歴史的背景に詳しい．] 日本語文献 [@北川源四郎1996-統計数理] は[ウェブ上からも読める](https://www.ism.ac.jp/editsec/toukei/pdf/44-1-031.pdf)．

### 逐次重点サンプリングの修正としての粒子フィルター

この手法は [重点サンプリング](../Surveys/BayesianComp.qmd#sec-importance-sampling) を繰り返すという逐次重点サンプリングの改良として開発された．逐次重点サンプリングのアイデアは古く，[@Hammersley-Morton1954] で提案され，[@Mayne1966], [@Handschin-Mayne1969] で逐次推定に応用された．

しかし，これには荷重の分散が指数増大するという致命的な欠点があった [@Chopin2004]．特に何度か反復を経ると，１つの粒子を除いて他の粒子は全て荷重を殆ど持たなくなってしまうという現象が起こる [@DelMoral-Doucet2003]．このように，荷重の分散が大きくなり，少数の粒子しか推定に関与しなくなる現象を **荷重の縮退** という．^[weight degeneracy [@Creal2011] p.253，[@Cappe+2005] 第7章，[@Robert-Casella04-MonteCarlo p.551] 14.3.3節 など．] 

そこで，[@Rubin1987] のアイデアを基に，^[SIR (Sampling/Importance Resampling) Algorithm と呼ばれるものであった．これの逐次化が粒子フィルターだとみなせる [@Robert-Casella04-MonteCarlo p.552] 14.3.4節．] **リサンプリング** という新たな機構を取り入れることを考える．これは **遺伝的変異・選択機構** とも呼ばれ，^[[@DelMoral-Doucet2014] などの用語である．] 尤度の高い粒子を複製する一方で尤度の低い粒子は削除するというものである

これにより定期的に荷重をリセットすることで分散の指数増大を抑えることができ，が保たれるのである．しかしながらこの仕組みにより粒子の間に相関が生じるために，理論的解析を困難にする．この点から粒子フィルターは **（平均場）相関粒子法** ともいう．^[[@DelMoral-Horton2023-EnKF] では mean-field type interacting particle methods と呼んでいる．呼び方については [@Iba2001] と [@DelMoral13-MeanFieldSimulation] と [紹介記事](../Particles/DelMoral2013.qmd#sec-names) も参照．]

リサンプリング機構の分計算負荷は上がるが，1990年代では計算機の性能はすでにこれを補って余りある段階に達していたのである．なお，[@Gordon+1993] はリサンプリング手法としては多項リサンプリングを採用しており，極めて実装が簡単という点も多くの応用を生んだ理由である．^[[@Creal2011] p.256．]

リサンプリングの実際の実装については，[粒子フィルターの実装の稿](../Particles/ParticleFilter.qmd) も参照．

### 粒子フィルターの応用

[@Gordon+1993] による粒子フィルターの考案は，物体追跡（と防衛目的）への応用が念頭にあり，この分野では粒子フィルターが極めて有効である [@Ristic+2004]．これは非線型性をものともしない性質に加えて，事前情報を柔軟に取り入れやすいという粒子フィルターの性格も大きく貢献している．^[事前情報というのは，自動運転の文脈では自動車が動き得る領域というのは極めて限られている，というような事前に判明しているが，うまく取り入れにくい情報のことをいう．[@Ristic+2004] 第6章や第9章で繰り返し種々の設定で実証されている．[@Yang+2023] は水中での物体追跡が縮退により従来は粒子フィルタが使えなかった問題の解決を試みている．[@Kummert+2021] はロボット支援を用いた手術中に物体追跡を利用する際に，尤度が低すぎるなどの要素から追跡対象を失った状態を検出してアラートを出す機構を開発している．]

コンピュータビジョンへの応用も早期から取り組まれており [@Isard-Andrew1998]，これに続いてロボティクス，HCI (Human-Computer Interaction) 分野への応用もなされている [@岡2005], [@Wills-Schon2023]．

一方で，[@北川1996] は季節調整モデルなど非定常時系列への応用が念頭にあった．確率的ボラティリティモデルなど，ファイナンスで扱う時系列は非線型性・非正規性を示すと同時にデータ数も多い．逐次推定のステップ数が増えようとも誤差が蓄積しない粒子フィルターが見事に推定を実行する．^[ファイナンスにおける確率的ボラティリティモデルなどの例が挙げられている [@Creal2011] p.256．]

加えて，マクロ経済学の分野で [動学的確率的一般均衡モデル (DSGE)](https://en.wikipedia.org/wiki/Dynamic_stochastic_general_equilibrium) の推定にも応用されている．DSGE は非線型なミクロ経済学的モデルの上に構築された大規模なモデルで，
従来は [MCMC](../Surveys/BayesianComp.qmd#sec-MCMC) を用いたベイズ推論が実行されていたが，粒子フィルターに焼戻し法や並列計算を組み合わせることでこの問題を回避でき，さらに事後分布が多峰性を持つ場合でも有用である [@Herbst-Schorfheide2013]．^[粒子フィルターの経済学での応用が増えたきっかけが Fernández-Villaverde and Rubio-Ramírez (2005, 2007) による（小規模な）DSGEモデルの推定への応用だった [@Creal2011 p.246]．[@矢野2014] は実物景気循環モデル (Real Business Cycles Model) への応用を解説している．]

近年では他の社会科学分野でもベイジアンモデリングが用いられ（[ベイズ計算の稿](../Surveys/BayesianComp.qmd#sec-BayesianModeling) 参照），粒子フィルターも [エージェント・ベースド・モデル](https://ja.wikipedia.org/wiki/%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%83%BB%E3%83%99%E3%83%BC%E3%82%B9%E3%83%BB%E3%83%A2%E3%83%87%E3%83%AB) への応用などが試みられている [@Lux2018]．

### 粒子フィルターの一般の推定問題への応用 {#sec-non-sequential}

こうして，粒子フィルターは非正規・非線型フィルタリング問題の解決のために開発されたアルゴリズムであったが，**非線型フィルタリングに限らず極めて広い問題へと応用出来る**ことが徐々に明らかになった．

特にサンプラーとしても極めて有効であり（ @sec-SMC-Samplers ），粒子フィルターは MCMC と併せて [ベイズ計算](../Surveys/BayesianComp.qmd) の主要トピックの１つに躍り出た [@Martin+2023-history p.11]．この意味で，粒子フィルターは広く **逐次 Monte Carlo 法**（Sequential Monte Carlo methods 略して **SMC** ）とも呼ばれる．^[[@Crisan-Doucet2002] ではすでに SMC とも呼ばれることが記されている．[@Chopin-Papaspiliopoulos20-SMC] 第3章にSMCのフィルタリング以外の多くの応用が紹介されている．] 

#### ベイズ学習

逐次的でない「静的」な設定の下での Bayes 推論に SMC を用いる方法は [@Chopin2002] が草分け的な仕事をした．この枠組みでは，Bayes 事後分布 $\pi(\theta|y_1,\cdots,y_N)$ の近似において，途中の $\pi(\theta|y_1,\cdots,y_n)$ を経由して逐次的に近似することが，自然な計算コスト削減法として理解できる．

#### サンプラーとしてのSMC {#sec-SMC-Samplers}

複雑な分布からのサンプリングや，その正規化定数の計算という MCMC と同様の用途に SMC を使うこともできる [@DelMoral+2006]．

SMC は **調音 (tempering)** を通じてサンプリング問題に応用される．これは目標の分布 $\pi_p\in\cP(E)$ に対して，これに至る $\cP(E)$ 上の道
$$
[p]\ni n\mapsto\pi_n\in\cP(E)
$$
を通じて，より簡単な分布 $\pi_1,\pi_2,\cdots$ から逐次的にサンプリングをするというアイデアである．

この媒介的な分布 $\pi_n$ を焼き戻し分布 (tempered distribution) または架橋分布 (bridging distribution) などとも呼ぶ．^[[@Behrens+2012] はいずれも用いている．[@Hamze-deFreitas2005] に tempered distribution の語用法がある，]

詳しくは，[SMC サンプラーの稿](../../Surveys/SMCSamplers.qmd) を参照．

#### 最適化

SMC を最適化へ応用することができる．

まず，任意の確率的最適化アルゴリズムに対して，これを並列して実行し，うまくいっているものとうまくいっていないものの間に遺伝的変異・選択機構を導入することでより性能の良い発見的アルゴリズムを導出出来ることを [@Aldous-Vazirani1994] が指摘しており，この機構を "go with the winners" と呼んでいる．

古典的な大域的最適化法に [焼きなまし法](https://ja.wikipedia.org/wiki/%E7%84%BC%E3%81%8D%E3%81%AA%E3%81%BE%E3%81%97%E6%B3%95) (simulated annealing) [@Kirkpartick+1983] があるが，[@Schafer2013] は特定の目的関数に対してこれを一般化して粒子法に基づく最適化法を提案し，特に多峰性を持つ場合に大きく性能を改善した．

[@Johansen+2008] では潜在変数モデルのパラメータの最尤推定に，EM アルゴリズム [@Dempster+1977] の代わりに simulated annealing に基づいた手法を用いている．分布の台が最尤推定量に収束するような分布の列
$$
\ov{\pi}_{\gamma_n}(\theta)\propt p(\theta)p(y|\theta)^{\gamma_n}
$$
を構成し，これから逐次的にサンプリングをするのである．最終的なアルゴリズムは，EM アルゴリズムや MCMC を用いる場合より，局所解に囚われることが少なく，初期値の設定に殆ど左右されないという利点がある．

この枠組みは一般の非凸最適化アルゴリズムになる可能性がある．^[[@Chopin-Papaspiliopoulos20-SMC 3.4節 p.30]]

#### 稀現象シミュレーション

SMC によるサンプリングは，直接のシミュレーションが困難な分布 $\pi_p$ に対しても，$\pi_1,\cdots,\pi_p$ と逐次的に近似することでこれを可能にするというアイデアであった．

特に，シミュレーションが困難である分布 $\pi_p$ の例として，極めて稀な事象 $A_p$ に関する条件付き分布などがあり得る．これに対して事象列 $A_0\supset\cdots\supset A_p$ を取り，
$$
\pi_n(d\theta)=\frac{1}{L_n}1_{A_n}(\theta)\nu(d\theta)
$$
という仲介分布の列を取るのである．この問題を **稀現象シミュレーション** という．

#### 確率的グラフィカルモデルの推論手法として

変数間の統計的依存関係が無向グラフによって与えられるモデルを [**確率的グラフィカルモデル**](https://ja.wikipedia.org/wiki/%E3%82%B0%E3%83%A9%E3%83%95%E3%82%A3%E3%82%AB%E3%83%AB%E3%83%A2%E3%83%87%E3%83%AB) という．ニューラルネットワーク [@Rumelhart-McClelland1987] も [状態空間モデル](../Surveys/SSM.qmd) もその例である．

確率的グラフィカルモデル自体多くの応用先をもち，疫学における疾病マッピング [@Green-Richardson2002]，画像解析 [@carbonetto-de-freitas-2003-cant] などにも応用されている．^[疾病マッピングは疾病の空間的な分布を把握すること，画像解析とは画像データから特徴を抽出してその意味論を理解することを指す．]

このようなモデルの尤度は極めて複雑になるが，これへ至る道を自然な方法で構成することができる [@Hamze-deFreitas2005]．複雑なモデルでは MCMC は尤度の正規化定数を評価する方法を持たないが，SMC ではこれを自然に評価することができる．

#### ポリマーシミュレーション

ポリマーシミュレーションにおいても重点サンプリング法と同じ発想が提案されたのは極めて早い段階であった [@Rosenbluth-Rosenbluth1955]．加えてリサンプリングにあたる enrichment の考え方もあった [@Wall-Erpenbeck1959]．

なお，このような物理・化学的文脈では，状態空間を探索する主体としての意味を強調し，「粒子」の代わりに walker と呼ぶ．^[[@Iba2001], [@Kremer-Binder1988] などが良いレビューを提供している．[@Assaraf+2000] が量子系のシミュレーションの文脈で．]

これら２つを組み合わせることで，長いポリマー鎖のシミュレーションを可能にする方法として，相関粒子法に基づくアルゴリズム PERM (pruned-enriched Rosenbluth algorithm) が提案されている [@Grassberger1997]．

この手法はたんぱく質の折り畳み問題にも応用されている [@Hansmann-Okamoto1999]．

#### 量子系シミュレーション

量子多体系の基底状態のシミュレーションにおけるモンテカルロ法である QMC (Quantum Monte Carlo)^[diffusion Monte Carlo, projector Monte Carlo などと呼ばれる手法に等しい．Green's function Monte Carlo もポテンシャル $G$ の取り方が違うのみである [@Assaraf+2000]．また [@Iba2001] 3.1節 p.282 にも言及がある．] でも， branching というリサンプリング機構を取り入れた相関粒子法が用いられている [@Assaraf+2000]．

これは大規模な疎行列の最小固有値・固有ベクトルを近似する手法として，量子系に限らない幅広い応用がある．^[[@Iba2001] 3.1節 p.281．]

### 粒子フィルターの弱点 {#sec-欠点}

1. **計算量**

    粒子フィルターは高い汎用性の代償として，多数の粒子による高精度な推論のためには多くの計算量を必要とすることは欠点に挙げられる．が，CPU や並列計算の発展により十分な量の粒子を用意できる場面も増えたため，その問題点も形骸化してきてると言える．^[[@矢野2014] p.190，[@Ristic+2004] 前文 p.xi．]

2. **荷重の縮退**

    また粒子フィルターは，観測 $Y_t$ の次元が大きいなど，観測から得られる情報量が多く，尤度（ポテンシャル）の尖度が高いとき，リサンプリング機構があってもやはり縮退を起こしてしまう．^[[@Chopin-Papaspiliopoulos20-SMC 19.1節 p.371], [@Creal2011 2.5.1節 p.258]．] このような場合は，観測の情報を柔軟に取り入れた提案核を構築し，誘導粒子フィルターをうまく設計する必要がある．

> 粒子フィルタを適用する際の課題の一つは，各粒子に割り当てられる重みが１粒子に集中する，いわゆる退化の問題を限られた数の粒子でいかに克服するかである．[@上野玄太2019]

3. **高次元**

    地球科学や天気予報の分野では $Y_t$ は大きく（$10^7$ を超えることもある），このような場合は粒子フィルターは実行可能でなくなる．加えて Kalman フィルターも逆行列の計算が不安定になり，アンサンブル Kalman フィルタという粒子法が用いられる（ @sec-EnKF ）．

## 今後の研究

粒子フィルターの更なる応用には次の点の研究が肝要である．

### Feynman-Kac 理論と粒子法の統一的理解

粒子フィルターは状態空間モデルのフィルタリングに使えるだけでなく，**Feynman-Kac 測度の確率的近似に使える汎用手法である** というのがより新しい数学的理解である．^[[@DelMoral-Doucet2014] など．] この文脈では **相関粒子法** (interacting particle methods) と呼ばれる．^[[@Iba2001] などでは population Monte Carlo と呼ばれている．]

> the mathematical concepts and models are now at a point where they provide a very natural and unifying mathematical basis for a large class of Monte Carlo algorithms. [@DelMoral-Doucet2014 p.2]

この枠組みからならば，粒子フィルターに限らず，物理学・化学・工学で用いられている多くの [発見的手法](https://ja.wikipedia.org/wiki/%E3%83%92%E3%83%A5%E3%83%BC%E3%83%AA%E3%82%B9%E3%83%86%E3%82%A3%E3%83%83%E3%82%AF) について，理論的な解析が可能になる可能性がある．

### 提案分布の取り方

@sec-欠点 で触れた通り，特に観測の情報量が大きい場合，提案分布の選び方が粒子フィルターの精度を大きく左右する．これは粒子を高確率領域に始めから誘導するように設計する **誘導粒子フィルター** によってある程度対処できる．^[そのアイデアは [@Doucet+2001 pp.79-95] 第4章 から．]

参照 Markov 核 $M_t$ がより良い攪拌性を持ち，ポテンシャル $G_t$ が平坦であるほど性能は良い傾向があるが，^[[@Crisan-Doucet2002 p.739] も参照．] このときの提案分布の取り方について普遍的な指針というものが得られていない．

> The key factors for a successful application of particle filters in practice are therefore a good choice of the importance density and Rao-Blackwellization if possible. [@Ristic+2004] Epilogue

[@Guarniero+2017] と [@Heng+2020] は提案分布にパラメトリックモデルを用意し，粒子推定量の分散を最小化するようにそのモデル内で逐次的に最適化していく機構を提案している．

[@Naesseth2015] が提唱する nested SMC は，は各時刻での提案分布を近似するために，もう一つのSMCを内部に走らせる．当然計算量は二倍になるが，それでも単純な bootstrap filter から大きく性能が改善する場合が多い．

加えて機械学習の観点からも，真の事後分布との KL 距離を適応的に最小化する汎用手法に，提案分布のパラメトリックモデルにニューラルネットワークによる大型のパラメトリックモデルを併せる手法が提案されている [@Gu+2015]．

### 高次元性への対応

状態空間が高次元になることと，既存のモデルを状態空間モデルに定式化することに困難が伴うことが，朧げながら共通課題のように思われるが，その現れ方と解決法は個々の事例で異なる．

#### 部分的な線型構造の利用

周辺化粒子フィルター，または Rao-Blackwellized particle filter とも呼ばれる方法である．これは多くの場面で，仮定されている状態空間モデルが部分的に線型である場合に，線型の部分をKalmanフィルターによって正確に解き，残った部分のみを粒子フィルターで解くことで，精度の向上とアルゴリズムの効率化を図る方法である．

[@Ristic+2004 p.287] では，探知前追跡 (track-before-detect) の問題^[探知前追跡とは，信号が弱い，またはノイズが強い環境下において，信頼のおける初期信号を頼りにせずとも，物体追跡を実行するための手法．]において，周辺化粒子フィルタが，必要な粒子数を大きく削減してくれることを紹介している．

その他にも，問題毎の特有の構造を利用して計算量を削減・パフォーマンスを最適化することは重要な営みである．

### 漸近論

#### 粒子数に関する漸近論

目前の問題を，所与の精度で解くために必要な粒子数は幾ばくか？という問題は実用上も有益だと思われる．^[[@Ristic+2004 p.288] に示唆されている．]

#### 時間離散化に関する漸近論

[@Chopin+2022]

### EnKFの数学的解析 {#sec-EnKF}

状態空間が高次元である場合，（どうなる？）

モデルが正規性を持つならば，**EnKF (Ensemble Kalman Filter)** [@Evensen1994] が有効であり，データ同化の分野で広く使われている．^[[@DelMoral-Horton2023-EnKF] は ensemble Kalman particle filtering methodology と呼んでいる．]

一方で，その数学的な振る舞いはほとんど解明されておらず，1次元の場合から調べている状況である [@DelMoral-Horton2023-EnKF]．

### 粒子フィルターの応用

リアルタイム性と [ベイズ推定の意思決定への応用との相性の良さ](../Surveys/BayesianComp.qmd#sec-BayesianCausalInference) が，今後多くの重要な応用を見る可能性がある．

#### 属人化医療への応用

筆者は属人化医療への応用が大きなモチベーションになっている．^[[過去の記事](../Surveys/SSM.qmd#sec-personalized-medicine)でも触れた．]

病気の進行（あるいは健康）のモニタリングのために，健康診断やウェアラブルデバイス，フォローアップから得られるデータは，治療の見直しや異常の早期発見のために即時処理されることが望ましい．これに逐次モンテカルロ法でBayes的に迫る研究がある [@Alvares+2021] ！

さらに，個々人の日常生活のレベルではSMCを用いているものはどうやらまだなく，運動と睡眠時間の間の関係と処置効果をMonte Carlo法を用いて推定している研究はある [@Daza-Schneider2022]．これを逐次化することで，よりリアルタイムで自分に合った生活習慣への示唆が得られるアプリを開発できるかもしれない．

また，属人化医療においてはシステム生物学的なモデルに基づいた薬効推定が欠かせない．小規模な患者群と測定時間（服薬時間）に関する不確定性を考慮した手法が [@Krengel+2013] で考察されている．

また，腫瘍サンプルに含まれる体細胞の突然変異に関するデータから，SMCを用いて腫瘍の発達と進行の状態を理解する手法も提案されている [@Ogundijo+2019]．

#### ゲノム解析への応用

次世代DNAシークエンサーでは，DNAの各塩基ごとに異なる蛍光物質を結合させ，蛍光の波長と強度により塩基を読み取る仕組みであり，蛍光強度の生データからDNA配列データへ変換するベースコールと呼ばれる段階で粒子フィルターを使うことも提案されている [@Shen-Vikalo2012]．

#### 疫学への応用

Covid-19のようなパンデミックにおいて，疫学モデルを通じて時間変動する再生産数をリアルタイムでモニタリングをして意思決定に繋げるためのSMC手法も考えられており，実際にノルウェーで使用され有効性が実証された [@Strovik+2023]．