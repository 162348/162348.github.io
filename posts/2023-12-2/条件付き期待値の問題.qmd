---
title: "条件付き期待値の測度論的基礎付け"
author: "Hirofumi Shiba"
date: "12/2/2023"
categories: [Probability, Math Notes]
toc: true
number-sections: true
twitter-card: 
    image: ../../cover.PNG
bibliography: ../../mathematics.bib
csl: ../../apa.csl
---

## 条件付き期待値の定義

条件付き期待値を，測度論から厳密に定義する際，ポイントは次の4点である．

{{< include ../../_preamble.qmd >}}

::: {.callout-important icon="false"}
## ポイント

1. 条件付き期待値は $\sigma$-代数 $\cG$ に対して $\E[X|\cG]$ の形で（$\Om$ 上殆ど至る所）定義される確率変数である．
2. $\E[X|Y]$ というのは，$\E[X|\sigma(Y)]$ の略記である．
3. $\E[X|Y=y]$ というのは，$\E[X|\sigma(Y)](Y^{-1}(y))$ のことである．
4. $X\in L^2(\Om)$ でもあるとき，$\E[X|\F]$ は $X$ に $L^2(\Om)$-距離で最も近いような $\F$-可測確率変数である．
:::

![Defining Properties for Conditional Expectation](cover.png)

### 測度論による定義 {#sec-def}

::: {.callout-tip icon="false"}
## 定義（条件付き期待値）
$(\Om,\F,\P)$ を確率空間とし，$\cG$ を $\F$ の部分 $\sigma$-代数とする．可積分確率変数 $X\in\L^1(\Om)$ について，
次の2条件を満たす，$\P$-零集合を除いて一意な確率変数を**条件付き期待値**といい，$\E[X|\cG]$ で表す．

1. $\cG$-可測でもある $\P$-可積分確率変数である．
2. 任意の $\cG$-可測集合 $B\in\cG$ 上では $X$ と期待値が同じ確率変数になる：$$\E[X1_B]=\E[\E[X|\cG]1_B]$$
:::

$$\E[X,B]:=\E[X1_B]$$
という記法を採用すれば，条件2は
$$\E[X,B]=\E[\E[X|\cG],B]$$
と書くこともできる．

::: {.callout-note icon="false"}
## 証明

定義の2条件のみから，$\E[X|\cG]$ が $\P$-零集合を除いて一意に定まること（とその存在）を示す．

$$Q(B):=E[X,B]=E[1_BX]\;(B\in\cG)$$
とおくことで，$Q$ は可測空間 $(\Om,\cG)$ 上の確率測度を定める．
いま，$\P|_\cG$ に関して $Q$ は絶対連続になっている：$$\forall_{B\in\cG}\;P(B)=0\Rightarrow Q(B)=0.$$
これより，[Radon-Nikodymの定理](https://ja.wikipedia.org/wiki/%E3%83%A9%E3%83%89%E3%83%B3%EF%BC%9D%E3%83%8B%E3%82%B3%E3%83%87%E3%82%A3%E3%83%A0%E3%81%AE%E5%AE%9A%E7%90%86)から，
ある $\cG$-可測で $\P$-可積分な可測関数 $Y:\Om\to\R$ が，$\P$-零集合上での違いを除いて一意的に存在して，$$\forall_{B\in\cG}\;Q(B)=\int_BY(\om)P(d\om)$$
が成り立つ．
よって，条件付き期待値 $Y$ は確かに存在して（同値類 $L^1(\P)$ の元としては）一意的で，(1),(2)が成り立つ．
:::

[@Dudley02-RealAnalysisAndProbability 10.1節 p.336], [@吉田朋広-数理統計 p.43] がおすすめな参照先．[@舟木-確率論 p.88] が入門しやすい．$X\in L^2(\Om)$ でいい場合は，より「射影」としてわかりやすい特徴付けがある（ @sec-characterization ）．これのおすすめは [@Jacod-Protter2004 第23節 p.200], [@Kallenberg p.164]．

### 確率変数に関する条件付け

::: {.callout-tip icon="false"}
## 定義（確率変数を与えた下での条件付き期待値）
$S$ を位相空間とする．確率変数 $X\in\L(\Om;S)$ による $Y\in\L^1(\Om)$ の**条件付き期待値**は，次を満たす可測関数 $E[Y|X=-]:S\to\R$ のことをいう：
$$
\begin{align*}
\forall_{B\in\B(S)}\quad&\int_{X^{-1}(B)}Y(\om)P(d\om)\\
&\quad=\int_BE[Y|X=x]P^X(dx).
\end{align*}
$$
:::

$(E,\cE)$ を可測空間とし，確率変数 $X:\Om\to E$ を与えた下での条件付き期待値 $\E[Y|X]$ を，$X$ が $\Om$ 上に引き戻す $\sigma$-代数
$$
\sigma(X):=\Brace{A\subset\Om\mid\exists_{B\in\cE}\; X^{-1}(B)=A}
$$
を与えた下での条件付き期待値 $\E[Y|\sigma(X)]$ と定める．^[[@Dudley02-RealAnalysisAndProbability p.340] など．] すると $\E[Y|X]$ は $\sigma[X]$-可測であるが，可測性の特徴付け（後述）から，これはあるBorel可測関数 $f$ について，$$E[Y|X]=f(X)\;\as$$
と表せる．つまり，$X$ の値域上の関数
$$E[Y|X=x]:=f(x)\;\as$$
と扱えるはずである．この $f:\mathcal{X}\to\R$ が条件付き期待値である．^[[@Kallenberg p.167]．] 厳密には，
$$
\E[Y|X=x]|_{x=X(\om)}=\E[Y|X](\om)\;\as
$$
を満たすように定める．

::: {.callout-tip icon="false"}
## 命題（Doobの汎函数表現）
$S$ を位相空間，$X\in \L(\Om;S),Y\in \L(\Om)$ を確率変数とする．次は同値：

1. $Y$は $\sigma(X)$-可測．
2. あるBorel可測関数 $f:S\to\R$ が存在して，$Y=f(X)$ を満たす．
:::

::: {.callout-note icon="false"}
## 証明
2 $\Rightarrow$ 1 はすぐに従う．任意の $B\in\B(\R)$ について，$f^{-1}(B)\in\B(S)$ であるから，
$$Y^{-1}(B)=X^{-1}(f^{-1}(B))\in\sigma(X).$$
あとは 1 $\Rightarrow$ 2 を示せば良い．3段階で示す．

1. まず $Y$ が単関数
$$Y=\sum_{i=1}^nc_i1_{A_i},\qquad c_i\ne c_j\;(i\ne j).$$
の場合について示す．仮定より $A_i\in\sigma(X)$ であるから，ある $B_i\in\B(S)$ が存在して $A_i=X^{-1}(B_i)$．よって，
$$f(x):=\sum_{i=1}^nc_i1_{B_i}(x).$$
と定めると $Y=f(X)$．
2. 次に $Y\ge0\;\as$ の場合を考えると，正な単関数の単調増加列 $\{Y_n\}$ で $Y$ に収束するものが取れる．各 $Y_n$ について，$f_n\in\L(S)$ が存在して $Y_n=f_n(X)$ が成り立つ．このとき，$f:=\limsup_{n\to\infty}f_n$ と定めれば，
$$\begin{align*}
Y&=\limsup_{n\to\infty}Y_n\\
&=(\limsup_{n\to\infty}f_n)(X)=f(X).
\end{align*}$$
3. 一般の場合は $Y=Y^+-Y^-$ の分解から従う．
:::

[@Dudley02-RealAnalysisAndProbability 定理4.2.8 p.128] は $S=\R$ の場合，[@Landkov72-Probability] は $S=\R^m$ の場合, [@Kallenberg 補題1.14 p.18] に一般の標準Borel空間の場合の証明がある．

### 射影としての特徴付け {#sec-characterization}

$L^2(\Om)\subset L^1(\Om)$ 上に議論を制限してみると，実は $\F$ の部分 $\sigma$-代数 $\cG$ に関する条件付き期待値は，部分空間
$$
L^2_\cG(\Om):=\Brace{X\in L^2(\Om)\mid X\,\text{は}\,\B(\R)/\cG\,\text{-可測}}
$$
への射影になっている．

::: {.callout-tip icon="false"}
## 定理（条件付き期待値の特徴付け）
部分 $\sigma$-代数 $\cG\subset\F$ と $X\in\L^2(\Om)$ を考える．
任意の $\wh{X}_\cG\in\L^2_\cG(\Om)$ について，次は同値：

1. $\wt{X}_\cG$ は $X$ の $L^2_\cG(\Om)$ への射影である：$$\norm{X-\wh{X}_\cG}_{L^2(\Om)}=\inf_{X'\in\L^2_\cG(\Om)}\norm{X-X'}_{L^2(\Om)}$$．
2. $\wt{X}_\cG$ は $X$ の条件付き期待値である：$$\forall_{Z\in L^2_\cG(\Om)}\;\E[ZX]=\E[Z\wh{X}_\cG].$$

:::

## 性質

### 作用素としての性質 {#sec-positive-operator}

$\cG$-可測な可積分関数のなす部分空間を $L_{\cG}^1(\Om)\subset L^1(\Om)$ で表す．

::: {.callout-tip icon="false"}
## 命題（条件付き期待値はノルム減少的な正作用素）
条件付き期待値 $\E_{\cG}:L^1(\Om)\to L_{\cG}^1(\Om)$ はノルム減少的で正な線型汎作用素である．すなわち，

1. 線型性：任意の実数 $a,b\in\R$ について，
$$\begin{align*}
\E[aX+bY|\cG]&=a\E[X|\cG]\\
&\qquad+b\E[Y|\cG]\;\as
\end{align*}$$
2. 正性：$X\le Y\;\as$ ならば，
$$\E[X|\cG]\le\E[Y|\cG]\;\as$$
3. Jensenの不等式：$\varphi:\R\to\R$ を凸関数とする．$\varphi(X)\in L^1(\Om)$ ならば，$$\varphi(\E[X|\cG])\le\E[\varphi(X)|\cG]\;\as$$
4. 三角不等式：$$\abs{\E[X|\cG]}\le\E[\abs{X}|\cG]\;\as$$

いずれも $L_{\cG}^1(\Om)$ 上の等式・不等式であり，殆ど確実ににしか成り立たないことに注意．
:::
::: {.callout-note icon="false"}
## 証明
1は結局積分の線型性から従います．2は次のように議論できます．

任意の $X\in L^1(\Om)_+$ について $\E[X|\cG]\in L^1(\Om)$ を示せば良い．$A_n:=\Brace{X'\le1/n}\in\cG$ について，条件付き期待値の定義から，任意の $n\in\N^+$ について，
$$
\begin{align*}
0\le\E[X,A_n]&=\E[\E[X|\cG],A_n]\\
&\le\frac{1}{n}\P[A_n].
\end{align*}
$$
より，$\lim_{n\to\infty}\P[A_n]=0$ が必要．これより，
$$\P[\E[X|\cG]<0]\le\P[\cup_{n=1}^\infty A_n]=0.$$
が解る．

3は単関数の場合から地道に示します．4はその特別の場合で $\varphi(x)=\abs{x}$ と取った場合に当たります．
:::

### Tower Property {#sec-tower}

::: {.callout-tip icon="false"}
## 命題（繰り返し期待値の法則）
2つの $\sigma$-代数が $\cG_1\subset\cG_2$ を満たすならば，$\E_{\cG_1}=\E_{\cG_1}\circ\E_{\cG_2}$．すなわち，
$$\E[X|\cG_1]=\E[\E[X|\cG_2]|\cG_1]\;\as$$
:::
::: {.callout-note icon="false"}
## 証明
右辺を $Z$ とおく．任意の $A\in\cG_1$ について，$A\in\cG_2$ でもあるから，
\begin{align*}
\E[Z1_A]&=\E[\E[X|\cG_1]1_A]\\
&=\E[X1_A].
\end{align*}
:::

### 単調収束定理 {#sec-monotone}

::: {.callout-tip icon="false"}
## 命題（条件付き期待値に対する単調収束定理）
可積分な実確率変数の列 $\{X_n\}\cup\{X\}\subset L^1(\Om)$ について，
$$X_n\nearrow X\;\as$$
$$\Rightarrow\quad\E[X_n|\cG]\nearrow\E[X|\cG]\;\as$$
:::
::: {.callout-note icon="false"}
## 証明
条件付き期待値の正性 @sec-positive-operator より，
$$\E[X_n|\cG]\le\E[X|\cG]\;\as,\qquad n\in\N.$$
よって，有界な単調列は収束するから，ある $Y\in L^1(\Om)$ を $E[X_n|\cG]\nearrow Y\;\as$ を満たすように定めることが出来る．同時に，通常の期待値に関する単調収束定理から，
$$
\begin{align*}
\E[X1_A]&=\lim_{n\to\infty}\E[X_n1_A]\\&=\E[Y1_A]\;(A\in\cG)
\end{align*}
$$
が必要であるから，条件付き期待値の一意性より，$Y=\E[X|\cG]\;\as$
:::

### 可測関数の取り出し {#sec-measurable}

::: {.callout-tip icon="false"}
## 命題（可測関数の取り出し）
$X,XY\in L^1(\Om)$ を可積分，$Y\in L_\cG(\Om)$ を $\cG$-可測実確率変数とする．このとき，

1. $XY\in L^1(\Om)$ならば，$$\E[XY|\cG]=Y\E[X|\cG]\;\as$$
2. 特に，$\E[Y|\cG]=Y\;\as$
:::
::: {.callout-note icon="false"}
## 証明
条件付き期待値の線型性から，$X,Y\ge0$ の場合について示せば良い．このとき，非負値単関数の収束列 $X_n\nearrow X,Y_n\nearrow Y$ が取れる．$X_nY\nearrow XY\in L^1(\Om)$ だから，単調収束定理 @sec-monotone から
$$\E[X_n|\cG]\nearrow\E[X|\cG]$$
$$
\begin{align*}
\Rightarrow&\quad Y\E[X_n|\cG]\nearrow Y\E[X|\cG]\\
\quad\land&\quad\E[X_nY|\cG]\nearrow\E[XY|\cG].
\end{align*}$$
よって，各 $n\in\N$ について $Y\E[X_n|\cG]=\E[X_nY|\cG]$ を示せば良い．単関数とは $X=1_C\;(C\in\cG)$ という形の関数の線型和だから，畢竟この形の関数について考えれば良いのである．任意の $B\in\cG$ について $C\cap B\in\cG$ であるから，
$$
\begin{align*}
\int_B1_C\E[Y|\cG]\,d\P&=\int_{C\cap B}\E[Y|\cG]\,d\P\\
&=\int_{C\cap B}Y\,d\P\\
&=\int_B1_CY\,d\P.
\end{align*}
$$
条件付き期待値の一意性より，$1_C\E[Y|\cG]=\E[1_CY|\cG]\;\as$ を得る．
:::

### 独立な場合

::: {.callout-tip icon="false"}
## 命題（独立確率変数に対する性質）
可積分実確率変数 $X\in L^1(\Om)$は $\sigma$-代数 $\cG$ と独立とする．

1.  $E[X|\cG]=E[X]\;\as$
2.  特に，$E[X|\b{2}]=E[X]\;\as$．
:::

### 練習

::: {.callout-tip icon="false"}
## 問題
確率変数 $X,Y$ とその値域の値 $y\in\mathcal{Y}$ について，
$$
\E[X|Y=y]\P[Y=y]=\E[X1_{\Brace{Y=y}}]
$$
はどう正当化されるか？
:::

::: {.callout-note icon="false"}
## 説明

$\E[X1_{\Brace{Y=y}}]$ の中身を $\sigma(Y)$ で条件付けてTower property（ @sec-tower ）を使うと（定義 @sec-def の条件2からと論じても良い），$1_{\Brace{Y=y}}$ は $\sigma(Y)$-可測だから，条件付き期待値の中身から出る（ @sec-measurable 参照）．これによって正当化できる．式で表すと，
$$
\begin{align*}
\E[X1_{\Brace{Y=y}}]&=\E[\E[X1_{\Brace{Y=y}}|Y]]\\
&=\E[1_{\Brace{Y=y}}\E[X|Y]]\\
&=\int_{\mathcal{Y}}\delta_y(y')\E[X|Y=y']\P(dy')\\
&=\E[X|Y=y]\P[Y=y].
\end{align*}
$$
ただし，$\mathcal{Y}$ 上の確率測度を $\P$ と置いた．
:::