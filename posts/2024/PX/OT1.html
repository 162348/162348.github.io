<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="司馬 博文">

<title>最適輸送とそのエントロピー緩和 – Hirofumi Shiba</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../assets/Shiba2.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-65186549de95cd2ff331b98fa30c8ceb.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-ee19febcf27b510306e6c67efc3fc858.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "?",
    "H"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-ot-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: ['listing-title','listing-image','listing-date','listing-subtitle',{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: ["listing-title","listing-author","listing-date","listing-image","listing-description"],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-ot-listing'] = new List('listing-ot-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-36GX2G6GLL"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-36GX2G6GLL', { 'anonymize_ip': true});
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&amp;display=swap" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic&amp;display=swap" rel="stylesheet">

<style>
  h1, .title, .description, .subtitle {
    font-family: "Zen Kurenaido", sans-serif !important;
  }
</style>

<!-- <style>
  .menu-text {
      font-family: "Gill Sans", sans-serif !important;
      font-weight: 400;
      font-style: normal;
  }
  .navbar-title {
      font-family: "Gill Sans", sans-serif !important;
      font-weight: 400;
      font-style: normal;
  }
</style> -->

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../assets/styles.css">
<meta property="og:title" content="最適輸送とそのエントロピー緩和 – Hirofumi Shiba">
<meta property="og:description" content="Python で最適輸送写像を計算する方法を解説する． 直接最適輸送問題を POT (Python Optimal Transport) で解く．この方法は原子の数 \(N\) に対して \(O(N^3\log N)\) の複雑性を持つ． 一方で，エントロピー正則化項 \(\epsilon\operatorname{Ent}(\pi)\) を導入したエントロピー最適輸送問題は Sinkhorn アルゴリズムで高速に解くことができる． これには OTT-JAX パッケージを用いる． \(\epsilon\to0\) の極限で元の最適輸送問題の解を得る．">
<meta property="og:image" content="https://162348.github.io/posts/2024/PX/Images/OT.svg">
<meta property="og:site_name" content="Hirofumi Shiba">
<meta name="twitter:title" content="最適輸送とそのエントロピー緩和 – Hirofumi Shiba">
<meta name="twitter:description" content="Python で最適輸送写像を計算する方法を解説する． 直接最適輸送問題を POT (Python Optimal Transport) で解く．この方法は原子の数 \(N\) に対して \(O(N^3\log N)\) の複雑性を持つ． 一方で，エントロピー正則化項 \(\epsilon\operatorname{Ent}(\pi)\) を導入したエントロピー最適輸送問題は Sinkhorn アルゴリズムで高速に解くことができる． これには OTT-JAX パッケージを用いる． \(\epsilon\to0\) の極限で元の最適輸送問題の解を得る．">
<meta name="twitter:image" content="https://162348.github.io/posts/2024/PX/Images/OT.svg">
<meta name="twitter:creator" content="@ano2math5">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Hirofumi Shiba</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Notes</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-notes">    
        <li>
    <a class="dropdown-item" href="../../../static/English.html">
 <span class="dropdown-text">English Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../blog.html">
 <span class="dropdown-text">ノート (Japanese)</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Materials.html"> 
<span class="menu-text">Materials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Slides.html"> 
<span class="menu-text">Slides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/162348/162348.github.io/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">最適輸送とそのエントロピー緩和</h1>
            <p class="subtitle lead">Iterative Proportional Fitting / Sinkhorn-Knopp Algorithm</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Computation</div>
                <div class="quarto-category">P(X)</div>
                <div class="quarto-category">Python</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>司馬 博文 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">3/13/2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">10/11/2024</p>
      </div>
    </div>
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">概要</div>
      <p>Python で最適輸送写像を計算する方法を解説する． 直接最適輸送問題を <code>POT</code> (Python Optimal Transport) で解く．この方法は原子の数 <span class="math inline">\(N\)</span> に対して <span class="math inline">\(O(N^3\log N)\)</span> の複雑性を持つ． 一方で，エントロピー正則化項 <span class="math inline">\(\epsilon\operatorname{Ent}(\pi)\)</span> を導入したエントロピー最適輸送問題は Sinkhorn アルゴリズムで高速に解くことができる． これには <code>OTT-JAX</code> パッケージを用いる． <span class="math inline">\(\epsilon\to0\)</span> の極限で元の最適輸送問題の解を得る．</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#最適輸送" id="toc-最適輸送" class="nav-link active" data-scroll-target="#最適輸送"><span class="header-section-number">1</span> 最適輸送</a>
  <ul class="collapse">
  <li><a href="#はじめに" id="toc-はじめに" class="nav-link" data-scroll-target="#はじめに"><span class="header-section-number">1.1</span> はじめに</a></li>
  <li><a href="#最適輸送問題" id="toc-最適輸送問題" class="nav-link" data-scroll-target="#最適輸送問題"><span class="header-section-number">1.2</span> 最適輸送問題</a></li>
  <li><a href="#solving-the-problem" id="toc-solving-the-problem" class="nav-link" data-scroll-target="#solving-the-problem"><span class="header-section-number">1.3</span> Solving the problem</a></li>
  <li><a href="#in-dimension-d-1" id="toc-in-dimension-d-1" class="nav-link" data-scroll-target="#in-dimension-d-1"><span class="header-section-number">1.4</span> In dimension <span class="math inline">\(d = 1\)</span></a></li>
  </ul></li>
  <li><a href="#sinkhorn-アルゴリズム" id="toc-sinkhorn-アルゴリズム" class="nav-link" data-scroll-target="#sinkhorn-アルゴリズム"><span class="header-section-number">2</span> Sinkhorn アルゴリズム</a>
  <ul class="collapse">
  <li><a href="#adding-negative-entropy-as-a-regularizer" id="toc-adding-negative-entropy-as-a-regularizer" class="nav-link" data-scroll-target="#adding-negative-entropy-as-a-regularizer"><span class="header-section-number">2.1</span> Adding negative entropy as a regularizer</a></li>
  <li><a href="#the-sinkhorn-iterates" id="toc-the-sinkhorn-iterates" class="nav-link" data-scroll-target="#the-sinkhorn-iterates"><span class="header-section-number">2.2</span> The Sinkhorn iterates</a></li>
  <li><a href="#initialization-and-convergence" id="toc-initialization-and-convergence" class="nav-link" data-scroll-target="#initialization-and-convergence"><span class="header-section-number">2.3</span> Initialization and convergence</a></li>
  <li><a href="#sinkhorn-implementation" id="toc-sinkhorn-implementation" class="nav-link" data-scroll-target="#sinkhorn-implementation"><span class="header-section-number">2.4</span> Sinkhorn Implementation</a></li>
  <li><a href="#the-effect-of-epsilon" id="toc-the-effect-of-epsilon" class="nav-link" data-scroll-target="#the-effect-of-epsilon"><span class="header-section-number">2.5</span> The effect of <span class="math inline">\(\epsilon\)</span></a></li>
  <li><a href="#sinkhorn-consistency" id="toc-sinkhorn-consistency" class="nav-link" data-scroll-target="#sinkhorn-consistency"><span class="header-section-number">2.6</span> Sinkhorn consistency</a></li>
  </ul></li>
  <li><a href="#ott-パッケージ" id="toc-ott-パッケージ" class="nav-link" data-scroll-target="#ott-パッケージ"><span class="header-section-number">3</span> <code>OTT</code> パッケージ</a>
  <ul class="collapse">
  <li><a href="#install-ott" id="toc-install-ott" class="nav-link" data-scroll-target="#install-ott"><span class="header-section-number">3.1</span> Install <code>OTT</code></a></li>
  <li><a href="#a-world-about-ott-and-jax" id="toc-a-world-about-ott-and-jax" class="nav-link" data-scroll-target="#a-world-about-ott-and-jax"><span class="header-section-number">3.2</span> A world about <code>OTT</code> and <code>JAX</code></a></li>
  <li><a href="#entropic-optimal-transport-with-ott" id="toc-entropic-optimal-transport-with-ott" class="nav-link" data-scroll-target="#entropic-optimal-transport-with-ott"><span class="header-section-number">3.3</span> Entropic optimal transport with <code>OTT</code></a></li>
  </ul></li>
  
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="関連記事一覧" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="関連記事一覧">関連記事一覧</h2>
<div id="listing-ot-listing" class="quarto-listing quarto-listing-container-grid">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="UChYKSUyQ1N1cnZleQ==" data-listing-date-sort="1725321600000" data-listing-file-modified-sort="1742737331129" data-listing-date-modified-sort="1728172800000" data-listing-reading-time-sort="4" data-listing-word-count-sort="743">
<a href="../../../posts/2024/PX/OT.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="../../../posts/2024/PX/Images/OT.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
最適輸送とは何か？
</h5>
<div class="card-subtitle listing-subtitle">
歴史と概観
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-09-03
</div>
</div>
</div>
</div>
</a>
</div>
<div class="g-col-1" data-index="1" data-categories="UHJvY2VzcyUyQ1NhbXBsaW5nJTJDUChYKQ==" data-listing-date-sort="1722643200000" data-listing-file-modified-sort="1742737330776" data-listing-date-modified-sort="1728604800000" data-listing-reading-time-sort="2" data-listing-word-count-sort="219">
<a href="../../../posts/2024/Bridges/SB1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="../../../posts/2024/Bridges/Files/SB.svg" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
拡散モデルからシュレディンガー橋へ
</h5>
<div class="card-subtitle listing-subtitle">
Iterative Proportional Fitting アルゴリズムについて
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-08-03
</div>
</div>
</div>
</div>
</a>
</div>
</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div>
<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<div id="2270da41" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>プロット用の関数の準備</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_weighted_points(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    x, a,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    y, b,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="va">None</span>, x_label<span class="op">=</span><span class="va">None</span>, y_label<span class="op">=</span><span class="va">None</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  ax.scatter(x[:,<span class="dv">0</span>], x[:,<span class="dv">1</span>], s<span class="op">=</span><span class="dv">5000</span><span class="op">*</span>a, c<span class="op">=</span><span class="st">'r'</span>, edgecolors<span class="op">=</span><span class="st">'k'</span>, label<span class="op">=</span>x_label)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  ax.scatter(y[:,<span class="dv">0</span>], y[:,<span class="dv">1</span>], s<span class="op">=</span><span class="dv">5000</span><span class="op">*</span>b, c<span class="op">=</span><span class="st">'b'</span>, edgecolors<span class="op">=</span><span class="st">'k'</span>, label<span class="op">=</span>y_label)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(np.shape(x)[<span class="dv">0</span>]):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      ax.annotate(<span class="bu">str</span>(i<span class="op">+</span><span class="dv">1</span>), (x[i,<span class="dv">0</span>], x[i,<span class="dv">1</span>]),fontsize<span class="op">=</span><span class="dv">30</span>,color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(np.shape(y)[<span class="dv">0</span>]):</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      ax.annotate(<span class="bu">str</span>(i<span class="op">+</span><span class="dv">1</span>), (y[i,<span class="dv">0</span>], y[i,<span class="dv">1</span>]),fontsize<span class="op">=</span><span class="dv">30</span>,color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> x_label <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">or</span> y_label <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    ax.legend(fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  ax.axis(<span class="st">'off'</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  ax.set_title(title, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_assignement(</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    x, a,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    y, b,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    optimal_plan,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="va">None</span>, x_label<span class="op">=</span><span class="va">None</span>, y_label<span class="op">=</span><span class="va">None</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  plot_weighted_points(</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>x, a<span class="op">=</span>a,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>y, b<span class="op">=</span>b,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    x_label<span class="op">=</span>x_label, y_label<span class="op">=</span>y_label</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(optimal_plan.shape[<span class="dv">0</span>]):</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(optimal_plan.shape[<span class="dv">1</span>]):</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>          ax.plot([x[i,<span class="dv">0</span>], y[j,<span class="dv">0</span>]], [x[i,<span class="dv">1</span>], y[j,<span class="dv">1</span>]], c<span class="op">=</span><span class="st">'k'</span>, lw<span class="op">=</span><span class="dv">30</span><span class="op">*</span>optimal_plan[i,j], alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  ax.axis(<span class="st">'off'</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  ax.set_title(title, fontsize<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_assignement_1D(</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    x, y,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="va">None</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  plot_points_1D(</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    x, y,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="va">None</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  x_sorted <span class="op">=</span> np.sort(x)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  y_sorted <span class="op">=</span> np.sort(y)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">assert</span> <span class="bu">len</span>(x) <span class="op">==</span> <span class="bu">len</span>(y), <span class="st">"x and y must have the same shape."</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(x)):</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    ax.hlines(</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        xmin<span class="op">=</span><span class="bu">min</span>(x_sorted[i], y_sorted[i]),</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        xmax<span class="op">=</span><span class="bu">max</span>(x_sorted[i], y_sorted[i]),</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">'k'</span>,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        lw<span class="op">=</span><span class="dv">10</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  ax.axis(<span class="st">'off'</span>)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  ax.set_title(title, fontsize<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_points_1D(</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    x, y,</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="va">None</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  a <span class="op">=</span> np.ones(n) <span class="op">/</span> n</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  ax.scatter(x, np.zeros(n), s<span class="op">=</span><span class="dv">1000</span><span class="op">*</span>a, c<span class="op">=</span><span class="st">'r'</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  ax.scatter(y, np.zeros(n), s<span class="op">=</span><span class="dv">1000</span><span class="op">*</span>b, c<span class="op">=</span><span class="st">'b'</span>)</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  min_val <span class="op">=</span> <span class="bu">min</span>(np.<span class="bu">min</span>(x), np.<span class="bu">min</span>(y))</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  max_val <span class="op">=</span> <span class="bu">max</span>(np.<span class="bu">max</span>(x), np.<span class="bu">max</span>(y))</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>      ax.annotate(<span class="bu">str</span>(i<span class="op">+</span><span class="dv">1</span>), xy<span class="op">=</span>(x[i], <span class="fl">0.005</span>), size<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'r'</span>, ha<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>      ax.annotate(<span class="bu">str</span>(j<span class="op">+</span><span class="dv">1</span>), xy<span class="op">=</span>(y[j], <span class="fl">0.005</span>), size<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'b'</span>, ha<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  ax.axis(<span class="st">'off'</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  ax.plot(np.linspace(min_val, max_val, <span class="dv">10</span>), np.zeros(<span class="dv">10</span>))</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  ax.set_title(title, fontsize<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_consistency(</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    reg_strengths,</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    plan_diff, distance_diff</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>  ax[<span class="dv">0</span>].loglog(reg_strengths, plan_diff, lw<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  ax[<span class="dv">0</span>].set_ylabel(<span class="st">'$||P^* - P_\epsilon^*||_F$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>  ax[<span class="dv">1</span>].tick_params(which<span class="op">=</span><span class="st">'both'</span>, size<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  ax[<span class="dv">0</span>].grid(ls<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  ax[<span class="dv">1</span>].loglog(reg_strengths, distance_diff, lw<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  ax[<span class="dv">1</span>].set_xlabel(<span class="st">'Regularization Strength $\epsilon$'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  ax[<span class="dv">1</span>].set_ylabel(<span class="vs">r'$ 100 \cdot \frac{\langle C, P^*_\epsilon \rangle - \langle C, P^* \rangle}{\langle C, P^* \rangle} $'</span>, fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  ax[<span class="dv">1</span>].tick_params(which<span class="op">=</span><span class="st">'both'</span>, size<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>  ax[<span class="dv">1</span>].grid(ls<span class="op">=</span><span class="st">'--'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="最適輸送" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="最適輸送"><span class="header-section-number">1</span> 最適輸送</h2>
<section id="はじめに" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">1.1</span> はじめに</h3>
<p>POT パッケージ（<a href="https://pythonot.github.io/">Docs</a> / <a href="https://github.com/PythonOT/POT">GitHub</a>）を用いる．</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install POT</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install cloudpickle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="37142bbc" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ot</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="最適輸送問題" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="最適輸送問題"><span class="header-section-number">1.2</span> 最適輸送問題</h3>
<p>We will solve the Bakeries/Cafés problem of transporting croissants from a number of Bakeries to Cafés.</p>
<p>We use fictional positions, production and sale numbers. We impose that the total croissant production is equal to the number of croissants sold, so that Bakeries and Cafés can be represented as measures with the same total mass. Then, up to normalization, they can be processed as probability measures.</p>
<p>Mathematically, we have acess to the position of the <span class="math inline">\(m\)</span> Bakeries as points in <span class="math inline">\(\mathbb{R}^2\)</span> via <span class="math inline">\(x \in \mathbb{R}^{n \times 2}\)</span> and their respective production via <span class="math inline">\(a \in \mathbb{R}^m\)</span> which describe the source point cloud. The Cafés where the croissants are sold are also defined by their position <span class="math inline">\(y \in \mathbb{R}^{m \times 2}\)</span> and the quantity of croissants sold by <span class="math inline">\(b \in \mathbb{R}^{m}\)</span>.</p>
<p>Afterwards, the Bakeries are represented by the probability measure <span class="math inline">\(\mu = \sum_{i=1}^n a_i \delta_{x_i}\)</span> and the Cafés by <span class="math inline">\(\nu = \sum_{j=1}^n b_j \delta_{y_j}\)</span>. Calculating the optimal assignment of the croissants delivered by the Bakeries to the Cafés remains to calculating the optimal transport between the probability measures <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\nu\)</span>.</p>
<p>Let’s download the data and check that the total croissant production is equal to the number of croissants sold.</p>
<div id="b282aef6" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.request <span class="im">import</span> urlopen</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cloudpickle <span class="im">as</span> cp</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>croissants <span class="op">=</span> cp.load(urlopen(<span class="st">'https://marcocuturi.net/data/croissants.pickle'</span>))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>bakery_pos <span class="op">=</span> croissants[<span class="st">'bakery_pos'</span>]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>bakery_prod <span class="op">=</span> croissants[<span class="st">'bakery_prod'</span>]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>cafe_pos <span class="op">=</span> croissants[<span class="st">'cafe_pos'</span>]</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>cafe_prod <span class="op">=</span> croissants[<span class="st">'cafe_prod'</span>]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Bakery productions ='</span>, bakery_prod)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Total number of croissants ='</span>, bakery_prod.<span class="bu">sum</span>())</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">""</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Café sales ='</span>, cafe_prod)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Total number of croissants sold ='</span>, cafe_prod.<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bakery productions = [31. 48. 82. 30. 40. 48. 89. 73.]
Total number of croissants = 441.0

Café sales = [82. 88. 92. 88. 91.]
Total number of croissants sold = 441.0</code></pre>
</div>
</div>
<p>We now normalize the weight vectors <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>, i.e.&nbsp;the production and the sales, to deal with probability measures.</p>
<div id="3b21b7ad" class="cell" data-executioninfo="{&quot;elapsed&quot;:11,&quot;status&quot;:&quot;error&quot;,&quot;timestamp&quot;:1702203316439,&quot;user&quot;:{&quot;displayName&quot;:&quot;Mahmoud Hegazy&quot;,&quot;userId&quot;:2035046206960435200},&quot;user_tz&quot;:-60}" data-outputid="5ce2d95f-8a07-4576-ba50-94c1db2e9093" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>bakery_prod <span class="op">=</span> bakery_prod <span class="op">/</span> bakery_prod.<span class="bu">sum</span>()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>cafe_prod <span class="op">=</span> cafe_prod <span class="op">/</span> cafe_prod.<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we plot the probability measures (the weighted point clouds) in <span class="math inline">\(\mathbb{R}^2\)</span>.</p>
<div id="d689bddb" class="cell" data-executioninfo="{&quot;elapsed&quot;:9,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1702203316439,&quot;user&quot;:{&quot;displayName&quot;:&quot;Mahmoud Hegazy&quot;,&quot;userId&quot;:2035046206960435200},&quot;user_tz&quot;:-60}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>plot_weighted_points(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>bakery_pos,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    x_label<span class="op">=</span><span class="st">"Bakeries"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>cafe_pos,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    y_label<span class="op">=</span><span class="st">"Cafés"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Bakeries and Cafés"</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OT1_files/figure-html/cell-6-output-1.png" width="763" height="645" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="solving-the-problem" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="solving-the-problem"><span class="header-section-number">1.3</span> Solving the problem</h3>
<p>To compute the optimal transport, we will consider three different costs:</p>
<ul>
<li><span class="math inline">\(\ell_1\)</span>: <span class="math inline">\(c(x, y) = \|x - y\|_1\)</span> , (Manhattan distance)</li>
<li><span class="math inline">\(\ell_2\)</span>: <span class="math inline">\(c(x, y) = \|x - y\|_2\)</span>, (Euclidean distance)</li>
<li><span class="math inline">\(\ell_2^2\)</span>: <span class="math inline">\(c(x, y) = \|x - y\|_2^2\)</span> (Squared-Euclidean distance)</li>
</ul>
<p>Note that we expect different optimal transport plans for different costs.</p>
<hr>
<p><strong>Question:</strong></p>
<ul>
<li>Complete the following function that computes a cost matrix <span class="math inline">\(C\)</span> from two set of points <span class="math inline">\(x, y\)</span> and a cost function <span class="math inline">\(c\)</span>. Compute the three costs matrices <span class="math inline">\(C_{\ell_1}, C_{\ell_2}, C_{\ell_2^2}\in \mathbb{R}^{n \times m}\)</span> using that function.</li>
<li>What cost should be used to minimize the total distance traveled by the driver that delivers croissants from Bakeries to Cafés?</li>
</ul>
<p><strong>Answer:</strong></p>
<div id="44e09e75" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>bakery_pos</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>array([[184.86464733, 201.8163543 ],
       [449.3486663 , 168.40784664],
       [245.41756746, 288.12166576],
       [273.95400109, 364.68282915],
       [494.58935376, 336.8424061 ],
       [738.19305545, 238.70491485],
       [736.10502372, 375.12298779],
       [537.74200949, 482.30861653]])</code></pre>
</div>
</div>
<div id="f0aa734a" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cafe_pos</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>array([[302.08410452, 442.78633642],
       [345.1162221 , 368.52123027],
       [449.226184  , 201.94529124],
       [454.08464888, 387.95508982],
       [627.60125204, 408.7770822 ]])</code></pre>
</div>
</div>
<div id="a287cbdc" class="cell" data-executioninfo="{&quot;elapsed&quot;:6,&quot;status&quot;:&quot;error&quot;,&quot;timestamp&quot;:1702200757600,&quot;user&quot;:{&quot;displayName&quot;:&quot;Mahmoud Hegazy&quot;,&quot;userId&quot;:2035046206960435200},&quot;user_tz&quot;:-60}" data-outputid="9e68a2b2-34bb-4a79-fdb8-941a02bd63a8" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cost_matrix(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    x: np.ndarray,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    y: np.ndarray,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    cost_fn: Callable</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">  Compute the pairwise cost matrix between the n points in ``x`` and the m points in ``y``.</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">  It should output a matrix of size n x m.</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> np.array([cost_fn(x_,y_) <span class="cf">for</span> x_ <span class="kw">in</span> x <span class="cf">for</span> y_ <span class="kw">in</span> y]).reshape(x.shape[<span class="dv">0</span>],y.shape[<span class="dv">0</span>])</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># compute cost matrices for different costs</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>C_l1 <span class="op">=</span> get_cost_matrix(</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>bakery_pos, y<span class="op">=</span>cafe_pos,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    cost_fn<span class="op">=</span> <span class="kw">lambda</span> x,y : <span class="bu">sum</span>(np.<span class="bu">abs</span>(x<span class="op">-</span>y))</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>C_l2 <span class="op">=</span> get_cost_matrix(</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>bakery_pos, y<span class="op">=</span>cafe_pos,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    cost_fn<span class="op">=</span> <span class="kw">lambda</span> x,y : <span class="bu">sum</span>((x<span class="op">-</span>y)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>C_l2_sq <span class="op">=</span> get_cost_matrix(</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>bakery_pos, y<span class="op">=</span>cafe_pos,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    cost_fn<span class="op">=</span> <span class="kw">lambda</span> x,y : <span class="bu">sum</span>(np.sqrt((x<span class="op">-</span>y)<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co"># print shapes of cost matrices</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Shape of C_l1: </span><span class="sc">{</span>C_l1<span class="sc">.</span>shape<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Shape of C_l2: </span><span class="sc">{</span>C_l2<span class="sc">.</span>shape<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Shape of C_l2_sq: </span><span class="sc">{</span>C_l2_sq<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shape of C_l1: (8, 5)
Shape of C_l2: (8, 5)
Shape of C_l2_sq: (8, 5)</code></pre>
</div>
</div>
<hr>
<p>We can now compute the Optimal Transport plan to transport the croissants from the bakeries to the cafés, for the three different costs.</p>
<hr>
<p><strong>Question:</strong></p>
<ul>
<li>Complete the following fuction that takes as input the cost matrix <span class="math inline">\(C\)</span> and the weights vectors <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> and outputs the optimal transport plan and the optimal transport cost using the <code>ot.emd</code> function. It has an option to display the results.</li>
<li>Use that function to compute and display the optiaml plan and the optimal cost for <span class="math inline">\(\ell_1, \ell_2\)</span> and <span class="math inline">\(\ell_2^2\)</span> geometries.</li>
</ul>
<p><strong>Remark:</strong> See https://pythonot.github.io/ for informations on the <code>ot.emd</code> function.</p>
<p><strong>Answer:</strong></p>
<div id="06c24488" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_transport(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    C: np.ndarray,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    a: np.ndarray,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    b: np.ndarray,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    verbose: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">  Compute the optimal transport plan and the optimal transport cost</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">  for cost matrix ``C`` and weight vectors $a$ and $b$.</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">  If ``verbose`` is set to True, it displays the results.</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  optimal_plan <span class="op">=</span> ot.emd(a,b,C)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  optimal_cost <span class="op">=</span> np.<span class="bu">sum</span>(optimal_plan <span class="op">*</span> C)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> verbose:</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"optimal transport plan: </span><span class="ch">\n</span><span class="sc">{</span>optimal_plan<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"transport cost: </span><span class="sc">{</span>optimal_cost<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> optimal_plan, optimal_cost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="dfcb78d6" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># l1 geometry</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"l1 geometry:"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>optimal_plan_l1_croissant, optimal_cost_l1_croissant <span class="op">=</span> compute_transport(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l1,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>l1 geometry:
optimal transport plan: 
[[0.07029478 0.         0.         0.         0.        ]
 [0.         0.         0.10884354 0.         0.        ]
 [0.05442177 0.13151927 0.         0.         0.        ]
 [0.         0.06802721 0.         0.         0.        ]
 [0.         0.         0.         0.09070295 0.        ]
 [0.         0.         0.09977324 0.00453515 0.00453515]
 [0.         0.         0.         0.         0.20181406]
 [0.06122449 0.         0.         0.10430839 0.        ]]
transport cost: 177.28420815406028</code></pre>
</div>
</div>
<div id="32a196cb" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># l2 geometry</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"l2 geometry:"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>optimal_plan_l2_croissant, optimal_cost_l2_croissant <span class="op">=</span> compute_transport(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l2,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>l2 geometry:
optimal transport plan: 
[[0.         0.07029478 0.         0.         0.        ]
 [0.         0.         0.10884354 0.         0.        ]
 [0.11791383 0.06802721 0.         0.         0.        ]
 [0.06802721 0.         0.         0.         0.        ]
 [0.         0.06122449 0.         0.02947846 0.        ]
 [0.         0.         0.09977324 0.00453515 0.00453515]
 [0.         0.         0.         0.         0.20181406]
 [0.         0.         0.         0.16553288 0.        ]]
transport cost: 24576.370543882178</code></pre>
</div>
</div>
<div id="8599807b" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># squared l2 geometry</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"squared l2 geometry:"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>optimal_plan_l2_sq_croissant, optimal_cost_l2_sq_croissant <span class="op">=</span> compute_transport(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l2_sq,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>squared l2 geometry:
optimal transport plan: 
[[0.07029478 0.         0.         0.         0.        ]
 [0.         0.         0.10884354 0.         0.        ]
 [0.05442177 0.13151927 0.         0.         0.        ]
 [0.         0.06802721 0.         0.         0.        ]
 [0.         0.         0.         0.09070295 0.        ]
 [0.         0.         0.09977324 0.00453515 0.00453515]
 [0.         0.         0.         0.         0.20181406]
 [0.06122449 0.         0.         0.10430839 0.        ]]
transport cost: 177.28420815406028</code></pre>
</div>
</div>
<hr>
<p>Now, we can visualize the assignement induced by each geometry.</p>
<div id="e13eacbc" class="cell" data-executioninfo="{&quot;elapsed&quot;:1831,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677230871731,&quot;user&quot;:{&quot;displayName&quot;:&quot;quentin Feron&quot;,&quot;userId&quot;:3625065177957837000},&quot;user_tz&quot;:-60}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">9</span><span class="op">*</span><span class="dv">3</span>, <span class="dv">7</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>plans <span class="op">=</span> [optimal_plan_l1_croissant,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>         optimal_plan_l2_croissant,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>         optimal_plan_l2_sq_croissant]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> [<span class="vs">r"$\ell_1$ geometry"</span>, <span class="vs">r"$\ell_2$ geometry"</span>, <span class="vs">r"$\ell_2^2$ geometry"</span>]</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> axes, plan, title <span class="kw">in</span> <span class="bu">zip</span>(ax, plans, titles):</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  plot_assignement(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>      ax<span class="op">=</span>axes,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      x<span class="op">=</span>bakery_pos, a<span class="op">=</span>bakery_prod, x_label<span class="op">=</span><span class="st">"Bakeries"</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>      y<span class="op">=</span>cafe_pos, b<span class="op">=</span>cafe_prod, y_label<span class="op">=</span><span class="st">"Cafés"</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>      optimal_plan<span class="op">=</span>plan,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>      title<span class="op">=</span>title</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OT1_files/figure-html/cell-14-output-1.png" width="2028" height="586" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="in-dimension-d-1" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="in-dimension-d-1"><span class="header-section-number">1.4</span> In dimension <span class="math inline">\(d = 1\)</span></h3>
<p>Let assume in this subsection that the cost is of the form <span class="math inline">\(c(x, y) = \|x - y\|_p^q\)</span> with <span class="math inline">\(p, q \geq 1\)</span>, which covers the costs we considered in the previous examples, and that the points are in <span class="math inline">\(\mathbb{R}\)</span>, i.e.&nbsp;<span class="math inline">\(x_1, ..., x_n, y_1, ... , y_n \in \mathbb{R}\)</span>. Then, computing OT boils down to sorting the points. Indeed, for all costs of the above form, the optimal permutation between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> is <span class="math inline">\(\sigma^* = \sigma_x^{-1} \circ \sigma_y\)</span> where <span class="math inline">\(\sigma_x\)</span> is the permutation sorting the <span class="math inline">\(x_i\)</span> and <span class="math inline">\(\sigma_y\)</span> the one sorting the <span class="math inline">\(y_i\)</span>. In particular, one has:</p>
<p><span class="math display">\[
W_c(\mu, \nu) = \frac{1}{n} \sum_{i=1}^n c(x_i, y_{\sigma_x^{-1} \circ \sigma_y(i)}) = \frac{1}{n} \sum_{i=1}^n c(x_{\sigma_x(i)}, y_{\sigma_y(i)})
\]</span></p>
<p>Thus, to compute the optimal transport cost, it is sufficient to sort <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>.</p>
<p>Let’s check this fact on an example, by comparing the transport cost obtained by sorting the points to the one obtained with the function <code>ot.emd</code>. To simplify, we generate points <span class="math inline">\(x,y \subset \mathbb{R}\)</span> s.t. <span class="math inline">\(x\)</span> is sorted, i.e.&nbsp;<span class="math inline">\(\sigma_x = I_d\)</span> and then <span class="math inline">\(\sigma^*=\sigma_y\)</span>. Therefore, computing the optimal assignement amounts to sort <span class="math inline">\(y\)</span>.</p>
<div id="25fcabee" class="cell" data-executioninfo="{&quot;elapsed&quot;:273,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677186314277,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="e7ad5225-5ac8-42bd-b442-1b48fdbb8fd9" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generate points</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>n, <span class="dv">2</span>) <span class="op">+</span> <span class="fl">.25</span> <span class="op">*</span> np.random.normal(size<span class="op">=</span>(n,))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> np.ones(n) <span class="op">/</span> n</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="dv">2</span><span class="op">*</span>n<span class="op">+</span><span class="dv">1</span>, <span class="dv">2</span>) <span class="op">+</span> <span class="fl">.25</span> <span class="op">*</span> np.random.normal(size<span class="op">=</span>(n,))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>np.random.shuffle(y)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> np.ones(n) <span class="op">/</span> n</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># plot points</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>plot_points_1D(</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    x, y,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"1D points"</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OT1_files/figure-html/cell-15-output-1.png" width="912" height="502" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<p><strong>Question:</strong></p>
<ul>
<li>For <span class="math inline">\(\ell_1\)</span> and <span class="math inline">\(\ell_2^2\)</span> geometries (<span class="math inline">\(\ell_2\)</span> and <span class="math inline">\(\ell_1\)</span> coincides on <span class="math inline">\(\mathbb{R}\)</span>), compute the optimal assignement and optimal transport cost by sorting <span class="math inline">\(y\)</span>. Put the assignement into a vector <span class="math inline">\(s \in \mathbb{R}^n\)</span>, s.t. <span class="math inline">\(x_i\)</span> is mapped to <span class="math inline">\(y_{s_i}\)</span>, i.e.&nbsp;<span class="math inline">\(s_i = \sigma^*(i)\)</span>. Is it different according to the geometry?</li>
<li>Put now the assignment you obtained by sorting the points in the form of a transport plan <span class="math inline">\(P^* \in \mathbb{R}^{n \times n}\)</span>. Check that you obtain the results with <code>ot.emd</code>.</li>
</ul>
<p><strong>Answer:</strong></p>
<div id="8dc74390" class="cell" data-executioninfo="{&quot;elapsed&quot;:4,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677186314690,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="23e277c0-b38f-4c1e-a9c5-fbd73d39c2bf" data-execution_count="16">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sort the points</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>y_sorted <span class="op">=</span> np.sort(y)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get optimal assignment as a vector</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>assignment <span class="op">=</span> np.argsort(y)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># transform it to a transport plan</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>optimal_plan <span class="op">=</span> np.zeros((n,n))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, idx <span class="kw">in</span> <span class="bu">enumerate</span>(assignment):</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    optimal_plan[i, idx] <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> n</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"optimal transport plan obtained by sorting the points:</span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>optimal_plan<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># The result doesn't match the lecturer's</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>optimal transport plan obtained by sorting the points:
 [[0.  0.  0.  0.2 0. ]
 [0.2 0.  0.  0.  0. ]
 [0.  0.  0.  0.  0.2]
 [0.  0.2 0.  0.  0. ]
 [0.  0.  0.2 0.  0. ]]</code></pre>
</div>
</div>
<div id="b5afb5d2" class="cell" data-executioninfo="{&quot;elapsed&quot;:213,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677186314899,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="320be5fd-7139-48fd-81b0-8491f131fb6a" data-execution_count="17">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># l1 geometry</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"l1 geometry:"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>C_l1 <span class="op">=</span> get_cost_matrix(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>x, y<span class="op">=</span>y,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    cost_fn<span class="op">=</span><span class="kw">lambda</span> x,y: np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(x <span class="op">-</span> y))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>optimal_plan_l1, optimal_cost_l1 <span class="op">=</span> compute_transport(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l1,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>a,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>b,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"is it equal to the one obtained by sorting the points? "</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>np<span class="sc">.</span>array_equal(optimal_plan_l1, optimal_plan)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>l1 geometry:
optimal transport plan: 
[[0.  0.  0.  0.2 0. ]
 [0.2 0.  0.  0.  0. ]
 [0.  0.  0.  0.  0.2]
 [0.  0.2 0.  0.  0. ]
 [0.  0.  0.2 0.  0. ]]
transport cost: 1.149278108705205
is it equal to the one obtained by sorting the points? True</code></pre>
</div>
</div>
<div id="48bfd142" class="cell" data-executioninfo="{&quot;elapsed&quot;:3,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677186314900,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="7541cb4f-8dbe-42e0-f51a-b59415be0933" data-execution_count="18">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># squared l2 geometry</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_permutation(matrix):</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Check if a given matrix is a permutation matrix.</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    n, m <span class="op">=</span> matrix.shape</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">!=</span> m:</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    row_sum <span class="op">=</span> np.<span class="bu">sum</span>(matrix, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    col_sum <span class="op">=</span> np.<span class="bu">sum</span>(matrix, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">all</span>(row_sum <span class="op">==</span> <span class="dv">1</span>) <span class="kw">and</span> np.<span class="bu">all</span>(col_sum <span class="op">==</span> <span class="dv">1</span>) <span class="kw">and</span> np.<span class="bu">all</span>((matrix <span class="op">==</span> <span class="dv">0</span>) <span class="op">|</span> (matrix <span class="op">==</span> <span class="dv">1</span>))</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>C_l2_sq <span class="op">=</span> get_cost_matrix(</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>x, y<span class="op">=</span>y,</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    cost_fn<span class="op">=</span><span class="kw">lambda</span> x,y: np.<span class="bu">sum</span>((x <span class="op">-</span> y) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>optimal_plan_l2_sq, optimal_cost_l2_sq <span class="op">=</span> compute_transport(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l2_sq,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>a,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>b,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"is permutation matrix? </span><span class="sc">{</span>is_permutation(optimal_plan_l2_sq)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"is it equal to the one obtained by sorting the points? "</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>np<span class="sc">.</span>array_equal(optimal_plan_l2_sq, optimal_plan)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>optimal transport plan: 
[[0.  0.  0.  0.2 0. ]
 [0.2 0.  0.  0.  0. ]
 [0.  0.  0.  0.  0.2]
 [0.  0.2 0.  0.  0. ]
 [0.  0.  0.2 0.  0. ]]
transport cost: 1.3651629169059696
is permutation matrix? False
is it equal to the one obtained by sorting the points? True</code></pre>
</div>
</div>
<hr>
<p>Finally, one can plot the assignement.</p>
<div id="c84a300e" class="cell" data-executioninfo="{&quot;elapsed&quot;:317,&quot;status&quot;:&quot;error&quot;,&quot;timestamp&quot;:1677186795376,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="a141fcda-eba6-4c02-ecf5-51b232fe6478" data-execution_count="19">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>plot_assignement_1D(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    x, y,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"1D assignement"</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OT1_files/figure-html/cell-19-output-1.png" width="912" height="502" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sinkhorn-アルゴリズム" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="sinkhorn-アルゴリズム"><span class="header-section-number">2</span> Sinkhorn アルゴリズム</h2>
<section id="adding-negative-entropy-as-a-regularizer" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="adding-negative-entropy-as-a-regularizer"><span class="header-section-number">2.1</span> Adding negative entropy as a regularizer</h3>
<p>In real ML applications, we often deal with large numbers of points. In this case, cubic complexity linear programming algorithms are too costly. This motivates (among other reasons) the regularized approach <span class="math display">\[
    \min_{P \in \mathcal{U}(a,b)} \langle C, P \rangle + \epsilon \sum_{ij} P_{ij} [ \log(P_{ij}) - 1].
\]</span> For <span class="math inline">\(\epsilon\)</span> is sufficiently small, one expects to recover an approximation of the original optimal transport plan.</p>
</section>
<section id="the-sinkhorn-iterates" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="the-sinkhorn-iterates"><span class="header-section-number">2.2</span> The Sinkhorn iterates</h3>
<p>In order to solve this problem, one can remark that the optimality conditions imply that a solution <span class="math inline">\(P_\epsilon^*\)</span> necessarily is of the form <span class="math inline">\(P_\epsilon^* = \text{diag}(u) \, K \, \text{diag}(v)\)</span>, where <span class="math inline">\(K = \exp(-C/\epsilon)\)</span> and <span class="math inline">\(u,v\)</span> are two non-negative vectors.</p>
<p><span class="math inline">\(P_\epsilon^*\)</span> should verify the constraints, i.e.&nbsp;<span class="math inline">\(P_\epsilon^* \in U(a,b)\)</span>, so that <span class="math display">\[
    P_\epsilon^* 1_m = a \text{  and  } (P_\epsilon^*)^T 1_n = b
\]</span> which can be rewritten as <span class="math display">\[
    u \odot (Kv) = a \text{  and  } v \odot (K^T u) = b
\]</span></p>
<p>Then Sinkhorn’s algorithm alternates between the resolution of these two equations, and reads at iteration <span class="math inline">\(t\)</span>: <span class="math display">\[
    u^{t+1} \leftarrow \frac{a}{Kv^t} \text{  and  } v^{t+1} \leftarrow \frac{b}{K^T u^{t+1}}
\]</span></p>
</section>
<section id="initialization-and-convergence" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="initialization-and-convergence"><span class="header-section-number">2.3</span> Initialization and convergence</h3>
<p>Usually, it starts from <span class="math inline">\(v^{0} = \mathrm{1}_m\)</span> and alternate the above updates until <span class="math inline">\(\|u^{t+1} \odot (Kv^{t+1}) - a\|_1 + \|v^{t+1} \odot (K^T u^{t+1}) - b\|_1 \leq \tau\)</span>, where <span class="math inline">\(\tau &gt; 0\)</span> is a fixed convergence threshold. Actually, since at the end of each iteration, one exactly has <span class="math inline">\(v^{t+1} \odot (K^T u^{t+1}) = b\)</span>, it just remains to test if <span class="math inline">\(\|u^{t+1} \odot (Kv^{t+1}) - a\|_1 \leq \tau\)</span>.</p>
<p>From an entropic optimal transport plan <span class="math inline">\(P^*_\epsilon\)</span>, we can approximate the optimal transport cost by <span class="math inline">\(\sum_{i,j=1}^n P^*_{\epsilon_{ij}} C_{ij} = ⟨C, P^*_\epsilon⟩\)</span>. For the rest of the section, we call this quantity the entropic optimal transport cost.</p>
</section>
<section id="sinkhorn-implementation" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="sinkhorn-implementation"><span class="header-section-number">2.4</span> Sinkhorn Implementation</h3>
<p>In this section, you will implement your own version of the Sinkhorn Algorithm.</p>
<hr>
<p><strong>Question:</strong> Complete the following Sinkhorn algorithm, by:</p>
<ul>
<li>Computing the kernel matrix <span class="math inline">\(K = \exp(-C / \epsilon)\)</span>,</li>
<li>Starting from <span class="math inline">\(v^{0} = \mathrm{1}_m\)</span>,</li>
<li>Alternating the updates <span class="math inline">\(u^{t+1} \odot (Kv^t) = a\)</span> and <span class="math inline">\(v^{t+1} \odot (K^T u^{t+1}) = b\)</span>,</li>
<li>Declaring convergence when <span class="math inline">\(\|u^t \odot (Kv^t) - a\|_1 + \|v^t \odot (K^T u^t) - b\|_1 \leq \tau\)</span>.</li>
</ul>
<p><strong>Remark:</strong> you should also use also a maximum number of iterations <code>max_iter</code>, to stop the algorithm after a fixed number of iterations if the convergence is not reached.</p>
<p><strong>Answer:</strong></p>
<div id="6f04749c" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sinkhorn(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    a: np.ndarray,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    b: np.ndarray,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    C: np.ndarray,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    epsilon: <span class="bu">float</span>,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    max_iters: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    tau: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Sinnkhorn's algorithm. It should output the optimal transport plan.</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> np.exp( <span class="op">-</span>C <span class="op">/</span> epsilon )</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    n, m <span class="op">=</span> a.shape[<span class="dv">0</span>], b.shape[<span class="dv">0</span>]</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.ones((m,))</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(max_iters):</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> a <span class="op">/</span> K.dot(v)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> b <span class="op">/</span> K.transpose().dot(u)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> u[:,<span class="va">None</span>] <span class="op">*</span> v[<span class="va">None</span>,:] <span class="op">*</span> K  <span class="co"># u_i, v_j, K_ij</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="90f5cee2" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> sinkhorn(a, b, C_l2_sq, epsilon<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(P.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(P.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0.2 0.2 0.2 0.2 0.2]
[0.19757988 0.19787653 0.20030352 0.20090692 0.20333316]</code></pre>
</div>
</div>
<div id="0c0f4e06" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> sinkhorn(a, b, C_l2_sq, epsilon<span class="op">=</span><span class="dv">1</span>, max_iters<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(P.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(P.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0.2 0.2 0.2 0.2 0.2]
[0.19997544 0.1999764  0.20000093 0.20000297 0.20004426]</code></pre>
</div>
</div>
<div id="c25ad2c4" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sinkhorn(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    a: np.ndarray,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    b: np.ndarray,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    C: np.ndarray,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    epsilon: <span class="bu">float</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    max_iters: <span class="bu">int</span> <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    tau: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Sinnkhorn's algorithm. It should output the optimal transport plan.</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> np.exp( <span class="op">-</span>C <span class="op">/</span> epsilon )</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    n, m <span class="op">=</span> a.shape[<span class="dv">0</span>], b.shape[<span class="dv">0</span>]</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.ones((m,))</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(max_iters):</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> a <span class="op">/</span> K.dot(v)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> b <span class="op">/</span> K.transpose().dot(u)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># compute row sum D(u) K D(v) = u * Kv</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(u <span class="op">*</span> K.dot(v) <span class="op">-</span> a)) <span class="op">&lt;</span> tau:</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">'early termination: '</span> <span class="op">+</span> <span class="bu">str</span>(i))</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> u[:,<span class="va">None</span>] <span class="op">*</span> v[<span class="va">None</span>,:] <span class="op">*</span> K  <span class="co"># u_i, v_j, K_ij</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c992f3b4" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> sinkhorn(a, b, C_l2_sq, epsilon<span class="op">=</span><span class="dv">1</span>, max_iters<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(P.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(P.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>early termination: 990
[0.2 0.2 0.2 0.2 0.2]
[0.19997453 0.19997552 0.20000097 0.20000309 0.20004589]</code></pre>
</div>
</div>
<div id="e9464c15" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> sinkhorn(a, b, C_l2_sq, epsilon<span class="op">=</span><span class="fl">0.1</span>, max_iters<span class="op">=</span><span class="dv">10000</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(P.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(P.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0.2 0.2 0.2 0.2 0.2]
[0.19995991 0.19997995 0.2        0.20002005 0.2000401 ]</code></pre>
</div>
</div>
<hr>
<p>Now, we can test the Sinkhorn algorithm on the “croissant” transport example.</p>
<hr>
<p><strong>Question:</strong> * Complete the following fuction that takes as input the cost matrix <span class="math inline">\(C\)</span> and the weights vectors <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> and outputs the entropic optimal transport plan and the entropic optimal transport cost using the <code>sinkhorn</code> function. As for the exact transport, it has an option to display the results. * Use that function on the croissant transport to compute and display the optimal plan and the optimal cost for the <span class="math inline">\(\ell_1, \ell_2\)</span> and <span class="math inline">\(\ell_2^2\)</span> geometries. * Each time you run the Sinkhorn algorithm, you should use <span class="math inline">\(\epsilon = 0.1 \cdot \bar{C}\)</span>, with <span class="math inline">\(\bar{C} = \frac{1}{nm} \sum_{i=1}^n \sum_{j=1}^m C_{ij}\)</span> is the mean of the cost matrix. It remains to adapt the <span class="math inline">\(\epsilon\)</span> value according to the cost matrix, to control the magnitude of the entries of <span class="math inline">\(C / \epsilon\)</span>. Why this strategy? What will happen if <span class="math inline">\(\epsilon\)</span> is too small compared to the entries of <span class="math inline">\(C\)</span>?</p>
<p><strong>Answer:</strong></p>
<div id="3e59d629" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_transport_sinkhorn(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    C: np.ndarray,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    a: np.ndarray,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    b: np.ndarray,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    epsilon: <span class="bu">float</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    max_iters: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10_000</span>,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    tau: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1e-4</span>,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    verbose: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">  Compute the entropic optimal transport plan and the entropic optimal transport cost</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">  for cost matrix ``C`` and weight vectors $a$ and $b$.</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">  If ``verbose`` is set to True, it displays the results.</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  optimal_plan_sinkhorn <span class="op">=</span> sinkhorn(a, b, C, epsilon, max_iters, tau)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  optimal_cost_sinkhorn <span class="op">=</span> np.<span class="bu">sum</span>(optimal_plan_sinkhorn <span class="op">*</span> C)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> verbose:</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"entropic optimal transport plan: </span><span class="ch">\n</span><span class="sc">{</span>optimal_plan_sinkhorn<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"entropic transport cost: </span><span class="sc">{</span>optimal_cost_sinkhorn<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> optimal_plan_sinkhorn, optimal_cost_sinkhorn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ade3fc59" class="cell" data-executioninfo="{&quot;elapsed&quot;:5,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677186319119,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="9f68f4d1-f6ce-41e9-990e-b0890b4084cb" data-execution_count="27">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># l1 geometry</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"l1 geometry:"</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>C_l1 <span class="op">=</span> get_cost_matrix(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>bakery_pos, y<span class="op">=</span>cafe_pos,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    cost_fn<span class="op">=</span><span class="kw">lambda</span> x,y: np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(x <span class="op">-</span> y))</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>optimal_plan_sinkhorn_l1_croissant, optimal_cost_sinkhorn_l1_croissant <span class="op">=</span> compute_transport_sinkhorn(</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l1,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    epsilon<span class="op">=</span>epsilon,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>l1 geometry:
early termination: 5970
entropic optimal transport plan: 
[[2.70428936e-002 4.32583290e-002 1.34214268e-047 1.83509051e-086
  1.62880160e-235]
 [3.42773260e-084 1.30691077e-046 1.08827539e-001 1.90100995e-040
  1.68731081e-189]
 [7.15328153e-002 1.14425257e-001 4.99347632e-122 4.85411038e-086
  4.30844293e-235]
 [2.61705422e-002 4.18628990e-002 5.77469196e-189 1.77589404e-086
  1.57625961e-235]
 [1.25908361e-049 4.80057848e-012 2.70172554e-084 9.07098043e-002
  1.22406524e-115]
 [2.66904088e-052 1.01764013e-014 9.97892408e-002 1.92289196e-004
  8.84651301e-003]
 [5.95876320e-051 4.18968529e-019 7.18872709e-119 4.29294956e-003
  1.97502693e-001]
 [6.11947921e-002 7.27950530e-029 1.24902883e-128 1.04351442e-001
  5.20381800e-060]]
entropic transport cost: 177.27648952346257</code></pre>
</div>
</div>
<div id="7d31f270" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(optimal_plan_sinkhorn_l1_croissant)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OT1_files/figure-html/cell-28-output-1.png" width="268" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="39fdc41d" class="cell" data-executioninfo="{&quot;elapsed&quot;:5,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677186319120,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="6ef09f42-96b6-42af-c4e0-a280acda8139" data-execution_count="29">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># l2 geometry</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"l2 geometry:"</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>C_l2 <span class="op">=</span> get_cost_matrix(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>bakery_pos, y<span class="op">=</span>cafe_pos,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    cost_fn<span class="op">=</span><span class="kw">lambda</span> x,y: np.linalg.norm(x <span class="op">-</span> y, <span class="bu">ord</span><span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> np.mean(C_l2_sq) <span class="op">*</span> <span class="fl">0.05</span> <span class="co"># compute the optimal value to avoid underflow</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>optimal_plan_sinkhorn_l2_croissant, optimal_cost_sinkhorn_l2_croissant <span class="op">=</span> compute_transport_sinkhorn(</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l2,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    epsilon<span class="op">=</span>epsilon,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>l2 geometry:
early termination: 6480
entropic optimal transport plan: 
[[1.47195199e-002 5.55812693e-002 2.07887308e-066 1.89085801e-083
  4.08212986e-215]
 [4.71170808e-067 2.26166564e-043 1.08836263e-001 9.74649907e-077
  7.01848099e-170]
 [4.19924977e-002 1.43964413e-001 2.66725594e-094 2.03490446e-086
  7.16649420e-222]
 [6.80327467e-002 4.36749516e-013 5.13671791e-141 2.72754187e-101
  3.05721358e-239]
 [1.24385751e-021 8.02928239e-007 1.04149196e-050 9.07085294e-002
  6.66796031e-098]
 [8.63129441e-026 1.06829448e-010 9.97805175e-002 4.48903087e-003
  4.56691630e-003]
 [2.65261029e-046 2.59222291e-040 8.94588488e-063 2.71496095e-025
  2.01782290e-001]
 [6.11962788e-002 1.70632530e-011 1.98854584e-093 1.04348925e-001
  1.28895438e-052]]
entropic transport cost: 139.5030886918118</code></pre>
</div>
</div>
<div id="91cc4d96" class="cell" data-executioninfo="{&quot;elapsed&quot;:4,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677186319120,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="fa8c9abe-a06e-4c76-d059-e97687851c26" data-execution_count="30">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># squared l2 geometry</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"squared l2 geometry:"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>C_l2_sq <span class="op">=</span> get_cost_matrix(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>bakery_pos, y<span class="op">=</span>cafe_pos,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    cost_fn<span class="op">=</span><span class="kw">lambda</span> x,y: np.<span class="bu">sum</span>((x <span class="op">-</span> y) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> np.mean(C_l2_sq) <span class="op">*</span> <span class="fl">0.05</span> <span class="co"># compute the optimal value to avoid underflow</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>optimal_plan_sinkhorn_l2_sq_croissant, optimal_cost_sinkhorn_l2_sq_croissant <span class="op">=</span> compute_transport_sinkhorn(</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l2_sq,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    epsilon<span class="op">=</span>epsilon,</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>squared l2 geometry:
early termination: 390
entropic optimal transport plan: 
[[9.15185856e-03 6.11459020e-02 2.53416007e-06 9.36830019e-11
  5.88710931e-33]
 [1.98312263e-09 2.86298466e-05 1.08801507e-01 2.62245737e-07
  1.22762517e-18]
 [1.02592189e-01 8.33635462e-02 3.95058637e-08 1.25018168e-08
  7.16059834e-28]
 [6.36539082e-02 4.37874407e-03 9.20213996e-12 8.38044497e-09
  1.80226054e-26]
 [1.15178824e-03 4.78786088e-02 4.40333811e-04 4.12385828e-02
  1.04144097e-10]
 [1.27912352e-15 1.00116432e-09 9.93719135e-02 7.28353201e-04
  8.73056135e-03]
 [5.51097456e-13 1.50024181e-09 4.51186568e-07 4.17827621e-03
  1.97618514e-01]
 [9.39129734e-03 2.75105187e-03 4.51869851e-10 1.53400990e-01
  1.31200779e-07]]
entropic transport cost: 24883.330683517215</code></pre>
</div>
</div>
<hr>
</section>
<section id="the-effect-of-epsilon" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="the-effect-of-epsilon"><span class="header-section-number">2.5</span> The effect of <span class="math inline">\(\epsilon\)</span></h3>
<p>Now we can display the transportation plans obtained with Sinkhorn’s algortihm, as we did for the exact OT.</p>
<div id="77c109f3" class="cell" data-executioninfo="{&quot;elapsed&quot;:1917,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677186324355,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="329a7955-acc7-490f-89e6-e7407763932c" data-execution_count="31">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">9</span><span class="op">*</span><span class="dv">3</span>, <span class="dv">7</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>plans <span class="op">=</span> [optimal_plan_sinkhorn_l1_croissant,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>         optimal_plan_sinkhorn_l2_croissant,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>         optimal_plan_sinkhorn_l2_sq_croissant]</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> [<span class="vs">r"$\ell_1$ geometry"</span>, <span class="vs">r"$\ell_2$ geometry"</span>, <span class="vs">r"$\ell_2^2$ geometry"</span>]</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> axes, plan, title <span class="kw">in</span> <span class="bu">zip</span>(ax, plans, titles):</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  plot_assignement(</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>      ax<span class="op">=</span>axes,</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>      x<span class="op">=</span>bakery_pos, a<span class="op">=</span>bakery_prod, x_label<span class="op">=</span><span class="st">"Bakeries"</span>,</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>      y<span class="op">=</span>cafe_pos, b<span class="op">=</span>cafe_prod, y_label<span class="op">=</span><span class="st">"Cafés"</span>,</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>      optimal_plan<span class="op">=</span>plan,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>      title<span class="op">=</span>title</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OT1_files/figure-html/cell-31-output-1.png" width="2028" height="586" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Note: There always is some transport at every edge in Sinkhorn algorithm’s output.</p>
<div id="4d3071c7" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">9</span><span class="op">*</span><span class="dv">3</span>, <span class="dv">7</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>plans <span class="op">=</span> [optimal_plan_l1_croissant,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>         optimal_plan_l2_croissant,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>         optimal_plan_l2_sq_croissant]</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> [<span class="vs">r"$\ell_1$ geometry"</span>, <span class="vs">r"$\ell_2$ geometry"</span>, <span class="vs">r"$\ell_2^2$ geometry"</span>]</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> axes, plan, title <span class="kw">in</span> <span class="bu">zip</span>(ax, plans, titles):</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  plot_assignement(</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>      ax<span class="op">=</span>axes,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>      x<span class="op">=</span>bakery_pos, a<span class="op">=</span>bakery_prod, x_label<span class="op">=</span><span class="st">"Bakeries"</span>,</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>      y<span class="op">=</span>cafe_pos, b<span class="op">=</span>cafe_prod, y_label<span class="op">=</span><span class="st">"Cafés"</span>,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>      optimal_plan<span class="op">=</span>plan,</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>      title<span class="op">=</span>title</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OT1_files/figure-html/cell-32-output-1.png" width="2028" height="586" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The above transport plans are obtained for <span class="math inline">\(\epsilon = 0.1 \cdot \bar{C}\)</span>. Let’s increase epsilon to <span class="math inline">\(\epsilon = 10 \cdot \bar{C}\)</span> and replot the optimal transport plans to visualize the effect of epsilon.</p>
<div id="5c62979e" class="cell" data-executioninfo="{&quot;elapsed&quot;:1524,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677186325876,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="861f6970-aac7-4b0c-ec5d-0936d100ef45" data-execution_count="33">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># l1 geometry</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> <span class="dv">10</span> <span class="op">*</span> np.mean(C_l1)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>optimal_plan_sinkhorn_l1_croissant, optimal_cost_sinkhorn_l1_croissant <span class="op">=</span> compute_transport_sinkhorn(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l1,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    epsilon<span class="op">=</span>epsilon,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="co"># l2 geometry</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> <span class="dv">10</span> <span class="op">*</span> np.mean(C_l2)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>optimal_plan_sinkhorn_l2_croissant, optimal_cost_sinkhorn_l2_croissant <span class="op">=</span> compute_transport_sinkhorn(</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l2,</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    epsilon<span class="op">=</span>epsilon,</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="co"># squared l2 geometry</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>epsilon <span class="op">=</span> <span class="dv">10</span> <span class="op">*</span> np.mean(C_l2_sq)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>optimal_plan_sinkhorn_l2_sq_croissant, optimal_cost_sinkhorn_l2_sq_croissant <span class="op">=</span> compute_transport_sinkhorn(</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    C<span class="op">=</span>C_l2_sq,</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    a<span class="op">=</span>bakery_prod,</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    b<span class="op">=</span>cafe_prod,</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    epsilon<span class="op">=</span>epsilon,</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">9</span><span class="op">*</span><span class="dv">3</span>, <span class="dv">7</span>)</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>plans <span class="op">=</span> [optimal_plan_l1_croissant,</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>         optimal_plan_l2_croissant,</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>         optimal_plan_l2_sq_croissant]</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> [<span class="vs">r"$\ell_1$ geometry"</span>, <span class="vs">r"$\ell_2$ geometry"</span>, <span class="vs">r"$\ell_2^2$ geometry"</span>]</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> axes, plan, title <span class="kw">in</span> <span class="bu">zip</span>(ax, plans, titles):</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>  plot_assignement(</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>      ax<span class="op">=</span>axes,</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>      x<span class="op">=</span>bakery_pos, a<span class="op">=</span>bakery_prod, x_label<span class="op">=</span><span class="st">"Bakeries"</span>,</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>      y<span class="op">=</span>cafe_pos, b<span class="op">=</span>cafe_prod, y_label<span class="op">=</span><span class="st">"Cafés"</span>,</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>      optimal_plan<span class="op">=</span>plan,</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>      title<span class="op">=</span>title</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>early termination: 10
early termination: 10
early termination: 10</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OT1_files/figure-html/cell-33-output-2.png" width="2028" height="586" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Note: If the epsilon is large, the distribution is close to uniform.</p>
<hr>
<p><strong>Question:</strong> What do you observe in relation to the transport plans obtained for the exact optimal transport?</p>
<p><strong>Answer:</strong></p>
<hr>
</section>
<section id="sinkhorn-consistency" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="sinkhorn-consistency"><span class="header-section-number">2.6</span> Sinkhorn consistency</h3>
<p>We now show that this Sinkhorn algorithm is consistent with classical optimal transport, using the “croissant” transport example and focusing on the <span class="math inline">\(\ell_2\)</span> cost.</p>
<hr>
<p><strong>Question:</strong> Complete the following code to compute, for various <span class="math inline">\(\epsilon'\)</span>, values on a regular grid: * Set <span class="math inline">\(\epsilon = \epsilon' \cdot \bar{C}\)</span>, * The deviation of the entropic optimal plan <span class="math inline">\(P^*_\epsilon\)</span> to the exact optimal plan <span class="math inline">\(P^*\)</span>, namely <span class="math inline">\(\|P^*_\epsilon - P^*\|_2\)</span>. * The deviation of the entropic optimal cost <span class="math inline">\(\langle C, P^*_\epsilon \rangle\)</span> to the exact optimal plan <span class="math inline">\(\langle C, P^*_\epsilon \rangle\)</span>, namely: <span class="math inline">\(\langle C, P^*_\epsilon \rangle - \langle C, P^* \rangle\)</span>.</p>
<p>We remind that the excat optimal transport plan for the <span class="math inline">\(\ell_2\)</span> cost is stored as variable <code>optimal_plan_l2_croissant</code>.</p>
<p><strong>Answer:</strong></p>
<div id="68fb303e" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>plan_diff <span class="op">=</span> []</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>distance_diff <span class="op">=</span> []</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> np.linspace(<span class="fl">0.01</span>, <span class="dv">5</span>, <span class="dv">100</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epsilon_prime <span class="kw">in</span> grid:</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  epsilon <span class="op">=</span> epsilon_prime <span class="op">*</span> np.mean(C_l2)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  optimal_plan_sinkhorn_l2_croissant, optimal_cost_sinkhorn_l2_croissant <span class="op">=</span> compute_transport_sinkhorn(</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>      C<span class="op">=</span>C_l2,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>      a<span class="op">=</span>bakery_prod,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>      b<span class="op">=</span>cafe_prod,</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>      epsilon<span class="op">=</span>epsilon,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>      verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">assert</span> optimal_cost_sinkhorn_l2_croissant <span class="op">!=</span> np.nan, (</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Optimal cost is nan due to numerical instabilities."</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  plan_diff.append(</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>      np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(optimal_plan_sinkhorn_l2_croissant <span class="op">-</span> optimal_plan_l2_croissant))</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  distance_diff.append(</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>      optimal_cost_sinkhorn_l2_croissant <span class="op">-</span> optimal_cost_l2_croissant</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>early termination: 2460
early termination: 220
early termination: 50
early termination: 30
early termination: 20
early termination: 20
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10
early termination: 10</code></pre>
</div>
</div>
<hr>
<p>Now, let’s plot the results.</p>
<div id="4b0cca58" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">5</span><span class="op">*</span><span class="dv">2</span>))</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>reg_strengths <span class="op">=</span> np.mean(C_l2) <span class="op">*</span> grid</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>plot_consistency(</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    reg_strengths,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    plan_diff,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    distance_diff</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/homebrew/lib/python3.12/site-packages/IPython/core/pylabtools.py:170: UserWarning: Data has no positive values, and therefore cannot be log-scaled.
  fig.canvas.print_figure(bytes_io, **kw)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="OT1_files/figure-html/cell-35-output-2.png" width="1335" height="844" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Note: The result is different from the lecturer’s.</p>
</section>
</section>
<section id="ott-パッケージ" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="ott-パッケージ"><span class="header-section-number">3</span> <code>OTT</code> パッケージ</h2>
<section id="install-ott" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="install-ott"><span class="header-section-number">3.1</span> Install <code>OTT</code></h3>
<p>First, you need to install <code>OTT</code>.</p>
<div id="c4a20535" class="cell" data-executioninfo="{&quot;elapsed&quot;:4333,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677180333767,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="8e7c9ade-b5c5-40ca-e624-0353e1feab1f" data-execution_count="36">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install ott<span class="op">-</span>jax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>error: externally-managed-environment

× This environment is externally managed
╰─&gt; To install Python packages system-wide, try brew install
    xyz, where xyz is the package you are trying to
    install.
    
    If you wish to install a Python library that isn't in Homebrew,
    use a virtual environment:
    
    python3 -m venv path/to/venv
    source path/to/venv/bin/activate
    python3 -m pip install xyz
    
    If you wish to install a Python application that isn't in Homebrew,
    it may be easiest to use 'pipx install xyz', which will manage a
    virtual environment for you. You can install pipx with
    
    brew install pipx
    
    You may restore the old behavior of pip by passing
    the '--break-system-packages' flag to pip, or by adding
    'break-system-packages = true' to your pip.conf file. The latter
    will permanently disable this error.
    
    If you disable this error, we STRONGLY recommend that you additionally
    pass the '--user' flag to pip, or set 'user = true' in your pip.conf
    file. Failure to do this can result in a broken Homebrew installation.
    
    Read more about this behavior here: &lt;https://peps.python.org/pep-0668/&gt;

note: If you believe this is a mistake, please contact your Python installation or OS distribution provider. You can override this, at the risk of breaking your Python installation or OS, by passing --break-system-packages.
hint: See PEP 668 for the detailed specification.
Note: you may need to restart the kernel to use updated packages.</code></pre>
</div>
</div>
<p>Then we load the required pakages.</p>
<div id="21ad542a" class="cell" data-executioninfo="{&quot;elapsed&quot;:1083,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677180334848,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="5cf76243-4b95-46d7-ffe6-6fde9cedc07d" data-execution_count="37">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.random <span class="im">as</span> random</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ott</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ott.geometry <span class="im">import</span> costs, pointcloud</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ott.problems.linear <span class="im">import</span> linear_problem</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ott.solvers.linear <span class="im">import</span> sinkhorn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-world-about-ott-and-jax" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="a-world-about-ott-and-jax"><span class="header-section-number">3.2</span> A world about <code>OTT</code> and <code>JAX</code></h3>
<p><code>OTT</code> is a python library that allows to compute and differentiate the entropic optimal transport. In this lab session, we will focus on entropic optimal transport computation, and not differentiation. differentiation will be takcled later.</p>
<p><code>OTT</code> is based on <code>JAX</code>, a package similar to <code>PyTorch</code> or <code>TensorFlow</code>, which allows to do automatic differentiation and GPU programming. It also provides useful primitives for efficient computation, such as the just-in-time (<code>jit</code>) compilation or the automatic vectorization map <code>vmap</code>. For more informations on <code>JAX</code>, see the tutorial https://jax.readthedocs.io/en/latest/notebooks/quickstart.html.</p>
<p>Unlike <code>PyTorch</code> or <code>TensorFlow</code>, <code>JAX</code> is very close to <code>numpy</code> thanks to the <code>jax.numpy</code> package, which implements most of the <code>numpy</code> features, but for the <code>JAX</code> data structures. For this lab session, you only need to know how to manipulate <code>jax.numpy</code> Arrays and generate random numbers with <code>jax.random</code>.</p>
<p>First, let’s have a look to <code>jax.numpy</code> and see that it works (almost) exactly as numpy. Usually, one imports <code>jax.numpy as jnp</code> as done in the above cells, and developp as with <code>numpy</code>, by just replacing <code>np</code> by <code>jnp</code>. Note that <code>jax.numpy</code> Arrays are called <code>DeviceArray</code>. For more informations on <code>jax.numpy</code>, see https://jax.readthedocs.io/en/latest/jax-101/01-jax-basics.html.</p>
<div id="70549218" class="cell" data-executioninfo="{&quot;elapsed&quot;:776,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677177738063,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="102dd072-941c-4376-8da0-243d2d63ae52" data-execution_count="38">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> <span class="dv">5</span> <span class="op">*</span> jnp.ones(<span class="dv">5</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>Id <span class="op">=</span> jnp.eye(<span class="dv">5</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(u))</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"u = </span><span class="sc">{</span>u<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Id = </span><span class="sc">{</span>Id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Id @ u = </span><span class="sc">{</span>jnp<span class="sc">.</span>dot(Id, u)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"sum(u) = </span><span class="sc">{</span>jnp<span class="sc">.</span><span class="bu">sum</span>(u)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"var(u) = </span><span class="sc">{</span>jnp<span class="sc">.</span>var(u)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'jaxlib.xla_extension.ArrayImpl'&gt;
u = [5. 5. 5. 5. 5.]
Id = [[1. 0. 0. 0. 0.]
 [0. 1. 0. 0. 0.]
 [0. 0. 1. 0. 0.]
 [0. 0. 0. 1. 0.]
 [0. 0. 0. 0. 1.]]
Id @ u = [5. 5. 5. 5. 5.]
sum(u) = 25.0
var(u) = 0.0</code></pre>
</div>
</div>
<p>With <code>numpy.random</code>, you can generate random numbers on the fly without giving the <code>seed</code>. For example, <code>np.random.rand()</code> generates a random number <span class="math inline">\(x \sim U([0, 1])\)</span>. Indeed, <code>numpy.random</code> uses an internal seed which is updated each time a random number generating function is called. On the other hand, with <code>jax.random</code>, we must give the <code>seed</code> each time we generate random numbers. To some extent, we want to always control the randomness. Moreover, we do not pass exactly a <code>seed</code> but a <code>jax.random.PRNGKey</code> key which is itself instantiated from a <code>seed</code>. Let’s see it on an example.</p>
<div id="6a2715f3" class="cell" data-executioninfo="{&quot;elapsed&quot;:344,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677177741429,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="40386ca7-8e5b-4019-d976-ca6bad24c043" data-execution_count="39">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> jax.random.PRNGKey(<span class="dv">0</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>n, d <span class="op">=</span> <span class="dv">13</span>, <span class="dv">2</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> jax.random.normal(rng, (n, d))</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"x = </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>x = [[ 2.516351   -1.3947194 ]
 [-0.8633262   0.6413567 ]
 [-0.37789643 -0.6044598 ]
 [ 1.9069     -0.17918469]
 [-0.7583423  -0.5160155 ]
 [ 1.2666148  -0.12342127]
 [ 0.28430256 -0.17251171]
 [ 1.0661486   1.5814103 ]
 [-2.0284636  -0.13168257]
 [-0.14515765  0.21532312]
 [-0.69525063 -0.9314128 ]
 [-0.89809936 -0.25272107]
 [-0.34937173  1.8394127 ]]</code></pre>
</div>
</div>
<p>Then, to have new keys to generate new random numbers, we need to split the key via <code>jax.random.split</code>, which generate <span class="math inline">\(n \geq 2\)</span> new keys from a key.</p>
<div id="056d78bc" class="cell" data-executioninfo="{&quot;elapsed&quot;:592,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677177743638,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="c9c452b7-a183-4e2a-a161-672e75e6514c" data-execution_count="40">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>rng1, rng2, rng3 <span class="op">=</span> jax.random.split(rng, <span class="dv">3</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> jax.random.normal(rng1, (n, d))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> jax.random.normal(rng2, (n, d))</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> jax.random.normal(rng2, (n, d))</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"a = </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"b = </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"c = </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>a = [[-0.38696066 -0.96707183]
 [ 1.0078175  -0.6096286 ]
 [-1.153353    1.0749092 ]
 [-1.2452031  -0.63885343]
 [ 0.01121208  0.2842425 ]
 [ 0.5296049   0.26609063]
 [ 0.8728492   1.0844501 ]
 [ 1.4472795  -0.82503337]
 [-0.41826957  0.21321987]
 [ 1.9602116   0.17687395]
 [-0.9978761  -2.0551765 ]
 [-0.4094941  -1.4577458 ]
 [-1.0969195  -0.66684234]]
b = [[ 0.10911155 -0.45371595]
 [ 0.12062439 -0.06927001]
 [ 0.00600028  2.3732579 ]
 [-0.17656058  1.7653493 ]
 [-0.06429235  0.487175  ]
 [-1.1079016  -1.0277865 ]
 [-0.0553451  -0.28271845]
 [-0.9633478  -0.05370665]
 [ 0.20281292 -0.16658288]
 [ 0.8015828  -0.61697495]
 [-0.30176872 -1.1862007 ]
 [-3.106658   -0.03262986]
 [ 0.53711027  0.21359496]]
c = [[ 0.10911155 -0.45371595]
 [ 0.12062439 -0.06927001]
 [ 0.00600028  2.3732579 ]
 [-0.17656058  1.7653493 ]
 [-0.06429235  0.487175  ]
 [-1.1079016  -1.0277865 ]
 [-0.0553451  -0.28271845]
 [-0.9633478  -0.05370665]
 [ 0.20281292 -0.16658288]
 [ 0.8015828  -0.61697495]
 [-0.30176872 -1.1862007 ]
 [-3.106658   -0.03262986]
 [ 0.53711027  0.21359496]]</code></pre>
</div>
</div>
<p>you now know everything you need for the moment!</p>
</section>
<section id="entropic-optimal-transport-with-ott" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="entropic-optimal-transport-with-ott"><span class="header-section-number">3.3</span> Entropic optimal transport with <code>OTT</code></h3>
<p>Now let’s use the implementation of the <code>OTT</code> Sinkhorn algorithm, on some random weighted point clouds. Then you will, by yourself, use it on the “croissant” transport example.</p>
<p>Let’s first generate the data.</p>
<div id="1d365501" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generate data</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> jax.random.PRNGKey(<span class="dv">0</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>rng1, rng2 <span class="op">=</span> jax.random.split(rng, <span class="dv">2</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>n, m, d <span class="op">=</span> <span class="dv">13</span>, <span class="dv">17</span>, <span class="dv">2</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> jax.random.normal(rng1, (n, d))</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> jax.random.normal(rng2, (m, d)) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> jnp.ones(n) <span class="op">/</span> n</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> jnp.ones(m) <span class="op">/</span> m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we have to define a <code>PointCloud</code> <code>geometry</code> which contains: * the point clouds <code>x</code> and <code>y</code>, * the cost function <code>cost_fn</code>, * the entropic regularization strength <code>epsilon</code>.</p>
<p>Note that the <code>geometry</code> does not contain the weight vectors <code>a</code> and <code>b</code>, these are passed later.</p>
<p>The <code>cost_fn</code> should be an istance of <code>ott.geometry.CostFn</code>. Most of the usual costs are implemented. For example, the three costs <span class="math inline">\(\ell_1, \ell_2\)</span> and <span class="math inline">\(\ell_2^2\)</span> are implemented. Here, we will focus on the <span class="math inline">\(\ell_2\)</span> cost, implemented by <code>ott.geometry.costs.Euclidean</code>. See https://ott-jax.readthedocs.io/en/latest/_autosummary/ott.geometry.costs.CostFn.html#ott.geometry.costs.CostFn for more information on the provided <code>cost_fn</code>.</p>
<p>We still choose <code>epsilon</code> to be <span class="math inline">\(0.1 \cdot \bar{C}\)</span>. To do this, we set <code>relative_epsilon=True</code> when instantiating the geometry. The term <code>relative</code> means that <code>epsilon</code> is chosen relatively to the mean of the cost matrix. Passing then <code>epsilon=0.1</code>, the value of <code>epsilon</code> used by Sinkhorn will be <span class="math inline">\(0.1 \cdot \bar{C}\)</span>.</p>
<div id="d336e0a2" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define geometry</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>geom <span class="op">=</span> pointcloud.PointCloud(</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>x, y<span class="op">=</span>y,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    cost_fn<span class="op">=</span>costs.Euclidean(),</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    epsilon<span class="op">=</span><span class="fl">1e-1</span>,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    relative_epsilon<span class="op">=</span><span class="va">True</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then define an optimization problem from this geometry, which is the problem we will solve with the Sinkhorn algorithm. We instantiate this optimization problem as an object of the class <code>linear_problem.LinearProblem</code>. We pass the weight vectors <code>a</code> and <code>b</code> because they define the constraints of the linear problem. Then, we instantiate a Sinkhorn solver, object of the class <code>sinkhorn.Sinkhorn</code>, which we will use to solve this optimization problem.</p>
<p>The <code>OTT</code> library is designed in this way because it allows to solve other optimal transport problems, which do not necessarily have a linear problem structure, and which use other solvers than Sinkhorn.</p>
<div id="979f902f" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create optimization problem</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>ot_prob <span class="op">=</span> linear_problem.LinearProblem(geom, a<span class="op">=</span>a, b<span class="op">=</span>b)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create sinkhorn solver</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>solver <span class="op">=</span> sinkhorn.Sinkhorn(ot_prob)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># solve the OT problem</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>ot_sol <span class="op">=</span> solver(ot_prob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>ot</code> output object contains several callables and properties, notably a boolean assessing the Sinkhorn convergence, the marginal errors throughtout iterations and the optimal transport plan.</p>
<div id="669e6954" class="cell" data-executioninfo="{&quot;elapsed&quot;:1048,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1677180360140,&quot;user&quot;:{&quot;displayName&quot;:&quot;Théo Uscidda&quot;,&quot;userId&quot;:4606330742318440000},&quot;user_tz&quot;:-60}" data-outputid="e96f56dd-306e-46f9-b1aa-bce66204af1a" data-execution_count="44">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">" Sinkhorn has converged: "</span>,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    ot_sol.converged,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Error upon last iteration: "</span>,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    ot_sol.errors[(ot_sol.errors <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>)][<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sinkhorn required "</span>,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    jnp.<span class="bu">sum</span>(ot_sol.errors <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">" iterations to converge. </span><span class="ch">\n</span><span class="st">"</span>,</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"entropic OT cost: "</span>,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    jnp.<span class="bu">sum</span>(ot_sol.matrix <span class="op">*</span> ot_sol.geom.cost_matrix),</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Sinkhorn has converged:  True 
 Error upon last iteration:  0.00019063428 
 Sinkhorn required  5  iterations to converge. 
 entropic OT cost:  29.436863</code></pre>
</div>
</div>
<hr>
<p><strong>Question:</strong> Compute the entropic optimal transport plan and cost for the “croissant” transport problem, with <span class="math inline">\(\ell_2\)</span> cost and <span class="math inline">\(\epsilon = 0.1 \cdot \bar{C}\)</span>. Then, plot the optimal transport plan.</p>
<p><strong>Answer:</strong></p>
<hr>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="参考文献" class="level2 appendix" data-number="4"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">4</span> 参考文献</h2><div class="quarto-appendix-contents">

<p>Marco Cuturi による <a href="https://colab.research.google.com/drive/1IgR8bL_ihL_kHeZMbX4pIvtXoWieVTfG?usp=sharing">Colab</a> を参考にした．</p>



</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/162348\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          trigger: 'click',
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          positionFixed: true,
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="162348/162348.github.io" data-repo-id="R_kgDOKlfKYQ" data-category="Announcements" data-category-id="DIC_kwDOKlfKYc4CgDmb" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" data-loading="lazy" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://162348.github.io/">
<p>Hirofumi Shiba</p>
</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/162348/162348.github.io/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/ano2math5">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:shiba.hirofumi@ism.ac.jp">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../../../blog.xml">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>