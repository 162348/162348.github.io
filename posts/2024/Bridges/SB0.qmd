---
title: "デノイジング・シュレディンガー橋"
subtitle: "拡散モデルを架橋に使うサンプリング法"
author: "司馬博文"
date: 8/3/2024
date-modified: 10/6/2024
categories: [Process, Sampling, P(X)]
bibliography: 
    - ../../../assets/mathematics.bib
    - ../../../assets/bib.bib
    - ../../../assets/bib1.bib
csl: ../../../assets/apalike.csl
abstract-title: 概要
abstract: 拡散モデルから始まるフロー学習手法は，画像と動画に関して 2024 年時点で最良の性能を誇る．これを統計に用いるために，正確に２つの分布を補間するような拡散過程を推定したい．これを実行する方法に Schrödinger 橋がある．
listing: 
    -   id: diffusion-listing
        type: grid
        sort: false
        contents:
            - "../Samplers/NF1.qmd"
            - "../Samplers/NF3.qmd"
            - "../Samplers/DD1.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
    -   id: SB-listing
        type: grid
        sort: false
        contents:
            - "SB1.qmd"
            - "SB2.qmd"
            - "TransportMethods.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
    -   id: lst-embedding
        type: grid
        sort: false
        grid-columns: 1
        grid-item-align: center
        contents:
            - "../Samplers/DD1.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
    -   id: lst-embedding2
        type: grid
        sort: false
        grid-columns: 1
        grid-item-align: center
        contents:
            - "../Samplers/Diffusion.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
    -   id: lst-embedding3
        type: grid
        sort: false
        grid-columns: 1
        grid-item-align: center
        contents:
            - "../Samplers/NF3.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
    -   id: lst-embedding4
        type: grid
        sort: false
        grid-columns: 1
        grid-item-align: center
        contents:
            - "SB1.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
---

## 関連記事一覧 {.unnumbered .unlisted}

::: {#diffusion-listing}
:::

{{< include ../../../assets/_preamble.qmd >}}

## 雑音除去拡散 (DDPM) {#sec-DDPM}

### はじめに

潜在空間 $\cX$ 上の事前分布 $\mu$ と，尤度が確率核 $\cX\to\cY$
$$
x\mapsto g(y|x)\,dy
$$
の形で与えられているとする．

この際の事後分布
$$
p(x|y)=\frac{g(y|x)\mu(x)}{\int_\cX g(y|x)\mu(x)\,dx}
$$
を償却的に学習し，サンプリングするためには [拡散模型](../Samplers/Diffusion.qmd) (DDPM / SGM) が使える．拡散模型については次稿参照：

::: {#lst-embedding2}
:::

この **サンプラーとしての拡散模型** を，DDPM をもじって DDPS (Denoising Diffusion Posterior Sampler) と呼ぼう．

本稿では生成モデルとしてはお馴染みの拡散模型をサンプラーとして捉えなおし，近似ベイズ推論や逆問題への応用をみる．

しかしこの方法は正確な方法ではない．次稿で Schrödinger 橋を用いて不偏性の達成を目指す：

::: {#lst-embedding4}
:::

### 雑音除去拡散 (DD) の定義

[拡散模型](../Samplers/Diffusion.qmd) は，次で定まる OU 過程によってデータ分布を $\rN_d(0,I_d)$ にまで破壊しているとみなせる [@Song+2021ICLR]：
$$
dX_t=-\frac{1}{2}X_t\,dt+dB_t,\qquad X_0\sim p(x|y).
$$

ただし，この過程は指数エルゴード性を持つと言っても，完全に $\rN_d(0,I_d)$ に従うようになるのは $t\to\infty$ の極限においてである．

この $(X_t)$ の有限時区間 $[0,T]$ における時間反転は，$(X_t)$ の密度を $p_t(x_t|y)$ で表すと，
$$
dZ_t=\frac{1}{2}Z_t\,dt+\nabla_z\log p_{T-t}(Z_t|y)\,dt+dW_t,\qquad Z_0\sim p_T(x_T|y),
$$ {#eq-denoising-diffusion}
の弱解になる [@Anderson1982], [@Haussmann-Pardoux1986]．詳しくは次の記事参照．

::: {#lst-embedding}
:::

この時間反転過程 $(Z_t)_{t\in[0,T]}$ を **雑音除去拡散** (Denoising Diffusion) という．

### スコアマッチングによる DD からのサンプリング {#sec-DDPS-sampling}

すると残りの問題は，拡散過程 $(Z_t)_{t\in[0,T]}$ からのサンプリングになる．

これにはドリフト項 $\log p_{T-t}(Z_t|y)$ の評価と初期分布 $p_T(x_T|y)$ からのサンプリングが必要である．

$(Z_t)$ を推定されたスコア $s^\theta$ を用いた Gauss 過程から開始する拡散
$$
dZ_t=\frac{1}{2}Z_t\,dt+s_{T-t}^\theta(Z_t,y)\,dt+dW_t,\qquad Z_0\sim\rN_d(0,I_d),
$$
で近似することが [@Song+2021ICLR] の方法である．思い切って $\rN_d(0,I_d)\approx p_T(x_T|y)$ としてしまい，$s_t^\theta(x_t,y)$ のモデリングに集中するのである．

この過程 $(Z_t)$ が定める測度を $\bQ_y^\theta\in\cP(C([0,T];\cX))$ と表すと，訓練目標は KL 乖離度の期待値
\begin{align*}
    \L(\theta)&:=2\E\SQuare{\KL\Paren{\bP_Y,\bQ_Y^\theta}}\\
    &=\int^T_0\E\SQuare{\Norm{s^\theta_t(X_t,Y)-\nabla_x\log p_{t|0}(X_t|X_0)}^2}\,dt+\const
\end{align*}
が考えられる [Th'm 1 @Song+2021ICLR]．ただし，$\bP_Y$ は $(X_t)$ の分布，$p_{t|0}$ は $(X_t)$ の遷移密度を表す．

この損失は [DSM](../Samplers/EBM.qmd#sec-DSM) [@Vincent2011] で与えられたものに等しく，
$$
(X_0,Y)\sim p(x,y)=g(y|x)\mu(x)
$$
からのシミュレーションが可能であるならば，この目的関数は確率的最適化アルゴリズムによって最適化できる．

こうして，雑音除去拡散サンプラー (DDPS: Denoising Diffusion Posterior Sampler) を得る．

### 近似ベイズ計算への応用

DDPS を学習するためには，事前分布と尤度 $g(y|x)$ からのサンプリングが可能であればよく，関数として評価することは一度もなかった．

従って DDPS は生成モデリングの他に Simulation-based Inference などの近似推論に用いることができる [@Shi+2022]．

実際，この DDPS は従来の ABC (Approximate Bayesian Computation) 法の代替になり得る．[@Benton+2024Denoising], [@Sharrock+2024] が良いレビューである．

さらに，[拡散模型の加速法](../Samplers/Diffusion.qmd#sec-acceleration) （Progressive Distillation [@Salimans-Ho2022] など）が DDPS にも応用可能である．

### 逆問題への応用

サンプルが画像だとしても，画像修復 (inpainting) や高解像度化 (super-resolution) などの逆問題応用が豊富に存在する．

このようなタスクに対しては **条件付き生成** の技術が考えられている：

::: {#lst-embedding3}
:::

このような，単一の $Y=y$ を固定した状況で潜在変数 $X_T$ からサンプリングをしたい場合では，$\log p_t(x_t|y)$ を一緒くたに $s^\theta_{t}(x_t,y)$ に取り替えてしまうのではなく，次の事前分布と尤度への分解に基づいて扱うこともできる：

$$
\nabla_x\log p_t(x_t|y)=\nabla_x\log\mu_t(x_t)+\nabla_x\log g_t(y|x_t),
$$
$$
\mu_t(x_t):=\int_\cX\mu(x_0)p_{t|0}(x_t|x_0)\,dx_0,\qquad g_t(y|x_t):=\int_\cX g(y|x_0)p_{0|t}(x_0,x_t)\,dx_0.
$$

この第一項は $s_t^\theta(x_t)$ により統一的にモデリングでき，同様に $X_0\sim\mu(x)$ から始まる雑音化過程 $(X_t)$ の分布を $\bP$ として $\KL(\bP,\bQ^\theta)$ 最小化問題として処理できる．

$g_t(y|x_t)$ の項も近似可能である．[@Chung+2023] では条件付き誘導が，[@Song+2023] では Monte Carlo 法が用いられている．

## Schrödinger 橋について {.unnumbered .unlisted}

::: {#SB-listing}
:::
