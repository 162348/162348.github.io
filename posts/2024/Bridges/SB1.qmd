---
title: "デノイジング・シュレディンガー橋"
subtitle: "拡散モデルからシュレディンガー橋へ"
author: "司馬 博文"
date: 8/3/2024
date-modified: 10/6/2024
categories: [Process, Sampling, P(X)]
bibliography: 
    - ../../../assets/mathematics.bib
    - ../../../assets/bib.bib
    - ../../../assets/bib1.bib
csl: ../../../assets/apalike.csl
abstract-title: 概要
abstract: |
  拡散モデルから始まるフロー学習手法は，画像と動画に関して 2024 年時点で最良の性能を誇る．これを統計に用いるために，正確に２つの分布を補間するような拡散過程を推定したい．
  これを実行する方法に Schrödinger 橋がある．
listing: 
    -   id: diffusion-listing
        type: grid
        sort: false
        contents:
            - "SB0.qmd"
            - "SB2.qmd"
            - "../Samplers/DD1.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
    -   id: lst-embedding
        type: grid
        sort: false
        grid-columns: 1
        grid-item-align: center
        contents:
            - "../Samplers/DD1.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
    -   id: lst-embedding2
        type: grid
        sort: false
        grid-columns: 1
        grid-item-align: center
        contents:
            - "../Samplers/Diffusion.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
    -   id: lst-embedding3
        type: grid
        sort: false
        grid-columns: 1
        grid-item-align: center
        contents:
            - "../Samplers/NF3.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
---

## 関連記事一覧 {.unnumbered .unlisted}

::: {#diffusion-listing}
:::

{{< include ../../../assets/_preamble.qmd >}}

## Schrödinger 橋による事後分布サンプリング (DSB-PS) {#sec-DSBPM}

### はじめに

$p_T(x_T|y)\approx\rN_d(0,I_d)$ の近似を成り立たせるために $T$ を十分大きく取る必要がある問題は，OU 過程の代わりに Schrödinger 橋を用いることで解決できることが [@Shi+2022] で提案された．

Schrödinger 橋自体は，[@DeBortoli+2021] などから拡散模型への応用は議論されていた．

### 定義

**Schrödinger 橋 (SB)** とは，
$$
\Pi^*:=\argmin_{\Pi\in\cP_0}\KL(\Pi,\bP),
$$
$$
\cP_0:=\BRace{\Pi\in\cP(C([0,T];\cX\times\cY))\,\bigg|\,\Pi_0(x_0,y_0)=p(x_0,y_0),\Pi_T(x_T,y_T)=\rN_d(0,I_d)p(y_T)},
$$
によって定まる確率分布に従う確率過程をいう．ただし，$\bP:=\bP_{y_0}\otimes\delta_{p(y)}$ とした．$\delta_{p(y)}$ は次で定まる確率分布である：
$$
dY_t=0,\qquad Y_0\sim p(y).
$$

これは表示
$$
\Pi^*=\bP^*_{y_0}\otimes\delta_{p(y)}
$$
を持つから，$Z_0\sim\rN_d(0,I_d)$ に従う過程 $(Z_t)$ をシミュレーションすることで，
$$
Z_T\sim\Pi^*_0(x|y)=p(x_0|y)\qquad p(y)\das
$$
が成り立つ．

### SB のシミュレーション

SB 問題の解 $\Pi$ は **逐次的比例フィッティング** (IPF: Iterative Proportional Fitting) により得られる．

#### IPF とは

IPF アルゴリズムは離散的な形で [@Deming-Stephan1940] が分割表データ解析の研究で提案している．その手続きを [@Ireland-Kullback1968] が距離の最小化として特徴付け，[@Kullback1968] が確率密度に対しても一般化した．ただし，この確率密度に対するアルゴリズムは [@Fortet1940] が Schrödinger 方程式の研究ですでに提案しているものである．

IPF は元々，指定した２つの確率ベクトル $r\in(0,\infty)^{d_r},c\in(0,\infty)^{d_c}$ を周辺分布に持つ結合分布（カップリング）のうち，指定の行列 $W\in M_{d_rd_c}(\R_+)$ に最も近い KL 乖離度を持つカップリングを見つけるための逐次アルゴリズムである [@Kurras2015]．

種々の分野で再発見され，複数の名前を持っているようである．例：Sheleikhovskii 法，Kruithof アルゴリズム，Furness 法，Sinkhorn-Knopp アルゴリズム，RAS 法など [@Kurras2015]．^[また，行列スケーリングを通じた最小情報コピュラとの関連を [@Bedford+2016], [@清智也2021] が指摘している．]

$W$ の成分が正である場合は，[@Sinkhorn1967] がアルゴリズムの収束と解の一意性を示している．^[ただし，[@Deming-Stephan1940] にも [@Fortet1940] にも言及しておらず，Markov 連鎖の遷移確率の推定という文脈で研究している．]

しかし，$W$ の成分が零を含む場合，零成分の位置に依存してアルゴリズムは収束しないことがあり得ることを，[@Sinkhorn-Knopp1967] が $d_r=d_c=1$ の場合について示している．

#### アルゴリズム

IPF アルゴリズムは，観念的には，２つの周辺分布のうち片方を制約に課しながら，KL 距離を最小にする射影を返していく：

$$
\Pi^{2n+1}:=\argmin_{\Pi\in\cP(C([0,T];\cX\times\cY))}\BRace{\KL(\Pi,\Pi^{2n})\,\bigg|\,\Pi_T=\rN_d(0,I_d)\otimes p(y_T)dy_T},
$$
$$
\Pi^{2n+2}:=\argmin_{\Pi\in\cP(C([0,T];\cX\times\cY))}\BRace{\KL(\Pi,\Pi^{2n+1})\,\bigg|\,\Pi_0(x_0,y_0)=p(x_0,y_0)}.
$$

今回の場合，
$$
\Pi^{2n+1}=\bP_{y_T}^{2n+1}\otimes\delta_{p(y)},\qquad\Pi^{2n+2}=\bP^{2n+2}_{y_0}\otimes\delta_{p(y)},
$$
と分解される．ただし，$\bP_{y_T}^{2n+1}$ は次で定まる $(Z_t)$ の時間反転
$$
dZ_t=f_{T-t}^{2n+1}(Z_t,y_T)\,dt+dW_t,\qquad Z_0\sim\rN_d(0,I_d),f_t^{2n+1}(x_t,y):=-f_t^{2n}(x_t,y)+\nabla_{x}\log\Pi^{2n}_t(x_t|y),
$$
$\bP_{y_0}^{2n+2}$ は次で定まる $(X_t)$ の経路測度となる：
$$
dX_t=f^{2n+2}_t(X_t,y_0)\,dt+dB_t,\qquad X_0\sim p(x|y_0)\,dx,f_t^{2n+2}(x_t,y):=-f_t^{2n+1}(x_t,y)+\nabla_x\log\Pi_t^{2n+1}(x_t|y).
$$
ただし，$f^0_t(x_t)=-x_t/2$．

#### DDPS との関係

最初のイテレーション $n=0$ における $\bP^1_y$ が雑音除去拡散に対応する．

しかし，IPF アルゴリズムのイテレーションを繰り返していくごとに，$T>0$ が十分に大きくない場合でも正確に $\rN_d(0,I_d)$ にデータ分布を還元する SB が得られるようになっていく．

#### DSB-PS

この際，スコア $\nabla_z\log p_{T-t}(Z_t|y)$ から始まり，$f^{n}_t\;(n\ge2)$ の推定も逐次的に行なわなければならない点については，**mean-matching** [@DeBortoli+2021], [@Shi+2022] という方法が考えられている．

この方法を用いて，IPF アルゴリズムが収束するまで実行して最終的に得るサンプラーを **Schrödinger 橋サンプラー** (DSB-PS: Diffusion Schrödinger Bridge Posterior Sampling) という．

## 文献紹介 {.appendix}

I^2^SB [@Liu+2023I2SB] のプロジェクトページは [こちら](https://i2sb.github.io/)．Text-to-Speech にも応用されている [@Chen+2023SB]．

SB はエントロピー正則化最適輸送の解になるが，このエントロピー／ラグランジアンの言葉で帰納バイアスを入れることができる [@Koshizuka-Sato2023], [@Isobe+2024]．

[鈴木大慈氏のスライド](https://drive.google.com/file/d/1ipWPVNBpFy5GlQqXtSbbhB0gAJUld-yd/view) では変分法的な見方が徹底されている．

1. Langevin 動力学は，平衡分布との KL 乖離度を最小化する Wasserstein 勾配流になっている．
2. その [時間反転過程](../Samplers/DD1.qmd) は OU 過程からの KL 乖離度とエネルギーの和を，$\ov{Y}_T\sim p_0$ の境界条件の下最小化する過程になっている．
3. さらに境界条件を加えたものが SB である．