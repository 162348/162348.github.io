<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="司馬博文">
<meta name="dcterms.date" content="2024-10-02">

<title>理想点解析のハンズオン – Hirofumi Shiba</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../assets/Shiba2.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-29987c632d9c708eba81ba88d1291502.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark-1df33b310b25e824b5acc70bcebddb02.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-29987c632d9c708eba81ba88d1291502.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-4c09742be2272f701a3e51422777528f.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark-4c09742be2272f701a3e51422777528f.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-4c09742be2272f701a3e51422777528f.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "?",
    "H"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-lst-embedding .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: ['listing-title','listing-image','listing-date','listing-subtitle','listing-categories',{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: ["listing-title","listing-author","listing-date","listing-image","listing-description"],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-lst-embedding'] = new List('listing-lst-embedding', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-lst-embedding1 .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: ['listing-title','listing-image','listing-date','listing-subtitle','listing-categories',{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: ["listing-title","listing-author","listing-date","listing-image","listing-description"],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-lst-embedding1'] = new List('listing-lst-embedding1', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-36GX2G6GLL"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-36GX2G6GLL', { 'anonymize_ip': true});
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&amp;display=swap" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic&amp;display=swap" rel="stylesheet">

<style>
  h1, .title, .description, .subtitle {
    font-family: "Zen Kurenaido", sans-serif !important;
  }
</style>

<!-- <style>
  .menu-text {
      font-family: "Gill Sans", sans-serif !important;
      font-weight: 400;
      font-style: normal;
  }
  .navbar-title {
      font-family: "Gill Sans", sans-serif !important;
      font-weight: 400;
      font-style: normal;
  }
</style> -->

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../assets/styles.css">
<meta property="og:title" content="理想点解析のハンズオン – Hirofumi Shiba">
<meta property="og:description" content="政治学における理想点解析とは，項目反応モデルを用いて裁判官や国会議員などの価値判断基準や「イデオロギー」を定量化・視覚化する方法である． ここでは既存のパッケージを用いて簡単に理想点解析を行う方法から始め， 自分で Stan コードを書いてモデルを推定する方法を紹介する． その際に最も重要な理想点モデルの性質として，識別可能性 の議論がある． これが保たれていないと，モデルの事後分布は多峰性を持ってしまい，推定をするたびに結果が異なったり，統計量の長期間平均が \(0\) になってしまったりしてしまう．">
<meta property="og:image" content="https://162348.github.io/posts/2024/TransDimensionalModels/Images/IPE_experiment.png">
<meta property="og:site_name" content="Hirofumi Shiba">
<meta property="og:image:height" content="588">
<meta property="og:image:width" content="703">
<meta name="twitter:title" content="理想点解析のハンズオン – Hirofumi Shiba">
<meta name="twitter:description" content="政治学における理想点解析とは，項目反応モデルを用いて裁判官や国会議員などの価値判断基準や「イデオロギー」を定量化・視覚化する方法である． ここでは既存のパッケージを用いて簡単に理想点解析を行う方法から始め， 自分で Stan コードを書いてモデルを推定する方法を紹介する． その際に最も重要な理想点モデルの性質として，識別可能性 の議論がある． これが保たれていないと，モデルの事後分布は多峰性を持ってしまい，推定をするたびに結果が異なったり，統計量の長期間平均が \(0\) になってしまったりしてしまう．">
<meta name="twitter:image" content="https://162348.github.io/posts/2024/TransDimensionalModels/Images/IPE_experiment.png">
<meta name="twitter:creator" content="@ano2math5">
<meta name="twitter:image-height" content="588">
<meta name="twitter:image-width" content="703">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Hirofumi Shiba</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Notes</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-notes">    
        <li>
    <a class="dropdown-item" href="../../../static/English.html">
 <span class="dropdown-text">English Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../blog.html">
 <span class="dropdown-text">ノート (Japanese)</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Materials.html"> 
<span class="menu-text">Materials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Slides.html"> 
<span class="menu-text">Slides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/162348/162348.github.io/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">理想点解析のハンズオン</h1>
            <p class="subtitle lead"><code>MCMCpack</code> パッケージとオリジナル <code>Stan</code> コードを使って</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Bayesian</div>
                <div class="quarto-category">Statistics</div>
                <div class="quarto-category">MCMC</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>司馬博文 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">10/02/2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">12/22/2024</p>
      </div>
    </div>
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">概要</div>
      <p>政治学における理想点解析とは，項目反応モデルを用いて裁判官や国会議員などの価値判断基準や「イデオロギー」を定量化・視覚化する方法である． ここでは既存のパッケージを用いて簡単に理想点解析を行う方法から始め， 自分で Stan コードを書いてモデルを推定する方法を紹介する． その際に最も重要な理想点モデルの性質として，<strong>識別可能性</strong> の議論がある． これが保たれていないと，モデルの事後分布は多峰性を持ってしまい，推定をするたびに結果が異なったり，統計量の長期間平均が <span class="math inline">\(0\)</span> になってしまったりしてしまう．</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#理想点モデルとは何か" id="toc-理想点モデルとは何か" class="nav-link active" data-scroll-target="#理想点モデルとは何か"><span class="header-section-number">1</span> 理想点モデルとは何か？</a>
  <ul class="collapse">
  <li><a href="#mcmcpack-パッケージ" id="toc-mcmcpack-パッケージ" class="nav-link" data-scroll-target="#mcmcpack-パッケージ"><span class="header-section-number">1.1</span> <code>MCMCpack</code> パッケージ</a></li>
  <li><a href="#理想点の推定" id="toc-理想点の推定" class="nav-link" data-scroll-target="#理想点の推定"><span class="header-section-number">1.2</span> 理想点の推定</a></li>
  <li><a href="#時系列化" id="toc-時系列化" class="nav-link" data-scroll-target="#時系列化"><span class="header-section-number">1.3</span> 時系列化</a></li>
  </ul></li>
  <li><a href="#母数ロジットモデルの推定" id="toc-母数ロジットモデルの推定" class="nav-link" data-scroll-target="#母数ロジットモデルの推定"><span class="header-section-number">2</span> ２母数ロジットモデルの推定</a>
  <ul class="collapse">
  <li><a href="#はじめに" id="toc-はじめに" class="nav-link" data-scroll-target="#はじめに"><span class="header-section-number">2.1</span> はじめに</a></li>
  <li><a href="#母数モデルbrms-パッケージ" id="toc-母数モデルbrms-パッケージ" class="nav-link" data-scroll-target="#母数モデルbrms-パッケージ"><span class="header-section-number">2.2</span> １母数モデル（<code>brms</code> パッケージ）</a></li>
  <li><a href="#母数モデルrstan-パッケージ" id="toc-母数モデルrstan-パッケージ" class="nav-link" data-scroll-target="#母数モデルrstan-パッケージ"><span class="header-section-number">2.3</span> １母数モデル（<code>rstan</code> パッケージ）</a></li>
  <li><a href="#sec-2PL" id="toc-sec-2PL" class="nav-link" data-scroll-target="#sec-2PL"><span class="header-section-number">2.4</span> ２母数モデル</a></li>
  <li><a href="#sec-identification" id="toc-sec-identification" class="nav-link" data-scroll-target="#sec-identification"><span class="header-section-number">2.5</span> 識別可能性</a></li>
  <li><a href="#階層ベイズ推定" id="toc-階層ベイズ推定" class="nav-link" data-scroll-target="#階層ベイズ推定"><span class="header-section-number">2.6</span> 階層ベイズ推定</a></li>
  <li><a href="#識別性の影響" id="toc-識別性の影響" class="nav-link" data-scroll-target="#識別性の影響"><span class="header-section-number">2.7</span> 識別性の影響</a></li>
  <li><a href="#事後分布の２峰性" id="toc-事後分布の２峰性" class="nav-link" data-scroll-target="#事後分布の２峰性"><span class="header-section-number">2.8</span> 事後分布の２峰性</a></li>
  </ul></li>
  <li><a href="#理想点解析パッケージ一覧" id="toc-理想点解析パッケージ一覧" class="nav-link" data-scroll-target="#理想点解析パッケージ一覧"><span class="header-section-number">3</span> 理想点解析パッケージ一覧</a>
  <ul class="collapse">
  <li><a href="#pscl-パッケージ" id="toc-pscl-パッケージ" class="nav-link" data-scroll-target="#pscl-パッケージ"><span class="header-section-number">3.1</span> <code>pscl</code> パッケージ</a></li>
  <li><a href="#mcmcpack-パッケージ-1" id="toc-mcmcpack-パッケージ-1" class="nav-link" data-scroll-target="#mcmcpack-パッケージ-1"><span class="header-section-number">3.2</span> <code>MCMCpack</code> パッケージ</a></li>
  <li><a href="#emirt-パッケージ" id="toc-emirt-パッケージ" class="nav-link" data-scroll-target="#emirt-パッケージ"><span class="header-section-number">3.3</span> <code>emIRT</code> パッケージ</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="関連記事" class="level2 unnumbered unlisted">
<h2 class="unnumbered unlisted anchored" data-anchor-id="関連記事">関連記事</h2>
<div id="listing-lst-embedding" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNz" data-listing-date-sort="1721088000000" data-listing-file-modified-sort="1760085125823" data-listing-date-modified-sort="1727827200000" data-listing-reading-time-sort="5" data-listing-word-count-sort="829">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="../../../posts/2024/TransDimensionalModels/Images/IdeologyPosition.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
理想点解析・多次元展開法・項目応答理論
</h5>
<div class="card-subtitle listing-subtitle">
空間モデルの特定を目指して
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-07-16
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ0NvbXB1dGF0aW9u" data-listing-date-sort="1732233600000" data-listing-file-modified-sort="1760085125923" data-listing-date-modified-sort="1734048000000" data-listing-reading-time-sort="1" data-listing-word-count-sort="186">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint2.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top"><img src="Images/IPE_experiment.png" style="height: 150px;"  class="thumbnail-image card-img"/></p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ベイズ理想点解析
</h5>
<div class="card-subtitle listing-subtitle">
PDMP サンプラーによる変数選択と共に
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

<div class="listing-category" onclick="window.quartoListingCategory('TUNNQw=='); return false;">MCMC</div>

<div class="listing-category" onclick="window.quartoListingCategory('Q29tcHV0YXRpb24='); return false;">Computation</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-11-22
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ0NvbXB1dGF0aW9u" data-listing-date-sort="1734220800000" data-listing-file-modified-sort="1760085125924" data-listing-date-modified-sort="1734220800000" data-listing-reading-time-sort="1" data-listing-word-count-sort="76">
<a href="../../../posts/2024/TransDimensionalModels/IdealPoint3.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top"><img src="Images/IPE_experiment.png" style="height: 150px;"  class="thumbnail-image card-img"/></p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
階層ベイズ理想点解析
</h5>
<div class="card-subtitle listing-subtitle">
PDMP サンプラーによる特異項目機能を取り込んだ大規模ベイズ推定
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

<div class="listing-category" onclick="window.quartoListingCategory('TUNNQw=='); return false;">MCMC</div>

<div class="listing-category" onclick="window.quartoListingCategory('Q29tcHV0YXRpb24='); return false;">Computation</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-15
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
<p>本稿では実際に理想点モデルの推定を，<a href="http://mqscores.wustl.edu/replication.php">Martin-Quinn</a> により公開されている連邦最高裁判所の 1937 年から 2022 年までのデータを（<code>MCMCpack</code> パッケージを通じて）用いて行う．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MCMCpack)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Rehnquist)  <span class="co"># MCMCpackに含まれる U.S. Supreme Court（連邦最高裁）のデータ</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(Rehnquist))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Rehnquist</th>
<th style="text-align: right;">Stevens</th>
<th style="text-align: right;">O.Connor</th>
<th style="text-align: right;">Scalia</th>
<th style="text-align: right;">Kennedy</th>
<th style="text-align: right;">Souter</th>
<th style="text-align: right;">Thomas</th>
<th style="text-align: right;">Ginsburg</th>
<th style="text-align: right;">Breyer</th>
<th style="text-align: right;">term</th>
<th style="text-align: right;">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1994</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>このデータは保守的な判断をする場合が <span class="math inline">\(y_i=1\)</span>，リベラルな判断をする場合が <span class="math inline">\(y_i=0\)</span> の２値データとなっている．</p>
</section>
<section id="理想点モデルとは何か" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="理想点モデルとは何か"><span class="header-section-number">1</span> 理想点モデルとは何か？</h2>
<section id="mcmcpack-パッケージ" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="mcmcpack-パッケージ"><span class="header-section-number">1.1</span> <code>MCMCpack</code> パッケージ</h3>
<p>はじめに，理想点モデルではどのようなことができるかをみるために，<code>MCMCpack</code> パッケージを通じて理想点推定を簡単に実行する方法を見る．</p>
<p>理想点モデルでは識別性が一つの論点になる（第 <a href="#sec-identification" class="quarto-xref">2.5</a> 節）が，ここでは簡単に，Stevens 判事と Thomas 判事の位置を固定する方法を用いてみよう．</p>
<p><code>MCMCpack</code> パッケージでは，時系列理想点モデルの推定に <a href="https://github.com/cran/MCMCpack/blob/master/man/MCMCdynamicIRT1d.Rd"><code>MCMCdynamicIRT1d()</code></a> 関数が用意されている．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 初期値の設定</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>theta.start <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">9</span>)  <span class="co"># 9人の裁判官の初期値</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>theta.start[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">3</span>      <span class="co"># Stevens裁判官の初期値</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>theta.start[<span class="dv">7</span>] <span class="ot">&lt;-</span> <span class="dv">2</span>       <span class="co"># Thomas裁判官の初期値</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMCの実行</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">MCMCdynamicIRT1d</span>(</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(Rehnquist[,<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]),           <span class="co"># データ行列（転置して裁判官×案件の形に）</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">item.time.map=</span>Rehnquist<span class="sc">$</span>time, <span class="co"># 各案件の時期情報</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta.start=</span>theta.start,      <span class="co"># 初期値</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc=</span><span class="dv">2000</span>,                   <span class="co"># MCMCの反復回数</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">burnin=</span><span class="dv">2000</span>,                 <span class="co"># バーンイン期間</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin=</span><span class="dv">5</span>,                       <span class="co"># 間引き数</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose=</span><span class="dv">500</span>,                  <span class="co"># 進捗表示間隔</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau2.start=</span><span class="fu">rep</span>(<span class="fl">0.1</span>, <span class="dv">9</span>),      <span class="co"># τ²の初期値</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">e0=</span><span class="dv">0</span>, <span class="at">E0=</span><span class="dv">1</span>,                  <span class="co"># θの事前分布パラメータ</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">a0=</span><span class="dv">0</span>, <span class="at">A0=</span><span class="dv">1</span>,                  <span class="co"># αの事前分布パラメータ</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">b0=</span><span class="dv">0</span>, <span class="at">B0=</span><span class="dv">1</span>,                  <span class="co"># βの事前分布パラメータ</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">c0=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">d0=</span><span class="sc">-</span><span class="dv">1</span>,               <span class="co"># τ²の事前分布パラメータ</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">store.item=</span><span class="cn">FALSE</span>,            <span class="co"># アイテムパラメータを保存しない</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta.constraints=</span><span class="fu">list</span>(<span class="at">Stevens=</span><span class="st">"-"</span>, <span class="at">Thomas=</span><span class="st">"+"</span>)  <span class="co"># 識別制約</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>theta_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"theta"</span>, <span class="fu">colnames</span>(out), <span class="at">value=</span><span class="cn">TRUE</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>theta_mcmc <span class="ot">&lt;-</span> out[, theta_cols]</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># library(coda)</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(theta_mcmc)  # codaのsummary関数で要約</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(theta_mcmc)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/plot.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</section>
<section id="理想点の推定" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="理想点の推定"><span class="header-section-number">1.2</span> 理想点の推定</h3>
<p>出力は各最高裁判事の理想点の事後分布である．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>theta_means <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(theta_mcmc)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">&lt;-</span> <span class="st">"t11"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>col_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(theta_mcmc)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>selected_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(pattern, col_names)  <span class="co"># 正規表現にマッチする列のインデックスを取得</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>selected_theta_mcmc <span class="ot">&lt;-</span> theta_mcmc[, selected_cols]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>quantiles_2_5 <span class="ot">&lt;-</span> <span class="fu">apply</span>(selected_theta_mcmc, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.025</span>))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>quantiles_97_5 <span class="ot">&lt;-</span> <span class="fu">apply</span>(selected_theta_mcmc, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.975</span>))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">legislator =</span> <span class="fu">colnames</span>(Rehnquist)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>],</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="fu">unname</span>(theta_means[selected_cols]),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">unname</span>(quantiles_2_5),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">unname</span>(quantiles_97_5)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>), <span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> legislator)) <span class="sc">+</span> </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower, <span class="at">xmax =</span> upper), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Estimated Ideal Points (11th term)"</span>, <span class="at">x =</span> <span class="st">"Ideal Point"</span>, <span class="at">y =</span> <span class="st">"Legislator"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="IdealPoint1_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="時系列化" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="時系列化"><span class="header-section-number">1.3</span> 時系列化</h3>
<p><span class="citation" data-cites="Martin-Quinn2002">(<a href="#ref-Martin-Quinn2002" role="doc-biblioref">Martin and Quinn, 2002</a>)</span> ではこの理想点の時系列的な変化を調べた．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>time_points <span class="ot">&lt;-</span> <span class="fu">unique</span>(Rehnquist<span class="sc">$</span>time)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>n_subjects <span class="ot">&lt;-</span> <span class="dv">9</span>  <span class="co"># 裁判官の数</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 各裁判官の軌跡をプロット</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(time_points, theta_means[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(time_points)], </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">"l"</span>, <span class="at">ylim=</span><span class="fu">range</span>(theta_means),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Time"</span>, <span class="at">ylab=</span><span class="st">"Ideal Point"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"Estimated Ideal Points Over Time"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 各裁判官を異なる色で追加</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">rainbow</span>(n_subjects)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>colors[<span class="dv">9</span>] <span class="ot">&lt;-</span> <span class="st">"blue"</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">8</span>,<span class="dv">9</span>)) {</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(time_points, </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>          theta_means[((i<span class="dv">-1</span>)<span class="sc">*</span><span class="fu">length</span>(time_points)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(i<span class="sc">*</span><span class="fu">length</span>(time_points))],</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">col=</span>colors[i],</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd=</span><span class="dv">3</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 凡例を追加</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend=</span><span class="fu">unique</span>(<span class="fu">colnames</span>(Rehnquist)[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">8</span>,<span class="dv">9</span>)]),  <span class="co"># 裁判官の名前</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span>colors[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">8</span>,<span class="dv">9</span>)], </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/plot3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p>たしかに <a href="https://en.wikipedia.org/wiki/William_Rehnquist">William Rehnquist</a> は共和党，<a href="https://en.wikipedia.org/wiki/Ruth_Bader_Ginsburg">Ruth Bader Ginsburg</a> と <a href="https://en.wikipedia.org/wiki/Stephen_Breyer">Stephen Breyer</a> は民主党である．</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/plot2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
<p><span class="math inline">\(0\)</span> の上に位置している <a href="https://ja.wikipedia.org/wiki/アンソニー・ケネディ">Anthony Kennedy</a> や <a href="https://en.wikipedia.org/wiki/Sandra_Day_O%27Connor">Sandra Day O’Connor</a> はほとんど中道的だが，やや保守党寄りである． <a href="https://en.wikipedia.org/wiki/Antonin_Scalia">Antonin Scalia</a> は特に保守的な立場であることが知られている．</p>
<p><span class="math inline">\(0\)</span> よりも下に位置するもう一人は <a href="https://en.wikipedia.org/wiki/David_Souter">David Souter</a> であるが，彼はもともと保守系と目されていたが，後年リベラルな傾向を示したとされる．<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</section>
</section>
<section id="母数ロジットモデルの推定" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="母数ロジットモデルの推定"><span class="header-section-number">2</span> ２母数ロジットモデルの推定</h2>
<section id="はじめに" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">2.1</span> はじめに</h3>
<p><code>MCMCpack</code> パッケージで理想点推定の出力がつかめたいま，より詳しくモデルを見ていく．</p>
<p>本節では <code>rstan</code> パッケージを用いて，項目反応モデルとして具体的な手順を踏んで推定してみる．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> Rehnquist <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># データを長形式に変換</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(term, time), <span class="at">names_to =</span> <span class="st">"name"</span>, <span class="at">values_to =</span> <span class="st">"y"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ケース ID を追加</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">case =</span> (<span class="fu">row_number</span>() <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> <span class="dv">9</span> <span class="sc">+</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="母数モデルbrms-パッケージ" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="母数モデルbrms-パッケージ"><span class="header-section-number">2.2</span> １母数モデル（<code>brms</code> パッケージ）</h3>
<p>まずは最も簡単な項目反応モデルとして，<span class="math inline">\(g\)</span> を logit リンクとして， <span class="math display">\[
g(\operatorname{P}[Y_{ij}=1])=\alpha_0+\alpha_j-x_i
\]</span> というモデルを推定することを考えよう．</p>
<p><code>brms</code> パッケージを用いれば，他の R パッケージと同様のインターフェイスで推定を行うことができる．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="fu">bf</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> case) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> name)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>fit_1PL <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  formula,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">brmsfamily</span>(<span class="st">"bernoulli"</span>, <span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_1PL)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: bernoulli 
  Links: mu = logit 
Formula: y ~ 1 + (1 | case) + (1 | name) 
   Data: df (Number of observations: 4343) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~case (Number of levels: 485) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.05      0.06     0.93     1.18 1.00     2016     2773

~name (Number of levels: 9) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     1.62      0.47     0.99     2.75 1.01      875     1534

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    -0.11      0.54    -1.15     1.00 1.00      652     1263

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>簡単なモデルであるが切片項の ESS が低く，すでに暗雲が立ち込めている．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit_1PL)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="IdealPoint1_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>ここには変動係数（我々の欲しい潜在変数）はパラメータとみなされておらず，推定値が表示されないので次のようにしてプロットする必要がある：</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ranef_legislator <span class="ot">&lt;-</span> <span class="fu">ranef</span>(fit_1PL)<span class="sc">$</span>name</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>posterior_means <span class="ot">&lt;-</span> ranef_legislator[,<span class="dv">1</span>,<span class="st">"Intercept"</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>lower_bounds <span class="ot">&lt;-</span> ranef_legislator[,<span class="dv">3</span>,<span class="st">"Intercept"</span>]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>upper_bounds <span class="ot">&lt;-</span> ranef_legislator[,<span class="dv">4</span>,<span class="st">"Intercept"</span>]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>plot_legislator <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">legislator =</span> <span class="fu">rownames</span>(ranef_legislator),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> posterior_means,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> lower_bounds,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> upper_bounds</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>p_1PL <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_legislator, <span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> legislator)) <span class="sc">+</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower, <span class="at">xmax =</span> upper), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"1PL Model"</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Posterior Estimate"</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Legislator"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>p_1PL</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="IdealPoint1_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Thomas や Scalia，そして Stevens が極端であることはとらえているが，Stevens や Ginsburg らリベラルな判事は左側に来て欲しいのであった．</p>
<p>誘導が成功しておらず，片方の峯からサンプリングしてしまっている．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prior_summary</span>(fit_1PL)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior     class      coef group resp dpar nlpar lb ub
 student_t(3, 0, 2.5) Intercept                                      
 student_t(3, 0, 2.5)        sd                                  0   
 student_t(3, 0, 2.5)        sd            case                  0   
 student_t(3, 0, 2.5)        sd Intercept  case                  0   
 student_t(3, 0, 2.5)        sd            name                  0   
 student_t(3, 0, 2.5)        sd Intercept  name                  0   
       source
      default
      default
 (vectorized)
 (vectorized)
 (vectorized)
 (vectorized)</code></pre>
</div>
</div>
</section>
<section id="母数モデルrstan-パッケージ" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="母数モデルrstan-パッケージ"><span class="header-section-number">2.3</span> １母数モデル（<code>rstan</code> パッケージ）</h3>
<p><code>brms</code> パッケージ内で生成される Stan コードを参考にして，自分で Stan コードを書いて推定することもできる．</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="Stan コードの出力">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Stan コードの出力
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stancode</span>(fit_1PL)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// generated with brms 2.21.0</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;  <span class="co">// total number of observations</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span> Y;  <span class="co">// response variable</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// data for group-level effects of ID 1</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N_1;  <span class="co">// number of grouping levels</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; M_1;  <span class="co">// number of coefficients per level</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J_1;  <span class="co">// grouping indicator per observation</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// group-level predictor values</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] Z_1_1;</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// data for group-level effects of ID 2</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N_2;  <span class="co">// number of grouping levels</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; M_2;  <span class="co">// number of coefficients per level</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J_2;  <span class="co">// grouping indicator per observation</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// group-level predictor values</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] Z_2_1;</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> prior_only;  <span class="co">// should the likelihood be ignored?</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> Intercept;  <span class="co">// temporary intercept for centered predictors</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[M_1] sd_1;  <span class="co">// group-level standard deviations</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[M_1] <span class="dt">vector</span>[N_1] z_1;  <span class="co">// standardized group-level effects</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[M_2] sd_2;  <span class="co">// group-level standard deviations</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[M_2] <span class="dt">vector</span>[N_2] z_2;  <span class="co">// standardized group-level effects</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_1] r_1_1;  <span class="co">// actual group-level effects</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_2] r_2_1;  <span class="co">// actual group-level effects</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> lprior = <span class="dv">0</span>;  <span class="co">// prior contributions to the log posterior</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  r_1_1 = (sd_1[<span class="dv">1</span>] * (z_1[<span class="dv">1</span>]));</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  r_2_1 = (sd_2[<span class="dv">1</span>] * (z_2[<span class="dv">1</span>]));</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  lprior += student_t_lpdf(Intercept | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  lprior += student_t_lpdf(sd_1 | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    - <span class="dv">1</span> * student_t_lccdf(<span class="dv">0</span> | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  lprior += student_t_lpdf(sd_2 | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>)</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    - <span class="dv">1</span> * student_t_lccdf(<span class="dv">0</span> | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">// likelihood including constants</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (!prior_only) {</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// initialize linear predictor term</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] mu = rep_vector(<span class="fl">0.0</span>, N);</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    mu += Intercept;</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>      <span class="co">// add more terms to the linear predictor</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>      mu[n] += r_1_1[J_1[n]] * Z_1_1[n] + r_2_1[J_2[n]] * Z_2_1[n];</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">target +=</span> bernoulli_logit_lpmf(Y | mu);</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors including constants</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> lprior;</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> std_normal_lpdf(z_1[<span class="dv">1</span>]);</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> std_normal_lpdf(z_2[<span class="dv">1</span>]);</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">// actual population-level intercept</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> b_Intercept = Intercept;</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>stan_code <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;  // data size: n = N * J - #(NA responses)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;  // number of judges</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; J;  // number of cases</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=0, upper=1&gt; Y;  // response variable</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=1, upper=N&gt; i;  // indicator for judges i in [N]</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=1, upper=J&gt; j;  // indicator for cases j in [J]</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] X;  // ideal points</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="st">  real alpha_zero;  // intercepts</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] alpha;  // item effects</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real lprior = 0;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="st">  lprior += student_t_lpdf(alpha_zero | 3, 0, 2.5);</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="st">  lprior += student_t_lpdf(alpha | 3, 0, 2.5);</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="st">  lprior += student_t_lpdf(X | 3, 0, 2.5);</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu = rep_vector(0, n);</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="st">  for (k in 1:n) {</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="st">    mu[k] = alpha[j[k]] - X[i[k]];</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="st">  target += bernoulli_logit_lpmf(Y | mu + alpha_zero);</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="st">  target += lprior;</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>case_number <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">nrow</span>(df) <span class="sc">/</span> <span class="dv">9</span>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>indicator_i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">times =</span> case_number)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>indicator_j <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>case_number, <span class="at">each =</span> <span class="dv">9</span>)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>i <span class="ot">&lt;-</span> indicator_i</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>j <span class="ot">&lt;-</span> indicator_j</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>df_NA <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(y))</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Y =</span> df_NA<span class="sc">$</span>y, <span class="at">n =</span> <span class="fu">nrow</span>(df_NA), <span class="at">N =</span> <span class="dv">9</span>, <span class="at">J =</span> case_number, <span class="at">i =</span> df_NA<span class="sc">$</span>i, <span class="at">j =</span> df_NA<span class="sc">$</span>j)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">model_code =</span> stan_code, <span class="at">data =</span> data, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">iter =</span> <span class="dv">4000</span>, <span class="at">warmup =</span> <span class="dv">3000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>all_samples <span class="ot">&lt;-</span> <span class="fu">extract</span>(fit, <span class="at">pars =</span> <span class="st">"X"</span>)<span class="sc">$</span>X</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>x_samples <span class="ot">&lt;-</span> all_samples[(<span class="fu">nrow</span>(all_samples) <span class="sc">-</span> <span class="dv">999</span>)<span class="sc">:</span><span class="fu">nrow</span>(all_samples), ]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>plot_dataframe <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">legislator =</span> <span class="fu">colnames</span>(Rehnquist)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>],</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="fu">apply</span>(x_samples, <span class="dv">2</span>, mean),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">apply</span>(x_samples, <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">apply</span>(x_samples, <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_dataframe, <span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> legislator)) <span class="sc">+</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower, <span class="at">xmax =</span> upper), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mean"</span>, <span class="at">y =</span> <span class="st">"Legislator"</span>, <span class="at">title =</span> <span class="st">"1PL Model (RStan)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="Images/1PL.png" class="img-fluid"></p>
<p><code>brms</code> による推定結果と，左右が逆になっている．これはモデル式を <code>alpha[j[k]] - X[i[k]]</code> と Stan コードに記入しており，<code>brms</code> の設定と（たまたま）逆になったためである．</p>
<p>余談であるが，<span class="math inline">\(\alpha_0\)</span> を固定された切片項でなくて，変動させる（変量効果にする）ことで，事後分散は大きく縮まる．</p>
<p>係数 <span class="math inline">\(\alpha_j,x_i\)</span> の事前分布を正規分布に変更したりしても結果はほとんど変わらない．</p>
</section>
<section id="sec-2PL" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="sec-2PL"><span class="header-section-number">2.4</span> ２母数モデル</h3>
<p><span class="citation" data-cites="Bafumi+2005">(<a href="#ref-Bafumi+2005" role="doc-biblioref">Bafumi et al., 2005</a>)</span> など，多くの理想点モデルでは２母数ロジットモデルが用いられる： <span class="math display">\[
g(x):=\operatorname{logit}(x)=\log\frac{x}{1-x},
\]</span> <span class="math display">\[
g(\mu_{i,j})=\alpha_j+\beta_j x_i=\beta_j\biggr(\widetilde{\alpha}_j+x_i\biggl).
\]</span> この際 <span class="math inline">\(x_i\)</span> は <span class="math inline">\(i\)</span> 番目の判事の <strong>理想点</strong> といい，<span class="math inline">\(\alpha_j,\beta_j\)</span> は <span class="math inline">\(j\)</span> 番目の事件の性質を表すパラメータである．</p>
<p>ものによっては判事の立場が関係ない事件もあるため，<span class="math inline">\(\beta_j\)</span> が用意されている．</p>
<p>基本的にこの識別パラメータが正になるように調整したいが，明示的にそうすることはしない．</p>
<p>次節で説明する方法により，理想点 <span class="math inline">\(x_i\)</span> が大きい場合は保守的な判断を下しやすいものと解釈できるように設計することができる（<span class="math inline">\(x_i\)</span> を数直線上にプロットした際に，リベラルな場合に左に，保守的な場合に右に来るようにする）が，ここではストレートに実装してみよう．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>stan_code <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;  // n = N * J - #(NA responses)</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; N;  // number of judges</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; J;  // number of cases</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=0, upper=1&gt; Y;  // response variable</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=1, upper=N&gt; i;  // indicator for judges i in [N]</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=1, upper=J&gt; j;  // indicator for cases j in [J]</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[N] X;  // ideal points</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] alpha;  // item effects</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[J] beta;  // item discremination</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="st">  real lprior = 0;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="st">  lprior += std_normal_lpdf(alpha);</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="st">  lprior += std_normal_lpdf(beta);</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="st">  lprior += std_normal_lpdf(X);</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="st">  vector[n] mu = rep_vector(0, n);</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="st">  for (k in 1:n) {</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="st">    mu[k] = alpha[j[k]] + beta[j[k]] * X[i[k]];</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="st">  target += bernoulli_logit_lpmf(Y | mu);</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="st">  target += lprior;</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>case_number <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">nrow</span>(df) <span class="sc">/</span> <span class="dv">9</span>)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>indicator_i <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">times =</span> case_number)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>indicator_j <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>case_number, <span class="at">each =</span> <span class="dv">9</span>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>i <span class="ot">&lt;-</span> indicator_i</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>j <span class="ot">&lt;-</span> indicator_j</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>df_NA <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(y))</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Y =</span> df_NA<span class="sc">$</span>y, <span class="at">n =</span> <span class="fu">nrow</span>(df_NA), <span class="at">N =</span> <span class="dv">9</span>, <span class="at">J =</span> case_number, <span class="at">i =</span> df_NA<span class="sc">$</span>i, <span class="at">j =</span> df_NA<span class="sc">$</span>j)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">model_code =</span> stan_code, <span class="at">data =</span> data, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">iter =</span> <span class="dv">4000</span>, <span class="at">warmup =</span> <span class="dv">3000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>all_samples <span class="ot">&lt;-</span> <span class="fu">extract</span>(fit, <span class="at">pars =</span> <span class="st">"X"</span>)<span class="sc">$</span>X</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>x_samples <span class="ot">&lt;-</span> all_samples[(<span class="fu">nrow</span>(all_samples) <span class="sc">-</span> <span class="dv">999</span>)<span class="sc">:</span><span class="fu">nrow</span>(all_samples), ]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>plot_dataframe <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">legislator =</span> <span class="fu">colnames</span>(Rehnquist)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>],</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="fu">apply</span>(x_samples, <span class="dv">2</span>, mean),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">apply</span>(x_samples, <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">apply</span>(x_samples, <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_dataframe, <span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> legislator)) <span class="sc">+</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower, <span class="at">xmax =</span> upper), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mean"</span>, <span class="at">y =</span> <span class="st">"Legislator"</span>, <span class="at">title =</span> <span class="st">"Ideal Points of Rehnquist"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><img src="Images/2PL.png" class="img-fluid"></p>
<p>２つを並べてみると</p>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/1PL.png" class="img-fluid figure-img"></p>
<figcaption>1PL Model</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/2PL.png" class="img-fluid figure-img"></p>
<figcaption>2PL Model</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>モデルの自由度が上がったことにより，事後分散が大幅に小さくなっていることがわかる．</p>
<p>また，1PL の場合と再び左右が反転し，最後のリベラルな判事の２人 Ginsburg と Breyer が右に来てしまっている．</p>
<p>これはモデル式を <code>mu[k] = alpha[j[k]] + beta[j[k]] * X[i[k]];</code> と足し算に戻したからだろうか？</p>
<p>実はそうではない．実際，何度か MCMC を回し直すと，ちゃんとリベラルな判事が左に来てくれることもある．</p>
<p>即ち，<strong>事後分布が多峰性を持つ</strong> のである！</p>
<!-- 

```r
formula_2PL <- bf(
  y ~ 0 + (1 + name | case)
)
fit_2PL <- update(fit_1PL, formula = formula_2PL, cores = 4, iter = 3000)
```

```r
summary(fit_2PL)
```

    Family: bernoulli 
      Links: mu = logit 
    Formula: y ~ (1 | case) + (case | name) - 1 
      Data: df (Number of observations: 4343) 
      Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
            total post-warmup draws = 4000

    Multilevel Hyperparameters:
    ~case (Number of levels: 485) 
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    sd(Intercept)     1.05      0.06     0.93     1.18 1.00     1800     2643

    ~name (Number of levels: 9) 
                        Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    sd(Intercept)           1.59      0.44     0.96     2.70 1.00      767     1456
    sd(case)                0.00      0.00     0.00     0.00 1.00     1144     2343
    cor(Intercept,case)    -0.06      0.48    -0.87     0.87 1.00     4220     2337

    Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
    and Tail_ESS are effective sample size measures, and Rhat is the potential
    scale reduction factor on split chains (at convergence, Rhat = 1).


```r
plot(fit_2PL)
```

![](Images/plot_2PL.png){width=70% fig-align=center}

```r
ranef_legislator <- ranef(fit_2PL)$name
posterior_means <- ranef_legislator[,1,"Intercept"]
lower_bounds <- ranef_legislator[,3,"Intercept"]
upper_bounds <- ranef_legislator[,4,"Intercept"]
plot_legislator <- data.frame(
  legislator = rownames(ranef_legislator),
  mean = posterior_means,
  lower = lower_bounds,
  upper = upper_bounds
)
p_2PL <- ggplot(plot_legislator, aes(x = mean, y = legislator)) +
  geom_point() +
  geom_errorbar(aes(xmin = lower, xmax = upper), width = 0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "2PL Model",
       x = "Posterior Estimate",
       y = "Legislator")
grid.arrange(p_1PL, p_2PL, nrow = 1)
```

![](Images/grid_arrange.png)

よりモデルの不確実性が減って，$0$ の周りに縮小されたことがわかる．これは一般の項目反応モデルで見られる：

::: {#lst-embedding}
:::

左派が右に表示されてしまっていることは変わらない．
-->
</section>
<section id="sec-identification" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="sec-identification"><span class="header-section-number">2.5</span> 識別可能性</h3>
<p>実は２母数ロジットモデルでは３つ識別不可能性を引き起こす対称性がある：</p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="[Section 2 @Bafumi+2005]">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span><span class="citation" data-cites="Bafumi+2005">(Section 2 <a href="#ref-Bafumi+2005" role="doc-biblioref">Bafumi et al., 2005</a>)</span>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>加法的別名 (additive aliasing)</p>
<p><span class="math inline">\(\widetilde{\alpha}_j,x_i\)</span> に同じ数を足した場合と <span class="math inline">\(\beta_j\)</span> と <span class="math inline">\((\widetilde{\alpha}_j,x_i)\)</span> に同じ数を乗じた／除した場合，全く等価なモデルが得られる．すなわちスケールを定める必要がある．</p></li>
<li><p>乗法的別名 (additive aliasing)</p>
<p><span class="math inline">\(\beta_j\)</span> を <span class="math inline">\(a&gt;0\)</span> 倍し，<span class="math inline">\(\widetilde{\alpha}_j,x_i\)</span> を <span class="math inline">\(1/a\)</span> 倍すると等価な尤度を定める．</p></li>
<li><p>反転対称性 (reflection invariance)</p>
<p>最後に <span class="math inline">\(\beta_j\)</span> の符号の問題があるためである．<span class="math inline">\(\beta_j\)</span> を <span class="math inline">\(-1\)</span> 倍させることで <span class="math inline">\(\widetilde{\alpha}_j,x_i\)</span> の役割を <span class="math inline">\(-1\)</span> 倍させることができる．このまま推定すると事後分布は <span class="math inline">\(0\)</span> に関して対称な形を持つことになる．</p></li>
</ul>
</div>
</div>
<!-- 
ベイズ推定では，次のような事前分布と階層構造を置くことでこの問題を回避できる：
$$
x_i\iidsim\rN(0,1),\qquad \al_j=\mu_\al+\ep_\al,\qquad\ep_\al\iidsim\rN(0,\sigma^2_\al),
$$
$$
\beta_j=\mu_\beta+\ep_\beta,\qquad\ep_\beta\iidsim\rN(0,\sigma^2_\beta).
$$

```r
library(rstan)
stan_code <- "
data {
  int<lower=1> n;  // n = N * J - #(NA responses)
  int<lower=1> N;  // number of judges
  int<lower=1> J;  // number of cases

  array[n] int<lower=0, upper=1> Y;  // response variable
  array[n] int<lower=1, upper=N> i;  // indicator for judges i in [N]
  array[n] int<lower=1, upper=J> j;  // indicator for cases j in [J]
}
parameters {
  vector[N] X;  // ideal points
  vector[J] alpha_zero;  // item effects
  vector[J] beta_zero;  // item discremination

  real<lower=0> sigma_al;  // sd of alpha
  real<lower=0> sigma_beta;  // sd of beta

  vector[J] alpha;  // real values of alpha
  vector[J] beta;  // real values of beta
}
transformed parameters {
  real lprior = 0;

  lprior += student_t_lpdf(alpha_zero | 3, 0, 2.5);
  lprior += student_t_lpdf(beta_zero | 3, 0, 2.5);
  lprior += student_t_lpdf(sigma_al | 3, 0, 2.5);
  lprior += student_t_lpdf(sigma_beta | 3, 0, 2.5);
  lprior += std_normal_lpdf(X);
}
model {
  alpha ~ normal(alpha_zero, sigma_al);
  beta ~ normal(beta_zero, sigma_beta);
  vector[n] mu = rep_vector(0, n);
  for (k in 1:n) {
    mu[k] = alpha[j[k]] + beta[j[k]] * X[i[k]];
  }
  target += bernoulli_logit_lpmf(Y | mu);
  target += lprior;
}
"
case_number <- as.integer(nrow(df) / 9)
indicator_i <- rep(1:9, times = case_number)
indicator_j <- rep(1:case_number, each = 9)
df$i <- indicator_i
df$j <- indicator_j

df_NA <- df %>% filter(!is.na(y))

data <- list(Y = df_NA$y, n = nrow(df_NA), N = 9, J = case_number, i = df_NA$i, j = df_NA$j)
fit <- stan(model_code = stan_code, data = data, chains = 4, cores = 4, verbose = TRUE, iter = 4000, warmup = 3000)
```

```r
all_samples <- extract(fit, pars = "X")$X
x_samples <- all_samples[(nrow(all_samples) - 999):nrow(all_samples), ]

plot_dataframe <- data.frame(
  legislator = colnames(Rehnquist)[1:9],
  mean = apply(x_samples, 2, mean),
  lower = apply(x_samples, 2, quantile, probs = 0.025),
  upper = apply(x_samples, 2, quantile, probs = 0.975)
)
ggplot(plot_dataframe, aes(x = mean, y = legislator)) +
  geom_point() +
  geom_errorbar(aes(xmin = lower, xmax = upper), width = 0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Mean", y = "Legislator", title = "Ideal Points of Rehnquist")
```

::: {layout-ncol=2}
![2PL Model](Images/stan2.png)

![Identified 2PL hierarchical model](Images/stan3.png)
:::
-->
<p><span class="math inline">\(\beta_j\)</span> の符号を制約したり，特定の判事の <span class="math inline">\(x_i\)</span> を固定して参照点とするなどの方法があるかもしれないが，ここでは <span class="citation" data-cites="Bafumi+2005">(2.2.3 節 <a href="#ref-Bafumi+2005" role="doc-biblioref">Bafumi et al., 2005, p. 178</a>)</span> に倣って，階層モデルの方法により，構造的なやり方でモデルに情報を伝える．</p>
<p>というのも，理想点 <span class="math inline">\(x_i\)</span> に次の階層構造を入れるのである： <span class="math display">\[
x_i=\delta+\gamma z_i+\epsilon_i\qquad\epsilon_i\overset{\text{i.i.d.}}{\sim}\mathrm{N}(0,1).
\]</span></p>
<p><span class="math inline">\(z_i\)</span> は当該判事を示した大統領の所属政党を表す２値変数で，共和党ならば <span class="math inline">\(z_i=1\)</span> とする．そして <span class="math inline">\(\gamma\)</span> に <span class="math inline">\(\mathbb{R}_+\)</span> 上に台を持つ事前分布を置く．</p>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="[@Bafumi+2005] による理想点モデルの階層化">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span><span class="citation" data-cites="Bafumi+2005">(<a href="#ref-Bafumi+2005" role="doc-biblioref">Bafumi et al., 2005</a>)</span> による理想点モデルの階層化
</div>
</div>
<div class="callout-body-container callout-body">
<p>このように共変量を適切な階層に追加することは，モデルに自然な形で正則化情報を伝えることに繋がり，モデルの識別やより現実的な推定値の獲得に繋がる．</p>
</div>
</div>
</section>
<section id="階層ベイズ推定" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="階層ベイズ推定"><span class="header-section-number">2.6</span> 階層ベイズ推定</h3>
<section id="指名大統領の政党属性" class="level4" data-number="2.6.1">
<h4 data-number="2.6.1" class="anchored" data-anchor-id="指名大統領の政党属性"><span class="header-section-number">2.6.1</span> 指名大統領の政党属性</h4>
<p>続いて <a href="#sec-identification" class="quarto-xref">2.5</a> で検討した，<span class="citation" data-cites="Bafumi+2005">(<a href="#ref-Bafumi+2005" role="doc-biblioref">Bafumi et al., 2005</a>)</span> による階層ベイズモデルにより緩やかに情報を伝えることで識別可能性を保つ方法を検討する（第 <a href="#sec-Bafumi" class="quarto-xref">2.6.2</a> 節）．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">nominator =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>      name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Rehnquist"</span>, <span class="st">"Stevens"</span>) <span class="sc">~</span> <span class="st">"Nixon"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>      name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"O.Connor"</span>, <span class="st">"Scalia"</span>, <span class="st">"Kennedy"</span>) <span class="sc">~</span> <span class="st">"Reagan"</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>      name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Souter"</span>, <span class="st">"Thomas"</span>) <span class="sc">~</span> <span class="st">"Bush"</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>      name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Breyer"</span>, <span class="st">"Ginsburg"</span>) <span class="sc">~</span> <span class="st">"Clinton"</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>nominator <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Nixon"</span>, <span class="st">"Reagan"</span>, <span class="st">"Bush"</span>, <span class="st">"Trump"</span>),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-Bafumi" class="level4" data-number="2.6.2">
<h4 data-number="2.6.2" class="anchored" data-anchor-id="sec-Bafumi"><span class="header-section-number">2.6.2</span> 階層２母数モデル</h4>
<p><code>x</code> の情報を階層的に伝えるには，もはや <code>brms</code> パッケージでは実行できないようである．</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="`fit_2PL::brmsfit` で用いた Stan コードの出力">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span><code>fit_2PL::brmsfit</code> で用いた Stan コードの出力
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>brms</code> パッケージでは <a href="https://paulbuerkner.com/brms/reference/stancode.html"><code>stancode()</code></a> 関数を用いて Stan コードを出力できる．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stancode</span>(fit_2PL)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>結果は以下の通りになる：</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// generated with brms 2.21.0</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">functions</span> {</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a> <span class="co">/* compute correlated group-level effects</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">  * Args:</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">  *   z: matrix of unscaled group-level effects</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">  *   SD: vector of standard deviation parameters</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">  *   L: cholesky factor correlation matrix</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">  * Returns:</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">  *   matrix of scaled group-level effects</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">  */</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span> scale_r_cor(<span class="dt">matrix</span> z, <span class="dt">vector</span> SD, <span class="dt">matrix</span> L) {</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// r is stored in another dimension order than z</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> transpose(diag_pre_multiply(SD, L) * z);</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;  <span class="co">// total number of observations</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span> Y;  <span class="co">// response variable</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// data for group-level effects of ID 1</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N_1;  <span class="co">// number of grouping levels</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; M_1;  <span class="co">// number of coefficients per level</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J_1;  <span class="co">// grouping indicator per observation</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// group-level predictor values</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] Z_1_1;</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">// data for group-level effects of ID 2</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N_2;  <span class="co">// number of grouping levels</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; M_2;  <span class="co">// number of coefficients per level</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J_2;  <span class="co">// grouping indicator per observation</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// group-level predictor values</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] Z_2_1;</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] Z_2_2;</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; NC_2;  <span class="co">// number of group-level correlations</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> prior_only;  <span class="co">// should the likelihood be ignored?</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[M_1] sd_1;  <span class="co">// group-level standard deviations</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[M_1] <span class="dt">vector</span>[N_1] z_1;  <span class="co">// standardized group-level effects</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[M_2] sd_2;  <span class="co">// group-level standard deviations</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[M_2, N_2] z_2;  <span class="co">// standardized group-level effects</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">cholesky_factor_corr</span>[M_2] L_2;  <span class="co">// cholesky factor of correlation matrix</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_1] r_1_1;  <span class="co">// actual group-level effects</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N_2, M_2] r_2;  <span class="co">// actual group-level effects</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">// using vectors speeds up indexing in loops</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_2] r_2_1;</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_2] r_2_2;</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> lprior = <span class="dv">0</span>;  <span class="co">// prior contributions to the log posterior</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>  r_1_1 = (sd_1[<span class="dv">1</span>] * (z_1[<span class="dv">1</span>]));</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// compute actual group-level effects</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>  r_2 = scale_r_cor(z_2, sd_2, L_2);</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  r_2_1 = r_2[, <span class="dv">1</span>];</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>  r_2_2 = r_2[, <span class="dv">2</span>];</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>  lprior += student_t_lpdf(sd_1 | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>)</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    - <span class="dv">1</span> * student_t_lccdf(<span class="dv">0</span> | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>  lprior += student_t_lpdf(sd_2 | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>)</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    - <span class="dv">2</span> * student_t_lccdf(<span class="dv">0</span> | <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>  lprior += lkj_corr_cholesky_lpdf(L_2 | <span class="dv">1</span>);</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">// likelihood including constants</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (!prior_only) {</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// initialize linear predictor term</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] mu = rep_vector(<span class="fl">0.0</span>, N);</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>      <span class="co">// add more terms to the linear predictor</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>      mu[n] += r_1_1[J_1[n]] * Z_1_1[n] + r_2_1[J_2[n]] * Z_2_1[n] + r_2_2[J_2[n]] * Z_2_2[n];</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">target +=</span> bernoulli_logit_lpmf(Y | mu);</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>  <span class="co">// priors including constants</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> lprior;</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> std_normal_lpdf(z_1[<span class="dv">1</span>]);</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> std_normal_lpdf(to_vector(z_2));</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">// compute group-level correlations</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>  <span class="dt">corr_matrix</span>[M_2] Cor_2 = multiply_lower_tri_self_transpose(L_2);</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=-<span class="dv">1</span>,<span class="kw">upper</span>=<span class="dv">1</span>&gt;[NC_2] cor_2;</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>  <span class="co">// extract upper diagonal of correlation matrix</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span>:M_2) {</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span>:(k - <span class="dv">1</span>)) {</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>      cor_2[choose(k - <span class="dv">1</span>, <span class="dv">2</span>) + j] = Cor_2[j, k];</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><code>function</code> ブロックでは <code>scale_r_cor()</code> 関数が定義されている．標準化された項目変数 <span class="math inline">\((\alpha_j,\beta_j)\)</span> を <code>z</code> として，その各次元の標準偏差を含む２次元ベクトルを <code>sd_2</code>，Cholesky 因子を <code>L_2</code> として，行列積 <code>sd_2*L2</code> にベクトル <code>z</code> を掛けて返している．これは <span class="math inline">\((\alpha_j,\beta_j)\)</span> を３つの要素（対角行列・Cholesky 因子・標準化されたベクトル）に因数分解して計算していることに起因する．</p>
<p><code>data</code> ブロックでデータのコーディングを定めている．<code>Y</code> は <span class="math inline">\(NJ\)</span> 行列である．<code>case</code> が <code>ID2</code> で <code>name</code> が <code>ID1</code> に対応する．判事 <span class="math inline">\(i\in[n]\)</span> は <code>N_1</code> 人，件数 <span class="math inline">\(j\in[J]\)</span> は <code>N_2</code> 件．このデータから <code>M_1=1</code> 次元の理想点を持った <code>M_2=2</code> パラメータモデルを推定する．<code>Z_1_1</code> が判事を表す標示変数で，項目を表す標示変数は <code>Z_2_1</code> と <code>Z_2_2</code> である．</p>
<p><code>parameter</code> ブロックでは標準化された理想点 <code>z_1</code> と項目パラメータ <code>z_2</code>，それぞれの標準偏差 <code>sd_1</code>, <code>sd_2</code> を宣言している．<code>z_1</code> だけ <code>N_1</code> ベクトル，<code>z_2</code> は <code>N_2</code> 行 <code>M_2</code> 列の行列であることに注意．</p>
<p><code>transformed_parameters</code> で真のスケールに戻す．<code>r_1_1=(sd_1[1]*(z_1[1]))</code> は理想点 <span class="math inline">\(x_1\)</span> にあたり，<code>r_2=scale_r_cor(z_2,sd_2,L_2)</code> は項目パラメータ <span class="math inline">\((\alpha_j,\beta_j)\)</span> にあたる．その後 <code>r_2_1=r_2[,1]</code> と <code>r_2_2=r_2[,2]</code> でそれぞれ <span class="math inline">\(\alpha_j\)</span> と <span class="math inline">\(\beta_j\)</span> に分解している．最後に <code>sd_1</code>, <code>sd_2</code> に t-分布，<code>L_2</code> に Cholesky 分布を事前分布として定義している．</p>
<p><code>model</code> で尤度を定義している．<code>mu</code> はこのブロックでしか使われない線型予測子の格納変数である．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>mu[n] += r_1_1[J_1[n]] * Z_1_1[n] + r_2_1[J_2[n]] * Z_2_1[n] + r_2_2[J_2[n]] * Z_2_2[n];</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>により <span class="math inline">\(\alpha_j+\beta_j x_i\)</span> が計算されている．<span class="math inline">\(j\)</span> は <code>J_2[n]</code>, <span class="math inline">\(i\)</span> は <code>J_1[n]</code> で表されている．最後に <code>bernoulli_logit_lpmf(Y | mu)</code> で尤度が定義される．</p>
<p><code>generated quantities</code> ブロックでは相関行列 <code>cor_2</code> を計算している．</p>
</div>
</div>
</div>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Files/bafumi.stan</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" data-filename="Files/bafumi.stan"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>data {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> n;  <span class="sc">/</span><span class="er">/</span> n <span class="ot">=</span> N <span class="sc">*</span> J <span class="sc">-</span> <span class="co">#(NA responses)</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> N;  <span class="sc">/</span><span class="er">/</span> number of judges</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> J;  <span class="sc">/</span><span class="er">/</span> number of cases</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  array[n] int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span>, upper<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> Y;  <span class="sc">/</span><span class="er">/</span> response variable</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  vector[N] Z;  <span class="sc">/</span><span class="er">/</span> covariates <span class="cf">for</span> judges</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  array[n] int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span>, upper<span class="ot">=</span>N<span class="sc">&gt;</span> i;  <span class="sc">/</span><span class="er">/</span> indicator <span class="cf">for</span> judges i <span class="cf">in</span> [N]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  array[n] int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span>, upper<span class="ot">=</span>J<span class="sc">&gt;</span> j;  <span class="sc">/</span><span class="er">/</span> indicator <span class="cf">for</span> cases j <span class="cf">in</span> [J]</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>parameters {</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  vector[N] X;  <span class="sc">/</span><span class="er">/</span> ideal points <span class="cf">for</span> judges</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  vector[J] alpha;</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  vector[J] beta;</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  real delta;</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  real gamma;</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> sigma;</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>transformed parameters {</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  real lprior <span class="ot">=</span> <span class="dv">0</span>;</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  lprior <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(delta <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  lprior <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(gamma <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  lprior <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(alpha <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  lprior <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(beta <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  lprior <span class="sc">+</span><span class="er">=</span> <span class="fu">std_normal_lpdf</span>(X);</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  lprior <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(sigma <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span> <span class="dv">1</span> <span class="sc">*</span> <span class="fu">student_t_lccdf</span>(<span class="dv">0</span> <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>model {</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  X <span class="sc">~</span> <span class="fu">normal</span>(delta <span class="sc">+</span> Z <span class="sc">*</span> <span class="fu">exp</span>(gamma), sigma);</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  vector[n] mu <span class="ot">=</span> <span class="fu">rep_vector</span>(<span class="dv">0</span>, n);</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    mu[k] <span class="ot">=</span> alpha[j[k]] <span class="sc">+</span> beta[j[k]] <span class="sc">*</span> X[i[k]];</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">bernoulli_logit_lpmf</span>(Y <span class="sc">|</span> mu);</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> lprior;</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<!-- 
```r
## fit without initial values

library(rstan)
case_number <- as.integer(nrow(df) / 9)
indicator_i <- rep(1:9, times = case_number)
indicator_j <- rep(1:case_number, each = 9)
df$i <- indicator_i
df$j <- indicator_j

df_NA <- df %>% filter(!is.na(y))

data <- list(Y = df_NA$y, n = nrow(df_NA), N = 9, J = case_number, Z = df_NA$x[1:9], i = df_NA$i, j = df_NA$j)

fit <- stan("Files/bafumi_modified.stan", data = data, chains = 4, cores = 4, verbose = TRUE, iter = 4000, warmup = 3000)
```

```r
## fit with erronous initial values

init_values <- list(X = c(-1.0,1.0,1.0,-1.0,-1.0,0.0,0.0,1.0,1.0), alpha = rep(0.0, case_number), beta = rep(0.0, case_number), delta = 0.0, gamma = 0.0, sigma = 1.0)
fit <- stan("Files/bafumi.stan", data = data, chains = 4, cores = 4, verbose = TRUE, iter = 4000, warmup = 3000, init = rep(list(init_values), 4))
```

```r
## fit with correct initial values

#| output: false
init_values <- list(X = -1.0 * c(-1.0,1.0,1.0,-1.0,-1.0,0.0,0.0,1.0,1.0), alpha = rep(0.0, case_number), beta = rep(0.0, case_number), delta = 0.0, gamma = 0.0, sigma = 1.0)
fit <- stan("Files/bafumi.stan", data = data, chains = 4, cores = 4, verbose = TRUE, iter = 4000, warmup = 3000, init = rep(list(init_values), 4))
```

```r
## plot X (ideal points)

all_samples <- extract(fit, pars = "X")$X
x_samples <- all_samples[(nrow(all_samples) - 999):nrow(all_samples), ]

plot_dataframe <- data.frame(
  legislator = colnames(Rehnquist)[1:9],
  mean = apply(x_samples, 2, mean),
  lower = apply(x_samples, 2, quantile, probs = 0.025),
  upper = apply(x_samples, 2, quantile, probs = 0.975)
)
p <- ggplot(plot_dataframe, aes(x = mean, y = legislator)) +
  geom_point() +
  geom_errorbar(aes(xmin = lower, xmax = upper), width = 0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Mean", y = "Legislator", title = "Ideal Points of Rehnquist")
p
# ggsave("Files/Bafumi_Model1.png", p)
```
-->
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/stan4.png" class="img-fluid figure-img"></p>
<figcaption>階層モデルの推定結果</figcaption>
</figure>
</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/stan4.png" class="img-fluid figure-img"></p>
<figcaption>今回の推定結果</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Images/2PL.png" class="img-fluid figure-img"></p>
<figcaption>２母数モデル <a href="#sec-2PL" class="quarto-xref">2.4</a> の推定結果</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="識別性の影響" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="識別性の影響"><span class="header-section-number">2.7</span> 識別性の影響</h3>
<p>実は階層的に緩やかにしか情報を伝えていないために，今回の <span class="math inline">\(\gamma\)</span> への事前分布の設定では，まだ <span class="math inline">\(0\)</span> の近くに密集することでもう一つの峰を作り出してしまうようである．</p>
<p>例えば，Stevens, Souter, Ginsburg, Breyer らリベラルな判事の初期位置を右側の <span class="math inline">\(1\)</span> に，Thomas, Scalia ら保守派の判事の初期位置を <span class="math inline">\(-1\)</span> に，そのほか中道的な判事の初期位置を <span class="math inline">\(0\)</span> にしてサンプリングをすると，ほぼ確実に左右が逆になった結果が出てくる．</p>
<p>その際は <span class="math inline">\(\gamma\)</span> の事後分布が大きく違う．</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>init_values <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">X =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>,<span class="sc">-</span><span class="fl">1.0</span>,<span class="sc">-</span><span class="fl">1.0</span>,<span class="fl">0.0</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">1.0</span>), <span class="at">alpha =</span> <span class="fu">rep</span>(<span class="fl">0.0</span>, case_number), <span class="at">beta =</span> <span class="fu">rep</span>(<span class="fl">0.0</span>, case_number), <span class="at">delta =</span> <span class="fl">0.0</span>, <span class="at">gamma =</span> <span class="fl">0.0</span>, <span class="at">sigma =</span> <span class="fl">1.0</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="st">"Files/bafumi.stan"</span>, <span class="at">data =</span> data, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">iter =</span> <span class="dv">4000</span>, <span class="at">warmup =</span> <span class="dv">3000</span>, <span class="at">init =</span> <span class="fu">rep</span>(<span class="fu">list</span>(init_values), <span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<!-- 
```r
gamma_all_samples <- extract(fit, pars = "gamma")$gamma
gamma_samples <- gamma_all_samples[(nrow(gamma_all_samples) - 999):nrow(gamma_all_samples)]
p <- ggplot(data.frame(gamma = exp(gamma_samples)), aes(x = gamma)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "blue", alpha = 0.5) +
  geom_density(color = "red") +
  # xlim(0, 1) +
  labs(x = "Gamma", y = "Density", title = "Posterior Distribution of Gamma")
# ggsave("Files/Bafumi_Model_erronous_Gamma.png", p)
p
```
-->
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model1_Gamma.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が正しい場合の回帰係数 <span class="math inline">\(\gamma\)</span> の事後分布</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model_erronous_Gamma.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が間違っている場合の回帰係数 <span class="math inline">\(\gamma\)</span> の事後分布</figcaption>
</figure>
</div>
</div>
</div>
</div>
<!--
```r
delta_all_samples <- extract(fit, pars = "delta")$delta
delta_samples <- delta_all_samples[(nrow(delta_all_samples) - 999):nrow(delta_all_samples)]
p <- ggplot(data.frame(delta = delta_samples), aes(x = delta)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "blue", alpha = 0.5) +
  geom_density(color = "red") +
  labs(x = "Delta", y = "Density", title = "Posterior Distribution of Delta")
# ggsave("Files/Bafumi_Model_erronous_Delta.png", p)
p
```
-->
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model1_Delta.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が正しい場合の回帰係数 <span class="math inline">\(\delta\)</span> の事後分布</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model_erronous_Delta.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が間違っている場合の回帰係数 <span class="math inline">\(\delta\)</span> の事後分布</figcaption>
</figure>
</div>
</div>
</div>
</div>
<!-- 
```r
X_calc <- delta_samples + df_NA$x[1:9] * exp(gamma_samples)
p <- ggplot(data.frame(x = X_calc), aes(x = x)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "blue", alpha = 0.5) +
  geom_density(color = "red") +
  labs(x = "X", y = "Density", title = "Posterior Distribution of X")
# ggsave("Files/Bafumi_Model_erronous_X.png", p)
p
```
-->
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model1_X.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が正しい場合の理想点の事後分布</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model_erronous_X.png" class="img-fluid figure-img"></p>
<figcaption>理想点の事後平均の位置が間違っている場合の理想点の事後分布</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="事後分布の２峰性" class="level3" data-number="2.8">
<h3 data-number="2.8" class="anchored" data-anchor-id="事後分布の２峰性"><span class="header-section-number">2.8</span> 事後分布の２峰性</h3>
<!-- この階層モデルは極めて事前分布の影響を受けやすい． -->
<p>しかし <span class="math inline">\(\alpha_j,\beta_j,\delta,\gamma\)</span> の事前分布はあまり大きな影響はないようである．<span class="math inline">\(\gamma\)</span> の中心も少しズラしたくらいでは関係ない．<span class="math inline">\(\gamma\)</span> を分散 <span class="math inline">\(1\)</span> で平均 <span class="math inline">\(10\)</span> の正規分布などにすると，<span class="math inline">\(\gamma\)</span> の事後分布は右に引っ張れる．</p>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model_erronous_Gamma.png" class="img-fluid figure-img"></p>
<figcaption>元々の事前分布</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model_artificial_Gamma.png" class="img-fluid figure-img"></p>
<figcaption><span class="math inline">\(\gamma\)</span> を右に引っ張った場合の事後分布</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>しかし理想点の結果自体は（左右の別を除いて）ほとんど変わらない：</p>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model1.png" class="img-fluid figure-img"></p>
<figcaption>元々のモデルの結果</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/Bafumi_Model_artificial.png" class="img-fluid figure-img"></p>
<figcaption><span class="math inline">\(\gamma\)</span> の事後分布を右に引っ張った場合</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>次は初期値をランダムとして９回実行して得る結果である：</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>experiment.r</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" data-filename="experiment.r"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  execution_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="st">"Files/bafumi_normal.stan"</span>, <span class="at">data =</span> data, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">cores =</span> <span class="dv">4</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>, <span class="at">iter =</span> <span class="dv">4000</span>, <span class="at">warmup =</span> <span class="dv">3000</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  })[<span class="st">'elapsed'</span>]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  all_samples <span class="ot">&lt;-</span> <span class="fu">extract</span>(fit, <span class="at">pars =</span> <span class="st">"X"</span>)<span class="sc">$</span>X</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  last_1000_samples <span class="ot">&lt;-</span> all_samples[(<span class="fu">nrow</span>(all_samples) <span class="sc">-</span> <span class="dv">999</span>)<span class="sc">:</span><span class="fu">nrow</span>(all_samples), ]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  plot_dataframe <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">legislator =</span> <span class="fu">colnames</span>(Rehnquist)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>],</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">apply</span>(last_1000_samples, <span class="dv">2</span>, mean),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower =</span> <span class="fu">apply</span>(last_1000_samples, <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper =</span> <span class="fu">apply</span>(last_1000_samples, <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  title <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Elapsed time: "</span>, execution_time, <span class="st">" seconds"</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_dataframe, <span class="fu">aes</span>(<span class="at">x =</span> mean, <span class="at">y =</span> legislator)) <span class="sc">+</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower, <span class="at">xmax =</span> upper), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Mean"</span>, <span class="at">y =</span> <span class="st">"Legislator"</span>, <span class="at">title =</span> title)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">"Files/experiment_"</span>, i, <span class="st">".png"</span>), p)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/experiment_1.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.99 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/experiment_2.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 17.01 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/experiment_3.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.30 seconds</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/experiment_4.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 15.00 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/experiment_5.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 14.98 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/experiment_6.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 15.06 seconds</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/experiment_7.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.42 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/experiment_8.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 16.57 seconds</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/experiment_9.png" class="img-fluid figure-img"></p>
<figcaption>Elapsed time: 17.18 seconds</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>なんと，緩やかな情報伝達に拘らず，判事の理想点はほぼ完全に識別されているが，<strong>方向が違う</strong>！</p>
<p>サンプリングを繰り返すことで結果がよく移り変わる．即ち，この事後分布は２峰あるようである．</p>
<p>そして burn-in 後の 1000 回のサンプリング期間では，異なる峰の間を移り変わることはほとんどないようである．</p>
<p>この点については次の稿も参照：</p>
<div id="listing-lst-embedding1" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="QmF5ZXNpYW4lMkNTdGF0aXN0aWNzJTJDTUNNQyUyQ1I=" data-listing-date-sort="1734825600000" data-listing-file-modified-sort="1760085125813" data-listing-date-modified-sort="1734912000000" data-listing-reading-time-sort="5" data-listing-word-count-sort="954">
<a href="../../../posts/2024/TransDimensionalModels/Bafumi.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top"><img src="Files/Bafumi_Model1.png" style="height: 150px;"  class="thumbnail-image card-img"/></p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
On the Identifiability of the Bafumi et. al.&nbsp;Ideal Point Model
</h5>
<div class="card-subtitle listing-subtitle">
Rethinking of the Hierarchical Model of Bafumi et. al.&nbsp;(2005)
</div>
<div class="listing-categories">

<div class="listing-category" onclick="window.quartoListingCategory('QmF5ZXNpYW4='); return false;">Bayesian</div>

<div class="listing-category" onclick="window.quartoListingCategory('U3RhdGlzdGljcw=='); return false;">Statistics</div>

<div class="listing-category" onclick="window.quartoListingCategory('TUNNQw=='); return false;">MCMC</div>

<div class="listing-category" onclick="window.quartoListingCategory('Ug=='); return false;">R</div>

</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-12-22
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
</section>
<section id="理想点解析パッケージ一覧" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="理想点解析パッケージ一覧"><span class="header-section-number">3</span> 理想点解析パッケージ一覧</h2>
<p>本節では次の３つのパッケージを紹介する：</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li><code>pscl</code> <span class="citation" data-cites="Zeileis+2008">(<a href="#ref-Zeileis+2008" role="doc-biblioref">Zeileis et al., 2008</a>)</span>：<a href="https://github.com/atahk/pscl">GitHub</a>, <a href="https://cran.r-project.org/web/packages/pscl/index.html">CRAN</a>．<span class="citation" data-cites="Arnold2018">(<a href="#ref-Arnold2018" role="doc-biblioref">Arnold, 2018</a>)</span> も参照．</li>
<li><code>MCMCpack</code> <span class="citation" data-cites="Martin+2011">(<a href="#ref-Martin+2011" role="doc-biblioref">Martin et al., 2011</a>)</span>：<a href="https://github.com/cran/MCMCpack">GitHub</a>, <a href="https://cran.r-project.org/web/packages/MCMCpack/index.html">CRAN</a></li>
<li><code>emIRT</code> <span class="citation" data-cites="Imai+2016">(<a href="#ref-Imai+2016" role="doc-biblioref">Imai et al., 2016</a>)</span>：<a href="https://github.com/kosukeimai/emIRT">GitHub</a>, <a href="https://cran.r-project.org/web/packages/emIRT/index.html">CRAN</a></li>
</ul>
</div>
</div>
</div>
<section id="pscl-パッケージ" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="pscl-パッケージ"><span class="header-section-number">3.1</span> <code>pscl</code> パッケージ</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"pscl"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="voteview-データ" class="level4" data-number="3.1.1">
<h4 data-number="3.1.1" class="anchored" data-anchor-id="voteview-データ"><span class="header-section-number">3.1.1</span> <code>voteview</code> データ</h4>
<p>このパッケージでは，Keith T. Poole と Howard Rosenthal が 1995 年から運営しているサイト <a href="https://voteview.com/"><code>voteview.com</code></a> のデータを利用するための関数 <code>readKH()</code> が提供されている．</p>
<p>例えば連邦議会 (U.S. Congress) 117 議会期 (Congress) 2021.1.3-2023.1.3 の上院 (Senate) の点呼投票データを読み込むには以下のようにする：<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pscl)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>s117 <span class="ot">&lt;-</span> <span class="fu">readKH</span>(<span class="st">"https://voteview.com/static/data/out/votes/S117_votes.ord"</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">desc=</span><span class="st">"117th U.S. Senate"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><code>s117</code> は <code>rollcall</code> オブジェクト，８つのフィールドを持った配列である．</p>
<p><code>s117$votes</code> データは <span class="math inline">\(n=104\)</span> 議員の計 <span class="math inline">\(m=949\)</span> 回の投票からなる <span class="math inline">\(10\)</span>-値の行列である．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(s117)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Summary of rollcall object s117 

Description:     117th U.S. Senate 
Source:      https://voteview.com/static/data/out/votes/S117_votes.ord 

Number of Legislators:       104
Number of Roll Call Votes:   949


Using the following codes to represent roll call votes:
Yea:         1 2 3 
Nay:         4 5 6 
Abstentions:     7 8 9 
Not In Legislature:  0 

Party Composition:
    D Indep     R 
   50     2    52 

Vote Summary:
               Count Percent
0 (notInLegis)  3544     3.6
1 (yea)        55542    56.3
6 (nay)        35995    36.5
7 (missing)        5     0.0
9 (missing)     3610     3.7

Use summary(s117,verbose=TRUE) for more detailed information.</code></pre>
</div>
</div>
</section>
<section id="点呼投票データ" class="level4" data-number="3.1.2">
<h4 data-number="3.1.2" class="anchored" data-anchor-id="点呼投票データ"><span class="header-section-number">3.1.2</span> 点呼投票データ</h4>
<p>点呼投票データとは <span class="math inline">\(n\times m\)</span> の行列で，そのエントリーは２値変数である（今回は <span class="math inline">\(1\)</span> か <span class="math inline">\(6\)</span>）．</p>
<p>しかし実際には種々の欠測により，<span class="math inline">\(0,7,9\)</span> も使われる．</p>
<p>これをヒートマップで可視化してみる．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>votes_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(s117<span class="sc">$</span>votes[<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>]) <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="st">"Legislator"</span>)  <span class="co"># 投票データをデータフレームに変換し、行名を列として追加</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>votes_long <span class="ot">&lt;-</span> votes_df <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Legislator, <span class="at">names_to =</span> <span class="st">"Vote"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)  <span class="co"># データを長形式に変換</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(votes_long, <span class="fu">aes</span>(<span class="at">x =</span> Vote, <span class="at">y =</span> Legislator, <span class="at">fill =</span> value)) <span class="sc">+</span> <span class="fu">geom_tile</span>() <span class="sc">+</span> <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Votes"</span>, <span class="at">y =</span> <span class="st">"Legislators"</span>, <span class="at">title =</span> <span class="st">"Voting Patterns"</span>)  <span class="co"># ヒートマップを作成</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="IdealPoint1_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="政党毎の賛成率" class="level4" data-number="3.1.3">
<h4 data-number="3.1.3" class="anchored" data-anchor-id="政党毎の賛成率"><span class="header-section-number">3.1.3</span> 政党毎の賛成率</h4>
<p>政党でソートし，賛成率を最初の 15 法案についてプロットしたものは次の通り：</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 政党ごとの賛成票の割合を計算</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>party_votes <span class="ot">&lt;-</span> s117<span class="sc">$</span>votes <span class="sc">%&gt;%</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">party =</span> s117<span class="sc">$</span>legis.data<span class="sc">$</span>party) <span class="sc">%&gt;%</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(party) <span class="sc">%&gt;%</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">mean</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># データを長形式に変換</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>party_votes_long <span class="ot">&lt;-</span> party_votes <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>party, <span class="at">names_to =</span> <span class="st">"Vote"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># DとRのデータのみを抽出</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>party_votes_d <span class="ot">&lt;-</span> party_votes_long <span class="sc">%&gt;%</span> <span class="fu">filter</span>(party <span class="sc">==</span> <span class="st">"D"</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>party_votes_r <span class="ot">&lt;-</span> party_votes_long <span class="sc">%&gt;%</span> <span class="fu">filter</span>(party <span class="sc">==</span> <span class="st">"R"</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Democrats (D) のデータのみをプロット</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(party_votes_d, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"Vote "</span>, <span class="st">""</span>, Vote)), <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Votes"</span>, <span class="at">y =</span> <span class="st">"Proportion of Yea votes"</span>,</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Proportion of Yea votes for Democrats"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Democrats (D) と Republicans (R) のデータを同じプロットに追加</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> party_votes_d[<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,], <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"Vote "</span>, <span class="st">""</span>, Vote)), <span class="at">y =</span> value, <span class="at">color =</span> <span class="st">"Democrat"</span>), <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> party_votes_r[<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,], <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"Vote "</span>, <span class="st">""</span>, Vote)), <span class="at">y =</span> value, <span class="at">color =</span> <span class="st">"Republican"</span>), <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Democrat"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Republican"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Votes"</span>, <span class="at">y =</span> <span class="st">"Proportion of Yea votes"</span>, <span class="at">color =</span> <span class="st">"Party"</span>,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Proportion of Yea votes by Party"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="IdealPoint1_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>民主党の 0-1 がはっきりした投票行動が見られる．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>s109 <span class="ot">&lt;-</span> <span class="fu">readKH</span>(<span class="st">"https://voteview.com/static/data/out/votes/S109_votes.ord"</span>,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">desc=</span><span class="st">"109th U.S. Senate"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Attempting to read file in Keith Poole/Howard Rosenthal (KH) format.
Attempting to create roll call object
109th U.S. Senate 
102 legislators and 645 roll calls
Frequency counts for vote types:
rollCallMatrix
    0     1     6     7     9 
  645 40207 22650     1  2287 </code></pre>
</div>
</div>
</section>
<section id="ベイズ推定" class="level4" data-number="3.1.4">
<h4 data-number="3.1.4" class="anchored" data-anchor-id="ベイズ推定"><span class="header-section-number">3.1.4</span> ベイズ推定</h4>
<p><code>pscl</code> パッケージでは，<code>rollcall</code> オブジェクトに対して <code>ideal()</code> 関数を用いてデータ拡張に基づく Gibbs サンプラーを通じた理想点解析を行うことができる．</p>
<p><a href="https://github.com/atahk/pscl/blob/master/man/ideal.Rd"><code>ideal()</code> 関数のマニュアル</a> に記載された例では <code>maxiter=260E3, burnin=10E3, thin=100</code> での実行が例示されているが，ここでは簡単に実行してみる．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">dim</span>(s117<span class="sc">$</span>legis.data)[<span class="dv">1</span>]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,n)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>x0[s117<span class="sc">$</span>legis.data<span class="sc">$</span>party<span class="sc">==</span><span class="st">"D"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>x0[s117<span class="sc">$</span>legis.data<span class="sc">$</span>party<span class="sc">==</span><span class="st">"R"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tictoc)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tic</span>(<span class="st">"ideal() fitting"</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>id1 <span class="ot">&lt;-</span> <span class="fu">ideal</span>(s117,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">d=</span><span class="dv">1</span>,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">startvals=</span><span class="fu">list</span>(<span class="at">x=</span>x0),</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">normalize=</span><span class="cn">TRUE</span>,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">store.item=</span><span class="cn">TRUE</span>,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">maxiter=</span><span class="dv">10000</span>,  <span class="co"># MCMCの反復回数</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">burnin=</span><span class="dv">5000</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">thin=</span><span class="dv">50</span>,  <span class="co"># 間引き間隔</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">verbose=</span><span class="cn">TRUE</span>)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="fu">toc</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><code>ideal() fitting: 43.938 sec elapsed</code> であった．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(id1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Looking up legislator names and party affiliations
in rollcall object s117 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="IdealPoint1_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><a href="https://github.com/atahk/pscl/blob/master/man/plot.ideal.Rd"><code>plot.ideal()</code> 関数のマニュアル</a> にある通り，<code>shoALLNames = FALSE</code> がデフォルトになっている．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(id1)  <span class="co"># 全議員の正確な推定値が見れる．</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>もっとも保守的な議員として Trump，５番目にリベラルな議員として Biden の名前がみえる．Harris は中道である．</p>
</section>
</section>
<section id="mcmcpack-パッケージ-1" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="mcmcpack-パッケージ-1"><span class="header-section-number">3.2</span> <code>MCMCpack</code> パッケージ</h3>
<section id="ロジットモデルの推定" class="level4" data-number="3.2.1">
<h4 data-number="3.2.1" class="anchored" data-anchor-id="ロジットモデルの推定"><span class="header-section-number">3.2.1</span> ロジットモデルの推定</h4>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MCMCpack)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># データの生成</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)  <span class="co"># 説明変数1</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)  <span class="co"># 説明変数2</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>Xdata <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, x1, x2)  <span class="co"># デザイン行列</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 真のパラメータ</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>true_beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 応答変数の生成</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">exp</span>(Xdata <span class="sc">%*%</span> true_beta) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(Xdata <span class="sc">%*%</span> true_beta))</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1000</span>, <span class="dv">1</span>, p)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMClogitでサンプリング</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> <span class="fu">MCMClogit</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2,    <span class="co"># モデル式</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>                      <span class="at">burnin =</span> <span class="dv">1000</span>,    <span class="co"># バーンイン期間</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mcmc =</span> <span class="dv">10000</span>,     <span class="co"># MCMCの反復回数</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>                      <span class="at">thin =</span> <span class="dv">1</span>,         <span class="co"># 間引き数</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>                      <span class="at">verbose =</span> <span class="dv">1000</span>)   <span class="co"># 進捗表示間隔</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 結果の確認</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(posterior)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Iterations = 1001:11000
Thinning interval = 1 
Number of chains = 1 
Sample size per chain = 10000 

1. Empirical mean and standard deviation for each variable,
   plus standard error of the mean:

               Mean      SD  Naive SE Time-series SE
(Intercept)  0.4464 0.07613 0.0007613       0.002471
x1          -0.8935 0.08239 0.0008239       0.002677
x2           0.9617 0.08706 0.0008706       0.002880

2. Quantiles for each variable:

               2.5%     25%     50%     75%   97.5%
(Intercept)  0.2962  0.3953  0.4464  0.4972  0.6027
x1          -1.0560 -0.9485 -0.8931 -0.8391 -0.7310
x2           0.7910  0.9017  0.9608  1.0206  1.1369</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(posterior)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="IdealPoint1_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="変化点解析" class="level4" data-number="3.2.2">
<h4 data-number="3.2.2" class="anchored" data-anchor-id="変化点解析"><span class="header-section-number">3.2.2</span> 変化点解析</h4>
<p><span class="citation" data-cites="Chib1998">(<a href="#ref-Chib1998" role="doc-biblioref">Chib, 1998</a>)</span> に基づく変化点モデルのベイズ推定の関数 <code>MCMCpoissonChange()</code> も実装されている．詳しくは <span class="citation" data-cites="Martin+2011">(<a href="#ref-Martin+2011" role="doc-biblioref">Martin et al., 2011</a>)</span> 第4節参照．</p>
</section>
</section>
<section id="emirt-パッケージ" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="emirt-パッケージ"><span class="header-section-number">3.3</span> <code>emIRT</code> パッケージ</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"emIRT"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>このパッケージには備え付けの 80-110 議会期の上院における点呼投票データ <code>dwnom</code> がある．</p>
<p>このデータに対して，階層モデルを用いた理想点解析を行う関数 <code>hierIRT()</code> がある．</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emIRT)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(dwnom)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="do">## This takes about 10 minutes to run on 8 threads</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="do">## You may need to reduce threads depending on what your machine can support</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>lout <span class="ot">&lt;-</span> <span class="fu">hierIRT</span>(<span class="at">.data =</span> dwnom<span class="sc">$</span>data.in,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">.starts =</span> dwnom<span class="sc">$</span>cur,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">.priors =</span> dwnom<span class="sc">$</span>priors,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">.control =</span> {<span class="fu">list</span>(</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">threads =</span> <span class="dv">8</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">thresh =</span> <span class="fl">1e-4</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">maxit=</span><span class="dv">200</span>,</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">checkfreq=</span><span class="dv">1</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>                        )})</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Bind ideal point estimates back to legislator data</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dwnom<span class="sc">$</span>legis, <span class="at">idealpt.hier=</span>lout<span class="sc">$</span>means<span class="sc">$</span>x_implied)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="do">## These are estimates from DW-NOMINATE as given on the Voteview example</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="do">## From file "SL80110C21.DAT"</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>nomres <span class="ot">&lt;-</span> dwnom<span class="sc">$</span>nomres</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="do">## Merge the DW-NOMINATE estimates to model results by legislator ID</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a><span class="do">## Check correlation between hierIRT() and DW-NOMINATE scores</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">merge</span>(final, nomres, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"senate"</span>,<span class="st">"id"</span>),<span class="at">all.x=</span><span class="cn">TRUE</span>,<span class="at">all.y=</span><span class="cn">FALSE</span>)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(res<span class="sc">$</span>idealpt.hier, res<span class="sc">$</span>dwnom1d)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>




</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Arnold2018" class="csl-entry" role="listitem">
Arnold, J. B. (2018). <em><a href="https://jrnold.github.io/bugs-examples-in-stan/"><span class="nocase">Simon Jackman’s Bayesian Model Examples in Stan</span></a></em>.
</div>
<div id="ref-Bafumi+2005" class="csl-entry" role="listitem">
Bafumi, J., Gelman, A., Park, D. K., and Kaplan, N. (2005). <a href="https://doi.org/10.1093/pan/mpi010"><span class="nocase">Practical Issues in Implementing and Understanding Bayesian Ideal Point Estimation</span></a>. <em>Political Analysis</em>, <em>13</em>(2), 171–187.
</div>
<div id="ref-Chib1998" class="csl-entry" role="listitem">
Chib, S. (1998). <a href="https://doi.org/10.1016/S0304-4076(97)00115-2">Estimation and comparison of multiple change-point models</a>. <em>Journal of Econometrics</em>, <em>86</em>(2), 221–241.
</div>
<div id="ref-Imai+2016" class="csl-entry" role="listitem">
Imai, K., Lo, J., and Olmsted, J. (2016). <a href=""><span class="nocase">Fast Estimation of Ideal Points with Massive Data</span></a>. <em>American Political Science Review</em>, <em>110</em>(4), 631–656.
</div>
<div id="ref-Martin-Quinn2002" class="csl-entry" role="listitem">
Martin, A. D., and Quinn, K. M. (2002). <a href="http://www.jstor.org/stable/25791672">Dynamic ideal point estimation via markov chain monte carlo for the u.s. Supreme court, 1953–1999</a>. <em>Political Analysis</em>, <em>10</em>(2), 134–153.
</div>
<div id="ref-Martin+2011" class="csl-entry" role="listitem">
Martin, A. D., Quinn, K. M., and Park, J. H. (2011). <a href="https://doi.org/10.18637/jss.v042.i09"><span class="nocase">MCMCpack: Markov chain Monte Carlo in R</span></a>. <em>Journal of Statistical Software</em>, <em>42</em>(9), 1–21.
</div>
<div id="ref-Zeileis+2008" class="csl-entry" role="listitem">
Zeileis, A., Kleiber, C., and Jackman, S. (2008). <a href="https://www.jstatsoft.org/v27/i08/">Regression models for count data in <span>R</span></a>. <em>Journal of Statistical Software</em>, <em>27</em>(8).
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>“Souter was nominated to the Supreme Court without a significant”paper trail” but was expected to be a conservative justice. Within a few years of his appointment, Souter moved towards the ideological center. He eventually came to vote reliably with the Court’s liberal wing.” <a href="https://en.wikipedia.org/wiki/David_Souter">Wikipedia</a> より引用．<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>１つの議会期 (Congress) は２つの会期 (Session)，第１会期と第２会期から構成される．<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/162348\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            trigger: 'click',
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            positionFixed: true,
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "162348/162348.github.io";
    script.dataset.repoId = "R_kgDOKlfKYQ";
    script.dataset.category = "Announcements";
    script.dataset.categoryId = "DIC_kwDOKlfKYc4CgDmb";
    script.dataset.mapping = "pathname";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://162348.github.io/">
<p>Hirofumi Shiba</p>
</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/162348/162348.github.io/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/ano2math5">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:shiba.hirofumi@ism.ac.jp">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../../../blog.xml">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>