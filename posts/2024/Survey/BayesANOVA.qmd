---
title: "ベイズ分散分析のモデル解析"
subtitle: "心理学実験を題材として"
author: "司馬 博文"
date: 9/24/2024
date-modified: 9/24/2024
categories: [Bayesian, Statistics]
bibliography: 
    - ../../../assets/mathematics.bib
    - ../../../assets/bib.bib
    - ../../../assets/bib1.bib
csl: ../../../assets/apalike.csl
abstract-title: 概要
abstract: |
    心理学などの人間を対象にする研究では変数の数が多く，正しいモデルを見つけるために分散分析 (ANOVA) が広く用いられる．
    しかし，古典的な ANOVA 解析手法である F-検定や t-検定は，データの一側面しか伝えない．
    一方で，モデルの仮定を前面に出したベイズ的な解析手法は，データを探索的に吟味することができ，極めて微妙な消息も捉えることが可能になる．
    本稿では特にベイズ ANOVA 手法 [@Rouder+2016] を採用して，そのモデルケースを実証する．
# image: Images/Polyhazard.png
code-fold: false
listing: 
    -   id: lst-survey
        type: grid
        sort: false
        contents:
            - "Survey1.qmd"
            - "Survey2.qmd"
            - "../Computation/brms.qmd"
            - "Survey3.qmd"
            - "BDA1.qmd"
            - "BDA2.qmd"
        date-format: iso
        fields: [title,image,date,subtitle]
---

{{< include ../../../assets/_preamble.qmd >}}

## はじめに

分散分析では，質的変数 $A$ の各水準 $A=a_1,a_2,\cdots$ について，水準内の変動と，水準間の変動を比較する．

因子 $A$ がデータに何の影響も及ぼさない場合（＋データが正規分布に従う場合），分散の比は中心 $F$-分布に従うはずであり，これに基づいて帰無仮説を検定することが古典的な手続きである．

一方でベイズ分散分析では，「因子 $A$ はデータに何の関係もない」という帰無仮説が支持するモデルと，別のモデルを，事後分布を通じて比較し検討することで結論を下すことを目指す．

この「別のモデル」の選び方は [@Rouder+2012] によって一致性とスケール不変性を持つものが提案されている．詳しくは次の関連記事も参照：

::: {#lst-survey}
:::

## 社会的なロボット

### はじめに

[@Horstmann+2018] は（偽の）心理実験が終了した後にロボットの電源を切るように命令された被験者が，実際にその指示に従うまでの時間が，ロボットの反応によりどう変化するかを調べた．

ロボットの反応には O (objection) と S (Social) の２因子がある．O は電源オフに対して反抗する "No! Please do not switch me off! I am scared that it [sic] will not brighten up again!" という発言をする．S はまるで意識がある人間かのようにユーモアのある会話をする "Oh yes, pizza is great. One time I ate a pizza as big as me."

本研究のデータを利用して検討してみる．$2\times 2$ の ANOVA モデルを考える．

```{r}
#| output: false
library(foreign)
df <- read.spss("Files/pone.0201581.s001.sav", to.data.frame=TRUE)
colnames(df)[colnames(df) == "Objection"] <- "O"
colnames(df)[colnames(df) == "Interaction_type"] <- "S"
```

被験者は全部で $85$ 人．

```{r}
length(df$VP_Code)
```

電源を切るまでにかかった時間のデータには欠測も多い．

```{r}
df$SwitchOff_Time
```

```{r}
df <- df[!is.na(df$SwitchOff_Time), ]
df[df$SwitchOff_Time == 0, ]$SwitchOff_Time <- 1  # questionable ?
df$log_data <- log(df$SwitchOff_Time)
```

```{r}
N <- df[df$O == "No Objection" & df$S == "Functional Interaction", ]
S <- df[df$O == "No Objection" & df$S == "Social Interaction", ]
O <- df[df$O == "Objection" & df$S == "Functional Interaction", ]
OS <- df[df$O == "Objection" & df$S == "Social Interaction", ]

boxplot(
  list(N = log(N$SwitchOff_Time), S = log(S$SwitchOff_Time), O = log(O$SwitchOff_Time), OS = log(OS$SwitchOff_Time)),
  main = "Boxplot of Four Data Sets",
  xlab = "Data Sets",
  ylab = "Values",
  col = c("skyblue", "lightgreen", "pink", "orange"),
  ylim = c(0, 4)
)

```

パッとデータを見ると，O の有無が重要であるようである．O と S の両方があった方が最もロボットに同情をそそるように思われるが，必ずしもそうでないようである．

### 正規性の確認

正規性の確認には [Q-Q plot](https://ja.wikipedia.org/wiki/Q-Qプロット) が利用できる．

一般に Q-Q プロットと言った場合は，２つの分布関数 $F,G$ の分位点関数 $F^{-1},G^{-1}$ について，$\{(F^{-1}(p),G^{-1}(p))\}_{p\in[0,1]}$ （の一部）をプロットしたものである．

ここでは片方の $G$ をデータの経験分布，$F$ を正規分布として Q-Q プロットを描いている．正規分布はほとんど $[-3,3]$ 上に値を取るため，$x$ はこの範囲に収まっていることがわかる．

```{r}
library(ggplot2)
library(gridExtra)

p1 <- ggplot(df, aes(sample = SwitchOff_Time)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  ggtitle("Q-Q Plot") +
  theme_minimal()

p2 <- ggplot(df, aes(sample = log_data)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  ggtitle("log transformed Q-Q Plot") +
  theme_minimal()

grid.arrange(p1, p2, nrow = 1)
```

左は大きな値に関して大きく赤線からの乖離が観察され，典型的な非正規性を示している．

そこでここでは対数変換をした後のデータ `log_data` を後続の解析の対象にする．

### 分散分析の実行

古典的な分散分析は `stats` パッケージの `aov` 関数で実行できる．

```{r}

df$O <- factor(df$O)
df$S <- factor(df$S)

summary(aov(log_data ~ O * S, data = df))
```

いずれの因子も有意にはならない．

しかし O と S の交互作用は少しあるかもしれないと期待させられるような結果である．

棄却はされなかった以上，統計的検定を通じたこれ以上の検討はできないが，ベイズの方法でさらに深く検討することができる．

### ベイズ分散分析の実行

ここではベイズ分散分析の提案者である Rouder と Morey による [`BayesFactor`](https://richarddmorey.github.io/BayesFactor/) パッケージを用いる．

その `anovaBF` 関数では，帰無仮説に対応するモデル（切片項のみのモデル）に対する [JZS 因子](Survey1.qmd#sec-JZS-factor) を出力する：

```{r}
library(BayesFactor)
bf = anovaBF(log_data ~ O * S, data = df)
bf
```

そもそもベイズ因子とは，モデルを仮定した下でのデータの（周辺）尤度比である．２つのモデルの事後分布の比とも密接な関係を持つ．

大雑把に「データを見た後にどれほどモデルへの信念を変えれば良いか？」に関する，データの予測性能 (predictive performance) に基づく指標である．

これを見る限り，O を含んだモデルが大きく支持され，S のみを含んだモデルはむしろ切片のみのモデルよりも予測性能が悪い．

O と S の両方を含んだモデルは，交差項の追加により大きく改善される．

## ハリーポッターを用いた性格テスト

## 参考文献 {.appendix}

本稿の解析は [@vandenBergh+2020] に基づく．

Bayes Anova は階層モデルにおいてどの成分が予測に重要な意味を持つかを定量する極めて強力な手法である．[@BDA p.423] 16.5 節に良い例がある．

> the analysis of variance is a helpful tool in understanding the importance of diﬀerent components in a hierarchical model. [@BDA p.423]

その他の Bayes ANOVA の文献には [@Gelman2005] などがある．

## 終わりに {.appendix}

ベイズ ANOVA の注意点をここに付しておく．

科学としては，ANOVA と統計的検定はベイズ推論とモデル比較の手続きで代替されるべきであると言える．

しかし，発見を端的に要約したり，伝えるべき聴衆に伝わるためには，「検定」ライクな結果とコミュニケーションは大いに有用である．

ベイズ ANOVA はそのためにベストであるが，上述の目標を達成するための特殊な手続きであり，ベイズデータ分析のワークフローの中に自然な位置を見つけるような解析段階ではないことには注意を要する．

ベイズ ANOVA を実行するためのパッケージには `BayesFactor` ([CRAN](https://cran.r-project.org/web/packages/BayesFactor/index.html) / [GitHub](https://github.com/richarddmorey/BayesFactor)) がある．`BayesFactor` では大規模な $M$-元配置 ANOVA モデルにおいても Bayes 因子を用いたモデル比較を行うことができる．

一方で `bayesanova` ([CRAN](https://cran.r-project.org/web/packages/bayesanova/index.html) / [GitHub](https://github.com/cran/bayesanova)) [@Kelter2022] は，検定ライクな手続きを根本的に排除しており，Gauss 混合モデルとして Gibbs サンプラーによるベイズ推定を実行し，ROPE (Region of Practical Equivalence) [@Kruschke2018] を用いたベイズ事後分布に基づくモデル比較を行う．

もちろんこのような完全なモデリングを行うことが理想かもしれないが，従来の ANOVA になれきっている研究者にとっては，Bayesian ANOVA に手を伸ばしてみることが次のステップとして大変良いだろう．