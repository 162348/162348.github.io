---
title: "粒子フィルターの連続極限"
author: "Draft Draft"
date: 1/23/2024
categories: [Particles, Process]
toc: true
number-sections: true
code-block-bg: true
code-block-border-left: "#5AB5BA"
code-overflow: wrap
code-fold: true
bibliography: 
    - ../../../mathematics.bib
    - ../../../bib.bib
csl: ../../../apa.csl
crossref:
    sec-prefix: 節
    eq-prefix: 式
    def-prefix: 定義
    def-title: 定義
    thm-prefix: 定理
    thm-title: 定理
    fig-prefix: 図
    fig-title: 図
abstract-title: 概要
abstract: 粒子フィルターを，拡散過程に対して適用することを考える．
---

{{< include ../../../_preamble.qmd >}}

## 枠組み

リサンプリングと，粒子フィルターは $(\Om,\F,\P)$ 上の関数とする．

観測対象は $(\Om',\F',\P')$ 上の過程 $z:\R_+\times\Om'\to\R^d$ とする．

２つの分布の間の関係を導く．

### リサンプリング

::: {.callout-tip}
## 定義（リサンプリング）

1. 積空間 $[N]^{[N]}$ を **附番の空間** といい，$a\in[N]^{[N]}$ で表す．

2. 粒子数 $N$ に関する **リサンプリング法** とは，荷重に応じて，附番の空間上の確率分布を対応させる関数
$$
r:\R_+^N\to\cP([N]^{[N]})
$$
をいう．

3. リサンプリング法 $r$ が **不偏** であるとは，任意の番号 $j\in[N]$ に対して，その番号を得る粒子数の期待値が，荷重の通りになることをいう：$A\sim r(w)$ ならば，
$$
\E[A^{-1}(j)]=\E\Square{\sum_{i=1}^N1_{\Brace{A(i)=j}}}=N\frac{w_j}{\norm{w}_1}
$$

:::

::: {.callout-caution icon="false" collapse="true" title="PAC-Bayes × リサンプリング？"}
問題構成がすごく PAC-Bayes っぽい．というより，Gibbs classifier っぽい．
:::

::: {.callout-caution icon="false" collapse="true"}
## 空間 $\cP([N]^{[N]})$ と $\cM^1([N]^{[N]})$

任意の元 $\mu\in\cM^1([N]^{[N]})$ は，その一点集合上での値
$$
f_\mu(a):=\mu(\{a\})
$$
で定まるため，$\cM^1([N]^{[N]})$ は $\Map([N]^{[N]},\R_+)$ と，$\cP([N]^{[N]})$ は $[N]^{[N]}$ 上の確率質量関数全体の集合と同一視できる．

さらに，後者の関数空間に，各点収束の位相を入れたものと，弱位相を備えた $\cM^1([N]^{[N]})$ とは同相である．

任意の可算な離散空間 $S$ において，弱収束は全変動収束に等しい．^[[@Dudley2002 p.389] 演習11.1.2．]

一般に [@Scheffe1947] の定理より，密度が各点収束するならば，分布は弱収束する．逆に，$S$ 上の分布が収束するとき，任意の一点集合 $\{x\}\subset S$ の境界は空集合であるから，[@Alexandroff1940] の特徴付けから，密度も収束する．

よって，$\cM^1([N]^{[N]})$ 上の弱収束と，$\Map([N]^{[N]},\R_+)$ 上の各点収束とは同値．いずれも第２可算だから，点列の収束が等しいことは位相も等しいことを含意する．
:::

このリサンプリング法 $r$ の，荷重が一様に近づく（＝殆どリサンプリングをしなくなっていく）極限における性質を，連続関数
$$
\R_+^N\times(0,1)\to \R_+^N
$$
$$
(w,\Delta)\mapsto e^{-\Delta w}:=(e^{-\Delta w^1},\cdots,e^{-\Delta w^N})
$$
を通じて調べる：
$$
\iota(w,\Delta):=\frac{r(e^{-\Delta w})}{\Delta}\quad\in\cM^1([N]^{[N]}).
$$
これは附番の空間 $[N]^{[N]}$ 上に有限測度を定める．弱位相を備えた空間 $\cM^1([N]^{[N]})$ は単に関数 $[N]^{[N]}\to\R_+$ の全体に各点収束の位相を考えた空間と同一視できる．

この
$$
\iota:\R^N_+\times(0,1)\to\cM^1([N]^{[N]})
$$
は連続になるとする．これは，$r:\R_+^N\to\cP([N]^{[N]})$ が連続ならば成り立つ．
^[$\cP([N]^{[N]})$ 上の弱位相は，質量関数の各点収束に同値．よって，任意の附番 $a\in[N]^{[N]}$ に対して，$r(e^{-\Delta w})(a)\in[0,1]$ が連続であることに同値．つまり，$a\in[N]^{[N]}$ の通りにリサンプリングされる確率が，荷重 $w\in\R_+^N$ の変化に対して連続的に変化することを要請している．]

任意の荷重 $w\in\R_+^N$ に対して，$\Delta\searrow0$ の極限で
$$
\ov{\iota}(w,0):=\lim_{\Delta\searrow0}\frac{r(e^{-\Delta w})}{\Delta}\quad\in\cM^1([N]^{[N]}\setminus\{\id_{[N]}\})
$$
が $\id_{[N]}$ 上を除いて存在するとし，延長
$$
\ov{\iota}:\R_+^N\times[0,1]\to\cM^1([N]^{[N]}\setminus\{\id_{[N]}\})
$$
が連続であるとする．

これは $r$ が連続であることに加えて上の収束が $w\in\R_+^N$ に関して一様に成り立つならば，成り立つ．

$\ov{\iota}(w):=\iota(w,0)$ は **極限リサンプリング測度** であり，総和を取ったもの
$$
\begin{align*}
    \ov{\iota}^*(w)&:=(\ov{\iota}(w,0)|1)\\
    &=\sum_{a\in[N]^{[N]}\setminus\{\id_{[N]}\}}\ov{\iota}(w,0)(a)\quad\in\R_+
\end{align*}
$$
は **リサンプリング率** と呼べる．^[ただし，$(\ov{\iota}(w,0)|1)$ の $1$ は $[N]^{[N]}\setminus\{\id_{[N]}\}$ 上の定値関数とした．]

::: {.callout-tip icon="false"}
## 補題（ここまでの議論のまとめ）

リサンプリング法 $r:\R_+^N\to\cP([N]^{[N]})$ が連続で，$[N]^{[N]}\setminus\{\id_{[N]}\}$ 上の各点収束
$$
\ov{\iota}(w):=\lim_{\Delta\searrow0}\frac{r(e^{-\Delta w})}{\Delta}
$$
は $w\in\R^N_+$ 上で一様に成り立つとする．このとき，極限リサンプリング測度 $\ov{\iota}:\R_+^N\to\cM^1([N]^{[N]}\setminus\{\id_{[N]}\})$ は $\cM^1([N]^{[N]}\setminus\{\id_{[N]}\})$ の弱位相について連続である．
:::

### 粒子フィルターの構成

::: {.callout-tip icon="false"}
## 目標となる Feynman-Kac 測度

$\R^d$ 上の伊藤拡散 $\{z_t\}\subset\L(\Om';\R^d)$ は，
$$
b_i,\sigma_{ij}\in\Lip_b(\R^d)\quad(i,j\in[d])
$$
が定める確率微分方程式
$$
z_t=b(z_t)dt+\sigma(z_t)dB_t
$$
で定まるものとする．

これを参照過程とし，ポテンシャル $V\in C_b(\R^d)_+$ が定める Feynman-Kac 測度を $\Pi\in C_c(D_{\R^d}(\R_+))^*$ と表す：
$$
\Pi(f):=\frac{1}{\cZ}\E\Square{f(z_{[0,\tau]})\exp\paren{-\int^\tau_0V(z_u)\,du}}
$$
$$
\cZ:=\E\Square{\exp\paren{-\int^\tau_0V(z_u)\,du}},\qquad f\in C_c(D_{\R^d}(\R_+);\R^d).
$$
:::

この $D_{\R^d}(\R_+)$ 上の Feynman-Kac 測度を，離散時間粒子フィルターがどこまで近似できるかを考える．

::: {.callout-tip icon="false"}
## 粒子フィルターの構成

粒子フィルター $\{X^\Delta_k\}\subset\L(\Om;M_{Nd}(\R))$ は最も自然に構成する．

粒子数 $N$ のリサンプリング法 $r$ に関して，サンプリング間隔を $\Delta>0$ として，
$$
\begin{align*}
    (X^\Delta_k)^i&:=(X_{k-1}^\Delta)^{A_k(i)}+\Delta\cdot b\paren{(X_{k-1}^\Delta)^{A_k(i)}}\\
    &\qquad+\sigma\paren{(X_{k-1}^\Delta)^{A_k(i)}}(B_{k\Delta}^i-B_{(k-1)\Delta}^i)\\
    &\qquad\qquad(i\in[N],k\in\N)\\
    A_k&\iidsim r(e^{-\Delta V(X^\Delta_k)})
\end{align*}
$$
と再帰的に定める．

これを $D_{\R^d}(\R_+)$-過程と見たものを
$$
Z_t^\Delta:=X_{\Floor{\frac{t}{\Delta}}}^\Delta
$$
と表す．フィルトレーション $\F_t$ は $(B_s)_{s\in[0,t]}$ と $\paren{A_{\Floor{\frac{s}{\Delta}}}}_{s\in[0,t]}$ とが生成するものの，完備右連続化とする．

:::

1. 任意の単調減少列 $\{\Delta_n\}\subset\R^+$ に対して，粒子フィルターの列
$$
\{X^{\Delta_n}\}\subset\L(\Om;D_{M_{Nd}(\R)}(\R_+))
$$
は一様に緊密である．

::: {.callout-tip icon="false"}
## 定理

Feynman-Kac 測度を定める参照過程 $\{z_t\}$ とポテンシャル $V:\R^d\to\R_+$ について，次を仮定する：

1. 
$$
b_i,\sigma_{ij}\in\Lip_b(\R^d)\quad(i,j\in[d])
$$
2. 
$$
\inf_{x\in\R^d}\inf_{\substack{\theta\in\R^d\\\norm{\theta}_2=1}}\norm{\sigma(x)\theta}_2>0
$$
3. $$V\in C_b(\R^d)_+$$

リサンプリング法 $r$ について，極限リサンプリング測度
$$
\ov{\iota}:\R_+^{N}\to\cM^1([N]^{[N]}\setminus\{\id_{[N]}\})
$$
が存在し，連続であるとする．^[その結果，任意の $a\in[N]^{[N]}\setminus\{\id_{[N]}\}$ に関して，$\R^{dN}\ni x\mapsto\ov{\iota}(V(x^1,\cdots,x^N))(a)$ が有界連続になる．]

このとき，これが定める粒子フィルター $\{X_k^\Delta\}_{k=0}^\infty$ の càdlàg 延長 $\{Z_t^\Delta\}_{t\in\R_+}$ は，任意の単調減少列 $\{\Delta_n\}\subset\R^+$ に対して，次を満たす：

1. ある Lévy 過程 $\{Z_t\}$ に分布収束する：
$$
(Z_t^{\Delta_n})\dto(Z_t).
$$
2. 分布収束極限の生成作用素 $\L$ は，伊藤拡散 $\{z_t\}$ の生成作用素
$$
\begin{align*}
    Lf(x)&=\frac{1}{2}\sum_{i,j=1}^d(\sigma\sigma^\top)_{ij}(x)\pp{^2f}{x_i\partial x_j}(x)\\
    &\qquad+\sum_{i=1}^db_i(x)\pp{f}{x_i}(x)\\
    &\qquad\qquad(f\in C_c^2(\R^d),x\in\R^d)
\end{align*}
$$
を用いて，
$$
\begin{align*}
    \L f(x)&:=\sum_{j=1}^N\sum_{k=1}^db_k(x^j)\pp{f}{x^j_k}(x)\\
    &\qquad+\sum_{j=1}^N\frac{1}{2}\sum_{k,l=1}^d(\sigma\sigma^\top)_{kl}(x^j)\pp{^2f}{x^j_k\partial x^j_l}(x)\\
    &\qquad+\sum_{a\in[N]^{[N]}\setminus\{\id_{[N]}\}}\ov{\iota}(V(x))(a)\Paren{f(x^{a(1:N)})-f(x^{1:N})}\\
    &\qquad\qquad(f\in C_c^2(\R^{dN}),x\in\R^{dN},x^j\in\R^N)
\end{align*}
$$
と表せる．
3. $\cV\in C_b(\R_+\times\R^{dN})_+$ を有界連続なポテンシャルとすると，任意の $f\in C_b(\R^{dN})$ について，
$$
\begin{align*}
    \lim_{n\to\infty}&\E\Square{f(X^{\Delta_n}_{\floor{\tau/\Delta_n}})\exp\paren{-\sum_{k=0}^{\floor{\tau/\Delta_n}-1}\Delta_n\cV(k\Delta_n,X^{\Delta_n}_k)}}\\
    =&\E\Square{f(Z_\tau)\exp\paren{-\int^\tau_0\cV(u,Z_u)\,du}}.
\end{align*}
$$

:::