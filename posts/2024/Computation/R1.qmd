---
title: "R（１）基本文法"
subtitle: "基本パッケージとその文法"
author: "司馬 博文"
date: 5/7/2021
date-modified: 6/7/2024
categories: [Computation, R]
bibliography: 
    - ../../../mathematics.bib
    - ../../../bib.bib
csl: ../../../apa.csl
abstract-title: 概要
abstract: R は統計計算のための言語です．
format:
  html:
    code-fold: false
---

::: {.callout-important appearance="simple"}
1. 全ては関数である．
2. 全てはベクトルであり，複雑な構造は dispatch の賜物である．
:::

## 基本

### 対話モード
バッチ処理は`R CMD BATCH file.z`で行う．

> When a user types a command at the prompt (or when an expression is read from a file) the first thing that happens to it is that the command is transformed by the parser into an internal representation. The evaluator executes parsed R expressions and returns the value of the expression. All expressions have a value. This is the core of the language. -- [R Language Definition](https://stat.ethz.ch/R-manual/R-devel/doc/manual/R-lang.html#Evaluation-of-expressions-1)

* R：どこからでも対話モードで実行可能なのが R．
* `[1]`はすぐ隣の要素の index．ALGOL 系と違い，1から index する．
    * ベクトルは基本横で`[1]`という行の名前の後に表示される，行列の行は`[1,]`と indexing される．indexing の表示の違いでクラスの違いがわかる．

::: {.callout-caution collapse="true" title="例"}

```{r}
x <- c(10, 20, 30, 40)
x
```

```{r}
mat <- matrix(1:6, nrow = 2)
mat
```

:::

* 関数名直打ちは定義が帰ってくる．

::: {.callout-caution collapse="true" title="例"}

```{r}
sum
```

:::

* `()`も，直打ちも，generic function の神である print 関数を呼んでいる．

::: {.callout-caution collapse="true" title="例"}

```{r}
x <- 42
x
```

```{r}
(x)
```

:::

* working directory の概念がある．
    * `getwd()`, `setwd()`

### 関数

* keyword をつけて呼び出せるが，位置が正しければ省略可能
    * `f(arg1=value1, arg2=value2)`

- R は **関数型言語** で，全ての実装は関数になっている．が，認知容易性のために予約語として実装された特殊文字を用いて，中置記法が使える．
    - `+`などの二項演算子は`”+”(1,2)`として使える．
    - `in`などの Condition Flow の宣言っぽい演算子も実装は関数．

::: {.callout-caution collapse="true" title="例"}

```{r}
`+`(1, 2)
```

```{r}
1 %in% c(1, 2, 3)
```

:::

- 関数適用の大原則：**リサイクル**

  logical の`==`も，`matrix(3,3,3)`も recycle される．
    - `(1,2,3) == (2,3,4)`はベクトルの同一性を表さず，`(F,F,F)`を返し，`matrix(3,3,3)`は３でrecycleされた3×3行列．

::: {.callout-caution collapse="true" title="例"}

```{r}
c(1, 2, 3) + c(4, 5)
```

```{r}
c(1, 2, 3) == c(2, 3, 4)
```

```{r}
matrix(3, nrow = 3, ncol = 3)
```

:::

### オブジェクト操作
`?Syntax`で演算の速さなどがわかる．

* 代入
    * `foo <- object`または`object -> foo`
    * `<<-`は再帰的代入
        * 関数の中でしか使われず，親 environment やグローバル環境の中からも右辺を探す．右辺が見つかったら再びそれを代入する．
    * `=`は代入もできる
    
    > the operator `=` is only allowed at the top level (e.g., in the complete expression typed at the command prompt) or as one of the subexpressions in a braced list of expressions.

::: {.callout-caution collapse="true" title="例"}

```{r}
foo <- 1

change_foo <- function() {
  foo <<- foo + 1
}

change_foo()
print(foo)
```

:::

* evaluetion
    * `(object)`
        * `print(object)` と等価．console だと裸で良い．
* `;`
    * 命令の併記

::: {.callout-caution collapse="true" title="例"}

```{r}
x <- 1; y <- 2; z <- x + y
print(z)
```

:::

* 変数名に数字が使えるのいいな．
  * 語頭は数字にはできない．

::: {.callout-caution title="演算子まとめ" collapse="true"}


| Operator | Description |
|:-:|:----------------|
| `-`      | Minus, can be unary or binary |
| `+`      | Plus, can be unary or binary |
| `!`      | Unary not |
| `~`      | Tilde, used for model formulae, can be either unary or binary |
| `?`      | Help |
| `:`      | Sequence, binary (in model formulae: interaction) |
| `*`      | Multiplication, binary |
| `/`      | Division, binary |
| `^`      | Exponentiation, binary |
| `%x%`    | Special binary operators, x can be replaced by any valid name |
| `%%`     | Modulus, binary |
| `%/%`    | Integer divide, binary |
| `%*%`    | Matrix product, binary |
| `%o%`    | Outer product, binary |
| `%x%`    | Kronecker product, binary |
| `%in%`   | Matching operator, binary (in model formulae: nesting) |
| `%||%`   | Null coalescing operator, binary |
| `<`      | Less than, binary |
| `>`      | Greater than, binary |
| `==`     | Equal to, binary |
| `>=`     | Greater than or equal to, binary |
| `<=`     | Less than or equal to, binary |
| `&`      | And, binary, vectorized |
| `&&`     | And, binary, not vectorized |
| `|`      | Or, binary, vectorized |
| `||`     | Or, binary, not vectorized |
| `<-`     | Left assignment, binary |
| `->`     | Right assignment, binary |
| `$`      | List subset, binary |

: [R Language Definition](https://stat.ethz.ch/R-manual/R-devel/doc/manual/R-lang.html#Operators-1) {.active .hover .bordered .responsive-sm}

:::


### 制御

* `{suite}`：ブロック

    ブロックは閉じるまで評価されない．

  ```{r}
  { x <- 0
  x + 5
  }
  ```

* `if`, `else`, `else if`：条件分岐

    ```r
    if ( statement1 )
        statement2
    else
        statement3
    ```

* `for`, `while`, `repeat`：反復
    
    ```r
    for ( name in vector ) {
        statement
    }
    ```

    ```r
    while ( statement1 ) {
        statement2
    }
    ```

    ```r
    repeat {
        statement
        if ( condition ) break
    }
    ```

* `switch (statement, list)`：`statement`を評価した結果得る数値を用いて，`list`を indexing して（評価して）返す．

  * `switch`は関数として実装されているが，「評価」のステップがあるために制御構文として使える．

  ```{r}
  x <- 3
  switch(x, 2+2, mean(1:10), rnorm(5))
  ```
  ```{r}
  switch(2, 2+2, mean(1:10), rnorm(5))
  ```



## 基本型

### データ構造：built-in は５つ

* vector
    * scaler オブジェクトは長さ１の vector として実装されている？
        * scaler は数値，文字列，論理値など．
    * `c()`が constructor
    * `x[]`で indexing できる
        * `[]`の中身はベクトルで指定できる！これが slice の代わり．

::: {.callout-caution collapse="true" title="例"}

```{r}
x <- c(10, 20, 30, 40, 50)
x[1]
```

```{r}
x[2:4]
```

:::

* matrix
    * `matrix()` がコンストラクタ

::: {.callout-caution collapse="true" title="例"}

```{r}
mat <- matrix(1:9, nrow = 3, ncol = 3)
mat
```

```{r}
mat[2, 3]
```

:::

* list：ベクトルとの違いはデータ型が不均一であるのを認めること．
    * `list()` がコンストラクタ
    * 多分データ分析じゃない計算機命令的な棲み分け．一番 csv みたい，

::: {.callout-caution collapse="true" title="例"}

```{r}
lst <- list(name = "Alice", age = 25, scores = c(90, 85, 88))
lst
```

```{r}
lst[[1]]
```

```{r}
lst$name
```

:::

* data frame：要は実データに即した構造で，行列の拡張．csv みたいな．長さの等しい vector の list．
    * `data.frame` がコンストラクタ．

::: {.callout-caution collapse="true" title="例"}

```{r}
df <- data.frame(name = c("Alice", "Bob"), age = c(25, 30))
df
```

```{r}
df[1, 2]
```

```{r}
df$name
```

:::

* array：ベクトル，行列のその先へ
    * `array`がコンストラクタ

::: {.callout-caution collapse="true" title="例"}

```{r}
arr <- array(1:8, dim = c(2, 2, 2))
arr
```

```{r}
arr[1, 2, 2]
```

:::

### データ型：built-in は 25^[[@Wickham2019] [第12章](https://adv-r.hadley.nz/base-types.html)．]
`typeof()`で調べる

> Note that in the C code underlying R, all objects are pointers to a structure with typedef `SEXPREC`; the different R data types are represented in C by `SEXPTYPE`, which determines how the information in the various parts of the structure is used. 

* `int`：整数
* `double`：クラスとしては`numeric`として実装されている．浮動小数点
  * `3.4e-2`は $3.4×10^-2$ で表す．
* `complex`：`1i`を虚数単位とし，`a+bi`と表す．
* `character`
    * `paste(x,y,[sep=“ “])`
* `logical`：Boole 値

::: {.callout-caution collapse="true" title="例"}

```{r}
typeof(1L)
```

```{r}
typeof(1i)
```

```{r}
typeof(FALSE)
```


:::

* `print(pi, digit=12)`
    * 任意精度表示．多分 print.numeric_version への dispatch

```{r}
print(pi, digit=12)
```

### 予約語とそのデータ型

* `pi`, `e`：`double`型
* `Inf`, `NaN`：`doule`型
* `T`,`F`：TRUE と FALSE の予約．`logical` 型
    * `as.numeric()`で`1`,`0`に埋め込まれる．
* `NA`：Not Available，統計データの欠損を表す．
    * 各モードに１つずつ存在する generic な存在である．
    * `NA_integer_`, `NA_real_`, `NA_complex_`, `NA_character_`, `NA_logical_`, ......
* `LETTERS`, `letters`：アルファベットのベクトル，`character` 型
* `NULL`：`NULL` 型でモードを持たない特殊なオブジェクト．$\emptyset$ のこと．

::: {.callout-caution collapse="true" title="例"}

```{r}
LETTERS
```

:::

### データのクラス
`class()`で調べることが出来る．

多くはデータ型（`typeof()`）と一致する．

```{r}
typeof(pi)
```

```{r}
class(pi)
```

### Logical：２値関数
ベクトルを各成分ごとに評価して，logical vector を返す関数．

* `!=`, `>=`, `<=`

::: {.callout-caution title="例" collapse="true"}
```{r}
x <- c(1, 2, 3)
y <- c(3, 2, 1)
x != y
```

```{r}
x >= y
```

```{r}
x <= y
```

:::

* `is.null()`, `is.na()`, `is.nan()`, `is.finite()`, `is.infinite()`

::: {.callout-caution title="例" collapse="true"}
```{r}
is.na(c(1, NA, 3))
```
```{r}
is.finite(c(1, Inf, NA, NaN))
```
:::

* `identical(1,1.0)`：`T`である，いずれも倍精度浮動小数点で表現されるので．
* `all.equal()`：「ほぼ同じ」かどうか．数値の近似比較に使える．

::: {.callout-caution title="例" collapse="true"}
```{r}
identical(1, 1.0)
```
```{r}
all.equal(1, 1.0000001)
```
:::

* `&`,`|`：論理積・和
* `&&`, `||`：条件式の論理積・和
  * `&`,`|`と違い，ベクトルには使えない．
* `xor()`：排他的論理和

::: {.callout-caution title="例" collapse="true"}
```{r}
x <- c(TRUE, FALSE, TRUE)
y <- c(TRUE, TRUE, FALSE)
x & y
```
```{r}
#| error: true
x && y
```
```{r}
xor(x, y)
```
:::

* `%in%`：match の二項関係版 interface．
    * `"%in%" <- function(x, table) match(x, table, nomatch = 0) > 0`が現状の定義
* `with(data, expr, …)`
    * `data`：data frame
    * `expr`は`data`の列名に関する expression をベタがき
    * 列ごとに`expr`を実行した結果を返す．
* `match(x, table)`
    * `x %in% table`と使える．
    * `x`：vector
    * `table`：vector
    * 返り値：logical vector

::: {.callout-caution title="例" collapse="true"}
```{r}
x <- c(1, 2, 3)
table <- c(2, 3, 4)
x %in% table
```
```{r}
match(x, table)
```
```{r}
data <- data.frame(a = 1:3, b = 4:6)
with(data, a + b)
```
:::

### `mode` について

* `str(obj)`：R object の構造を教えてくれる．structure
* `mode(obj)`：オブジェクトのモード＝データ型を返す．
* `class(obj)`：R は全てのものはオブジェクトだから，class を返す．この値に従って dispatch されている．

> Function `mode` gives information about the mode of an object in the sense of Becker, Chambers & Wilks (1988), and is more compatible with other implementations of the S language. -- [R Language Definition](https://stat.ethz.ch/R-manual/R-devel/doc/manual/R-lang.html)

* `storage.mode(obj)`：オブジェクトの storage mode を返す．

> Finally, the function `storage.mode` returns the storage mode of its argument in the sense of Becker et al. (1988).  -- [R Language Definition](https://stat.ethz.ch/R-manual/R-devel/doc/manual/R-lang.html)

* `help()`：`?keyword`と等価．
    * `Trig {base}`：パッケージ base の Trig についての説明．
    * `graphics::hist`：はパッケージ graphics の関数 hist について．
    * 特殊関数を調べるには`””`で escape する必要があることがある．
* `example()`：R のこの機能やばすぎる
    * help 内の例を実行
    * `demo()`がさらにある．
* `help.search()`：`??”keyword”`と等価．
    * キーワード検索
    * Google 検索と同じ要領で使ってください．

## 属性

`NULL`以外の全てのオブジェクトは`attribute`を持ち得る．`attribute`とは，全ての成分に名前がついた`pairlist`である．

```{r}
attributes(y ~ x1 + x2)
```

属性は，第一義的には R にクラス構造を実装するのに使われる．`class`属性を評価し，そのオブジェクトにどの function dispatch を適用するかを決定する．

```{=html}
<div class="article-card-container">
  <div class="article-card">
    <a href="https://162348.github.io/posts/2024/Computation/R0.html" target="_blank">
      <img src="https://162348.github.io/thumbnail.svg" alt="Article Image" class="article-image">
      <div class="article-content">
        <h3 class="article-title">R の概観</h3>
        <p class="article-description">R は統計計算のための言語です．  </p>
      </div>
    </a>
  </div>
</div>
```

### `names`

`names`は，ベクトルの各要素に名前をつけるための属性であり，indexing にも使われる．

### `class`

`class`は，オブジェクトのクラスを指定する文字列である．