<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="司馬博文">

<title>R によるベイズ混合モデリング入門 – Hirofumi Shiba</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../assets/profile.jpg" rel="icon" type="image/jpeg">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-cf7929f4d66a2bdccc4ecf0c4d40c672.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-62adebfec53d4c95a7ec1fcfb398e1f1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "?",
    "H"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-36GX2G6GLL"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-36GX2G6GLL', { 'anonymize_ip': true});
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&amp;display=swap" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic&amp;display=swap" rel="stylesheet">

<style>
  .navbar-title, .menu-text {
      font-family: "Zen Kurenaido", sans-serif !important;
      font-weight: 400;
      font-style: normal;
  }
  h1, .title, .description, .subtitle {
    font-family: "Zen Kurenaido", sans-serif !important;
  }
</style>

<!-- <style>
  .menu-text {
      font-family: "Gill Sans", sans-serif !important;
      font-weight: 400;
      font-style: normal;
  }
  .navbar-title {
      font-family: "Gill Sans", sans-serif !important;
      font-weight: 400;
      font-style: normal;
  }
</style> -->

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../assets/styles.css">
<meta property="og:title" content="R によるベイズ混合モデリング入門 – Hirofumi Shiba">
<meta property="og:description" content="`brms` はベイズ階層モデリングを，確率的プログラミング言語 Stan をエンジンとして行うための R パッケージである．本稿では，`brms`…">
<meta property="og:image" content="https://162348.github.io/posts/2024/Computation/brms_files/figure-html/unnamed-chunk-4-1.png">
<meta property="og:site_name" content="Hirofumi Shiba">
<meta property="og:image:height" content="768">
<meta property="og:image:width" content="1152">
<meta name="twitter:title" content="R によるベイズ混合モデリング入門 – Hirofumi Shiba">
<meta name="twitter:description" content="`brms` はベイズ階層モデリングを，確率的プログラミング言語 Stan をエンジンとして行うための R パッケージである．本稿では，`brms`…">
<meta name="twitter:image" content="https://162348.github.io/posts/2024/Computation/brms_files/figure-html/unnamed-chunk-4-1.png">
<meta name="twitter:creator" content="@ano2math5">
<meta name="twitter:image-height" content="768">
<meta name="twitter:image-width" content="1152">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Hirofumi Shiba</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../static/English.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Sessions.html"> 
<span class="menu-text">Sessions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Slides.html"> 
<span class="menu-text">Slides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blog.html"> 
<span class="menu-text">ブログ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Japanese.html"> 
<span class="menu-text">自己紹介</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/162348/162348.github.io/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">R によるベイズ混合モデリング入門</h1>
            <p class="subtitle lead">brms を用いた混合効果モデリング入門</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Bayesian</div>
                <div class="quarto-category">MCMC</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">Stan</div>
                <div class="quarto-category">Statistics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>司馬博文 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">5/12/2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">9/12/2024</p>
      </div>
    </div>
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">概要</div>
      <p><code>brms</code> はベイズ階層モデリングを，確率的プログラミング言語 Stan をエンジンとして行うための R パッケージである．本稿では，<code>brms</code> の基本的な使い方と，その実装を紹介する．</p>
      <p>また，ランダム効果モデルとは何であるか，固定効果モデル・混合効果モデル・一般化推定方程式などとの違いをレビューする．ランダム効果の追加は縮小推定などの自動的な正則化を可能とする美点がある一方で，係数の不偏推定やロバスト推定に拘る場合はこれを避ける判断もあり得る．</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#例で学ぶ-brms-の使い方" id="toc-例で学ぶ-brms-の使い方" class="nav-link active" data-scroll-target="#例で学ぶ-brms-の使い方"><span class="header-section-number">1</span> 例で学ぶ <code>brms</code> の使い方</a>
  <ul class="collapse">
  <li><a href="#sec-example" id="toc-sec-example" class="nav-link" data-scroll-target="#sec-example"><span class="header-section-number">1.1</span> カウントデータのモデリング</a></li>
  <li><a href="#モデルの推定とプロット" id="toc-モデルの推定とプロット" class="nav-link" data-scroll-target="#モデルの推定とプロット"><span class="header-section-number">1.2</span> モデルの推定とプロット</a></li>
  <li><a href="#モデルによる予測" id="toc-モデルによる予測" class="nav-link" data-scroll-target="#モデルによる予測"><span class="header-section-number">1.3</span> モデルによる予測</a></li>
  <li><a href="#sec-model-comparison" id="toc-sec-model-comparison" class="nav-link" data-scroll-target="#sec-model-comparison"><span class="header-section-number">1.4</span> モデルの比較</a></li>
  <li><a href="#その他の例" id="toc-その他の例" class="nav-link" data-scroll-target="#その他の例"><span class="header-section-number">1.5</span> その他の例</a></li>
  </ul></li>
  <li><a href="#ランダム効果モデルの正しい使い方" id="toc-ランダム効果モデルの正しい使い方" class="nav-link" data-scroll-target="#ランダム効果モデルの正しい使い方"><span class="header-section-number">2</span> ランダム効果モデルの正しい使い方</a>
  <ul class="collapse">
  <li><a href="#sec-RF" id="toc-sec-RF" class="nav-link" data-scroll-target="#sec-RF"><span class="header-section-number">2.1</span> ランダム効果モデル</a></li>
  <li><a href="#説明変数との相関の問題" id="toc-説明変数との相関の問題" class="nav-link" data-scroll-target="#説明変数との相関の問題"><span class="header-section-number">2.2</span> 説明変数との相関の問題</a></li>
  <li><a href="#固定効果-vs.-変量効果" id="toc-固定効果-vs.-変量効果" class="nav-link" data-scroll-target="#固定効果-vs.-変量効果"><span class="header-section-number">2.3</span> 固定効果 vs.&nbsp;変量効果</a></li>
  <li><a href="#ランダム効果モデルにおける相関のモデリング" id="toc-ランダム効果モデルにおける相関のモデリング" class="nav-link" data-scroll-target="#ランダム効果モデルにおける相関のモデリング"><span class="header-section-number">2.4</span> ランダム効果モデルにおける相関のモデリング</a></li>
  <li><a href="#第三の名前混合効果モデル" id="toc-第三の名前混合効果モデル" class="nav-link" data-scroll-target="#第三の名前混合効果モデル"><span class="header-section-number">2.5</span> 第三の名前：混合効果モデル</a></li>
  <li><a href="#sec-GEE" id="toc-sec-GEE" class="nav-link" data-scroll-target="#sec-GEE"><span class="header-section-number">2.6</span> GEE との違い</a></li>
  <li><a href="#ベイズ混合効果モデルという光" id="toc-ベイズ混合効果モデルという光" class="nav-link" data-scroll-target="#ベイズ混合効果モデルという光"><span class="header-section-number">2.7</span> ベイズ混合効果モデルという光……？</a></li>
  </ul></li>
  <li><a href="#混合効果モデリングのテクニック集" id="toc-混合効果モデリングのテクニック集" class="nav-link" data-scroll-target="#混合効果モデリングのテクニック集"><span class="header-section-number">3</span> 混合効果モデリングのテクニック集</a>
  <ul class="collapse">
  <li><a href="#sec-group-level-variance-estimation" id="toc-sec-group-level-variance-estimation" class="nav-link" data-scroll-target="#sec-group-level-variance-estimation"><span class="header-section-number">3.1</span> グループレベル分散の推定</a></li>
  <li><a href="#sec-shrinkage-estimation" id="toc-sec-shrinkage-estimation" class="nav-link" data-scroll-target="#sec-shrinkage-estimation"><span class="header-section-number">3.2</span> 係数の縮小推定</a></li>
  <li><a href="#sec-subsec-count-data" id="toc-sec-subsec-count-data" class="nav-link" data-scroll-target="#sec-subsec-count-data"><span class="header-section-number">3.3</span> カウントデータ過分散へのお手軽対処法</a></li>
  <li><a href="#変量係数モデルによる非線型モデリング" id="toc-変量係数モデルによる非線型モデリング" class="nav-link" data-scroll-target="#変量係数モデルによる非線型モデリング"><span class="header-section-number">3.4</span> 変量係数モデルによる非線型モデリング</a></li>
  </ul></li>
  <li><a href="#brmsの実装" id="toc-brmsの実装" class="nav-link" data-scroll-target="#brmsの実装"><span class="header-section-number">4</span> <code>brms</code>の実装</a>
  <ul class="collapse">
  <li><a href="#事前分布" id="toc-事前分布" class="nav-link" data-scroll-target="#事前分布"><span class="header-section-number">4.1</span> 事前分布</a></li>
  <li><a href="#回帰式" id="toc-回帰式" class="nav-link" data-scroll-target="#回帰式"><span class="header-section-number">4.2</span> 回帰式</a></li>
  <li><a href="#sec-ubsubsec-covariance-structure" id="toc-sec-ubsubsec-covariance-structure" class="nav-link" data-scroll-target="#sec-ubsubsec-covariance-structure"><span class="header-section-number">4.3</span> 共分散構造</a></li>
  <li><a href="#推論エンジン" id="toc-推論エンジン" class="nav-link" data-scroll-target="#推論エンジン"><span class="header-section-number">4.4</span> 推論エンジン</a></li>
  </ul></li>
  
  
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<div class="callout callout-style-simple callout-tip callout-titled" title="brms: Bayesian Regression Models using 'Stan' リンク集">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
brms: Bayesian Regression Models using ‘Stan’ リンク集
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://cran.r-project.org/web/packages/brms/">r-project</a></li>
<li><a href="https://paul-buerkner.github.io/brms/">Documentation</a></li>
<li><a href="https://github.com/paul-buerkner/brms">GitHub</a></li>
<li><a href="https://discourse.mc-stan.org/">discourse</a></li>
<li><span class="citation" data-cites="Burkner2017">(<a href="#ref-Burkner2017" role="doc-biblioref">Bürkner, 2017</a>)</span></li>
<li><span class="citation" data-cites="Burkner2018">(<a href="#ref-Burkner2018" role="doc-biblioref">Bürkner, 2018</a>)</span></li>
<li><span class="citation" data-cites="Burkner2021">(<a href="#ref-Burkner2021" role="doc-biblioref">Bürkner, 2021</a>)</span></li>
</ul>
</div>
</div>
<p>ダウンロードは：<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"brms"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="例で学ぶ-brms-の使い方" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="例で学ぶ-brms-の使い方"><span class="header-section-number">1</span> 例で学ぶ <code>brms</code> の使い方</h2>
<section id="sec-example" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="sec-example"><span class="header-section-number">1.1</span> カウントデータのモデリング</h3>
<p>Documentation で紹介されている，<a href="https://search.r-project.org/CRAN/refmans/dhglm/html/epilepsy.html"><code>Epilepsy Seizures Data</code></a> <span class="citation" data-cites="Leppik+1987">(<a href="#ref-Leppik+1987" role="doc-biblioref">Leppik et al., 1987</a>)</span>，<span class="citation" data-cites="Thall-Vail1990">(<a href="#ref-Thall-Vail1990" role="doc-biblioref">Thall and Vail, 1990</a>)</span> を用いた <a href="https://paul-buerkner.github.io/brms/">例</a> を実行してみる：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(count <span class="sc">~</span> zAge <span class="sc">+</span> zBase <span class="sc">*</span> Trt <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> epilepsy, <span class="at">family =</span> <span class="fu">poisson</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>てんかん (epilepsy) 患者の発作回数<code>count</code>を被説明変数とし，処置の効果を表す説明変数<code>Trt</code>と患者毎のランダムな切片項<code>(1|patient)</code>，及び<code>zAge</code>,<code>zBase</code>への依存構造を調べたい．</p>
<p>被説明変数<code>count</code>は離散変数であり，Poisson 分布に従うと仮定する．</p>
<div class="callout callout-style-simple callout-note callout-titled" title="説明変数">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
説明変数
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><code>zAge</code>：標準化された年齢</li>
<li><code>zBase</code>：ベースの発作回数</li>
<li><code>Trt</code>：治療の有無を表す２値変数</li>
<li><code>(1|patient)</code>：患者ごとに異なるとした切片項</li>
</ul>
<p><code>zBase * Trt</code>という記法は，この２つの交互作用もモデルに含めることを意味する．</p>
</div>
</div>
<div class="callout callout-style-simple callout-note no-icon callout-titled" title="データの詳細">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
データの詳細
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>epilepsy</code>は59 人の患者に関して，４回の入院時の発作回数を記録した，全 236 データからなる．<code>patient</code>が患者を識別する ID であり，<code>(1|patient)</code>は患者ごとのランダム効果ということになる．</p>
</div>
</div>
<p>従って本モデルは<code>zAge</code>, <code>zBase</code>, <code>Trt</code>, <code>Trt*zBase</code>という固定効果，<code>(1|patient)</code>というランダム効果を取り入れた（一般化線型）<strong>混合効果モデル</strong> ということになり，回帰式は次の通りである： <span class="math display">\[
y_{it} = \beta_1 \cdot\texttt{zAge}_i+ \beta_2 \cdot \texttt{zBase}_i + \beta_3 \cdot \texttt{Trt}_i
\]</span> <span class="math display">\[
+ \beta_4 \cdot (\texttt{zBase}_i \cdot \texttt{Trt}_i) + \alpha_i +\epsilon_{it}.
\]</span> ただし，<span class="math inline">\(\texttt{count}_{it}\)</span> の Poisson 母数を <span class="math inline">\(\lambda_{it}\)</span> として，<span class="math inline">\(y_{it}:=\log(\lambda_{it})\)</span> とした．</p>
<p>解析意図としては，ベースの発作回数が高いほど，治療効果が高い／低いのではないか？という仮説を検証する，<code>zBase*Trt</code>を曝露因子としたモデルである．</p>
<div class="callout callout-style-default callout-caution callout-titled" title="全データ">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
全データ
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>epilepsy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Age Base Trt patient visit count obs        zAge        zBase
1    31   11   0       1     1     5   1  0.42499501 -0.757172825
2    30   11   0       2     1     3   2  0.26528351 -0.757172825
3    25    6   0       3     1     2   3 -0.53327400 -0.944403322
4    36    8   0       4     1     4   4  1.22355252 -0.869511123
5    22   66   0       5     1     7   5 -1.01240850  1.302362646
6    29   27   0       6     1     5   6  0.10557201 -0.158035233
7    31   12   0       7     1     6   7  0.42499501 -0.719726725
8    42   52   0       8     1    40   8  2.18182153  0.778117253
9    37   23   0       9     1     5   9  1.38326402 -0.307819631
10   28   10   0      10     1    14  10 -0.05413949 -0.794618924
11   36   52   0      11     1    26  11  1.22355252  0.778117253
12   24   33   0      12     1    12  12 -0.69298550  0.066641363
13   23   18   0      13     1     4  13 -0.85269700 -0.495050128
14   36   42   0      14     1     7  14  1.22355252  0.403656259
15   26   87   0      15     1    16  15 -0.37356249  2.088730734
16   26   50   0      16     1    11  16 -0.37356249  0.703225054
17   28   18   0      17     1     0  17 -0.05413949 -0.495050128
18   31  111   0      18     1    37  18  0.42499501  2.987437121
19   32   18   0      19     1     3  19  0.58470651 -0.495050128
20   21   20   0      20     1     3  20 -1.17212000 -0.420157930
21   29   12   0      21     1     3  21  0.10557201 -0.719726725
22   21    9   0      22     1     3  22 -1.17212000 -0.832065024
23   32   17   0      23     1     2  23  0.58470651 -0.532496228
24   25   28   0      24     1     8  24 -0.53327400 -0.120589134
25   30   55   0      25     1    18  25  0.26528351  0.890455552
26   40    9   0      26     1     2  26  1.86239852 -0.832065024
27   19   10   0      27     1     3  27 -1.49154300 -0.794618924
28   22   47   0      28     1    13  28 -1.01240850  0.590886756
29   18   76   1      29     1    11  29 -1.65125450  1.676823640
30   32   38   1      30     1     8  30  0.58470651  0.253871861
31   20   19   1      31     1     0  31 -1.33183150 -0.457604029
32   30   10   1      32     1     3  32  0.26528351 -0.794618924
33   18   19   1      33     1     2  33 -1.65125450 -0.457604029
34   24   24   1      34     1     4  34 -0.69298550 -0.270373532
35   30   31   1      35     1    22  35  0.26528351 -0.008250835
36   35   14   1      36     1     5  36  1.06384102 -0.644834526
37   27   11   1      37     1     2  37 -0.21385099 -0.757172825
38   20   67   1      38     1     3  38 -1.33183150  1.339808745
39   22   41   1      39     1     4  39 -1.01240850  0.366210159
40   28    7   1      40     1     2  40 -0.05413949 -0.906957223
41   23   22   1      41     1     0  41 -0.85269700 -0.345265731
42   40   13   1      42     1     5  42  1.86239852 -0.682280626
43   33   46   1      43     1    11  43  0.74441801  0.553440656
44   21   36   1      44     1    10  44 -1.17212000  0.178979662
45   35   38   1      45     1    19  45  1.06384102  0.253871861
46   25    7   1      46     1     1  46 -0.53327400 -0.906957223
47   26   36   1      47     1     6  47 -0.37356249  0.178979662
48   25   11   1      48     1     2  48 -0.53327400 -0.757172825
49   22  151   1      49     1   102  49 -1.01240850  4.485281100
50   32   22   1      50     1     4  50  0.58470651 -0.345265731
51   25   41   1      51     1     8  51 -0.53327400  0.366210159
52   35   32   1      52     1     1  52  1.06384102  0.029195264
53   21   56   1      53     1    18  53 -1.17212000  0.927901651
54   41   24   1      54     1     6  54  2.02211002 -0.270373532
55   32   16   1      55     1     3  55  0.58470651 -0.569942327
56   26   22   1      56     1     1  56 -0.37356249 -0.345265731
57   21   25   1      57     1     2  57 -1.17212000 -0.232927432
58   36   13   1      58     1     0  58  1.22355252 -0.682280626
59   37   12   1      59     1     1  59  1.38326402 -0.719726725
60   31   11   0       1     2     3  60  0.42499501 -0.757172825
61   30   11   0       2     2     5  61  0.26528351 -0.757172825
62   25    6   0       3     2     4  62 -0.53327400 -0.944403322
63   36    8   0       4     2     4  63  1.22355252 -0.869511123
64   22   66   0       5     2    18  64 -1.01240850  1.302362646
65   29   27   0       6     2     2  65  0.10557201 -0.158035233
66   31   12   0       7     2     4  66  0.42499501 -0.719726725
67   42   52   0       8     2    20  67  2.18182153  0.778117253
68   37   23   0       9     2     6  68  1.38326402 -0.307819631
69   28   10   0      10     2    13  69 -0.05413949 -0.794618924
70   36   52   0      11     2    12  70  1.22355252  0.778117253
71   24   33   0      12     2     6  71 -0.69298550  0.066641363
72   23   18   0      13     2     4  72 -0.85269700 -0.495050128
73   36   42   0      14     2     9  73  1.22355252  0.403656259
74   26   87   0      15     2    24  74 -0.37356249  2.088730734
75   26   50   0      16     2     0  75 -0.37356249  0.703225054
76   28   18   0      17     2     0  76 -0.05413949 -0.495050128
77   31  111   0      18     2    29  77  0.42499501  2.987437121
78   32   18   0      19     2     5  78  0.58470651 -0.495050128
79   21   20   0      20     2     0  79 -1.17212000 -0.420157930
80   29   12   0      21     2     4  80  0.10557201 -0.719726725
81   21    9   0      22     2     4  81 -1.17212000 -0.832065024
82   32   17   0      23     2     3  82  0.58470651 -0.532496228
83   25   28   0      24     2    12  83 -0.53327400 -0.120589134
84   30   55   0      25     2    24  84  0.26528351  0.890455552
85   40    9   0      26     2     1  85  1.86239852 -0.832065024
86   19   10   0      27     2     1  86 -1.49154300 -0.794618924
87   22   47   0      28     2    15  87 -1.01240850  0.590886756
88   18   76   1      29     2    14  88 -1.65125450  1.676823640
89   32   38   1      30     2     7  89  0.58470651  0.253871861
90   20   19   1      31     2     4  90 -1.33183150 -0.457604029
91   30   10   1      32     2     6  91  0.26528351 -0.794618924
92   18   19   1      33     2     6  92 -1.65125450 -0.457604029
93   24   24   1      34     2     3  93 -0.69298550 -0.270373532
94   30   31   1      35     2    17  94  0.26528351 -0.008250835
95   35   14   1      36     2     4  95  1.06384102 -0.644834526
96   27   11   1      37     2     4  96 -0.21385099 -0.757172825
97   20   67   1      38     2     7  97 -1.33183150  1.339808745
98   22   41   1      39     2    18  98 -1.01240850  0.366210159
99   28    7   1      40     2     1  99 -0.05413949 -0.906957223
100  23   22   1      41     2     2 100 -0.85269700 -0.345265731
101  40   13   1      42     2     4 101  1.86239852 -0.682280626
102  33   46   1      43     2    14 102  0.74441801  0.553440656
103  21   36   1      44     2     5 103 -1.17212000  0.178979662
104  35   38   1      45     2     7 104  1.06384102  0.253871861
105  25    7   1      46     2     1 105 -0.53327400 -0.906957223
106  26   36   1      47     2    10 106 -0.37356249  0.178979662
107  25   11   1      48     2     1 107 -0.53327400 -0.757172825
108  22  151   1      49     2    65 108 -1.01240850  4.485281100
109  32   22   1      50     2     3 109  0.58470651 -0.345265731
110  25   41   1      51     2     6 110 -0.53327400  0.366210159
111  35   32   1      52     2     3 111  1.06384102  0.029195264
112  21   56   1      53     2    11 112 -1.17212000  0.927901651
113  41   24   1      54     2     3 113  2.02211002 -0.270373532
114  32   16   1      55     2     5 114  0.58470651 -0.569942327
115  26   22   1      56     2    23 115 -0.37356249 -0.345265731
116  21   25   1      57     2     3 116 -1.17212000 -0.232927432
117  36   13   1      58     2     0 117  1.22355252 -0.682280626
118  37   12   1      59     2     4 118  1.38326402 -0.719726725
119  31   11   0       1     3     3 119  0.42499501 -0.757172825
120  30   11   0       2     3     3 120  0.26528351 -0.757172825
121  25    6   0       3     3     0 121 -0.53327400 -0.944403322
122  36    8   0       4     3     1 122  1.22355252 -0.869511123
123  22   66   0       5     3     9 123 -1.01240850  1.302362646
124  29   27   0       6     3     8 124  0.10557201 -0.158035233
125  31   12   0       7     3     0 125  0.42499501 -0.719726725
126  42   52   0       8     3    21 126  2.18182153  0.778117253
127  37   23   0       9     3     6 127  1.38326402 -0.307819631
128  28   10   0      10     3     6 128 -0.05413949 -0.794618924
129  36   52   0      11     3     6 129  1.22355252  0.778117253
130  24   33   0      12     3     8 130 -0.69298550  0.066641363
131  23   18   0      13     3     6 131 -0.85269700 -0.495050128
132  36   42   0      14     3    12 132  1.22355252  0.403656259
133  26   87   0      15     3    10 133 -0.37356249  2.088730734
134  26   50   0      16     3     0 134 -0.37356249  0.703225054
135  28   18   0      17     3     3 135 -0.05413949 -0.495050128
136  31  111   0      18     3    28 136  0.42499501  2.987437121
137  32   18   0      19     3     2 137  0.58470651 -0.495050128
138  21   20   0      20     3     6 138 -1.17212000 -0.420157930
139  29   12   0      21     3     3 139  0.10557201 -0.719726725
140  21    9   0      22     3     3 140 -1.17212000 -0.832065024
141  32   17   0      23     3     3 141  0.58470651 -0.532496228
142  25   28   0      24     3     2 142 -0.53327400 -0.120589134
143  30   55   0      25     3    76 143  0.26528351  0.890455552
144  40    9   0      26     3     2 144  1.86239852 -0.832065024
145  19   10   0      27     3     4 145 -1.49154300 -0.794618924
146  22   47   0      28     3    13 146 -1.01240850  0.590886756
147  18   76   1      29     3     9 147 -1.65125450  1.676823640
148  32   38   1      30     3     9 148  0.58470651  0.253871861
149  20   19   1      31     3     3 149 -1.33183150 -0.457604029
150  30   10   1      32     3     1 150  0.26528351 -0.794618924
151  18   19   1      33     3     7 151 -1.65125450 -0.457604029
152  24   24   1      34     3     1 152 -0.69298550 -0.270373532
153  30   31   1      35     3    19 153  0.26528351 -0.008250835
154  35   14   1      36     3     7 154  1.06384102 -0.644834526
155  27   11   1      37     3     0 155 -0.21385099 -0.757172825
156  20   67   1      38     3     7 156 -1.33183150  1.339808745
157  22   41   1      39     3     2 157 -1.01240850  0.366210159
158  28    7   1      40     3     1 158 -0.05413949 -0.906957223
159  23   22   1      41     3     4 159 -0.85269700 -0.345265731
160  40   13   1      42     3     0 160  1.86239852 -0.682280626
161  33   46   1      43     3    25 161  0.74441801  0.553440656
162  21   36   1      44     3     3 162 -1.17212000  0.178979662
163  35   38   1      45     3     6 163  1.06384102  0.253871861
164  25    7   1      46     3     2 164 -0.53327400 -0.906957223
165  26   36   1      47     3     8 165 -0.37356249  0.178979662
166  25   11   1      48     3     0 166 -0.53327400 -0.757172825
167  22  151   1      49     3    72 167 -1.01240850  4.485281100
168  32   22   1      50     3     2 168  0.58470651 -0.345265731
169  25   41   1      51     3     5 169 -0.53327400  0.366210159
170  35   32   1      52     3     1 170  1.06384102  0.029195264
171  21   56   1      53     3    28 171 -1.17212000  0.927901651
172  41   24   1      54     3     4 172  2.02211002 -0.270373532
173  32   16   1      55     3     4 173  0.58470651 -0.569942327
174  26   22   1      56     3    19 174 -0.37356249 -0.345265731
175  21   25   1      57     3     0 175 -1.17212000 -0.232927432
176  36   13   1      58     3     0 176  1.22355252 -0.682280626
177  37   12   1      59     3     3 177  1.38326402 -0.719726725
178  31   11   0       1     4     3 178  0.42499501 -0.757172825
179  30   11   0       2     4     3 179  0.26528351 -0.757172825
180  25    6   0       3     4     5 180 -0.53327400 -0.944403322
181  36    8   0       4     4     4 181  1.22355252 -0.869511123
182  22   66   0       5     4    21 182 -1.01240850  1.302362646
183  29   27   0       6     4     7 183  0.10557201 -0.158035233
184  31   12   0       7     4     2 184  0.42499501 -0.719726725
185  42   52   0       8     4    12 185  2.18182153  0.778117253
186  37   23   0       9     4     5 186  1.38326402 -0.307819631
187  28   10   0      10     4     0 187 -0.05413949 -0.794618924
188  36   52   0      11     4    22 188  1.22355252  0.778117253
189  24   33   0      12     4     4 189 -0.69298550  0.066641363
190  23   18   0      13     4     2 190 -0.85269700 -0.495050128
191  36   42   0      14     4    14 191  1.22355252  0.403656259
192  26   87   0      15     4     9 192 -0.37356249  2.088730734
193  26   50   0      16     4     5 193 -0.37356249  0.703225054
194  28   18   0      17     4     3 194 -0.05413949 -0.495050128
195  31  111   0      18     4    29 195  0.42499501  2.987437121
196  32   18   0      19     4     5 196  0.58470651 -0.495050128
197  21   20   0      20     4     7 197 -1.17212000 -0.420157930
198  29   12   0      21     4     4 198  0.10557201 -0.719726725
199  21    9   0      22     4     4 199 -1.17212000 -0.832065024
200  32   17   0      23     4     5 200  0.58470651 -0.532496228
201  25   28   0      24     4     8 201 -0.53327400 -0.120589134
202  30   55   0      25     4    25 202  0.26528351  0.890455552
203  40    9   0      26     4     1 203  1.86239852 -0.832065024
204  19   10   0      27     4     2 204 -1.49154300 -0.794618924
205  22   47   0      28     4    12 205 -1.01240850  0.590886756
206  18   76   1      29     4     8 206 -1.65125450  1.676823640
207  32   38   1      30     4     4 207  0.58470651  0.253871861
208  20   19   1      31     4     0 208 -1.33183150 -0.457604029
209  30   10   1      32     4     3 209  0.26528351 -0.794618924
210  18   19   1      33     4     4 210 -1.65125450 -0.457604029
211  24   24   1      34     4     3 211 -0.69298550 -0.270373532
212  30   31   1      35     4    16 212  0.26528351 -0.008250835
213  35   14   1      36     4     4 213  1.06384102 -0.644834526
214  27   11   1      37     4     4 214 -0.21385099 -0.757172825
215  20   67   1      38     4     7 215 -1.33183150  1.339808745
216  22   41   1      39     4     5 216 -1.01240850  0.366210159
217  28    7   1      40     4     0 217 -0.05413949 -0.906957223
218  23   22   1      41     4     0 218 -0.85269700 -0.345265731
219  40   13   1      42     4     3 219  1.86239852 -0.682280626
220  33   46   1      43     4    15 220  0.74441801  0.553440656
221  21   36   1      44     4     8 221 -1.17212000  0.178979662
222  35   38   1      45     4     7 222  1.06384102  0.253871861
223  25    7   1      46     4     3 223 -0.53327400 -0.906957223
224  26   36   1      47     4     8 224 -0.37356249  0.178979662
225  25   11   1      48     4     0 225 -0.53327400 -0.757172825
226  22  151   1      49     4    63 226 -1.01240850  4.485281100
227  32   22   1      50     4     4 227  0.58470651 -0.345265731
228  25   41   1      51     4     7 228 -0.53327400  0.366210159
229  35   32   1      52     4     5 229  1.06384102  0.029195264
230  21   56   1      53     4    13 230 -1.17212000  0.927901651
231  41   24   1      54     4     0 231  2.02211002 -0.270373532
232  32   16   1      55     4     3 232  0.58470651 -0.569942327
233  26   22   1      56     4     8 233 -0.37356249 -0.345265731
234  21   25   1      57     4     1 234 -1.17212000 -0.232927432
235  36   13   1      58     4     0 235  1.22355252 -0.682280626
236  37   12   1      59     4     2 236  1.38326402 -0.719726725</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="モデルの推定とプロット" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="モデルの推定とプロット"><span class="header-section-number">1.2</span> モデルの推定とプロット</h3>
<div class="callout callout-style-default callout-caution callout-titled" title="フィッティングの出力">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
フィッティングの出力
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(count <span class="sc">~</span> zAge <span class="sc">+</span> zBase <span class="sc">*</span> Trt <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> epilepsy, <span class="at">family =</span> <span class="fu">poisson</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 5.2e-05 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.52 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 0.907 seconds (Warm-up)
Chain 1:                0.743 seconds (Sampling)
Chain 1:                1.65 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 1.3e-05 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.13 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 0.918 seconds (Warm-up)
Chain 2:                0.721 seconds (Sampling)
Chain 2:                1.639 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 1.4e-05 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.14 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 0.864 seconds (Warm-up)
Chain 3:                0.726 seconds (Sampling)
Chain 3:                1.59 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 1.3e-05 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.13 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 1.074 seconds (Warm-up)
Chain 4:                0.806 seconds (Sampling)
Chain 4:                1.88 seconds (Total)
Chain 4: </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: poisson 
  Links: mu = log 
Formula: count ~ zAge + zBase * Trt + (1 | patient) 
   Data: epilepsy (Number of observations: 236) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~patient (Number of levels: 59) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     0.58      0.07     0.46     0.74 1.00      804     1363

Regression Coefficients:
           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept      1.77      0.12     1.53     2.00 1.01      636      888
zAge           0.10      0.09    -0.07     0.27 1.00      715     1483
zBase          0.70      0.12     0.46     0.95 1.00      589     1231
Trt1          -0.26      0.17    -0.59     0.07 1.01      656     1034
zBase:Trt1     0.05      0.16    -0.27     0.38 1.00      680     1426

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>基本的な解析の前提がまず出力され，推定結果はグループ毎（今回は患者毎）の変数（今回は <span class="math inline">\(\alpha_i\)</span>）から表示される．</p>
<p>後半に固定効果の係数，すなわち回帰係数の推定結果が表示される．</p>
<p>治療効果<code>Trt</code>の係数は負で，平均的に処置効果はある可能性があるが，95% 信頼区間は <span class="math inline">\(0\)</span> を跨いでいるという意味で，有意とは言えない．また，交差項<code>zBase*Trt</code>の係数は小さく，交互効果の存在を示す証拠はないと思われる．</p>
<p><span class="math inline">\(\widehat{R}\)</span> が１より大きい場合，MCMC が収束していない可能性を意味する <span class="citation" data-cites="Vehtari+2021">(<a href="#ref-Vehtari+2021" role="doc-biblioref">Vehtari et al., 2021</a>)</span>．通説には <span class="math inline">\(\widehat{R}\le1.1\)</span> などの基準がある．</p>
<p>変数を指定して，事後分布と MCMC の軌跡をプロットできる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"b_Trt1"</span>, <span class="st">"b_zBase"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="brms_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>より詳しく見るには<code>conditional_effects</code>関数を用いることもできる．交差項の効果はほとんどないことがわかる：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">conditional_effects</span>(fit1, <span class="at">effects =</span> <span class="st">"zBase:Trt"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-conditional_effects" class="quarto-float quarto-figure quarto-figure-center anchored" width="576">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-conditional_effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="brms_files/figure-html/fig-conditional_effects-1.png" id="fig-conditional_effects" class="img-fluid figure-img" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-conditional_effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
図&nbsp;1
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="モデルによる予測" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="モデルによる予測"><span class="header-section-number">1.3</span> モデルによる予測</h3>
<p>fit したモデル <code>fit1</code> を用いて，平均年齢と平均ベースレートを持つ患者に対する治療効果を予測する：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>newdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Trt =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">zAge =</span> <span class="dv">0</span>, <span class="at">zBase =</span> <span class="dv">0</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(fit1, <span class="at">newdata =</span> newdata, <span class="at">re_formula =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Estimate Est.Error Q2.5 Q97.5
[1,]   5.8870  2.501858    2    11
[2,]   4.5655  2.156588    1     9</code></pre>
</div>
</div>
<p>関数<a href="https://paul-buerkner.github.io/brms/reference/predict.brmsfit.html"><code>predict()</code></a>は事後予測分布からのサンプリングを行う．一方で，関数<a href="https://paul-buerkner.github.io/brms/reference/fitted.brmsfit.html"><code>fitted()</code></a>は平均を返す．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(fit1, <span class="at">newdata =</span> newdata, <span class="at">re_formula =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Estimate Est.Error     Q2.5    Q97.5
[1,] 5.905118 0.7105245 4.614680 7.413713
[2,] 4.537683 0.5298045 3.559239 5.647088</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled" title="予測の出力">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
予測の出力
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>従って，もう１度ずつ実行すると，<code>predict</code>では値が変わるが，<code>fitted</code>では同じ値が出力される．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(fit1, <span class="at">newdata =</span> newdata, <span class="at">re_formula =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Estimate Est.Error Q2.5 Q97.5
[1,]  5.94525  2.551251    2    12
[2,]  4.57525  2.225101    1     9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(fit1, <span class="at">newdata =</span> newdata, <span class="at">re_formula =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Estimate Est.Error     Q2.5    Q97.5
[1,] 5.905118 0.7105245 4.614680 7.413713
[2,] 4.537683 0.5298045 3.559239 5.647088</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="sec-model-comparison" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="sec-model-comparison"><span class="header-section-number">1.4</span> モデルの比較</h3>
<p>モデル<code>fit1</code>で行った Poisson 回帰分析は，<code>fit1</code>に含めた説明変数の違いを除けば，個々の観測が独立になる，という仮定の上に成り立っている（第 <a href="#sec-ubsubsec-covariance-structure" class="quarto-xref">4.3</a> 節）．</p>
<p>この仮定が破れているとき＝全ての説明変数をモデルに含めきれていないとき，Poisson 分布の性質 <span class="math display">\[
\operatorname{E}[X]=\mathrm{V}[X]=\lambda\qquad (X\sim\mathrm{Pois}(\lambda))
\]</span> からの離反として現れ，この現象は <strong>過分散</strong>（overdispersion）とも呼ばれる．</p>
<section id="観測レベルランダム効果" class="level4" data-number="1.4.1">
<h4 data-number="1.4.1" class="anchored" data-anchor-id="観測レベルランダム効果"><span class="header-section-number">1.4.1</span> 観測レベルランダム効果</h4>
<p>ということで，他の説明変数が存在した場合を想定して， Poisson 分布族ではなく，分散が平均よりも大きいような別の分布族を用いて，フィット度合いを比較してみることを考えたい．</p>
<p>そこで，追加の変動をモデルに追加するべく，モデル<code>fit1</code>に観測ごとの切片項 <span class="math inline">\(\eta_{it}\)</span> を追加してみる（この手法は観測レベルランダム効果と呼ばれる．第 <a href="#sec-subsec-count-data" class="quarto-xref">3.3</a> 節参照）．</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(count <span class="sc">~</span> zAge <span class="sc">+</span> zBase <span class="sc">*</span> Trt <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>obs),</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> epilepsy, <span class="at">family =</span> <span class="fu">poisson</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled" title="フィッティングの出力">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
フィッティングの出力
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(count <span class="sc">~</span> zAge <span class="sc">+</span> zBase <span class="sc">*</span> Trt <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>obs),</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> epilepsy, <span class="at">family =</span> <span class="fu">poisson</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 7.4e-05 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.74 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 2.09 seconds (Warm-up)
Chain 1:                1.138 seconds (Sampling)
Chain 1:                3.228 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 1.9e-05 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.19 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 1.918 seconds (Warm-up)
Chain 2:                1.139 seconds (Sampling)
Chain 2:                3.057 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 1.9e-05 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.19 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 1.983 seconds (Warm-up)
Chain 3:                1.133 seconds (Sampling)
Chain 3:                3.116 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 2.4e-05 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.24 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 1.971 seconds (Warm-up)
Chain 4:                1.151 seconds (Sampling)
Chain 4:                3.122 seconds (Total)
Chain 4: </code></pre>
</div>
</div>
</div>
</div>
</div>
<p>こうして得た２つのモデル<code>fit1</code>,<code>fit2</code>を比較する．</p>
<p>LLO (Leave-One-Out) cross-validation が関数<code>loo</code>によって実行できる：</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(fit1, fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled" title="LOO-CV の結果">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
LOO-CV の結果
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(fit1, fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 8 observations with a pareto_k &gt; 0.7 in model 'fit1'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 59 observations with a pareto_k &gt; 0.7 in model 'fit2'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Output of model 'fit1':

Computed from 4000 by 236 log-likelihood matrix.

         Estimate   SE
elpd_loo   -670.9 36.0
p_loo        93.2 13.7
looic      1341.7 72.1
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 2.0]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     228   96.6%   77      
   (0.7, 1]   (bad)        5    2.1%   &lt;NA&gt;    
   (1, Inf)   (very bad)   3    1.3%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.

Output of model 'fit2':

Computed from 4000 by 236 log-likelihood matrix.

         Estimate   SE
elpd_loo   -595.2 14.0
p_loo       108.0  7.2
looic      1190.4 28.0
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.6]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     177   75.0%   85      
   (0.7, 1]   (bad)       52   22.0%   &lt;NA&gt;    
   (1, Inf)   (very bad)   7    3.0%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.

Model comparisons:
     elpd_diff se_diff
fit2   0.0       0.0  
fit1 -75.7      26.5  </code></pre>
</div>
</div>
</div>
</div>
</div>
<p><code>elpd_diff</code> は expected log posterior density の差異を表す．<code>fit2</code>の方が大きく当てはまりが良いことが見て取れる．</p>
<p>また，WAIC (Watanabe-Akaike Information Criterion) も実装されている：</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">waic</span>(fit1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled" title="WAIC の結果">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
WAIC の結果
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">waic</span>(fit1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
53 (22.5%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 236 log-likelihood matrix.

          Estimate   SE
elpd_waic   -667.4 36.1
p_waic        89.8 13.8
waic        1334.9 72.3

53 (22.5%) p_waic estimates greater than 0.4. We recommend trying loo instead. </code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">waic</span>(fit2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
63 (26.7%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 236 log-likelihood matrix.

          Estimate   SE
elpd_waic   -571.4 11.9
p_waic        84.3  5.1
waic        1142.8 23.9

63 (26.7%) p_waic estimates greater than 0.4. We recommend trying loo instead. </code></pre>
</div>
</div>
</div>
</div>
</div>
<p>他にも，<code>reloo</code>, <code>kfold</code> などの関数もある．</p>
<div class="callout callout-style-default callout-caution callout-titled" title="他の関数一覧">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
他の関数一覧
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(<span class="at">class=</span><span class="st">"brmsfit"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] add_criterion           add_ic                  as_draws_array         
 [4] as_draws_df             as_draws_list           as_draws_matrix        
 [7] as_draws_rvars          as_draws                as.array               
[10] as.data.frame           as.matrix               as.mcmc                
[13] autocor                 bayes_factor            bayes_R2               
[16] bridge_sampler          coef                    conditional_effects    
[19] conditional_smooths     control_params          default_prior          
[22] expose_functions        family                  fitted                 
[25] fixef                   formula                 getCall                
[28] hypothesis              kfold                   log_lik                
[31] log_posterior           logLik                  loo_compare            
[34] loo_linpred             loo_model_weights       loo_moment_match       
[37] loo_predict             loo_predictive_interval loo_R2                 
[40] loo_subsample           loo                     LOO                    
[43] marginal_effects        marginal_smooths        mcmc_plot              
[46] model_weights           model.frame             nchains                
[49] ndraws                  neff_ratio              ngrps                  
[52] niterations             nobs                    nsamples               
[55] nuts_params             nvariables              pairs                  
[58] parnames                plot                    post_prob              
[61] posterior_average       posterior_epred         posterior_interval     
[64] posterior_linpred       posterior_predict       posterior_samples      
[67] posterior_smooths       posterior_summary       pp_average             
[70] pp_check                pp_mixture              predict                
[73] predictive_error        predictive_interval     prepare_predictions    
[76] print                   prior_draws             prior_summary          
[79] psis                    ranef                   reloo                  
[82] residuals               restructure             rhat                   
[85] stancode                standata                stanplot               
[88] summary                 update                  VarCorr                
[91] variables               vcov                    waic                   
[94] WAIC                   
see '?methods' for accessing help and source code</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="患者内の相関構造のモデリング" class="level4" data-number="1.4.2">
<h4 data-number="1.4.2" class="anchored" data-anchor-id="患者内の相関構造のモデリング"><span class="header-section-number">1.4.2</span> 患者内の相関構造のモデリング</h4>
<p>また，<code>fit1</code>において，同一患者の異なる訪問の間には全く相関がないと仮定されており，これは全く非現実的な仮定をおいてしまっていると言える．<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>患者内の相関構造は，<code>brm()</code>関数の<code>autocor</code>引数で指定できる（第 <a href="#sec-autocor-argument" class="quarto-xref">4.3.2</a> 節）．</p>
<p>例えば，全く構造を仮定しない場合は，<a href="http://paul-buerkner.github.io/brms/reference/unstr.html"><code>unstr</code></a>を指定する：</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(count <span class="sc">~</span> zAge <span class="sc">+</span> zBase <span class="sc">*</span> Trt <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient),</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">autocor =</span> <span class="sc">~</span><span class="fu">unstr</span>(<span class="at">time=</span>visit, <span class="at">gr=</span>patient),</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> epilepsy, <span class="at">family =</span> <span class="fu">poisson</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled" title="フィッティングの出力">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
フィッティングの出力
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(count <span class="sc">~</span> zAge <span class="sc">+</span> zBase <span class="sc">*</span> Trt <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient),</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">autocor =</span> <span class="sc">~</span><span class="fu">unstr</span>(<span class="at">time=</span>visit, <span class="at">gr=</span>patient),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> epilepsy, <span class="at">family =</span> <span class="fu">poisson</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Argument 'autocor' should be specified within the 'formula' argument.
See ?brmsformula for help.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.000148 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.48 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 4.102 seconds (Warm-up)
Chain 1:                2.262 seconds (Sampling)
Chain 1:                6.364 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 3.9e-05 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.39 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 4.034 seconds (Warm-up)
Chain 2:                3.134 seconds (Sampling)
Chain 2:                7.168 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 4.4e-05 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.44 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 4.157 seconds (Warm-up)
Chain 3:                2.383 seconds (Sampling)
Chain 3:                6.54 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 3.8e-05 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.38 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 4.12 seconds (Warm-up)
Chain 4:                2.316 seconds (Sampling)
Chain 4:                6.436 seconds (Total)
Chain 4: </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>このモデルも<code>fit1</code>より遥かに当てはまりが良く，<code>fit2</code>とほとんど同じ当てはまりの良さが見られる：</p>
<div class="callout callout-style-default callout-caution callout-titled" title="LOO-CV の結果">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
LOO-CV の結果
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(fit2,fit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 59 observations with a pareto_k &gt; 0.7 in model 'fit2'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 51 observations with a pareto_k &gt; 0.7 in model 'fit3'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Output of model 'fit2':

Computed from 4000 by 236 log-likelihood matrix.

         Estimate   SE
elpd_loo   -595.2 14.0
p_loo       108.0  7.2
looic      1190.4 28.0
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.6]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     177   75.0%   85      
   (0.7, 1]   (bad)       52   22.0%   &lt;NA&gt;    
   (1, Inf)   (very bad)   7    3.0%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.

Output of model 'fit3':

Computed from 4000 by 236 log-likelihood matrix.

         Estimate   SE
elpd_loo   -599.7 14.6
p_loo       111.2  7.7
looic      1199.5 29.2
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.5]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     185   78.4%   55      
   (0.7, 1]   (bad)       45   19.1%   &lt;NA&gt;    
   (1, Inf)   (very bad)   6    2.5%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.

Model comparisons:
     elpd_diff se_diff
fit2  0.0       0.0   
fit3 -4.5       2.9   </code></pre>
</div>
</div>
</div>
</div>
</div>
<p>思ったよりも<code>fit2</code>の当てはまりが良いため，Poisson-対数正規混合モデリングを本格的に実施してみることが，次の選択肢になり得る（第 <a href="#sec-subsec-count-data" class="quarto-xref">3.3</a> 節参照）．</p>
</section>
</section>
<section id="その他の例" class="level3" data-number="1.5">
<h3 data-number="1.5" class="anchored" data-anchor-id="その他の例"><span class="header-section-number">1.5</span> その他の例</h3>
<p>Sebastian Weber らにより，<a href="https://opensource.nibr.com/bamdd/">新薬の治験における実際の解析事例をまとめたウェブサイト</a> が公開されている．<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>特に，<a href="https://opensource.nibr.com/bamdd/src/02h_mmrm.html#brms-implementation">13 章</a>で，同様の経時的繰り返し観測データを扱っているが，ここではカウントデータではなく連続な応用変数が扱われている．</p>
</section>
</section>
<section id="ランダム効果モデルの正しい使い方" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="ランダム効果モデルの正しい使い方"><span class="header-section-number">2</span> ランダム効果モデルの正しい使い方</h2>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="概要">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
概要
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>ランダム効果モデル</strong> とは，グループ毎に異なる切片項 <span class="math inline">\(\alpha_{s[i]}\)</span> を追加し，これにも誤差を仮定してモデルに入れて得る階層モデルである．</li>
<li>しかし，<span class="math inline">\(\alpha_{s[i]}\)</span> が（ユニットレベルの）説明変数 <span class="math inline">\(x_i\)</span> と相関を持つ場合，推定量の一致性が失われる．これを回避するために，<span class="math inline">\(x_i\)</span> の係数 <span class="math inline">\(\beta\)</span> にのみ関心がある場合は，固定効果モデルが用いられることも多い．</li>
<li>だが，簡単なトリック（<span class="math inline">\(\alpha_{s[i]}\)</span> の説明変数に <span class="math inline">\(\overline{x}_s\)</span> を追加すること）で，推定量の一致性を回復することができる．</li>
<li>このトリックを取り入れたランダム効果モデルは，<span class="math inline">\(x_i\)</span> と <span class="math inline">\(\alpha_{s[i]}\)</span> に相関がない場合は固定効果モデルと等価な <span class="math inline">\(\beta\)</span> の推定量を与え，相関がある場合でも，<span class="math inline">\(\beta\)</span> を一致推定し，各変動切片項 <span class="math inline">\(\alpha_{s[i]}\)</span> の構造にも洞察を与えてくれる．</li>
</ul>
</div>
</div>
<p>ランダム効果モデルは線型混合モデル (Linear Mixed Model; LMM) とも呼ばれる．</p>
<blockquote class="blockquote">
<p>LMM は，母数の共通化によるデータのプーリングと変動効果による標本平均の縮小作用を生み出すことのできるモデルであり，その結果生ずる予測量が EBLUE になる．したがって，EBLUE は，各々の地域の標本平均とプールされた回帰推定量との加重平均になっており，データ数が少ないときには標本平均をプールされた推定量の方向へ縮小することにより，推定精度の改善を図っている．<span class="citation" data-cites="久保川達也2006">(<a href="#ref-久保川達也2006" role="doc-biblioref">久保川達也, 2006</a>)</span></p>
</blockquote>
<section id="sec-RF" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="sec-RF"><span class="header-section-number">2.1</span> ランダム効果モデル</h3>
<p><strong>ランダム効果</strong> は，変動する切片項と呼んだ方がわかりやすい <span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007</a>)</span> と言われるように，サブグループ毎に異なる切片項のことである．<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p>ユニット（個人などの最小単位）レベルの回帰式を書き下すと，グループ選択関数 <span class="math inline">\(s:[n]\to[S]\;(S\le n)\)</span> を通じて， <span id="eq-stage-1"><span class="math display">\[
y_i=\alpha_{s[i]}+\beta x_i+\epsilon_i,\qquad i\in[n],
\tag{1}\]</span></span> というようになる．</p>
<p>これは，確率変数 <span class="math inline">\(\alpha_{s[i]}\)</span> の平均を <span class="math inline">\(\alpha_0\)</span> とすると，グループレベルの回帰式 <span id="eq-stage-2"><span class="math display">\[
\alpha_s=\alpha_0+\eta_s,\qquad s\in[S]
\tag{2}\]</span></span> が背後にある <strong>階層モデル</strong> (multilevel / hierarchical model) だとみなすこともできる．</p>
</section>
<section id="説明変数との相関の問題" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="説明変数との相関の問題"><span class="header-section-number">2.2</span> 説明変数との相関の問題</h3>
<section id="問題の所在" class="level4" data-number="2.2.1">
<h4 data-number="2.2.1" class="anchored" data-anchor-id="問題の所在"><span class="header-section-number">2.2.1</span> 問題の所在</h4>
<p>ランダム効果では，ユニットレベルの説明変数 <span class="math inline">\(x_i\)</span> と変動切片項 <span class="math inline">\(\alpha_{s[i]}\)</span> が相関を持たないという仮定が Gauss-Markov の定理の仮定に等価になるため，これが違反されると推定量の不偏性・一致性が約束されず，推定量の分散も大きくなる．<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="Gauss-Markov の仮定">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Gauss-Markov の仮定
</div>
</div>
<div class="callout-body-container callout-body">
<p>ユニットレベル回帰式 <span class="math display">\[
y_i=\alpha_{s[i]}+\beta x_i+\epsilon_i,\qquad i\in[n],\tag{1}
\]</span> において，ユニットレベルの説明変数 <span class="math inline">\(x_i\)</span> と変動切片項 <span class="math inline">\(\alpha_{s[i]}\)</span> が相関を持たないこと．</p>
</div>
</div>
<p>実際，ランダム効果モデルの階層構造を，(<a href="#eq-stage-2" class="quarto-xref">2</a>) を (<a href="#eq-stage-1" class="quarto-xref">1</a>) に代入することで一つの式にまとめると <span id="eq-RF"><span class="math display">\[
y_i=\alpha_0+\beta x_i+\underbrace{\epsilon_i'}_{\epsilon_i+\eta_{s[i]}}
\tag{3}\]</span></span> を得る．</p>
<p>このような誤差項の構造 <span class="math inline">\(e_{it}=\alpha_i+\epsilon_{it}\)</span> を <strong>一元配置モデル</strong> (one-way error component model) ともいう <span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022, p. 600</a>)</span>, <span class="citation" data-cites="久保川達也2006">(<a href="#ref-久保川達也2006" role="doc-biblioref">久保川達也, 2006, p. 155</a>)</span>．</p>
<p><span class="math inline">\(x_i\)</span> と <span class="math inline">\(\alpha_{s[i]}\)</span> に相関がある場合，<span class="math inline">\(x_i\)</span> と <span class="math inline">\(\eta_s\)</span> にも相関があるため，結果として (<a href="#eq-RF" class="quarto-xref">3</a>) では説明変数と誤差 <span class="math inline">\(\epsilon_i'\)</span> に相関が生じてしまう．これは計量経済学では <strong>内生性</strong> (endogeneity) の問題と呼ばれているものに他ならない．</p>
</section>
<section id="業界の現状母数効果モデル" class="level4" data-number="2.2.2">
<h4 data-number="2.2.2" class="anchored" data-anchor-id="業界の現状母数効果モデル"><span class="header-section-number">2.2.2</span> 業界の現状：母数効果モデル</h4>
<p>そのため，ランダム効果モデルは避けられる傾向にあり，切片項 <span class="math inline">\(\alpha_{s[i]}\equiv\alpha_0\)</span> は変動しないとし，グループレベルの効果を無視してモデリングすることも多い： <span class="math display">\[
y_i=\alpha_0+\beta x_i+\epsilon_i.
\]</span> このことを <strong>完全プーリングモデル</strong> (complete pooling model) または母数効果モデルと呼び，ランダム効果モデルを <strong>部分プーリングモデル</strong> (partial pooling model) と呼んで対比させることがある．<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<p>周辺モデル (marginal model) や <strong>母平均モデル</strong> (population-average model) とも呼ばれる <span class="citation" data-cites="Gardiner+2009">(<a href="#ref-Gardiner+2009" role="doc-biblioref">Gardiner et al., 2009, p. 228</a>)</span>．</p>
<p>実際，これ以上の仮定を置かず，ランダム効果は局外母数として（<strong>母数効果</strong>ともいう）一般化推定方程式の方法（第 <a href="#sec-GEE" class="quarto-xref">2.6</a> 節）によれば，<span class="math inline">\(\beta\)</span> の不偏推定が可能である．</p>
<p>リンク関数 <span class="math inline">\(g\)</span> を通じた非線型モデル <span class="math display">\[
g(\operatorname{E}[y_i|x_i])=\beta x_i
\]</span> であっても，指数型分布族を仮定すれば，<span class="math inline">\(\beta\)</span> の一致推定が可能である．</p>
<p>だが，切片項の変動を消してしまうことで，回帰係数 <span class="math inline">\(\beta\)</span> の推定に対する縮小効果（第 <a href="#sec-shrinkage-estimation" class="quarto-xref">3.2</a> 節）が得られないという欠点もあり，小地域推定などにおいては <span class="math inline">\(\alpha_{s[i]}\)</span> を確率変数とみなす積極的理由もある．この点については <span class="citation" data-cites="久保川達也2006">(<a href="#ref-久保川達也2006" role="doc-biblioref">久保川達也, 2006</a>)</span> も参照．</p>
</section>
<section id="sec-fixed-effects-model" class="level4" data-number="2.2.3">
<h4 data-number="2.2.3" class="anchored" data-anchor-id="sec-fixed-effects-model"><span class="header-section-number">2.2.3</span> 固定効果モデルという解決</h4>
<p>問題を起こさずに，しかしながらグループレベルの効果をモデリングしたい場合， <span class="math display">\[
y_i=\alpha_{s[i]}^{\text{unmodeled}}+\beta x_i+\epsilon_i
\]</span> <span class="math display">\[
\alpha_s^{\text{unmodeled}}\sim\mathrm{N}(\alpha_0,\infty)
\]</span> として，グループ毎に変動する切片項 <span class="math inline">\(\alpha_{s[i]}^{\text{unmodeled}}\)</span> を許すが，この変数自体にモデルは仮定しない，とすることもできる．</p>
<p>このようなモデルは，グループ毎に別々の回帰分析を実行し，<span class="math inline">\(\beta\)</span> の値はこれらのグループの間で適切に重みづけて最終的な推定値としているに等しい．</p>
<p>すなわち，グループの数だけ，グループへの所属を表す２値変数 <span class="math inline">\(1_{s[i]=s}\)</span> を導入し，<span class="math inline">\(S\)</span> 個の項 <span class="math inline">\(\sum_{s=1}^S1_{s[i]=s}\alpha_{s[i]}^{\text{unmodeled}}\)</span> を説明変数に加えて回帰分析を行うことに等しい．</p>
<div class="callout callout-style-simple callout-caution no-icon callout-titled" title="固定効果モデルの別名">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
固定効果モデルの別名
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022</a>)</span> をはじめ，計量経済学では fixed effects model と呼ばれる．</li>
<li><span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007</a>)</span> は unmodeled varying intercept と呼んでいる．</li>
<li>least squares dummy variable regression とも呼べる．<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></li>
</ul>
</div>
</div>
</section>
</section>
<section id="固定効果-vs.-変量効果" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="固定効果-vs.-変量効果"><span class="header-section-number">2.3</span> 固定効果 vs.&nbsp;変量効果</h3>
<div class="callout callout-style-simple callout-caution no-icon callout-titled" title="利点">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
利点
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math inline">\(x_i\)</span> と <span class="math inline">\(\alpha_{s[i]}\)</span> が相関を持ち得る場合も，固定効果モデルでは問題が生じない．<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
</div>
</div>
<div class="callout callout-style-simple callout-caution no-icon callout-titled" title="問題点">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
問題点
</div>
</div>
<div class="callout-body-container callout-body">
<p>異なるグループのデータが相互作用する機構がランダム効果モデルに比べて貧しい．</p>
<p>例えばランダム効果モデルを用いた場合，外れ値グループが存在するなどノイズの大きなデータに対しても，<span class="math inline">\(\eta_s\)</span> を通じて緩やかに情報が伝達され，<span class="math inline">\(\beta\)</span> の値は平均へ縮小されて推定される（第 <a href="#sec-shrinkage-estimation" class="quarto-xref">3.2</a> 節）．固定効果モデルではそのような頑健性を持たない <span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007, pp. 4–5</a>)</span>．</p>
</div>
</div>
<p>固定効果モデルは <span class="math inline">\(\beta\)</span> （のみ）に関心がある場合，<span class="math inline">\(\alpha_{s[i]}\)</span> と <span class="math inline">\(x_i\)</span> の相関の存在に対してロバストな推定法として有用であり，その理由で計量経済学（特に線型パネルデータ）では主流の推定手法となっている．<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p>
<p>実際，<span class="math inline">\(\alpha_{s[i]}\)</span> と <span class="math inline">\(x_i\)</span> が無相関であるとき，変量効果モデルと固定効果モデルは <span class="math inline">\(\beta\)</span> に関しては等価な推定量を与える．</p>
<blockquote class="blockquote">
<p>Current econometric practice is to prefer robustness over efficiency. Consequently, current practice is (nearly uniformly) to use the fixed effects estmimator for linear panel data models. <span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022, p. 624</a>)</span></p>
</blockquote>
<p>逆に言えば，固定効果モデルは <span class="math inline">\(x_i\)</span> と <span class="math inline">\(\alpha_{s[i]}\)</span> の構造のモデリングを放棄したモデリング法であり，各 <span class="math inline">\(\alpha_{s[i]}\)</span> の値にも興味がある場合，または <span class="math inline">\(\beta\)</span> のより精度の高い推定が実行したい場合には，やはり <span class="math inline">\(\alpha_{s[i]}\)</span> の誤差と相関構造もモデルに取り入れたランダム効果モデルを用いたいということになる．</p>
</section>
<section id="ランダム効果モデルにおける相関のモデリング" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="ランダム効果モデルにおける相関のモデリング"><span class="header-section-number">2.4</span> ランダム効果モデルにおける相関のモデリング</h3>
<p><span class="math inline">\(x_i\)</span> と <span class="math inline">\(\alpha_{s[i]}\)</span> が相関を持つ場合に一致推定が保証されないことがランダム効果モデルの欠陥だと述べたが，実はこれは簡単な方法で解決できる．</p>
<p><span class="math inline">\(x_i\)</span> と <span class="math inline">\(\alpha_{s[i]}\)</span> との相関は，欠落変数が存在するため，と考えることができる．</p>
<p>そしてこの相関は，説明変数の平均 <span class="math inline">\(\overline{x}_s\)</span> を変動する切片項 <span class="math inline">\(\alpha_s\)</span> の説明変数として追加することで除去できる：<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></p>
<p><span class="math display">\[
y_i=\alpha_{s[i]}+\beta x_i+\epsilon_i
\]</span> <span class="math display">\[
\alpha_s=\alpha_0+\alpha_1\overline{x}_s+\eta_s
\]</span></p>
<p>これにより，Gauss-Markov の仮定（外生性）が回復される．</p>
<p><span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007, pp. 7–9</a>)</span> にシミュレーションによる検証が掲載されている．</p>
<blockquote class="blockquote">
<p>Practitioners can get around this problem by taking advantage of the <strong>multilevel structure</strong> of their regression equation. <span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007, p. 12</a>)</span></p>
</blockquote>
</section>
<section id="第三の名前混合効果モデル" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="第三の名前混合効果モデル"><span class="header-section-number">2.5</span> 第三の名前：混合効果モデル</h3>
<p>以上，解説してきたランダム効果モデル／変量効果モデルであるが，<strong>混合効果モデル</strong> とも呼ばれる．<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a></p>
<p>何を言っているのかわからないかもしれないが，式 (<a href="#eq-stage-1" class="quarto-xref">1</a>) <span class="math display">\[
y_i=\alpha_{s[i]}+\beta x_i+\epsilon_i,\qquad i\in[n],\tag{1}
\]</span> において，<span class="math inline">\(\alpha_{s[i]}\)</span> がランダム効果であるが，回帰係数 <span class="math inline">\(\beta\)</span> を <strong>固定効果</strong> とも呼ぶことがあるのである．</p>
<p>そしてこう見ると全体として固定効果と変量効果が同居した <strong>混合（効果）モデル</strong> とも呼べそうである．</p>
<p>現代的には，必要ならば <span class="math inline">\(\beta\)</span> を確率変数とみなしても良いだろうが，慣習的にそう呼ぶため，これに従わざるを得ない，というのが <span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022, p. 625</a>)</span> などを見る限り共通了解であるようである．</p>
<p>これが計量経済学における固定効果モデル（第 <a href="#sec-fixed-effects-model" class="quarto-xref">2.2.3</a> 節）の名前の由来である．<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> 実際，固定効果モデルは，たしかに（ユニットレベルでの回帰係数という意味での）「固定効果」を表す変数しか含んでいない（少なくとも見た目上は）．</p>
<div class="callout callout-style-simple callout-caution no-icon callout-titled" title="線型混合モデルの別名">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
線型混合モデルの別名
</div>
</div>
<div class="callout-body-container callout-body">
<p>式 (<a href="#eq-stage-1" class="quarto-xref">1</a>) <span class="math display">\[
y_i=\alpha_{s[i]}+\beta x_i+\epsilon_i,\qquad i\in[n],\tag{1}
\]</span> で定義されるモデルは，<span class="citation" data-cites="Chung+2013">(<a href="#ref-Chung+2013" role="doc-biblioref">Chung et al., 2013</a>)</span> によると次のような複数の名前を持つ：</p>
<ul>
<li>線型混合モデル (linear mixed models) <span class="citation" data-cites="Kincaid2005">(<a href="#ref-Kincaid2005" role="doc-biblioref">Kincaid, 2005</a>)</span></li>
<li>階層モデル (hierarchical models)</li>
<li>マルチレベル線型モデル (multilevel linear models)</li>
<li>混合効果モデル (mixed-effects models) <span class="citation" data-cites="Chung+2015">(<a href="#ref-Chung+2015" role="doc-biblioref">Chung et al., 2015</a>)</span></li>
<li>ランダム効果モデル (random effects model) <span class="citation" data-cites="Hubbard+2010">(<a href="#ref-Hubbard+2010" role="doc-biblioref">Hubbard et al., 2010</a>)</span> や <span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007</a>)</span>．</li>
<li>分散成分モデル (variance component model)<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a></li>
</ul>
</div>
</div>
</section>
<section id="sec-GEE" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="sec-GEE"><span class="header-section-number">2.6</span> GEE との違い</h3>
<p><strong>一般化推定方程式</strong> (GEE: Generalized Estimating Equation) では，ランダム効果モデルにおける階層的な議論を全て「局外母数」として捨象し，母数 <span class="math inline">\(\beta\)</span> の推定に集中する見方をする．</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="GEE との違い">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
GEE との違い
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><u>回帰式が違う</u></p>
<p>線型の場合の GEE は <span class="math display">\[
   Y_{it}=\alpha+\beta_1x_{1,i,t}+\cdots+\beta_px_{p,i,t}
   \]</span> とも表され，ランダムな切片項というものは見当たらない．その代わり，グループ間の影響は相関係数行列としてモデル化を行う．ランダム効果モデルでは，この相関構造をランダムな切片項を追加することで表現し，回帰式を複数立てることでモデルを表現する．</p></li>
<li><p><u>推定目標が違う</u></p>
<p>GEE は population average model でよく用いられる <span class="citation" data-cites="Hubbard+2010">(<a href="#ref-Hubbard+2010" role="doc-biblioref">Hubbard et al., 2010</a>)</span> ように，あくまで応答 <span class="math inline">\(Y_{it}\)</span> の平均の不偏推定が目標であり，共分散構造はいわば局外母数である．一方，混合効果モデルは，その階層モデルとしての性質の通り，平均構造と分散構造のいずれも推定対象として扱う志向性がある．</p></li>
<li><p><u>推定方法が違う</u></p>
<p>混合効果モデルは主に最尤法により推定される <span class="citation" data-cites="Hubbard+2010">(<a href="#ref-Hubbard+2010" role="doc-biblioref">Hubbard et al., 2010</a>)</span>．GEE はモーメント法により推定され，最尤法ベースではないため，完全にランダムとは言えない欠測がある場合は弱く，欠測データに対しては IPW などの方法が用いられる．</p></li>
</ol>
</div>
</div>
<p>GEE にとって相関構造は局外母数であり，正確な特定は目的に含まれない．この意味で GEE の相関係数⾏列におく仮定は「間違えていてもよい便宜的な仮定」であるため，<strong>作業相関係数行列</strong> (working correlation coefficient matrix) とも呼ばれる．相関構造を誤特定していても，平均構造は一致推定が可能であり，ロバストである．両方の特定に成功した場合はセミパラメトリック有効性が達成される．</p>
<p>一方で混合効果モデルは，階層モデルとして平均構造と分散構造のいずれにも明示的な仮定をおくため，片方（例えば共分散構造）の特定を間違えていた場合，もう片方の解釈性が失われる，というリスクがあると論じることができる．特に <span class="citation" data-cites="Hubbard+2010">(<a href="#ref-Hubbard+2010" role="doc-biblioref">Hubbard et al., 2010</a>)</span> に見られる論調である．</p>
<p>しかし小地域推定や，「子供の身長の成長曲線の描画」が主な研究目的である場合など，ユニットの平均効果ではなく個別効果に注目したい場合には混合効果モデルの方が適していることになる <span class="citation" data-cites="Gardiner+2009">(<a href="#ref-Gardiner+2009" role="doc-biblioref">Gardiner et al., 2009</a>)</span>．実際，モデルの特定に成功していれば，いずれのパラメータも最尤推定されるため，一致性を持つ．</p>
<p>従って，モデル選択において用いられる基準も違う．GEE における作業相関係数行列と説明変数の選択には QIC (Quasi-likelihood Information Criterion) が，混合効果モデルには AIC や BIC （または cAIC や mAIC <span class="citation" data-cites="Vaida-Blanchard2005">(<a href="#ref-Vaida-Blanchard2005" role="doc-biblioref">Vaida and Blanchard, 2005</a>)</span>）が用いられる <span class="citation" data-cites="Gardiner+2009">(<a href="#ref-Gardiner+2009" role="doc-biblioref">Gardiner et al., 2009, p. 228</a>)</span>．</p>
<!--

本データを扱った論文 [@Thall-Vail1990] では，[@Liang-Zeger1986] の一般化推定方程式の枠組みに則り，共分散の構造にどのようなパラメトリック分布を仮定するのが良いかが，漸近論の観点から議論されている．

-->
</section>
<section id="ベイズ混合効果モデルという光" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="ベイズ混合効果モデルという光"><span class="header-section-number">2.7</span> ベイズ混合効果モデルという光……？</h3>
<p>しかし，結局ベイズ統計学の立場からは，２つの違いはほとんど重要ではなく，混合効果モデルを推定した後に，周辺化をして平均構造に関する marginal estimator を構成すれば，GEE の代用になっているのではないか？</p>
<p>計算機の性能と，計算統計手法の発展が目まぐるしい現代にて，過去の議論を踏襲しすぎることは，問題の本質を誤るということもあるのだろう．</p>
<p>ということで，以上議論したグループレベル構造を持ったデータに対する２階の階層モデルを，本稿では「混合効果モデル」と呼ぶことにする．</p>
<p>この節はこれで終わり．</p>
</section>
</section>
<section id="混合効果モデリングのテクニック集" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="混合効果モデリングのテクニック集"><span class="header-section-number">3</span> 混合効果モデリングのテクニック集</h2>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="概要">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
概要
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>混合効果モデルの推定において，グループレベル変動 <span class="math inline">\(\alpha_{s[i]}\)</span> の共分散行列 <span class="math inline">\(\mathrm{V}[\eta_s]\)</span> の推定が不安定になり得る．特に，グループ数 <span class="math inline">\(S\)</span> が小さい場合に顕著である．</li>
<li>カウントデータの Poisson モデルでは，「観測レベルのランダム効果」を追加することで，実質的に Poisson-対数正規混合モデリングを実行できる．</li>
</ul>
</div>
</div>
<section id="sec-group-level-variance-estimation" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="sec-group-level-variance-estimation"><span class="header-section-number">3.1</span> グループレベル分散の推定</h3>
<section id="問題" class="level4" data-number="3.1.1">
<h4 data-number="3.1.1" class="anchored" data-anchor-id="問題"><span class="header-section-number">3.1.1</span> 問題</h4>
<p>混合効果モデル（階層モデル） <span class="math display">\[
y_i=\alpha_{s[i]}+\beta x_i+\epsilon_i,\qquad i\in[n],\tag{1}
\]</span> の推定において，特にグループ数 <span class="math inline">\(S\)</span> が小さい場合，グループレベルの変動切片項 <span class="math inline">\(\alpha_{s[i]}\)</span> の共分散行列 <span class="math inline">\(\mathrm{V}[\eta_s]\)</span> の推定が不安定になったり，分散が負の値をとったりするという問題点が古くからある <span class="citation" data-cites="Harville1977">(<a href="#ref-Harville1977" role="doc-biblioref">Harville, 1977</a>)</span>．<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a></p>
<p>変量効果 <span class="math inline">\(\eta_s\)</span> を <span class="math inline">\(\eta_s\overset{\text{iid}}{\sim}(0,\sigma^2_s)\)</span>，誤差を <span class="math inline">\(\epsilon_i\overset{\text{iid}}{\sim}(0,\sigma^2_e)\)</span> とすると，この <span class="math inline">\(\mathrm{V}[\eta_s]\)</span> は次の形をもち，グループ間の相関構造のモデリングを一手に引き受けている： <span class="math display">\[
\mathrm{V}[\eta_{s}]=\sigma^2_sJ_{n_s}+\sigma_e^2I_{n_s},\qquad J_{n_s}:=\boldsymbol{1}_{n_s}\boldsymbol{1}_{n_s}^\top.
\]</span></p>
<p>EM アルゴリズムが提案されたばかりの頃 <span class="citation" data-cites="Laird-Ware1982">(<a href="#ref-Laird-Ware1982" role="doc-biblioref">Laird and Ware, 1982</a>)</span> では，共分散構造にパラメトリックな仮定をおいていたが，現代ではこれを取り去った最尤推定法・ベイズ推定法が主流である．</p>
</section>
<section id="退化しない共分散行列推定" class="level4" data-number="3.1.2">
<h4 data-number="3.1.2" class="anchored" data-anchor-id="退化しない共分散行列推定"><span class="header-section-number">3.1.2</span> 退化しない共分散行列推定</h4>
<p>しかし，最尤推定法と，一定の事前分布を仮定したベイズ MAP 推定法では，推定された共分散行列が退化してしまったり，分散が負の値を取ってしまうことがある．</p>
<p>打ち切り推定量 <span class="citation" data-cites="Kubokawa-Srivastava1999">(<a href="#ref-Kubokawa-Srivastava1999" role="doc-biblioref">T. Kubokawa and Srivastava, 1999</a>)</span>, <span class="citation" data-cites="Kubokawa2000">(<a href="#ref-Kubokawa2000" role="doc-biblioref">Tatsuya Kubokawa, 2000</a>)</span> なども提案されているが，ベイズでは Wishart 事前分布を仮定することでこれが回避される <span class="citation" data-cites="Chung+2015">(<a href="#ref-Chung+2015" role="doc-biblioref">Chung et al., 2015</a>)</span>．<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a> これは最尤法の文脈では，penalized likelihood と等価になる <span class="citation" data-cites="Chung+2013">(<a href="#ref-Chung+2013" role="doc-biblioref">Chung et al., 2013</a>)</span>．</p>
<p>モデルのサイズによっては，完全なベイズ推定を実行することが難しく，一部は等価な頻度論的な方法や近似を用いることもある．その際，最適化ソルバーの収束を速めるために，共分散構造に（データや計画とは無関係に）パラメトリックモデルを仮定してしまうこともある <span class="citation" data-cites="Kincaid2005">(<a href="#ref-Kincaid2005" role="doc-biblioref">Kincaid, 2005</a>)</span>．</p>
</section>
</section>
<section id="sec-shrinkage-estimation" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="sec-shrinkage-estimation"><span class="header-section-number">3.2</span> 係数の縮小推定</h3>
<p>分散 <span class="math inline">\(\mathrm{V}[\eta_s]\)</span> を推定して分散比 <span class="math inline">\(\rho:=\sigma_v^2/\sigma_e^2\)</span> の推定量 <span class="math inline">\(\widehat{\rho}\)</span> を得て，これを最良線型不偏推定量 (BLUE) <span class="math inline">\(\widehat{\beta}\)</span> に代入して得られる，グループごとの <span class="math inline">\(y_s\)</span> の推定量に <span class="math display">\[
\widehat{y}_s:=\frac{\widehat{\rho}n_s}{1+\widehat{\rho}n_s}\overline{y}_s+\frac{1}{1+\widehat{\rho}n_s}\overline{x}_s^\top\widetilde{\beta}(\widehat{\rho})
\]</span> というものがあり，これを <strong>経験 BLUE</strong> という <span class="citation" data-cites="久保川達也2006">(<a href="#ref-久保川達也2006" role="doc-biblioref">久保川達也, 2006, p. 143</a>)</span>．</p>
<p>これは，各グループ <span class="math inline">\(s\in[S]\)</span> における値 <span class="math inline">\(y_s\)</span> を，単なる経験平均 <span class="math inline">\(\overline{y}_s\)</span> ではなく，全データプールから得られる推定量 <span class="math inline">\(\overline{x}_s^\top\widetilde{\beta}(\widehat{\rho})\)</span> で補正した推定量になっている．</p>
<p>このことにより，各グループ <span class="math inline">\(s\in[S]\)</span> のデータ数が少なく，経験平均 <span class="math inline">\(\overline{y}_s\)</span> では分散が大きくなってしまう場合でも，安定した推定量を得ることができる．</p>
<p>縮小推定は小地域推定 <span class="citation" data-cites="Battese+1988">(<a href="#ref-Battese+1988" role="doc-biblioref">George E. Battese and Fuller, 1988</a>)</span> に応用を持つ．例えば <span class="math inline">\(s\in[S]\)</span> をアメリカ合衆国の各州とし，投票行動のデータに応用した例が <span class="citation" data-cites="Gelman2014">(<a href="#ref-Gelman2014" role="doc-biblioref">Gelman, 2014</a>)</span> にある．</p>
<p>このように，変量効果 <span class="math inline">\(\alpha_{s[i]}\)</span> を追加したモデリングを実行することにより，グループごとの被説明変数を縮小推定することができる．</p>
<section id="sec-empirical-bayes" class="level4" data-number="3.2.1">
<h4 data-number="3.2.1" class="anchored" data-anchor-id="sec-empirical-bayes"><span class="header-section-number">3.2.1</span> 経験ベイズ</h4>
<p>縮小推定の効用は初め，経験ベイズの枠組みで説明された．</p>
<blockquote class="blockquote">
<p>以上の考え方は，経験ベイズの枠組みで <span class="citation" data-cites="Efron-Morris1975">(<a href="#ref-Efron-Morris1975" role="doc-biblioref">Efron and Morris, 1975</a>)</span> の一連の論文の中で示されてきたものであり，ベイズ的アプローチの現実的な有用性は基本的には上述の考え方に基づいている．</p>
</blockquote>
<p>そもそも１元配置混合線型モデルは <span class="math display">\[
y_{ij}=\theta_{ij}+e_{ij},\qquad \theta_{ij}=x_{ij}^\top\beta+v_i
\]</span> とも理解できる．これは階層モデル <span class="math display">\[
y_{ij}\sim\mathrm{N}(\theta_{ij},\sigma^2_e),\qquad\theta_{ij}\sim\mathrm{N}(x_{ij}^\top\beta,\sigma_v^2)
\]</span> とも見れる．</p>
<p><span class="math inline">\(\beta,\sigma^2_v,\sigma^2_e\)</span> を未知母数として扱った場合を <strong>経験ベイズモデル</strong>，変量として扱って更なる分布を仮定した場合を（狭義の） <strong>階層ベイズ</strong> ともいう <span class="citation" data-cites="久保川達也2006">(<a href="#ref-久保川達也2006" role="doc-biblioref">久保川達也, 2006, p. 155</a>)</span>．</p>
</section>
</section>
<section id="sec-subsec-count-data" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="sec-subsec-count-data"><span class="header-section-number">3.3</span> カウントデータ過分散へのお手軽対処法</h3>
<p>これはカウントデータのモデリング限定のテクニックである．</p>
<p>カウントデータも，一般化線型（混合）モデルの範疇で扱うことができるため，リンク関数 <span class="math inline">\(g\)</span> を通じてほとんど同等の扱いが可能である．</p>
<section id="負の二項分布によるモデリング" class="level4" data-number="3.3.1">
<h4 data-number="3.3.1" class="anchored"><span class="header-section-number">3.3.1</span> 負の二項分布によるモデリング</h4>
<p>カウントデータの基本は Poisson 分布であろうが，過分散を考慮するために，負の二項分布でモデリングすることもできる．負の二項分布は例えばマーケティングにおいて，顧客の購買回数をモデル化する際に用いられる <span class="citation" data-cites="森岡-今西16-確率思考の戦略論">(<a href="#ref-森岡-今西16-確率思考の戦略論" role="doc-biblioref">森岡毅，今西聖貴, 2016</a>)</span>．</p>
<p>この行為は，Poisson 分布の Gamma 分布による混合分布族を用いた，混合モデリングを行っているとみなせる：</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="命題">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
命題
</div>
</div>
<div class="callout-body-container callout-body">
<p>Poisson 分布 <span class="math inline">\(\mathrm{Pois}(\theta)\)</span> の <span class="math inline">\(\mathrm{Gamma}(\alpha,\nu)\)</span>-混合は負の二項分布 <span class="math inline">\(\mathrm{NB}\left(\nu,\frac{\alpha}{\alpha+1}\right)\)</span> になる．</p>
<p>ただし，負の二項分布 <span class="math inline">\(\mathrm{NB}(\nu,p)\)</span> は，次の確率質量関数 <span class="math inline">\(p(x;\nu,p)\)</span> が定める <span class="math inline">\(\mathbb{N}\)</span> 上の確率分布である： <span class="math display">\[
p(x;\nu,p)=\begin{pmatrix}x+\nu-1\\x\end{pmatrix}p^\nu(1-p)^x.
\]</span></p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled" title="証明">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
証明
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>確率分布の変換則より，次のように計算できる：</p>
<p><span class="math display">\[\begin{align*}
  p(x)&amp;=\int_{\mathbb{R}_+}\frac{\theta^x}{x!}e^{-\theta}\frac{1}{\Gamma(\nu)}\alpha^\nu\theta^{\nu-1}e^{-\alpha\theta}d\theta\\
  &amp;=\frac{\alpha^\nu}{x!\Gamma(\nu)}\int_{\mathbb{R}_+}\theta^{x+\nu-1}e^{-(\alpha+1)\theta}d\theta\\
  &amp;=\frac{\alpha^\nu}{x!\Gamma(\nu)}\frac{\Gamma(x+\nu)}{(\alpha+1)^{x+\nu}}\\
  &amp;=\begin{pmatrix}\nu+x-1\\x\end{pmatrix}\left(\frac{1}{\alpha+1}\right)^x\left(\frac{\alpha}{\alpha+1}\right)^\nu.
\end{align*}\]</span></p>
<p>この最右辺は，たしかに負の二項分布の質量関数である．</p>
<p>この証明方法と，Gamma 分布については次の記事を参照：</p>
<div class="article-card-container">
  <div class="article-card">
    <a href="https://162348.github.io/posts/2023/Probability/Beta-Gamma.html" target="_blank">
      <img src="https://162348.github.io/posts/2023/Probability/Beta-Gamma_files/figure-html/cell-4-output-1.png" alt="Article Image" class="article-image">
      <div class="article-content">
        <h3 class="article-title anchored" data-anchor-id="負の二項分布によるモデリング">確率測度の変換則</h3>
        <p class="article-description">Gamma 分布とBeta 分布を例に</p>
      </div>
    </a>
  </div>
</div>
</div>
</div>
</div>
<p>これは <span class="math display">\[
y_{it}\sim\mathrm{Pois}(\theta)
\]</span> <span class="math display">\[
\theta\sim\mathrm{Gamma}(\alpha,\nu)
\]</span> という Gamma 分布を仮定した経験ベイズモデル（第 <a href="#sec-empirical-bayes" class="quarto-xref">3.2.1</a> 節）に当たる．</p>
<p>Gamma 分布は Poisson 分布の共役事前分布であるため計算が容易であり，早くから質病地図の作成などにも用いられていた <span class="citation" data-cites="Clayton-Kaldor1987">(<a href="#ref-Clayton-Kaldor1987" role="doc-biblioref">Clayton and Kaldor, 1987</a>)</span>, <span class="citation" data-cites="丹後俊郎1988">(<a href="#ref-丹後俊郎1988" role="doc-biblioref">丹後俊郎, 1988</a>)</span>．</p>
</section>
<section id="poisson-対数正規混合によるモデリング" class="level4" data-number="3.3.2">
<h4 data-number="3.3.2" class="anchored" data-anchor-id="poisson-対数正規混合によるモデリング"><span class="header-section-number">3.3.2</span> Poisson-対数正規混合によるモデリング</h4>
<p>Poisson 回帰</p>
<p><span class="math display">\[
\begin{align*} y_{it} &amp; \sim \operatorname{Pois}(\lambda_{s[i]}) \\ \log(\lambda_{s[i]}) &amp; = \alpha_i + \eta_{it} \\ \eta_{it} &amp; \sim \operatorname{N}(0, \sigma). \end{align*}
\]</span></p>
<p>を考えると，各 <span class="math inline">\(y_{it}\)</span> を，（グループ毎に条件付ければ）Poisson 分布の対数正規分布による混合分布を用いてモデル化していることにあたる．</p>
<p>この，Poisson-対数正規分布族は，<span class="citation" data-cites="Bulmer1974">(<a href="#ref-Bulmer1974" role="doc-biblioref">Bulmer, 1974</a>)</span> により生物種の個体数分布のモデリングで，過分散を説明するために用いられている．</p>
<p>すなわち，第 <a href="#sec-example" class="quarto-xref">1.1</a> 節のモデルの比較 <a href="#sec-model-comparison" class="quarto-xref">1.4</a> で扱った，<strong>観測レベルランダム効果</strong> (OLRE: Observation-level Random Effects) の方法は，<u>観測毎に <span class="math inline">\(\eta_{it}\)</span> というランダム切片項を追加するだけで，本質的には Poisson-対数正規混合モデリングを実施する</u> という，いわばハックのような使い方である．<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a></p>
<p>今回はモデル比較の結果が良かったため，本格的に対数正規混合を実施してみるのも良いかもしれない．</p>
</section>
</section>
<section id="変量係数モデルによる非線型モデリング" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="変量係数モデルによる非線型モデリング"><span class="header-section-number">3.4</span> 変量係数モデルによる非線型モデリング</h3>
<div class="callout callout-style-simple callout-caution no-icon callout-titled" title="混合モデルの種々の拡張">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
混合モデルの種々の拡張
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>前節 <a href="#sec-subsec-count-data" class="quarto-xref">3.3</a> では，カウントデータに適用するための一般化線型混合モデルをみた．</p>
<p><span class="citation" data-cites="久保川達也2006">(<a href="#ref-久保川達也2006" role="doc-biblioref">久保川達也, 2006</a>)</span> では，ここまで考慮した１元配置混合線型モデルの拡張をいくつか紹介している：</p>
<ul>
<li>各グループ <span class="math inline">\(s\in[S]\)</span> の中でもいくつかのクラスターに分けられる場合，<strong>２元配置混合モデル</strong> が考えられる： <span class="math display">\[
y_{ijk}=x_{ijk}^\top\beta+v_i+u_{ij}+e_{ijk}.
\]</span></li>
<li>誤差分散が一定であるという仮定が怪しい場合，<strong>変動分散モデル</strong> が考えられる．これは，グループ内の分散を <span class="math inline">\(e_{ij}|\sigma_i^2\sim\mathrm{N}(0,\sigma_i^2)\)</span> とし，<span class="math inline">\(\sigma_i\)</span> をグループ内で同一の分布に従う i.i.d. と仮定した階層モデルをいう．</li>
<li>係数 <span class="math inline">\(\beta\)</span> にもモデルを仮定した階層モデルは <strong>変量係数モデル</strong> ともいう： <span class="math display">\[
\beta_i=W_i\alpha+v_i.
\]</span> 州ごとの，収入因子が投票行動に与える影響の差を突き止めた <span class="citation" data-cites="Gelman2014">(<a href="#ref-Gelman2014" role="doc-biblioref">Gelman, 2014</a>)</span> ではこの変量係数モデルを用いている．</li>
</ul>
</div>
</div>
</div>
<section id="例投票行動の州ごとの違い" class="level4" data-number="3.4.1">
<h4 data-number="3.4.1" class="anchored" data-anchor-id="例投票行動の州ごとの違い"><span class="header-section-number">3.4.1</span> 例：投票行動の州ごとの違い</h4>
<p><span class="citation" data-cites="Gelman2014">(<a href="#ref-Gelman2014" role="doc-biblioref">Gelman, 2014</a>)</span> では州ごとの投票行動の違いを説明するために，まずは次のロジスティック混合モデルを考えている： <span class="math display">\[
\operatorname{Pr}(y_i=1)=\operatorname{logit}^{-1}(\alpha_{s[i]}+x_i\beta)
\]</span> <span class="math display">\[
\alpha_s=W_s^\top\gamma+\epsilon_s,\qquad\epsilon_s\overset{\text{iid}}{\sim}\mathrm{N}(0,\sigma^2_\alpha).
\]</span></p>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="各変数の説明">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
各変数の説明
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><span class="math inline">\(y_i\in\{0,1\}\)</span> は共和党に投票したか，民主党に投票したかを表す２値変数．</li>
<li><span class="math inline">\(x_i\in\{\pm2,\pm1,0\}\)</span> は収入のレベルを５段階で表す離散変数．</li>
<li><span class="math inline">\(W_j\)</span> は各州の共変量のベクトル．</li>
</ul>
</div>
</div>
</div>
<p>しかしこのままではモデルの当てはまりが良くなかった．これは州ごとに収入が投票に与える影響が異なるためであった．これを考慮するために，<span class="citation" data-cites="Gelman2014">(<a href="#ref-Gelman2014" role="doc-biblioref">Gelman, 2014</a>)</span> は変量係数モデルを用いた．</p>
</section>
<section id="混合モデルの変量係数モデル化" class="level4" data-number="3.4.2">
<h4 data-number="3.4.2" class="anchored" data-anchor-id="混合モデルの変量係数モデル化"><span class="header-section-number">3.4.2</span> 混合モデルの変量係数モデル化</h4>
<p><span class="math inline">\(\beta\)</span> を州ごとに変化させ，これに <span class="math display">\[
\beta_s=W_s^\top\gamma'+\epsilon'_s,\qquad \epsilon'_s\overset{\text{iid}}{\sim}\mathrm{N}(0,\sigma^2_\beta),
\]</span> というモデルをおく．これにより，州ごとに変化する収入-投票関係をモデリングできる．</p>
</section>
<section id="非線型モデル化" class="level4" data-number="3.4.3">
<h4 data-number="3.4.3" class="anchored" data-anchor-id="非線型モデル化"><span class="header-section-number">3.4.3</span> 非線型モデル化</h4>
<p>これに加えて，<span class="math inline">\(\beta_s\)</span> を収入カテゴリのアイテム <span class="math inline">\(x_i\in\{\pm2,\pm1,0\}\)</span> ごとに変化させることも考えられる．</p>
<p>これは値も持つダミー変数 <span class="math display">\[
\boldsymbol{x}_i^j=(j-3)1_{\left\{x_i=j\right\}},\qquad j\in\{1,2,3,4,5\},
\]</span> を成分にもつ <span class="math inline">\(\boldsymbol{x}_i\in\mathbb{Z}^5\)</span> を用いて， <span class="math display">\[
\operatorname{Pr}(y_i=1)=\operatorname{logit}^{-1}(\alpha_{s[i]}+\boldsymbol{x}_i^\top\boldsymbol{\beta}_s)
\]</span></p>
<p>というモデルを考えることにあたる．</p>
</section>
</section>
</section>
<section id="brmsの実装" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="brmsの実装"><span class="header-section-number">4</span> <code>brms</code>の実装</h2>
<p><a href="https://paul-buerkner.github.io/brms/reference/brm.html"><code>brm</code> 関数</a>（コードは <a href="https://github.com/paul-buerkner/brms/blob/master/R/brm.R">こちら</a>）の実装を調べる．</p>
<div class="callout callout-style-simple callout-important no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li><a href="https://github.com/paul-buerkner/brms/blob/master/R/brm.R#L436"><code>brms</code></a></li>
</ul>
<p>Stan コードを扱っている関数は <a href="https://github.com/paul-buerkner/brms/blob/d42adcd22f5af441870038b1d78ad4d9408f344f/R/stancode.R"><code>.stancode()</code></a> であった．最終的に，<a href="https://github.com/paul-buerkner/brms/blob/d42adcd22f5af441870038b1d78ad4d9408f344f/R/backends.R#L67"><code>.compile_model_rstan()</code></a> と <a href="https://github.com/paul-buerkner/brms/blob/d42adcd22f5af441870038b1d78ad4d9408f344f/R/backends.R#L145"><code>.fit_model_rstan()</code></a> が呼ばれるようになっている．</p>
<ul>
<li><a href="https://github.com/paul-buerkner/brms/blob/d42adcd22f5af441870038b1d78ad4d9408f344f/R/standata.R#L109"><code>.standata</code></a></li>
</ul>
</div>
</div>
</div>
<section id="事前分布" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="事前分布"><span class="header-section-number">4.1</span> 事前分布</h3>
<p><a href="https://paul-buerkner.github.io/brms/reference/brm.html"><code>brm</code>関数</a> では，デフォルトでは無情報事前分布が用いられる．</p>
<blockquote class="blockquote">
<p>Default priors are chosen to be non or very weakly informative so that their influence on the results will be negligible and you usually don’t have to worry about them. However, after getting more familiar with Bayesian statistics, I recommend you to start thinking about reasonable informative priors for your model parameters: Nearly always, there is at least some prior information available that can be used to improve your inference.<br><a href="https://paul-buerkner.github.io/brms/reference/brm.html">brm(): Fit Bayesian Generalized (Non-)Linear Multivariate Multilevel Models</a></p>
</blockquote>
</section>
<section id="回帰式" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="回帰式"><span class="header-section-number">4.2</span> 回帰式</h3>
<p><code>brm()</code>関数の第一引数は，<code>validate_formula</code>関数に渡される．</p>
<p>この関数は S3 のメソッドのディスパッチを用いて実装されており，<code>brmsformula</code>オブジェクトに対しては，<code>validate_formula.brmsformula</code>関数が呼び出される．</p>
<p>ここでは<code>autocor</code>引数が引かれている場合，出力の<code>formula</code>属性に追加される：<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fit3<span class="sc">$</span>formula</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>count ~ zAge + zBase * Trt + (1 | patient) 
autocor ~ unstr(time = visit, gr = patient)</code></pre>
</div>
</div>
<p>なお，<code>brmsformula</code>オブジェクトのコンストラクタは <a href="http://paul-buerkner.github.io/brms/reference/brmsformula.html"><code>brmsformula()</code>関数</a> である．これは，R の<code>formula</code>オブジェクトを通じて，階層モデルを定義できるようになっている（実装は<a href="R3.qmd">リスト</a>）．</p>
</section>
<section id="sec-ubsubsec-covariance-structure" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="sec-ubsubsec-covariance-structure"><span class="header-section-number">4.3</span> 共分散構造</h3>
<p>共分散構造は２つの観点から，<code>brmsformula</code>オブジェクトから自動的に指定される．</p>
<p>１つ目がグルーピング構造（共分散行列のブロック構造）であり，これは<a href="https://paul-buerkner.github.io/brms/reference/gr.html"><code>gr</code>関数</a> が使用される．</p>
<p>２つ目がグループ内の相関構造であり，これは<code>brm()</code>関数の<code>autocor</code>引数を用いる．</p>
<section id="gr関数" class="level4" data-number="4.3.1">
<h4 data-number="4.3.1" class="anchored" data-anchor-id="gr関数"><span class="header-section-number">4.3.1</span> <code>gr</code>関数</h4>
<p>この関数は<code>brm</code>関数の第一引数として与えられたモデル定義式から，暗黙のうちに内部で呼び出される．</p>
<p>例えば，回帰式に<code>(1|patient)</code>が含まれていた場合，<code>gr(patient)</code>が呼び出される．</p>
<p>共分散構造におく仮定について，重要なデフォルト設定が２つある：</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li><p>グループ間の相関構造は想定されている：<code>cor=True</code>．</p>
<blockquote class="blockquote">
<p>If <code>TRUE</code> (the default), group-level terms will be modelled as correlated.<br><a href="https://paul-buerkner.github.io/brms/reference/gr.html">gr(): Set up basic grouping terms in brms</a></p>
</blockquote></li>
<li><p>一方で，グループ内の相関構造は想定されておらず，独立とされている．具体的に指定したい場合は引数<code>cov</code>を用いる．</p>
<blockquote class="blockquote">
<p>By default, levels of the same grouping factor are modeled as independent of each other.<br><a href="https://paul-buerkner.github.io/brms/reference/gr.html">gr(): Set up basic grouping terms in brms</a></p>
</blockquote></li>
</ul>
<p>すなわち，<span class="math inline">\(\mathrm{V}[\eta_s]\)</span> には一切仮定が置かれておらず（第 <a href="#sec-group-level-variance-estimation" class="quarto-xref">3.1</a> 節），一方で <span class="math inline">\(\{\epsilon_{it}\}_{t=1}^T\)</span> は互いに独立とされている．</p>
</div>
</div>
</div>
<p>また，この二階層目の分布族（第 <a href="#sec-RF" class="quarto-xref">2.1</a> 節での <span class="math inline">\(\alpha_i\)</span> と <span class="math inline">\(\eta_{it}\)</span>）は，分散共分散行列 <span class="math inline">\(\mathrm{V}[\eta_s]\)</span> を持った正規分布がデフォルトで，現状他の分布族は指定できないでいる．</p>
<blockquote class="blockquote">
<p>dist: Name of the distribution of the group-level effects. Currently “gaussian” is the only option.<br><a href="https://paul-buerkner.github.io/brms/reference/gr.html">gr(): Set up basic grouping terms in brms</a></p>
</blockquote>
</section>
<section id="sec-autocor-argument" class="level4" data-number="4.3.2">
<h4 data-number="4.3.2" class="anchored" data-anchor-id="sec-autocor-argument"><span class="header-section-number">4.3.2</span> <code>autocor</code>引数</h4>
<p><code>brm()</code>関数には，<a href="http://paul-buerkner.github.io/brms/reference/autocor-terms.html"><code>autocor</code>引数</a> が用意されている．</p>
<p><code>gr()</code>のデフォルト値では独立とされていたグループ内の相関構造を，具体的に指定するのに用いられる．</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ul>
<li><code>unstr</code>：一才の仮定を置かない．</li>
<li><code>AR</code>：一次の自己相関構造．</li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="推論エンジン" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="推論エンジン"><span class="header-section-number">4.4</span> 推論エンジン</h3>
<p><a href="https://paul-buerkner.github.io/brms/reference/brm.html"><code>brm</code>関数</a> は，Stan による MCMC サンプリングを通じて，事後分布を計算する．</p>
</section>
</section>




<div id="quarto-appendix" class="default"><section id="文献紹介" class="level2 appendix" data-number="5"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">5</span> 文献紹介</h2><div class="quarto-appendix-contents">

<p>ここでは計量経済学の呼称に従い，固定効果モデルと変量効果モデルと呼んだが，同じモデルを母数モデル (fixed effect model) と変量モデル (random effect model) と呼んだりもする <span class="citation" data-cites="足立浩平2000">(<a href="#ref-足立浩平2000" role="doc-biblioref">足立浩平, 2000</a>)</span>．</p>
</div></section><section id="acknowledgements" class="level2 appendix" data-number="6"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">6</span> Acknowledgements</h2><div class="quarto-appendix-contents">

<p>I would like to extend my gratitude to Robert Long, who kindly shared me the knowledge about the covariance structure implicitly defined via <code>brms</code> formula on <a href="https://stats.stackexchange.com/questions/649358/the-default-covariance-structure-implicitly-assumed-in-the-brms-formula/650015#650015">this Cross Validated post</a>. His insights were instrumental in enhancing this work.</p>



</div></section><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Bafumi-Gelman2007" class="csl-entry" role="listitem">
Bafumi, J., and Gelman, A. (2007). <a href="https://dx.doi.org/10.2139/ssrn.1010095"><span class="nocase">Fitting Multilevel Models When Predictors and Group Effects Correlate</span></a>. <em>SSRN</em>.
</div>
<div id="ref-Bulmer1974" class="csl-entry" role="listitem">
Bulmer, M. G. (1974). <a href="http://www.jstor.org/stable/2529621">On fitting the poisson lognormal distribution to species-abundance data</a>. <em>Biometrics</em>, <em>30</em>(1), 101–110.
</div>
<div id="ref-Burkner2017" class="csl-entry" role="listitem">
Bürkner, P.-C. (2017). <a href="https://doi.org/10.18637/jss.v080.i01">Brms: An r package for bayesian multilevel models using stan</a>. <em>Journal of Statistical Software</em>, <em>80</em>(1), 1–28.
</div>
<div id="ref-Burkner2018" class="csl-entry" role="listitem">
Bürkner, P.-C. (2018). <a href="https://doi.org/10.32614/RJ-2018-017"><span class="nocase">Advanced Bayesian Multilevel Modeling with the R Package brms</span></a>. <em><span>The R Journal</span></em>, <em>10</em>(1), 395–411.
</div>
<div id="ref-Burkner2021" class="csl-entry" role="listitem">
Bürkner, P.-C. (2021). <a href="https://doi.org/10.18637/jss.v100.i05">Bayesian item response modeling in r with brms and stan</a>. <em>Journal of Statistical Software</em>, <em>100</em>(5), 1–54.
</div>
<div id="ref-Chung+2015" class="csl-entry" role="listitem">
Chung, Y., Gelman, A., Rabe-Hesketh, S., Liu, J., and Dorie, V. (2015). <a href="https://doi.org/10.3102/1076998615570945">Weakly informative prior for point estimation of covariance matrices in hierarchical models</a>. <em>Journal of Educational and Behavioral Statistics</em>, <em>40</em>(2), 136–157.
</div>
<div id="ref-Chung+2013" class="csl-entry" role="listitem">
Chung, Y., Rabe-Hesketh, S., Dorie, V., Gelman, A., and Liu, J. (2013). <a href="https://doi.org/10.1007/s11336-013-9328-2">A nondegenerate penalized likelihood estimator for variance parameters in multilevel models</a>. <em>Psychometrika</em>, <em>78</em>(4), 685–709.
</div>
<div id="ref-Clayton-Kaldor1987" class="csl-entry" role="listitem">
Clayton, D., and Kaldor, J. (1987). <a href="http://www.jstor.org/stable/2532003">Empirical bayes estimates of age-standardized relative risks for use in disease mapping</a>. <em>Biometrics</em>, <em>43</em>(3), 671–681.
</div>
<div id="ref-Cunningham21-Mixtape" class="csl-entry" role="listitem">
Cunningham, S. (2021). <em>Causal inference : The mixtape</em>. Yale University Press.
</div>
<div id="ref-Efron-Morris1975" class="csl-entry" role="listitem">
Efron, B., and Morris, C. (1975). <a href="http://www.jstor.org/stable/2285814">Data analysis using stein’s estimator and its generalizations</a>. <em>Journal of the American Statistical Association</em>, <em>70</em>(350), 311–319.
</div>
<div id="ref-Gardiner+2009" class="csl-entry" role="listitem">
Gardiner, J. C., Luo, Z., and Roman, L. A. (2009). <a href="https://doi.org/10.1002/sim.3478">Fixed effects, random effects and GEE: What are the differences?</a> <em>Statistics in Medicine</em>, <em>28</em>(2), 221–239.
</div>
<div id="ref-Gelman2014" class="csl-entry" role="listitem">
Gelman, A. (2014). <a href="https://doi.org/10.1214/13-STS458"><span class="nocase">How Bayesian Analysis Cracked the Red-State, Blue-State Problem</span></a>. <em>Statistical Science</em>, <em>29</em>(1), 26–35.
</div>
<div id="ref-Battese+1988" class="csl-entry" role="listitem">
George E. Battese, R. M. H., and Fuller, W. A. (1988). <a href="https://doi.org/10.1080/01621459.1988.10478561">An error-components model for prediction of county crop areas using survey and satellite data</a>. <em>Journal of the American Statistical Association</em>, <em>83</em>(401), 28–36.
</div>
<div id="ref-Hansen2022" class="csl-entry" role="listitem">
Hansen, B. E. (2022). <em>Econometrics</em>. Princeton University Press.
</div>
<div id="ref-Harville1977" class="csl-entry" role="listitem">
Harville, D. A. (1977). <a href="https://doi.org/10.1080/01621459.1977.10480998">Maximum likelihood approaches to variance component estimation and to related problems</a>. <em>Journal of the American Statistical Association</em>, <em>72</em>(358), 320–338.
</div>
<div id="ref-Hubbard+2010" class="csl-entry" role="listitem">
Hubbard, A. E., Ahern, J., Fleischer, N. L., Laan, M. V. der, Lippman, S. A., Jewell, N., … Satariano, W. A. (2010). <a href="https://journals.lww.com/epidem/fulltext/2010/07000/to_gee_or_not_to_gee__comparing_population_average.7.aspx">To GEE or not to GEE: Comparing population average and mixed models for estimating the associations between neighborhood risk factors and health</a>. <em>Epidemiology</em>, <em>21</em>(4).
</div>
<div id="ref-Kincaid2005" class="csl-entry" role="listitem">
Kincaid, C. D. (2005). <a href="https://support.sas.com/resources/papers/proceedings/proceedings/sugi30/198-30.pdf"><span class="nocase">Guidelines for Selecting the Covariance Structure in Mixed Model Analysis</span></a>. In <em>SAS user group international</em>,Vol. 30, pages 198–30.
</div>
<div id="ref-Kubokawa2000" class="csl-entry" role="listitem">
Kubokawa, Tatsuya. (2000). <a href="https://doi.org/10.14490/jjss1995.30.143">ESTIMATION OF VARIANCE AND COVARIANCE COMPONENTS IN ELLIPTICALLY CONTOURED DISTRIBUTIONS</a>. <em>JOURNAL OF THE JAPAN STATISTICAL SOCIETY</em>, <em>30</em>(2), 143–176.
</div>
<div id="ref-Kubokawa-Srivastava1999" class="csl-entry" role="listitem">
Kubokawa, T., and Srivastava, M. S. (1999). <a href="https://doi.org/10.1214/aos/1017939248"><span class="nocase">Improved nonnegative estimation of multivariate components of variance</span></a>. <em>The Annals of Statistics</em>, <em>27</em>(6), 2008–2032.
</div>
<div id="ref-Laird-Ware1982" class="csl-entry" role="listitem">
Laird, N. M., and Ware, J. H. (1982). <a href="http://www.jstor.org/stable/2529876">Random-effects models for longitudinal data</a>. <em>Biometrics</em>, <em>38</em>(4), 963–974.
</div>
<div id="ref-Leppik+1987" class="csl-entry" role="listitem">
Leppik, I. E., Dreifuss, F. E., Porter, R., Bowman, T., Santilli, N., Jacobs, M., … Gutierrez, A. (1987). <a href="https://doi.org/10.1212/WNL.37.6.963">A controlled study of progabide in partial seizures</a>. <em>Neurology</em>, <em>37</em>(6), 963–963.
</div>
<div id="ref-Thall-Vail1990" class="csl-entry" role="listitem">
Thall, P. F., and Vail, S. C. (1990). <a href="http://www.jstor.org/stable/2532086">Some covariance models for longitudinal count data with overdispersion</a>. <em>Biometrics</em>, <em>46</em>(3), 657–671.
</div>
<div id="ref-Vaida-Blanchard2005" class="csl-entry" role="listitem">
Vaida, F., and Blanchard, S. (2005). <a href="http://www.jstor.org/stable/20441193">Conditional akaike information for mixed-effects models</a>. <em>Biometrika</em>, <em>92</em>(2), 351–370.
</div>
<div id="ref-Vehtari+2021" class="csl-entry" role="listitem">
Vehtari, A., Gelman, A., Simpson, D., Carpenter, B., and Bürkner, P.-C. (2021). <a href="https://doi.org/10.1214/20-BA1221"><span class="nocase">Rank-Normalization, Folding, and Localization: An Improved <span class="math inline">\(\widehat{R}\)</span> for Assessing Convergence of MCMC (with Discussion)</span></a>. <em>Bayesian Analysis</em>, <em>16</em>(2), 667–718.
</div>
<div id="ref-丹後俊郎1988" class="csl-entry" role="listitem">
丹後俊郎. (1988). <a href="https://doi.org/10.5023/jappstat.17.81">死亡指標の経験的ベイズ推定量について</a>. <em>応用統計学</em>, <em>17</em>(2), 81–96.
</div>
<div id="ref-久保川達也2006" class="csl-entry" role="listitem">
久保川達也. (2006). <a href="https://doi.org/10.5023/jappstat.35.139">線形混合モデルと小地域の推定</a>. <em>応用統計学</em>, <em>35</em>(3), 139–161.
</div>
<div id="ref-森岡-今西16-確率思考の戦略論" class="csl-entry" role="listitem">
森岡毅，今西聖貴. (2016). <em>確率思考の戦略論―ＵＳＪでも実証された数学マーケティングの力</em>. 角川書店.
</div>
<div id="ref-足立浩平2000" class="csl-entry" role="listitem">
足立浩平. (2000). <a href="https://doi.org/10.2333/jbhmk.27.12">計量多次元展開法の変量モデル</a>. <em>行動計量学</em>, <em>27</em>(1), 12–23.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>R を最新バージョン 4.3.1 → 4.4.0 にアップデートしなければインストールに失敗したことに注意．<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>通常は時間的に離れている観測は相関が薄いとしても，直近の観測と関連性が高いだろう．<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Statistical Modeling, Causal Inference, and Social Science における <a href="https://statmodeling.stat.columbia.edu/2024/05/08/bamdd/">こちらのエントリ</a> も参照．<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>すなわち，ある確率変数の従う項と考えており，<strong>変量効果</strong> とも呼ばれる．一方で未知母数とみなす場合は <strong>母数効果</strong> ともいう <span class="citation" data-cites="久保川達也2006">(<a href="#ref-久保川達也2006" role="doc-biblioref">久保川達也, 2006</a>)</span>．<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p><span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022, p. 333</a>)</span> 第12.3節，<span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007, p. 3</a>)</span>, <span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022, p. 604</a>)</span>，<span class="citation" data-cites="Gardiner+2009">(<a href="#ref-Gardiner+2009" role="doc-biblioref">Gardiner et al., 2009, p. 228</a>)</span>．<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p><span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007, p. 5</a>)</span> や <span class="citation" data-cites="久保川達也2006">(<a href="#ref-久保川達也2006" role="doc-biblioref">久保川達也, 2006, p. 141</a>)</span> も参照．<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p><span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007, p. 5</a>)</span>，<span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022, p. 609</a>)</span> 17.11節 など．狭義では，fixed effects model は within transformation を行い，グループ間の影響を引いたあとに回帰を実行する……という手続きを指すこともあるが，２つは等価な結果を生む．詳しくは <span class="citation" data-cites="Cunningham21-Mixtape">(<a href="#ref-Cunningham21-Mixtape" role="doc-biblioref">Cunningham, 2021</a>)</span> なども参照．<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p><span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022, p. 624</a>)</span> 17.25節．<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p><span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022, p. 624</a>)</span>，<span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007, p. 6</a>)</span>．<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p><span class="citation" data-cites="Bafumi-Gelman2007">(<a href="#ref-Bafumi-Gelman2007" role="doc-biblioref">Bafumi and Gelman, 2007, p. 6</a>)</span>．<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p><span class="citation" data-cites="Hubbard+2010">(<a href="#ref-Hubbard+2010" role="doc-biblioref">Hubbard et al., 2010</a>)</span> では両方の名前で呼んでいる．<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p><span class="citation" data-cites="Hansen2022">(<a href="#ref-Hansen2022" role="doc-biblioref">Hansen, 2022, p. 625</a>)</span> 17.25節．疫学・生物統計学では，実験計画法でしか「固定効果」「変量効果モデル」とは言わない，という認識であることも筆者は聞いたことがある．<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p><span class="math inline">\(\mathrm{V}[\eta_s]\)</span> はブロック行列の構造を持つためこう呼ばれる．<span class="citation" data-cites="久保川達也2006">(<a href="#ref-久保川達也2006" role="doc-biblioref">久保川達也, 2006, p. 141</a>)</span> でも LMM と併記されている．<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p><span class="citation" data-cites="Laird-Ware1982">(<a href="#ref-Laird-Ware1982" role="doc-biblioref">Laird and Ware, 1982</a>)</span>，<span class="citation" data-cites="Chung+2013">(<a href="#ref-Chung+2013" role="doc-biblioref">Chung et al., 2013</a>)</span>，<span class="citation" data-cites="Chung+2015">(<a href="#ref-Chung+2015" role="doc-biblioref">Chung et al., 2015</a>)</span>，<a href="https://statmodeling.stat.columbia.edu/2023/06/02/blme-bayesian-linear-mixed-effects-models/">Statistical Modeling, Causal Inference, and Social Science ブログ 6/2/2023</a>．<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>逆 Wishart ではないらしい <span class="citation" data-cites="Chung+2015">(<a href="#ref-Chung+2015" role="doc-biblioref">Chung et al., 2015</a>)</span>．<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p><a href="https://solomonkurz.netlify.app/blog/2021-07-12-got-overdispersion-try-observation-level-random-effects-with-the-poisson-lognormal-mixture/#negative-binomial-counts">Solomon Kurtz (2021)</a> による解説，<a href="https://rpubs.com/INBOstats/OLRE">RPubs</a> も参照．<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17"><p><a href="https://github.com/paul-buerkner/brms/blob/deb56d02d0f897422a4d1d5a43d18e99400f80a0/R/brmsformula.R#L1363">Line 1363</a>．<a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/162348\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          trigger: 'click',
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          positionFixed: true,
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="162348/162348.github.io" data-repo-id="R_kgDOKlfKYQ" data-category="Announcements" data-category-id="DIC_kwDOKlfKYc4CgDmb" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" data-loading="lazy" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://162348.github.io/">
<p>Hirofumi Shiba</p>
</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/162348/162348.github.io/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/ano2math5">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:shiba.hirofumi@ism.ac.jp">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../../../blog.xml">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>