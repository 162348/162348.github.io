<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="司馬博文">

<title>フローベース模型による条件付き生成 – Hirofumi Shiba</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../assets/Shiba2.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-90c2643ab6f776117e85fdd60cb25922.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-f42164379716b1d157629f80c17af3a6.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "?",
    "H"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-diffusion-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: ['listing-title','listing-image','listing-date','listing-subtitle',{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: ["listing-title","listing-author","listing-date","listing-image","listing-description"],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-diffusion-listing'] = new List('listing-diffusion-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-lst-embedding .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: ['listing-title','listing-image','listing-date','listing-subtitle',{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: ["listing-title","listing-author","listing-date","listing-image","listing-description"],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-lst-embedding'] = new List('listing-lst-embedding', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-36GX2G6GLL"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-36GX2G6GLL', { 'anonymize_ip': true});
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&amp;display=swap" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic&amp;display=swap" rel="stylesheet">

<style>
  h1, .title, .description, .subtitle {
    font-family: "Zen Kurenaido", sans-serif !important;
  }
</style>

<!-- <style>
  .menu-text {
      font-family: "Gill Sans", sans-serif !important;
      font-weight: 400;
      font-style: normal;
  }
  .navbar-title {
      font-family: "Gill Sans", sans-serif !important;
      font-weight: 400;
      font-style: normal;
  }
</style> -->

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../assets/styles.css">
<meta property="og:title" content="フローベース模型による条件付き生成 – Hirofumi Shiba">
<meta property="og:description" content="拡散模型は拡張性にも優れており，条件付けが容易である．現状は誘導付き拡散によってこれが実現されるが，連続的な条件付き生成のために，フローマッチングなる方法も提案された．">
<meta property="og:image" content="https://162348.github.io/posts/2024/Samplers/Files/RFDiff.gif">
<meta property="og:site_name" content="Hirofumi Shiba">
<meta name="twitter:title" content="フローベース模型による条件付き生成 – Hirofumi Shiba">
<meta name="twitter:description" content="拡散模型は拡張性にも優れており，条件付けが容易である．現状は誘導付き拡散によってこれが実現されるが，連続的な条件付き生成のために，フローマッチングなる方法も提案された．">
<meta name="twitter:image" content="https://162348.github.io/posts/2024/Samplers/Files/RFDiff.gif">
<meta name="twitter:creator" content="@ano2math5">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Hirofumi Shiba</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Notes</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-notes">    
        <li>
    <a class="dropdown-item" href="../../../static/English.html">
 <span class="dropdown-text">English Notes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../blog.html">
 <span class="dropdown-text">ノート (Japanese)</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Materials.html"> 
<span class="menu-text">Materials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Slides.html"> 
<span class="menu-text">Slides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/Software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../static/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/162348/162348.github.io/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">フローベース模型による条件付き生成</h1>
            <p class="subtitle lead">誘導からフローマッチングへ</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Deep</div>
                <div class="quarto-category">Sampling</div>
                <div class="quarto-category">P(X)</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>司馬博文 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">8/10/2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">10/12/2024</p>
      </div>
    </div>
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">概要</div>
      拡散模型は拡張性にも優れており，条件付けが容易である．現状は誘導付き拡散によってこれが実現されるが，連続的な条件付き生成のために，フローマッチングなる方法も提案された．
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#誘導" id="toc-誘導" class="nav-link active" data-scroll-target="#誘導"><span class="header-section-number">1</span> 誘導</a>
  <ul class="collapse">
  <li><a href="#はじめに" id="toc-はじめに" class="nav-link" data-scroll-target="#はじめに"><span class="header-section-number">1.1</span> はじめに</a></li>
  <li><a href="#条件付きスコア場" id="toc-条件付きスコア場" class="nav-link" data-scroll-target="#条件付きスコア場"><span class="header-section-number">1.2</span> 条件付きスコア場</a></li>
  <li><a href="#sec-CG" id="toc-sec-CG" class="nav-link" data-scroll-target="#sec-CG"><span class="header-section-number">1.3</span> 分類器による誘導 (CG)</a></li>
  <li><a href="#分類器なしの誘導" id="toc-分類器なしの誘導" class="nav-link" data-scroll-target="#分類器なしの誘導"><span class="header-section-number">1.4</span> 分類器なしの誘導</a></li>
  <li><a href="#高解像度画像生成への応用" id="toc-高解像度画像生成への応用" class="nav-link" data-scroll-target="#高解像度画像生成への応用"><span class="header-section-number">1.5</span> 高解像度画像生成への応用</a></li>
  <li><a href="#逆問題への応用" id="toc-逆問題への応用" class="nav-link" data-scroll-target="#逆問題への応用"><span class="header-section-number">1.6</span> 逆問題への応用</a></li>
  </ul></li>
  <li><a href="#sec-2" id="toc-sec-2" class="nav-link" data-scroll-target="#sec-2"><span class="header-section-number">2</span> フローマッチングによる連続な条件付け</a>
  <ul class="collapse">
  <li><a href="#sec-CCG" id="toc-sec-CCG" class="nav-link" data-scroll-target="#sec-CCG"><span class="header-section-number">2.1</span> 連続な条件付き生成</a></li>
  <li><a href="#sec-FM" id="toc-sec-FM" class="nav-link" data-scroll-target="#sec-FM"><span class="header-section-number">2.2</span> フローマッチング (FM)</a></li>
  <li><a href="#条件付きフローマッチング-cfm" id="toc-条件付きフローマッチング-cfm" class="nav-link" data-scroll-target="#条件付きフローマッチング-cfm"><span class="header-section-number">2.3</span> 条件付きフローマッチング (CFM)</a></li>
  <li><a href="#最適輸送-cfm-ot-cfm" id="toc-最適輸送-cfm-ot-cfm" class="nav-link" data-scroll-target="#最適輸送-cfm-ot-cfm"><span class="header-section-number">2.4</span> 最適輸送 CFM (OT-CFM)</a></li>
  <li><a href="#sec-OT-CFM-in-GFM-perspective" id="toc-sec-OT-CFM-in-GFM-perspective" class="nav-link" data-scroll-target="#sec-OT-CFM-in-GFM-perspective"><span class="header-section-number">2.5</span> <span class="math inline">\(\mathcal{P}(\mathbb{R}^d)^{[0,1]}\)</span> 上の最適化としての見方</a></li>
  <li><a href="#sec-GFM" id="toc-sec-GFM" class="nav-link" data-scroll-target="#sec-GFM"><span class="header-section-number">2.6</span> 拡張フローマッチング (GFM)</a></li>
  <li><a href="#gfm-の無限次元最適化" id="toc-gfm-の無限次元最適化" class="nav-link" data-scroll-target="#gfm-の無限次元最適化"><span class="header-section-number">2.7</span> GFM の無限次元最適化</a></li>
  </ul></li>
  
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="hidden">
<p>A Blog Entry on Bayesian Computation by an Applied Mathematician</p>
<p>$$</p>
<p>$$</p>
</div>
<section id="関連ページ" class="level3 unnumbered unlisted">
<h3 class="unnumbered unlisted anchored" data-anchor-id="関連ページ">関連ページ</h3>
<div id="listing-diffusion-listing" class="quarto-listing quarto-listing-container-grid">
<div class="list grid quarto-listing-cols-3">
<div class="g-col-1" data-index="0" data-categories="RGVlcCUyQ1Byb2Nlc3MlMkNTYW1wbGluZw==" data-listing-date-sort="1707868800000" data-listing-file-modified-sort="1752753395643" data-listing-date-modified-sort="1724371200000" data-listing-reading-time-sort="5" data-listing-word-count-sort="826">
<a href="../../../posts/2024/Samplers/Diffusion.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="../../../posts/2024/Samplers/Files/DDPM_outputs.png" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
拡散模型
</h5>
<div class="card-subtitle listing-subtitle">
深層生成モデル６
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-02-14
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="1" data-categories="RGVlcCUyQ1NhbXBsaW5nJTJDUChYKQ==" data-listing-date-sort="1707868800000" data-listing-file-modified-sort="1752753395803" data-listing-date-modified-sort="1724803200000" data-listing-reading-time-sort="5" data-listing-word-count-sort="816">
<a href="../../../posts/2024/Samplers/NF1.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="../../../posts/2024/Samplers/Files/linear/output.gif" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
ニューラル常微分方程式
</h5>
<div class="card-subtitle listing-subtitle">
シミュレーションなしの拡散モデルとしての連続正規化流
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-02-14
</div>
</div>
</div>
</div></a>
</div>
<div class="g-col-1" data-index="2" data-categories="RGVlcCUyQ05hdHVyZSUyQ1NhbXBsaW5n" data-listing-date-sort="1711756800000" data-listing-file-modified-sort="1752753395643" data-listing-date-modified-sort="1722470400000" data-listing-reading-time-sort="5" data-listing-word-count-sort="880">
<a href="../../../posts/2024/Samplers/EBM.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-left">
<p class="card-img-top">
<img loading="lazy" src="../../../posts/2024/Samplers/Files/NCL/thumb_checkerboard.gif" class="thumbnail-image card-img" style="height: 150px;">
</p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
エネルギーベースモデル
</h5>
<div class="card-subtitle listing-subtitle">
深層生成モデル５
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-03-30
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
<section id="誘導" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="誘導"><span class="header-section-number">1</span> 誘導</h2>
<p>拡散模型の美点には，条件付けが可能で拡張性に優れているという点もある．</p>
<p>実際，拡散模型の出現後，Conditional VAE <span class="citation" data-cites="Kingma+2014">(<a href="#ref-Kingma+2014" role="doc-biblioref">Kingma et al., 2014</a>)</span> などの従来手法を凌駕する条件付き生成が可能であることが直ちに理解された．</p>
<p><span class="math inline">\(C\)</span> がクラスラベルなどの離散変数である場合，「誘導」による条件付き生成が初めに考えられた．</p>
<section id="はじめに" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="はじめに"><span class="header-section-number">1.1</span> はじめに</h3>
<p>「誘導」ではまず，DDPM <span class="citation" data-cites="Ho+2020">(<a href="#ref-Ho+2020" role="doc-biblioref">Ho et al., 2020</a>)</span> でタイムステップ <span class="math inline">\(t\)</span> を positional encoding したようにして，プロンプト <span class="math inline">\(c\)</span> をデータに埋め込む．<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>そしてデータ <span class="math inline">\(X\)</span> とそのラベル <span class="math inline">\(C\)</span> に対して，条件付き分布 <span class="math inline">\(\mathcal{L}[X|C]\)</span> をモデリングする．</p>
<p>しかしこのアプローチの問題は，ラベル <span class="math inline">\(C\)</span> が不確実な場合などは，この情報を無視して普通の <span class="math inline">\(X\)</span> が生成されてしまいがちであることである．</p>
<p>そこで目的関数に，条件付き分布 <span class="math inline">\(X|C\)</span> の正確性を期すような追加のデザインをする．これが「誘導」である．</p>
</section>
<section id="条件付きスコア場" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="条件付きスコア場"><span class="header-section-number">1.2</span> 条件付きスコア場</h3>
<p>条件付き分布 <span class="math inline">\(p(x|c)\)</span> を学習することを考える．</p>
<p>このとき <span class="math inline">\(p(x|c)\)</span> のスコアは，Bayes の定理から次のように表せる： <span class="math display">\[
\log p(x|c)=\log p(c|x)+\log p(x)-\log p(c),
\]</span> <span id="eq-conditioned-score"><span class="math display">\[
\therefore\qquad\nabla_x\log p(x|c)=\nabla_x\log p(x)+\nabla_x\log p(c|x).
\tag{1}\]</span></span></p>
<p>すなわち，条件付き確率 <span class="math inline">\(p(x|c)\)</span> のスコア場は，条件なしのスコア場 <span class="math inline">\(\nabla_x\log p(x)\)</span> と，分類器のスコア場 <span class="math inline">\(\nabla_x\log p(c|x)\)</span> の重ね合わせになる．</p>
</section>
<section id="sec-CG" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="sec-CG"><span class="header-section-number">1.3</span> 分類器による誘導 (CG)</h3>
<p>式 (<a href="#eq-conditioned-score" class="quarto-xref">1</a>) から，<span class="math inline">\(\nabla_x\log p(x|c)\)</span> が計算できる分類器 <span class="math inline">\(p(c|x)\)</span> を新たに訓練すれば，既存のモデル <span class="math inline">\(\nabla_x\log p(x)\)</span> から，サンプリング方法を変えるだけで条件付き生成ができる．</p>
<p>これを <strong>CG: Classifier Guidance</strong> <span class="citation" data-cites="Dhariwal-Nichol2021">(<a href="#ref-Dhariwal-Nichol2021" role="doc-biblioref">Dhariwal and Nichol, 2021</a>)</span> といい，サンプリング中に各ステップで少しずつ <span class="math inline">\(x_t\)</span> が <span class="math inline">\(p(x_t|c)\)</span> に近づくように「誘導」されていく．</p>
<p>さらに，<span class="math inline">\(c\)</span> が無視されがちな場合も見越して，誘導スケール (guidance scale) という新たなハイパーパラメータ <span class="math inline">\(\lambda\ge0\)</span> を導入し，次のスコア <span id="eq-CG-score"><span class="math display">\[
\nabla_x\log p(x)+\lambda\nabla_x\log p(c|x).
\tag{2}\]</span></span> からサンプリングすることも考えられる．</p>
<p><span class="math inline">\(\lambda&gt;1\)</span> としどんどん大きくしていくと，クラスラベル <span class="math inline">\(c\)</span> に「典型的な」サンプルが生成される傾向にある．</p>
</section>
<section id="分類器なしの誘導" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="分類器なしの誘導"><span class="header-section-number">1.4</span> 分類器なしの誘導</h3>
<p>CG はいわばアドホックな方法であり，外部の分類器 <span class="math inline">\(p(c|x)\)</span> に頼らない方法を考えたい．</p>
<p>そのためには，式 (<a href="#eq-CG-score" class="quarto-xref">2</a>) から <span class="math inline">\(p(c|x)\)</span> を消去して <span id="eq-CFG-score"><span class="math display">\[
\lambda\nabla_x\log p(x|c)+(1-\lambda)\nabla_x\log p(x)
\tag{3}\]</span></span> とみて，<span class="math inline">\(p(x|c),p(x)\)</span> のいずれもデータから学ぶ．</p>
<p>このアプローチを <strong>Classifier-Free Diffusion Guidance</strong> <span class="citation" data-cites="Ho-Salimans2021">(<a href="#ref-Ho-Salimans2021" role="doc-biblioref">Ho and Salimans, 2021</a>)</span> という．</p>
<p>その際は，新たなクラスラベル <span class="math inline">\(\emptyset\)</span> を導入して <span class="math display">\[
p(x)=p(x|\emptyset)
\]</span> とみなすことで，<span class="math inline">\(p(x|c),p(x)\)</span> を同一の <a href="../../../posts/2024/Samplers/Diffusion.html#sec-score-network">スコアネットワーク</a> でモデリングする．</p>
<p>データセット内にランダムに1から2割の画像をクラスラベル <span class="math inline">\(\emptyset\)</span> と設定することで，これを実現する．</p>
<p>同様の方法を，スコアマッチングではなくフローマッチングを行うことを <span class="citation" data-cites="Dao+2023">(<a href="#ref-Dao+2023" role="doc-biblioref">Dao et al., 2023</a>)</span>, <span class="citation" data-cites="Zheng+2023GuidedFlow">(<a href="#ref-Zheng+2023GuidedFlow" role="doc-biblioref">Q. Zheng et al., 2023</a>)</span> が提案している．</p>
<p>この方法は，追加の分類器の訓練が必要ないだけでなく，サンプリングのクオリティも向上する <span class="citation" data-cites="Nichol+2022">(<a href="#ref-Nichol+2022" role="doc-biblioref">Nichol et al., 2022</a>)</span>, <span class="citation" data-cites="Saharia+2022SIGGRAPH">(<a href="#ref-Saharia+2022SIGGRAPH" role="doc-biblioref">Saharia, Chan, Chang, et al., 2022</a>)</span>．これは分類タスクで訓練されたスコア <span class="math inline">\(\log p(c|x)\)</span> はどう訓練してもスコアネットワークで学習したスコア (<a href="#eq-CFG-score" class="quarto-xref">3</a>) に匹敵する「良い」勾配が得られないためである．</p>
</section>
<section id="高解像度画像生成への応用" class="level3" data-number="1.5">
<h3 data-number="1.5" class="anchored" data-anchor-id="高解像度画像生成への応用"><span class="header-section-number">1.5</span> 高解像度画像生成への応用</h3>
<section id="sec-CascadedGeneration" class="level4" data-number="1.5.1">
<h4 data-number="1.5.1" class="anchored" data-anchor-id="sec-CascadedGeneration"><span class="header-section-number">1.5.1</span> Cascaded Generation</h4>
<p>条件付き生成の技術はそのままで，最終的なクオリティを向上させるためには，Cascading <span class="citation" data-cites="Ho+2022">(<a href="#ref-Ho+2022" role="doc-biblioref">Ho et al., 2022</a>)</span> が使用可能である．</p>
<p>これは，画像生成は <span class="math inline">\(x\)</span> の解像度が低い状態で行い，この低解像度画像を次の条件付き拡散モデルの条件付け <span class="math inline">\(c\)</span> として，条件付き生成を <strong>高解像度化</strong> (super-resolution) に用いるものである <span class="citation" data-cites="Saharia+2023">(<a href="#ref-Saharia+2023" role="doc-biblioref">Saharia et al., 2023</a>)</span>．</p>
<p>この方法の美点は，条件付き生成器をたくさんスタックしたのちに，拡散模型間の段階でも Gauss ノイズや blur を印加することで，さらに最終的なクオリティが上げられるという <span class="citation" data-cites="Ho+2022">(<a href="#ref-Ho+2022" role="doc-biblioref">Ho et al., 2022</a>)</span>．これを <strong>conditioning augmentation</strong> と呼んでいる．</p>
<p>この方法は最初から高解像度での生成を目指して大規模な単一の拡散模型を設計するよりも大きく計算コストを削減できる．</p>
<p>Google も <a href="https://imagen.research.google/">Imagen</a> <span class="citation" data-cites="Saharia+2022">(<a href="#ref-Saharia+2022" role="doc-biblioref">Saharia, Chan, Saxena, et al., 2022</a>)</span> でこのアーキテクチャを用いている．</p>
</section>
<section id="self-conditioning-chen2023analogbits" class="level4" data-number="1.5.2">
<h4 data-number="1.5.2" class="anchored" data-anchor-id="self-conditioning-chen2023analogbits"><span class="header-section-number">1.5.2</span> Self-Conditioning <span class="citation" data-cites="Chen+2023AnalogBits">(<a href="#ref-Chen+2023AnalogBits" role="doc-biblioref">T. Chen et al., 2023</a>)</span></h4>
<p>拡散モデルを自己再帰的に用い，自身の前回の出力を今回の入力として逐次的にサンプリングを繰り返すことで，サンプリングのクオリティをさらに向上する自己条件づけが <span class="citation" data-cites="Chen+2023AnalogBits">(<a href="#ref-Chen+2023AnalogBits" role="doc-biblioref">T. Chen et al., 2023</a>)</span> で提案された．</p>
<p>この方法は RoseTTAFold Diffusion <span class="citation" data-cites="Watson+2023">(<a href="#ref-Watson+2023" role="doc-biblioref">Watson et al., 2023</a>)</span> によるたんぱく質構造生成でも用いられている：</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Files/RFDiff.gif" class="img-fluid figure-img"></p>
<figcaption>RFdiffusion generating a novel protein that binds to the insulin receptor. Taken from <a href="https://www.bakerlab.org/2023/07/11/diffusion-model-for-protein-design/">Baker Lab HP</a></figcaption>
</figure>
</div>
</section>
</section>
<section id="逆問題への応用" class="level3" data-number="1.6">
<h3 data-number="1.6" class="anchored" data-anchor-id="逆問題への応用"><span class="header-section-number">1.6</span> 逆問題への応用</h3>
<p>一方で単一の <span class="math inline">\(Y=y\)</span> を想定した状況では，非償却的な方法を採用することでさらに精度を上げることが考えられる．</p>
<p><span class="math inline">\(\log p_t(x_t|y)\)</span> を一緒くたに <span class="math inline">\(s^\theta_{t}(x_t,y)\)</span> に取り替えてしまうのではなく，まず第一項 <span class="math inline">\(\nabla_x\log p_t(x_t|y)\)</span> を <span class="math inline">\(s_t^\theta(x_t)\)</span> により統一的にモデリングする．</p>
<p>そして <span class="math inline">\(\nabla_x\log p_t(y|x_t)\)</span> の項は <a href="../../../posts/2024/Samplers/DD1.html#sec-Tweedie-formula">Tweedie の推定量</a> <span id="eq-Tweedie-estimator"><span class="math display">\[
\widehat{x}_0:=\operatorname{E}[x_0|x_t]=\frac{1}{\sqrt{\overline{\alpha}_t}}\biggr(x_t+(1-\overline{\alpha}_t)\nabla_{x_t}\log p_t(x_t)\biggl)
\tag{4}\]</span></span> を通じて <span class="math display">\[
p(y|x_t)\approx p(y|\widehat{x}_0)
\]</span> によって近似する．式 (<a href="#eq-Tweedie-estimator" class="quarto-xref">4</a>) の <span class="math inline">\(\nabla_{x_t}\log p_t(x_t)\)</span> に事前に訓練したスコアネットワーク <span class="math inline">\(s_t^\theta(x_t)\)</span> を用いる．</p>
<p><span class="citation" data-cites="Chung+2023">(<a href="#ref-Chung+2023" role="doc-biblioref">Chung et al., 2023</a>)</span> はこの方法を Computer Vision における非線型逆問題に適用している．</p>
<p><span class="citation" data-cites="Song+2023">(<a href="#ref-Song+2023" role="doc-biblioref">Song et al., 2023</a>)</span> では Monte Carlo 法が用いられている．</p>
<p>拡散模型の一般の事後分布サンプリングのための応用については次稿も参照：</p>
<div id="listing-lst-embedding" class="listing quarto-float quarto-figure quarto-figure-left quarto-listing quarto-listing-container-grid anchored">
<div class="list grid quarto-listing-cols-1">
<div class="g-col-1" data-index="0" data-categories="UHJvY2VzcyUyQ1NhbXBsaW5nJTJDUChYKQ==" data-listing-date-sort="1722643200000" data-listing-file-modified-sort="1752753394094" data-listing-date-modified-sort="1728691200000" data-listing-reading-time-sort="2" data-listing-word-count-sort="300">
<a href="../../../posts/2024/Bridges/SB0.html" class="quarto-grid-link">
<div class="quarto-grid-item card h-100 card-center">
<p class="card-img-top"><img src="../Bridges/Files/ode_animation.gif" style="height: 150px;"  class="thumbnail-image card-img"/></p>
<div class="card-body post-contents">
<h5 class="no-anchor card-title listing-title">
拡散モデルによる事後分布サンプリング
</h5>
<div class="card-subtitle listing-subtitle">
Langevin 拡散の時間反転を用いたシミュレーションベースのサンプリング法
</div>
<div class="card-attribution card-text-small end">
<div class="listing-date">
2024-08-03
</div>
</div>
</div>
</div></a>
</div>
</div>
<div class="listing-no-matching d-none">No matching items</div>
</div>
</section>
</section>
<section id="sec-2" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="sec-2"><span class="header-section-number">2</span> フローマッチングによる連続な条件付け</h2>
<section id="sec-CCG" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="sec-CCG"><span class="header-section-number">2.1</span> 連続な条件付き生成</h3>
<p>連続な変数に対する条件付き確率からの生成は CcGAN <span class="citation" data-cites="Ding+2021">(<a href="#ref-Ding+2021" role="doc-biblioref">Ding et al., 2021</a>)</span> などでも試みられていた．</p>
<p>AlphaFold 3 <span class="citation" data-cites="Abramson+2024">(<a href="#ref-Abramson+2024" role="doc-biblioref">Abramson et al., 2024</a>)</span> や RoseTTAFold Diffusion <span class="citation" data-cites="Watson+2023">(<a href="#ref-Watson+2023" role="doc-biblioref">Watson et al., 2023</a>)</span>, <span class="citation" data-cites="Krishna+2024">(<a href="#ref-Krishna+2024" role="doc-biblioref">Krishna et al., 2024</a>)</span> など，たんぱく質構造生成模型において拡散モデルが用いられている理由も，高精度な条件付き生成が可能であることが大きいという．</p>
<p>このことに加えて連続な変数に対する条件付けを可能にすることは，拡散モデルの拡張性をさらに高めることになる．</p>
<p>そもそも拡散モデルは <a href="../../../posts/2024/Samplers/NF1.html#sec-FM">連続時間正規化流</a> (CNF) と合流し，フローマッチング（第 <a href="#sec-FM" class="quarto-xref">2.2</a> 節）によりノイズ分布 <span class="math inline">\(P_0\)</span> をデータ分布 <span class="math inline">\(P_1\)</span> に変換する曲線 <span class="math inline">\(\{P_t\}_{t\in[0,1]}\subset\mathcal{P}(\mathbb{R}^d)\)</span> を直接学習するように発展した．</p>
<p>この方法では，新たな条件付け変数 <span class="math inline">\(c\in[0,1]^k\)</span> に対して，連続写像 <span class="math display">\[
P_{t,c}:[0,1]\times[0,1]^k\to\mathcal{P}(\mathbb{R}^d)
\]</span> を学習するようにフローマッチングを拡張できれば，連続な条件付き生成が可能になることになる．</p>
<p>これを行列値ベクトル場の理論を通じて達成するのが <strong>拡張フローマッチング</strong> (EFM: Extended Flow Matching) <span class="citation" data-cites="Isobe+2024">(<a href="#ref-Isobe+2024" role="doc-biblioref">Isobe et al., 2024</a>)</span> である．</p>
<p>このようなフローマッチングの拡張は <span class="citation" data-cites="Chen-Lipman2024">(<a href="#ref-Chen-Lipman2024" role="doc-biblioref">R. T. Q. Chen and Lipman, 2024</a>)</span> でも考えられている．</p>
</section>
<section id="sec-FM" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="sec-FM"><span class="header-section-number">2.2</span> フローマッチング (FM)</h3>
<p>２つの確率分布 <span class="math inline">\(P_0,P_1\in\mathcal{P}(\mathbb{R}^d)\)</span> を結ぶ曲線を <span class="math display">\[
(P_t)=((\phi_t)_*P_0)_{t\in[0,1]}\in\mathcal{P}(\mathbb{R}^d)^{[0,1]}
\]</span> の形で学習することを考える．</p>
<p>そのための１つのアプローチとして，<a href="https://ja.wikipedia.org/wiki/連続の方程式">連続方程式</a> というPDE <span id="eq-CE"><span class="math display">\[
\frac{\partial p_t}{\partial t}+\operatorname{div}(F_tp_t)=0.
\tag{5}\]</span></span> を満たすベクトル場 <span class="math inline">\(F_t\)</span> を学習し，これが定めるフローを <span class="math inline">\((\phi_t)\)</span> とすることがある：</p>
<p><span class="math display">\[
\frac{\partial \phi_t(x)}{\partial t}=F_t(\phi_t(x)).
\]</span></p>
<p>このような <span class="math inline">\(F_t\)</span> が１つ既知であり，<span class="math inline">\(p_t\)</span> から自由にサンプリングできる場合は， <span id="eq-FM-objective"><span class="math display">\[
\mathcal{L}_{\mathrm{FM}}(\theta)=\operatorname{E}\biggl[\biggl|F_\theta(X_T,T)-F_T(X_T)\biggr|^2\biggr],\qquad T\sim\mathrm{U}([0,1]),X_T\sim p_T,
\tag{6}\]</span></span> の最小化によってベクトル場 <span class="math inline">\(F_t\)</span> が学習できる．これを <strong>フローマッチング</strong> (FM: Flow Matching) の目的関数という．</p>
</section>
<section id="条件付きフローマッチング-cfm" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="条件付きフローマッチング-cfm"><span class="header-section-number">2.3</span> 条件付きフローマッチング (CFM)</h3>
<p>仮に <span class="math inline">\(p_t\)</span> が <span class="math display">\[
p_t(x)=\int_\Omega p_t(x|c)q(c)\,dc,\qquad\Omega\subset\mathbb{R}^k,
\]</span> という <span class="math inline">\(p_{t,c}(x):=p_t(x|c)\)</span> の <span class="math inline">\(q\)</span>-混合としての展開を通じて得られているとする．</p>
<p>この場合，<span class="math inline">\((p_{t,c})\)</span> を生成するベクトル場 <span class="math inline">\(F_t(x|c)\)</span> が特定できれば， <span id="eq-marginal-VF"><span class="math display">\[
F_t(x):=\operatorname{E}\left[\frac{F_t(x|U)p_t(x|U)}{p_t(x)}\right]
\tag{7}\]</span></span> が <span class="math inline">\((p_t)\)</span> を生成する <span class="citation" data-cites="Lipman+2023">(定理1 <a href="#ref-Lipman+2023" role="doc-biblioref">Lipman et al., 2023</a>)</span>, <span class="citation" data-cites="Tong+2024">(定理3.1 <a href="#ref-Tong+2024" role="doc-biblioref">Tong et al., 2024</a>)</span>．</p>
<p>従って，<span class="math inline">\(F_t\)</span> を学習するには FM 目的関数 (<a href="#eq-FM-objective" class="quarto-xref">6</a>) の代わりに <span id="eq-CFM-objective"><span class="math display">\[
\mathcal{L}_{\mathrm{CFM}}(\theta)=\operatorname{E}\biggl[\biggl|F_\theta(X_T,T)-F_T(X|C)\biggr|^2\biggr],\qquad C\sim q,
\tag{8}\]</span></span> の最小化によっても <span class="math inline">\(F_t(x|c)\)</span> が学習できる．これを <strong>条件付きフローマッチング</strong> (CFM: Conditional Flow Matching) の目的関数という．</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="$P_0$ が Gauss 分布である場合 [@Lipman+2023]">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="math inline">\(P_0\)</span> が Gauss 分布である場合 <span class="citation" data-cites="Lipman+2023">(<a href="#ref-Lipman+2023" role="doc-biblioref">Lipman et al., 2023</a>)</span>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><span class="math inline">\(P_0=\operatorname{N}_d(0,I_d)\)</span> をノイズ分布，<span class="math inline">\(P_1\)</span> を一般のデータ分布とする．</p>
<p>ただし，誤差を許して，<span class="math inline">\(P_1*\operatorname{N}_d(0,\sigma^2I_d)\)</span> を改めて真のデータ分布とする．</p>
<p>このように定式化することで，各データ点 <span class="math inline">\(c\in\{x_i\}_{i=1}^n\)</span> で条件づければ， <span class="math display">\[
P_{0,c}:=P_0(-|c)=\operatorname{N}_d(0,I_d),\qquad P_{1,c}:=P_1(-|c)=\operatorname{N}_d(0,\sigma^2I_d),
\]</span> の間を結ぶ曲線 <span class="math inline">\((P_{t,c})_{t\in[0,1],c\in\{x_i\}_{i=1}^n}\)</span> を学習する問題となる．</p>
<p>実は <span class="math inline">\(P_{0,c},P_{1,c}\)</span> が Gauss 分布であることにより，この問題はすでに <span class="citation" data-cites="McCann1997">(<a href="#ref-McCann1997" role="doc-biblioref">McCann, 1997, p. 159</a>)</span> によって解かれており，最適輸送は <span class="math display">\[
P_{t,c}=\operatorname{N}_d\biggr(tc,(t\sigma-t+1)^2I_d\biggl),\qquad F_t(x|c)=\frac{c-(1-\sigma)x}{1-(1-\sigma)t},
\]</span> によって与えられる．</p>
</div>
</div>
</div>
<p>しかし，各 <span class="math inline">\((P_{t,c})_{t\in[0,1]}\)</span> が最適輸送になっていても，式 (<a href="#eq-marginal-VF" class="quarto-xref">7</a>) で定まる <span class="math inline">\((P_t)_{t\in[0,1]}\)</span> が最適輸送になるとは限らない．</p>
</section>
<section id="最適輸送-cfm-ot-cfm" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="最適輸送-cfm-ot-cfm"><span class="header-section-number">2.4</span> 最適輸送 CFM (OT-CFM)</h3>
<p>ここで形式的に，条件付ける変数 <span class="math inline">\(c\)</span> は <a href="../../../posts/2024/Probability/Coupling.html">カップリング</a> <span class="math inline">\(\pi\in C(P_0,P_1)\)</span> に従う <span class="math inline">\(C\sim\pi\)</span> とする： <span class="math display">\[
C(P_0,P_1):=\left\{\pi\in\mathcal{P}(\mathbb{R}^d\times\mathbb{R}^d)\:\middle|\:\begin{array}{l}(\mathrm{pr}_1)_*\pi=P_0,\\(\mathrm{pr}_2)_*\pi=P_1\end{array}\right\}.
\]</span></p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="$P_0$ も一般の分布である場合 [I-CFM @Tong+2024]">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="math inline">\(P_0\)</span> も一般の分布である場合 <span class="citation" data-cites="Tong+2024">(I-CFM <a href="#ref-Tong+2024" role="doc-biblioref">Tong et al., 2024</a>)</span>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><span class="math inline">\(Q_0,Q_1\)</span> は未知のデータ分布で， <span class="math display">\[
P_1=Q_1*\operatorname{N}_d(0,\sigma^2I_d),\qquad P_0=Q_0*\operatorname{N}_d(0,\sigma^2I_d),
\]</span> の間を架橋したいとする．このとき， <span class="math display">\[
\pi:=Q_0\otimes Q_1
\]</span> と定めると， <span class="math display">\[
P_{t,c}=\operatorname{N}_d\biggr(tc_1+(1-t)c_0,\sigma^2I_d\biggl),\qquad F_t(x|c)=c_1-c_0,
\]</span> が <span class="math inline">\(P_0,P_1\)</span> の間の輸送を定める <span class="citation" data-cites="Tong+2024">(命題3.3 <a href="#ref-Tong+2024" role="doc-biblioref">Tong et al., 2024</a>)</span>．</p>
<p>加えて，<span class="math inline">\(\sigma\to0\)</span> の極限において，学習される輸送 <span class="math inline">\((P_t)\)</span> は <span class="math inline">\(Q_0,Q_1\)</span> の間の輸送になる．</p>
<p>これは <span class="citation" data-cites="Lipman+2023">(<a href="#ref-Lipman+2023" role="doc-biblioref">Lipman et al., 2023</a>)</span> の例の，<span class="math inline">\(P_0,P_1\)</span> を対称に扱った拡張と見れる．</p>
<p>また，<span class="math inline">\(P_{t,c}\)</span> が <span class="math inline">\(\sigma\to0\)</span> とした Delta 測度である場合が Rectified Flow <span class="citation" data-cites="Liu+2023-Flow">(<a href="#ref-Liu+2023-Flow" role="doc-biblioref">Liu et al., 2023</a>)</span> に当たる．</p>
<p>この方法を拡張し，例えば平均を線型関数 <span class="math inline">\(m(t)=tc_1+(1-t)c_0\)</span> の代わりに <span class="math display">\[
m(t)=\cos\left(\frac{\pi t}{2}\right)c_0+\sin\left(\frac{\pi t}{2}\right)c_1
\]</span> とした場合が Stochastic Interpolant <span class="citation" data-cites="Albergo-Vanden-Eijnden2023">(<a href="#ref-Albergo-Vanden-Eijnden2023" role="doc-biblioref">Albergo and Vanden-Eijnden, 2023</a>)</span> に当たる．</p>
</div>
</div>
</div>
<p>その中でも特に，<span class="math inline">\(\pi\)</span> を 2-Wasserstein 距離に関する最適輸送計画 <span class="math display">\[
\pi:=\operatorname*{argmin}_{\pi\in C(P_0,P_1)}\operatorname{E}[\lvert X-Y\rvert^2]
\]</span> であるとする．</p>
<p>このとき， <span class="math display">\[
P_{t,c}=\operatorname{N}_d\biggr(tc_1+(1-t)c_0,\sigma^2I_d\biggl),\qquad F_t(x|c)=c_1-c_0,
\]</span> を <span class="math inline">\(C\sim\pi\)</span> に関して周辺化した輸送 <span class="math inline">\((P_t)\in\mathcal{P}(\mathbb{R}^d)^{[0,1]}\)</span> は，<span class="math inline">\(\sigma\to0\)</span> の極限で（動的な）最適輸送になる <span class="citation" data-cites="Tong+2024">(命題3.4 <a href="#ref-Tong+2024" role="doc-biblioref">Tong et al., 2024</a>)</span>．</p>
<div class="callout callout-style-default callout-caution no-icon callout-titled" title="Schrödinger Bridge のシミュレーション [SB-CFM @Tong+2024]">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Schrödinger Bridge のシミュレーション <span class="citation" data-cites="Tong+2024">(SB-CFM <a href="#ref-Tong+2024" role="doc-biblioref">Tong et al., 2024</a>)</span>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><span class="math display">\[
\pi_{2\sigma^2}:=\operatorname*{argmin}_{\pi\in C(P_0,P_1)}\biggr(\operatorname{E}[\lvert X-Y\rvert^2]+2\sigma^2H(\pi)\biggl)
\]</span> を，エントロピー正則化項 <span class="math inline">\(2\sigma^2\)</span> を持ったエントロピー最適輸送計画とする．</p>
<p>このとき，各点を結んだ Broanian bridge <span class="math display">\[
P_{t,c}:=\operatorname{N}\biggr(tc_1+(1-t)c_0,t(1-t)\sigma^2I_d\biggl),
\]</span> <span class="math display">\[
F_t(x|c):=\frac{1-2t}{2t(1-t)}\biggr(x-(tc_1+(1-t)c_0)\biggl)+(c_1-c_0),
\]</span> の周辺化 <span class="math inline">\((P_t)\in\mathcal{P}(\mathbb{R}^d)^{[0,1]}\)</span> は，標準 Brown 運動を <span class="math inline">\(\sigma\)</span> だけスケールした分布 <span class="math inline">\(W\)</span> に対する Schrödinger bridge <span class="math display">\[
\pi^*:=\operatorname*{argmin}_{\substack{\mu_0=P_0\\\mu_1=P_1}}\operatorname{KL}(\mu,W)
\]</span> と分布同等になる <span class="citation" data-cites="Tong+2024">(定理3.5 <a href="#ref-Tong+2024" role="doc-biblioref">Tong et al., 2024</a>)</span>．</p>
<p><span class="math inline">\(\sigma\to0\)</span> の極限が OT-CFM であり，<span class="math inline">\(\sigma\to\infty\)</span> の極限が I-CFM である．</p>
</div>
</div>
</div>
<p>訓練時は，CFM の目的関数 (<a href="#eq-CFM-objective" class="quarto-xref">8</a>) を計算するために <span class="math inline">\((X_0,X_1)\sim\pi\)</span> というサンプリングが必要になる．データサイズが大きい場合には，これにミニバッチ最適輸送 <span class="citation" data-cites="Fatras+2021">(<a href="#ref-Fatras+2021" role="doc-biblioref">Fatras et al., 2021</a>)</span> を用いることができる．</p>
<p>このように，２つの分布 <span class="math inline">\(P_0,P_1\)</span> を単に独立カップリングと見るのではなく，依存関係があった場合にはそれも考慮してなるべくダイナミクスが直線になるように誘導する方法 Multisample Flow Matching として <span class="citation" data-cites="Pooladian+2023">(<a href="#ref-Pooladian+2023" role="doc-biblioref">Pooladian et al., 2023</a>)</span> も考えている．</p>
</section>
<section id="sec-OT-CFM-in-GFM-perspective" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="sec-OT-CFM-in-GFM-perspective"><span class="header-section-number">2.5</span> <span class="math inline">\(\mathcal{P}(\mathbb{R}^d)^{[0,1]}\)</span> 上の最適化としての見方</h3>
<p>実は OT-CFM は，２つの確率密度 <span class="math inline">\(p_0,p_1\)</span> を結ぶ曲線 <span class="math inline">\((p_t)\in\mathcal{P}(\mathbb{R}^d)^{[0,1]}\)</span> の中で，<strong>Dirichlet エネルギー</strong> <span class="math display">\[
D(p):=\inf_{(p,F)}\frac{1}{2}\int_{[0,1]\times\mathbb{R}^d}\lvert F_t(x)\rvert^2p_t(x)\,dxdt
\]</span> を最小化する曲線 <span class="math inline">\((p_t)\)</span> を学習していると見れる <span class="citation" data-cites="Isobe+2024">(<a href="#ref-Isobe+2024" role="doc-biblioref">Isobe et al., 2024</a>)</span>．ただし，<span class="math inline">\((p,F)\)</span> は連続方程式 (<a href="#eq-CE" class="quarto-xref">5</a>) を満たす密度とベクトル場の組とした．</p>
<p>条件付きフローマッチングでは，このような曲線 <span class="math inline">\((p_t)\)</span> を次の方法で構成していた．</p>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<ol type="1">
<li>ある決定論的なダイナミクス <span class="math inline">\(\psi_c:[0,1]\to\mathbb{R}^d\)</span> を定める．<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li>
<li><span class="math inline">\(Q\in\mathcal{P}(C^1([0,1];\mathbb{R}^d))\)</span> を確率測度とする．</li>
<li><span class="math inline">\(\psi,Q\)</span> から， <span class="math display">\[
P^Q:=\operatorname{E}_{\psi\sim Q}[\delta_\psi]
\]</span> によって確率測度の曲線 <span class="math inline">\((P^Q_t)\in\mathcal{P}(\mathbb{R}^d)^{[0,1]}\)</span> を定める．</li>
</ol>
</div>
</div>
</div>
<p>実は Dirichlet 汎函数 <span class="math inline">\(D:\mathcal{P}(\mathbb{R}^d)^{[0,1]}\to\mathbb{R}_+\)</span> が凸であるために，このように構成される <span class="math inline">\((p_t)\)</span> の中での最適解は，<span class="math inline">\(Q\in\mathcal{P}(C^1([0,1];\mathbb{R}^d))\)</span> の全体で探す必要はなく，線型なダイナミクス <span class="math display">\[
\psi_c(t)=tc_1+(1-t)c_0,\qquad c=(c_0,c_1)\in\mathbb{R}^d\times\mathbb{R}^d,
\]</span> の重ね合わせの形でのみ探せば良い <span class="citation" data-cites="Brenier2003">(<a href="#ref-Brenier2003" role="doc-biblioref">Brenier, 2003</a>)</span>．</p>
<p>従って，<span class="math inline">\((X_0,X_1)\)</span> の分布の全体 <span class="math inline">\(C(P_0,P_1)\)</span> のみについてパラメータづけをして探せば良い．さらにこの場合， <span class="math display">\[
F_t(x|c)=\frac{\partial \psi_c(t)}{\partial t}=c_1-c_0
\]</span> であるから，<span class="math inline">\(D(P)=2W_2(P_0,P_1)^2\)</span> の最小化は <span class="math inline">\(P_0,P_1\)</span> の 2-Wasserstein 最適な輸送計画 <span class="math inline">\(\pi^*\)</span> の探索に等価になる．</p>
<p>これが OT-CFM の <span class="math inline">\(\mathcal{P}(\mathbb{R}^d)^{[0,1]}\)</span> 上の最適化としての解釈である．同時に，条件付きフローマッチングの目的関数 (<a href="#eq-CFM-objective" class="quarto-xref">8</a>) の他に，<a href="../../../posts/2024/Samplers/EBM.html#sec-DSM">DSM</a> 様の目的関数 <span class="math display">\[
\operatorname{E}\biggl[\biggl|F_T(\psi(T))-\partial_t\psi_C(T)\biggr|^2\biggr],\qquad T\sim\mathrm{U}([0,1]),C\sim\pi^*,
\]</span> の最小化点としてもベクトル場 <span class="math inline">\(F_t\)</span> が学習できる．</p>
</section>
<section id="sec-GFM" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="sec-GFM"><span class="header-section-number">2.6</span> 拡張フローマッチング (GFM)</h3>
<p>前節での観察は次のように要約できる：</p>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="OT-CFM の Dirichlet 汎函数最小化としての特徴付け">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
OT-CFM の Dirichlet 汎函数最小化としての特徴付け
</div>
</div>
<div class="callout-body-container callout-body">
<p>OT-CFM は，条件付きフローマッチングに対して，Dirichlet エネルギーの言葉で帰納バイアスを導入することで，最適輸送を学習するための方法論である．</p>
</div>
</div>
<p>こう考えると，Dirichlet エネルギーの言葉で他の帰納バイアスを導入することが考えられる．</p>
<p>ここで条件付けの議論（第 <a href="#sec-CCG" class="quarto-xref">2.1</a> 節）に戻ってくる．最適輸送のための <span class="math inline">\(c=(c_0,c_1)\in\mathbb{R}^{2d}\)</span> に限らず，一般の <span class="math inline">\(c\in\mathbb{R}^k\)</span> に対して連続に条件付けされるように拡張したい．</p>
<p>これは，<span class="math inline">\((F_t),(p_t)\)</span> の添字を <span class="math inline">\(t\in[0,1]\)</span> から <span class="math inline">\(\xi\in[0,1]\times\mathbb{R}^k\)</span> に拡張することで達成される．</p>
<p>これは新たな <span class="math inline">\((F_\xi),(p_\xi)\)</span> を <span class="math inline">\(M_{dk}(\mathbb{R})\)</span>-値の行列値ベクトル場 <span class="math inline">\((F_t)\)</span> とベクトル値密度 <span class="math inline">\((p_t)\)</span> と見ることに等価である．すると，<strong>一般化連続方程式</strong> <span class="citation" data-cites="Brenier2003">(<a href="#ref-Brenier2003" role="doc-biblioref">Brenier, 2003</a>)</span>, <span class="citation" data-cites="Lavenant2019">(<a href="#ref-Lavenant2019" role="doc-biblioref">Lavenant, 2019</a>)</span> <span class="math display">\[
\nabla_\xi p_\xi(x)+\operatorname{div}_x(p_\xi u_\xi)=0
\]</span> の理論を用いれば，全く同様の枠組みで可能になる <span class="citation" data-cites="Isobe+2024">(命題1 <a href="#ref-Isobe+2024" role="doc-biblioref">Isobe et al., 2024</a>)</span>．</p>
<p>これが <strong>拡張フローマッチング</strong> (EFM: Extended Flow Matching) <span class="citation" data-cites="Isobe+2024">(<a href="#ref-Isobe+2024" role="doc-biblioref">Isobe et al., 2024</a>)</span> である．</p>
</section>
<section id="gfm-の無限次元最適化" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="gfm-の無限次元最適化"><span class="header-section-number">2.7</span> GFM の無限次元最適化</h3>
<p>ただし，拡張 Dirichlet エネルギー <span class="citation" data-cites="Lavenant2019">(<a href="#ref-Lavenant2019" role="doc-biblioref">Lavenant, 2019</a>)</span> <span class="math display">\[
D(P):=\inf_{(p,F)}\frac{1}{2}\int_{[0,1]\times\mathbb{R}^k\times\mathbb{R}^d}\lvert F_\xi(x)\rvert^2p_\xi(x)\,dxd\xi
\]</span> の第 <a href="#sec-OT-CFM-in-GFM-perspective" class="quarto-xref">2.5</a> 節の形での最小化点は，もはや線型なダイナミクスの重ね合わせとは限らない．</p>
<p>すると無限次元最適化になってしまうため，適切な <a href="../../../posts/2023/KernelMethods/KernelMethods4Mathematicians.html">RKHS</a> <span class="math inline">\(\mathcal{F}\subset\mathrm{Map}([0,1]\times\mathbb{R}^k;\mathbb{R}^d)\)</span> 内で探すことが必要である： <span class="math display">\[
\psi=\phi_{x_{\partial\Xi}}\in\operatorname*{argmin}_{f\in\mathcal{F}}\sum_{\xi\in\partial\Xi}\lvert f(\xi)-x_\xi\rvert^2.
\]</span> ただし，<span class="math inline">\(\partial\Xi\overset{\text{finite}}{\subset}[0,1]\times\mathbb{R}^k\)</span> は境界条件が与えられる点の有限集合で，<span class="math inline">\(x_\xi\in\mathbb{R}^d\)</span> はその点での値である．</p>
<p><span class="math inline">\((\mathbb{R}^d)^{\lvert\partial\Xi\rvert}\)</span> 上での結合分布 <span class="math inline">\(\pi\)</span> が与えられたならば， <span class="math display">\[
\inf_{Q\in\mathcal{P}(C^1([0,1]\times\mathbb{R}^k;\mathbb{R}^d))}D(P^Q)\le\inf_\pi\int_{(\mathbb{R}^d)^{\lvert\partial\Xi\rvert}}\lvert\nabla_\xi\phi_{x_{\partial\Xi}}\rvert^2\pi(dx_\xi)
\]</span> という評価が得られるが，この右辺は最適輸送の形になっており，最小値が適切な周辺分布とコスト関数 <span class="math display">\[
c(x_{\partial\Xi}):=\int_{[0,1]\times\mathbb{R}^k}\lvert\nabla_\xi\phi_{x_{\partial\Xi}}(\xi)\rvert^2\,d\xi
\]</span> が定める輸送計画問題になっている．</p>
<p>この解 <span class="math inline">\(\pi^*\)</span> をミニバッチ最適輸送で解きながら，目的関数 <span class="math display">\[
\operatorname{E}\biggl[\biggl|F_T(\psi(T))-\nabla_\xi\phi_{x_{\partial\Xi}}\biggr|^2\biggr],\qquad T\sim\mathrm{U}([0,1]),x_{\partial\Xi}\sim\pi^*,
\]</span> の最小化点としてベクトル場 <span class="math inline">\(F_t\)</span> を学習することができる <span class="citation" data-cites="Isobe+2024">(定理4 <a href="#ref-Isobe+2024" role="doc-biblioref">Isobe et al., 2024</a>)</span>．</p>
<p>これを <span class="citation" data-cites="Isobe+2024">(<a href="#ref-Isobe+2024" role="doc-biblioref">Isobe et al., 2024</a>)</span> は MMOT-EFM と呼んでいる．</p>
</section>
</section>



<div id="quarto-appendix" class="default"><section id="文献紹介" class="level2 appendix" data-number="3"><h2 class="anchored quarto-appendix-heading"><span class="header-section-number">3</span> 文献紹介</h2><div class="quarto-appendix-contents">

<p>本記事の後半第 <a href="#sec-2" class="quarto-xref">2</a> 節は，<span class="citation" data-cites="Tong+2024">(<a href="#ref-Tong+2024" role="doc-biblioref">Tong et al., 2024</a>)</span>, <span class="citation" data-cites="Isobe+2024">(<a href="#ref-Isobe+2024" role="doc-biblioref">Isobe et al., 2024</a>)</span> の解説である．</p>
<p>前半の内容に関して，メンダコ氏によるブログ記事 <a href="https://horomary.hatenablog.com/entry/2024/06/30/211033">AlphaFold の進化史</a> は AlphaFold3 が丁寧に解説されている．</p>
<p>当該ブログは丁寧に書かれており，大変おすすめできる．</p>
<blockquote class="blockquote">
<p>Alphafold3とは長大な条件付けネットワークを備えた全原子拡散生成モデルであると前述したとおり、Alphafold3では必須入力としてタンパク質配列を、任意入力として核酸配列、SMILES形式で表現された低分子リガンド、金属イオンなどを長大な条件付けネットワークに入力することで、拡散モデルへの条件付けベクトルを作成します。</p>
</blockquote>
<blockquote class="blockquote">
<p>DeepLearningで大規模分子の構造分布を予測するなんて数年前には考えられませんでしたが、拡散モデルによってすでに現実になりつつあります。一例として Distributional GraphormerというMicrosoft Researchの研究 <span class="citation" data-cites="Zheng+2024">(<a href="#ref-Zheng+2024" role="doc-biblioref">S. Zheng et al., 2024</a>)</span> を紹介します。</p>
</blockquote>
<p>続きはぜひ，<a href="https://horomary.hatenablog.com/entry/2024/06/30/211033#AlphaFold3-2024">メンダコ氏のブログ</a>でお読みください．</p>
<p><span class="citation" data-cites="Dao+2023">(<a href="#ref-Dao+2023" role="doc-biblioref">Dao et al., 2023</a>)</span> のプロジェクトページは <a href="https://vinairesearch.github.io/LFM/">こちら</a>．</p>




</div></section><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Abramson+2024" class="csl-entry" role="listitem">
Abramson, J., Adler, J., Dunger, J., Evans, R., Green, T., Pritzel, A., … Jumper, J. M. (2024). <a href="https://doi.org/10.1038/s41586-024-07487-w">Accurate structure prediction of biomolecular interactions with AlphaFold 3</a>. <em>Nature</em>, <em>630</em>(8016), 493–500.
</div>
<div id="ref-Albergo-Vanden-Eijnden2023" class="csl-entry" role="listitem">
Albergo, M. S., and Vanden-Eijnden, E. (2023). <a href="https://openreview.net/forum?id=li7qeBbCR1t"><span class="nocase">Building Normalizing Flows with Stochastic Interpolants</span></a>. In <em>The eleventh international conference on learning representations</em>.
</div>
<div id="ref-Brenier2003" class="csl-entry" role="listitem">
Brenier, Y. (2003). <a href="https://doi.org/10.1007/978-3-540-44857-0_4">Extended monge-kantorovich theory</a>. In <em>Optimal transportation and applications: Lectures given at the c.i.m.e. Summer school, held in martina franca, italy, september 2-8, 2001</em>, pages 91–121. Berlin, Heidelberg: Springer Berlin Heidelberg.
</div>
<div id="ref-Chen-Lipman2024" class="csl-entry" role="listitem">
Chen, R. T. Q., and Lipman, Y. (2024). <a href="https://openreview.net/forum?id=g7ohDlTITL">Flow matching on general geometries</a>. In <em>The twelfth international conference on learning representations</em>.
</div>
<div id="ref-Chen+2023AnalogBits" class="csl-entry" role="listitem">
Chen, T., ZHANG, R., and Hinton, G. (2023). <a href="https://openreview.net/forum?id=3itjR9QxFw">Analog bits: Generating discrete data using diffusion models with self-conditioning</a>. In <em>The eleventh international conference on learning representations</em>.
</div>
<div id="ref-Chung+2023" class="csl-entry" role="listitem">
Chung, H., Kim, J., Mccann, M. T., Klasky, M. L., and Ye, J. C. (2023). <a href="https://openreview.net/forum?id=OnD9zGAGT0k">Diffusion posterior sampling for general noisy inverse problems</a>. In <em>The eleventh international conference on learning representations</em>.
</div>
<div id="ref-Dao+2023" class="csl-entry" role="listitem">
Dao, Q., Phung, H., Nguyen, B., and Tran, A. (2023). <a href="https://arxiv.org/abs/2307.08698">Flow matching in latent space</a>.
</div>
<div id="ref-Dhariwal-Nichol2021" class="csl-entry" role="listitem">
Dhariwal, P., and Nichol, A. Q. (2021). <a href="https://openreview.net/forum?id=AAWuCvzaVt">Diffusion models beat <span>GAN</span>s on image synthesis</a>. In A. Beygelzimer, Y. Dauphin, P. Liang, and J. W. Vaughan, editors, <em>Advances in neural information processing systems</em>.
</div>
<div id="ref-Ding+2021" class="csl-entry" role="listitem">
Ding, X., Wang, Y., Xu, Z., Welch, W. J., and Wang, Z. J. (2021). <a href="https://openreview.net/forum?id=PrzjugOsDeE">Cc<span>{</span>GAN<span>}</span>: Continuous conditional generative adversarial networks for image generation</a>. In <em>International conference on learning representations</em>.
</div>
<div id="ref-Fatras+2021" class="csl-entry" role="listitem">
Fatras, K., Zine, Y., Majewski, S., Flamary, R., Gribonval, R., and Courty, N. (2021). <a href="https://arxiv.org/abs/2101.01792">Minibatch optimal transport distances; analysis and applications</a>.
</div>
<div id="ref-Ho+2020" class="csl-entry" role="listitem">
Ho, J., Jain, A., and Abbeel, P. (2020). <a href="https://proceedings.neurips.cc/paper/2020/hash/4c5bcfec8584af0d967f1ab10179ca4b-Abstract.html"><span>Denoising Diffusion Probabilistic Models</span></a>. In <em>Advances in neural information processing systems</em>,Vol. 33.
</div>
<div id="ref-Ho+2022" class="csl-entry" role="listitem">
Ho, J., Saharia, C., Chan, W., Fleet, D. J., Norouzi, M., and Salimans, T. (2022). <a href="http://jmlr.org/papers/v23/21-0635.html">Cascaded diffusion models for high fidelity image generation</a>. <em>Journal of Machine Learning Research</em>, <em>23</em>(47), 1–33.
</div>
<div id="ref-Ho-Salimans2021" class="csl-entry" role="listitem">
Ho, J., and Salimans, T. (2021). <a href="https://openreview.net/forum?id=qw8AKxfYbI">Classifier-free diffusion guidance</a>. In <em>NeurIPS 2021 workshop on deep generative models and downstream applications</em>.
</div>
<div id="ref-Isobe+2024" class="csl-entry" role="listitem">
Isobe, N., Koyama, M., Zhang, J., Hayashi, K., and Fukumizu, K. (2024). <a href="https://arxiv.org/abs/2402.18839">Extended flow matching: A method of conditional generation with generalized continuity equation</a>.
</div>
<div id="ref-Kingma+2014" class="csl-entry" role="listitem">
Kingma, D. P., Mohamed, S., Jimenez Rezende, D., and Welling, M. (2014). <a href="https://proceedings.neurips.cc/paper_files/paper/2014/file/d523773c6b194f37b938d340d5d02232-Paper.pdf"><span class="nocase">Semi-supervised Learning with Deep Generative Models</span></a>. In Z. Ghahramani, M. Welling, C. Cortes, N. Lawrence, and K. Q. Weinberger, editors, <em>Advances in neural information processing systems</em>,Vol. 27. Curran Associates, Inc.
</div>
<div id="ref-Krishna+2024" class="csl-entry" role="listitem">
Krishna, R., Wang, J., Ahern, W., Sturmfels, P., Venkatesh, P., Kalvet, I., … Baker, D. (2024). <a href="https://doi.org/10.1126/science.adl2528">Generalized biomolecular modeling and design with RoseTTAFold all-atom</a>. <em>Science</em>, <em>384</em>(6693), eadl2528.
</div>
<div id="ref-Lavenant2019" class="csl-entry" role="listitem">
Lavenant, H. (2019). <a href="https://doi.org/10.1016/j.jfa.2019.05.003">Harmonic mappings valued in the wasserstein space</a>. <em>Journal of Functional Analysis</em>, <em>277</em>(3), 688–785.
</div>
<div id="ref-Lipman+2023" class="csl-entry" role="listitem">
Lipman, Y., Chen, R. T. Q., Ben-Hamu, H., Nickel, M., and Le, M. (2023). <a href="https://openreview.net/forum?id=PqvMRDCJT9t">Flow matching for generative modeling</a>. In <em>The eleventh international conference on learning representations</em>.
</div>
<div id="ref-Liu+2023-Flow" class="csl-entry" role="listitem">
Liu, X., Gong, C., and liu, qiang. (2023). <a href="https://openreview.net/forum?id=XVjTT1nw5z">Flow straight and fast: Learning to generate and transfer data with rectified flow</a>. In <em>The eleventh international conference on learning representations</em>.
</div>
<div id="ref-McCann1997" class="csl-entry" role="listitem">
McCann, R. J. (1997). <a href="https://doi.org/10.1006/aima.1997.1634">A convexity principle for interacting gases</a>. <em>Advances in Mathematics</em>, <em>128</em>(1), 153–179.
</div>
<div id="ref-Nichol+2022" class="csl-entry" role="listitem">
Nichol, A. Q., Dhariwal, P., Ramesh, A., Shyam, P., Mishkin, P., Mcgrew, B., … Chen, M. (2022). <a href="https://proceedings.mlr.press/v162/nichol22a.html"><span>GLIDE</span>: Towards photorealistic image generation and editing with text-guided diffusion models</a>. In K. Chaudhuri, S. Jegelka, L. Song, C. Szepesvari, G. Niu, and S. Sabato, editors, <em>Proceedings of the 39th international conference on machine learning</em>,Vol. 162, pages 16784–16804. PMLR.
</div>
<div id="ref-Pooladian+2023" class="csl-entry" role="listitem">
Pooladian, A.-A., Ben-Hamu, H., Domingo-Enrich, C., Amos, B., Lipman, Y., and Chen, R. T. Q. (2023). <a href="https://proceedings.mlr.press/v202/pooladian23a.html">Multisample flow matching: Straightening flows with minibatch couplings</a>. In A. Krause, E. Brunskill, K. Cho, B. Engelhardt, S. Sabato, and J. Scarlett, editors, <em>Proceedings of the 40th international conference on machine learning</em>,Vol. 202, pages 28100–28127. PMLR.
</div>
<div id="ref-Saharia+2022SIGGRAPH" class="csl-entry" role="listitem">
Saharia, C., Chan, W., Chang, H., Lee, C. A., Ho, J., Salimans, T., … Norouzi, M. (2022). <a href="https://openreview.net/forum?id=FPGs276lUeq"><span class="nocase">Palette: Image-to-Image Diffusion Models</span></a>.
</div>
<div id="ref-Saharia+2022" class="csl-entry" role="listitem">
Saharia, C., Chan, W., Saxena, S., Li, L., Whang, J., Denton, E., … Norouzi, M. (2022). <a href="https://openreview.net/forum?id=08Yk-n5l2Al">Photorealistic text-to-image diffusion models with deep language understanding</a>. In A. H. Oh, A. Agarwal, D. Belgrave, and K. Cho, editors, <em>Advances in neural information processing systems</em>.
</div>
<div id="ref-Saharia+2023" class="csl-entry" role="listitem">
Saharia, C., Ho, J., Chan, W., Salimans, T., Fleet, D. J., and Norouzi, M. (2023). <a href="https://doi.org/10.1109/TPAMI.2022.3204461">Image super-resolution via iterative refinement</a>. <em>IEEE Transactions on Pattern Analysis and Machine Intelligence</em>, <em>45</em>(4), 4713–4726.
</div>
<div id="ref-Song+2023" class="csl-entry" role="listitem">
Song, J., Zhang, Q., Yin, H., Mardani, M., Liu, M.-Y., Kautz, J., … Vahdat, A. (2023). <a href="https://proceedings.mlr.press/v202/song23k.html">Loss-guided diffusion models for plug-and-play controllable generation</a>. In A. Krause, E. Brunskill, K. Cho, B. Engelhardt, S. Sabato, and J. Scarlett, editors, <em>Proceedings of the 40th international conference on machine learning</em>,Vol. 202, pages 32483–32498. PMLR.
</div>
<div id="ref-Tong+2024" class="csl-entry" role="listitem">
Tong, A., Fatras, K., Malkin, N., Huguet, G., Zhang, Y., Rector-Brooks, J., … Bengio, Y. (2024). <a href="https://openreview.net/forum?id=CD9Snc73AW"><span class="nocase">Improving and Generalizing Flow-Based Generative Models with Minibatch Optimal Transport</span></a>. <em>Transactions on Machine Learning Research</em>.
</div>
<div id="ref-Watson+2023" class="csl-entry" role="listitem">
Watson, J. L., Juergens, D., Bennett, N. R., Trippe, B. L., Yim, J., Eisenach, H. E., … Baker, D. (2023). <a href="https://doi.org/10.1038/s41586-023-06415-8">De novo design of protein structure and function with RFdiffusion</a>. <em>Nature</em>, <em>620</em>(7976), 1089–1100.
</div>
<div id="ref-Zheng+2023GuidedFlow" class="csl-entry" role="listitem">
Zheng, Q., Le, M., Shaul, N., Lipman, Y., Grover, A., and Chen, R. T. Q. (2023). <a href="https://arxiv.org/abs/2311.13443">Guided flows for generative modeling and decision making</a>.
</div>
<div id="ref-Zheng+2024" class="csl-entry" role="listitem">
Zheng, S., He, J., Liu, C., Shi, Y., Lu, Z., Feng, W., … Liu, T.-Y. (2024). <a href="https://doi.org/10.1038/s42256-024-00837-3">Predicting equilibrium distributions for molecular systems with deep learning</a>. <em>Nature Machine Intelligence</em>, <em>6</em>(5), 558–567.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><span class="math inline">\(c\)</span> が <span class="math inline">\(x_t\)</span> と同じ画像である場合は，<span class="citation" data-cites="Ho+2022">(<a href="#ref-Ho+2022" role="doc-biblioref">Ho et al., 2022</a>)</span> のように <span class="math inline">\(x_t\)</span> にそのまま連結することも考えられる．<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>すべての <span class="math inline">\((P_{t,c})_{t\in[0,1]}\)</span> は <span class="math inline">\(\sigma\to0\)</span> の極限で決定論的なダイナミクスを定めていた．これを <span class="math inline">\(\psi_c(t)\)</span> と表すこととする．<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/162348\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            trigger: 'click',
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            positionFixed: true,
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "162348/162348.github.io";
    script.dataset.repoId = "R_kgDOKlfKYQ";
    script.dataset.category = "Announcements";
    script.dataset.categoryId = "DIC_kwDOKlfKYc4CgDmb";
    script.dataset.mapping = "pathname";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://162348.github.io/">
<p>Hirofumi Shiba</p>
</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/162348/162348.github.io/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/ano2math5">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:shiba.hirofumi@ism.ac.jp">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../../../blog.xml">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>